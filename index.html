<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rugby Club</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <script src="js/sanitize-html.js"></script>
    <script src="js/shared-settings.js"></script>
    <script src="js/color-manager.js"></script>
    <link rel="stylesheet" href="css/calendar-widget.css">
    <style>
        /* Admin controlled elements */
        html, body {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        body {
            padding-top: 75px; /* Mobile: smaller header */
            padding-left: 0 !important; /* üéØ OLS 111: Remove side padding */
            padding-right: 0 !important; /* üéØ OLS 111: Remove side padding */
            margin-left: 0 !important;
            margin-right: 0 !important;
        }
        
        /* üéØ OLS 111 + OLS 124: Ensure footer goes full-width */
        #footer-placeholder,
        #footer-placeholder > *,
        .footer,
        .footer-wrapper,
        .site-footer,
        footer {
            margin-left: 0 !important;
            margin-right: 0 !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
            border-radius: 0 !important;
            box-sizing: border-box !important;
        }
        
        /* Force footer container to not be constrained */
        #footer-placeholder > div,
        #footer-placeholder > footer,
        #footer-placeholder > section,
        #footer-placeholder .container,
        #footer-placeholder .footer-container,
        footer .container,
        .footer .container {
            margin: 0 auto !important;
            padding-left: 2rem !important;
            padding-right: 2rem !important;
            width: 100% !important;
            max-width: 100% !important;
            border-radius: 0 !important;
        }
        
        /* Remove any gap/spacing before footer */
        #footer-placeholder {
            margin-top: 0 !important;
        }
        
        /* Desktop: taller header needs more clearance */
        @media (min-width: 769px) {
            body {
                padding-top: 95px; /* Desktop: larger header */
            }
        }
        
        .nav-item[data-admin-controlled="true"] {
            display: none;
        }

        .nav-item[data-admin-controlled="true"].admin-enabled {
            display: block;
        }

        /* Live Social Media Section */
        .live-social-section {
            padding: 3rem 0;
            background: var(--bg-light);
        }

        .social-embed {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .social-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .facebook-logo {
            width: 50px;
            height: 50px;
            background: #1877f2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .instagram-logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        /* RFU League Table */
        .rfu-league-section {
            padding: 3rem 0;
            background: white;
        }

        .league-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .league-header {
            background: var(--primary-green);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }

        .league-content {
            padding: 2rem;
        }

        /* üéØ OLS 25 FIX: FASTER + SEAMLESS TICKERTAPE */
        .sponsor-banner {
    background: transparent;
    padding: 0.5rem 0;
    box-shadow: none;
    overflow: hidden;
    position: relative;
    border-top: 3px solid var(--accent-gold);
    border-bottom: none;
    margin-top: 0;
    z-index: 1; /* Below fixed header (z-index: 1000) */
    min-height: auto;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.sponsor-banner.ready {
    opacity: 1;
}

/* Ensure sponsor banner clears the fixed header properly */
.sponsor-banner:first-of-type {
    margin-top: 0; /* Body padding-top handles clearance */
}

.sponsor-banner-clickable {
    cursor: pointer;
    transition: background 0.3s ease;
}

.sponsor-banner-clickable:hover {
    background: transparent;
}

.sponsor-ticker {
    display: flex;
    gap: 0.125rem;
    align-items: center;
    padding: 0 1rem;
}


.sponsor-logo-banner {
    flex: 0 0 auto;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    background: transparent;
    border-radius: 0;
    box-shadow: none;
    transition: all 0.3s ease;
    cursor: pointer;
    overflow: hidden;
}

.sponsor-logo-banner:hover {
    transform: scale(1.08);
    filter: brightness(1.1);
    background: transparent;
}

.sponsor-logo-banner img {
    width: auto;
    height: 100%;
    object-fit: contain;
    object-position: center;
    filter: grayscale(20%) opacity(0.85);
    transition: filter 0.3s ease;
}

.sponsor-logo-banner:hover img {
    filter: grayscale(0%) opacity(1);
}

.sponsor-logo-banner.placeholder {
    background: linear-gradient(45deg, var(--primary-green), var(--primary-maroon));
    color: white;
    font-weight: bold;
    font-size: 0.85rem;
    text-align: center;
}

/* Seamless infinite scroll animation */
@keyframes sponsorScroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
}

/* üì± Mobile styles */
@media (max-width: 768px) {
    .sponsor-banner {
        margin-top: 70px;
        padding: 0.5rem 0;
        min-height: auto;
    }
    
    .sponsor-ticker {
        gap: 0.125rem;
        /* Animation duration set dynamically by JavaScript based on sponsor count */
    }
    
    .sponsor-logo-banner {
        flex: 0 0 auto;
        height: 70px;
        padding: 0;
        border-radius: 0;
    }
}

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.75), rgba(var(--primary-maroon-rgb), 0.75)), 
                        url('images/backgrounds/hero-banner.png') center/cover no-repeat;
            min-height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            position: relative;
            margin: -100px 0 0 0;
            padding: 100px 1rem 3rem 1rem;
        }

        .hero-content {
            max-width: 800px;
            z-index: 2;
        }

        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .hero p {
            font-size: 1.3rem;
            margin-bottom: 2rem;
            opacity: 0.9;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        .cta-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 1rem 2rem;
            border-radius: 30px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .btn-primary {
            background: var(--accent-gold);
            color: var(--primary-green);
        }

        .btn-secondary {
            background: transparent;
            color: white;
            border: 2px solid white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        /* ENHANCED FIXTURES SECTION */
        .fixtures-timeline-container {
            position: relative;
            margin-top: 2rem;
            overflow: hidden;
        }

        .fixtures-timeline {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            gap: 1.5rem;
            padding: 1rem 0;
            scroll-behavior: smooth;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            padding-left: calc(50vw - 160px);
            padding-right: calc(50vw - 160px);
        }

        .fixture-timeline-card:first-child {
            margin-left: 0 !important;
        }

        .fixture-timeline-card:last-child {
            margin-right: 0 !important;
        }

        .fixtures-timeline::-webkit-scrollbar {
            height: 8px;
        }

        .fixtures-timeline::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }

        .fixtures-timeline::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 10px;
        }

        .fixtures-timeline::-webkit-scrollbar-thumb:hover {
            background: rgba(var(--accent-gold-rgb), 0.8);
        }

        .fixtures-timeline-container::before,
        .fixtures-timeline-container::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 80px;
            z-index: 10;
            pointer-events: none;
        }

        .fixtures-timeline-container::before {
            left: 0;
            background: linear-gradient(to right, 
                rgba(var(--primary-green-rgb), 1) 0%, 
                rgba(var(--primary-green-rgb), 0.9) 15%, 
                rgba(var(--primary-green-rgb), 0.7) 35%, 
                rgba(var(--primary-green-rgb), 0.4) 60%, 
                rgba(var(--primary-green-rgb), 0.2) 80%, 
                transparent 100%);
        }

        .fixtures-timeline-container::after {
            right: 0;
            background: linear-gradient(to left, 
                rgba(var(--primary-maroon-rgb), 1) 0%, 
                rgba(var(--primary-maroon-rgb), 0.9) 15%, 
                rgba(var(--primary-maroon-rgb), 0.7) 35%, 
                rgba(var(--primary-maroon-rgb), 0.4) 60%, 
                rgba(var(--primary-maroon-rgb), 0.2) 80%, 
                transparent 100%);
        }

        .match-info {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-maroon) 100%);
            position: relative;
        }

        .match-info::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
        }

        .match-info .container {
            position: relative;
            z-index: 2;
        }

        .match-info .section-title {
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .fixtures-team-filter {
            background: rgba(255,255,255,0.1);
            padding: 1.5rem;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin-bottom: 2rem;
        }

        .fixtures-team-filter h3 {
            color: white;
            margin-bottom: 1rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .team-filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .team-filter-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .team-filter-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: var(--accent-gold);
            transform: translateY(-2px);
        }

        .team-filter-btn.active {
            background: var(--accent-gold);
            color: var(--primary-green);
            border-color: var(--accent-gold);
            box-shadow: 0 5px 15px rgba(var(--accent-gold-rgb), 0.4);
        }

        .timeline-navigation {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .timeline-nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .timeline-nav-btn:hover {
            background: var(--accent-gold);
            color: var(--primary-green);
            border-color: var(--accent-gold);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(var(--accent-gold-rgb), 0.4);
        }

        .timeline-nav-btn:disabled {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.5);
            border-color: rgba(255,255,255,0.1);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .fixture-timeline-card {
            flex: 0 0 320px;
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            scroll-snap-align: center;
            scroll-snap-stop: always;
            position: relative;
        }

        .fixture-timeline-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .fixture-timeline-card.current-match {
            border: 3px solid var(--accent-gold);
            transform: scale(1.05);
            z-index: 10;
        }

        .fixture-timeline-card.past-match {
            opacity: 0.9;
        }

        .fixture-timeline-card.future-match {
            border-left: 4px solid var(--primary-green);
        }

        .fixture-timeline-card.cancelled-match {
            border-left: 4px solid #6c757d;
            opacity: 0.65;
        }

        .fixture-timeline-card.postponed-match {
            border-left: 4px solid #ff9800;
            opacity: 0.65;
        }

        .match-status {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-green);
            color: white;
            padding: 0.3rem 1rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .match-status.current {
            background: var(--accent-gold);
            color: var(--primary-green);
        }

        .match-status.upcoming {
            background: var(--primary-maroon);
        }

        .match-status.cancelled {
            background: #6c757d;
        }

        .match-status.postponed {
            background: #ff9800;
            color: white;
        }

        .match-teams-timeline {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary-green);
            margin-bottom: 1rem;
            text-align: center;
        }

        .match-score-timeline {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin: 1rem 0;
            color: var(--primary-maroon);
        }

        .match-date-timeline {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .match-details-timeline {
            text-align: center;
            color: var(--text-light);
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .match-competition-timeline {
            background: var(--bg-light);
            padding: 0.5rem;
            border-radius: 8px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-dark);
            font-style: italic;
        }

        /* üéØ OLS 129: Timeline Action Buttons */
        .timeline-action-buttons {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        
        .timeline-action-btn {
            padding: 0.4rem 0.6rem;
            border: none;
            border-radius: 6px;
            background: var(--primary-green);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .timeline-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .timeline-action-btn.timeline-action-report {
            background: var(--primary-maroon);
        }

        @media (max-width: 768px) {
            .live-social-section .container > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 2rem;
            }
            
            .social-header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .sponsor-banner {
        margin-top: 70px;
        padding: 0.5rem 0;
        min-height: auto;
    }
            .sponsor-ticker {
                gap: 0.125rem;
            }
            
            .sponsor-logo-banner {
                flex: 0 0 auto;
                height: 70px;
                padding: 0;
                border-radius: 0;
            }

            .hero h1 {
                font-size: 2.5rem;
            }

            .hero p {
                font-size: 1.1rem;
            }

            .cta-buttons {
                flex-direction: column;
                align-items: center;
            }

            .fixtures-timeline {
                padding-left: calc(50vw - 140px);
                padding-right: calc(50vw - 140px);
                gap: 1rem;
            }

            .fixture-timeline-card {
                flex: 0 0 280px;
            }

            .timeline-navigation {
                flex-direction: column;
                align-items: center;
            }
        }

        /* üéØ PREVENT FLASH OF DEFAULT CONTENT */
        .hero h1,
        .hero p,
        .section-title,
        .stat-item,
        .about-text {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .cms-content-loaded .hero h1,
        .cms-content-loaded .section-title,
        .cms-content-loaded .stat-item,
        .cms-content-loaded .about-text {
            opacity: 1;
        }
        
        /* Hero tagline uses 0.9 opacity for design (subtle transparency) */
        .cms-content-loaded .hero p {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <!-- Universal Header -->
    <div id="header-placeholder" data-page="home"></div>

    <!-- üéØ OLS 25: Sponsor Banner with Admin Toggle Control -->
    <section class="sponsor-banner sponsor-banner-clickable" id="sponsorBanner" style="display: none;" onclick="window.location.href='pages/sponsors.html';" title="Click to view all sponsors">
        <div class="sponsor-ticker" id="sponsorTickerMain">
            <!-- Sponsors loaded dynamically -->
        </div>
    </section>

    <!-- Hero Section -->
    <section id="home" class="hero">
        <div class="hero-content">
            <h1>Welcome to Our Club</h1>
            <p>Proudly representing tradition, excellence, and the spirit of rugby since our founding</p>
            <div class="cta-buttons">
                <a href="pages/fixtures.html" class="btn btn-primary">View Fixtures</a>
                <a href="#about" class="btn btn-secondary">About Our Club</a>
            </div>
        </div>
    </section>

    <!-- Fixtures & Results Timeline (MOVED UP) -->
    <section id="fixtures" class="match-info">
        <div class="container">
            <h2 class="section-title fade-in">Fixtures & Results</h2>
            
            <div class="fixtures-team-filter">
                <h3>Select Team:</h3>
                
                <!-- MOBILE DROPDOWN (hidden on desktop) -->
                <div class="fixtures-filter-mobile">
                    <select id="fixtures-team-select" 
                            style="width: 100%; padding: 1rem; border: 2px solid var(--primary-green); border-radius: 10px; font-size: 1rem; font-weight: bold; color: var(--primary-green); background: white; cursor: pointer;">
                        <!-- Dynamically populated by loadTeamFilters() -->
                    </select>
                </div>
                
                <!-- DESKTOP BUTTONS (hidden on mobile) -->
                <div class="team-filter-buttons fixtures-filter-desktop" id="team-filter-buttons">
                    <!-- Dynamically populated by loadTeamFilters() -->
                </div>
            </div>
            
            <div class="fixtures-timeline-container">
                <div class="fixtures-timeline" id="fixtures-timeline">
                    <!-- Timeline cards populated by JavaScript -->
                </div>
                
                <div class="timeline-navigation">
                    <button class="timeline-nav-btn" id="scrollLeft" onclick="scrollTimeline('left')">‚Üê Past Results</button>
                    <button class="timeline-nav-btn" id="scrollRight" onclick="scrollTimeline('right')">Future Fixtures ‚Üí</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Our SociOLS Section -->
    <section class="live-social-section">
        <div class="container">
            <h2 class="section-title fade-in">Our SociOLS</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 3rem;">
                
                <!-- Instagram Feed - CMS controlled via homepage-instagram-url -->
                <div class="social-embed social-embed-instagram">
                    <div id="instagram-feed">
                        <iframe src="about:blank" 
                                width="100%" 
                                height="700" 
                                class="instagram-iframe"
                                style="border:none;overflow:hidden;border-radius:10px;" 
                                scrolling="no" 
                                frameborder="0">
                        </iframe>
                    </div>
                </div>
                
                <!-- Facebook Feed - CMS controlled via homepage-facebook-url -->
                <div class="social-embed social-embed-facebook">
                    <div id="facebook-desktop" class="facebook-desktop-only">
                        <iframe src="about:blank" 
                                width="100%" 
                                height="700" 
                                style="border:none; overflow:hidden; border-radius:10px;" 
                                scrolling="no" 
                                frameborder="0" 
                                allowfullscreen="true" 
                                allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share">
                        </iframe>
                    </div>
                    
                    <div id="facebook-mobile" class="facebook-mobile-only">
                        <div style="text-align: center; padding: 2rem 1rem; background: linear-gradient(135deg, #f0f2f5 0%, #e4e6eb 100%); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="width: 50px; height: 50px; background: #1877f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; box-shadow: 0 4px 12px rgba(24, 119, 242, 0.3);">
                                <svg width="25" height="25" fill="white" viewBox="0 0 24 24">
                                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                                </svg>
                            </div>
                            <h3 style="color: #1877f2; margin-bottom: 1rem; font-size: 1rem; font-weight: bold;">Follow Us</h3>
                            <a href="#" 
                               id="facebook-mobile-link"
                               target="_blank" 
                               style="display: inline-block; padding: 0.7rem 1.8rem; background: #1877f2; color: white; text-decoration: none; border-radius: 25px; font-weight: bold; font-size: 0.9rem; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(24, 119, 242, 0.4);">
                                üìò Facebook
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- League Table (Mobile Compact - next to Facebook) -->
                <div class="social-embed league-mobile-compact">
                    <div class="league-mobile-only">
                        <div id="league-mobile-card" style="text-align: center; padding: 2rem 1rem; background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon)); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="font-size: 2.5rem; margin-bottom: 1rem;">üèÜ</div>
                            <h3 style="color: white; margin-bottom: 0.5rem; font-size: 1rem; font-weight: bold;">League Table</h3>
                            <p id="league-mobile-position" style="color: var(--accent-gold); font-size: 0.9rem; margin-bottom: 0.75rem; font-weight: bold;"></p>
                            <a id="league-mobile-link" 
                               href="#" 
                               target="_blank" 
                               style="display: inline-block; padding: 0.7rem 1.8rem; background: var(--accent-gold); color: var(--primary-green); text-decoration: none; border-radius: 25px; font-weight: bold; font-size: 0.9rem; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                üèâ View Table
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <style>
    .social-embed-instagram {
        background: white;
        border-radius: 15px;
        padding: 0;
        box-shadow: var(--shadow);
        overflow: hidden;
        min-height: auto !important;
    }

    .social-embed-instagram #instagram-feed {
        position: relative;
        width: 100%;
        min-height: 400px;
    }

    .instagram-iframe {
        display: block;
        width: 100% !important;
        min-height: 400px;
        max-height: 700px;
    }

    .social-embed-facebook {
        background: white;
        border-radius: 15px;
        padding: 0;
        box-shadow: var(--shadow);
        overflow: hidden;
    }

    .facebook-desktop-only {
        display: block;
    }

    .facebook-mobile-only {
        display: none;
    }
    
    .league-desktop-only {
        display: block;
    }
    
    .league-mobile-only {
        display: none;
    }
    
    .league-mobile-compact {
        display: none;
    }

    @media (max-width: 768px) {
        /* Keep Instagram normal, make Facebook and League side-by-side */
        .live-social-section .container > div[style*="grid-template-columns"] {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 0.75rem !important;
        }
        
        .live-social-section {
            padding: 2rem 0 1rem 0 !important;
        }
        
        /* Hide the standalone League Table section on mobile */
        .external-link-section {
            display: none !important;
        }
        
        /* Instagram takes full width */
        .social-embed-instagram {
            grid-column: 1 / -1 !important;
            min-height: 500px !important;
            max-height: 600px !important;
            height: auto !important;
            padding: 0 !important;
            margin-bottom: 0.75rem !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        .instagram-iframe {
            height: 500px !important;
            max-height: 600px !important;
            min-height: 400px !important;
            width: 100% !important;
        }
        
        /* Facebook and League cards - uniform styling */
        .social-embed-facebook,
        .league-mobile-compact {
            min-height: auto !important;
            padding: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* Make card contents uniform height */
        .social-embed-facebook .facebook-mobile-only > div,
        .league-mobile-compact .league-mobile-only > div {
            min-height: 180px !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
        }
        
        .facebook-desktop-only {
            display: none !important;
        }
        
        .facebook-mobile-only {
            display: block !important;
        }
        
        .league-mobile-compact {
            display: block !important;
        }
        
        .league-mobile-only {
            display: block !important;
        }
    }
    </style>

    <style>
    /* üéØ OLS 111: Limit news articles on homepage - 6 desktop, 3 mobile */
    .news-grid .news-card:nth-child(n+7) {
        display: none;
    }
    
    @media (max-width: 768px) {
        .news-grid .news-card:nth-child(n+4) {
            display: none;
        }
    }
    </style>

    <!-- Latest News -->
    <section id="news" class="news-section">
        <div class="container">
            <h2 class="section-title fade-in">Latest News</h2>
            <div class="news-grid">
                <!-- News articles populated by JavaScript -->
            </div>
            <!-- üéØ ADD THIS NEW SECTION -->
        <div style="text-align: center; margin-top: 3rem;">
            <a href="pages/news.html" class="btn" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 1rem 2.5rem; background: var(--primary-green); color: white; text-decoration: none; border-radius: 30px; font-weight: bold; font-size: 1.1rem; transition: all 0.3s ease;">
                üì∞ View All News
            </a>
        </div>
        <!-- üéØ END OF NEW SECTION -->
        </div>
    </section>

    <!-- üéØ OLS 125: Gallery Preview Widget - 3 Recent Albums -->
    <section id="gallery-preview" class="gallery-preview-section">
        <div class="container">
            <h2 class="section-title fade-in">üì∏ Photo Gallery</h2>
            <p class="gallery-preview-subtitle">Latest photos from matches, training and club events</p>
            
            <div id="gallery-preview-grid" class="gallery-preview-grid">
                <!-- Populated by JavaScript -->
                <div class="gallery-preview-loading">
                    <div class="gallery-spinner"></div>
                    <p>Loading albums...</p>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 2rem;">
                <a href="pages/gallery.html" class="btn" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 1rem 2.5rem; background: var(--primary-green); color: white; text-decoration: none; border-radius: 30px; font-weight: bold; font-size: 1.1rem; transition: all 0.3s ease;">
                    üì∑ View Full Gallery
                </a>
            </div>
        </div>
    </section>

    <!-- Gallery Preview Styles -->
    <style>
    .gallery-preview-section {
        padding: 4rem 0;
        background: var(--bg-light);
    }
    
    .gallery-preview-subtitle {
        text-align: center;
        color: var(--text-light);
        margin-bottom: 2rem;
        font-size: 1.1rem;
    }
    
    .gallery-preview-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 2rem;
        margin-bottom: 1rem;
    }
    
    .gallery-album-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .gallery-album-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 30px rgba(0,0,0,0.2);
    }
    
    .gallery-album-cover {
        width: 100%;
        aspect-ratio: 16/10;
        overflow: hidden;
        position: relative;
    }
    
    .gallery-album-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.4s ease;
    }
    
    .gallery-album-card:hover .gallery-album-cover img {
        transform: scale(1.08);
    }
    
    .gallery-album-cover .photo-count {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: bold;
        backdrop-filter: blur(4px);
    }
    
    .gallery-album-info {
        padding: 1.25rem;
    }
    
    .gallery-album-title {
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--primary-green);
        margin: 0 0 0.5rem 0;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .gallery-album-date {
        font-size: 0.9rem;
        color: var(--text-light);
        margin: 0;
    }
    
    .gallery-preview-loading {
        grid-column: 1 / -1;
        text-align: center;
        padding: 3rem;
        color: var(--text-light);
    }
    
    .gallery-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(var(--primary-green-rgb), 0.2);
        border-top-color: var(--primary-green);
        border-radius: 50%;
        animation: gallerySpin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes gallerySpin {
        to { transform: rotate(360deg); }
    }
    
    .gallery-preview-empty {
        grid-column: 1 / -1;
        text-align: center;
        padding: 3rem;
        background: white;
        border-radius: 15px;
        color: var(--text-light);
    }
    
    /* Responsive: Tablet */
    @media (max-width: 992px) {
        .gallery-preview-grid {
            gap: 1.5rem;
        }
        
        .gallery-album-info {
            padding: 1rem;
        }
        
        .gallery-album-title {
            font-size: 1rem;
        }
    }
    
    /* Responsive: Mobile */
    @media (max-width: 768px) {
        .gallery-preview-section {
            padding: 3rem 0;
        }
        
        .gallery-preview-grid {
            grid-template-columns: 1fr;
            gap: 1.25rem;
            max-width: 400px;
            margin: 0 auto 1rem;
        }
        
        .gallery-preview-subtitle {
            font-size: 1rem;
            padding: 0 1rem;
        }
        
        .gallery-album-cover {
            aspect-ratio: 16/9;
        }
    }
    </style>

    <!-- Gallery Preview JavaScript -->
    <script>
    (async function loadGalleryPreview() {
        const container = document.getElementById('gallery-preview-grid');
        if (!container) return;
        
        try {
            // Try cache first
            let albums = JSON.parse(localStorage.getItem('olrfc_gallery') || '[]');
            
            // Fetch fresh data in background
            try {
                const response = await fetch('/.netlify/functions/gallery');
                if (response.ok) {
                    const result = await response.json();
                    albums = result.data || [];
                    localStorage.setItem('olrfc_gallery', JSON.stringify(albums));
                }
            } catch (e) {
                console.warn('Could not fetch fresh gallery data:', e);
            }
            
            if (!albums || albums.length === 0) {
                container.innerHTML = `
                    <div class="gallery-preview-empty">
                        <p>üì∑ Photo gallery coming soon!</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Check back for match day photos and club events.</p>
                    </div>
                `;
                return;
            }
            
            // Sort albums by date (newest first) and get 3 most recent
            const sortedAlbums = albums.sort((a, b) => {
                const dateA = new Date(a.date || a.createdAt || 0);
                const dateB = new Date(b.date || b.createdAt || 0);
                return dateB - dateA;
            });
            
            const recentAlbums = sortedAlbums.slice(0, 3);
            
            // Build HTML for album cards
            let html = '';
            
            recentAlbums.forEach((album) => {
                // Get photo count - use photoCount field if available
                let photoCount = 0;
                if (album.photoCount) {
                    photoCount = parseInt(album.photoCount) || 0;
                }
                
                // Parse photos - it's stored as a JSON string!
                let photos = [];
                if (album.photos) {
                    if (typeof album.photos === 'string') {
                        try {
                            photos = JSON.parse(album.photos);
                        } catch (e) {
                            console.warn('Could not parse photos for album:', album.title);
                        }
                    } else if (Array.isArray(album.photos)) {
                        photos = album.photos;
                    }
                }
                
                // If we didn't have photoCount, use parsed array length
                if (!photoCount && Array.isArray(photos)) {
                    photoCount = photos.length;
                }
                
                // Get cover image - first photo from parsed array, or dedicated cover field
                let coverUrl = album.cover || album.coverImage || album.coverUrl;
                if (!coverUrl && Array.isArray(photos) && photos.length > 0) {
                    const firstPhoto = photos[0];
                    coverUrl = typeof firstPhoto === 'string' ? firstPhoto : (firstPhoto?.url || firstPhoto?.src);
                }
                
                // Use Cloudinary transformations for optimized cover
                if (coverUrl && coverUrl.includes('cloudinary')) {
                    coverUrl = coverUrl.replace('/upload/', '/upload/c_fill,w_600,h_400,q_auto,f_auto/');
                }
                
                // Format date
                const albumDate = album.date || album.createdAt;
                let dateDisplay = '';
                if (albumDate) {
                    const date = new Date(albumDate);
                    dateDisplay = date.toLocaleDateString('en-GB', { 
                        day: 'numeric', 
                        month: 'long', 
                        year: 'numeric' 
                    });
                }
                
                html += `
                    <div class="gallery-album-card" onclick="window.location.href='pages/gallery.html'">
                        <div class="gallery-album-cover">
                            ${coverUrl 
                                ? `<img src="${coverUrl}" alt="${album.title || 'Album'}" loading="lazy" onerror="this.parentElement.innerHTML='<div style=\\'width:100%;height:100%;background:linear-gradient(135deg, var(--primary-green), var(--primary-maroon));display:flex;align-items:center;justify-content:center;color:white;font-size:3rem;\\'>üì∑</div><span class=\\'photo-count\\'>üì∑ ${photoCount} photo${photoCount !== 1 ? 's' : ''}</span>'">`
                                : `<div style="width:100%;height:100%;background:linear-gradient(135deg, var(--primary-green), var(--primary-maroon));display:flex;align-items:center;justify-content:center;color:white;font-size:3rem;">üì∑</div>`
                            }
                            <span class="photo-count">üì∑ ${photoCount} photo${photoCount !== 1 ? 's' : ''}</span>
                        </div>
                        <div class="gallery-album-info">
                            <h3 class="gallery-album-title">${album.title || 'Untitled Album'}</h3>
                            ${dateDisplay ? `<p class="gallery-album-date">üìÖ ${dateDisplay}</p>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            console.log('‚úÖ Gallery preview loaded:', recentAlbums.length, 'albums');
            
        } catch (error) {
            console.error('Error loading gallery preview:', error);
            container.innerHTML = `
                <div class="gallery-preview-empty">
                    <p>üì∑ Gallery temporarily unavailable</p>
                </div>
            `;
        }
    })();
    </script>

    <!-- üéØ OLS 125: Recent Form Widget -->
    <section id="recent-form" class="recent-form-section">
        <div class="container">
            <h2 class="section-title fade-in">Recent Form</h2>
            
            <!-- Team Filter -->
            <div class="form-widget-filter">
                <label for="form-team-select">Select Team:</label>
                <select id="form-team-select" onchange="updateFormWidget(this.value)">
                    <option value="all">All Teams</option>
                    <!-- Populated dynamically -->
                </select>
            </div>
            
            <div id="form-widget-container" class="form-widget-container">
                <!-- Populated by JavaScript -->
                <div class="form-widget-loading">
                    <div class="form-spinner"></div>
                    <p>Loading results...</p>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 2rem;">
                <a href="pages/fixtures.html" class="btn" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 1rem 2.5rem; background: var(--primary-maroon); color: white; text-decoration: none; border-radius: 30px; font-weight: bold; font-size: 1.1rem; transition: all 0.3s ease;">
                    üèâ View All Fixtures & Results
                </a>
            </div>
        </div>
    </section>

    <!-- Recent Form Widget Styles -->
    <style>
    .recent-form-section {
        padding: 4rem 0;
        background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%);
    }
    
    .form-widget-filter {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .form-widget-filter label {
        font-weight: bold;
        color: var(--primary-green);
        font-size: 1.1rem;
    }
    
    .form-widget-filter select {
        padding: 0.8rem 2rem 0.8rem 1.5rem;
        border: 2px solid var(--primary-green);
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        background: white;
        color: var(--primary-green);
        cursor: pointer;
        min-width: 200px;
        transition: all 0.3s ease;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23006400' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
    }
    
    .form-widget-filter select:hover {
        background-color: rgba(var(--primary-green-rgb), 0.05);
        border-color: var(--primary-maroon);
    }
    
    .form-widget-filter select:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(var(--primary-green-rgb), 0.15);
    }
    
    .form-widget-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        max-width: 1100px;
        margin: 0 auto;
    }
    
    .form-widget-loading {
        text-align: center;
        padding: 3rem;
        color: var(--text-light);
    }
    
    .form-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(var(--primary-maroon-rgb), 0.2);
        border-top-color: var(--primary-maroon);
        border-radius: 50%;
        animation: formSpin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes formSpin {
        to { transform: rotate(360deg); }
    }
    
    .form-team-row {
        background: white;
        border-radius: 20px;
        padding: 2rem 3rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
    }
    
    .form-team-name {
        font-weight: 700;
        color: var(--primary-green);
        font-size: 1.4rem;
        text-align: center;
        padding-bottom: 0.75rem;
        border-bottom: 3px solid var(--accent-gold);
        margin-bottom: 0.25rem;
    }
    
    .form-indicators {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
        width: 100%;
        padding: 0.75rem 0;
    }
    
    .form-match {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        min-width: 90px;
        padding: 1rem 1rem;
        border-radius: 14px;
        background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%);
        border: 1px solid rgba(0,0,0,0.06);
        transition: all 0.25s ease;
        cursor: default;
    }
    
    .form-match:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    
    .form-indicator {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1.5rem;
        color: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.25);
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    
    .form-indicator.win {
        background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
    }
    
    .form-indicator.draw {
        background: linear-gradient(135deg, #FFB300 0%, #FF8F00 100%);
    }
    
    .form-indicator.loss {
        background: linear-gradient(135deg, #EF5350 0%, #C62828 100%);
    }
    
    .form-score {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--text-dark);
        letter-spacing: 0.5px;
    }
    
    .form-opponent {
        font-size: 0.8rem;
        color: var(--text-light);
        text-align: center;
        max-width: 85px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .form-summary {
        display: flex;
        justify-content: center;
        gap: 1rem;
        width: 100%;
        padding-top: 1rem;
        border-top: 1px solid rgba(0,0,0,0.06);
    }
    
    .form-summary span {
        padding: 0.6rem 1.5rem;
        border-radius: 25px;
        font-weight: 700;
        font-size: 1rem;
        letter-spacing: 0.5px;
    }
    
    .form-summary .wins {
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(46, 125, 50, 0.15) 100%);
        color: #2E7D32;
        border: 1px solid rgba(76, 175, 80, 0.3);
    }
    
    .form-summary .draws {
        background: linear-gradient(135deg, rgba(255, 179, 0, 0.15) 0%, rgba(255, 143, 0, 0.15) 100%);
        color: #E65100;
        border: 1px solid rgba(255, 179, 0, 0.3);
    }
    
    .form-summary .losses {
        background: linear-gradient(135deg, rgba(239, 83, 80, 0.15) 0%, rgba(198, 40, 40, 0.15) 100%);
        color: #C62828;
        border: 1px solid rgba(239, 83, 80, 0.3);
    }
    
    .form-widget-empty {
        text-align: center;
        padding: 3rem 2rem;
        background: white;
        border-radius: 20px;
        color: var(--text-light);
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .recent-form-section {
            padding: 3rem 0;
        }
        
        .form-widget-filter {
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .form-widget-filter select {
            width: 100%;
            max-width: 280px;
        }
        
        .form-team-row {
            padding: 1.25rem 1rem;
            border-radius: 16px;
        }
        
        .form-team-name {
            font-size: 1.1rem;
        }
        
        .form-indicators {
            gap: 0.5rem;
        }
        
        .form-match {
            min-width: 60px;
            padding: 0.5rem 0.35rem;
        }
        
        .form-indicator {
            width: 42px;
            height: 42px;
            font-size: 1.1rem;
        }
        
        .form-score {
            font-size: 0.8rem;
        }
        
        .form-opponent {
            font-size: 0.7rem;
            max-width: 55px;
        }
        
        .form-summary {
            gap: 0.5rem;
        }
        
        .form-summary span {
            padding: 0.4rem 0.9rem;
            font-size: 0.85rem;
        }
    }
    
    @media (max-width: 480px) {
        .form-indicators {
            gap: 0.4rem;
        }
        
        .form-match {
            min-width: 54px;
            padding: 0.4rem 0.25rem;
        }
        
        .form-indicator {
            width: 38px;
            height: 38px;
            font-size: 1rem;
        }
    }
    </style>

    <!-- Recent Form Widget JavaScript -->
    <script>
    // Global variable to store fixtures data for filtering
    window.formWidgetFixtures = [];
    window.formWidgetTeams = [];
    
    (async function loadFormWidget() {
        const container = document.getElementById('form-widget-container');
        const teamSelect = document.getElementById('form-team-select');
        if (!container) return;
        
        try {
            // Load fixtures from cache or API
            let fixtures = JSON.parse(localStorage.getItem('olrfc_fixtures') || '[]');
            
            // Fetch fresh data
            try {
                const response = await fetch('/.netlify/functions/fixtures');
                if (response.ok) {
                    const result = await response.json();
                    fixtures = result.data || [];
                    localStorage.setItem('olrfc_fixtures', JSON.stringify(fixtures));
                }
            } catch (e) {
                console.warn('Could not fetch fresh fixtures:', e);
            }
            
            // Load teams for filter dropdown
            let teams = JSON.parse(localStorage.getItem('olrfc_teams') || '[]');
            try {
                const teamsResponse = await fetch('/.netlify/functions/teams');
                if (teamsResponse.ok) {
                    const teamsResult = await teamsResponse.json();
                    teams = teamsResult.data || [];
                    localStorage.setItem('olrfc_teams', JSON.stringify(teams));
                }
            } catch (e) {
                console.warn('Could not fetch teams:', e);
            }
            
            // OLS 125: Sort teams by displayOrder
            teams = [...teams].sort((a, b) => {
                const orderA = a.displayOrder || 99;
                const orderB = b.displayOrder || 99;
                return orderA - orderB;
            });
            
            // Populate team dropdown (sorted by displayOrder)
            if (teamSelect && teams.length > 0) {
                teamSelect.innerHTML = '<option value="all">All Teams</option>';
                teams.forEach(team => {
                    teamSelect.innerHTML += `<option value="${team.slug || team.name}">${team.name}</option>`;
                });
                
                // OLS 125: Default to first team in the sorted list
                if (teams.length > 0) {
                    teamSelect.value = teams[0].slug || teams[0].name;
                }
            }
            
            // Store globally for filter updates
            window.formWidgetFixtures = fixtures;
            window.formWidgetTeams = teams;
            
            // OLS 125: Render with first team selected by default (or 'all' if no teams)
            const defaultTeam = teams.length > 0 ? (teams[0].slug || teams[0].name) : 'all';
            renderFormWidget(defaultTeam);
            
        } catch (error) {
            console.error('Error loading form widget:', error);
            container.innerHTML = `
                <div class="form-widget-empty">
                    <p>üèâ Results temporarily unavailable</p>
                </div>
            `;
        }
    })();
    
    function updateFormWidget(teamFilter) {
        renderFormWidget(teamFilter);
    }
    
    function renderFormWidget(teamFilter) {
        const container = document.getElementById('form-widget-container');
        const fixtures = window.formWidgetFixtures || [];
        const teams = window.formWidgetTeams || [];
        
        if (!container) return;
        
        const currentDate = new Date();
        
        // Filter for completed matches - using SAME logic as fixtures timeline
        // Check if scores are actually entered (not null, not empty string, not undefined)
        const completedMatches = fixtures.filter(f => {
            const matchDateTime = new Date(f.dateTime);
            const hasDateTimePassed = matchDateTime < currentDate;
            
            const hasValidScores = f.ourScore !== null && 
                                  f.ourScore !== '' && 
                                  f.ourScore !== undefined &&
                                  f.theirScore !== null && 
                                  f.theirScore !== '' && 
                                  f.theirScore !== undefined;
            
            return hasDateTimePassed && hasValidScores;
        });
        
        console.log('üèâ Form Widget - Completed matches:', completedMatches.length);
        
        if (completedMatches.length === 0) {
            container.innerHTML = `
                <div class="form-widget-empty">
                    <p>üèâ No results yet this season</p>
                    <p style="font-size: 0.9rem; margin-top: 0.5rem;">Check back after match day!</p>
                </div>
            `;
            return;
        }
        
        // Sort by date (most recent first)
        completedMatches.sort((a, b) => {
            const dateA = new Date(a.dateTime);
            const dateB = new Date(b.dateTime);
            return dateB - dateA;
        });
        
        // Group by team
        const teamMatches = {};
        completedMatches.forEach(match => {
            const teamSlug = match.team || 'unknown';
            
            // Find team name from teams data
            const teamData = teams.find(t => t.slug === teamSlug);
            const teamName = teamData ? teamData.name : teamSlug;
            const teamOrder = teamData ? (teamData.displayOrder || 99) : 99;
            
            if (!teamMatches[teamSlug]) {
                teamMatches[teamSlug] = {
                    name: teamName,
                    slug: teamSlug,
                    displayOrder: teamOrder,
                    matches: []
                };
            }
            teamMatches[teamSlug].matches.push(match);
        });
        
        // Filter teams if needed
        let teamsToShow = Object.values(teamMatches);
        
        // OLS 125: Sort by displayOrder
        teamsToShow.sort((a, b) => a.displayOrder - b.displayOrder);
        
        if (teamFilter && teamFilter !== 'all') {
            teamsToShow = teamsToShow.filter(t => t.slug === teamFilter);
        }
        
        if (teamsToShow.length === 0) {
            container.innerHTML = `
                <div class="form-widget-empty">
                    <p>üèâ No results for this team yet</p>
                </div>
            `;
            return;
        }
        
        // Build HTML for each team
        let html = '';
        teamsToShow.forEach(team => {
            const recentMatches = team.matches.slice(0, 5).reverse(); // Last 5 matches, oldest left ‚Üí newest right
            
            let wins = 0, draws = 0, losses = 0;
            
            let matchIndicators = '';
            recentMatches.forEach(match => {
                // Use SAME logic as fixtures timeline
                const ourScore = parseInt(match.ourScore);
                const theirScore = parseInt(match.theirScore);
                const isWin = ourScore > theirScore;
                const isDraw = ourScore === theirScore;
                
                let outcome, indicatorClass;
                if (isWin) {
                    outcome = 'W';
                    indicatorClass = 'win';
                    wins++;
                } else if (isDraw) {
                    outcome = 'D';
                    indicatorClass = 'draw';
                    draws++;
                } else {
                    outcome = 'L';
                    indicatorClass = 'loss';
                    losses++;
                }
                
                const score = `${ourScore}-${theirScore}`;
                
                // Truncate opponent name (more space on desktop now)
                const shortOpponent = (match.opponent || 'TBC').length > 15 
                    ? (match.opponent || 'TBC').substring(0, 13) + '...' 
                    : (match.opponent || 'TBC');
                
                matchIndicators += `
                    <div class="form-match" title="${match.opponent || 'TBC'} - ${score}">
                        <div class="form-indicator ${indicatorClass}">${outcome}</div>
                        <span class="form-score">${score}</span>
                        <span class="form-opponent">${shortOpponent}</span>
                    </div>
                `;
            });
            
            html += `
                <div class="form-team-row">
                    <div class="form-team-name">üèâ ${team.name}</div>
                    <div class="form-indicators">
                        ${matchIndicators}
                    </div>
                    <div class="form-summary">
                        <span class="wins">W: ${wins}</span>
                        <span class="draws">D: ${draws}</span>
                        <span class="losses">L: ${losses}</span>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        console.log('‚úÖ Form widget rendered:', teamsToShow.length, 'teams');
    }
    </script>

    <!-- RFU League Table - OLS 120: Dynamic Scraped Version with Multi-Team Support -->
    <section class="rfu-league-section" id="league-table-section">
        <div class="container">
            <h2 class="section-title fade-in">League Table</h2>
            <div class="league-table">
                <div class="league-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem;">
                        <div>
                            <h3>üèÜ <span id="league-team-title">Current League Standings</span></h3>
                            <p id="league-table-subtitle">Loading standings...</p>
                        </div>
                        <!-- Team Filter (only shows if multiple tables configured) -->
                        <div id="league-team-filter" style="display: none;">
                            <select id="league-team-select-display" onchange="switchLeagueTable(this.value)" 
                                    style="padding: 0.5rem 1rem; border: 2px solid var(--primary-green); border-radius: 25px; font-size: 0.9rem; font-weight: bold; color: var(--primary-green); background: white; cursor: pointer;">
                            </select>
                        </div>
                    </div>
                </div>
                <div class="league-content">
                    <!-- Dynamic League Table Container -->
                    <div id="league-table-container">
                        <!-- Loading State -->
                        <div id="league-table-loading" style="text-align: center; padding: 3rem;">
                            <div class="league-loading-spinner"></div>
                            <p style="margin-top: 1rem; color: var(--text-light);">Fetching latest standings...</p>
                        </div>
                        
                        <!-- Table will be injected here -->
                        <div id="league-table-data" style="display: none;"></div>
                        
                        <!-- Error/Fallback State -->
                        <div id="league-table-fallback" style="display: none; text-align: center; padding: 2rem;">
                            <p style="color: var(--text-light); margin-bottom: 1.5rem;">Unable to load live standings</p>
                            <a id="league-table-external-link" 
                               href="#" 
                               target="_blank" 
                               class="btn"
                               style="display: inline-block; background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon)); color: white; padding: 1rem 2rem; border-radius: 30px; text-decoration: none; font-weight: bold;">
                                üèâ View on England Rugby
                            </a>
                        </div>
                    </div>
                    
                    <!-- Footer Link -->
                    <div id="league-table-footer" style="display: none; text-align: center; padding: 1rem; border-top: 1px solid #eee; margin-top: 1rem;">
                        <a id="league-table-rfu-link" 
                           href="#" 
                           target="_blank" 
                           style="color: var(--primary-green); text-decoration: none; font-size: 0.9rem;">
                            View full table on England Rugby ‚Üí
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- League Table Styles -->
    <style>
    .league-loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(var(--primary-green-rgb), 0.2);
        border-top-color: var(--primary-green);
        border-radius: 50%;
        animation: leagueSpin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes leagueSpin {
        to { transform: rotate(360deg); }
    }
    
    .league-standings-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
    }
    
    .league-standings-table thead {
        background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon));
        color: white;
    }
    
    .league-standings-table th {
        padding: 0.75rem 0.5rem;
        text-align: center;
        font-weight: bold;
        font-size: 0.8rem;
        white-space: nowrap;
    }
    
    .league-standings-table th:nth-child(2) {
        text-align: left;
    }
    
    .league-standings-table tbody tr {
        border-bottom: 1px solid #eee;
        transition: background 0.2s ease;
    }
    
    .league-standings-table tbody tr:hover {
        background: rgba(var(--primary-green-rgb), 0.05);
    }
    
    .league-standings-table tbody tr.highlight-club {
        background: linear-gradient(90deg, rgba(var(--accent-gold-rgb), 0.2), rgba(var(--primary-green-rgb), 0.1));
        font-weight: bold;
    }
    
    .league-standings-table tbody tr.highlight-club:hover {
        background: linear-gradient(90deg, rgba(var(--accent-gold-rgb), 0.3), rgba(var(--primary-green-rgb), 0.15));
    }
    
    .league-standings-table td {
        padding: 0.6rem 0.5rem;
        text-align: center;
    }
    
    .league-standings-table td:nth-child(2) {
        text-align: left;
    }
    
    .league-team-cell {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .league-team-logo {
        width: 24px;
        height: 24px;
        object-fit: contain;
        border-radius: 4px;
    }
    
    .league-team-name {
        font-weight: 500;
    }
    
    .league-position-cell {
        font-weight: bold;
        color: var(--primary-green);
    }
    
    .league-points-cell {
        font-weight: bold;
        color: var(--primary-maroon);
        font-size: 1.1rem;
    }
    
    /* Responsive - Hide less important columns on mobile */
    @media (max-width: 768px) {
        .league-standings-table {
            font-size: 0.85rem;
        }
        
        .league-standings-table th,
        .league-standings-table td {
            padding: 0.5rem 0.3rem;
        }
        
        .league-standings-table .hide-mobile {
            display: none;
        }
        
        .league-team-logo {
            width: 20px;
            height: 20px;
        }
        
        .league-team-name {
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    }
    
    @media (max-width: 480px) {
        .league-team-name {
            max-width: 80px;
        }
    }
    </style>

    <!-- League Table JavaScript - Multi-Team Support -->
    <script>
    // Global variables for league table
    window.leagueTablesConfig = [];
    let currentLeagueConfig = null;
    
    (async function initLeagueTable() {
        // Get league settings from CMS
        let settings = {};
        try {
            const cached = localStorage.getItem('olrfc_site-settings');
            if (cached) settings = JSON.parse(cached);
        } catch (e) {}
        
        // Parse league tables array
        try {
            window.leagueTablesConfig = JSON.parse(settings['league-tables'] || '[]');
        } catch (e) {
            window.leagueTablesConfig = [];
        }
        
        // Fallback to legacy single config if no multi-config exists
        if (window.leagueTablesConfig.length === 0 && settings['league-division']) {
            window.leagueTablesConfig = [{
                id: 'legacy',
                teamName: "Men's 1st XV",
                division: settings['league-division'] || '66509',
                competition: settings['league-competition'] || '1597',
                season: settings['league-season'] || '2025-2026',
                clubName: settings['league-club-name'] || 'Old Laurentian',
                isDefault: true
            }];
        }
        
        // If still no configs, use hardcoded defaults
        if (window.leagueTablesConfig.length === 0) {
            window.leagueTablesConfig = [{
                id: 'default',
                teamName: "Men's 1st XV",
                division: '66509',
                competition: '1597',
                season: '2025-2026',
                clubName: 'Old Laurentian',
                isDefault: true
            }];
        }
        
        // Setup team filter dropdown if multiple configs
        const filterContainer = document.getElementById('league-team-filter');
        const filterSelect = document.getElementById('league-team-select-display');
        
        if (window.leagueTablesConfig.length > 1 && filterContainer && filterSelect) {
            // Show filter
            filterContainer.style.display = 'block';
            
            // Populate dropdown
            filterSelect.innerHTML = window.leagueTablesConfig.map(config => 
                `<option value="${config.id}" ${config.isDefault ? 'selected' : ''}>${config.teamName}</option>`
            ).join('');
        }
        
        // Find default config
        currentLeagueConfig = window.leagueTablesConfig.find(c => c.isDefault) || window.leagueTablesConfig[0];
        
        // Load the default table
        await loadLeagueTableData(currentLeagueConfig);
    })();
    
    /**
     * Switch to a different team's league table
     */
    async function switchLeagueTable(configId) {
        const config = window.leagueTablesConfig.find(c => c.id === configId);
        if (!config) return;
        
        currentLeagueConfig = config;
        
        // Show loading state
        const loading = document.getElementById('league-table-loading');
        const container = document.getElementById('league-table-data');
        const fallback = document.getElementById('league-table-fallback');
        
        if (loading) loading.style.display = 'block';
        if (container) container.style.display = 'none';
        if (fallback) fallback.style.display = 'none';
        
        await loadLeagueTableData(config);
    }
    
    /**
     * Load league table data for a specific config
     */
    async function loadLeagueTableData(config) {
        const container = document.getElementById('league-table-data');
        const loading = document.getElementById('league-table-loading');
        const fallback = document.getElementById('league-table-fallback');
        const footer = document.getElementById('league-table-footer');
        const subtitle = document.getElementById('league-table-subtitle');
        const teamTitle = document.getElementById('league-team-title');
        const externalLink = document.getElementById('league-table-external-link');
        const rfuLink = document.getElementById('league-table-rfu-link');
        
        // Mobile compact card elements
        const mobilePosition = document.getElementById('league-mobile-position');
        const mobileLink = document.getElementById('league-mobile-link');
        
        const { division, competition, season, clubName, teamName, rfuTeamId, tableIndex } = config; // OLS 132: tableIndex used as tableSelector
        
        // Update title
        if (teamTitle) {
            teamTitle.textContent = teamName || 'Current League Standings';
        }
        
        // Build RFU URL for fallback links - handle all URL formats
        let rfuUrl;
        if (division && division.startsWith('team:')) {
            // Team-only format
            const teamId = division.replace('team:', '');
            rfuUrl = `https://www.englandrugby.com/fixtures-and-results/search-results?team=${teamId}&season=${season}#related-teams-tables`;
        } else if (rfuTeamId) {
            // Full format with team ID
            rfuUrl = `https://www.englandrugby.com/fixtures-and-results/search-results?team=${rfuTeamId}&competition=${competition}&division=${division}&season=${season}#tables`;
        } else {
            // Division/competition only format
            rfuUrl = `https://www.englandrugby.com/fixtures-and-results/search-results?competition=${competition}&division=${division}&season=${season}#tables`;
        }
        
        if (externalLink) externalLink.href = rfuUrl;
        if (rfuLink) rfuLink.href = rfuUrl;
        if (mobileLink) mobileLink.href = rfuUrl;
        
        try {
            // OLS 132: Build fetch URL for Puppeteer-based scraper
            // Puppeteer uses team ID to navigate, then tableSelector to pick the right "View Full Table"
            let fetchUrl;
            
            // Extract team ID from rfuTeamId or division
            let teamId = rfuTeamId || '';
            if (!teamId && division && division.startsWith('team:')) {
                teamId = division.replace('team:', '');
            }
            
            if (teamId) {
                fetchUrl = `/.netlify/functions/league-table?team=${teamId}&season=${season}`;
            } else {
                // Fallback to division/competition format
                fetchUrl = `/.netlify/functions/league-table?division=${division}&competition=${competition}&season=${season}`;
            }
            
            // Add tableSelector if specified (which "View Full Table" link to click)
            if (tableIndex !== undefined && tableIndex !== null) {
                fetchUrl += `&tableSelector=${tableIndex}`;
            }
            
            // Fetch league table data from our Puppeteer scraper function
            const response = await fetch(fetchUrl);
            
            if (!response.ok) throw new Error('Failed to fetch standings');
            
            const result = await response.json();
            
            if (!result.success || !result.data?.standings?.length) {
                throw new Error('No standings data');
            }
            
            const standings = result.data.standings;
            
            // Find our club's position
            const ourTeam = standings.find(team => 
                team.team.name.toLowerCase().includes(clubName.toLowerCase())
            );
            
            // Update mobile card with our position (only for default/first config)
            if (mobilePosition && ourTeam && config.isDefault) {
                const positionSuffix = getOrdinalSuffix(ourTeam.position);
                mobilePosition.textContent = `${ourTeam.position}${positionSuffix} Place ‚Ä¢ ${ourTeam.points} pts`;
            }
            
            // Update subtitle
            const scrapedDate = result.data.scrapedAt ? new Date(result.data.scrapedAt) : new Date();
            if (subtitle) {
                subtitle.textContent = `${result.data.season} Season ‚Ä¢ Updated ${scrapedDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}`;
            }
            
            // Build table HTML
            // Mobile shows: #, Team, P, W, PF, Pts (6 cols)
            // Desktop shows all 10 columns
            const tableHtml = `
                <table class="league-standings-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Team</th>
                            <th>P</th>
                            <th>W</th>
                            <th class="hide-mobile">D</th>
                            <th class="hide-mobile">L</th>
                            <th>PF</th>
                            <th class="hide-mobile">PA</th>
                            <th class="hide-mobile">+/-</th>
                            <th>Pts</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${standings.map(team => {
                            const isHighlight = team.team.name.toLowerCase().includes(clubName.toLowerCase());
                            return `
                                <tr class="${isHighlight ? 'highlight-club' : ''}">
                                    <td class="league-position-cell">${team.position}</td>
                                    <td>
                                        <div class="league-team-cell">
                                            ${team.team.logo ? `<img src="${team.team.logo}" alt="" class="league-team-logo" onerror="this.style.display='none'">` : ''}
                                            <span class="league-team-name">${team.team.name}</span>
                                        </div>
                                    </td>
                                    <td>${team.played}</td>
                                    <td>${team.won}</td>
                                    <td class="hide-mobile">${team.drawn}</td>
                                    <td class="hide-mobile">${team.lost}</td>
                                    <td>${team.pointsFor}</td>
                                    <td class="hide-mobile">${team.pointsAgainst}</td>
                                    <td class="hide-mobile">${team.pointsDiff > 0 ? '+' : ''}${team.pointsDiff}</td>
                                    <td class="league-points-cell">${team.points}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            if (container) {
                container.innerHTML = tableHtml;
                container.style.display = 'block';
            }
            
            // Show table, hide loading
            if (loading) loading.style.display = 'none';
            if (footer) footer.style.display = 'block';
            if (fallback) fallback.style.display = 'none';
            
            console.log(`‚úÖ League table loaded for ${teamName}:`, standings.length, 'teams');
            
        } catch (error) {
            console.error('‚ùå League table error:', error);
            
            // Show fallback
            if (loading) loading.style.display = 'none';
            if (fallback) fallback.style.display = 'block';
            if (subtitle) subtitle.textContent = 'View standings on England Rugby';
        }
    }
    
    // Helper function for ordinal suffixes (1st, 2nd, 3rd, etc.)
    function getOrdinalSuffix(n) {
        const s = ['th', 'st', 'nd', 'rd'];
        const v = n % 100;
        return s[(v - 20) % 10] || s[v] || s[0];
    }
    </script>


    <!-- üìÖ CLUB CALENDAR SECTION -->
<section class="calendar-section" style="padding: 4rem 0; background: var(--bg-light);">
    <div class="container">
        <h2 class="section-title fade-in">üìÖ Club Calendar</h2>
        <p style="text-align: center; color: var(--text-light); margin-bottom: 2rem; font-size: 1.1rem;">
            View all upcoming fixtures, social events, training sessions, and club activities
        </p>
        
        <!-- üéØ CALENDAR FILTER - RESPONSIVE (Dropdown on Mobile, Buttons on Desktop) -->
        <div class="calendar-filters" style="background: rgba(var(--primary-green-rgb), 0.05); padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem;">
            <h3 style="color: var(--primary-green); text-align: center; margin-bottom: 1rem; font-size: 1.2rem;">
                üìã Filter Calendar View
            </h3>
            
            <!-- MOBILE DROPDOWN (hidden on desktop) - Dynamically populated -->
            <div class="calendar-filter-mobile">
                <select id="calendar-filter-select" onchange="filterCalendarType(this.value)" 
                        style="width: 100%; padding: 1rem; border: 2px solid var(--primary-green); border-radius: 10px; font-size: 1rem; font-weight: bold; color: var(--primary-green); background: white; cursor: pointer;">
                    <option value="all">üìÖ All Events</option>
                    <!-- Options populated dynamically by JavaScript -->
                </select>
            </div>
            
            <!-- DESKTOP BUTTONS (hidden on mobile) - Dynamically populated -->
            <div class="calendar-filter-desktop" id="homepage-filter-buttons">
                <button class="calendar-filter-btn active" onclick="filterCalendarType('all')" 
                        style="padding: 0.8rem 1.5rem; border: 2px solid var(--primary-green); background: var(--primary-green); color: white; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; font-size: 1rem;">
                    üìÖ All Events
                </button>
                <!-- Buttons populated dynamically by JavaScript -->
                <span id="homepage-filter-loading" style="color: var(--text-light); font-size: 0.9rem;">Loading...</span>
            </div>
            
            <p style="text-align: center; margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                üí° Select a filter to show only that event type, or "All Events" to see everything
            </p>
        </div>
        
        <!-- üéØ NEW CUSTOM CALENDAR WIDGET -->
        <div id="ols-calendar-widget"></div>
        

        
    </div>
</section>

<!-- üì± CALENDAR FILTER RESPONSIVE STYLES -->
<style>
/* Show buttons on desktop, hide dropdown */
.calendar-filter-desktop {
    display: flex !important;
    gap: 0.75rem;
    flex-wrap: wrap;
    justify-content: center;
}
.calendar-filter-mobile {
    display: none !important;
}

/* Hide buttons on mobile, show dropdown */
@media (max-width: 768px) {
    .calendar-filter-desktop {
        display: none !important;
    }
    .calendar-filter-mobile {
        display: block !important;
    }
    
    .calendar-section .container > p {
        font-size: 1rem !important;
        padding: 0 1rem;
    }
}

/* Calendar filter button hover styles */
.calendar-filter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.calendar-filter-btn.active {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
}
</style>

<!-- üì± MOBILE RESPONSIVE STYLES -->
<style>
@media (max-width: 768px) {
    .calendar-section .calendar-container {
        padding: 1rem !important;
    }
    
    .calendar-section iframe {
        height: 500px !important;
    }
    
    .calendar-section .container > p {
        font-size: 1rem !important;
        padding: 0 1rem;
    }
    
    .calendar-section div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
        gap: 0.75rem !important;
    }
    
    .calendar-filters div[style*="display: flex"] {
        flex-direction: column !important;
        align-items: stretch !important;
    }
    
    .calendar-filter-btn {
        width: 100% !important;
        text-align: center !important;
    }
}

/* Calendar filter button styles */
.calendar-filter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.calendar-filter-btn.active {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
}
</style>

<!-- üìÖ Calendar Filter JavaScript -->
<script>
function filterCalendar(type) {
    // Hide all calendar views
    document.querySelectorAll('.calendar-view').forEach(view => {
        view.style.display = 'none';
    });
    
    // Show selected calendar view
    const selectedView = document.getElementById('calendar-' + type);
    if (selectedView) {
        selectedView.style.display = 'block';
    }
    
    // Update button styles
    document.querySelectorAll('.calendar-filter-btn').forEach(btn => {
        btn.classList.remove('active');
        const btnColor = btn.style.color;
        btn.style.background = 'white';
        btn.style.color = btnColor;
    });
    
    // Style active button
    const activeBtn = document.querySelector(`[data-calendar="${type}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        if (type === 'all') {
            activeBtn.style.background = 'var(--primary-green)';
            activeBtn.style.color = 'white';
        } else {
            const btnBorder = activeBtn.style.borderColor;
            activeBtn.style.background = btnBorder;
            activeBtn.style.color = 'white';
        }
    }
}
</script>

    <!-- Club Stats -->
    <section class="stats-section">
        <div class="container">
            <div class="stats-grid fade-in">
                <div class="stat-item">
                    <span class="stat-number">450+</span>
                    <span class="stat-label">Club Members</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">100+</span>
                    <span class="stat-label">Years of Heritage</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">3</span>
                    <span class="stat-label">Wins This Season</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">2</span>
                    <span class="stat-label">Senior Teams</span>
                </div>
            </div>
        </div>
    </section>

    <!-- About Section - Content CMS controlled via homepage-about-content -->
    <section id="about" class="about-section">
        <div class="container">
            <h2 class="section-title fade-in">Welcome to Our Club</h2>
            <div class="about-grid">
                <div class="about-text fade-in">
                    <p style="color: var(--text-light);">Loading club information...</p>
                </div>
                <div class="about-image fade-in">
                    <img src="images/backgrounds/club-heritage.png" 
                         alt="Club Heritage - Historic team photo" 
                         style="width: 100%; height: auto; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                </div>
            </div>
        </div>
    </section>

    <!-- Club Info Card -->
    <section style="padding: 3rem 0; background: var(--bg-light);">
        <div class="container">
            <div style="background: white; padding: 2.5rem; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                
                <h2 style="color: var(--primary-green); text-align: center; margin-bottom: 2.5rem; font-size: 2rem;">
                    üìç Find Us & Join Us
                </h2>
                
                <!-- OLS 117: Dynamic Club Address from Site Settings -->
                <div id="club-address-container" style="text-align: center; padding: 2rem; background: var(--bg-light); border-radius: 12px; margin-bottom: 2rem;">
                    <div style="font-size: 2.5rem; margin-bottom: 1rem;">üìç</div>
                    <h3 style="color: var(--primary-green); margin-bottom: 1rem; font-size: 1.3rem;">Club Address</h3>
                    <p id="club-address-text" style="color: var(--text-dark); line-height: 1.6; font-size: 1.1rem;">
                        <strong>Loading...</strong>
                    </p>
                    <a id="club-address-directions" 
                       href="#" 
                       target="_blank"
                       style="display: inline-block; margin-top: 1rem; color: var(--primary-maroon); text-decoration: none; font-weight: bold; font-size: 1.1rem;">
                        Get Directions ‚Üí
                    </a>
                </div>

                <h3 style="color: var(--primary-maroon); text-align: center; margin-bottom: 1.5rem; font-size: 1.5rem;">
                    Training Times
                </h3>

                <!-- OLS 117: Dynamic Training Times from Teams Data -->
                
                <!-- DESKTOP: Grid View -->
                <div class="training-times-desktop" id="training-times-desktop">
                    <!-- Populated dynamically by JavaScript -->
                    <div style="text-align: center; padding: 2rem; grid-column: 1 / -1;">
                        <p style="color: var(--text-light);">Loading training times...</p>
                    </div>
                </div>

                <!-- MOBILE: Accordion View -->
                <div class="training-times-mobile" id="training-times-mobile">
                    <!-- Populated dynamically by JavaScript -->
                    <div style="text-align: center; padding: 2rem;">
                        <p style="color: var(--text-light);">Loading training times...</p>
                    </div>
                </div>

                <script>
                /**
                 * OLS 131: Dynamic Club Info Section with Section-Based Training Times
                 * Loads venue address from site-settings and training times grouped by club sections
                 */
                (async function loadClubInfoSection() {
                    try {
                        // ========== CLUB ADDRESS ==========
                        // Try cache first, then fetch fresh
                        let settings = JSON.parse(localStorage.getItem('olrfc_site-settings') || '{}');
                        
                        // Apply address immediately from cache
                        applyClubAddress(settings);
                        
                        // Fetch fresh settings in background
                        try {
                            const response = await fetch('/.netlify/functions/site-settings');
                            if (response.ok) {
                                const result = await response.json();
                                settings = result.data || {};
                                localStorage.setItem('olrfc_site-settings', JSON.stringify(settings));
                                applyClubAddress(settings);
                            }
                        } catch (e) {
                            console.warn('Could not fetch fresh site settings:', e);
                        }
                        
                        // ========== TRAINING TIMES ==========
                        // Get club sections from settings
                        const clubSections = getClubSections(settings);
                        
                        // Try cache first for teams
                        let teams = JSON.parse(localStorage.getItem('olrfc_teams') || '[]');
                        renderTrainingTimes(clubSections, teams);
                        
                        // Fetch fresh teams in background
                        try {
                            const teamsResponse = await fetch('/.netlify/functions/teams');
                            if (teamsResponse.ok) {
                                const teamsResult = await teamsResponse.json();
                                teams = teamsResult.data || [];
                                localStorage.setItem('olrfc_teams', JSON.stringify(teams));
                                renderTrainingTimes(clubSections, teams);
                            }
                        } catch (e) {
                            console.warn('Could not fetch fresh teams:', e);
                        }
                        
                    } catch (error) {
                        console.error('Error loading club info section:', error);
                    }
                    
                    /**
                     * Get club sections from settings
                     */
                    function getClubSections(settings) {
                        const defaultSections = [
                            { id: 'senior', name: 'Senior', icon: 'üèâ', order: 1, trainingMode: 'none' },
                            { id: 'ladies', name: 'Ladies', icon: 'üë©', order: 2, trainingMode: 'none' },
                            { id: 'minis', name: 'Minis & Juniors', icon: 'üë∂', order: 3, trainingMode: 'none' }
                        ];
                        
                        try {
                            if (settings['club-sections']) {
                                return JSON.parse(settings['club-sections']);
                            }
                        } catch (e) {
                            console.warn('Could not parse club sections:', e);
                        }
                        
                        return defaultSections;
                    }
                    
                    /**
                     * Apply club address from settings
                     */
                    function applyClubAddress(settings) {
                        const venueName = settings['contacts-venue-name'] || 'Club Venue';
                        const venueStreet = settings['contacts-venue-street'] || '';
                        const venueCity = settings['contacts-venue-city'] || '';
                        
                        // Parse city/postcode (might be combined or separate)
                        const cityParts = venueCity.split(',').map(s => s.trim());
                        
                        const addressEl = document.getElementById('club-address-text');
                        const directionsEl = document.getElementById('club-address-directions');
                        
                        if (addressEl) {
                            addressEl.innerHTML = `
                                <strong>${venueName}</strong><br>
                                ${venueStreet}<br>
                                ${cityParts.join('<br>')}
                            `;
                        }
                        
                        if (directionsEl) {
                            // Build Google Maps query
                            const mapsQuery = encodeURIComponent(`${venueName} ${venueStreet} ${venueCity}`);
                            directionsEl.href = `https://maps.google.com/?q=${mapsQuery}`;
                        }
                    }
                    
                    /**
                     * OLS 131: Render training times grouped by club sections
                     * Teams with identical schedules are automatically grouped together
                     */
                    function renderTrainingTimes(clubSections, teams) {
                        const desktopContainer = document.getElementById('training-times-desktop');
                        const mobileContainer = document.getElementById('training-times-mobile');
                        
                        // Normalize team training data to slots format
                        const normalizeSlots = (team) => {
                            // New format: trainingSlots array
                            if (team.trainingSlots && Array.isArray(team.trainingSlots) && team.trainingSlots.length > 0) {
                                return team.trainingSlots.map(s => ({
                                    day: s.day,
                                    startTime: s.startTime,
                                    endTime: s.endTime
                                })).sort((a, b) => {
                                    const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                                    return dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day);
                                });
                            }
                            
                            // Legacy format: trainingDays + single time
                            let days = team.trainingDays || [];
                            if (typeof days === 'string') {
                                days = days.split(/[&,]/).map(d => d.trim()).filter(Boolean);
                            }
                            if (Array.isArray(days) && days.length > 0) {
                                const startTime = team.trainingStartTime || '';
                                const endTime = team.trainingEndTime || '';
                                return days.map(day => ({ day, startTime, endTime })).sort((a, b) => {
                                    const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                                    return dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day);
                                });
                            }
                            
                            return [];
                        };
                        
                        // Create schedule key for grouping
                        const getScheduleKey = (slots) => {
                            return slots.map(s => `${s.day}|${s.startTime}|${s.endTime}`).join(';;');
                        };
                        
                        // Build sections that have at least one team with training enabled
                        const sectionsWithTraining = [];
                        
                        clubSections.forEach(section => {
                            // Get all teams in this section that have training enabled
                            const sectionTeams = teams
                                .filter(t => t.clubSection === section.id && t.showInTraining)
                                .map(t => ({ ...t, normalizedSlots: normalizeSlots(t) }))
                                .filter(t => t.normalizedSlots.length > 0)
                                .sort((a, b) => (a.displayOrder || 99) - (b.displayOrder || 99));
                            
                            if (sectionTeams.length > 0) {
                                // Group teams by identical schedule
                                const scheduleGroups = {};
                                
                                sectionTeams.forEach(team => {
                                    const scheduleKey = getScheduleKey(team.normalizedSlots);
                                    
                                    if (!scheduleGroups[scheduleKey]) {
                                        scheduleGroups[scheduleKey] = {
                                            teams: [],
                                            slots: team.normalizedSlots
                                        };
                                    }
                                    scheduleGroups[scheduleKey].teams.push(team);
                                });
                                
                                sectionsWithTraining.push({
                                    ...section,
                                    scheduleGroups: Object.values(scheduleGroups)
                                });
                            }
                        });
                        
                        // Sort by trainingSortOrder
                        sectionsWithTraining.sort((a, b) => (a.trainingSortOrder || 99) - (b.trainingSortOrder || 99));
                        
                        console.log('üèâ Training Times:', sectionsWithTraining.map(s => ({
                            name: s.name,
                            groups: s.scheduleGroups.map(g => ({
                                teams: g.teams.map(t => t.name),
                                slots: g.slots
                            }))
                        })));
                        
                        // Check if we have any content to show
                        if (sectionsWithTraining.length === 0) {
                            const emptyMsg = '<div style="text-align: center; padding: 2rem; grid-column: 1 / -1;"><p style="color: var(--text-light);">Training schedule coming soon</p></div>';
                            if (desktopContainer) desktopContainer.innerHTML = emptyMsg;
                            if (mobileContainer) mobileContainer.innerHTML = emptyMsg.replace('grid-column: 1 / -1;', '');
                            return;
                        }
                        
                        // Color schemes for visual variety
                        const colorSchemes = [
                            { border: 'var(--primary-green)', title: 'var(--primary-green)', bg: 'rgba(var(--primary-green-rgb), 0.1), rgba(var(--primary-maroon-rgb), 0.05)' },
                            { border: 'var(--accent-gold)', title: 'var(--primary-maroon)', bg: 'rgba(var(--accent-gold-rgb), 0.1), rgba(var(--primary-maroon-rgb), 0.05)' },
                            { border: 'var(--primary-green)', title: 'var(--primary-green)', bg: 'rgba(var(--primary-green-rgb), 0.05), rgba(var(--accent-gold-rgb), 0.05)' },
                            { border: 'var(--primary-maroon)', title: 'var(--primary-maroon)', bg: 'rgba(var(--primary-maroon-rgb), 0.05), rgba(var(--primary-green-rgb), 0.05)' }
                        ];
                        
                        // Format slots into HTML
                        const formatSlotsHtml = (slots) => {
                            return slots.map((slot, i) => {
                                const timeStr = formatTimeRange(slot.startTime, slot.endTime);
                                return `
                                    <p style="margin-bottom: ${i < slots.length - 1 ? '0.5rem' : '0'};">
                                        <strong>${slot.day}</strong><br>
                                        <span style="color: var(--text-light);">${timeStr}</span>
                                    </p>
                                `;
                            }).join('');
                        };
                        
                        // ===== DESKTOP GRID =====
                        if (desktopContainer) {
                            desktopContainer.innerHTML = sectionsWithTraining.map((section, index) => {
                                const colors = colorSchemes[index % colorSchemes.length];
                                
                                const groupsHtml = section.scheduleGroups.map((group, i) => {
                                    // Build team names (with notes)
                                    const teamNames = group.teams.map(t => {
                                        const notes = t.trainingNotes ? ` <span style="font-size: 0.8rem; color: var(--text-light);">(${t.trainingNotes})</span>` : '';
                                        return t.name + notes;
                                    }).join(' & ');
                                    
                                    const timesHtml = formatSlotsHtml(group.slots);
                                    const isLast = i === section.scheduleGroups.length - 1;
                                    
                                    return `
                                        <div style="${!isLast ? 'margin-bottom: 1.25rem; padding-bottom: 1.25rem; border-bottom: 1px dashed rgba(0,0,0,0.1);' : ''}">
                                            <h5 style="color: var(--primary-maroon); margin-bottom: 0.5rem; font-size: 1rem; font-weight: 600;">
                                                ${teamNames}
                                            </h5>
                                            <div style="color: var(--text-dark); line-height: 1.6; font-size: 0.95rem;">
                                                ${timesHtml}
                                            </div>
                                        </div>
                                    `;
                                }).join('');
                                
                                return `
                                    <div style="padding: 1.5rem; background: linear-gradient(135deg, ${colors.bg}); border-radius: 12px; border: 2px solid ${colors.border};">
                                        <h4 style="color: ${colors.title}; margin-bottom: 1rem; font-size: 1.1rem; text-align: center; font-weight: bold; padding-bottom: 0.75rem; border-bottom: 2px solid ${colors.border};">
                                            ${section.icon ? section.icon + ' ' : ''}${section.name}
                                        </h4>
                                        ${groupsHtml}
                                    </div>
                                `;
                            }).join('');
                        }
                        
                        // ===== MOBILE ACCORDION =====
                        if (mobileContainer) {
                            mobileContainer.innerHTML = sectionsWithTraining.map((section, index) => {
                                const colors = colorSchemes[index % colorSchemes.length];
                                
                                const groupsHtml = section.scheduleGroups.map((group, i) => {
                                    const teamNames = group.teams.map(t => {
                                        const notes = t.trainingNotes ? ` <span style="font-size: 0.85rem; color: var(--text-light);">(${t.trainingNotes})</span>` : '';
                                        return t.name + notes;
                                    }).join(' & ');
                                    
                                    const timesHtml = formatSlotsHtml(group.slots);
                                    const isLast = i === section.scheduleGroups.length - 1;
                                    
                                    return `
                                        <div style="${!isLast ? 'margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed rgba(0,0,0,0.1);' : ''}">
                                            <strong style="color: var(--primary-maroon);">${teamNames}</strong>
                                            <div style="margin-top: 0.5rem; line-height: 1.6;">
                                                ${timesHtml}
                                            </div>
                                        </div>
                                    `;
                                }).join('');
                                
                                return `
                                    <div class="accordion-item" style="margin-bottom: 0.5rem; border-radius: 10px; overflow: hidden; border: 2px solid ${colors.border};">
                                        <button class="accordion-header" onclick="toggleTrainingAccordion(this)" 
                                                style="width: 100%; padding: 1rem; background: linear-gradient(135deg, ${colors.bg}); border: none; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: ${colors.title}; font-size: 1.1rem;">
                                            <span>${section.icon ? section.icon + ' ' : ''}${section.name}</span>
                                            <span class="accordion-icon">‚ñº</span>
                                        </button>
                                        <div class="accordion-content" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; background: white;">
                                            <div style="padding: 1rem;">
                                                ${groupsHtml}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        }
                    }
                    
                    /**
                     * OLS 131: Format training schedule into HTML
                     * Accepts either new format (array + times) or legacy format (string)
                     */
                    function formatTrainingTimes(data) {
                        // Handle new format: { trainingDays: [...], trainingStartTime, trainingEndTime }
                        if (data && Array.isArray(data.trainingDays)) {
                            const days = data.trainingDays;
                            if (days.length === 0) return '<p style="color: var(--text-light);">Schedule TBC</p>';
                            
                            const timeStr = formatTimeRange(data.trainingStartTime, data.trainingEndTime);
                            
                            return days.map((day, i) => `
                                <p style="margin-bottom: ${i < days.length - 1 ? '0.5rem' : '0'};">
                                    <strong>${day}</strong><br>
                                    <span style="color: var(--text-light);">${timeStr}</span>
                                </p>
                            `).join('');
                        }
                        
                        // Legacy format fallback: string days and times
                        if (data && typeof data.trainingDays === 'string' && data.trainingDays) {
                            const dayList = data.trainingDays.split(/[&,]/).map(d => d.trim()).filter(Boolean);
                            const timeLines = (data.trainingTimes || '').split('\n').map(t => t.trim()).filter(Boolean);
                            
                            if (timeLines.length <= 1) {
                                const timeDisplay = timeLines[0] || 'Time TBC';
                                return dayList.map((day, i) => `
                                    <p style="margin-bottom: ${i < dayList.length - 1 ? '0.5rem' : '0'};">
                                        <strong>${day}</strong><br>
                                        <span style="color: var(--text-light);">${timeDisplay}</span>
                                    </p>
                                `).join('');
                            }
                            
                            return timeLines.map((line, i) => `
                                <p style="margin-bottom: ${i < timeLines.length - 1 ? '0.5rem' : '0'};">
                                    <span style="color: var(--text-light);">${line}</span>
                                </p>
                            `).join('');
                        }
                        
                        return '<p style="color: var(--text-light);">Schedule TBC</p>';
                    }
                    
                    /**
                     * Format time range from 24h inputs to readable format
                     */
                    function formatTimeRange(startTime, endTime) {
                        if (!startTime && !endTime) return 'Time TBC';
                        
                        const formatTime = (time) => {
                            if (!time) return '';
                            const [hours, minutes] = time.split(':');
                            const h = parseInt(hours);
                            const suffix = h >= 12 ? 'pm' : 'am';
                            const displayHour = h > 12 ? h - 12 : (h === 0 ? 12 : h);
                            return minutes === '00' ? `${displayHour}${suffix}` : `${displayHour}:${minutes}${suffix}`;
                        };
                        
                        const start = formatTime(startTime);
                        const end = formatTime(endTime);
                        
                        if (start && end) return `${start} - ${end}`;
                        if (start) return `From ${start}`;
                        if (end) return `Until ${end}`;
                        return 'Time TBC';
                    }
                })();

                /**
                 * Toggle accordion for mobile training times
                 */
                function toggleTrainingAccordion(button) {
                    const content = button.nextElementSibling;
                    const icon = button.querySelector('.accordion-icon');
                    const isOpen = content.style.maxHeight && content.style.maxHeight !== '0px';
                    
                    if (isOpen) {
                        content.style.maxHeight = '0';
                        icon.textContent = '‚ñº';
                    } else {
                        content.style.maxHeight = content.scrollHeight + 'px';
                        icon.textContent = '‚ñ≤';
                    }
                }
                </script>

                <div style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon)); border-radius: 12px; text-align: center; color: white;">
                    <p style="font-size: 1.1rem; margin: 0;">
                        <strong>Questions?</strong> Get in touch: 
                        <a id="contact-email-link" href="#" style="color: var(--accent-gold); text-decoration: none; font-weight: bold;">Loading...</a>
                    </p>
                </div>
                <script>
                // Load contact email from CMS settings
                (function() {
                    const emailLink = document.getElementById('contact-email-link');
                    if (!emailLink) return;
                    
                    // Try cache first
                    try {
                        const settings = JSON.parse(localStorage.getItem('olrfc_site-settings') || '{}');
                        const email = settings['contacts-email'] || settings['contact-email'] || 'info@rugbyclub.com';
                        emailLink.href = 'mailto:' + email;
                        emailLink.textContent = email;
                    } catch (e) {
                        emailLink.href = 'mailto:info@rugbyclub.com';
                        emailLink.textContent = 'info@rugbyclub.com';
                    }
                })();
                </script>

            </div>
        </div>
    </section>

    <style>
    /* Training Times Responsive */
    .training-times-desktop {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    .training-times-mobile {
        display: none !important;
        margin-bottom: 2rem;
    }
    
    /* Fixtures Team Filter Responsive */
    .fixtures-filter-desktop {
        display: flex !important;
    }
    .fixtures-filter-mobile {
        display: none !important;
    }
    
    @media (max-width: 768px) {
        .training-times-desktop {
            display: none !important;
        }
        .training-times-mobile {
            display: block !important;
        }
        
        .fixtures-filter-desktop {
            display: none !important;
        }
        .fixtures-filter-mobile {
            display: block !important;
        }
        
        section[style*="padding: 3rem 0"] .container > div {
            padding: 1.5rem !important;
        }
        
        section[style*="padding: 3rem 0"] h2 {
            font-size: 1.5rem !important;
        }
        
        section[style*="padding: 3rem 0"] h3 {
            font-size: 1.2rem !important;
        }
        
        section[style*="padding: 3rem 0"] h4 {
            font-size: 1rem !important;
        }
    }
    </style>

    <!-- Footer -->
    <!-- Universal Footer -->
    <div id="footer-placeholder" data-page="home"></div>

    <!-- Scripts -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="js/main.js"></script>
    <script src="js/animations.js"></script>
    <script src="js/olrfc-netlify-data.js"></script>
    <script src="js/admin-data-loader.js"></script>
    <script src="js/news-filter.js"></script>
    <script src="js/fixtures-filter.js"></script>
    <script src="js/calendar-data-fetcher.js"></script>
    <script src="js/calendar-widget.js"></script>
    <script src="js/header.js"></script>
    <script src="js/footer.js"></script>
    <script src="js/seo-manager.js"></script>

    <script>
        // üéØ OLS 25 FIX: Enhanced Sponsor Banner Loader
        class SponsorBannerLoader {
    constructor() {
        this.sponsors = [];
        this.animationFrameId = null; // Track animation to prevent multiple instances
        this.isLoading = false; // Prevent concurrent loads
        this.debounceTimer = null; // Debounce rapid calls
        this.currentSponsorIds = null; // Track current sponsors to detect changes
        this.isAnimating = false; // Track if animation is running smoothly
        this.init();
    }

    init() {
        console.log('üîÑ SponsorBannerLoader initialized, waiting for feature states...');
        
        // Listen for data updates with debouncing
        // Only listen to storage events for sponsor-specific changes
        window.addEventListener('storage', (e) => {
            if (e.key === 'olrfc_sponsors') {
                this.debouncedLoad();
            }
        });
        window.addEventListener('olrfcDataReady', () => {
            console.log('üîÑ Admin data ready, loading sponsors...');
            this.debouncedLoad();
        });
        window.addEventListener('olrfcFeaturesUpdated', () => {
            console.log('üîÑ Features updated, reloading sponsor banner...');
            this.debouncedLoad();
        });
    }

    // Debounced load to prevent rapid multiple calls
    debouncedLoad() {
        if (this.debounceTimer) {
            clearTimeout(this.debounceTimer);
        }
        this.debounceTimer = setTimeout(() => {
            this.loadSponsorBanner();
        }, 300); // 300ms debounce - better for mobile
    }

    shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    // Get sponsors from localStorage (synced by admin-data-loader.js)
    getSponsorsFromCache() {
        try {
            const data = localStorage.getItem('olrfc_sponsors');
            if (!data) return [];
            
            const sponsors = JSON.parse(data);
            const activeSponsors = sponsors.filter(s => s.active === true || s.active === 'true');
            
            console.log('üìä Sponsors from cache:', sponsors.length, 'total,', activeSponsors.length, 'active');
            return activeSponsors;
        } catch (e) {
            console.error('‚ùå Error reading sponsors from cache:', e);
            return [];
        }
    }

    async loadSponsorBanner() {
        // Prevent concurrent loads
        if (this.isLoading) {
            console.log('‚ö†Ô∏è Load already in progress, skipping...');
            return;
        }
        
        this.isLoading = true;
        console.log('üîÑ Loading sponsor banner...');
        
        try {
            // Check admin toggle
            const sponsorFeatureEnabled = window.featureStates?.sponsors || false;
            console.log('üéØ Sponsor feature (from global state):', sponsorFeatureEnabled);
            
            const bannerElement = document.getElementById('sponsorBanner');
            const tickerElement = document.getElementById('sponsorTickerMain');
            
            if (!bannerElement || !tickerElement) {
                console.log('‚ùå Banner elements not found');
                return;
            }

            // Hide if admin disabled
            if (!sponsorFeatureEnabled) {
                bannerElement.style.display = 'none';
                bannerElement.classList.remove('ready');
                // Stop animation if running
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                    this.isAnimating = false;
                }
                console.log('üö´ Sponsor banner hidden: Admin disabled');
                return;
            }

            // üéØ Get sponsors from localStorage (synced by admin-data-loader.js)
            // admin-data-loader.js runs BEFORE this and syncs all data to localStorage
            const activeSponsors = this.getSponsorsFromCache();

            // If no sponsors, hide banner
            if (activeSponsors.length === 0) {
                console.log('‚è≥ No sponsors available yet (admin-data-loader may still be syncing)');
                bannerElement.style.display = 'none';
                bannerElement.classList.remove('ready');
                // Stop animation if running
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                    this.isAnimating = false;
                }
                return;
            }

            // Check if sponsors have actually changed
            const newSponsorIds = activeSponsors.map(s => s.id).sort().join(',');
            if (this.currentSponsorIds === newSponsorIds && this.isAnimating) {
                console.log('‚úÖ Sponsors unchanged, keeping current animation');
                return;
            }
            
            // Sponsors changed, update and restart animation
            this.currentSponsorIds = newSponsorIds;
            console.log('üîÑ Sponsors changed, reinitializing...');
            
            // Cancel any existing animation to prevent multiple instances
            if (this.animationFrameId) {
                cancelAnimationFrame(this.animationFrameId);
                this.animationFrameId = null;
                this.isAnimating = false;
                console.log('üõë Cancelled previous animation');
            }
            
            // Remove ready class to prepare for smooth fade-in
            bannerElement.classList.remove('ready');

            // Show banner with sponsors
            bannerElement.style.display = 'block';
            console.log('‚úÖ Sponsor banner visible with', activeSponsors.length, 'sponsors');
            
            // Randomize order (different on each page load)
            const randomizedSponsors = this.shuffleArray(activeSponsors);
            
            // Double the array so when first set scrolls off, second set is already visible
            const sponsorLogos = [...randomizedSponsors, ...randomizedSponsors];
            
            tickerElement.innerHTML = '';
            
            sponsorLogos.forEach(sponsor => {
                const logoDiv = document.createElement('div');
                logoDiv.className = 'sponsor-logo-banner';
                
                if (sponsor.website) {
                    logoDiv.onclick = () => window.open(sponsor.website, '_blank');
                    logoDiv.style.cursor = 'pointer';
                }

                if (sponsor.logo) {
                    logoDiv.innerHTML = `<img src="${sponsor.logo}" alt="${sponsor.name}" title="${sponsor.name}">`;
                } else {
                    logoDiv.className += ' placeholder';
                    logoDiv.textContent = sponsor.name;
                    logoDiv.title = sponsor.name;
                }

                tickerElement.appendChild(logoDiv);
            });

            // Wait for all images to load before starting animation
            const images = tickerElement.querySelectorAll('img');
            const imageLoadPromises = Array.from(images).map(img => {
                if (img.complete) {
                    return Promise.resolve();
                }
                return new Promise((resolve) => {
                    img.onload = resolve;
                    img.onerror = resolve; // Still resolve even if image fails to prevent blocking
                });
            });

            // Wait for images to load (with timeout fallback)
            await Promise.race([
                Promise.all(imageLoadPromises),
                new Promise(resolve => setTimeout(resolve, 1000)) // 1s timeout fallback
            ]);

            // Small delay to ensure layout is stable
            await new Promise(resolve => setTimeout(resolve, 50));

            // Continuous scroll with requestAnimationFrame (no timed resets)
            let scrollPosition = 0;
            let lastTime = performance.now();
            
            // Detect actual mobile devices, not just narrow windows
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || window.innerWidth <= 480;
            const pixelsPerSecond = isMobile ? 55 : 60; // Mobile faster, desktop slower
            
            // Calculate actual width dynamically - measure after DOM renders and images load
            const allLogos = tickerElement.querySelectorAll('.sponsor-logo-banner');
            const gapSize = 2; // 0.125rem = 2px
            let singleSetWidth = 0;
            
            // Sum up width of first half only (since we duplicate)
            for (let i = 0; i < allLogos.length / 2; i++) {
                singleSetWidth += allLogos[i].offsetWidth + gapSize;
            }
            
            const scroll = (currentTime) => {
                const deltaTime = (currentTime - lastTime) / 1000; // Convert to seconds
                lastTime = currentTime;
                
                scrollPosition += pixelsPerSecond * deltaTime; // Distance = speed √ó time
                
                // When first set completely scrolls off, reset position (seamless because second set is identical)
                if (scrollPosition >= singleSetWidth) {
                    scrollPosition = 0;
                }
                
                tickerElement.style.transform = `translateX(-${scrollPosition}px)`;
                this.animationFrameId = requestAnimationFrame(scroll);
            };
            
            // Start animation and fade in banner smoothly
            this.animationFrameId = requestAnimationFrame(scroll);
            this.isAnimating = true;
            bannerElement.classList.add('ready');
            
            console.log('‚úÖ', activeSponsors.length, 'sponsors,', pixelsPerSecond, 'px/s', isMobile ? '(mobile device)' : '(desktop)', 'Width:', singleSetWidth + 'px');
        } finally {
            // Always release the lock
            this.isLoading = false;
        }
    }
}

        // Fixtures Timeline (unchanged from your version)
        class FixturesTimeline {
            constructor() {
                this.currentTeam = 'all';
                this.timeline = document.getElementById('fixtures-timeline');
                // üéØ OLS 129: Add arrays for gallery and match report linking
                this.galleries = [];
                this.newsArticles = [];
                this.init();
            }

            async init() {
                this.setupTeamFilters();
                this.setupDataUpdateListeners();
                // üéØ OLS 129: Load galleries and news for action buttons
                await this.loadGalleries();
                await this.loadNewsArticles();
                this.loadTimelineData();
            }

            setupDataUpdateListeners() {
                window.addEventListener('olrfcDataReady', () => {
                    console.log('üîÑ FixturesTimeline: Data ready, reloading...');
                    this.loadTimelineData();
                });
                
                window.addEventListener('storage', (e) => {
                    if (e.key === 'olrfc_fixtures') {
                        console.log('üîÑ Fixtures updated, reloading...');
                        this.loadTimelineData();
                    }
                });
            }

            setupTeamFilters() {
                // Desktop buttons
                const filterButtons = document.querySelectorAll('.team-filter-btn');
                filterButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        filterButtons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentTeam = btn.getAttribute('data-team');
                        this.loadTimelineData();
                    });
                });
                
                // Mobile dropdown
                const mobileSelect = document.getElementById('fixtures-team-select');
                if (mobileSelect) {
                    mobileSelect.addEventListener('change', (e) => {
                        this.currentTeam = e.target.value;
                        this.loadTimelineData();
                        
                        // Also update desktop buttons if switching between views
                        filterButtons.forEach(b => b.classList.remove('active'));
                        const matchingBtn = document.querySelector(`.team-filter-btn[data-team="${e.target.value}"]`);
                        if (matchingBtn) matchingBtn.classList.add('active');
                    });
                }
            }

            getData(key) {
                try {
                    return JSON.parse(localStorage.getItem(`olrfc_${key}`)) || [];
                } catch (e) {
                    console.error(`Error loading ${key}:`, e);
                    return [];
                }
            }

            getTeamName(teamSlug) {
                const teams = this.getData('teams');
                const team = teams.find(t => t.slug === teamSlug);
                return team ? team.name : 'OLS';
            }

            // üéØ OLS 129: Load galleries for fixture matching
            async loadGalleries() {
                try {
                    const cachedGalleries = this.getData('gallery');
                    if (cachedGalleries && cachedGalleries.length > 0) {
                        this.galleries = cachedGalleries;
                        return;
                    }
                    
                    const response = await fetch('/.netlify/functions/gallery');
                    if (response.ok) {
                        const result = await response.json();
                        this.galleries = result.data || [];
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not load galleries:', error);
                    this.galleries = [];
                }
            }

            // üéØ OLS 129: Load news articles for match report matching
            async loadNewsArticles() {
                try {
                    const cachedNews = this.getData('news');
                    if (cachedNews && cachedNews.length > 0) {
                        this.newsArticles = cachedNews;
                        return;
                    }
                    
                    const response = await fetch('/.netlify/functions/news');
                    if (response.ok) {
                        const result = await response.json();
                        this.newsArticles = result.data || [];
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not load news:', error);
                    this.newsArticles = [];
                }
            }

            // üéØ OLS 129: Find gallery linked to a fixture
            getGalleryForFixture(fixtureId) {
                return this.galleries.find(gallery => gallery.fixtureId === fixtureId || gallery.fixture === fixtureId);
            }

            // üéØ OLS 129: Find match report linked to a fixture
            getMatchReportForFixture(fixtureId) {
                return this.newsArticles.find(article => {
                    if (!article.fixtureId || article.fixtureId === '' || article.fixtureId === null) {
                        return false;
                    }
                    return article.fixtureId === fixtureId;
                });
            }

            // üéØ OLS 129: Render action buttons for fixture card
            renderActionButtons(match) {
                const gallery = this.getGalleryForFixture(match.id);
                const matchReport = this.getMatchReportForFixture(match.id);
                const hasMatchReport = matchReport && matchReport.id;
                const hasGallery = gallery && gallery.id;
                const hasTeamsheet = match.teamsheetUrl && match.teamsheetUrl !== '';
                
                // If no content at all, return empty
                if (!hasTeamsheet && !hasMatchReport && !hasGallery) {
                    return '';
                }
                
                let buttons = [];
                
                if (hasTeamsheet) {
                    buttons.push(`<button class="timeline-action-btn" onclick="event.stopPropagation(); openTimelineTeamsheet('${match.teamsheetUrl}', '${match.opponent}')" title="View Teamsheet">üë§</button>`);
                }
                
                if (hasMatchReport) {
                    buttons.push(`<button class="timeline-action-btn timeline-action-report" onclick="event.stopPropagation(); window.location.href='pages/news-article.html?id=${matchReport.id}'" title="Match Report">‚úçÔ∏è</button>`);
                }
                
                if (hasGallery) {
                    buttons.push(`<button class="timeline-action-btn" onclick="event.stopPropagation(); window.location.href='pages/gallery.html?id=${gallery.id}'" title="Photo Gallery">üì∏</button>`);
                }
                
                return `<div class="timeline-action-buttons">${buttons.join('')}</div>`;
            }

            loadTimelineData() {
                // Show all teams if 'all' is selected, otherwise filter by specific team
                const dynamicData = this.currentTeam === 'all' 
                    ? this.getData('fixtures')
                    : this.getData('fixtures').filter(f => f.team === this.currentTeam);
                
                if (dynamicData.length === 0) {
                    this.showLoadingState();
                    return;
                }
                
                const timelineData = this.combineFixtureData([], dynamicData);
                timelineData.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                const currentDate = new Date();
                let currentIndex = -1;
                
                // Find the most recent match that has BOTH: datetime passed AND has scores
                for (let i = timelineData.length - 1; i >= 0; i--) {
                    const matchDateTime = new Date(timelineData[i].date);
                    if (matchDateTime < currentDate && timelineData[i].isResult) {
                        currentIndex = i;
                        break;
                    }
                }
                
                // If no results found, highlight the next upcoming match
                if (currentIndex === -1) {
                    currentIndex = timelineData.findIndex(match => new Date(match.date) >= currentDate);
                    if (currentIndex === -1) currentIndex = 0;
                }
                
                this.renderTimeline(timelineData, currentIndex);
                this.scrollToCurrentMatch(currentIndex);
            }

            showLoadingState() {
                if (!this.timeline) return;
                this.timeline.innerHTML = `
                    <div style="flex: 0 0 320px; background: white; border-radius: 15px; padding: 2rem; text-align: center; box-shadow: var(--shadow);">
                        <div style="display: inline-block; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-green); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem;"></div>
                        <h3 style="color: var(--primary-green); margin-bottom: 0.5rem;">Loading Fixtures...</h3>
                        <p style="color: var(--text-light); font-size: 0.9rem;">Fetching latest match data</p>
                    </div>
                `;
            }

            combineFixtureData(staticData, dynamicData) {
                let combined = [];
                dynamicData.forEach(dynFixture => {
                    // Check if scores are actually entered (not null, not empty string, not undefined)
                    const hasValidScores = dynFixture.ourScore !== null && 
                                          dynFixture.ourScore !== '' && 
                                          dynFixture.ourScore !== undefined &&
                                          dynFixture.theirScore !== null && 
                                          dynFixture.theirScore !== '' && 
                                          dynFixture.theirScore !== undefined;
                    
                    combined.push({
                        id: dynFixture.id, // üéØ OLS 129: Include ID for action buttons
                        date: dynFixture.dateTime,
                        opponent: dynFixture.opponent,
                        team: dynFixture.team, // Include team slug
                        isResult: hasValidScores,
                        type: hasValidScores ? 'result' : 'fixture',
                        ourScore: dynFixture.ourScore,
                        theirScore: dynFixture.theirScore,
                        venue: dynFixture.venue === 'home' ? 'Home Ground' : 'Away',
                        competition: dynFixture.competition || 'Friendly',
                        time: new Date(dynFixture.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        matchStatus: dynFixture.matchStatus || 'played',
                        teamsheetUrl: dynFixture.teamsheetUrl || null // üéØ OLS 129: Include teamsheet URL
                    });
                });
                return combined;
            }

            renderTimeline(timelineData, currentIndex) {
                this.timeline.innerHTML = '';
                const currentDate = new Date();
                
                timelineData.forEach((match, index) => {
                    const card = document.createElement('div');
                    const matchDateTime = new Date(match.date);  // Full datetime comparison
                    const hasDateTimePassed = matchDateTime < currentDate;  // More explicit naming
                    const isCurrent = index === currentIndex;
                    const isPast = hasDateTimePassed && match.isResult;
                    const isFuture = !hasDateTimePassed;  // DateTime hasn't passed yet
                    
                    const isCancelled = match.matchStatus === 'cancelled';
                    const isPostponed = match.matchStatus === 'postponed';
                    const isNotPlayed = isCancelled || isPostponed;

                    card.className = `fixture-timeline-card ${isCancelled ? 'cancelled-match' : ''} ${isPostponed ? 'postponed-match' : ''} ${!isNotPlayed && isCurrent ? 'current-match' : ''} ${!isNotPlayed && isPast ? 'past-match' : ''} ${!isNotPlayed && isFuture ? 'future-match' : ''}`;

                    let statusText = 'Upcoming';
                    let statusClass = 'upcoming';

                    if (isCancelled) {
                        statusText = 'Cancelled';
                        statusClass = 'cancelled';
                    } else if (isPostponed) {
                        statusText = 'Postponed';
                        statusClass = 'postponed';
                    // Only show as result/pending if the DATETIME has actually passed
                    } else if (hasDateTimePassed && match.isResult) {
                        statusText = isCurrent ? 'Latest Result' : 'Past Result';
                        statusClass = isCurrent ? 'current' : 'past';
                    } else if (hasDateTimePassed && !match.isResult) {
                        statusText = 'Result Pending';
                        statusClass = 'upcoming';
                    }

                    if (isNotPlayed) {
                        const teamDisplay = this.getTeamName(match.team);
                        const statusLabel = isCancelled ? 'Cancelled' : 'Postponed';
                        card.innerHTML = `
                            <div class="match-status ${statusClass}">${statusText}</div>
                            <div class="match-teams-timeline" style="text-decoration: line-through; opacity: 0.6;">${teamDisplay} vs ${match.opponent}</div>
                            <div class="match-score-timeline" style="font-size: 1.2rem; color: ${isCancelled ? '#6c757d' : '#ff9800'};">Match ${statusLabel}</div>
                            <div class="match-date-timeline">${this.formatDate(match.date)}</div>
                            <div class="match-details-timeline">
                                ${match.venue}<br>
                                <strong>${statusLabel}</strong>
                            </div>
                            <div class="match-competition-timeline">${match.competition || 'Friendly'}</div>
                        `;
                    } else if (match.isResult && hasDateTimePassed) {
                        const isWin = parseInt(match.ourScore) > parseInt(match.theirScore);
                        const isDraw = parseInt(match.ourScore) === parseInt(match.theirScore);
                        const resultText = isWin ? 'Victory' : isDraw ? 'Draw' : 'Defeat';
                        
                        // Always show team name for clarity
                        const teamDisplay = this.getTeamName(match.team);
                        
                        // üéØ OLS 129: Get action buttons
                        const actionButtons = this.renderActionButtons(match);
                        
                        card.innerHTML = `
                            <div class="match-status ${statusClass}">${statusText}</div>
                            <div class="match-teams-timeline">${teamDisplay} vs ${match.opponent}</div>
                            <div class="match-score-timeline">${match.ourScore} - ${match.theirScore}</div>
                            <div class="match-date-timeline">${this.formatDate(match.date)}</div>
                            <div class="match-details-timeline">
                                ${match.venue}<br>
                                <strong>${resultText}</strong>
                            </div>
                            <div class="match-competition-timeline">${match.competition || 'Friendly'}</div>
                            ${actionButtons}
                        `;
                    } else {
                        // Always show team name for clarity
                        const teamDisplay = this.getTeamName(match.team);
                        
                        // üéØ OLS 129: Get action buttons (teamsheet may be available for upcoming)
                        const actionButtons = this.renderActionButtons(match);
                        
                        card.innerHTML = `
                            <div class="match-status ${statusClass}">${statusText}</div>
                            <div class="match-teams-timeline">${teamDisplay} vs ${match.opponent}</div>
                            <div class="match-score-timeline">${match.time || '15:00'}</div>
                            <div class="match-date-timeline">${this.formatDate(match.date)}</div>
                            <div class="match-details-timeline">
                                ${match.venue}<br>
                                <strong>Kick-off: ${match.time || '15:00'}</strong>
                            </div>
                            <div class="match-competition-timeline">${match.competition || 'Friendly'}</div>
                            ${actionButtons}
                        `;
                    }
                    
                    this.timeline.appendChild(card);
                });
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-GB', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
            }

            scrollToCurrentMatch(currentIndex) {
                setTimeout(() => {
                    const timeline = this.timeline;
                    const cards = timeline.querySelectorAll('.fixture-timeline-card');
                    
                    if (!cards[currentIndex]) {
                        if (cards[0]) timeline.scrollTo({ left: 0, behavior: 'smooth' });
                        return;
                    }
                    
                    const targetCard = cards[currentIndex];
                    const container = timeline.parentElement;
                    const containerWidth = container.offsetWidth;
                    const cardWidth = targetCard.offsetWidth;
                    const cardLeft = targetCard.offsetLeft;
                    const scrollPosition = cardLeft - (containerWidth / 2) + (cardWidth / 2);
                    
                    timeline.scrollTo({
                        left: Math.max(0, scrollPosition),
                        behavior: 'smooth'
                    });
                }, 300);
            }
        }

        function scrollTimeline(direction) {
            const timeline = document.getElementById('fixtures-timeline');
            const container = timeline.parentElement;
            const scrollAmount = container.offsetWidth * 0.8;
            
            if (direction === 'left') {
                timeline.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            } else {
                timeline.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            }
        }

        // üöÄ Enhanced feature state loading with event dispatch
        async function loadFeatureStates() {
    try {
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'GET'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        const settings = result.data || {};
        
        console.log('üìä Raw settings from Netlify:', settings);
        
        const featureStates = {
            shop: false,
            events: false,
            members: false,
            payments: false,
            sponsors: false
        };
        
        // Extract feature states from settings object
        Object.keys(settings).forEach(key => {
            if (key.startsWith('feature-')) {
                const featureName = key.replace('feature-', '');
                if (featureStates.hasOwnProperty(featureName)) {
                    featureStates[featureName] = settings[key] === 'true';
                }
            }
        });
        
        console.log('‚úÖ Feature states loaded from Netlify:', featureStates);
        
        // üöÄ CRITICAL: Store globally so sponsor banner can access it
        window.featureStates = featureStates;
        
        // Apply saved states to navigation
        Object.keys(featureStates).forEach(feature => {
            const navItems = document.querySelectorAll(`[data-admin-controlled="true"][data-feature="${feature}"]`);
            navItems.forEach(item => {
                item.classList.toggle('admin-enabled', featureStates[feature]);
            });
        });
        
        // üöÄ Dispatch event for sponsor banner
        window.dispatchEvent(new CustomEvent('olrfcFeaturesUpdated', { 
            detail: featureStates 
        }));
        
        return featureStates; // ‚Üê Return so we can await
        
    } catch (error) {
        console.error('‚ùå Error loading feature states:', error);
        
        // üì± Mobile fallback: Default sponsors to TRUE
        const fallbackStates = {
            shop: false,
            events: false,
            members: false,
            payments: false,
            sponsors: true  // ‚Üê Mobile users see banner by default
        };
        
        window.featureStates = fallbackStates;
        
        window.dispatchEvent(new CustomEvent('olrfcFeaturesUpdated', { 
            detail: fallbackStates 
        }));
        
        return fallbackStates;
    }
}
  
        // Initialize everything
        let sponsorBannerLoader;
        let fixturesTimeline;

        document.addEventListener('DOMContentLoaded', async function() {  // ‚Üê Made async
    console.log('üöÄ Page loaded, initializing...');
    
    // Initialize banner loader (but don't load yet)
    window.sponsorBannerLoader = new SponsorBannerLoader();
    
    // Initialize fixtures timeline
    window.fixturesTimeline = new FixturesTimeline();
    
    // üéØ CRITICAL: Load feature states FIRST
    console.log('‚è≥ Loading feature states from Netlify...');
    await loadFeatureStates();  // ‚Üê WAIT here until Netlify responds
    
    // ‚úÖ Sponsor banner loads automatically via 'olrfcFeaturesUpdated' event listener (100ms debounced)
    console.log('‚úÖ Feature states ready, sponsor banner will load automatically...');
    
    setTimeout(() => {
        console.log('üèâ Admin data already synced - news cards safe!');
    }, 2000);
    
    console.log('‚úÖ All components initialized');
});
    </script>

<script>
// üéØ INITIALIZE CALENDAR WIDGET
// Add this to your existing DOMContentLoaded function or create a new one

// Wait for page to load
window.addEventListener('load', async function() {
    console.log('üöÄ Initializing OLS Custom Calendar...');
    
    // Small delay to ensure other scripts have initialized
    setTimeout(async () => {
        try {
            // Create data fetcher
            const dataFetcher = new CalendarDataFetcher();
            
            // Build dynamic filter buttons from calendar config
            await buildHomepageFilterButtons(dataFetcher);
            
            // Create widget
            window.calendarWidget = new CalendarWidget('ols-calendar-widget', dataFetcher);
            
            console.log('‚úÖ OLS Custom Calendar ready!');
        } catch (error) {
            console.error('‚ùå Error initializing calendar:', error);
        }
    }, 500);
});

// OLS 124: Build dynamic filter buttons from calendar configuration
async function buildHomepageFilterButtons(dataFetcher) {
    const buttonContainer = document.getElementById('homepage-filter-buttons');
    const dropdown = document.getElementById('calendar-filter-select');
    
    // Wait for settings to load
    await dataFetcher.loadCalendarSettings();
    
    // Get available filters
    const filters = dataFetcher.getAvailableFilters();
    
    // Remove loading text
    const loadingEl = document.getElementById('homepage-filter-loading');
    if (loadingEl) loadingEl.remove();
    
    // Build desktop buttons
    if (buttonContainer) {
        let buttonsHTML = `
            <button class="calendar-filter-btn active" onclick="filterCalendarType('all')" 
                    style="padding: 0.8rem 1.5rem; border: 2px solid var(--primary-green); background: var(--primary-green); color: white; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; font-size: 1rem;">
                üìÖ All Events
            </button>
        `;
        
        filters.forEach(filter => {
            if (filter.id === 'all') return; // Skip 'all' - already added
            
            buttonsHTML += `
                <button class="calendar-filter-btn" onclick="filterCalendarType('${filter.type}')" 
                        style="padding: 0.8rem 1.5rem; border: 2px solid ${filter.color}; background: white; color: ${filter.color}; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; font-size: 1rem;">
                    <span style="display: inline-block; width: 12px; height: 12px; background: ${filter.color}; border-radius: 50%; margin-right: 0.5rem;"></span>
                    ${filter.label}
                </button>
            `;
        });
        
        buttonContainer.innerHTML = buttonsHTML;
    }
    
    // Build mobile dropdown
    if (dropdown) {
        let optionsHTML = '<option value="all">üìÖ All Events</option>';
        
        // Color emoji mapping for dropdown
        const colorEmojis = {
            '#e53935': 'üî¥', '#f44336': 'üî¥',  // Red
            '#1e88e5': 'üîµ', '#2196f3': 'üîµ',  // Blue
            '#43a047': 'üü¢', '#4caf50': 'üü¢',  // Green
            '#fb8c00': 'üü†', '#ff9800': 'üü†',  // Orange
            '#8e24aa': 'üü£', '#9c27b0': 'üü£',  // Purple
            '#607d8b': '‚ö™',                    // Grey
        };
        
        filters.forEach(filter => {
            if (filter.id === 'all') return;
            
            const emoji = colorEmojis[filter.color] || 'üìå';
            optionsHTML += `<option value="${filter.type}">${emoji} ${filter.label}</option>`;
        });
        
        dropdown.innerHTML = optionsHTML;
    }
    
    console.log('‚úÖ Homepage filter buttons built:', filters.length, 'filters');
}

// Filter function for the filter buttons
function filterCalendarType(type) {
    if (window.calendarWidget) {
        window.calendarWidget.filterByType(type);
    }
    
    // Update button styles
    document.querySelectorAll('.calendar-filter-btn').forEach(btn => {
        btn.classList.remove('active');
        const btnColor = btn.style.color;
        btn.style.background = 'white';
        btn.style.color = btnColor;
    });
    
    // Style active button
    const clickedBtn = event.target.closest('.calendar-filter-btn');
    if (clickedBtn) {
        clickedBtn.classList.add('active');
        if (type === 'all') {
            clickedBtn.style.background = 'var(--primary-green)';
            clickedBtn.style.color = 'white';
        } else {
            const btnBorder = clickedBtn.style.borderColor;
            clickedBtn.style.background = btnBorder;
            clickedBtn.style.color = 'white';
        }
    }
}

// Close popup when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('day-popup-modal');
    if (modal && e.target === modal && window.calendarWidget) {
        window.calendarWidget.closePopup();
    }
});

// Close popup with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('day-popup-modal');
        if (modal && modal.style.display !== 'none' && window.calendarWidget) {
            window.calendarWidget.closePopup();
        }
    }
});
</script>

    <!-- Hidden Netlify Forms for data persistence -->
<form name="olrfc-sponsors" netlify netlify-honeypot="bot-field" hidden>
  <input type="text" name="form-name" value="olrfc-sponsors" />
  <input type="text" name="id" />
  <input type="text" name="name" />
  <input type="text" name="logo" />
  <input type="text" name="website" />
  <input type="text" name="tier" />
  <input type="text" name="phone" />
  <input type="text" name="email" />
  <input type="text" name="address" />
  <input type="text" name="active" />
  <input type="text" name="showInBanner" />
  <input type="text" name="description" />
  <input type="text" name="startDate" />
  <input type="text" name="endDate" />
  <input type="text" name="createdAt" />
</form>

<!-- üéØ ADD THIS NEW FORM -->
<form name="olrfc-news" netlify netlify-honeypot="bot-field" hidden>
  <input type="text" name="form-name" value="olrfc-news" />
  <input type="text" name="id" />
  <input type="text" name="title" />
  <textarea name="content"></textarea>
  <input type="text" name="category" />
  <input type="text" name="author" />
  <input type="text" name="date" />
  <input type="text" name="image" />
  <input type="text" name="featured" />
</form>


<!-- ============================================================================ -->
<!-- DYNAMIC CMS CONTENT LOADER - OLS 94 -->
<!-- Dual-loading approach: localStorage first (instant), then Netlify refresh -->
<!-- ============================================================================ -->
<script>
(async function() {
    try {
        let settingsToApply = null;
        let loadedFromCache = false;
        
        // üöÄ STEP 1: Check localStorage FIRST (instant, no flash)
        const cachedSettings = localStorage.getItem('olrfc_site-settings');
        if (cachedSettings) {
            try {
                settingsToApply = JSON.parse(cachedSettings);
                loadedFromCache = true;
                console.log('‚ö° Using cached settings (instant load, no flash)');
                applyContent(settingsToApply);
                document.body.classList.add('cms-content-loaded'); // Show content immediately
            } catch (e) {
                console.warn('‚ö†Ô∏è Cache parse error:', e);
            }
        }
        
        // üåê STEP 2: Fetch fresh data from Netlify (background refresh OR first load)
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'GET'
        });
        
        if (response.ok) {
            const result = await response.json();
            const freshSettings = result.data || {};
            
            // Update localStorage cache
            localStorage.setItem('olrfc_site-settings', JSON.stringify(freshSettings));
            
            // Only re-apply if content changed OR this is first load
            if (!loadedFromCache) {
                console.log('üì° First load: applying fresh settings from Netlify');
                applyContent(freshSettings);
                document.body.classList.add('cms-content-loaded'); // Show content with fade-in
            } else if (JSON.stringify(freshSettings) !== cachedSettings) {
                console.log('üîÑ Content updated, refreshing page...');
                applyContent(freshSettings);
            }
        } else if (!loadedFromCache) {
            // No cache AND Netlify failed - show defaults
            console.log('‚ö†Ô∏è No cache, Netlify unavailable - using defaults');
            document.body.classList.add('cms-content-loaded'); // Show defaults
        }
        
        function applyContent(settingsData) {
            // Build content map (only homepage fields)
            const content = {};
            Object.keys(settingsData).forEach(key => {
                if (key.startsWith('homepage-')) {
                    content[key] = settingsData[key];
                }
            });
            
            // Helper function to get content with fallback
            const get = (key, fallback) => content[key] || fallback;
            
            // 1. Page Title
            const pageTitle = get('homepage-page-title', 'Rugby Club');
            document.title = pageTitle;
            
            // 2. Hero Section - Heading
            const heroHeading = document.querySelector('.hero h1');
            if (heroHeading) {
                const headingText = get('homepage-hero-heading', 'Welcome to Our Club');
                heroHeading.textContent = headingText;
            }
            
            // 3. Hero Section - Tagline
            const heroTagline = document.querySelector('.hero p');
            if (heroTagline) {
                const taglineText = get('homepage-hero-tagline', 'Proudly representing tradition, excellence, and the spirit of rugby since our founding');
                heroTagline.textContent = taglineText;
            }
            
            // 4. Fixtures Section Title
            const fixturesSection = document.querySelector('#fixtures .section-title');
            if (fixturesSection) {
                const fixturesTitle = get('homepage-fixtures-title', 'Fixtures & Results');
                fixturesSection.textContent = fixturesTitle;
            }
            
            // 5. Social Section Title (after fixtures)
            const socialSection = document.querySelector('.live-social-section .section-title');
            if (socialSection) {
                const socialTitle = get('homepage-social-title', 'Our Socials');
                socialSection.textContent = socialTitle;
            }
            
            // 6. News Section Title
            const newsSection = document.querySelector('#news .section-title');
            if (newsSection) {
                const newsTitle = get('homepage-news-title', 'Latest News');
                newsSection.textContent = newsTitle;
            }
            
            // 7. League Table Section Title
            const leagueSection = document.querySelector('.rfu-league-section .section-title');
            if (leagueSection) {
                const leagueTitle = get('homepage-league-title', 'League Table');
                leagueSection.textContent = leagueTitle;
            }
            
            // 8. Calendar Section Title
            const calendarSection = document.querySelector('.calendar-section .section-title');
            if (calendarSection) {
                const calendarTitle = get('homepage-calendar-title', 'üìÖ Club Calendar');
                calendarSection.textContent = calendarTitle;
            }
            
            // 9. About Section Title
            const aboutSection = document.querySelector('#about .section-title');
            if (aboutSection) {
                const aboutTitle = get('homepage-about-title', 'About Our Club');
                aboutSection.textContent = aboutTitle;
            }
            
            // 10. Find Us Section Title
            const findUsTitle = document.querySelector('section[style*="padding: 3rem 0; background: var(--bg-light)"] h2');
            if (findUsTitle && findUsTitle.textContent.includes('üìç')) {
                const findUsText = get('homepage-findus-title', 'üìç Find Us & Join Us');
                findUsTitle.textContent = findUsText;
            }
            
            // 11. Training Times Title
            const trainingTitle = document.querySelector('h3[style*="color: var(--primary-maroon); text-align: center"]');
            if (trainingTitle && trainingTitle.textContent.includes('Training')) {
                const trainingText = get('homepage-training-title', 'Training Times');
                trainingTitle.textContent = trainingText;
            }
            
            // 12-19. Stats Section (4 stats with numbers + labels)
            const statItems = document.querySelectorAll('.stat-item');
            if (statItems.length >= 4) {
                // Default values for fallback
                const defaultStats = [
                    { number: '450+', label: 'Club Members' },
                    { number: '100+', label: 'Years of Heritage' },
                    { number: '3', label: 'Wins This Season' },
                    { number: '2', label: 'Senior Teams' }
                ];
                
                // Update each stat
                for (let i = 1; i <= 4; i++) {
                    const stat = statItems[i - 1];
                    const number = stat.querySelector('.stat-number');
                    const label = stat.querySelector('.stat-label');
                    
                    if (number) {
                        const numValue = get(`homepage-stat${i}-number`, defaultStats[i - 1].number);
                        number.textContent = numValue;
                    }
                    
                    if (label) {
                        const labelValue = get(`homepage-stat${i}-label`, defaultStats[i - 1].label);
                        label.textContent = labelValue;
                    }
                }
            }
            
            // 20. About Content (with paragraph handling)
            const aboutText = document.querySelector('.about-text');
            if (aboutText) {
                const aboutContent = get('homepage-about-content', '');
                
                if (aboutContent) {
                    // Clear existing paragraphs
                    aboutText.innerHTML = '';
                    
                    // Split by line breaks and create new paragraphs
                    const paragraphs = aboutContent.split(/\n+/).filter(p => p.trim());
                    
                    if (paragraphs.length > 0) {
                        paragraphs.forEach(paraText => {
                            const p = document.createElement('p');
                            p.textContent = paraText.trim();
                            aboutText.appendChild(p);
                        });
                    }
                }
            }
            
            // 21. Instagram URL - convert to embed format
            const instagramUrl = get('homepage-instagram-url', '');
            if (instagramUrl) {
                // Smart processing: convert profile URL to embed URL
                let embedUrl = instagramUrl;
                if (!embedUrl.endsWith('/embed')) {
                    embedUrl = embedUrl.replace(/\/$/, '') + '/embed';
                }
                
                // Update Instagram iframe
                const instagramIframe = document.querySelector('.instagram-iframe');
                if (instagramIframe) {
                    instagramIframe.src = embedUrl;
                }
            }
            
            // 22. Facebook URL - convert to plugin format for desktop, direct for mobile
            const facebookUrl = get('homepage-facebook-url', '');
            if (facebookUrl) {
                // Desktop: Facebook plugin iframe
                const facebookIframe = document.querySelector('#facebook-desktop iframe');
                if (facebookIframe) {
                    const encodedUrl = encodeURIComponent(facebookUrl);
                    const pluginUrl = `https://www.facebook.com/plugins/page.php?href=${encodedUrl}&tabs=timeline&width=500&height=700&small_header=false&adapt_container_width=true&hide_cover=false&show_facepile=true`;
                    facebookIframe.src = pluginUrl;
                }
                
                // Mobile: Direct link button
                const facebookMobileBtn = document.querySelector('#facebook-mobile-link');
                if (facebookMobileBtn) {
                    facebookMobileBtn.href = facebookUrl;
                }
            }
            
            // 23. League Table URL - apply to all 3 locations
            const leagueUrl = get('homepage-league-url', 'https://www.englandrugby.com/fixtures-and-results/search-results?division=66509&competition=1597&season=2025-2026#tables');
            if (leagueUrl) {
                // Mobile button (in social section)
                const leagueMobileBtn = document.querySelector('.league-mobile-compact a');
                if (leagueMobileBtn) {
                    leagueMobileBtn.href = leagueUrl;
                }
                
                // Desktop button (in RFU league section)
                const leagueDesktopBtn = document.querySelector('#rfu-league-table a');
                if (leagueDesktopBtn) {
                    leagueDesktopBtn.href = leagueUrl;
                }
                
                // Desktop link (alternative location if exists)
                const leagueDesktopLink = document.querySelector('.league-desktop-only a');
                if (leagueDesktopLink) {
                    leagueDesktopLink.href = leagueUrl;
                }
            }
            
            // 24. Hero Background Image - Update CSS background-image
            const heroBackgroundUrl = get('homepage-hero-background', '');
            if (heroBackgroundUrl) {
                const heroSection = document.querySelector('.hero');
                if (heroSection) {
                    // Update the background-image URL in the inline style or via CSS
                    const currentBg = window.getComputedStyle(heroSection).backgroundImage;
                    const newBg = currentBg.replace(/url\(['"]?[^'"]*['"]?\)/g, `url('${heroBackgroundUrl}')`);
                    heroSection.style.backgroundImage = newBg;
                    console.log('üñºÔ∏è Hero background updated:', heroBackgroundUrl);
                }
            }
            
            // 25. Heritage/About Image - Update src
            const heritageImageUrl = get('homepage-heritage-image', '');
            if (heritageImageUrl) {
                const heritageImg = document.querySelector('.about-image img');
                if (heritageImg) {
                    heritageImg.src = heritageImageUrl;
                    console.log('üñºÔ∏è Heritage image updated:', heritageImageUrl);
                }
            }
            
            console.log('‚úÖ Homepage CMS content applied (25 fields)');
        }
        
    } catch (error) {
        console.error('‚ùå Error loading CMS content:', error);
        // Show defaults even if error
        document.body.classList.add('cms-content-loaded');
    }
})();
</script>

<!-- Dynamic Team Filters Loader -->
<script>
(function() {
    /**
     * Load teams from Netlify Blobs and populate fixtures team filters
     */
    async function loadTeamFilters() {
        try {
            console.log('üì• Loading teams from Netlify Blobs for fixtures filters...');
            
            // Fetch teams from Netlify Blobs
            const response = await fetch('/.netlify/functions/teams', {
                method: 'GET'
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch teams from Netlify');
            }
            
            const result = await response.json();
            let teams = result.data || [];
            
            // OLS 125: Sort teams by displayOrder (lower numbers first)
            teams = [...teams].sort((a, b) => {
                const orderA = a.displayOrder || 99;
                const orderB = b.displayOrder || 99;
                return orderA - orderB;
            });
            
            console.log(`üìä Loaded ${teams.length} teams for fixtures filters (sorted by displayOrder)`);
            
            // Get filter elements
            const mobileSelect = document.getElementById('fixtures-team-select');
            const desktopButtons = document.getElementById('team-filter-buttons');
            
            if (!mobileSelect || !desktopButtons) {
                console.warn('‚ö†Ô∏è Team filter elements not found');
                return;
            }
            
            // Clear existing content
            mobileSelect.innerHTML = '';
            desktopButtons.innerHTML = '';
            
            // Add "All Teams" option first
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.selected = true;
            allOption.textContent = 'All Teams';
            mobileSelect.appendChild(allOption);
            
            const allButton = document.createElement('button');
            allButton.className = 'team-filter-btn active';
            allButton.setAttribute('data-team', 'all');
            allButton.textContent = 'All Teams';
            desktopButtons.appendChild(allButton);
            
            // Add each team
            teams.forEach(team => {
                // Mobile dropdown option
                const option = document.createElement('option');
                option.value = team.slug;
                option.textContent = team.name;
                mobileSelect.appendChild(option);
                
                // Desktop button
                const button = document.createElement('button');
                button.className = 'team-filter-btn';
                button.setAttribute('data-team', team.slug);
                button.textContent = team.name;
                desktopButtons.appendChild(button);
            });
            
            console.log('‚úÖ Team filters loaded successfully from Netlify');
            
            // Trigger FixturesTimeline to re-setup filters now that buttons exist
            if (window.fixturesTimeline && typeof window.fixturesTimeline.setupTeamFilters === 'function') {
                console.log('üîÑ Re-initializing FixturesTimeline with new team buttons...');
                window.fixturesTimeline.setupTeamFilters();
            }
            
        } catch (error) {
            console.error('Error loading team filters:', error);
            
            // Fallback: add a basic "All Teams" option so page doesn't break
            const mobileSelect = document.getElementById('fixtures-team-select');
            const desktopButtons = document.getElementById('team-filter-buttons');
            
            if (mobileSelect && mobileSelect.children.length === 0) {
                mobileSelect.innerHTML = '<option value="all" selected>All Teams</option>';
            }
            
            if (desktopButtons && desktopButtons.children.length === 0) {
                const fallbackBtn = document.createElement('button');
                fallbackBtn.className = 'team-filter-btn active';
                fallbackBtn.setAttribute('data-team', 'all');
                fallbackBtn.textContent = 'All Teams';
                desktopButtons.appendChild(fallbackBtn);
            }
            
            console.log('‚ö†Ô∏è Using fallback: All Teams only');
        }
    }
    
    // Load team filters when page is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadTeamFilters);
    } else {
        loadTeamFilters();
    }
})();
</script>

<!-- ============================================ -->
<!-- üéØ OLS 129: TEAMSHEET MODAL FOR HOMEPAGE -->
<!-- ============================================ -->
<div id="timelineTeamsheetModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center;">
    <div class="teamsheet-modal-content" style="position: relative; background: white; border-radius: 12px; overflow: hidden; max-height: 95vh; max-width: min(500px, 90vw); display: flex; flex-direction: column;">
        <div style="background: var(--primary-green); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
            <h3 id="timelineTeamsheetTitle" style="margin: 0;">üìã Teamsheet</h3>
            <button onclick="closeTimelineTeamsheet()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
        </div>
        <div style="padding: 1rem; text-align: center; overflow: hidden; display: flex; justify-content: center; align-items: center; flex-grow: 1;">
            <img id="timelineTeamsheetImg" src="" alt="Teamsheet" style="max-height: calc(95vh - 80px); max-width: 100%; width: auto; height: auto; object-fit: contain; border-radius: 8px;">
        </div>
    </div>
</div>

<script>
// üéØ OLS 129: Teamsheet modal functions for homepage timeline
function openTimelineTeamsheet(imageUrl, opponent) {
    const modal = document.getElementById('timelineTeamsheetModal');
    const img = document.getElementById('timelineTeamsheetImg');
    const title = document.getElementById('timelineTeamsheetTitle');
    
    img.src = imageUrl;
    title.textContent = `üìã Teamsheet vs ${opponent}`;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeTimelineTeamsheet() {
    const modal = document.getElementById('timelineTeamsheetModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Close on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeTimelineTeamsheet();
    }
});

// Close on background click
document.getElementById('timelineTeamsheetModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'timelineTeamsheetModal') {
        closeTimelineTeamsheet();
    }
});
</script>

<!-- ============================================ -->
<!-- ADMIN LOGIN MODAL (OLS 97) -->
<!-- ============================================ -->
<div id="adminLoginModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h2>üîê Admin Login</h2>
            <span class="close" onclick="closeAdminLoginModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="adminLoginForm" onsubmit="handleAdminLogin(event)">
                <div class="form-group">
                    <label for="adminEmail">Email Address</label>
                    <input 
                        type="email" 
                        id="adminEmail" 
                        name="adminEmail" 
                        required 
                        placeholder="your.email@example.com"
                        autocomplete="email"
                    >
                </div>
                
                <div class="form-group">
                    <label for="adminPassword">Password</label>
                    <input 
                        type="password" 
                        id="adminPassword" 
                        name="adminPassword" 
                        required 
                        placeholder="Enter your password"
                        autocomplete="current-password"
                    >
                </div>
                
                <div id="loginError" class="error-message" style="display: none; color: #d32f2f; margin-bottom: 15px;"></div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeAdminLoginModal()">Cancel</button>
                    <button type="submit" class="btn-primary" id="loginButton">
                        <span id="loginButtonText">Login</span>
                        <span id="loginSpinner" style="display: none;">‚è≥ Logging in...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Admin Login Modal Styles (OLS 98 - Updated to match footer.js) */
/* Highly specific selectors to avoid conflicts with existing page styles */

#adminLoginModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 10000;
    justify-content: center;
    align-items: center;
}

#adminLoginModal.modal {
    display: none;
}

#adminLoginModal .modal-content {
    max-width: 400px;
    background: var(--white, #ffffff);
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    width: 90%;
}

#adminLoginModal .modal-header {
    padding: 20px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon));
    color: var(--white, #ffffff);
    border-radius: 8px 8px 0 0;
}

#adminLoginModal .modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
    color: var(--white, #ffffff);
}

#adminLoginModal .modal-header .close {
    background: transparent;
    border: none;
    color: var(--white, #ffffff);
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

#adminLoginModal .modal-header .close:hover {
    opacity: 0.7;
}

#adminLoginModal .modal-body {
    padding: 25px;
}

#adminLoginModal .form-group {
    margin-bottom: 20px;
}

#adminLoginModal .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--text-dark, #333);
    font-size: 14px;
}

#adminLoginModal .form-group input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
    font-family: inherit;
}

#adminLoginModal .form-group input:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 3px rgba(var(--primary-green-rgb), 0.1);
}

#adminLoginModal .form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 25px;
}

#adminLoginModal .btn-secondary {
    padding: 10px 20px;
    background: var(--bg-light, #f5f5f5);
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-family: inherit;
    color: var(--text-dark, #333);
}

#adminLoginModal .btn-secondary:hover {
    background: #e0e0e0;
}

#adminLoginModal .btn-primary {
    padding: 10px 25px;
    background: var(--primary-green);
    color: var(--white, #ffffff);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    font-family: inherit;
}

#adminLoginModal .btn-primary:hover {
    background: var(--primary-maroon);
}

#adminLoginModal .btn-primary:disabled {
    background: #ccc;
    cursor: not-allowed;
}

#adminLoginModal .error-message {
    padding: 10px;
    background: #ffebee;
    border: 1px solid #ef5350;
    border-radius: 4px;
    font-size: 14px;
    color: #d32f2f;
}
</style>

<script>
/**
 * ADMIN LOGIN FUNCTIONS (OLS 97)
 * These override/extend the toggleAdminDashboard from footer.js
 */

// Override toggleAdminDashboard to open modal instead of prompt
function toggleAdminDashboard(event) {
    // Save current scroll position
    const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
    // Prevent page jump when clicking the link
    if (event && event.preventDefault) {
        event.preventDefault();
    }
    
    openAdminLoginModal();
    
    // Restore scroll position immediately
    setTimeout(() => {
        window.scrollTo(0, scrollPosition);
    }, 0);
    
    return false; // Extra safety to prevent default behavior
}

// Open the login modal
function openAdminLoginModal(event) {
    // Prevent page jump if called from a link
    if (event && event.preventDefault) {
        event.preventDefault();
    }
    document.getElementById('adminLoginModal').style.display = 'flex';
    document.getElementById('adminEmail').focus();
    return false;
}

// Close the login modal
function closeAdminLoginModal() {
    document.getElementById('adminLoginModal').style.display = 'none';
    document.getElementById('adminLoginForm').reset();
    document.getElementById('loginError').style.display = 'none';
}

// Handle admin login form submission
async function handleAdminLogin(event) {
    event.preventDefault();
    
    const email = document.getElementById('adminEmail').value.trim();
    const password = document.getElementById('adminPassword').value;
    const loginButton = document.getElementById('loginButton');
    const loginButtonText = document.getElementById('loginButtonText');
    const loginSpinner = document.getElementById('loginSpinner');
    const errorDiv = document.getElementById('loginError');
    
    // Clear previous errors
    errorDiv.style.display = 'none';
    
    // Show loading state
    loginButton.disabled = true;
    loginButtonText.style.display = 'none';
    loginSpinner.style.display = 'inline';
    
    try {
        // Check if the data manager class is loaded
        if (typeof OLRFCNetlifyDataManager === 'undefined') {
            throw new Error('System not ready. Please refresh the page and try again.');
        }
        
        // Initialize netlifyDataManager if not already done
        if (typeof window.netlifyDataManager === 'undefined') {
            window.netlifyDataManager = new OLRFCNetlifyDataManager();
        }
        
        // Attempt login via serverless function
        const result = await window.netlifyDataManager.loginAdminUser(email, password);
        
        if (result.success && result.user) {
            // Create enhanced session with full user data
            const adminSession = {
                userId: result.user.id,
                username: result.user.username,
                email: result.user.email,
                role: result.user.role,
                permissions: result.user.permissions,
                loginTime: new Date().getTime(),
                expiresAt: new Date().getTime() + (24 * 60 * 60 * 1000) // 24 hours
            };
            
            localStorage.setItem('olrfc_admin_session', JSON.stringify(adminSession));
            
            console.log('‚úÖ Login successful:', result.user.username);
            
            // Redirect to admin dashboard
            window.location.href = 'pages/admin-dashboard.html';
        } else {
            throw new Error('Login failed - invalid response');
        }
    } catch (error) {
        console.error('Login error:', error);
        
        // Show error message
        errorDiv.textContent = error.message || 'Invalid email or password. Please try again.';
        errorDiv.style.display = 'block';
        
        // Reset button
        loginButton.disabled = false;
        loginButtonText.style.display = 'inline';
        loginSpinner.style.display = 'none';
        
        // Clear password field
        document.getElementById('adminPassword').value = '';
        document.getElementById('adminPassword').focus();
    }
}

// Close modal when clicking outside
window.addEventListener('click', function(event) {
    const modal = document.getElementById('adminLoginModal');
    if (event.target === modal) {
        closeAdminLoginModal();
    }
});

// Handle escape key
window.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('adminLoginModal');
        if (modal.style.display === 'flex') {
            closeAdminLoginModal();
        }
    }
});
</script>

</body>
</html>
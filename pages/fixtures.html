<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixtures & Results - Old Laurentian RFC</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <script src="../js/sanitize-html.js"></script>
    <script src="../js/shared-settings.js"></script>
    <script src="../js/color-manager.js"></script>
    <style>
        /* Admin controlled elements */
        .nav-item[data-admin-controlled="true"] {
            display: none;
        }

        .nav-item[data-admin-controlled="true"].admin-enabled {
            display: block;
        }

        /* Page-specific styles for fixtures */
        .fixtures-page-header {
            background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon));
            color: white;
            padding: 6rem 0 4rem;
            margin-top: 80px;
            text-align: center;
        }

        .fixtures-controls {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 3rem;
            position: sticky;
            top: 100px;
            z-index: 100;
        }

        .controls-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .team-selector-wrapper,
        .season-selector-wrapper {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .team-selector-wrapper label,
        .season-selector-wrapper label {
            font-weight: bold;
            color: var(--primary-green);
            font-size: 1.1rem;
        }

        .team-select,
        .season-select {
            padding: 0.8rem 1.5rem;
            border: 2px solid var(--primary-green);
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            background: white;
            color: var(--primary-green);
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .team-select:hover,
        .season-select:hover {
            background: var(--primary-green);
            color: white;
        }

        .team-select:focus,
        .season-select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(var(--primary-green-rgb), 0.2);
        }

        /* Mobile/Desktop visibility helpers */
        .mobile-only {
            display: none;
        }

        .desktop-only {
            display: flex;
        }

        /* View Toggle - OLS 121 */
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            background: #f5f5f5;
            padding: 0.3rem;
            border-radius: 25px;
        }

        .view-toggle-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 20px;
            background: transparent;
            color: var(--text-light);
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .view-toggle-btn:hover {
            color: var(--primary-green);
        }

        .view-toggle-btn.active {
            background: var(--primary-green);
            color: white;
        }

        /* Season Filter Buttons - OLS 121 */
        .season-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .season-filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--primary-maroon);
            border-radius: 20px;
            background: white;
            color: var(--primary-maroon);
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .season-filter-btn:hover {
            background: var(--primary-maroon);
            color: white;
        }

        .season-filter-btn.active {
            background: var(--primary-maroon);
            color: white;
        }

        .fixtures-section {
            margin-bottom: 4rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--accent-gold);
        }

        .section-title-small {
            color: var(--primary-green);
            font-size: 2rem;
            margin: 0;
        }

        .section-count {
            background: var(--accent-gold);
            color: var(--primary-green);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* Summary Stats */
        .fixtures-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .summary-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: var(--shadow);
            text-align: center;
            border-top: 4px solid var(--accent-gold);
        }

        .summary-number {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary-green);
            display: block;
            margin-bottom: 0.5rem;
        }

        .summary-label {
            color: var(--text-light);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .summary-detail {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        /* OLS 125: Recent Form Widget */
        .recent-form-widget {
            background: white;
            border-radius: 20px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .form-widget-header {
            text-align: center;
            margin-bottom: 1.25rem;
        }
        
        .form-widget-header h3 {
            color: var(--primary-green);
            font-size: 1.3rem;
            margin: 0;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid var(--accent-gold);
            display: inline-block;
        }
        
        .form-widget-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .form-indicators-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            width: 100%;
        }
        
        .form-match-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
            min-width: 80px;
            padding: 0.75rem 0.75rem;
            border-radius: 12px;
            background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%);
            border: 1px solid rgba(0,0,0,0.06);
            transition: all 0.25s ease;
        }
        
        .form-match-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        
        .form-result-badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.4rem;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .form-result-badge.win {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
        }
        
        .form-result-badge.draw {
            background: linear-gradient(135deg, #FFB300 0%, #FF8F00 100%);
        }
        
        .form-result-badge.loss {
            background: linear-gradient(135deg, #EF5350 0%, #C62828 100%);
        }
        
        .form-match-score {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .form-match-opponent {
            font-size: 0.75rem;
            color: var(--text-light);
            text-align: center;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .form-summary-row {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(0,0,0,0.06);
            width: 100%;
        }
        
        .form-summary-badge {
            padding: 0.5rem 1.25rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.95rem;
        }
        
        .form-summary-badge.wins {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(46, 125, 50, 0.15) 100%);
            color: #2E7D32;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .form-summary-badge.draws {
            background: linear-gradient(135deg, rgba(255, 179, 0, 0.15) 0%, rgba(255, 143, 0, 0.15) 100%);
            color: #E65100;
            border: 1px solid rgba(255, 179, 0, 0.3);
        }
        
        .form-summary-badge.losses {
            background: linear-gradient(135deg, rgba(239, 83, 80, 0.15) 0%, rgba(198, 40, 40, 0.15) 100%);
            color: #C62828;
            border: 1px solid rgba(239, 83, 80, 0.3);
        }
        
        .form-empty-message {
            color: var(--text-light);
            font-style: italic;
            padding: 1rem;
        }

        /* Card View */
        .fixtures-card-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
        }

        .fixture-card-large {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .fixture-card-large:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        .fixture-card-large.result {
            background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon));
            color: white;
        }

        .fixture-card-large.upcoming {
            border: 3px solid var(--accent-gold);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-type {
            background: var(--accent-gold);
            color: var(--primary-green);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .fixture-card-large.result .card-type {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .card-date {
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: bold;
        }

        .fixture-card-large.result .card-date {
            color: rgba(255,255,255,0.8);
        }

        .card-teams {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .team-matchup {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 1rem;
            line-height: 1.3;
        }

        .card-score {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-gold);
            margin-bottom: 1rem;
        }

        .fixture-card-large.upcoming .card-score {
            color: var(--primary-maroon);
            font-size: 1.5rem;
        }

        .card-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-venue {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .venue-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .venue-home {
            background: var(--accent-gold);
            color: var(--primary-green);
        }

        .venue-away {
            background: var(--primary-green);
            color: white;
        }

        .card-competition {
            font-size: 0.9rem;
            text-align: center;
            padding: 0.5rem;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            margin-bottom: 1rem;
        }

        .fixture-card-large.upcoming .card-competition {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        .card-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        /* ============================================ */
        /* TABLE VIEW STYLES - OLS 121 */
        /* ============================================ */
        .fixtures-table-view {
            display: none !important;
        }

        .fixtures-table-view.active {
            display: block !important;
        }

        .fixtures-card-wrapper {
            display: block;
        }

        .fixtures-card-wrapper.hidden {
            display: none !important;
        }

        .fixtures-table-container {
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .fixtures-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        .fixtures-table thead {
            background: var(--primary-green);
            color: white;
        }

        .fixtures-table th {
            padding: 1rem;
            text-align: left;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        .fixtures-table th.center,
        .fixtures-table td.center {
            text-align: center;
        }

        .fixtures-table tbody tr {
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .fixtures-table tbody tr:hover {
            background: #f8f9fa;
        }

        .fixtures-table tbody tr:last-child {
            border-bottom: none;
        }

        .fixtures-table td {
            padding: 1rem;
            vertical-align: middle;
        }

        /* Result row styling */
        .fixtures-table tr.result-win {
            background: linear-gradient(90deg, rgba(40, 167, 69, 0.1) 0%, transparent 100%);
            border-left: 4px solid #28a745;
        }

        .fixtures-table tr.result-loss {
            background: linear-gradient(90deg, rgba(220, 53, 69, 0.1) 0%, transparent 100%);
            border-left: 4px solid #dc3545;
        }

        .fixtures-table tr.result-draw {
            background: linear-gradient(90deg, rgba(255, 193, 7, 0.1) 0%, transparent 100%);
            border-left: 4px solid #ffc107;
        }

        .fixtures-table tr.result-pending {
            background: linear-gradient(90deg, rgba(108, 117, 125, 0.1) 0%, transparent 100%);
            border-left: 4px solid #6c757d;
        }

        .fixtures-table tr.fixture-upcoming {
            background: linear-gradient(90deg, rgba(var(--accent-gold-rgb, 212, 175, 55), 0.15) 0%, transparent 100%);
            border-left: 4px solid var(--accent-gold);
        }

        /* Cancelled fixture - grey with strikethrough */
        .fixtures-table tr.fixture-cancelled {
            background: linear-gradient(90deg, rgba(108, 117, 125, 0.08) 0%, transparent 100%);
            border-left: 4px solid #6c757d;
            opacity: 0.7;
        }
        .fixtures-table tr.fixture-cancelled td .team-name,
        .fixtures-table tr.fixture-cancelled td .team-name.our-team {
            text-decoration: line-through;
            color: #6c757d;
        }

        /* Postponed fixture - orange with strikethrough */
        .fixtures-table tr.fixture-postponed {
            background: linear-gradient(90deg, rgba(255, 152, 0, 0.1) 0%, transparent 100%);
            border-left: 4px solid #ff9800;
            opacity: 0.7;
        }
        .fixtures-table tr.fixture-postponed td .team-name,
        .fixtures-table tr.fixture-postponed td .team-name.our-team {
            text-decoration: line-through;
            color: #999;
        }

        /* Current fixture highlight - clean border approach */
        .fixtures-table tr.current-fixture {
            background: linear-gradient(90deg, rgba(var(--accent-gold-rgb, 212, 175, 55), 0.3) 0%, rgba(var(--accent-gold-rgb, 212, 175, 55), 0.1) 100%) !important;
            border-left: 4px solid var(--accent-gold) !important;
            border-top: 2px solid var(--accent-gold);
            border-bottom: 2px solid var(--accent-gold);
        }

        .fixtures-table tr.current-fixture td:first-child {
            position: relative;
        }

        .fixtures-table tr.current-fixture td:first-child::before {
            content: '‚ñ∂';
            position: absolute;
            left: 0.3rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-gold);
            font-size: 0.7rem;
        }

        .fixtures-table tr.current-fixture td:first-child {
            padding-left: 1.5rem;
        }

        /* Team name styling */
        .team-name {
            font-weight: 500;
        }

        .team-name.our-team {
            font-weight: bold;
            color: var(--primary-green);
        }

        /* Score styling */
        .score-display {
            font-weight: bold;
            font-size: 1.1rem;
            white-space: nowrap;
        }

        .score-display.win {
            color: #28a745;
        }

        .score-display.loss {
            color: #dc3545;
        }

        .score-display.draw {
            color: #ffc107;
        }

        .score-display.pending {
            color: #6c757d;
            font-style: italic;
            font-weight: normal;
        }

        .score-display.upcoming {
            color: var(--primary-maroon);
        }

        .score-display.cancelled {
            color: #6c757d;
            font-style: italic;
            font-weight: normal;
            font-size: 0.9rem;
        }

        .score-display.postponed {
            color: #ff9800;
            font-style: italic;
            font-weight: normal;
            font-size: 0.9rem;
        }

        /* Venue badge in table */
        .venue-badge-small {
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-block;
        }

        /* OLS 122: Action row for buttons (always visible) */
        .fixture-action-row {
            background: var(--bg-light);
        }
        
        .fixture-action-row td {
            padding: 0.5rem 1rem 0.5rem 1.5rem !important;
            border-bottom: none !important;
            border-left: 4px solid var(--primary-green) !important;
        }
        
        /* Result-specific border colours to match fixture row above */
        .fixture-action-row.action-win td {
            border-left-color: #28a745 !important;
        }
        .fixture-action-row.action-loss td {
            border-left-color: #dc3545 !important;
        }
        .fixture-action-row.action-draw td {
            border-left-color: #ffc107 !important;
        }
        .fixture-action-row.action-pending td {
            border-left-color: #6c757d !important;
        }
        .fixture-action-row.action-upcoming td {
            border-left-color: var(--accent-gold) !important;
        }
        .fixture-action-row.action-cancelled td {
            border-left-color: #6c757d !important;
        }
        .fixture-action-row.action-postponed td {
            border-left-color: #ff9800 !important;
        }
        
        /* Remove bottom border from fixture row when followed by action row */
        tr:has(+ .fixture-action-row) td {
            border-bottom: none !important;
        }
        
        .btn-sm {
            padding: 0.4rem 0.8rem !important;
            font-size: 0.8rem !important;
            border-radius: 6px;
        }
        
        @media (max-width: 768px) {
            .fixture-action-row td {
                padding: 0.4rem 0.5rem 0.6rem 1rem !important;
            }
            .btn-sm {
                padding: 0.35rem 0.6rem !important;
                font-size: 0.75rem !important;
            }
        }

        /* Table section header */
        .table-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .table-section-header h2 {
            color: var(--primary-green);
            font-size: 1.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .fixture-count-badge {
            background: var(--accent-gold);
            color: var(--primary-green);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Loading and Empty States */
        .loading-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .empty-state h3 {
            color: var(--primary-green);
            margin-bottom: 1rem;
        }

        .empty-state p {
            color: var(--text-light);
            margin-bottom: 2rem;
        }

        /* üéØ PREVENT FLASH OF DEFAULT CONTENT */
        .fixtures-page-header {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .cms-content-loaded .fixtures-page-header {
            opacity: 1;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .fixtures-page-header {
                padding: 4rem 0 2rem;
            }

            .fixtures-controls {
                padding: 1rem;
                top: 80px;
            }

            /* Mobile: Show dropdown, hide buttons */
            .mobile-only {
                display: flex;
            }

            .desktop-only {
                display: none !important;
            }

            /* Mobile: Both filters on same row */
            .controls-row {
                flex-direction: row;
                gap: 0.75rem;
            }

            .team-selector-wrapper,
            .season-selector-wrapper {
                flex-direction: column;
                flex: 1;
                gap: 0.3rem;
            }

            .team-selector-wrapper label,
            .season-selector-wrapper label {
                font-size: 0.85rem;
            }

            .team-select,
            .season-select {
                width: 100%;
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
                min-width: unset;
            }

            .season-filters {
                gap: 0.4rem;
            }

            .season-filter-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }

            .fixtures-card-view {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .fixture-card-large {
                padding: 1.5rem;
            }

            .card-score {
                font-size: 2rem;
            }

            .team-matchup {
                font-size: 1.1rem;
            }

            .card-details {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .card-actions {
                flex-direction: column;
            }

            /* Table mobile adjustments */
            .fixtures-table th.hide-mobile,
            .fixtures-table td.hide-mobile {
                display: none;
            }

            .fixtures-table {
                font-size: 0.85rem;
            }

            .fixtures-table th,
            .fixtures-table td {
                padding: 0.75rem 0.5rem;
            }

            .fixture-expanded-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .expanded-actions {
                width: 100%;
                justify-content: stretch;
            }

            .expanded-actions .btn {
                flex: 1;
                text-align: center;
            }
            
            /* OLS 125: Recent Form Widget mobile */
            .recent-form-widget {
                padding: 1.25rem 1rem;
                border-radius: 16px;
            }
            
            .form-widget-header h3 {
                font-size: 1.1rem;
            }
            
            .form-indicators-row {
                gap: 0.5rem;
            }
            
            .form-match-item {
                min-width: 60px;
                padding: 0.5rem 0.4rem;
            }
            
            .form-result-badge {
                width: 42px;
                height: 42px;
                font-size: 1.1rem;
            }
            
            .form-match-score {
                font-size: 0.8rem;
            }
            
            .form-match-opponent {
                font-size: 0.7rem;
                max-width: 55px;
            }
            
            .form-summary-row {
                gap: 0.5rem;
            }
            
            .form-summary-badge {
                padding: 0.4rem 0.9rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .fixtures-controls {
                padding: 1rem;
            }

            .fixtures-summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .summary-card {
                padding: 1.5rem;
            }

            .summary-number {
                font-size: 2rem;
            }

            .view-toggle-btn span {
                display: none;
            }

            .fixtures-table {
                font-size: 0.8rem;
            }

            .score-display {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header-placeholder" data-page="fixtures"></div>

    <!-- Page Header -->
    <section class="fixtures-page-header">
        <div class="container">
            <h1>Fixtures & Results</h1>
            <p style="font-size: 1.2rem; opacity: 0.9; margin-top: 1rem;">
                Complete fixture list and results for all Old Laurentian RFC teams
            </p>
        </div>
    </section>

    <main style="padding: 2rem 0 4rem;">
        <div class="container">
            
            <!-- Controls - Team dropdown + View Toggle + Season filters -->
            <div class="fixtures-controls">
                <div class="controls-row">
                    <div class="team-selector-wrapper">
                        <label for="team-selector-dropdown">Team:</label>
                        <select id="team-selector-dropdown" class="team-select">
                            <!-- Team options populated dynamically from Netlify -->
                        </select>
                    </div>
                    
                    <!-- OLS 121: Season Dropdown (Mobile) -->
                    <div class="season-selector-wrapper mobile-only">
                        <label for="season-selector-dropdown">Season:</label>
                        <select id="season-selector-dropdown" class="season-select">
                            <option value="all">All Seasons</option>
                            <!-- Season options populated dynamically -->
                        </select>
                    </div>
                    
                    <!-- OLS 121: View Toggle (Desktop only) -->
                    <div class="view-toggle desktop-only">
                        <button class="view-toggle-btn active" data-view="cards" title="Card View">
                            üìá <span>Cards</span>
                        </button>
                        <button class="view-toggle-btn" data-view="table" title="Table View">
                            üìä <span>Table</span>
                        </button>
                    </div>
                </div>
                
                <!-- OLS 121: Season Filter Buttons (Desktop only) -->
                <div class="season-filters desktop-only" id="seasonFilters">
                    <button class="season-filter-btn active" data-season="all">All Seasons</button>
                    <!-- Season buttons will be generated dynamically -->
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="fixtures-summary" id="fixtureSummary">
                <div class="summary-card">
                    <span class="summary-number" id="totalMatches">0</span>
                    <span class="summary-label">Games Played</span>
                    <div class="summary-detail">This Season</div>
                </div>
                <div class="summary-card">
                    <span class="summary-number" id="totalWins">0</span>
                    <span class="summary-label">Wins</span>
                    <div class="summary-detail" id="winPercentage">0% win rate</div>
                </div>
                <div class="summary-card">
                    <span class="summary-number" id="upcomingFixtures">0</span>
                    <span class="summary-label">Upcoming</span>
                    <div class="summary-detail">Next 30 days</div>
                </div>
                <div class="summary-card">
                    <span class="summary-number" id="totalPoints">0</span>
                    <span class="summary-label">Points Scored</span>
                    <div class="summary-detail">All competitions</div>
                </div>
            </div>

            <!-- OLS 125: Recent Form Widget (shown when single team selected) -->
            <div class="recent-form-widget" id="recentFormWidget" style="display: none;">
                <div class="form-widget-header">
                    <h3>Recent Form</h3>
                </div>
                <div class="form-widget-content" id="recentFormContent">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- ============================================ -->
            <!-- CARD VIEW (Original) -->
            <!-- ============================================ -->
            <div class="fixtures-card-wrapper" id="cardViewWrapper">
                <!-- Results Section -->
                <div class="fixtures-section" id="resultsSection">
                    <div class="section-header">
                        <h2 class="section-title-small">Recent Results</h2>
                        <span class="section-count" id="resultsCount">0 matches</span>
                    </div>
                    
                    <div class="fixtures-card-view" id="resultsCardView">
                        <!-- Result cards will be populated here -->
                    </div>
                </div>

                <!-- Fixtures Section -->
                <div class="fixtures-section" id="fixturesSection">
                    <div class="section-header">
                        <h2 class="section-title-small">Upcoming Fixtures</h2>
                        <span class="section-count" id="fixturesCount">0 matches</span>
                    </div>
                    
                    <div class="fixtures-card-view" id="fixturesCardView">
                        <!-- Fixture cards will be populated here -->
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- TABLE VIEW (OLS 121) -->
            <!-- ============================================ -->
            <div class="fixtures-table-view" id="tableViewWrapper">
                <div class="table-section-header">
                    <h2>üìÖ Season Timeline <span class="fixture-count-badge" id="tableFixtureCount">0 fixtures</span></h2>
                </div>
                
                <div class="fixtures-table-container">
                    <table class="fixtures-table" id="fixturesTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Team</th>
                                <th class="center">Score</th>
                                <th>Opponent</th>
                                <th>Venue</th>
                                <th class="hide-mobile">Competition</th>
                            </tr>
                        </thead>
                        <tbody id="fixturesTableBody">
                            <!-- Table rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <!-- OLS 122: Teamsheet Modal -->
    <div id="teamsheetModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center;">
        <div class="teamsheet-modal-content" style="position: relative; background: white; border-radius: 12px; overflow: hidden; max-height: 95vh; display: flex; flex-direction: column;">
            <div style="background: var(--primary-green); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <h3 id="teamsheetModalTitle" style="margin: 0;">üìã Teamsheet</h3>
                <button onclick="closeTeamsheetModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
            </div>
            <div style="padding: 1rem; text-align: center; overflow: hidden; display: flex; justify-content: center; align-items: center; flex-grow: 1;">
                <img id="teamsheetModalImg" src="" alt="Teamsheet" style="max-height: calc(95vh - 80px); max-width: 100%; width: auto; height: auto; object-fit: contain; border-radius: 8px;">
            </div>
        </div>
    </div>
    
    <style>
        /* OLS 122: Teamsheet modal responsive styles */
        @media (min-width: 769px) {
            /* Desktop: constrain width for portrait images */
            .teamsheet-modal-content {
                max-width: min(500px, 90vw);
            }
        }
        @media (max-width: 768px) {
            /* Mobile: full width */
            .teamsheet-modal-content {
                max-width: 95vw;
                max-height: 90vh;
            }
            #teamsheetModalImg {
                max-height: calc(90vh - 80px) !important;
            }
        }
    </style>

    <!-- Footer -->
    <div id="footer-placeholder" data-page="fixtures"></div>

    <!-- Scripts -->
    <script src="../js/header.js"></script>
    <script src="../js/footer.js"></script>
    <script src="../js/seo-manager.js"></script>
    <script src="../js/admin-data-loader.js"></script>
    <script>
        // Load feature states from admin settings
        async function loadFeatureStates() {
            try {
                const response = await fetch('/.netlify/functions/netlify-forms-get?form_name=admin-settings');
                
                if (!response.ok) {
                    throw new Error('Failed to fetch settings');
                }
                
                const result = await response.json();
                const settings = result.data || [];
                
                const featureStates = {
                    shop: false,
                    events: false,
                    members: false,
                    payments: false,
                    sponsors: false
                };
                
                settings.reverse();
                
                for (const setting of settings) {
                    if (setting.featureStates) {
                        const parsed = JSON.parse(setting.featureStates);
                        Object.assign(featureStates, parsed);
                        break;
                    }
                }
                
                // Apply feature states
                if (!featureStates.shop) {
                    const shopLinks = document.querySelectorAll('.nav-item[data-feature="shop"]');
                    shopLinks.forEach(link => link.style.display = 'none');
                }
                
                if (!featureStates.events) {
                    const eventsLinks = document.querySelectorAll('.nav-item[data-feature="events"]');
                    eventsLinks.forEach(link => link.style.display = 'none');
                }
                
            } catch (error) {
                console.warn('Error loading feature states:', error);
            }
        }

        class FixturesPageManager {
            constructor() {
                this.allFixtures = [];
                this.galleries = [];
                this.newsArticles = []; // OLS 122: For match report lookup
                this.availableSeasons = new Set();
                this.currentTeam = 'all';
                this.currentSeason = 'all';
                this.currentView = 'cards';  // OLS 121: View state
                this.expandedRowId = null;   // OLS 121: Track expanded row
                this.init();
            }

            async init() {
                console.log('üèâ Initializing Fixtures Page Manager...');
                
                // OLS 121: Load saved view preference, or default to table on mobile
                const savedView = localStorage.getItem('olrfc_fixtures_view');
                const isMobile = window.innerWidth <= 768;
                
                if (savedView && (savedView === 'cards' || savedView === 'table')) {
                    // User has a saved preference - respect it
                    this.currentView = savedView;
                } else if (isMobile) {
                    // No saved preference + mobile = default to table
                    this.currentView = 'table';
                    console.log('üì± Mobile detected - defaulting to table view');
                }
                // Otherwise stays as 'cards' (desktop default)
                
                // Wait for admin-data-loader to sync data from Netlify
                if (window.adminDataLoader && typeof window.adminDataLoader.syncFromNetlify === 'function') {
                    console.log('‚è≥ Waiting for admin-data-loader sync...');
                    await window.adminDataLoader.syncFromNetlify();
                    console.log('‚úÖ Admin data sync complete');
                }
                
                this.loadData();
                await this.loadGalleries();
                await this.loadNewsArticles(); // OLS 122: Load news for match report lookup
                this.generateSeasonFilters();
                this.setupEventListeners();
                this.applyViewToggle();  // OLS 121: Apply saved view
                this.renderAll();
                
                // OLS 126: Inject SportsEvent schema for SEO
                this.injectFixturesSchema();
            }

            loadData() {
                this.allFixtures = this.combineAllFixtureData();
            }

            async loadGalleries() {
                try {
                    console.log('üì∏ Loading galleries for fixture matching...');
                    
                    const cachedGalleries = this.getData('gallery');
                    if (cachedGalleries && cachedGalleries.length > 0) {
                        this.galleries = cachedGalleries;
                        console.log(`‚úÖ Loaded ${this.galleries.length} galleries from cache`);
                        return;
                    }
                    
                    const response = await fetch('/.netlify/functions/gallery', {
                        method: 'GET'
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to fetch galleries');
                    }
                    
                    const result = await response.json();
                    this.galleries = result.data || [];
                    console.log(`‚úÖ Loaded ${this.galleries.length} galleries from Netlify`);
                } catch (error) {
                    console.error('‚ùå Error loading galleries:', error);
                    this.galleries = [];
                }
            }

            getGalleryForFixture(fixtureId) {
                // OLS 122: Check both 'fixtureId' and 'fixture' for backwards compatibility
                return this.galleries.find(gallery => gallery.fixtureId === fixtureId || gallery.fixture === fixtureId);
            }

            // OLS 122: Load news articles for match report lookup
            async loadNewsArticles() {
                try {
                    console.log('üì∞ Loading news articles for match report matching...');
                    
                    const cachedNews = this.getData('news');
                    if (cachedNews && cachedNews.length > 0) {
                        this.newsArticles = cachedNews;
                        console.log(`‚úÖ Loaded ${this.newsArticles.length} news articles from cache`);
                        return;
                    }
                    
                    const response = await fetch('/.netlify/functions/news');
                    
                    if (!response.ok) {
                        throw new Error('Failed to fetch news');
                    }
                    
                    const result = await response.json();
                    this.newsArticles = result.data || [];
                    console.log(`‚úÖ Loaded ${this.newsArticles.length} news articles from Netlify`);
                } catch (error) {
                    console.error('‚ùå Error loading news:', error);
                    this.newsArticles = [];
                }
            }

            // OLS 122: Find match report linked to a fixture
            getMatchReportForFixture(fixtureId) {
                // Look for news articles with fixtureId matching this fixture
                // Must check that fixtureId exists and matches (not null, not empty string)
                const matchReport = this.newsArticles.find(article => {
                    if (!article.fixtureId || article.fixtureId === '' || article.fixtureId === null) {
                        return false;
                    }
                    const matches = article.fixtureId === fixtureId;
                    if (matches) {
                        console.log(`‚úÖ Found match report "${article.title}" for fixture ${fixtureId}`);
                    }
                    return matches;
                });
                
                if (!matchReport) {
                    console.log(`üì≠ No match report found for fixture ${fixtureId}`);
                }
                
                return matchReport;
            }

            renderActionButtons(fixture) {
                const gallery = this.getGalleryForFixture(fixture.id);
                // OLS 122: Look up match report by fixtureId on the news article
                const matchReport = this.getMatchReportForFixture(fixture.id);
                const hasMatchReport = matchReport && matchReport.id;
                const hasGallery = gallery && gallery.id;
                const hasTeamsheet = fixture.teamsheetUrl && fixture.teamsheetUrl !== '';
                
                // Check if fixture is upcoming or past
                const fixtureDate = new Date(fixture.datetime || fixture.date);
                const isUpcoming = fixtureDate > new Date();
                
                let buttons = '';
                
                // OLS 122: Teamsheet button - show for all fixtures if available
                if (hasTeamsheet) {
                    buttons += `
                        <button class="btn" style="background: var(--primary-green); color: white;" onclick="openTeamsheetModal('${fixture.teamsheetUrl}', '${fixture.opponent}')">
                            üìã Teamsheet
                        </button>
                    `;
                } else if (isUpcoming) {
                    // Only show disabled teamsheet for upcoming fixtures
                    buttons += `
                        <button class="btn" style="background: var(--bg-light); color: var(--text-light); cursor: not-allowed;" disabled title="No teamsheet available yet">
                            üìã No Teamsheet
                        </button>
                    `;
                }
                
                // For past fixtures, show match report and gallery buttons
                if (!isUpcoming) {
                    if (hasMatchReport) {
                        buttons += `
                            <button class="btn" style="background: var(--primary-maroon); color: white;" onclick="window.location.href='news-article.html?id=${matchReport.id}'">
                                üì∞ Match Report
                            </button>
                        `;
                    } else {
                        buttons += `
                            <button class="btn" style="background: var(--bg-light); color: var(--text-light); cursor: not-allowed;" disabled title="No match report available">
                                üì∞ No Report
                            </button>
                        `;
                    }
                    
                    if (hasGallery) {
                        buttons += `
                            <button class="btn btn-primary" onclick="window.location.href='gallery.html?id=${gallery.id}'">
                                üì∏ View Gallery
                            </button>
                        `;
                    } else {
                        buttons += `
                            <button class="btn btn-primary" style="opacity: 0.5; cursor: not-allowed;" disabled title="No gallery available">
                                üì∏ No Gallery
                            </button>
                        `;
                    }
                }
                
                return buttons;
            }

            // ============================================
            // OLS 121: SEASON CALCULATION
            // ============================================
            calculateSeason(dateString) {
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                
                if (month >= 8) {
                    return `${year}/${String(year + 1).slice(2)}`;
                } else {
                    return `${year - 1}/${String(year).slice(2)}`;
                }
            }

            generateSeasonFilters() {
                const seasonFilters = document.getElementById('seasonFilters');
                const seasonDropdown = document.getElementById('season-selector-dropdown');
                
                // Collect all seasons from fixtures
                this.availableSeasons.clear();
                this.allFixtures.forEach(fixture => {
                    if (fixture.season) {
                        this.availableSeasons.add(fixture.season);
                    }
                });
                
                // Sort seasons in descending order (newest first)
                const sortedSeasons = Array.from(this.availableSeasons).sort().reverse();
                const currentSeason = sortedSeasons[0] || 'all'; // Most recent season
                
                console.log(`üìÖ Available seasons: ${sortedSeasons.join(', ')}`);
                console.log(`üìÖ Current season: ${currentSeason}`);
                
                // Default to current season on mobile (first load only)
                const isMobile = window.innerWidth <= 768;
                if (isMobile && this.currentSeason === 'all' && sortedSeasons.length > 0) {
                    this.currentSeason = currentSeason;
                    console.log(`üì± Mobile: defaulting to current season ${currentSeason}`);
                }
                
                // Populate desktop buttons
                if (seasonFilters) {
                    const allButton = seasonFilters.querySelector('[data-season="all"]');
                    seasonFilters.innerHTML = '';
                    if (allButton) {
                        allButton.classList.toggle('active', this.currentSeason === 'all');
                        seasonFilters.appendChild(allButton);
                    }
                    
                    sortedSeasons.forEach(season => {
                        const button = document.createElement('button');
                        button.className = 'season-filter-btn';
                        if (season === this.currentSeason) {
                            button.classList.add('active');
                        }
                        button.dataset.season = season;
                        button.textContent = season;
                        seasonFilters.appendChild(button);
                    });
                }
                
                // Populate mobile dropdown
                if (seasonDropdown) {
                    seasonDropdown.innerHTML = '<option value="all">All Seasons</option>';
                    
                    sortedSeasons.forEach(season => {
                        const option = document.createElement('option');
                        option.value = season;
                        option.textContent = season;
                        if (season === this.currentSeason) {
                            option.selected = true;
                        }
                        seasonDropdown.appendChild(option);
                    });
                    
                    // Set dropdown to current season
                    seasonDropdown.value = this.currentSeason;
                }
                
                this.setupSeasonFilterListeners();
            }

            setupSeasonFilterListeners() {
                // Desktop: Button listeners
                const seasonFilters = document.getElementById('seasonFilters');
                if (seasonFilters) {
                    seasonFilters.querySelectorAll('.season-filter-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            seasonFilters.querySelectorAll('.season-filter-btn').forEach(b => b.classList.remove('active'));
                            e.target.classList.add('active');
                            
                            this.currentSeason = e.target.dataset.season;
                            
                            // Sync mobile dropdown
                            const dropdown = document.getElementById('season-selector-dropdown');
                            if (dropdown) dropdown.value = this.currentSeason;
                            
                            console.log(`üîç Season filter changed to: ${this.currentSeason}`);
                            this.renderAll();
                        });
                    });
                }
                
                // Mobile: Dropdown listener
                const seasonDropdown = document.getElementById('season-selector-dropdown');
                if (seasonDropdown) {
                    seasonDropdown.addEventListener('change', (e) => {
                        this.currentSeason = e.target.value;
                        
                        // Sync desktop buttons
                        if (seasonFilters) {
                            seasonFilters.querySelectorAll('.season-filter-btn').forEach(btn => {
                                btn.classList.toggle('active', btn.dataset.season === this.currentSeason);
                            });
                        }
                        
                        console.log(`üîç Season filter changed to: ${this.currentSeason}`);
                        this.renderAll();
                    });
                }
            }

            combineAllFixtureData() {
                const combined = [];
                const dynamicData = this.getData('fixtures');
                
                console.log('üèâ Loading fixtures from localStorage:', dynamicData.length, 'total');
                
                dynamicData.forEach(dynFixture => {
                    const hasOurScore = dynFixture.ourScore !== null && dynFixture.ourScore !== '' && dynFixture.ourScore !== undefined;
                    const hasTheirScore = dynFixture.theirScore !== null && dynFixture.theirScore !== '' && dynFixture.theirScore !== undefined;
                    const isResult = hasOurScore && hasTheirScore;
                    
                    const fixtureDate = new Date(dynFixture.dateTime);
                    const dateStr = dynFixture.dateTime.split('T')[0];
                    const timeStr = fixtureDate.toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit'});
                    
                    const season = this.calculateSeason(dynFixture.dateTime);
                    
                    const ourTeamName = this.getTeamName(dynFixture.team);
                    const homeTeam = dynFixture.venue === 'home' ? ourTeamName : dynFixture.opponent;
                    const awayTeam = dynFixture.venue === 'home' ? dynFixture.opponent : ourTeamName;
                    
                    const fixture = {
                        id: dynFixture.id,
                        date: dateStr,
                        datetime: dynFixture.dateTime,
                        time: timeStr,
                        team: dynFixture.team,
                        teamName: ourTeamName,
                        opponent: dynFixture.opponent,
                        isResult: isResult,
                        type: isResult ? 'result' : 'fixture',
                        ourScore: isResult ? parseInt(dynFixture.ourScore) : null,
                        theirScore: isResult ? parseInt(dynFixture.theirScore) : null,
                        venue: dynFixture.venue === 'home' ? 'Home Ground' : 'Away',
                        venueShort: dynFixture.venue === 'home' ? 'Home' : 'Away',
                        competition: dynFixture.competition || 'Friendly',
                        homeTeam: homeTeam,
                        awayTeam: awayTeam,
                        isHome: dynFixture.venue === 'home',
                        matchReportId: dynFixture.matchReport || null,
                        season: season,
                        matchStatus: dynFixture.matchStatus || 'played',
                        // OLS 122: Teamsheet URL
                        teamsheetUrl: dynFixture.teamsheetUrl || null
                    };
                    
                    combined.push(fixture);
                });
                
                combined.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                console.log('‚úÖ Total fixtures loaded:', combined.length);
                
                return combined;
            }

            /**
             * Inject SportsEvent schema for upcoming fixtures (OLS 126)
             * Helps fixtures appear in Google Events and rich search results
             */
            async injectFixturesSchema() {
                // Get upcoming fixtures only (not results)
                const upcomingFixtures = this.allFixtures.filter(f => !f.isResult);
                
                if (upcomingFixtures.length === 0) {
                    console.log('üìÖ No upcoming fixtures for schema');
                    return;
                }
                
                // Limit to next 10 fixtures for schema (Google recommendation)
                const fixturesForSchema = upcomingFixtures
                    .sort((a, b) => new Date(a.datetime) - new Date(b.datetime))
                    .slice(0, 10);
                
                // Fetch club settings for venue info
                let clubName = 'Rugby Club';
                let clubAddress = '';
                let clubUrl = window.location.origin;
                
                try {
                    const response = await fetch('/.netlify/functions/site-settings', {
                        method: 'GET'
                    });
                    if (response.ok) {
                        const result = await response.json();
                        const settings = result.data || {};
                        clubName = settings['club-name'] || clubName;
                        clubAddress = settings['contact-address'] || '';
                    }
                } catch (error) {
                    console.warn('Could not fetch settings for fixtures schema');
                }
                
                // Generate SportsEvent schema for each fixture
                const eventSchemas = fixturesForSchema.map(fixture => {
                    const eventSchema = {
                        "@context": "https://schema.org",
                        "@type": "SportsEvent",
                        "name": `${fixture.homeTeam} vs ${fixture.awayTeam}`,
                        "description": `${fixture.competition} rugby match: ${fixture.homeTeam} vs ${fixture.awayTeam}`,
                        "startDate": fixture.datetime,
                        "eventStatus": "https://schema.org/EventScheduled",
                        "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
                        "sport": "Rugby Union",
                        "homeTeam": {
                            "@type": "SportsTeam",
                            "name": fixture.homeTeam
                        },
                        "awayTeam": {
                            "@type": "SportsTeam",
                            "name": fixture.awayTeam
                        },
                        "competitor": [
                            {
                                "@type": "SportsTeam",
                                "name": fixture.homeTeam
                            },
                            {
                                "@type": "SportsTeam",
                                "name": fixture.awayTeam
                            }
                        ],
                        "organizer": {
                            "@type": "SportsOrganization",
                            "name": clubName,
                            "url": clubUrl
                        }
                    };
                    
                    // Add location for home fixtures
                    if (fixture.isHome && clubAddress) {
                        eventSchema.location = {
                            "@type": "Place",
                            "name": clubName + " Home Ground",
                            "address": {
                                "@type": "PostalAddress",
                                "streetAddress": clubAddress
                            }
                        };
                    } else if (!fixture.isHome) {
                        eventSchema.location = {
                            "@type": "Place",
                            "name": fixture.opponent + " (Away)"
                        };
                    }
                    
                    return eventSchema;
                });
                
                // Create combined schema with @graph for multiple events
                const combinedSchema = {
                    "@context": "https://schema.org",
                    "@graph": eventSchemas
                };
                
                // Remove any existing fixtures schema
                const existingSchema = document.querySelector('script[type="application/ld+json"][data-fixtures-schema]');
                if (existingSchema) {
                    existingSchema.remove();
                }
                
                // Inject schema into head
                const script = document.createElement('script');
                script.type = 'application/ld+json';
                script.setAttribute('data-fixtures-schema', 'true');
                script.textContent = JSON.stringify(combinedSchema, null, 2);
                document.head.appendChild(script);
                
                console.log(`‚úÖ SportsEvent schema injected for ${fixturesForSchema.length} upcoming fixtures`);
            }

            getTeamName(teamSlug) {
                try {
                    const cachedTeams = JSON.parse(localStorage.getItem('olrfc_teams') || '[]');
                    const team = cachedTeams.find(t => t.slug === teamSlug);
                    if (team && team.name) {
                        return team.name;
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Error reading teams from cache:', e);
                }
                return teamSlug;
            }

            getData(key) {
                try {
                    return JSON.parse(localStorage.getItem(`olrfc_${key}`)) || [];
                } catch (e) {
                    console.error(`Error loading ${key} data:`, e);
                    return [];
                }
            }

            setupEventListeners() {
                // Team filter
                const teamSelect = document.getElementById('team-selector-dropdown');
                if (teamSelect) {
                    teamSelect.addEventListener('change', (e) => {
                        this.currentTeam = e.target.value;
                        this.renderAll();
                        // OLS 125: Update Recent Form widget visibility
                        this.updateFormWidget();
                    });
                }
                
                // OLS 121: View toggle
                document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const view = e.currentTarget.dataset.view;
                        this.currentView = view;
                        
                        // Save preference
                        localStorage.setItem('olrfc_fixtures_view', view);
                        
                        // Update UI
                        this.applyViewToggle();
                        this.renderAll();
                    });
                });
            }

            // OLS 121: Apply view toggle state
            applyViewToggle() {
                // Update buttons
                document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === this.currentView);
                });
                
                // Show/hide views
                const cardWrapper = document.getElementById('cardViewWrapper');
                const tableWrapper = document.getElementById('tableViewWrapper');
                
                if (this.currentView === 'table') {
                    cardWrapper.classList.add('hidden');
                    tableWrapper.classList.add('active');
                } else {
                    cardWrapper.classList.remove('hidden');
                    tableWrapper.classList.remove('active');
                }
                
                console.log(`üëÅÔ∏è View switched to: ${this.currentView}`);
            }

            getFilteredFixtures() {
                let filtered = this.allFixtures;

                if (this.currentTeam !== 'all') {
                    filtered = filtered.filter(fixture => fixture.team === this.currentTeam);
                }

                if (this.currentSeason !== 'all') {
                    filtered = filtered.filter(fixture => fixture.season === this.currentSeason);
                }

                return filtered;
            }

            renderAll() {
                const filteredFixtures = this.getFilteredFixtures();
                const currentDate = new Date();
                
                const results = filteredFixtures.filter(f => {
                    const fixtureDateTime = new Date(f.datetime);
                    return f.isResult || fixtureDateTime < currentDate;
                });
                
                const fixtures = filteredFixtures.filter(f => {
                    const fixtureDateTime = new Date(f.datetime);
                    return fixtureDateTime >= currentDate;
                });

                results.sort((a, b) => new Date(b.date) - new Date(a.date));
                fixtures.sort((a, b) => new Date(a.date) - new Date(b.date));

                this.renderSummary(filteredFixtures);
                
                // Render based on current view
                if (this.currentView === 'cards') {
                    this.renderResults(results);
                    this.renderFixtures(fixtures);
                    this.updateCounts(results.length, fixtures.length);
                } else {
                    this.renderTable(filteredFixtures);
                }
                
                console.log(`üìä Showing ${filteredFixtures.length} fixtures (Team: ${this.currentTeam}, Season: ${this.currentSeason}, View: ${this.currentView})`);
            }

            renderSummary(fixtures) {
                const currentDate = new Date();
                
                const allPastMatches = fixtures.filter(f => {
                    const fixtureDate = new Date(f.date);
                    return fixtureDate < currentDate;
                });
                
                const resultsWithScores = fixtures.filter(f => f.isResult);
                const wins = resultsWithScores.filter(f => parseInt(f.ourScore) > parseInt(f.theirScore));
                
                const today = new Date();
                const next30Days = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
                const upcoming = fixtures.filter(f => {
                    const fixtureDate = new Date(f.date);
                    return fixtureDate >= today && fixtureDate <= next30Days;
                });
                
                const totalPoints = resultsWithScores.reduce((sum, f) => sum + parseInt(f.ourScore || 0), 0);
                const winPercentage = resultsWithScores.length > 0 ? Math.round((wins.length / resultsWithScores.length) * 100) : 0;

                document.getElementById('totalMatches').textContent = allPastMatches.length;
                document.getElementById('totalWins').textContent = wins.length;
                document.getElementById('upcomingFixtures').textContent = upcoming.length;
                document.getElementById('totalPoints').textContent = totalPoints;
                document.getElementById('winPercentage').textContent = `${winPercentage}% win rate`;
            }

            // OLS 125: Recent Form Widget
            updateFormWidget() {
                const widget = document.getElementById('recentFormWidget');
                const content = document.getElementById('recentFormContent');
                
                if (!widget || !content) return;
                
                // Only show when single team is selected
                if (this.currentTeam === 'all') {
                    widget.style.display = 'none';
                    return;
                }
                
                // Get results for selected team (last 5)
                const currentDate = new Date();
                const teamFixtures = this.allFixtures
                    .filter(f => f.team === this.currentTeam && f.isResult)
                    .sort((a, b) => new Date(b.datetime) - new Date(a.datetime))
                    .slice(0, 5);
                
                if (teamFixtures.length === 0) {
                    content.innerHTML = '<p class="form-empty-message">No recent results for this team</p>';
                    widget.style.display = 'block';
                    return;
                }
                
                // Calculate W/D/L
                let wins = 0, draws = 0, losses = 0;
                
                const matchesHtml = teamFixtures.map(match => {
                    const ourScore = parseInt(match.ourScore);
                    const theirScore = parseInt(match.theirScore);
                    
                    let outcome, badgeClass;
                    if (ourScore > theirScore) {
                        outcome = 'W';
                        badgeClass = 'win';
                        wins++;
                    } else if (ourScore === theirScore) {
                        outcome = 'D';
                        badgeClass = 'draw';
                        draws++;
                    } else {
                        outcome = 'L';
                        badgeClass = 'loss';
                        losses++;
                    }
                    
                    const score = `${ourScore}-${theirScore}`;
                    const shortOpponent = (match.opponent || 'TBC').length > 12 
                        ? (match.opponent || 'TBC').substring(0, 10) + '...' 
                        : (match.opponent || 'TBC');
                    
                    return `
                        <div class="form-match-item" title="${match.opponent} - ${score}">
                            <div class="form-result-badge ${badgeClass}">${outcome}</div>
                            <div class="form-match-score">${score}</div>
                            <div class="form-match-opponent">${shortOpponent}</div>
                        </div>
                    `;
                }).join('');
                
                content.innerHTML = `
                    <div class="form-indicators-row">
                        ${matchesHtml}
                    </div>
                    <div class="form-summary-row">
                        <span class="form-summary-badge wins">W: ${wins}</span>
                        <span class="form-summary-badge draws">D: ${draws}</span>
                        <span class="form-summary-badge losses">L: ${losses}</span>
                    </div>
                `;
                
                widget.style.display = 'block';
            }

            // ============================================
            // OLS 121: TABLE VIEW RENDERING
            // ============================================
            renderTable(allFixtures) {
                const tbody = document.getElementById('fixturesTableBody');
                const countBadge = document.getElementById('tableFixtureCount');
                tbody.innerHTML = '';
                
                if (allFixtures.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 3rem; color: var(--text-light);">
                                No fixtures found for the selected filters.
                            </td>
                        </tr>
                    `;
                    countBadge.textContent = '0 fixtures';
                    return;
                }
                
                // Sort chronologically: oldest first, newest last (like a real fixture list)
                const currentDate = new Date();
                const sorted = [...allFixtures].sort((a, b) => {
                    return new Date(a.datetime) - new Date(b.datetime);
                });
                
                // Find the "current" fixture for highlighting:
                // - First upcoming fixture (next match to be played)
                // - Or most recent past fixture if no upcoming
                let currentFixtureId = null;
                const upcomingFixtures = sorted.filter(f => new Date(f.datetime) >= currentDate);
                const pastFixtures = sorted.filter(f => new Date(f.datetime) < currentDate);
                
                if (upcomingFixtures.length > 0) {
                    // First upcoming (soonest)
                    currentFixtureId = upcomingFixtures[0].id;
                } else if (pastFixtures.length > 0) {
                    // Most recent past (last in the sorted past array)
                    currentFixtureId = pastFixtures[pastFixtures.length - 1].id;
                }
                
                // Render rows
                sorted.forEach(fixture => {
                    const row = this.createTableRow(fixture, currentFixtureId);
                    tbody.appendChild(row);
                    
                    // OLS 122: Add action buttons row (only if fixture has any linked content)
                    const actionRow = this.createActionRow(fixture);
                    if (actionRow) {
                        tbody.appendChild(actionRow);
                    }
                });
                
                countBadge.textContent = `${allFixtures.length} fixtures`;
                
                // Smart scroll: center on the current fixture (where "now" is in the season)
                setTimeout(() => {
                    const currentRow = tbody.querySelector('.current-fixture');
                    if (currentRow) {
                        currentRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }

            createTableRow(fixture, currentFixtureId) {
                const row = document.createElement('tr');
                const currentDate = new Date();
                const fixtureDate = new Date(fixture.datetime);
                const isPast = fixtureDate < currentDate;
                
                // Determine row class
                let rowClass = '';
                if (fixture.matchStatus === 'cancelled') {
                    rowClass = 'fixture-cancelled';
                } else if (fixture.matchStatus === 'postponed') {
                    rowClass = 'fixture-postponed';
                } else if (isPast) {
                    if (fixture.isResult) {
                        if (fixture.ourScore > fixture.theirScore) {
                            rowClass = 'result-win';
                        } else if (fixture.ourScore < fixture.theirScore) {
                            rowClass = 'result-loss';
                        } else {
                            rowClass = 'result-draw';
                        }
                    } else {
                        rowClass = 'result-pending';
                    }
                } else {
                    rowClass = 'fixture-upcoming';
                }
                
                if (fixture.id === currentFixtureId) {
                    rowClass += ' current-fixture';
                }
                
                row.className = rowClass;
                row.dataset.fixtureId = fixture.id;
                
                // Score display - always show OUR score first, then THEIR score
                let scoreHtml = '';
                let scoreClass = '';
                if (fixture.matchStatus === 'cancelled') {
                    scoreClass = 'cancelled';
                    scoreHtml = 'Cancelled';
                } else if (fixture.matchStatus === 'postponed') {
                    scoreClass = 'postponed';
                    scoreHtml = 'Postponed';
                } else if (fixture.isResult) {
                    if (fixture.ourScore > fixture.theirScore) {
                        scoreClass = 'win';
                    } else if (fixture.ourScore < fixture.theirScore) {
                        scoreClass = 'loss';
                    } else {
                        scoreClass = 'draw';
                    }

                    // Always: Our Score - Their Score
                    scoreHtml = `${fixture.ourScore} - ${fixture.theirScore}`;
                } else if (isPast) {
                    scoreClass = 'pending';
                    scoreHtml = 'TBC';
                } else {
                    scoreClass = 'upcoming';
                    scoreHtml = `${fixture.time}`;
                }
                
                // Always show: Our Team | Score | Opponent
                row.innerHTML = `
                    <td>${this.formatDateShort(fixture.date)}</td>
                    <td><span class="team-name our-team">${fixture.teamName}</span></td>
                    <td class="center"><span class="score-display ${scoreClass}">${scoreHtml}</span></td>
                    <td><span class="team-name">${fixture.opponent}</span></td>
                    <td><span class="venue-badge-small venue-${fixture.isHome ? 'home' : 'away'}">${fixture.venueShort}</span></td>
                    <td class="hide-mobile">${fixture.competition}</td>
                `;
                
                // OLS 122: Removed click-to-expand - now using always-visible action rows
                
                return row;
            }

            // OLS 122: Create action buttons row - only shows if fixture has linked content
            createActionRow(fixture) {
                const gallery = this.getGalleryForFixture(fixture.id);
                const matchReport = this.getMatchReportForFixture(fixture.id);
                const hasMatchReport = matchReport && matchReport.id;
                const hasGallery = gallery && gallery.id;
                const hasTeamsheet = fixture.teamsheetUrl && fixture.teamsheetUrl !== '';
                
                // If no content linked, don't create a row
                if (!hasTeamsheet && !hasMatchReport && !hasGallery) {
                    return null;
                }
                
                // Determine result type for border colour
                const currentDate = new Date();
                const fixtureDate = new Date(fixture.datetime);
                const isPast = fixtureDate < currentDate;
                
                let resultType = 'upcoming';
                if (fixture.matchStatus === 'cancelled') {
                    resultType = 'cancelled';
                } else if (fixture.matchStatus === 'postponed') {
                    resultType = 'postponed';
                } else if (isPast) {
                    if (fixture.isResult) {
                        if (fixture.ourScore > fixture.theirScore) {
                            resultType = 'win';
                        } else if (fixture.ourScore < fixture.theirScore) {
                            resultType = 'loss';
                        } else {
                            resultType = 'draw';
                        }
                    } else {
                        resultType = 'pending';
                    }
                }
                
                const row = document.createElement('tr');
                row.className = `fixture-action-row action-${resultType}`;
                
                // Build buttons - only for available content
                let buttons = [];
                
                if (hasTeamsheet) {
                    buttons.push(`<button class="btn btn-sm" style="background: var(--primary-green); color: white;" onclick="openTeamsheetModal('${fixture.teamsheetUrl}', '${fixture.opponent}')">üìã Teamsheet</button>`);
                }
                
                if (hasMatchReport) {
                    buttons.push(`<button class="btn btn-sm" style="background: var(--primary-maroon); color: white;" onclick="window.location.href='news-article.html?id=${matchReport.id}'">üì∞ Match Report</button>`);
                }
                
                if (hasGallery) {
                    buttons.push(`<button class="btn btn-sm" style="background: var(--primary-green); color: white;" onclick="window.location.href='gallery.html?id=${gallery.id}'">üì∏ Gallery</button>`);
                }
                
                row.innerHTML = `
                    <td colspan="6">
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: flex-start;">
                            ${buttons.join('')}
                        </div>
                    </td>
                `;
                
                return row;
            }

            // OLS 122: Removed toggleExpandedRow - no longer using expandable rows

            formatDateShort(dateString) {
                const date = new Date(dateString);
                const options = { 
                    weekday: 'short', 
                    day: 'numeric',
                    month: 'short'
                };
                return date.toLocaleDateString('en-GB', options);
            }

            // ============================================
            // CARD VIEW RENDERING (Original)
            // ============================================
            renderResults(results) {
                const container = document.getElementById('resultsCardView');
                container.innerHTML = '';

                if (results.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No Results Found</h3><p>No match results found for the selected filters.</p></div>';
                    return;
                }

                results.forEach(result => {
                    const card = this.createResultCard(result);
                    container.appendChild(card);
                });
            }

            renderFixtures(fixtures) {
                const container = document.getElementById('fixturesCardView');
                container.innerHTML = '';

                if (fixtures.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No Fixtures Found</h3><p>No upcoming fixtures found for the selected filters.</p></div>';
                    return;
                }

                fixtures.forEach(fixture => {
                    const card = this.createFixtureCard(fixture);
                    container.appendChild(card);
                });
            }

            createResultCard(result) {
                const card = document.createElement('div');
                card.className = 'fixture-card-large result';

                // Handle cancelled/postponed fixtures
                if (result.matchStatus === 'cancelled' || result.matchStatus === 'postponed') {
                    const isCancelled = result.matchStatus === 'cancelled';
                    const statusLabel = isCancelled ? 'Cancelled' : 'Postponed';
                    const statusColor = isCancelled ? '#6c757d' : '#ff9800';
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-type" style="color: ${statusColor};">${statusLabel}</div>
                            <div class="card-date">${this.formatDate(result.date)} ‚Ä¢ ${result.season}</div>
                        </div>
                        <div class="card-teams">
                            <div class="team-matchup" style="text-decoration: line-through; opacity: 0.7;">${result.homeTeam} vs ${result.awayTeam}</div>
                            <div class="card-score" style="font-size: 1rem; color: ${statusColor};">Match ${statusLabel}</div>
                        </div>
                        <div class="card-details">
                            <div class="card-venue">
                                <span class="venue-badge venue-${result.venue === 'Home Ground' ? 'home' : 'away'}">${result.venue}</span>
                            </div>
                            <div style="font-weight: bold; color: ${statusColor};">${statusLabel}</div>
                        </div>
                        <div class="card-competition">${result.competition}</div>
                    `;
                    return card;
                }

                const hasScores = result.ourScore !== null &&
                                 result.ourScore !== '' &&
                                 result.ourScore !== undefined &&
                                 result.theirScore !== null &&
                                 result.theirScore !== '' &&
                                 result.theirScore !== undefined;

                if (hasScores) {
                    const isHome = result.venue === 'Home Ground';
                    const homeScore = isHome ? result.ourScore : result.theirScore;
                    const awayScore = isHome ? result.theirScore : result.ourScore;
                    
                    const isWin = parseInt(result.ourScore) > parseInt(result.theirScore);
                    const resultText = isWin ? 'Victory' : parseInt(result.ourScore) === parseInt(result.theirScore) ? 'Draw' : 'Defeat';
                    
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-type">Result</div>
                            <div class="card-date">${this.formatDate(result.date)} ‚Ä¢ ${result.season}</div>
                        </div>
                        <div class="card-teams">
                            <div class="team-matchup">${result.homeTeam} vs ${result.awayTeam}</div>
                            <div class="card-score">${homeScore} - ${awayScore}</div>
                        </div>
                        <div class="card-details">
                            <div class="card-venue">
                                <span class="venue-badge venue-${result.venue === 'Home Ground' ? 'home' : 'away'}">${result.venue}</span>
                            </div>
                            <div style="font-weight: bold; color: white;">${resultText}</div>
                        </div>
                        <div class="card-competition">${result.competition}</div>
                        <div class="card-actions">
                            ${this.renderActionButtons(result)}
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-type">Result Pending</div>
                            <div class="card-date">${this.formatDate(result.date)} ‚Ä¢ ${result.season}</div>
                        </div>
                        <div class="card-teams">
                            <div class="team-matchup">${result.homeTeam} vs ${result.awayTeam}</div>
                            <div class="card-score" style="font-size: 1rem; color: rgba(255,255,255,0.8);">Score to be confirmed</div>
                        </div>
                        <div class="card-details">
                            <div class="card-venue">
                                <span class="venue-badge venue-${result.venue === 'Home Ground' ? 'home' : 'away'}">${result.venue}</span>
                            </div>
                            <div style="font-weight: bold; color: white;">Match Completed</div>
                        </div>
                        <div class="card-competition">${result.competition}</div>
                        <div class="card-actions">
                            ${this.renderActionButtons(result)}
                        </div>
                    `;
                }
                
                return card;
            }

            createFixtureCard(fixture) {
                const card = document.createElement('div');
                card.className = 'fixture-card-large upcoming';

                // Handle cancelled/postponed upcoming fixtures
                if (fixture.matchStatus === 'cancelled' || fixture.matchStatus === 'postponed') {
                    const isCancelled = fixture.matchStatus === 'cancelled';
                    const statusLabel = isCancelled ? 'Cancelled' : 'Postponed';
                    const statusColor = isCancelled ? '#6c757d' : '#ff9800';
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-type" style="color: ${statusColor};">${statusLabel}</div>
                            <div class="card-date">${this.formatDate(fixture.date)} ‚Ä¢ ${fixture.season}</div>
                        </div>
                        <div class="card-teams">
                            <div class="team-matchup" style="text-decoration: line-through; opacity: 0.7;">${fixture.homeTeam} vs ${fixture.awayTeam}</div>
                            <div class="card-score" style="font-size: 1rem; color: ${statusColor};">Match ${statusLabel}</div>
                        </div>
                        <div class="card-details">
                            <div class="card-venue">
                                <span class="venue-badge venue-${fixture.venue === 'Home Ground' ? 'home' : 'away'}">${fixture.venue}</span>
                            </div>
                            <div style="font-weight: bold; color: ${statusColor};">${statusLabel}</div>
                        </div>
                        <div class="card-competition">${fixture.competition}</div>
                    `;
                    return card;
                }

                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-type">Fixture</div>
                        <div class="card-date">${this.formatDate(fixture.date)} ‚Ä¢ ${fixture.season}</div>
                    </div>
                    <div class="card-teams">
                        <div class="team-matchup">${fixture.homeTeam} vs ${fixture.awayTeam}</div>
                        <div class="card-score">Kick-off: ${fixture.time}</div>
                    </div>
                    <div class="card-details">
                        <div class="card-venue">
                            <span class="venue-badge venue-${fixture.venue === 'Home Ground' ? 'home' : 'away'}">${fixture.venue}</span>
                        </div>
                        <div style="font-weight: bold; color: var(--primary-green);">Upcoming Match</div>
                    </div>
                    <div class="card-competition">${fixture.competition}</div>
                `;
                
                return card;
            }

            updateCounts(resultsCount, fixturesCount) {
                document.getElementById('resultsCount').textContent = `${resultsCount} matches`;
                document.getElementById('fixturesCount').textContent = `${fixturesCount} matches`;
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                const options = { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                };
                return date.toLocaleDateString('en-GB', options);
            }
        }

        function showMatchReport(team, date) {
            alert(`Match Report for ${team} on ${date}\n\nIn a real implementation, this would open a detailed match report page with:\n- Match statistics\n- Player performances\n- Photo gallery\n- Match highlights`);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            await loadFeatureStates();
            new FixturesPageManager();
        });

        document.getElementById('menuToggle')?.addEventListener('click', function() {
            const nav = document.querySelector('.nav');
            nav.classList.toggle('active');
        });

        document.querySelectorAll('.nav a').forEach(link => {
            link.addEventListener('click', () => {
                document.querySelector('.nav').classList.remove('active');
            });
        });

        // OLS 122: Teamsheet modal functions
        function openTeamsheetModal(imageUrl, opponent) {
            const modal = document.getElementById('teamsheetModal');
            const img = document.getElementById('teamsheetModalImg');
            const title = document.getElementById('teamsheetModalTitle');
            
            img.src = imageUrl;
            title.textContent = `üìã Teamsheet vs ${opponent}`;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeTeamsheetModal() {
            const modal = document.getElementById('teamsheetModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Close teamsheet modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTeamsheetModal();
            }
        });
        
        // Close teamsheet modal on background click
        document.getElementById('teamsheetModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'teamsheetModal') {
                closeTeamsheetModal();
            }
        });

        function openMatchReport(reportId, opponent) {
            if (!reportId) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
                    background: #fff3cd; color: #856404; padding: 1.5rem 2rem;
                    border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 10000; font-weight: 500; text-align: center;
                `;
                notification.innerHTML = `
                    <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">üìù Match Report Coming Soon</div>
                    <div style="font-size: 0.9rem;">No report available yet for the match vs ${opponent}</div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.transition = 'opacity 0.3s ease';
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
                return;
            }
            
            const news = JSON.parse(localStorage.getItem('olrfc_news') || '[]');
            const article = news.find(a => a.id === reportId);
            
            if (!article) {
                alert('Match report not found. It may have been deleted.');
                return;
            }
            
            sessionStorage.setItem('currentArticle', JSON.stringify(article));
            window.location.href = 'news-article.html';
        }
    </script>

<!-- ============================================================================ -->
<!-- DYNAMIC CMS CONTENT LOADER - OLS 79 (Updated OLS 93: No Flash) -->
<!-- ============================================================================ -->
<script>
(async function() {
    try {
        let settingsToApply = null;
        let loadedFromCache = false;
        
        const cachedSettings = localStorage.getItem('olrfc_site-settings');
        if (cachedSettings) {
            try {
                settingsToApply = JSON.parse(cachedSettings);
                loadedFromCache = true;
                console.log('‚ö° Using cached settings (instant load, no flash)');
                applyContent(settingsToApply);
                document.body.classList.add('cms-content-loaded');
            } catch (e) {
                console.warn('‚ö†Ô∏è Cache parse error:', e);
            }
        }
        
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'GET'
        });
        
        if (response.ok) {
            const result = await response.json();
            const freshSettings = result.data || {};
            
            localStorage.setItem('olrfc_site-settings', JSON.stringify(freshSettings));
            
            if (!loadedFromCache) {
                console.log('üì° First load: applying fresh settings from Netlify');
                applyContent(freshSettings);
                document.body.classList.add('cms-content-loaded');
            } else if (JSON.stringify(freshSettings) !== cachedSettings) {
                console.log('üîÑ Content updated, refreshing page...');
                applyContent(freshSettings);
            }
        } else if (!loadedFromCache) {
            console.log('‚ö†Ô∏è No cache, Netlify unavailable - using defaults');
            document.body.classList.add('cms-content-loaded');
        }
        
        function applyContent(settingsData) {
            const content = {};
            Object.keys(settingsData).forEach(key => {
                if (key.startsWith('fixtures-')) {
                    content[key] = settingsData[key];
                }
            });
            
            const get = (key, fallback) => content[key] || fallback;
            
            const pageTitle = get('fixtures-page-title', 'Fixtures & Results - Old Laurentian RFC');
            document.title = pageTitle;
            
            const mainHeading = document.querySelector('.fixtures-page-header h1');
            if (mainHeading) {
                const headingText = get('fixtures-main-heading', 'Fixtures & Results');
                mainHeading.textContent = headingText;
            }
            
            const pageDescription = document.querySelector('.fixtures-page-header p');
            if (pageDescription) {
                const descText = get('fixtures-page-description', 'Complete fixture list and results for all Old Laurentian RFC teams');
                pageDescription.textContent = descText;
            }
            
            const filterLabel = document.querySelector('label[for="team-selector-dropdown"]');
            if (filterLabel) {
                const labelText = get('fixtures-filter-label', 'Filter by Team:');
                filterLabel.textContent = labelText;
            }
            
            const allTeamsOption = document.querySelector('#team-selector-dropdown option[value="all"]');
            if (allTeamsOption) {
                const optionText = get('fixtures-all-teams-label', 'All Teams');
                allTeamsOption.textContent = optionText;
            }
            
            const resultsTitle = document.querySelector('#resultsSection .section-title-small');
            if (resultsTitle) {
                const titleText = get('fixtures-results-title', 'Recent Results');
                resultsTitle.textContent = titleText;
            }
            
            const upcomingTitle = document.querySelector('#fixturesSection .section-title-small');
            if (upcomingTitle) {
                const titleText = get('fixtures-upcoming-title', 'Upcoming Fixtures');
                upcomingTitle.textContent = titleText;
            }
            
            const summaryCards = document.querySelectorAll('.summary-card');
            if (summaryCards.length >= 4) {
                const defaultStats = [
                    { label: 'Games Played', detail: 'This Season' },
                    { label: 'Wins', detail: null },
                    { label: 'Upcoming', detail: 'Next 30 days' },
                    { label: 'Points Scored', detail: 'All competitions' }
                ];
                
                for (let i = 1; i <= 4; i++) {
                    const card = summaryCards[i - 1];
                    const labelEl = card.querySelector('.summary-label');
                    const detailEl = card.querySelector('.summary-detail');
                    
                    if (labelEl) {
                        const labelValue = get(`fixtures-summary${i}-label`, defaultStats[i - 1].label);
                        labelEl.textContent = labelValue;
                    }
                    
                    if (detailEl && defaultStats[i - 1].detail) {
                        const detailValue = get(`fixtures-summary${i}-detail`, defaultStats[i - 1].detail);
                        if (i !== 2) {
                            detailEl.textContent = detailValue;
                        }
                    }
                }
            }
            
            console.log('‚úÖ Fixtures page CMS content applied');
        }
        
    } catch (error) {
        console.error('‚ùå Error loading fixtures CMS content:', error);
        document.body.classList.add('cms-content-loaded');
    }
})();
</script>

<!-- ============================================================================ -->
<!-- DYNAMIC TEAM FILTERS LOADER - OLS 81 -->
<!-- ============================================================================ -->
<script>
(function() {
    async function loadTeamFilters() {
        try {
            console.log('üì• Loading teams from Netlify Blobs for fixtures dropdown...');
            
            const response = await fetch('/.netlify/functions/teams', {
                method: 'GET'
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch teams from Netlify');
            }
            
            const result = await response.json();
            let teams = result.data || [];
            
            // OLS 125: Sort teams by displayOrder (lower numbers first)
            teams = [...teams].sort((a, b) => {
                const orderA = a.displayOrder || 99;
                const orderB = b.displayOrder || 99;
                return orderA - orderB;
            });
            
            console.log(`üìä Loaded ${teams.length} teams for fixtures dropdown (sorted by displayOrder)`);
            
            const dropdown = document.getElementById('team-selector-dropdown');
            
            if (!dropdown) {
                console.warn('‚ö†Ô∏è Team dropdown element not found');
                return;
            }
            
            dropdown.innerHTML = '';
            
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.selected = true;
            allOption.textContent = 'All Teams';
            dropdown.appendChild(allOption);
            
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.slug;
                option.textContent = team.name;
                dropdown.appendChild(option);
            });
            
            console.log('‚úÖ Team dropdown loaded successfully from Netlify');
            
        } catch (error) {
            console.error('Error loading team filters:', error);
            
            const dropdown = document.getElementById('team-selector-dropdown');
            
            if (dropdown && dropdown.children.length === 0) {
                dropdown.innerHTML = '<option value="all" selected>All Teams</option>';
            }
            
            console.log('‚ö†Ô∏è Using fallback: All Teams only');
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadTeamFilters);
    } else {
        loadTeamFilters();
    }
})();
</script>

</body>
</html>
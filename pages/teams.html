<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teams & Players</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <script src="../js/sanitize-html.js"></script>
    <script src="../js/shared-settings.js"></script>
    <script src="../js/color-manager.js"></script>
    <style>
        /* Teams Page Specific Styles */
        .teams-page {
            margin-top: 100px;
            padding: 3rem 0;
            min-height: calc(100vh - 200px);
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon));
            color: white;
            padding: 3rem 2rem;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 3rem;
        }

        .page-header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .page-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Team Filter Tabs */
        .team-filters {
            background: var(--white);
            padding: 2rem 0;
            border-bottom: 2px solid var(--bg-light);
            position: sticky;
            top: 80px;
            z-index: 50;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .team-filters .filter-container {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .team-filter-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--primary-green);
            background: var(--white);
            color: var(--primary-green);
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .team-filter-btn:hover {
            background: var(--primary-green);
            color: var(--white);
            transform: translateY(-2px);
        }

        .team-filter-btn.active {
            background: var(--primary-green);
            color: var(--white);
        }

        /* Players Section */
        .players-section {
            padding: 4rem 0;
            min-height: 60vh;
        }

        .team-header-info {
            text-align: center;
            margin-bottom: 3rem;
        }

        .team-header-info h2 {
            font-size: 2.5rem;
            color: var(--primary-green);
            margin-bottom: 1rem;
        }

        .team-header-info .team-description {
            font-size: 1.1rem;
            color: var(--text-light);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Players Grid */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 2rem;
        }

        .player-card {
            background: var(--white);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            text-align: center;
        }

        .player-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .player-photo-container {
            width: 100%;
            height: 250px;
            position: relative;
            overflow: hidden;
            /* Default gradient fallback */
            background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon));
            background-size: cover;
            background-position: center;
        }

        .player-photo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center bottom;
            position: relative;
            z-index: 2;
            /* Transparent backgrounds work because Cloudinary removes them */
        }

        .player-photo.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: rgba(255,255,255,0.7);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .player-info {
            padding: 1.5rem;
        }

        .player-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-green);
            margin-bottom: 0.5rem;
        }

        .player-position {
            color: var(--text-light);
            font-size: 0.95rem;
            margin-bottom: 0.3rem;
        }

        .player-team-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--primary-green);
            color: white;
            font-size: 0.75rem;
            border-radius: 12px;
            margin-top: 0.5rem;
            font-weight: 600;
        }

        .player-appearances {
            color: var(--text-dark);
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .loading-spinner {
            border: 4px solid var(--bg-light);
            border-top: 4px solid var(--primary-green);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .empty-state h3 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .empty-state p {
            font-size: 1.1rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .teams-page {
                margin-top: 80px;
            }

            .page-header h1 {
                font-size: 2rem;
            }

            .team-filters .filter-container {
                justify-content: flex-start;
            }

            .players-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 1rem;
            }

            .player-photo {
                height: 180px;
            }

            .player-info {
                padding: 1rem;
            }

            .player-name {
                font-size: 1rem;
            }

            .team-header-info h2 {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .page-header h1 {
                font-size: 1.6rem;
            }

            .page-header p {
                font-size: 1rem;
            }

            .team-filter-btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header-placeholder" data-page="teams"></div>

    <!-- Main Content -->
    <main class="teams-page">
        <div class="container">
            
            <!-- Page Header -->
            <div class="page-header">
                <h1 id="teamsPageHeading">Our Teams</h1>
                <p id="teamsPageDescription">Meet the players who represent our club with pride</p>
            </div>

            <!-- Team Filter Tabs -->
            <div class="team-filters">
                <div class="container">
                    <div class="filter-container" id="teamFilters">
                        <button class="team-filter-btn active" data-team="all">All Teams</button>
                        <!-- Teams will be loaded here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Players Section -->
            <div class="players-section">
                <!-- Team Header (shows when specific team selected) -->
                <div class="team-header-info" id="teamHeaderInfo" style="display: none;">
                    <h2 id="teamName"></h2>
                    <p class="team-description" id="teamDescription"></p>
                </div>

                <!-- Loading State -->
                <div class="loading-state" id="loadingState">
                    <div class="loading-spinner"></div>
                    <p>Loading teams and players...</p>
                </div>

                <!-- Players Grid -->
                <div class="players-grid" id="playersGrid" style="display: none;">
                    <!-- Players will be loaded here dynamically -->
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <h3>üèâ No Players Yet</h3>
                    <p>Players will appear here once they've been added to this team.</p>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <div id="footer-placeholder" data-page="teams"></div>

    <!-- Scripts -->
    <script src="../js/main.js"></script>
    <script src="../js/header.js"></script>
    <script src="../js/footer.js"></script>
    <script src="../js/seo-manager.js"></script>

    <!-- ============================================================================ -->
    <!-- CMS CONTENT LOADER - OLS 119 -->
    <!-- Loads page title, heading, description from site-settings -->
    <!-- ============================================================================ -->
    <script>
    (async function() {
        try {
            let settingsToApply = null;
            let loadedFromCache = false;
            
            // üöÄ STEP 1: Check localStorage FIRST (instant, no flash)
            const cachedSettings = localStorage.getItem('olrfc_site-settings');
            if (cachedSettings) {
                try {
                    settingsToApply = JSON.parse(cachedSettings);
                    loadedFromCache = true;
                    console.log('‚ö° Using cached settings for teams page');
                    applyContent(settingsToApply);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Cache parse error:', e);
                }
            }
            
            // üåê STEP 2: Fetch fresh data from Netlify (background refresh OR first load)
            const response = await fetch('/.netlify/functions/site-settings', {
                method: 'GET'
            });
            
            if (response.ok) {
                const result = await response.json();
                const freshSettings = result.data || {};
                
                // Update localStorage cache
                localStorage.setItem('olrfc_site-settings', JSON.stringify(freshSettings));
                
                // Only re-apply if content changed OR this is first load
                if (!loadedFromCache) {
                    console.log('üì° First load: applying fresh settings from Netlify');
                    applyContent(freshSettings);
                } else if (JSON.stringify(freshSettings) !== cachedSettings) {
                    console.log('üîÑ Content updated, refreshing...');
                    applyContent(freshSettings);
                }
            }
            
            function applyContent(settingsData) {
                // Helper function to get content with fallback
                const get = (key, fallback) => settingsData[key] || fallback;
                
                // 1. Page Title
                const pageTitle = get('teams-page-title', 'Teams & Players');
                document.title = pageTitle;
                
                // 2. Main Heading
                const mainHeading = document.getElementById('teamsPageHeading');
                if (mainHeading) {
                    mainHeading.textContent = get('teams-main-heading', 'Our Teams');
                }
                
                // 3. Page Description
                const pageDescription = document.getElementById('teamsPageDescription');
                if (pageDescription) {
                    pageDescription.textContent = get('teams-page-description', 'Meet the players who represent our club with pride');
                }
                
                console.log('‚úÖ Teams page CMS content applied');
            }
            
        } catch (error) {
            console.error('‚ùå Error loading teams CMS content:', error);
        }
    })();
    </script>

    <!-- ============================================================================ -->
    <!-- TEAMS PAGE MANAGER - OLS 119 -->
    <!-- Fetches teams, players, and display filters from Netlify Blobs -->
    <!-- ============================================================================ -->
    <script>
        // Teams Page Manager
        class TeamsPageManager {
            constructor() {
                this.teams = [];
                this.filters = [];
                this.players = [];
                this.currentTeamSlug = null;
                this.init();
            }

            async init() {
                try {
                    await this.loadTeamsAndPlayers();
                    
                    // Set default selection: first filter, or first team, or null
                    if (this.filters.length > 0) {
                        this.currentTeamSlug = `filter:${this.filters[0].id}`;
                    } else if (this.teams.length > 0) {
                        this.currentTeamSlug = this.teams[0].slug;
                    }
                    
                    // Check for URL parameter (overrides default)
                    const urlParams = new URLSearchParams(window.location.search);
                    const teamParam = urlParams.get('team');
                    if (teamParam) {
                        this.currentTeamSlug = teamParam;
                    }
                    
                    this.renderTeamFilters();
                    this.renderPlayers();
                    this.setupEventListeners();
                } catch (error) {
                    console.error('Error initializing teams page:', error);
                    this.showError();
                }
            }

            async loadTeamsAndPlayers() {
                // üåê OLS 119: Fetch from Netlify Blobs (correct endpoints)
                try {
                    console.log('üåê Fetching players, teams, and filters from Netlify Blobs...');
                    
                    // Fetch players from Blobs
                    const playersResponse = await fetch('/.netlify/functions/players', {
                        method: 'GET'
                    });
                    
                    // Fetch teams from Blobs
                    const teamsResponse = await fetch('/.netlify/functions/teams', {
                        method: 'GET'
                    });
                    
                    // Fetch display filters from site-settings (Blobs)
                    const settingsResponse = await fetch('/.netlify/functions/site-settings', {
                        method: 'GET'
                    });
                    
                    // Process players
                    if (playersResponse.ok) {
                        const playersResult = await playersResponse.json();
                        const cloudPlayers = playersResult.data || [];
                        
                        if (cloudPlayers.length > 0) {
                            this.players = cloudPlayers;
                            localStorage.setItem('olrfc_players', JSON.stringify(cloudPlayers));
                            console.log(`‚úÖ Loaded ${cloudPlayers.length} players from Blobs`);
                        } else {
                            console.log('‚ö†Ô∏è No players in Blobs, using localStorage');
                            const localPlayers = localStorage.getItem('olrfc_players');
                            this.players = localPlayers ? JSON.parse(localPlayers) : [];
                        }
                    }
                    
                    // Process teams
                    if (teamsResponse.ok) {
                        const teamsResult = await teamsResponse.json();
                        const cloudTeams = teamsResult.data || [];
                        
                        if (cloudTeams.length > 0) {
                            this.teams = cloudTeams;
                            localStorage.setItem('olrfc_teams', JSON.stringify(cloudTeams));
                            console.log(`‚úÖ Loaded ${cloudTeams.length} teams from Blobs`);
                        } else {
                            console.log('‚ö†Ô∏è No teams in Blobs, using localStorage');
                            const localTeams = localStorage.getItem('olrfc_teams');
                            this.teams = localTeams ? JSON.parse(localTeams) : [];
                        }
                    }
                    
                    // Process display filters from site-settings
                    if (settingsResponse.ok) {
                        const settingsResult = await settingsResponse.json();
                        const settings = settingsResult.data || {};
                        
                        // Get team-display-filters from site-settings
                        const filtersJson = settings['team-display-filters'];
                        if (filtersJson) {
                            try {
                                const parsedFilters = typeof filtersJson === 'string' 
                                    ? JSON.parse(filtersJson) 
                                    : filtersJson;
                                
                                // Only use enabled filters, sorted by order
                                this.filters = parsedFilters
                                    .filter(f => f.enabled)
                                    .sort((a, b) => (a.order || 99) - (b.order || 99));
                                
                                localStorage.setItem('olrfc_team_filters', JSON.stringify(parsedFilters));
                                console.log(`‚úÖ Loaded ${this.filters.length} display filters from site-settings`);
                            } catch (e) {
                                console.warn('‚ö†Ô∏è Error parsing display filters:', e);
                            }
                        } else {
                            console.log('‚ö†Ô∏è No display filters in site-settings, using localStorage');
                            const localFilters = localStorage.getItem('olrfc_team_filters');
                            if (localFilters) {
                                const parsed = JSON.parse(localFilters);
                                this.filters = parsed.filter(f => f.enabled);
                            }
                        }
                    }
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è Cloud fetch failed, using localStorage:', error);
                }
                
                // üíæ FALLBACK - Load from localStorage if cloud fetch failed
                if (this.players.length === 0) {
                    const localPlayers = localStorage.getItem('olrfc_players');
                    this.players = localPlayers ? JSON.parse(localPlayers) : [];
                }
                
                if (this.teams.length === 0) {
                    const localTeams = localStorage.getItem('olrfc_teams');
                    this.teams = localTeams ? JSON.parse(localTeams) : [];
                }
                
                if (this.filters.length === 0) {
                    const localFilters = localStorage.getItem('olrfc_team_filters');
                    if (localFilters) {
                        const parsedFilters = JSON.parse(localFilters);
                        this.filters = parsedFilters.filter(f => f.enabled);
                    }
                }

                console.log(`‚úÖ Final: ${this.teams.length} teams, ${this.players.length} players, ${this.filters.length} filters`);
            }

            renderTeamFilters() {
                const filtersContainer = document.getElementById('teamFilters');
                
                let html = '';

                // Use filters if they exist, otherwise use individual teams
                if (this.filters.length > 0) {
                    // Show custom filters
                    this.filters.forEach((filter, index) => {
                        const isActive = this.currentTeamSlug === `filter:${filter.id}`;
                        html += `
                            <button class="team-filter-btn ${isActive ? 'active' : ''}" data-team="filter:${filter.id}">
                                ${filter.name}
                            </button>
                        `;
                    });
                } else {
                    // Fallback to individual teams
                    this.teams.forEach((team, index) => {
                        const isActive = this.currentTeamSlug === team.slug;
                        html += `
                            <button class="team-filter-btn ${isActive ? 'active' : ''}" data-team="${team.slug}">
                                ${team.name}
                            </button>
                        `;
                    });
                }

                filtersContainer.innerHTML = html;
            }

            setupEventListeners() {
                // Team filter buttons
                document.querySelectorAll('.team-filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const teamSlug = e.target.dataset.team;
                        this.filterByTeam(teamSlug);
                    });
                });
            }

            filterByTeam(teamSlug) {
                // Update active button
                document.querySelectorAll('.team-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.team === teamSlug) {
                        btn.classList.add('active');
                    }
                });

                this.currentTeamSlug = teamSlug;
                this.renderPlayers();

                // Update URL without page reload
                const newUrl = `${window.location.pathname}?team=${teamSlug}`;
                window.history.pushState({}, '', newUrl);
            }

            renderPlayers() {
                const loadingState = document.getElementById('loadingState');
                const playersGrid = document.getElementById('playersGrid');
                const emptyState = document.getElementById('emptyState');
                const teamHeaderInfo = document.getElementById('teamHeaderInfo');

                // Hide loading
                loadingState.style.display = 'none';

                // Determine if we're filtering by a filter group or individual team
                let filteredPlayers;
                let isFilterGroup = false;
                let currentFilter = null;
                let teamSlugsInFilter = [];

                if (this.currentTeamSlug && this.currentTeamSlug.startsWith('filter:')) {
                    // Filter group selected
                    const filterId = this.currentTeamSlug.replace('filter:', '');
                    currentFilter = this.filters.find(f => f.id === filterId);
                    
                    if (currentFilter) {
                        isFilterGroup = true;
                        teamSlugsInFilter = currentFilter.teamSlugs;
                        filteredPlayers = this.players.filter(p => teamSlugsInFilter.includes(p.team));
                    } else {
                        filteredPlayers = [];
                    }
                } else if (this.currentTeamSlug) {
                    // Individual team selected
                    filteredPlayers = this.players.filter(p => p.team === this.currentTeamSlug);
                } else {
                    // No selection (shouldn't happen, but handle gracefully)
                    filteredPlayers = [];
                }

                // Show team header
                if (isFilterGroup && currentFilter) {
                    // Show filter info
                    document.getElementById('teamName').textContent = currentFilter.name;
                    document.getElementById('teamDescription').textContent = currentFilter.description || '';
                    teamHeaderInfo.style.display = 'block';
                } else if (this.currentTeamSlug) {
                    // Show individual team info
                    const team = this.teams.find(t => t.slug === this.currentTeamSlug);
                    if (team) {
                        document.getElementById('teamName').textContent = team.name;
                        document.getElementById('teamDescription').textContent = team.description || '';
                        teamHeaderInfo.style.display = 'block';
                    }
                }

                // Show empty state if no players
                if (filteredPlayers.length === 0) {
                    playersGrid.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                // Render players
                emptyState.style.display = 'none';
                playersGrid.style.display = 'grid';

                // Get custom player card background (if set)
                const playerCardBg = localStorage.getItem('olrfc_player_card_background');
                const bgStyle = playerCardBg ? 
                    `style="background-image: url('${playerCardBg}'); background-size: cover; background-position: center;"` : 
                    '';
                
                playersGrid.innerHTML = filteredPlayers.map(player => {
                    return `
                        <div class="player-card">
                            <div class="player-photo-container" ${bgStyle}>
                                ${player.photo ? 
                                    `<img src="${player.photo}" alt="${player.name}" class="player-photo">` :
                                    `<div class="player-photo placeholder">üë§</div>`
                                }
                            </div>
                            <div class="player-info">
                                <div class="player-name">${player.name}</div>
                                ${player.position ? 
                                    `<div class="player-position">${player.position}</div>` : 
                                    ''
                                }
                                <!-- Appearances commented out until teamsheet generator implemented
                                <div class="player-appearances">
                                    ${player.appearances || 0} appearances
                                </div>
                                -->
                            </div>
                        </div>
                    `;
                }).join('');
            }

            showError() {
                const loadingState = document.getElementById('loadingState');
                loadingState.innerHTML = `
                    <h3 style="color: var(--primary-maroon);">‚ö†Ô∏è Error Loading Teams</h3>
                    <p>Please try refreshing the page.</p>
                `;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            new TeamsPageManager();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Old Laurentian RFC</title>

    <script src="../js/admin-permissions-enhanced.js"></script>
    <script src="../js/admin-permission-wrapper.js"></script>

    <!-- OLS 104: Activity Logger - Add this line -->
    <script src="../js/admin-activity-logger.js"></script>
    

    <script src="../js/cloudinary-upload.js"></script>
    <script src="../js/olrfc-netlify-data.js"></script>
    <script src="../js/contacts-manager.js"></script>
    <script src="../js/background-removal.js"></script>
     <script src="../js/color-manager.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: var(--bg-light);
        }

        .admin-header {
            background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon));
            color: white;
            padding: 1rem 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .admin-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-logo img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            padding: 5px;
        }

        .admin-nav {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .admin-nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: var(--transition);
            font-weight: 500;
        }

        .admin-nav a:hover, .admin-nav a.active {
            background: rgba(255,255,255,0.2);
        }

        .admin-nav a.logout {
            background: #dc3545;
        }

        .admin-nav a.logout:hover {
            background: #c82333;
        }

        /* OLS 132: New Sidebar Layout */
        .admin-layout {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        .admin-sidebar {
            width: 260px;
            background: linear-gradient(180deg, var(--primary-maroon) 0%, #4a1525 100%);
            padding: 1rem 0;
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar-section {
            margin-bottom: 0.5rem;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1.25rem;
            color: rgba(255,255,255,0.6);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }

        .sidebar-header:hover {
            color: rgba(255,255,255,0.9);
            background: rgba(255,255,255,0.05);
        }

        .sidebar-header .toggle-icon {
            transition: transform 0.2s ease;
        }

        .sidebar-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .sidebar-links {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .sidebar-links.collapsed {
            max-height: 0 !important;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 1.25rem 0.6rem 1.75rem;
            color: rgba(255,255,255,0.85);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .sidebar-link:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .sidebar-link.active {
            background: rgba(255,255,255,0.15);
            color: white;
            border-left-color: var(--accent-gold);
        }

        .sidebar-link .link-icon {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        .sidebar-link .link-badge {
            margin-left: auto;
            background: #dc3545;
            color: white;
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            font-weight: bold;
        }

        .sidebar-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 0.75rem 1.25rem;
        }

        .sidebar-solo-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.25rem;
            color: white;
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .sidebar-solo-link:hover {
            background: rgba(255,255,255,0.1);
        }

        .sidebar-solo-link.active {
            background: rgba(255,255,255,0.15);
            border-left-color: var(--accent-gold);
        }

        .admin-main {
            flex: 1;
            padding: 2rem;
            background: #f8f9fa;
            min-width: 0;
        }

        /* Quick Actions Bar */
        .quick-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: linear-gradient(135deg, var(--primary-green), #3d7a1f);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 80, 22, 0.3);
        }

        .quick-action-btn.secondary {
            background: linear-gradient(135deg, var(--primary-maroon), #4a1525);
        }

        .quick-action-btn.secondary:hover {
            box-shadow: 0 4px 12px rgba(128, 0, 32, 0.3);
        }

        /* Section header with manage button */
        .section-header-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .section-header-bar h2 {
            margin: 0;
        }

        .section-header-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .manage-link {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            background: #f0f0f0;
            color: var(--text-dark);
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .manage-link:hover {
            background: #e0e0e0;
        }

        /* Mobile sidebar */
        @media (max-width: 900px) {
            .admin-sidebar {
                position: fixed;
                left: -280px;
                top: 70px;
                z-index: 1000;
                transition: left 0.3s ease;
                box-shadow: 4px 0 20px rgba(0,0,0,0.2);
            }

            .admin-sidebar.open {
                left: 0;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 70px;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            }

            .sidebar-overlay.open {
                display: block;
            }

            .mobile-menu-btn {
                display: flex !important;
            }

            .admin-main {
                padding: 1rem;
            }

            /* Larger touch targets for sidebar on mobile */
            .sidebar-link {
                padding: 0.85rem 1.25rem 0.85rem 1.75rem;
                min-height: 44px;
            }

            .sidebar-solo-link {
                padding: 0.85rem 1.25rem;
                min-height: 44px;
            }

            .sidebar-header {
                padding: 0.85rem 1.25rem;
                min-height: 44px;
            }

            /* Section header stacking on mobile */
            .section-header-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .section-header-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .section-header-actions .btn,
            .section-header-actions .manage-link {
                flex: 1;
                text-align: center;
                justify-content: center;
                min-height: 44px;
            }

            /* Quick actions grid on mobile */
            .quick-actions {
                padding: 1rem;
            }

            .quick-action-btn {
                width: 100%;
                justify-content: center;
                min-height: 44px;
            }

            /* Manage links full width on mobile */
            .manage-link {
                padding: 0.6rem 1rem;
            }

            /* Stats grid mobile */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        @media (max-width: 480px) {
            /* Extra small screens */
            .admin-header-content {
                padding: 0 0.75rem;
            }

            .admin-logo h2 {
                font-size: 1rem;
            }

            .admin-logo small {
                display: none;
            }

            /* Icon-only nav on tiny screens */
            .admin-nav .nav-text {
                display: none;
            }

            .admin-nav a {
                padding: 0.5rem;
            }

            .section-header-bar h2 {
                font-size: 1.3rem;
            }

            .section-header-actions {
                flex-direction: column;
            }

            .section-header-actions .btn,
            .section-header-actions .manage-link {
                width: 100%;
            }

            /* Single column stats on very small screens */
            .stats-grid {
                grid-template-columns: 1fr !important;
            }

            /* Sidebar slightly narrower */
            .admin-sidebar {
                width: 240px;
            }

            /* Make buttons easier to tap */
            .btn {
                min-height: 44px;
                padding: 0.6rem 1rem;
            }
        }

        .mobile-menu-btn {
            display: none;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* OLS 107: Navigation Badge for New Enquiries */
        .nav-badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            margin-left: 0.5rem;
            min-width: 20px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Legacy container for compatibility */
        .admin-section .container {
            padding: 0;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .dashboard-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            border: 2px solid transparent;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-gold);
        }

        .card-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .card-title {
            font-size: 1.5rem;
            color: var(--primary-green);
            margin-bottom: 1rem;
        }

        .card-description {
            color: var(--text-light);
            margin-bottom: 1.5rem;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 25px;
            background: var(--primary-green);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: var(--transition);
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: var(--primary-maroon);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--accent-gold);
            color: var(--primary-green);
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .admin-section {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            display: none;
        }

        .admin-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--bg-light);
        }

        .section-header h2 {
            color: var(--primary-green);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-green);
        }

        .form-group textarea {
            height: 120px;
            resize: vertical;
        }

        .file-upload {
            border: 2px dashed #ddd;
            padding: 2rem;
            text-align: center;
            border-radius: 8px;
            transition: border-color 0.3s ease;
            background: var(--bg-light);
        }

        .file-upload:hover {
            border-color: var(--primary-green);
        }

        .file-upload input {
            margin-top: 1rem;
        }

        .content-list {
            margin-top: 2rem;
        }

        .content-item {
            background: var(--bg-light);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .content-item:hover {
            background: #e9ecef;
        }

        .content-info h4 {
            color: var(--primary-green);
            margin-bottom: 0.5rem;
        }

        .content-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        .btn-edit {
            background: var(--accent-gold);
            color: var(--primary-green);
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(45deg, var(--primary-green), var(--primary-maroon));
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-card.clickable {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card.clickable:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .stat-card.clickable:active {
            transform: translateY(-1px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--bg-light);
        }

        .modal-header h3 {
            color: var(--primary-green);
        }

        .close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        .close:hover {
            background: #f8f9fa;
        }

        /* Cover Photo Selection */
        .cover-photo-option {
            position: relative;
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            aspect-ratio: 1;
        }

        .cover-photo-option:hover {
            transform: scale(1.05);
            border-color: var(--primary-maroon);
        }

        .cover-photo-option.selected {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(var(--primary-green-rgb), 0.2);
        }

        .cover-photo-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .cover-photo-option.selected::after {
            content: '✓';
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--primary-green);
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
        }

        .welcome-banner {
            background: linear-gradient(45deg, var(--primary-green), var(--primary-maroon));
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .welcome-banner h1 {
            margin-bottom: 0.5rem;
        }

        .admin-user {
            color: var(--accent-gold);
            font-weight: bold;
        }

        .quick-actions {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .quick-actions h3 {
            color: var(--primary-green);
            margin-bottom: 1rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .data-management {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-top: 2rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        /* Shop specific styles */
        .shop-item {
            align-items: flex-start !important;
        }

        .shop-item .content-info {
            flex: 1;
        }

        #shopCategoryFilters .btn.active {
            background: var(--primary-green) !important;
            color: white !important;
        }

        /* Sponsor-specific styles */
        .sponsor-item {
            align-items: flex-start !important;
        }

        .sponsor-item .content-info {
            flex: 1;
        }

        .sponsor-tier-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 1rem;
        }

        .tier-platinum { background: linear-gradient(45deg, #e5e4e2, #c0c0c0); color: #333; }
        .tier-gold { background: linear-gradient(45deg, #ffd700, #ffed4e); color: #333; }
        .tier-silver { background: linear-gradient(45deg, #c0c0c0, #a8a8a8); color: #333; }
        .tier-bronze { background: linear-gradient(45deg, #cd7f32, #b8860b); color: white; }

        #sponsorTierFilters .btn.active {
            background: var(--primary-green) !important;
            color: white !important;
        }

        @keyframes previewScroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .sponsor-preview-logo {
            flex: 0 0 auto;
            height: 40px;
            min-width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 0.7rem;
            text-align: center;
        }

        .sponsor-preview-logo img {
            max-height: 30px;
            max-width: 70px;
            object-fit: contain;
        }

        /* Website Feature Toggle Styles */
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--accent-gold);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            /* Keep header horizontal but compact */
            .admin-header-content {
                flex-direction: row;
                justify-content: space-between;
                padding: 0 0.5rem;
            }

            .admin-nav {
                gap: 0.5rem;
            }

            .admin-nav a {
                padding: 0.4rem 0.6rem;
                font-size: 0.85rem;
            }

            .container {
                padding: 1rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .content-item {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .content-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .action-buttons {
                flex-direction: column;
            }

            .modal-content {
                width: 95%;
                max-height: 90vh;
                padding: 1.5rem;
                overflow-y: auto;
            }

            /* Dashboard quick actions */
            .quick-actions .action-buttons {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .quick-actions .action-buttons .btn {
                font-size: 0.85rem;
                padding: 0.6rem;
            }

            /* Standalone section cards */
            #news-categories > div,
            #league-tables > div,
            #club-sections > div,
            #data-migration > div {
                padding: 1rem;
            }
        }
        
        @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* Site Customization Styles */
.customization-tab {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Color picker sync */
input[type="color"] {
    transition: transform 0.2s ease;
}

input[type="color"]:hover {
    transform: scale(1.05);
}

/* Toggle Switch Styles */
/* Navigation Settings toggle input styles (extends the .toggle-switch above) */
.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-switch input:checked + .toggle-slider {
    background: var(--accent-gold);
}

.toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(30px);
}

.toggle-switch input:focus + .toggle-slider {
    box-shadow: 0 0 4px var(--accent-gold);
}

/* Display Filters Styles */
.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 1rem;
    background: var(--bg-light);
    border-radius: 8px;
}

.checkbox-group label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem;
    cursor: pointer;
}

.checkbox-group label:hover {
    background: var(--white);
    border-radius: 5px;
}

.info-box {
    background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
    border-left: 4px solid var(--primary-green);
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
}

.info-box h4 {
    color: var(--primary-green);
    margin-bottom: 0.5rem;
}

.info-box ul {
    margin-left: 1.5rem;
    margin-top: 0.5rem;
}

.player-team-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: var(--primary-green);
    color: white;
    font-size: 0.75rem;
    border-radius: 12px;
    margin-top: 0.5rem;
}

        /* Content Management Accordion Styles - OLS 76 */
        .content-accordion summary {
            transition: all 0.3s ease;
        }
        
        .content-accordion summary:hover {
            background: rgba(var(--primary-green-rgb), 0.05);
            border-radius: 8px;
        }
        
        .content-accordion[open] summary .accordion-icon {
            transform: rotate(180deg);
        }
        
        .content-accordion:not([open]) summary .accordion-icon {
            transform: rotate(-90deg);
        }
        
        .content-accordion summary::-webkit-details-marker {
            display: none;
        }
        
        /* OLS 100: Bulk Edit Fixtures Table Styles */
        #bulkEditFixturesTable input,
        #bulkEditFixturesTable select {
            width: 100%;
            padding: 0.4rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            background: white;
            transition: all 0.3s ease;
        }
        
        #bulkEditFixturesTable input:focus,
        #bulkEditFixturesTable select:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 2px rgba(var(--primary-green-rgb), 0.1);
        }
        
        #bulkEditFixturesTable tbody tr {
            background: white;
            transition: background 0.2s ease;
        }
        
        #bulkEditFixturesTable tbody tr:hover {
            background: #f8f9fa;
        }
        
        #bulkEditFixturesTable tbody td {
            padding: 0.6rem;
            border: 1px solid #ddd;
            transition: background 0.3s ease;
        }
        
        /* Highlight changed cells */
        #bulkEditFixturesTable tbody td.changed {
            background: #fff3cd !important;
            border-color: #ffc107 !important;
        }
        
        #bulkEditFixturesTable tbody td.changed input,
        #bulkEditFixturesTable tbody td.changed select {
            background: #fff3cd;
            border-color: #ffc107;
            font-weight: bold;
        }

        /* OLS 127: Enhanced Bulk Edit Styles */
        #bulkEditFixturesTable .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        #bulkEditFixturesTable .checkbox-cell input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        #bulkEditFixturesTable tbody tr.marked-for-delete {
            background: rgba(220, 53, 69, 0.15) !important;
            opacity: 0.7;
        }

        #bulkEditFixturesTable tbody tr.marked-for-delete td {
            text-decoration: line-through;
            color: #999;
        }

        #bulkEditFixturesTable tbody tr.new-row {
            background: rgba(40, 167, 69, 0.15) !important;
        }

        #bulkEditFixturesTable tbody tr.new-row td {
            border-left: 3px solid #28a745;
        }

        /* Spreadsheet import styles */
        .btn-upload {
            background: #17a2b8 !important;
            color: white !important;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        .btn-upload:hover {
            background: #138496 !important;
        }

        #bulkEditFixturesTable tbody tr.imported-row {
            background: rgba(23, 162, 184, 0.12) !important;
        }

        #bulkEditFixturesTable tbody tr.imported-row td {
            border-left: 3px solid #17a2b8;
        }

        .spreadsheet-import-summary {
            background: linear-gradient(135deg, #e8f4f8, #d1ecf1);
            border: 1px solid #bee5eb;
            border-left: 4px solid #17a2b8;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .spreadsheet-import-summary .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .spreadsheet-import-summary .summary-header h4 {
            margin: 0;
            color: #0c5460;
            font-size: 1rem;
        }

        .spreadsheet-import-summary .summary-dismiss {
            background: none;
            border: none;
            color: #0c5460;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            line-height: 1;
            opacity: 0.6;
        }

        .spreadsheet-import-summary .summary-dismiss:hover {
            opacity: 1;
        }

        .spreadsheet-import-summary .summary-stats {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }

        .spreadsheet-import-summary .stat-item {
            font-size: 0.9rem;
            color: #0c5460;
        }

        .spreadsheet-import-summary .stat-item strong {
            font-size: 1.1rem;
        }

        .spreadsheet-import-summary .stat-added { color: #28a745; }
        .spreadsheet-import-summary .stat-skipped { color: #6c757d; }
        .spreadsheet-import-summary .stat-warnings { color: #ff9800; }

        .spreadsheet-import-summary details {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #0c5460;
        }

        .spreadsheet-import-summary details summary {
            cursor: pointer;
            font-weight: bold;
            color: #17a2b8;
        }

        .spreadsheet-import-summary details ul {
            margin: 0.5rem 0 0 1.5rem;
            padding: 0;
        }

        .spreadsheet-import-summary details li {
            margin-bottom: 0.25rem;
        }

        /* Calendar Dedup styles */
        .btn-dedup {
            background: #6f42c1 !important;
            color: white !important;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        .btn-dedup:hover {
            background: #5a32a3 !important;
        }

        .dedup-summary {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            padding: 1rem;
            background: linear-gradient(135deg, #f3eaff, #e8daff);
            border: 1px solid #d4b8ff;
            border-left: 4px solid #6f42c1;
            border-radius: 8px;
        }

        .dedup-summary .dedup-stat {
            text-align: center;
        }

        .dedup-summary .dedup-stat strong {
            display: block;
            font-size: 1.5rem;
            color: #6f42c1;
        }

        .dedup-summary .dedup-stat span {
            font-size: 0.85rem;
            color: #666;
        }

        #dedupResultsTable tbody tr {
            border-bottom: 1px solid #eee;
        }

        #dedupResultsTable tbody tr:hover {
            background: #f8f4ff;
        }

        #dedupResultsTable td {
            padding: 0.5rem 0.6rem;
            border: 1px solid #eee;
        }

        .dedup-orphan {
            color: #dc3545;
            font-size: 0.8rem;
            font-style: italic;
        }

        .dedup-old-id {
            color: #6c757d;
            font-size: 0.8rem;
            font-family: monospace;
        }

        .bulk-action-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #f0f0f0;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .bulk-action-bar .selection-count {
            font-weight: bold;
            color: var(--primary-green);
        }

        .bulk-action-bar .btn-danger {
            background: #dc3545;
            color: white;
        }

        .bulk-action-bar .btn-danger:hover {
            background: #c82333;
        }

        .bulk-action-bar .btn-success {
            background: #28a745;
            color: white;
        }

        .bulk-action-bar .btn-success:hover {
            background: #218838;
        }
        
        /* OLS 100: Fixture Time Filter Tabs */
        .fixture-time-tab {
            padding: 1rem 2rem;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .fixture-time-tab:hover {
            color: var(--primary-green);
            background: rgba(var(--primary-green-rgb), 0.05);
        }
        
        .fixture-time-tab.active {
            color: var(--primary-green);
            border-bottom-color: var(--primary-green);
            background: rgba(var(--primary-green-rgb), 0.1);
        }
        
        /* OLS 100: Missing Score Warning Badge */
        .missing-score-warning {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .missing-score-warning::before {
            content: '⚠️';
            font-size: 1.2rem;
        }
        
        .content-item.missing-score {
            border-left: 4px solid #ffc107;
            background: rgba(255, 193, 7, 0.05);
        }
        
        /* ============================================ */
        /* OLS 102: Loading Spinner Styles */
        /* ============================================ */
        
        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s ease-in-out;
        }

        .loading-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .loading-spinner-container {
            background: var(--white);
            padding: 3rem 4rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .loading-spinner {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
        }

        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-radius: 50%;
            animation: spin 1.5s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }

        .spinner-ring:nth-child(1) {
            border-top-color: var(--primary-green);
            animation-delay: -0.45s;
        }

        .spinner-ring:nth-child(2) {
            border-top-color: var(--primary-maroon);
            animation-delay: -0.3s;
        }

        .spinner-ring:nth-child(3) {
            border-top-color: var(--accent-gold);
            animation-delay: -0.15s;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-dark);
            font-size: 1.1rem;
            font-weight: 600;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .loading-spinner-container.success {
            animation: successPop 0.4s ease-out;
        }

        .loading-spinner-container.error {
            animation: errorShake 0.4s ease-out;
        }

        @keyframes successPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .loading-checkmark {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            border-radius: 50%;
            display: none;
            background: linear-gradient(45deg, var(--primary-green), var(--primary-maroon));
            position: relative;
        }

        .loading-checkmark.show {
            display: block;
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .loading-checkmark::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--white);
            font-size: 3rem;
            font-weight: bold;
        }

        .loading-error {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            border-radius: 50%;
            display: none;
            background: #dc3545;
            position: relative;
        }

        .loading-error.show {
            display: block;
            animation: scaleIn 0.3s ease-out;
        }

        .loading-error::after {
            content: '✕';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--white);
            font-size: 3rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    
    <!-- ============================================ -->
    <!-- OLS 102: Loading Spinner Component -->
    <!-- ============================================ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner-container">
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <div class="loading-text">
                <span id="loadingMessage">Saving changes...</span>
            </div>
        </div>
    </div>
    <!-- END Loading Spinner -->
    
    <!-- ============================================ -->
    <!-- SECURITY: Enhanced Admin Authentication (OLS 97) -->
    <!-- ============================================ -->
    <script>
        // Check if user is authenticated on page load
        (function() {
            const adminSession = localStorage.getItem('olrfc_admin_session');
            
            // If no session token exists, redirect to homepage
            if (!adminSession) {
                alert('⚠️ Unauthorized Access!\n\nPlease login through the admin portal.');
                window.location.href = '../index.html';
                return;
            }
            
            // Parse and validate session
            try {
                const session = JSON.parse(adminSession);
                const currentTime = new Date().getTime();
                
                // Check if session has required fields
                if (!session.userId || !session.email || !session.role) {
                    throw new Error('Invalid session structure');
                }
                
                // Check if session has expired (24 hours)
                if (session.expiresAt && currentTime > session.expiresAt) {
                    localStorage.removeItem('olrfc_admin_session');
                    alert('⏱️ Session Expired!\n\nYour session has expired. Please login again.');
                    window.location.href = '../index.html';
                    return;
                }
                
                // Session is valid - store globally for access control
                window.currentAdmin = session;
                
                console.log('✅ Admin authenticated:', session.username, '(' + session.role + ')');
                
                // Apply role-based UI customization on page load
                document.addEventListener('DOMContentLoaded', function() {
                    applyRoleBasedPermissions(session);
                });
                
            } catch (error) {
                // Invalid session data - remove and redirect
                console.error('Session validation error:', error);
                localStorage.removeItem('olrfc_admin_session');
                alert('❌ Invalid Session!\n\nPlease login again.');
                window.location.href = '../index.html';
                return;
            }
        })();

        // ============================================================================
        // GLOBAL VARIABLES (OLS 100)
        // Must be defined early, before AdminSystem initialization
        // ============================================================================
        let currentFixtureTimeFilter = 'upcoming';
        // ============================================================================

        /**
         * Apply role-based permissions to dashboard UI
         */
        function applyRoleBasedPermissions(session) {
            const role = session.role;
            const permissions = session.permissions || {};
            
            // Hide admin management section if not super-admin
            if (role !== 'super-admin') {
                setTimeout(function() {
                    const adminMgmt = document.getElementById('admin-management');
                    const adminMgmtNav = document.querySelector('[onclick*="admin-management"]');
                    const adminMgmtCard = document.querySelector('[onclick*="admin-management"]');
                    
                    if (adminMgmt) adminMgmt.style.display = 'none';
                    if (adminMgmtNav) adminMgmtNav.style.display = 'none';
                    if (adminMgmtCard) adminMgmtCard.style.display = 'none';
                }, 100);
            }
            
            // Apply permissions to content sections
            const contentSections = [
                { name: 'news', element: 'news' },
                { name: 'fixtures', element: 'fixtures' },
                { name: 'players', element: 'players' },
                { name: 'sponsors', element: 'sponsors' },
                { name: 'gallery', element: 'gallery' },
                { name: 'shop', element: 'shop' },
                { name: 'teams', element: 'teams' }
            ];
            
            setTimeout(function() {
                contentSections.forEach(function(section) {
                    if (permissions[section.name] === false) {
                        const sectionEl = document.getElementById(section.element);
                        const cardEl = document.querySelector('[onclick*="' + section.element + '"]');
                        
                        if (sectionEl) sectionEl.style.display = 'none';
                        if (cardEl) cardEl.style.display = 'none';
                    }
                });
            }, 100);
            
            // Editors can't delete items - hide delete buttons
            if (role === 'editor') {
                setTimeout(function() {
                    document.querySelectorAll('.delete-btn, .btn-delete, [onclick*="delete"]').forEach(function(btn) {
                        if (btn.textContent.includes('Delete') || btn.textContent.includes('🗑️')) {
                            btn.style.display = 'none';
                        }
                    });
                }, 500);
            }
        }

        /**
         * Check if current user has specific permission
         */
        function hasPermission(permissionName) {
            if (!window.currentAdmin) return false;
            if (window.currentAdmin.role === 'super-admin') return true;
            return window.currentAdmin.permissions[permissionName] === true;
        }

        /**
         * Check if current user has specific role
         */
        function hasRole(roleName) {
            if (!window.currentAdmin) return false;
            return window.currentAdmin.role === roleName;
        }
    </script>
    <!-- ============================================ -->
    
    <header class="admin-header">
        <div class="admin-header-content">
            <div class="admin-logo">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>
                <!-- Logo hidden by default, only shows when custom logo uploaded -->
                <img id="admin-header-logo" src="" alt="Club Logo" style="max-height: 50px; width: auto; display: none;">
                <div>
                    <h2 id="admin-header-club-name">Old Laurentian RFC</h2>
                    <small>Admin Dashboard</small>
                </div>
            </div>
            <nav class="admin-nav">
                <a href="../index.html" class="nav-link-site"><span class="nav-icon">🌐</span><span class="nav-text"> View Site</span></a>
                <a href="#" onclick="adminLogout()" class="logout"><span class="nav-icon">🚪</span><span class="nav-text"> Logout</span></a>
            </nav>
        </div>
    </header>

    <!-- Mobile overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="admin-layout">
        <!-- OLS 132: New Sidebar Navigation -->
        <aside id="adminSidebar" class="admin-sidebar">
            <!-- Dashboard -->
            <a href="#dashboard" class="sidebar-solo-link active" onclick="showSection('dashboard'); closeSidebarMobile();">
                <span class="link-icon">📊</span> Dashboard
            </a>
            
            <div class="sidebar-divider"></div>

            <!-- CONTENT Section -->
            <div class="sidebar-section">
                <div class="sidebar-header" onclick="toggleSidebarSection(this)">
                    <span>📰 Content</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="sidebar-links" style="max-height: 200px;">
                    <a href="#news" class="sidebar-link" onclick="showSection('news'); closeSidebarMobile();">
                        <span class="link-icon">📰</span> News Articles
                    </a>
                    <a href="#news-categories" class="sidebar-link" onclick="showSection('news-categories'); closeSidebarMobile();">
                        <span class="link-icon">🏷️</span> News Categories
                    </a>
                    <a href="#fixtures" class="sidebar-link" onclick="showSection('fixtures'); closeSidebarMobile();">
                        <span class="link-icon">📅</span> Fixtures & Results
                    </a>
                    <a href="#league-tables" class="sidebar-link" onclick="showSection('league-tables'); closeSidebarMobile();">
                        <span class="link-icon">🏆</span> League Tables
                    </a>
                </div>
            </div>

            <!-- PEOPLE Section -->
            <div class="sidebar-section">
                <div class="sidebar-header" onclick="toggleSidebarSection(this)">
                    <span>👥 People & Teams</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="sidebar-links" style="max-height: 250px;">
                    <a href="#teams" class="sidebar-link" onclick="showSection('teams'); closeSidebarMobile();">
                        <span class="link-icon">🏉</span> Teams
                    </a>
                    <a href="#players" class="sidebar-link" onclick="showSection('players'); closeSidebarMobile();">
                        <span class="link-icon">🏃</span> Players
                    </a>
                    <a href="#club-sections" class="sidebar-link" onclick="showSection('club-sections'); closeSidebarMobile();">
                        <span class="link-icon">🏢</span> Club Sections
                    </a>
                    <a href="#filters" class="sidebar-link" onclick="showSection('filters'); closeSidebarMobile();">
                        <span class="link-icon">🎯</span> Display Filters
                    </a>
                </div>
            </div>

            <!-- CLUB Section -->
            <div class="sidebar-section">
                <div class="sidebar-header" onclick="toggleSidebarSection(this)">
                    <span>🏛️ Club</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="sidebar-links" style="max-height: 250px;">
                    <a href="#sponsors" class="sidebar-link" onclick="showSection('sponsors'); closeSidebarMobile();">
                        <span class="link-icon">🤝</span> Sponsors
                    </a>
                    <a href="#contacts" class="sidebar-link" onclick="showSection('contacts'); closeSidebarMobile();">
                        <span class="link-icon">📇</span> Club Contacts
                    </a>
                    <a href="#vp-wall" class="sidebar-link" onclick="showSection('vp-wall'); closeSidebarMobile();">
                        <span class="link-icon">🎖️</span> Vice Presidents
                    </a>
                    <a href="#events-enquiry" class="sidebar-link" onclick="showSection('events-enquiry'); closeSidebarMobile();">
                        <span class="link-icon">📧</span> Events & Enquiries
                        <span id="sidebar-enquiry-badge" class="link-badge" style="display: none;">0</span>
                    </a>
                </div>
            </div>

            <!-- MEDIA Section -->
            <div class="sidebar-section">
                <div class="sidebar-header" onclick="toggleSidebarSection(this)">
                    <span>🖼️ Media</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="sidebar-links" style="max-height: 100px;">
                    <a href="#gallery" class="sidebar-link" onclick="showSection('gallery'); closeSidebarMobile();">
                        <span class="link-icon">📸</span> Gallery
                    </a>
                    <a href="#shop" class="sidebar-link" onclick="showSection('shop'); closeSidebarMobile();">
                        <span class="link-icon">🛒</span> Shop
                    </a>
                </div>
            </div>

            <div class="sidebar-divider"></div>

            <!-- SETTINGS Section -->
            <div class="sidebar-section">
                <div class="sidebar-header" onclick="toggleSidebarSection(this)">
                    <span>⚙️ Settings</span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="sidebar-links" style="max-height: 350px;">
                    <a href="#site-customization" class="sidebar-link" onclick="showSection('site-customization'); closeSidebarMobile();">
                        <span class="link-icon">🎨</span> Site Appearance
                    </a>
                    <a href="#content-management" class="sidebar-link" onclick="showSection('content-management'); closeSidebarMobile();">
                        <span class="link-icon">📝</span> Page Content
                    </a>
                    <a href="#admin-management" class="sidebar-link" onclick="showSection('admin-management'); closeSidebarMobile();">
                        <span class="link-icon">👤</span> Admin Users
                    </a>
                    <a href="#activity-log" class="sidebar-link" onclick="showSection('activity-log'); closeSidebarMobile();">
                        <span class="link-icon">📋</span> Activity Log
                    </a>
                    <a href="#data-migration" class="sidebar-link" onclick="showSection('data-migration'); closeSidebarMobile();">
                        <span class="link-icon">☁️</span> Data Migration
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="admin-main">
            <div class="container">
        <!-- Dashboard Overview -->
        <div id="dashboard" class="admin-section active">
            <div class="welcome-banner">
                <h1>Welcome to the Admin Dashboard</h1>
                <p>Logged in as: <span class="admin-user" id="currentUser">Admin User</span></p>
                <p>Manage your Old Laurentian RFC website content from here</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card clickable" onclick="showSection('news')">
                    <span class="stat-number" id="newsCount">0</span>
                    <span>News Articles</span>
                </div>
                <div class="stat-card clickable" onclick="showSection('fixtures')">
                    <span class="stat-number" id="fixturesCount">0</span>
                    <span>Fixtures</span>
                </div>
                <div class="stat-card clickable" onclick="showSection('gallery')">
                    <span class="stat-number" id="galleryCount">0</span>
                    <span>Gallery Albums</span>
                </div>
                <div class="stat-card clickable" onclick="showSection('players')">
                    <span class="stat-number" id="playersCount">0</span>
                    <span>Players</span>
                </div>
                <div class="stat-card clickable" onclick="showSection('teams')">
                    <span class="stat-number" id="teamsCount">0</span>
                    <span>Teams</span>
                </div>
                <div class="stat-card clickable" onclick="showSection('shop')">
                    <span class="stat-number" id="shopCount">0</span>
                    <span>Shop Items</span>
                </div>
                    
                <div class="stat-card clickable" onclick="showSection('events-enquiry')">
                    <span class="stat-number" id="enquiriesCount">0</span>
                    <span>Enquiries</span>
                </div>
        
                <div class="stat-card clickable" onclick="showSection('sponsors')">
                    <span class="stat-number" id="sponsorsCount">0</span>
                    <span>Sponsors</span>
                </div>
                <div class="stat-card clickable" onclick="showSection('contacts')">
                    <span class="stat-number" id="contactsCount">0</span>
                    <span>Contacts</span>
               </div>
                <div class="stat-card clickable" onclick="showSection('vp-wall')">
                    <span class="stat-number" id="vpsCount">0</span>
                    <span>Vice Presidents</span>
               </div>
            </div>

            <div class="quick-actions">
                <h3>⚡ Quick Actions</h3>
                <div class="action-buttons">
                    <button class="btn" onclick="populateNewsClubSectionDropdown(); openModal('newsModal')">📰 Add News</button>
                    <button class="btn" onclick="adminSystem.currentEditIndex = null; openModal('fixtureModal')">🏉 Add Fixture</button>
                    <button class="btn" onclick="openModal('galleryModal')">📸 Upload Photos</button>
                    <button class="btn" onclick="openModal('playerModal')">👥 Add Player</button>
                    <button class="btn" onclick="openModal('shopModal')">🛒 Add Product</button>
                    <button class="btn" onclick="adminSystem.currentEditIndex = null; openModal('sponsorModal')">🤝 Add Sponsor</button>
                    <button class="btn" onclick="openContactModal()">👥 Add Contact</button>
                    <button class="btn" onclick="openVPModal()">🧱 Add VP</button>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card" onclick="showSection('news')">
                    <span class="card-icon">📰</span>
                    <h3 class="card-title">Manage News</h3>
                    <p class="card-description">Add, edit, and delete news articles. Keep your supporters updated with the latest club news.</p>
                    <button class="btn">Manage News</button>
                </div>

                <div class="dashboard-card" onclick="showSection('fixtures')">
                    <span class="card-icon">🏉</span>
                    <h3 class="card-title">Manage Fixtures</h3>
                    <p class="card-description">Add results and upcoming matches. Track scores and league standings.</p>
                    <button class="btn">Manage Fixtures</button>
                </div>

                <div class="dashboard-card" onclick="showSection('gallery')">
                    <span class="card-icon">📸</span>
                    <h3 class="card-title">Photo Gallery</h3>
                    <p class="card-description">Upload and organize team photos. Share memorable moments with your community.</p>
                    <button class="btn">Manage Gallery</button>
                </div>

                <div class="dashboard-card" onclick="showSection('players')">
                    <span class="card-icon">👥</span>
                    <h3 class="card-title">Manage Players</h3>
                    <p class="card-description">Update player profiles and photos. Maintain accurate team rosters.</p>
                    <button class="btn">Manage Players</button>
                </div>

                <div class="dashboard-card" onclick="showSection('teams')">
                    <span class="card-icon">🏉</span>
                    <h3 class="card-title">Team Management</h3>
                    <p class="card-description">Manage your club's teams. Add seniors, juniors, ladies, youth teams and more.</p>
                    <button class="btn">Manage Teams</button>
                </div>
                
                <div class="dashboard-card" onclick="showSection('shop')">
                    <span class="card-icon">🛒</span>
                    <h3 class="card-title">Shop Management</h3>
                    <p class="card-description">Manage products, prices, and inventory. Upload product images and descriptions.</p>
                    <button class="btn">Manage Shop</button>
                </div>

                <div class="dashboard-card" onclick="showSection('sponsors')">
                    <span class="card-icon">🤝</span>
                    <h3 class="card-title">Sponsor Management</h3>
                    <p class="card-description">Manage club sponsors, upload logos, and control banner display. Build valuable partnerships.</p>
                    <button class="btn">Manage Sponsors</button>
                </div>

                <div class="dashboard-card" onclick="showSection('contacts')">
                    <span class="card-icon">📞</span>
                    <h3 class="card-title">Club Contacts</h3>
                    <p class="card-description">Manage committee contacts and club officials. Display contact details for your supporters.</p>
                    <button class="btn">Manage Contacts</button>
                </div>

                <div class="dashboard-card" onclick="showSection('admin-management')">
                    <span class="card-icon">👥</span>
                    <h3 class="card-title">Admin Management</h3>
                    <p class="card-description">Manage admin users, roles, and permissions. Control who can access the dashboard.</p>
                    <button class="btn">Manage Admins</button>
                </div>

                <div class="dashboard-card" onclick="showSection('vp-wall')">
                    <span class="card-icon">🧱</span>
                    <h3 class="card-title">VP Wall</h3>
                    <p class="card-description">Manage Vice Presidents who have served the club. Add names to the honorary brick wall.</p>
                    <button class="btn">Manage VPs</button>
                </div>

                <div class="dashboard-card" onclick="showSection('activity-log')">
                    <span class="card-icon">📊</span>
                    <h3 class="card-title">Activity Log</h3>
                    <p class="card-description">Complete audit trail of all admin actions. Track who changed what and when.</p>
                    <button class="btn">View Activity</button>
                </div>

            </div>

            <!-- Website Feature Controls -->
            <div class="admin-section active" style="display: block;">
                <div class="section-header">
                    <h2>🎛️ Website Feature Controls</h2>
                    <p style="margin: 0; color: var(--text-light);">Toggle website features on/off for public users. Changes take effect immediately.</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div style="background: rgba(var(--primary-green-rgb), 0.1); padding: 1.5rem; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border: 2px solid var(--primary-green);">
                        <div>
                            <strong>Club Shop</strong>
                            <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">E-commerce functionality</p>
                        </div>
                        <div class="toggle-switch" data-feature="shop" onclick="toggleWebsiteFeature('shop')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(var(--primary-green-rgb), 0.1); padding: 1.5rem; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border: 2px solid var(--primary-green);">
                        <div>
                            <strong>Events Calendar</strong>
                            <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">Club events and bookings</p>
                        </div>
                        <div class="toggle-switch" data-feature="events" onclick="toggleWebsiteFeature('events')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(var(--primary-green-rgb), 0.1); padding: 1.5rem; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border: 2px solid var(--primary-green);">
                        <div>
                            <strong>Member Portal</strong>
                            <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">Member-only section</p>
                        </div>
                        <div class="toggle-switch" data-feature="members" onclick="toggleWebsiteFeature('members')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(var(--primary-green-rgb), 0.1); padding: 1.5rem; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border: 2px solid var(--primary-green);">
                        <div>
                            <strong>Online Payments</strong>
                            <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">Membership fees & match payments</p>
                        </div>
                        <div class="toggle-switch" data-feature="payments" onclick="toggleWebsiteFeature('payments')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(244, 196, 48, 0.1); padding: 1.5rem; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border: 2px solid var(--accent-gold);">
                        <div>
                            <strong>Sponsor Banner</strong>
                            <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">Toggle on/off Sponsors Banner</p>
                        </div>
                        <div class="toggle-switch" data-feature="sponsors" onclick="toggleWebsiteFeature('sponsors')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="data-management">
    <h3>💾 Data Management</h3>
    <div class="action-buttons">
        <button class="btn btn-secondary" onclick="exportData()">📤 Export JSON</button>
        <button class="btn btn-secondary" onclick="exportToCSV()">📊 Export CSV</button>
        <button class="btn btn-secondary" onclick="importData()">📥 Import JSON</button>
        <button class="btn btn-secondary" onclick="importFromCSV()">📋 Import CSV</button>
        <button class="btn btn-primary" onclick="migrateToCloud()">🚀 Migrate to Cloud</button>
        <button class="btn btn-danger" onclick="clearAllData()">🗑️ Clear All Data</button>
    </div>
    <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
        💡 <strong>Tip:</strong> Use CSV export for bulk editing in Excel, JSON for full system backups.
    </p>
</div>
        </div>

        <!-- ================================================ -->
        <!-- SITE CUSTOMIZATION SECTION -->
        <!-- ================================================ -->
        <div id="site-customization" class="admin-section">
            <div class="section-header-bar">
                <h2>🎨 Site Appearance</h2>
            </div>

            <!-- Quick Actions -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <button class="btn btn-secondary" onclick="showCustomizationTab('club-identity')">
                    🎯 Club Identity
                </button>
                <button class="btn btn-secondary" onclick="showCustomizationTab('brand-colors')">
                    🎨 Brand Colors
                </button>
                <button class="btn btn-secondary" onclick="showCustomizationTab('navigation')">
                    📌 Navigation Menu
                </button>
                <button class="btn btn-secondary" onclick="showCustomizationTab('footer-contact')">
                    📍 Footer & Contact
                </button>
                <button class="btn btn-secondary" onclick="showCustomizationTab('advanced-settings')">
                    ⚙️ Advanced Settings
                </button>
            </div>

            <!-- Customization Tabs -->
            
            <!-- Tab 1: Club Identity -->
            <div id="club-identity-tab" class="customization-tab active" style="display: block;">
                <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: var(--shadow);">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary-green); display: flex; align-items: center; gap: 0.5rem;">
                        <span>🎯</span> Club Identity
                    </h3>
                    
                    <div style="display: grid; gap: 1.5rem;">
                        <!-- Club Name -->
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--text-dark);">
                                Club Name
                            </label>
                            <input type="text" id="setting-club-name" 
                                   placeholder="Old Laurentian RFC" 
                                   value="Old Laurentian RFC"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">
                                Appears in header and page titles
                            </small>
                        </div>

                        <!-- Club Tagline -->
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--text-dark);">
                                Club Tagline
                            </label>
                            <input type="text" id="setting-club-tagline" 
                                   placeholder="Est. 1919" 
                                   value="Est. 1919"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">
                                Appears below club name in header
                            </small>
                        </div>

                        <!-- Logo Upload -->
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--text-dark);">
                                Club Logo
                            </label>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <div id="logo-preview-container" style="width: 100px; height: 100px; border: 2px solid #e0e0e0; border-radius: 10px; overflow: hidden; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #999; font-size: 0.75rem; text-align: center; padding: 0.5rem;">
                                    <img id="logo-preview" src="" alt="Logo Preview" style="width: 100%; height: 100%; object-fit: contain; display: none;">
                                    <span id="logo-preview-placeholder" style="display: block;">📷<br>No logo yet</span>
                                </div>
                                <div style="flex: 1;">
                                    <button class="btn btn-secondary" onclick="uploadLogo()">
                                        📤 Upload New Logo
                                    </button>
                                    <div style="margin-top: 0.5rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" id="remove-logo-background" style="cursor: pointer;">
                                            <span style="color: var(--text-light); font-size: 0.9rem;">Remove background automatically</span>
                                        </label>
                                    </div>
                                    <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                                        Recommended: Square image, at least 500x500px, PNG or JPG
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Save Button for Club Identity -->
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #f0f0f0; text-align: center;">
                        <button class="btn btn-primary" onclick="saveClubIdentity()" style="font-size: 1.1rem; padding: 1rem 3rem;">
                            💾 Save Club Identity
                        </button>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                            Saves club name, tagline, and logo
                        </p>
                    </div>
                    
                    <!-- Status Message -->
                    <div id="club-identity-status" style="display: none; margin-top: 1rem;"></div>
                </div>
            </div>

            <!-- Tab 2: Navigation Menu -->
            <div id="navigation-tab" class="customization-tab" style="display: none;">
                <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: var(--shadow);">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary-green); display: flex; align-items: center; gap: 0.5rem;">
                        <span>📌</span> Navigation Menu
                    </h3>
                    
                    <!-- Live Preview -->
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 10px; margin-bottom: 2rem; border: 2px dashed #ddd;">
                        <div style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 0.5rem;">Preview:</div>
                        <div id="header-preview" style="background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon)); color: white; padding: 1rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    🏉
                                </div>
                                <div>
                                    <div style="font-weight: bold; font-size: 1rem;">Old Laurentian RFC</div>
                                    <div style="font-size: 0.75rem; opacity: 0.9;">Est. 1919</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; font-size: 0.85rem;">
                                <span>Home</span>
                                <span>News</span>
                                <span>Fixtures</span>
                                <span>Gallery</span>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Management -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--text-dark);">Navigation Menu Items</h4>
                        <p style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 1rem;">
                            Control which pages appear in your site's navigation menu. Core pages (News, Fixtures, Events, Sponsors, Gallery, About) are always visible.
                        </p>
                        
                        <!-- Core Pages (Always Visible) -->
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-dark); margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                Core Pages (Always Visible)
                            </div>
                            <div style="display: grid; gap: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-light); font-size: 0.9rem;">
                                    <span>✓</span>
                                    <span>News</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-light); font-size: 0.9rem;">
                                    <span>✓</span>
                                    <span>Fixtures</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-light); font-size: 0.9rem;">
                                    <span>✓</span>
                                    <span>Events</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-light); font-size: 0.9rem;">
                                    <span>✓</span>
                                    <span>Sponsors</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-light); font-size: 0.9rem;">
                                    <span>✓</span>
                                    <span>Gallery</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-light); font-size: 0.9rem;">
                                    <span>✓</span>
                                    <span>About</span>
                                </div>
                            </div>
                        </div>

                        <!-- Optional Pages (Toggle On/Off) -->
                        <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1rem;">
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-dark); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                Optional Pages (Toggle On/Off)
                            </div>
                            <div id="nav-items-list" style="display: grid; gap: 1rem;">
                                <!-- Home -->
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 6px;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.25rem;">🏠 Home</div>
                                        <div style="font-size: 0.85rem; color: var(--text-light);">Show/hide homepage link</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="nav-toggle-home" checked onchange="handleNavigationToggle('home', this)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>

                                <!-- Players -->
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 6px;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.25rem;">👥 Players</div>
                                        <div style="font-size: 0.85rem; color: var(--text-light);">Show/hide players page</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="nav-toggle-players" checked onchange="handleNavigationToggle('players', this)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>

                                <!-- Shop -->
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 6px;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.25rem;">🛍️ Shop</div>
                                        <div style="font-size: 0.85rem; color: var(--text-light);">Show/hide merchandise shop page</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="nav-toggle-shop" checked onchange="handleNavigationToggle('shop', this)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>

                                <!-- Policies -->
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 6px;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.25rem;">📋 Policies</div>
                                        <div style="font-size: 0.85rem; color: var(--text-light);">Show/hide policies & documents page</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="nav-toggle-policies" checked onchange="handleNavigationToggle('policies', this)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>

                                <!-- Contact -->
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 6px;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.25rem;">📞 Contact</div>
                                        <div style="font-size: 0.85rem; color: var(--text-light);">Show/hide contact page</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="nav-toggle-contact" checked onchange="handleNavigationToggle('contact', this)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>

                                <!-- VP Wall (OLS 114) -->
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 6px;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.25rem;">🧱 VP Wall</div>
                                        <div style="font-size: 0.85rem; color: var(--text-light);">Show/hide Vice Presidents wall page</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="nav-toggle-vp-wall" checked onchange="handleNavigationToggle('vp-wall', this)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button class="btn btn-secondary" onclick="resetNavigationToDefaults()">
                                🔄 Reset to Default (All Enabled)
                            </button>
                        </div>

                        <!-- Status Message -->
                        <div id="nav-save-status" style="margin-top: 1rem; padding: 0.75rem; border-radius: 8px; display: none;"></div>
                        
                        <!-- Auto-save Note -->
                        <div style="margin-top: 0.5rem; padding: 0.75rem; background: #e3f2fd; border-radius: 8px; color: #1976d2; font-size: 0.85rem;">
                            ℹ️ <strong>Auto-save enabled:</strong> Changes save automatically when you toggle each switch
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Footer & Contact -->
            <div id="footer-contact-tab" class="customization-tab" style="display: none;">
                <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: var(--shadow);">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary-green); display: flex; align-items: center; gap: 0.5rem;">
                        <span>📍</span> Footer & Contact Information
                    </h3>
                    
                    <div style="display: grid; gap: 1.5rem;">
                        <!-- Contact Information -->
                        <div>
                            <h4 style="margin-bottom: 1rem; color: var(--text-dark);">Contact Information</h4>
                            <div style="display: grid; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Address</label>
                                    <textarea id="setting-contact-address" 
                                              placeholder="Fenley Field, Lime Tree Avenue&#10;Rugby, Warwickshire, CV22 7QT"
                                              rows="3"
                                              style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; font-family: inherit; resize: vertical;">Fenley Field, Lime Tree Avenue
Rugby, Warwickshire, CV22 7QT</textarea>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Email</label>
                                    <input type="email" id="setting-contact-email" 
                                           placeholder="info@olsrugby.com" 
                                           value="info@olsrugby.com"
                                           style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Phone (Optional)</label>
                                    <input type="tel" id="setting-contact-phone" 
                                           placeholder="01234 567890"
                                           style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;">
                                </div>
                            </div>
                        </div>

                        <!-- Social Media Links -->
                        <div>
                            <h4 style="margin-bottom: 1rem; color: var(--text-dark);">Social Media Links</h4>
                            <div style="display: grid; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                        <span style="color: #1877f2;">📘</span> Facebook URL
                                    </label>
                                    <input type="url" id="setting-social-facebook" 
                                           placeholder="https://www.facebook.com/olsrugby" 
                                           value="https://www.facebook.com/olsrugby"
                                           style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                        <span style="color: #E1306C;">📷</span> Instagram URL
                                    </label>
                                    <input type="url" id="setting-social-instagram" 
                                           placeholder="https://www.instagram.com/olsrugby"
                                           style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                        <span style="color: #1DA1F2;">🐦</span> Twitter URL
                                    </label>
                                    <input type="url" id="setting-social-twitter" 
                                           placeholder="https://twitter.com/olsrugby"
                                           style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                        <span style="color: #FF0000;">📹</span> YouTube URL (Optional)
                                    </label>
                                    <input type="url" id="setting-social-youtube" 
                                           placeholder="https://www.youtube.com/@olsrugby"
                                           style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;">
                                </div>
                            </div>
                        </div>

                        <!-- Copyright Text -->
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Copyright Text</label>
                            <input type="text" id="setting-copyright" 
                                   placeholder="© 2025 Old Laurentian RFC. All rights reserved."
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;">
                        </div>
                    </div>
                    
                    <!-- Save Button for Footer & Contact -->
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #f0f0f0; text-align: center;">
                        <button class="btn btn-primary" onclick="saveFooterSettings()" style="font-size: 1.1rem; padding: 1rem 3rem;">
                            💾 Save Footer & Contact
                        </button>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                            Saves address, email, phone, social links, and copyright
                        </p>
                    </div>
                    
                    <!-- Status Message -->
                    <div id="footer-contact-status" style="display: none; margin-top: 1rem;"></div>
                </div>
            </div>

            <!-- Tab 4: Brand Colors -->
            <div id="brand-colors-tab" class="customization-tab" style="display: none;">
                <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: var(--shadow);">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary-green); display: flex; align-items: center; gap: 0.5rem;">
                        <span>🎨</span> Brand Colors
                    </h3>
                    
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Customize your club's brand colors. These colors will be used throughout the entire website.
                    </p>

                    <div style="display: grid; gap: 1.5rem;">
                        <!-- Primary Green -->
                        <div style="display: flex; gap: 1rem; align-items: center; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
                            <div>
                                <input type="color" id="color-primary-green" value="#2e5016" 
                                       style="width: 80px; height: 80px; border: 3px solid #ddd; border-radius: 10px; cursor: pointer;">
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 0.25rem;">Primary Colour</div>
                                <div style="color: var(--text-light); font-size: 0.9rem;">Main club color - used for headers, buttons, highlights</div>
                                <input type="text" id="color-primary-green-hex" value="#2e5016" readonly
                                       style="margin-top: 0.5rem; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; width: 120px; font-family: monospace;">
                            </div>
                        </div>

                        <!-- Primary Maroon -->
                        <div style="display: flex; gap: 1rem; align-items: center; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
                            <div>
                                <input type="color" id="color-primary-maroon" value="#8b1538" 
                                       style="width: 80px; height: 80px; border: 3px solid #ddd; border-radius: 10px; cursor: pointer;">
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 0.25rem;">Secondary Colour</div>
                                <div style="color: var(--text-light); font-size: 0.9rem;">Secondary club color - used for gradients, accents</div>
                                <input type="text" id="color-primary-maroon-hex" value="#8b1538" readonly
                                       style="margin-top: 0.5rem; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; width: 120px; font-family: monospace;">
                            </div>
                        </div>

                        <!-- Accent Gold -->
                        <div style="display: flex; gap: 1rem; align-items: center; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
                            <div>
                                <input type="color" id="color-accent-gold" value="#f4c430" 
                                       style="width: 80px; height: 80px; border: 3px solid #ddd; border-radius: 10px; cursor: pointer;">
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 0.25rem;">Accents Colour</div>
                                <div style="color: var(--text-light); font-size: 0.9rem;">Highlight color - used for CTAs, borders, important elements</div>
                                <input type="text" id="color-accent-gold-hex" value="#f4c430" readonly
                                       style="margin-top: 0.5rem; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; width: 120px; font-family: monospace;">
                            </div>
                        </div>

                        <!-- Reset to Defaults Button -->
                        <div>
                            <button class="btn btn-secondary" onclick="resetColorsToDefault()" style="width: 100%;">
                                🔄 Reset to OLS Default Colors
                            </button>
                        </div>
                    </div>
                    
                    <!-- OLS 129: Header Style Selector -->
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 3px solid #f0f0f0;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
                            🎨 Header Style
                        </h4>
                        <p style="color: var(--text-light); margin-bottom: 1.5rem; font-size: 0.95rem;">
                            Choose how your brand colors are displayed in the website header.
                        </p>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;" id="header-style-options">
                            <!-- Gradient Option -->
                            <label class="header-style-option" data-style="gradient" onclick="selectHeaderStyle('gradient')">
                                <input type="radio" name="header-style" value="gradient" style="display: none;">
                                <div class="header-style-preview" style="height: 60px; border-radius: 8px; background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon)); margin-bottom: 0.5rem;"></div>
                                <div style="font-weight: bold; text-align: center;">Gradient</div>
                                <div style="font-size: 0.8rem; color: var(--text-light); text-align: center;">Classic blend</div>
                            </label>
                            
                            <!-- Solid Option -->
                            <label class="header-style-option" data-style="solid" onclick="selectHeaderStyle('solid')">
                                <input type="radio" name="header-style" value="solid" style="display: none;">
                                <div class="header-style-preview" style="height: 60px; border-radius: 8px; background: var(--primary-green); margin-bottom: 0.5rem;"></div>
                                <div style="font-weight: bold; text-align: center;">Solid</div>
                                <div style="font-size: 0.8rem; color: var(--text-light); text-align: center;">Clean & minimal</div>
                            </label>
                            
                            <!-- Angular Option -->
                            <label class="header-style-option" data-style="angular" onclick="selectHeaderStyle('angular')">
                                <input type="radio" name="header-style" value="angular" style="display: none;">
                                <div class="header-style-preview" style="height: 60px; border-radius: 8px; background: linear-gradient(90deg, var(--primary-maroon) 0%, var(--primary-green) 50%, var(--primary-maroon) 100%); margin-bottom: 0.5rem; position: relative; overflow: hidden;">
                                    <div style="position: absolute; top: 0; left: 0; width: 30px; height: 100%; background: var(--primary-maroon); clip-path: polygon(0 0, 100% 0, 40% 100%, 0 100%);"></div>
                                    <div style="position: absolute; top: 0; right: 0; width: 30px; height: 100%; background: var(--primary-maroon); clip-path: polygon(60% 0, 100% 0, 100% 100%, 0 100%);"></div>
                                </div>
                                <div style="font-weight: bold; text-align: center;">Angular</div>
                                <div style="font-size: 0.8rem; color: var(--text-light); text-align: center;">Sporty & dynamic</div>
                            </label>
                        </div>
                        
                        <style>
                            .header-style-option {
                                cursor: pointer;
                                padding: 1rem;
                                border: 3px solid #e0e0e0;
                                border-radius: 12px;
                                transition: all 0.2s ease;
                                background: #f8f9fa;
                            }
                            .header-style-option:hover {
                                border-color: var(--primary-green);
                                transform: translateY(-2px);
                            }
                            .header-style-option.selected {
                                border-color: var(--primary-green);
                                background: rgba(var(--primary-green-rgb), 0.1);
                                box-shadow: 0 4px 12px rgba(var(--primary-green-rgb), 0.3);
                            }
                        </style>
                    </div>
                    <!-- END Header Style Selector -->
                    
                    <!-- Save Button for Brand Colors -->
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #f0f0f0; text-align: center;">
                        <button class="btn btn-primary" onclick="saveColorScheme()" style="font-size: 1.1rem; padding: 1rem 3rem;">
                            💾 Save Color Scheme
                        </button>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                            Saves primary, secondary, and accent colors
                        </p>
                    </div>
                    
                    <!-- Status Message -->
                    <div id="brand-colors-status" style="display: none; margin-top: 1rem;"></div>
                </div>
            </div>

            <!-- Tab 5: Advanced Settings -->
            <div id="advanced-settings-tab" class="customization-tab" style="display: none;">
                <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: var(--shadow);">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary-green); display: flex; align-items: center; gap: 0.5rem;">
                        <span>⚙️</span> Advanced Settings
                    </h3>
                    
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Customize the appearance of player cards on your Teams page. Upload a custom background image or use a color gradient.
                    </p>

                    <!-- Preview Section -->
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem; border: 2px dashed #ddd;">
                        <div style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 1rem;">Preview:</div>
                        <div style="width: 250px; margin: 0 auto;">
                            <div id="player-card-preview" style="background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon)); border-radius: 10px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                <div style="height: 250px; display: flex; align-items: center; justify-content: center; position: relative;">
                                    <div style="font-size: 4rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">👤</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.95); padding: 1.5rem; text-align: center;">
                                    <div style="font-size: 1.1rem; font-weight: bold; color: var(--text-dark); margin-bottom: 0.25rem;">Player Name</div>
                                    <div style="font-size: 0.9rem; color: var(--text-light);">Position</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; gap: 1.5rem;">
                        <!-- Background Image Upload -->
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--text-dark);">
                                Player Card Background Image
                            </label>
                            <div style="display: flex; gap: 1rem; align-items: start;">
                                <div id="player-card-bg-preview" style="width: 150px; height: 150px; border: 2px solid #e0e0e0; border-radius: 10px; overflow: hidden; background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon)); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.85rem; text-align: center; padding: 1rem;">
                                    No custom background<br>Using gradient
                                </div>
                                <div style="flex: 1;">
                                    <button class="btn btn-secondary" onclick="uploadPlayerCardBackground()" style="margin-bottom: 0.5rem;">
                                        📤 Upload Background Image
                                    </button>
                                    <button class="btn" onclick="removePlayerCardBackground()" style="margin-bottom: 0.5rem; background: #dc3545;">
                                        🗑️ Remove Background
                                    </button>
                                    <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                                        Recommended: 500x700px or similar portrait ratio<br>
                                        This image will appear behind all player photos on the Teams page
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Info Box -->
                        <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 1rem; border-radius: 5px;">
                            <div style="font-weight: bold; color: #1976d2; margin-bottom: 0.5rem;">💡 How Player Cards Work</div>
                            <div style="color: #1565c0; font-size: 0.9rem; line-height: 1.6;">
                                • Player photos automatically have backgrounds removed (blue/green screen)<br>
                                • The transparent player cutout sits on top of your background image<br>
                                • If no background image is uploaded, cards use your club's color gradient<br>
                                • All player cards use the same background for consistency
                            </div>
                        </div>
                    </div>

                    <!-- OLS 128: Default Match Report Images -->
                    <div style="margin-top: 3rem; padding-top: 2rem; border-top: 3px solid #f0f0f0;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
                            🖼️ Default Match Report Images
                        </h4>
                        <p style="color: var(--text-light); margin-bottom: 1.5rem; font-size: 0.95rem;">
                            These images are used for Match Report articles when no custom image is uploaded. The system automatically detects win/loss from the article title.
                        </p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <!-- Win Image -->
                            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; border: 2px solid #e0e0e0; text-align: center;">
                                <h5 style="color: var(--primary-green); margin-bottom: 0.75rem; font-size: 1.1rem;">🎉 Win Image</h5>
                                <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 1rem;">Shown for victories, triumphs, etc.</p>
                                
                                <div id="default-win-image-preview" style="width: 100%; height: 150px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; overflow: hidden; background: white;">
                                    <span style="color: var(--text-light); font-size: 0.9rem;">No image set<br><small>(shows gradient placeholder)</small></span>
                                </div>
                                
                                <input type="file" id="default-win-image-input" accept="image/*" style="display: none;" onchange="uploadDefaultMatchImage('win', this)">
                                <button onclick="document.getElementById('default-win-image-input').click()" class="btn btn-secondary" style="width: 100%; padding: 0.75rem;">
                                    📤 Upload Win Image
                                </button>
                            </div>
                            
                            <!-- Loss Image -->
                            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; border: 2px solid #e0e0e0; text-align: center;">
                                <h5 style="color: var(--primary-maroon); margin-bottom: 0.75rem; font-size: 1.1rem;">😔 Loss Image</h5>
                                <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 1rem;">Shown for defeats, losses, etc.</p>
                                
                                <div id="default-loss-image-preview" style="width: 100%; height: 150px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; overflow: hidden; background: white;">
                                    <span style="color: var(--text-light); font-size: 0.9rem;">No image set<br><small>(shows gradient placeholder)</small></span>
                                </div>
                                
                                <input type="file" id="default-loss-image-input" accept="image/*" style="display: none;" onchange="uploadDefaultMatchImage('loss', this)">
                                <button onclick="document.getElementById('default-loss-image-input').click()" class="btn btn-secondary" style="width: 100%; padding: 0.75rem;">
                                    📤 Upload Loss Image
                                </button>
                            </div>
                        </div>
                        
                        <!-- Info Box -->
                        <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 1rem; border-radius: 5px; margin-top: 1.5rem;">
                            <div style="font-weight: bold; color: #1976d2; margin-bottom: 0.5rem;">💡 How it works</div>
                            <div style="color: #1565c0; font-size: 0.9rem; line-height: 1.6;">
                                • Win image shown when title contains: "win", "victory", "triumph", "beat"<br>
                                • Loss image shown when title contains: "loss", "lost", "defeat"<br>
                                • If undetermined, loss image is used as the safer default<br>
                                • Without images uploaded, match reports show a gradient placeholder
                            </div>
                        </div>
                    </div>
                    <!-- END Default Match Report Images -->

                    <!-- API Configuration Section (OLS 108) -->
                    <div style="margin-top: 3rem; padding-top: 2rem; border-top: 3px solid #f0f0f0;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
                            🔌 API Configuration
                        </h4>
                        <p style="color: var(--text-light); margin-bottom: 1.5rem; font-size: 0.95rem;">
                            Configure external service integrations. These API keys are stored securely and only accessible to super-admins.
                            <strong>Set these once during initial site setup.</strong>
                        </p>

                        <div style="display: grid; gap: 2rem;">
                            
                            <!-- SendGrid Email Service -->
                            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; border: 2px solid #e0e0e0;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                                    <span style="font-size: 1.5rem;">📧</span>
                                    <div>
                                        <div style="font-weight: bold; color: var(--text-dark); font-size: 1.05rem;">SendGrid Email Service</div>
                                        <div style="color: var(--text-light); font-size: 0.85rem;">Required for enquiry form email notifications</div>
                                    </div>
                                </div>
                                
                                <div style="display: grid; gap: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark);">
                                            SendGrid API Key *
                                        </label>
                                        <input type="password" 
                                               id="api-sendgrid-key" 
                                               placeholder="SG.xxxxxxxxxxxxxxxxxxxxxxxx"
                                               style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; font-family: 'Courier New', monospace;">
                                        <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                                            Get your API key from <a href="https://app.sendgrid.com/settings/api_keys" target="_blank" style="color: var(--primary-green); text-decoration: underline;">SendGrid Dashboard</a>
                                        </small>
                                    </div>

                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark);">
                                            From Email Address *
                                        </label>
                                        <input type="email" 
                                               id="api-sendgrid-from-email" 
                                               placeholder="noreply@yourclub.com"
                                               style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;">
                                        <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                                            Must be a verified sender in your SendGrid account
                                        </small>
                                    </div>

                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark);">
                                            Notification Email Address *
                                        </label>
                                        <input type="email" 
                                               id="api-sendgrid-notify-email" 
                                               placeholder="admin@yourclub.com"
                                               style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;">
                                        <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                                            Where enquiry notifications will be sent
                                        </small>
                                    </div>
                                </div>

                                <!-- Setup Instructions -->
                                <details style="margin-top: 1rem; background: white; padding: 1rem; border-radius: 8px; border: 1px solid #ddd;">
                                    <summary style="cursor: pointer; font-weight: 600; color: var(--primary-green); user-select: none;">
                                        📖 Setup Instructions
                                    </summary>
                                    <div style="margin-top: 1rem; color: var(--text-dark); font-size: 0.9rem; line-height: 1.8;">
                                        <strong>Step 1:</strong> Create free SendGrid account at <a href="https://signup.sendgrid.com/" target="_blank" style="color: var(--primary-green);">signup.sendgrid.com</a><br>
                                        <strong>Step 2:</strong> Verify your sender email address<br>
                                        <strong>Step 3:</strong> Create API key with "Mail Send" permissions<br>
                                        <strong>Step 4:</strong> Copy API key and paste above<br>
                                        <strong>Step 5:</strong> Set your from/notification emails<br>
                                        <strong>Step 6:</strong> Click "Save Advanced Settings" below
                                    </div>
                                </details>

                                <!-- Status Indicator -->
                                <div id="sendgrid-status" style="margin-top: 1rem; padding: 0.75rem; border-radius: 8px; display: none;">
                                    <!-- Will show configured/not configured status -->
                                </div>
                            </div>

                            <!-- Future API Integrations Placeholder -->
                            <div style="background: #fff8e1; padding: 1.5rem; border-radius: 10px; border: 2px dashed #ffd54f;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                    <span style="font-size: 1.5rem;">🚀</span>
                                    <div style="font-weight: bold; color: #f57c00; font-size: 1.05rem;">Coming Soon</div>
                                </div>
                                <div style="color: #e65100; font-size: 0.9rem; line-height: 1.6;">
                                    Additional API integrations will be added here:<br>
                                    • ☁️ Cloudinary (Image hosting)<br>
                                    • 📅 Google Calendar (Event sync)<br>
                                    • 🖼️ Remove.bg (Background removal)<br>
                                    • 📱 Social Media (Auto-posting)
                                </div>
                            </div>

                        </div>
                    </div>
                    
                    <!-- Save Button for Advanced Settings -->
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #f0f0f0; text-align: center;">
                        <button class="btn btn-primary" onclick="saveAdvancedSettings()" style="font-size: 1.1rem; padding: 1rem 3rem;">
                            💾 Save Advanced Settings
                        </button>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                            Saves player card background image settings
                        </p>
                    </div>
                    
                    <!-- Status Message -->
                    <div id="advanced-settings-status" style="display: none; margin-top: 1rem;"></div>
                </div>
            </div>

            <!-- Alert/Success Message -->
            <div id="customizationAlert" style="display: none; margin-top: 1rem;"></div>
        </div>
        <!-- ================================================ -->
        <!-- END SITE CUSTOMIZATION SECTION -->
        <!-- ================================================ -->

        <!-- ================================================ -->
        <!-- CONTENT MANAGEMENT SECTION - OLS 76 -->
        <!-- ================================================ -->
        <div id="content-management" class="admin-section">
            <div class="section-header-bar">
                <h2>📝 Page Content</h2>
            </div>

            <!-- Homepage Accordion -->
            <details class="content-accordion" id="homepage-accordion" open style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 1rem;">
                <summary style="font-size: 1.3rem; font-weight: bold; color: var(--primary-green); cursor: pointer; padding: 0.5rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="accordion-icon" style="transition: transform 0.3s ease;">▼</span>
                    🏠 Homepage Content
                </summary>
                
                <div style="margin-top: 1.5rem; display: grid; gap: 2rem;">
                    
                    <!-- Hero Section -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.05), rgba(var(--primary-maroon-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            🦸 Hero Section
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Hero Heading</label>
                                <input type="text" id="homepage-hero-heading" 
                                       placeholder="Welcome to Old Laurentian RFC" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Main heading on homepage hero section</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Hero Tagline</label>
                                <input type="text" id="homepage-hero-tagline" 
                                       placeholder="Proudly representing tradition, excellence, and the spirit of rugby since our founding" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Subtitle/tagline below hero heading</small>
                            </div>
                            
                            <!-- Hero Background Image Upload -->
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Hero Background Image</label>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <div style="width: 200px; height: 100px; border: 2px solid #e0e0e0; border-radius: 10px; overflow: hidden; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                        <img id="hero-bg-preview" src="images/backgrounds/hero-banner.png" alt="Hero Background Preview" style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                    <div style="flex: 1;">
                                        <button class="btn btn-secondary" onclick="uploadHeroBackground()">
                                            📤 Upload Hero Background
                                        </button>
                                        <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                                            Recommended: Landscape image, at least 1920x1080px, JPG or PNG<br>
                                            This image appears behind your homepage hero text
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section Titles -->
                    <div style="padding: 1.5rem; background: rgba(0,0,0,0.02); border-radius: 10px;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📋 Section Titles
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Fixtures Section</label>
                                <input type="text" id="homepage-fixtures-title" 
                                       placeholder="Fixtures & Results" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Social Section</label>
                                <input type="text" id="homepage-social-title" 
                                       placeholder="Our Socials" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">News Section</label>
                                <input type="text" id="homepage-news-title" 
                                       placeholder="Latest News" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">League Section</label>
                                <input type="text" id="homepage-league-title" 
                                       placeholder="League Table" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Calendar Section</label>
                                <input type="text" id="homepage-calendar-title" 
                                       placeholder="📅 Club Calendar" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">About Section</label>
                                <input type="text" id="homepage-about-title" 
                                       placeholder="Welcome Back to Fenley Fields" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Find Us Section</label>
                                <input type="text" id="homepage-findus-title" 
                                       placeholder="📍 Find Us & Join Us" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Training Section</label>
                                <input type="text" id="homepage-training-title" 
                                       placeholder="Training Times" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                        </div>
                    </div>

                    <!-- About Section Content -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--accent-gold-rgb), 0.05), rgba(var(--primary-green-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📖 About Section
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">About Content</label>
                                <textarea id="homepage-about-content" 
                                          rows="10" 
                                          placeholder="Your club's story, values, and history..."
                                          style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; font-family: inherit; resize: vertical;"></textarea>
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Main content for the About section. Use line breaks to separate paragraphs.</small>
                            </div>
                            
                            <!-- Heritage/About Image Upload -->
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Heritage/About Image</label>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <div style="width: 200px; height: 150px; border: 2px solid #e0e0e0; border-radius: 10px; overflow: hidden; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                        <img id="heritage-img-preview" src="images/backgrounds/club-heritage.png" alt="Heritage Image Preview" style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                    <div style="flex: 1;">
                                        <button class="btn btn-secondary" onclick="uploadHeritageImage()">
                                            📤 Upload Heritage Image
                                        </button>
                                        <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                                            Recommended: Landscape or square image, at least 800x600px, JPG or PNG<br>
                                            This image appears in the About section showing your club's heritage
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Club Stats -->
                    <div style="padding: 1.5rem; background: rgba(0,0,0,0.02); border-radius: 10px;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📊 Club Stats
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                            <!-- Stat 1 -->
                            <div style="padding: 1rem; background: white; border-radius: 8px; border: 2px solid #f0f0f0;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--primary-green);">Stat 1</label>
                                <input type="text" id="homepage-stat1-number" 
                                       placeholder="450+" 
                                       style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 5px; margin-bottom: 0.5rem;">
                                <input type="text" id="homepage-stat1-label" 
                                       placeholder="Club Members" 
                                       style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 5px;">
                            </div>
                            <!-- Stat 2 -->
                            <div style="padding: 1rem; background: white; border-radius: 8px; border: 2px solid #f0f0f0;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--primary-maroon);">Stat 2</label>
                                <input type="text" id="homepage-stat2-number" 
                                       placeholder="100+" 
                                       style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 5px; margin-bottom: 0.5rem;">
                                <input type="text" id="homepage-stat2-label" 
                                       placeholder="Years of Heritage" 
                                       style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 5px;">
                            </div>
                            <!-- Stat 3 -->
                            <div style="padding: 1rem; background: white; border-radius: 8px; border: 2px solid #f0f0f0;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--accent-gold);">Stat 3</label>
                                <input type="text" id="homepage-stat3-number" 
                                       placeholder="3" 
                                       style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 5px; margin-bottom: 0.5rem;">
                                <input type="text" id="homepage-stat3-label" 
                                       placeholder="Wins This Season" 
                                       style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 5px;">
                            </div>
                            <!-- Stat 4 -->
                            <div style="padding: 1rem; background: white; border-radius: 8px; border: 2px solid #f0f0f0;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--primary-green);">Stat 4</label>
                                <input type="text" id="homepage-stat4-number" 
                                       placeholder="2" 
                                       style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 5px; margin-bottom: 0.5rem;">
                                <input type="text" id="homepage-stat4-label" 
                                       placeholder="Senior Teams" 
                                       style="width: 100%; padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 5px;">
                            </div>
                        </div>
                    </div>

                    <!-- External Links & Socials -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(24, 119, 242, 0.05), rgba(228, 64, 95, 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📱 External Links & Socials
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Instagram Profile URL</label>
                                <input type="url" id="homepage-instagram-url" 
                                       placeholder="https://www.instagram.com/yourusername/" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Just paste your Instagram profile URL - we'll handle the embed automatically</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Facebook Page URL</label>
                                <input type="url" id="homepage-facebook-url" 
                                       placeholder="https://www.facebook.com/yourpage" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Just paste your Facebook page URL - we'll handle the embed automatically</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">League Table URL</label>
                                <input type="url" id="homepage-league-url" 
                                       placeholder="https://www.englandrugby.com/fixtures-and-results/..." 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Fallback link if live table fails to load</small>
                            </div>
                        </div>
                    </div>

                    <!-- OLS 120: League Table Configuration - Multi-Team Support -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.08), rgba(var(--accent-gold-rgb), 0.05)); border-radius: 10px; border: 2px solid rgba(var(--primary-green-rgb), 0.2);">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            🏆 League Table Configuration
                            <span style="font-size: 0.75rem; background: var(--accent-gold); color: var(--primary-green); padding: 0.2rem 0.5rem; border-radius: 10px; font-weight: bold;">LIVE DATA</span>
                        </h4>
                        <p style="color: var(--text-light); margin-bottom: 1rem; font-size: 0.9rem;">
                            Configure league tables for each team. Tables are scraped live from England Rugby.
                        </p>
                        
                        <!-- League Tables List -->
                        <div id="league-tables-list" style="display: grid; gap: 0.75rem; margin-bottom: 1rem;">
                            <!-- Populated by JavaScript -->
                            <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                                Loading league tables...
                            </div>
                        </div>
                        
                        <!-- Add Button -->
                        <button onclick="openLeagueTableModal()" class="btn btn-secondary" style="width: 100%; padding: 0.75rem;">
                            ➕ Add League Table
                        </button>
                        
                        <!-- Help Text -->
                        <div style="margin-top: 1rem; padding: 1rem; background: rgba(var(--accent-gold-rgb), 0.1); border-radius: 8px;">
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-dark);">
                                <strong>💡 How to add a league table:</strong><br>
                                1. Go to <a href="https://www.englandrugby.com/fixtures-and-results" target="_blank" style="color: var(--primary-green);">englandrugby.com</a> and find your team's league table<br>
                                2. Copy the URL from your browser<br>
                                3. Paste it into the form - we'll extract the settings automatically!
                            </p>
                        </div>
                    </div>


                    <!-- Page Settings -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.05), rgba(var(--primary-maroon-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            ⚙️ Page Settings
                        </h4>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Title</label>
                            <input type="text" id="homepage-page-title" 
                                   placeholder="Old Laurentian RFC - Est. 1919" 
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                            <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Browser tab title for homepage</small>
                        </div>
                        <div style="margin-top: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Description (SEO)</label>
                            <input type="text" id="homepage-page-description" 
                                   placeholder="Official website of Old Laurentian RFC. News, fixtures, results, events and more from Rugby's friendliest club." 
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;"
                                   maxlength="160">
                            <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Meta description for search engines & social sharing (max 160 characters)</small>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div style="text-align: center; padding-top: 1rem; border-top: 2px solid #f0f0f0;">
                        <button id="save-homepage-btn" class="btn btn-primary" onclick="saveHomePageContent()" style="font-size: 1.1rem; padding: 1rem 3rem;">
                            💾 Save Homepage Content
                        </button>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                            Only changed fields will be saved
                        </p>
                    </div>

                </div>
            </details>

            <!-- Fixtures Page Accordion -->
            <details class="content-accordion" id="fixtures-accordion" style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 1rem;">
                <summary style="font-size: 1.3rem; font-weight: bold; color: var(--primary-green); cursor: pointer; padding: 0.5rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="accordion-icon" style="transition: transform 0.3s ease;">▼</span>
                    🏉 Fixtures Page Content
                </summary>
                
                <div style="margin-top: 1.5rem; display: grid; gap: 2rem;">
                    
                    <!-- Page Header -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.05), rgba(var(--primary-maroon-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📄 Page Header
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Title (Browser Tab)</label>
                                <input type="text" id="fixtures-page-title" 
                                       placeholder="Fixtures & Results - Old Laurentian RFC" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Browser tab title for fixtures page</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Main Heading</label>
                                <input type="text" id="fixtures-main-heading" 
                                       placeholder="Fixtures & Results" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Main page heading</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Description</label>
                                <input type="text" id="fixtures-page-description" 
                                       placeholder="Complete fixture list and results for all Old Laurentian RFC teams" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Subtitle below main heading</small>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Controls -->
                    <div style="padding: 1.5rem; background: rgba(0,0,0,0.02); border-radius: 10px;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            🔍 Filter Controls
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Filter Label</label>
                                <input type="text" id="fixtures-filter-label" 
                                       placeholder="Filter by Team:" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Label for team filter dropdown</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">"All Teams" Option Label</label>
                                <input type="text" id="fixtures-all-teams-label" 
                                       placeholder="All Teams" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">First option in team dropdown</small>
                            </div>
                        </div>
                    </div>

                    <!-- Section Titles -->
                    <div style="padding: 1.5rem; background: rgba(0,0,0,0.02); border-radius: 10px;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📋 Section Titles
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Results Section</label>
                                <input type="text" id="fixtures-results-title" 
                                       placeholder="Recent Results" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Upcoming Fixtures Section</label>
                                <input type="text" id="fixtures-upcoming-title" 
                                       placeholder="Upcoming Fixtures" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                        </div>
                    </div>

                    <!-- Summary Stats -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.05), rgba(var(--primary-maroon-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📊 Summary Stats Labels
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                            
                            <!-- Stat 1 -->
                            <div style="padding: 1rem; background: white; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <h5 style="color: var(--primary-green); margin-bottom: 0.5rem;">📈 Stat 1 (Games Played)</h5>
                                <div style="display: grid; gap: 0.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem; font-weight: bold;">Label</label>
                                        <input type="text" id="fixtures-summary1-label" 
                                               placeholder="Games Played" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #e0e0e0; border-radius: 5px; font-size: 0.9rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem; font-weight: bold;">Detail Text</label>
                                        <input type="text" id="fixtures-summary1-detail" 
                                               placeholder="This Season" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #e0e0e0; border-radius: 5px; font-size: 0.9rem;">
                                    </div>
                                </div>
                            </div>

                            <!-- Stat 2 -->
                            <div style="padding: 1rem; background: white; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <h5 style="color: var(--primary-green); margin-bottom: 0.5rem;">📈 Stat 2 (Wins)</h5>
                                <div style="display: grid; gap: 0.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem; font-weight: bold;">Label</label>
                                        <input type="text" id="fixtures-summary2-label" 
                                               placeholder="Wins" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #e0e0e0; border-radius: 5px; font-size: 0.9rem;">
                                    </div>
                                </div>
                            </div>

                            <!-- Stat 3 -->
                            <div style="padding: 1rem; background: white; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <h5 style="color: var(--primary-green); margin-bottom: 0.5rem;">📈 Stat 3 (Upcoming)</h5>
                                <div style="display: grid; gap: 0.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem; font-weight: bold;">Label</label>
                                        <input type="text" id="fixtures-summary3-label" 
                                               placeholder="Upcoming" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #e0e0e0; border-radius: 5px; font-size: 0.9rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem; font-weight: bold;">Detail Text</label>
                                        <input type="text" id="fixtures-summary3-detail" 
                                               placeholder="Next 30 days" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #e0e0e0; border-radius: 5px; font-size: 0.9rem;">
                                    </div>
                                </div>
                            </div>

                            <!-- Stat 4 -->
                            <div style="padding: 1rem; background: white; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <h5 style="color: var(--primary-green); margin-bottom: 0.5rem;">📈 Stat 4 (Points)</h5>
                                <div style="display: grid; gap: 0.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem; font-weight: bold;">Label</label>
                                        <input type="text" id="fixtures-summary4-label" 
                                               placeholder="Points Scored" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #e0e0e0; border-radius: 5px; font-size: 0.9rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem; font-weight: bold;">Detail Text</label>
                                        <input type="text" id="fixtures-summary4-detail" 
                                               placeholder="All competitions" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #e0e0e0; border-radius: 5px; font-size: 0.9rem;">
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Save Button -->
                    <div style="text-align: center; padding-top: 1rem; border-top: 2px solid #f0f0f0;">
                        <button id="save-fixtures-btn" class="btn btn-primary" onclick="saveFixturesPageContent()" style="font-size: 1.1rem; padding: 1rem 3rem;">
                            💾 Save Fixtures Page Content
                        </button>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                            Only changed fields will be saved
                        </p>
                    </div>

                </div>
            </details>

            <!-- News Page Accordion -->
            <details class="content-accordion" id="news-accordion" style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 1rem;">
                <summary style="font-size: 1.3rem; font-weight: bold; color: var(--primary-green); cursor: pointer; padding: 0.5rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="accordion-icon" style="transition: transform 0.3s ease;">▼</span>
                    📰 News Page Content
                </summary>
                
                <div style="margin-top: 1.5rem; display: grid; gap: 2rem;">
                    
                    <!-- Page Header -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.05), rgba(var(--primary-maroon-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📄 Page Header
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Title (Browser Tab)</label>
                                <input type="text" id="news-page-title" 
                                       placeholder="News Archive - Old Laurentian RFC" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Browser tab title for news page</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Main Heading</label>
                                <input type="text" id="news-main-heading" 
                                       placeholder="📰 News Archive" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Main page heading (emoji included)</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Description</label>
                                <input type="text" id="news-page-description" 
                                       placeholder="Stay updated with all the latest news, match reports, and club updates" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Subtitle below main heading</small>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Buttons -->
                    <div style="padding: 1.5rem; background: rgba(0,0,0,0.02); border-radius: 10px;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            🔍 Filter Button Labels
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">All News Button</label>
                                <input type="text" id="news-filter-all" 
                                       placeholder="All News" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Default/all categories filter</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Senior Teams Button</label>
                                <input type="text" id="news-filter-seniors" 
                                       placeholder="Senior Teams" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Ladies Team Button</label>
                                <input type="text" id="news-filter-ladies" 
                                       placeholder="Phoenix Ladies" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Your ladies/womens team name</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Youth Teams Button</label>
                                <input type="text" id="news-filter-youth" 
                                       placeholder="Minis & Juniors" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Club News Button</label>
                                <input type="text" id="news-filter-club" 
                                       placeholder="Club News" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Social Events Button</label>
                                <input type="text" id="news-filter-social" 
                                       placeholder="Social Events" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                        </div>
                    </div>

                    <!-- UI Elements -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--accent-gold-rgb), 0.05), rgba(var(--primary-green-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            🔘 UI Elements
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Load More Button</label>
                                <input type="text" id="news-loadmore-text" 
                                       placeholder="Load More Articles" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Button text for loading more articles</small>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div style="text-align: center; padding-top: 1rem; border-top: 2px solid #f0f0f0;">
                        <button id="save-news-btn" class="btn btn-primary" onclick="saveNewsPageContent()" style="font-size: 1.1rem; padding: 1rem 3rem;">
                            💾 Save News Page Content
                        </button>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                            Only changed fields will be saved
                        </p>
                    </div>

                </div>
            </details>

            <!-- Events Page Accordion -->
            <details class="content-accordion" id="events-accordion" style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 1rem;">
                <summary style="font-size: 1.3rem; font-weight: bold; color: var(--primary-green); cursor: pointer; padding: 0.5rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="accordion-icon" style="transition: transform 0.3s ease;">▼</span>
                    📅 Events Page Content
                </summary>
                
                <div style="margin-top: 1.5rem; display: grid; gap: 2rem;">
                    
                    <!-- Page Header -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.05), rgba(var(--primary-maroon-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📄 Page Header
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Title (Browser Tab)</label>
                                <input type="text" id="events-page-title" 
                                       placeholder="Events Calendar - Old Laurentian RFC" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Browser tab title for events page</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Main Heading</label>
                                <input type="text" id="events-main-heading" 
                                       placeholder="🏉 Events Calendar" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Main page heading (emoji included)</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Description</label>
                                <input type="text" id="events-page-description" 
                                       placeholder="All fixtures, training sessions, and social events in one place" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Subtitle below main heading</small>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Section -->
                    <div style="padding: 1.5rem; background: rgba(0,0,0,0.02); border-radius: 10px;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            🔍 Filter Controls
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Filter Section Title</label>
                                <input type="text" id="events-filter-title" 
                                       placeholder="Filter Events" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Title above filter buttons</small>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">All Events Button</label>
                                <input type="text" id="events-filter-all" 
                                       placeholder="All Events" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Senior Button</label>
                                <input type="text" id="events-filter-senior" 
                                       placeholder="Senior" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Junior Button</label>
                                <input type="text" id="events-filter-junior" 
                                       placeholder="Junior" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Colts Button</label>
                                <input type="text" id="events-filter-colts" 
                                       placeholder="Colts" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Social Button</label>
                                <input type="text" id="events-filter-social" 
                                       placeholder="Social" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                        </div>
                    </div>

                    <!-- Events List Section -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--accent-gold-rgb), 0.05), rgba(var(--primary-green-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📋 Events List Section
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Events List Title</label>
                                <input type="text" id="events-list-title" 
                                       placeholder="Upcoming Events" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Title for the events list section</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Loading Message</label>
                                <input type="text" id="events-loading-message" 
                                       placeholder="Loading events..." 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Message shown while loading</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Empty State Title</label>
                                <input type="text" id="events-empty-title" 
                                       placeholder="No Events Found" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Title when no events match filter</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Empty State Message</label>
                                <input type="text" id="events-empty-message" 
                                       placeholder="There are no events matching your filter criteria." 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Message when no events match filter</small>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div style="text-align: center; padding-top: 1rem; border-top: 2px solid #f0f0f0;">
                        <button id="save-events-btn" class="btn btn-primary" onclick="saveEventsPageContent()" style="font-size: 1.1rem; padding: 1rem 3rem;">
                            💾 Save Events Page Content
                        </button>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                            Only changed fields will be saved
                        </p>
                    </div>

                </div>
            </details>

            <!-- Calendar Configuration Accordion - OLS 124 -->
            <details class="content-accordion" id="calendar-config-accordion" style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 1rem;">
                <summary style="font-size: 1.3rem; font-weight: bold; color: var(--primary-green); cursor: pointer; padding: 0.5rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="accordion-icon" style="transition: transform 0.3s ease;">▼</span>
                    📅 Calendar Configuration
                </summary>
                
                <div style="margin-top: 1.5rem; display: grid; gap: 2rem;">
                    
                    <!-- Section 1: Fixture Colour Coding Info -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.05), rgba(var(--primary-maroon-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            🎨 Fixture Colour Coding
                        </h4>
                        <p style="color: var(--text-light); font-size: 0.9rem;">
                            Fixture colours on the website calendar are driven by <strong>Club Sections</strong>. Each club section has a calendar colour — fixtures from teams in that section are displayed in that colour. Manage sections and their colours in the <a href="#" onclick="showSection('club-sections'); return false;" style="color: var(--primary-green); font-weight: bold;">Club Sections</a> page.
                        </p>
                    </div>
                    
                    <!-- Section 2: Team → Filter Assignment -->
                    <!-- Section 2: Additional Calendars -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--accent-gold-rgb), 0.05), rgba(var(--primary-green-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            📆 Additional Calendars
                        </h4>
                        <p style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 1rem;">
                            Add extra Google Calendar sources (e.g., Social Events, TV Fixtures). These appear as separate filter options.
                        </p>
                        
                        <!-- Additional Calendars Container -->
                        <div id="additional-calendars-container" style="display: grid; gap: 1rem; margin-bottom: 1rem;">
                            <!-- Additional calendars will be populated by JavaScript -->
                        </div>
                        
                        <!-- Add New Calendar Button -->
                        <button type="button" onclick="addAdditionalCalendar()" 
                                style="padding: 0.75rem 1.5rem; background: var(--accent-gold); color: var(--text-dark); border: none; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 0.5rem;">
                            ➕ Add Calendar Source
                        </button>
                    </div>
                    
                    <!-- Section 3: Fixtures Calendar ID -->
                    <div style="padding: 1.5rem; background: rgba(0,0,0,0.02); border-radius: 10px;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            🔗 Fixtures Calendar (Google)
                        </h4>
                        <p style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 1rem;">
                            The main calendar where all fixtures are synced. Admin-managed, view-only for others.
                        </p>
                        
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Google Calendar ID</label>
                            <input type="text" id="calendar-fixtures-id" 
                                   placeholder="your-calendar-id@group.calendar.google.com" 
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-family: monospace; font-size: 0.9rem;">
                            <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">
                                Find this in Google Calendar → Settings → Calendar ID
                            </small>
                        </div>
                    </div>
                    
                    <!-- Info about Team Assignments -->
                    <div style="padding: 1rem; background: rgba(var(--primary-green-rgb), 0.1); border-radius: 10px; border-left: 4px solid var(--primary-green);">
                        <p style="margin: 0; color: var(--text-dark); font-size: 0.95rem;">
                            💡 <strong>Team → Section assignments</strong> are set on each team in the
                            <a href="#" onclick="showSection('teams'); return false;" style="color: var(--primary-green); font-weight: bold;">Teams section</a>.
                            Edit a team to change its Club Section.
                        </p>
                    </div>

                    <!-- Save Button -->
                    <div style="text-align: center; padding-top: 1rem; border-top: 2px solid #f0f0f0;">
                        <button id="save-calendar-config-btn" class="btn btn-primary" onclick="saveCalendarConfiguration()" style="font-size: 1.1rem; padding: 1rem 3rem;">
                            💾 Save Calendar Configuration
                        </button>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                            Changes affect both homepage and events page calendars
                        </p>
                    </div>

                </div>
            </details>

            <!-- Gallery Page Accordion -->
            <details class="content-accordion" id="gallery-accordion" style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 1rem;">
                <summary style="font-size: 1.3rem; font-weight: bold; color: var(--primary-green); cursor: pointer; padding: 0.5rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="accordion-icon" style="transition: transform 0.3s ease;">▼</span>
                    📸 Gallery Page Content
                </summary>
                
                <div style="margin-top: 1.5rem; display: grid; gap: 2rem;">
                    
                    <!-- Page Header -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.05), rgba(var(--primary-maroon-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📄 Page Header
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Title (Browser Tab)</label>
                                <input type="text" id="gallery-page-title" 
                                       placeholder="Photo Gallery - Old Laurentian RFC" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Browser tab title for gallery page</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Main Heading</label>
                                <input type="text" id="gallery-main-heading" 
                                       placeholder="📸 Photo Gallery" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Main page heading (emoji included)</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Description</label>
                                <input type="text" id="gallery-page-description" 
                                       placeholder="Relive the best moments from Old Laurentian RFC" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Subtitle below main heading</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Loading Message</label>
                                <input type="text" id="gallery-loading-message" 
                                       placeholder="Loading albums..." 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Message shown while loading albums</small>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Labels -->
                    <div style="padding: 1.5rem; background: rgba(0,0,0,0.02); border-radius: 10px;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            🔍 Filter Labels
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Team Filter Label</label>
                                <input type="text" id="gallery-team-filter-label" 
                                       placeholder="🏉 Filter by Team:" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Season Filter Label</label>
                                <input type="text" id="gallery-season-filter-label" 
                                       placeholder="📅 Filter by Season:" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Sort Label</label>
                                <input type="text" id="gallery-sort-label" 
                                       placeholder="📆 Sort by Date:" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                        </div>
                    </div>

                    <!-- Team Filter Options -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--accent-gold-rgb), 0.05), rgba(var(--primary-green-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            🏉 Team Filter Options
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">All Teams</label>
                                <input type="text" id="gallery-team-all" 
                                       placeholder="All Teams" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Men's 1st XV</label>
                                <input type="text" id="gallery-team-mens1st" 
                                       placeholder="Men's 1st XV" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Men's 2nd XV</label>
                                <input type="text" id="gallery-team-mens2nd" 
                                       placeholder="Men's 2nd XV" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Ladies Team</label>
                                <input type="text" id="gallery-team-ladies" 
                                       placeholder="Phoenix Ladies" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Your ladies/womens team name</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Colts</label>
                                <input type="text" id="gallery-team-colts" 
                                       placeholder="Colts" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Other</label>
                                <input type="text" id="gallery-team-other" 
                                       placeholder="Other" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                        </div>
                    </div>

                    <!-- Other Filter Options -->
                    <div style="padding: 1.5rem; background: rgba(0,0,0,0.02); border-radius: 10px;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📅 Other Filter Options
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">All Seasons</label>
                                <input type="text" id="gallery-season-all" 
                                       placeholder="All Seasons" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Newest First</label>
                                <input type="text" id="gallery-sort-newest" 
                                       placeholder="Newest First" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Oldest First</label>
                                <input type="text" id="gallery-sort-oldest" 
                                       placeholder="Oldest First" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.05), rgba(var(--primary-maroon-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📷 Empty State
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Empty State Title</label>
                                <input type="text" id="gallery-empty-title" 
                                       placeholder="No Albums Yet" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Empty State Message</label>
                                <input type="text" id="gallery-empty-message" 
                                       placeholder="Check back soon for photos from matches, training, and club events!" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                        </div>
                    </div>

                    <!-- Photographer Credit -->
                    <div style="padding: 1.5rem; background: rgba(0,0,0,0.02); border-radius: 10px;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📸 Photographer Credit
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Credit Section Title</label>
                                <input type="text" id="gallery-credit-title" 
                                       placeholder="Photography Credit" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Photographer Name</label>
                                <input type="text" id="gallery-photographer-name" 
                                       placeholder="Chris Reading" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Your club photographer's name</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Credit Message</label>
                                <textarea id="gallery-credit-message" 
                                          rows="2"
                                          placeholder="All photos captured by our dedicated club photographer. Thank you for capturing these memorable moments!"
                                          style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; font-family: inherit; resize: vertical;"></textarea>
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Thank you message for your photographer</small>
                            </div>
                        </div>
                        <div style="display: grid; gap: 1rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #f0f0f0;">
                            <h5 style="color: var(--primary-green); margin-bottom: 0.5rem;">Social Media Links</h5>
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Instagram URL</label>
                                    <input type="url" id="gallery-photographer-instagram-url" 
                                           placeholder="https://www.instagram.com/username" 
                                           style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Instagram Label</label>
                                    <input type="text" id="gallery-photographer-instagram-label" 
                                           placeholder="📷 Instagram" 
                                           style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Facebook URL</label>
                                    <input type="url" id="gallery-photographer-facebook-url" 
                                           placeholder="https://www.facebook.com/username" 
                                           style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Facebook Label</label>
                                    <input type="text" id="gallery-photographer-facebook-label" 
                                           placeholder="👤 Facebook" 
                                           style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Email Address</label>
                                    <input type="email" id="gallery-photographer-email" 
                                           placeholder="photographer@email.com" 
                                           style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Email Label</label>
                                    <input type="text" id="gallery-photographer-email-label" 
                                           placeholder="📧 Email" 
                                           style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                </div>
                            </div>
                            <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Leave URL fields empty to hide that social link on the page</small>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div style="text-align: center; padding-top: 1rem; border-top: 2px solid #f0f0f0;">
                        <button id="save-gallery-btn" class="btn btn-primary" onclick="saveGalleryPageContent()" style="font-size: 1.1rem; padding: 1rem 3rem;">
                            💾 Save Gallery Page Content
                        </button>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                            Only changed fields will be saved
                        </p>
                    </div>

                </div>
            </details>

            <!-- Contacts Page Accordion -->
            <details class="content-accordion" id="contacts-accordion" style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 1rem;">
                <summary style="font-size: 1.3rem; font-weight: bold; color: var(--primary-green); cursor: pointer; padding: 0.5rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="accordion-icon" style="transition: transform 0.3s ease;">▼</span>
                    📞 Contacts Page Content
                </summary>
                
                <div style="margin-top: 1.5rem; display: grid; gap: 2rem;">
                    
                    <!-- Page Header -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.05), rgba(var(--primary-maroon-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📄 Page Header
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Title (Browser Tab)</label>
                                <input type="text" id="contacts-page-title" 
                                       placeholder="Club Contacts - Old Laurentian RFC" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Browser tab title for contacts page</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Main Heading</label>
                                <input type="text" id="contacts-main-heading" 
                                       placeholder="Club Committee Contacts" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Main page heading</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Description</label>
                                <input type="text" id="contacts-page-description" 
                                       placeholder="Our dedicated committee members are here to help. Find the right person for your enquiry below." 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Subtitle below main heading</small>
                            </div>
                        </div>
                    </div>

                    <!-- Location Section -->
                    <div style="padding: 1.5rem; background: rgba(0,0,0,0.02); border-radius: 10px;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📍 Club Location
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Location Heading</label>
                                <input type="text" id="contacts-location-heading" 
                                       placeholder="📍 Club Address" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Section heading for location</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Venue Name</label>
                                <input type="text" id="contacts-venue-name" 
                                       placeholder="Fenley Field" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Ground/venue name</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Street Address</label>
                                <input type="text" id="contacts-venue-street" 
                                       placeholder="Lime Tree Avenue" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Street address</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">City / Postcode</label>
                                <input type="text" id="contacts-venue-city" 
                                       placeholder="Rugby, Warwickshire, CV22 7QT" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">City, county, and postcode</small>
                            </div>
                        </div>
                    </div>

                    <!-- Training Times Section -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--accent-gold-rgb), 0.05), rgba(var(--primary-green-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            ⏰ Training Times
                        </h4>
                        <div style="display: grid; gap: 1.5rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Training Times Heading</label>
                                <input type="text" id="contacts-training-heading" 
                                       placeholder="⏰ Training Times" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Section heading for training schedule</small>
                            </div>
                            <!-- OLS 131: Training schedule now comes from Club Sections -->
                            <div style="padding: 1rem; background: rgba(var(--primary-green-rgb), 0.1); border-radius: 8px; border-left: 4px solid var(--primary-green);">
                                <p style="margin: 0; font-size: 0.95rem;">
                                    <strong>📋 Training Schedule</strong><br>
                                    <span style="color: var(--text-light);">Training times are now managed via <strong>Club Sections</strong>. Edit each section in Teams to configure whether the section trains together or shows individual team training times.</span>
                                </p>
                                <a href="#" onclick="showSection('teams'); setTimeout(toggleClubSectionsPanel, 100); return false;" style="display: inline-block; margin-top: 0.75rem; color: var(--primary-green); font-weight: bold; text-decoration: none;">
                                    → Configure Club Sections
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- UI Messages -->
                    <div style="padding: 1.5rem; background: rgba(0,0,0,0.02); border-radius: 10px;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            💬 UI Messages
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Loading Message</label>
                                <input type="text" id="contacts-loading-message" 
                                       placeholder="Loading contacts..." 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Shown while contacts are loading</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Empty State Title</label>
                                <input type="text" id="contacts-empty-title" 
                                       placeholder="No Contacts Available" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Shown when no contacts exist</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Empty State Message</label>
                                <input type="text" id="contacts-empty-message" 
                                       placeholder="Contact information will be displayed here once added by club administrators." 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Message when no contacts exist</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">No Contact Info Message</label>
                                <input type="text" id="contacts-no-info-message" 
                                       placeholder="Contact via club for details" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Shown when contact has no email/phone</small>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div style="text-align: center; padding-top: 1rem; border-top: 2px solid #f0f0f0;">
                        <button id="save-contacts-btn" class="btn btn-primary" onclick="saveContactsPageContent()" style="font-size: 1.1rem; padding: 1rem 3rem;">
                            💾 Save Contacts Page Content
                        </button>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                            Only changed fields will be saved
                        </p>
                    </div>

                </div>
            </details>

            <!-- Teams Page Accordion - OLS 119 -->
            <details class="content-accordion" id="teams-accordion" style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 1rem;">
                <summary style="font-size: 1.3rem; font-weight: bold; color: var(--primary-green); cursor: pointer; padding: 0.5rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="accordion-icon" style="transition: transform 0.3s ease;">▼</span>
                    👥 Teams Page Content
                </summary>
                
                <div style="margin-top: 1.5rem; display: grid; gap: 2rem;">
                    
                    <!-- Page Header -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.05), rgba(var(--primary-maroon-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📄 Page Header
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Title (Browser Tab)</label>
                                <input type="text" id="teams-page-title" 
                                       placeholder="Teams & Players" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Browser tab title for teams page</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Main Heading</label>
                                <input type="text" id="teams-main-heading" 
                                       placeholder="Our Teams" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Main page heading</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Description</label>
                                <input type="text" id="teams-page-description" 
                                       placeholder="Meet the players who represent our club with pride" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Subtitle below main heading</small>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div style="text-align: center; padding-top: 1rem; border-top: 2px solid #f0f0f0;">
                        <button id="save-teams-btn" class="btn btn-primary" onclick="saveTeamsPageContent()" style="font-size: 1.1rem; padding: 1rem 3rem;">
                            💾 Save Teams Page Content
                        </button>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                            Only changed fields will be saved
                        </p>
                    </div>

                </div>
            </details>

            <!-- Sponsors Page Accordion -->
            <details class="content-accordion" id="sponsors-accordion" style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 1rem;">
                <summary style="font-size: 1.3rem; font-weight: bold; color: var(--primary-green); cursor: pointer; padding: 0.5rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="accordion-icon" style="transition: transform 0.3s ease;">▼</span>
                    🤝 Sponsors Page Content
                </summary>
                
                <div style="margin-top: 1.5rem; display: grid; gap: 2rem;">
                    
                    <!-- Page Header -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.05), rgba(var(--primary-maroon-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📄 Page Header
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Title (Browser Tab)</label>
                                <input type="text" id="sponsors-page-title" 
                                       placeholder="Our Sponsors - Old Laurentian RFC" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Browser tab title for sponsors page</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Main Heading</label>
                                <input type="text" id="sponsors-main-heading" 
                                       placeholder="Our Sponsors" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Main page heading</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Description</label>
                                <input type="text" id="sponsors-page-description" 
                                       placeholder="Thank you to our sponsors for supporting Old Laurentian RFC" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Subtitle below main heading</small>
                            </div>
                        </div>
                    </div>

                    <!-- Sponsors List Section -->
                    <div style="padding: 1.5rem; background: rgba(0,0,0,0.02); border-radius: 10px;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📋 Sponsors List
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">List Title</label>
                                <input type="text" id="sponsors-list-title" 
                                       placeholder="Our Sponsors" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Title above sponsors grid</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Loading Message</label>
                                <input type="text" id="sponsors-loading-message" 
                                       placeholder="Loading sponsors..." 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Shown while sponsors are loading</small>
                            </div>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--accent-gold-rgb), 0.05), rgba(var(--primary-green-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📭 Empty State
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Empty State Icon</label>
                                <input type="text" id="sponsors-empty-icon" 
                                       placeholder="🤝" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Emoji shown when no sponsors (e.g., 🤝, 💼, 🏢)</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Empty State Text</label>
                                <input type="text" id="sponsors-empty-text" 
                                       placeholder="No sponsors to display at this time." 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Message when no sponsors exist</small>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Labels -->
                    <div style="padding: 1.5rem; background: rgba(0,0,0,0.02); border-radius: 10px;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            🏷️ Contact Labels
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Website Label (Card)</label>
                                <input type="text" id="sponsors-card-website-label" 
                                       placeholder="Visit Website" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Label for website link on sponsor cards</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Phone Label (Modal)</label>
                                <input type="text" id="sponsors-modal-phone-label" 
                                       placeholder="Phone" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Label for phone in detail modal</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Email Label (Modal)</label>
                                <input type="text" id="sponsors-modal-email-label" 
                                       placeholder="Email" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Label for email in detail modal</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Website Label (Modal)</label>
                                <input type="text" id="sponsors-modal-website-label" 
                                       placeholder="Website" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Label for website in detail modal</small>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div style="text-align: center; padding-top: 1rem; border-top: 2px solid #f0f0f0;">
                        <button id="save-sponsors-btn" class="btn btn-primary" onclick="saveSponsorsPageContent()" style="font-size: 1.1rem; padding: 1rem 3rem;">
                            💾 Save Sponsors Page Content
                        </button>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                            Only changed fields will be saved
                        </p>
                    </div>

                </div>
            </details>

            <!-- VP Wall Page Content (OLS 114) -->
            <details class="content-accordion" style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 1rem;">
                <summary style="font-size: 1.3rem; font-weight: bold; color: var(--primary-green); cursor: pointer; padding: 0.5rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                    🧱 VP Wall Page Content
                </summary>
                
                <div style="margin-top: 1.5rem; display: grid; gap: 2rem;">
                    
                    <!-- Page Header -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.05), rgba(var(--primary-maroon-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📄 Page Header
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Title (Browser Tab)</label>
                                <input type="text" id="vpwall-page-title" 
                                       placeholder="Vice Presidents Wall - Old Laurentian RFC" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Browser tab title for VP Wall page</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Main Heading</label>
                                <input type="text" id="vpwall-main-heading" 
                                       placeholder="🧱 Vice Presidents Wall" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Main page heading (can include emoji)</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Page Subtitle</label>
                                <input type="text" id="vpwall-page-subtitle" 
                                       placeholder="Honoring those who have served our club with distinction" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Subtitle below main heading</small>
                            </div>
                        </div>
                    </div>

                    <!-- Intro Section -->
                    <div style="padding: 1.5rem; background: rgba(0,0,0,0.02); border-radius: 10px;">
                        <h4 style="color: var(--primary-maroon); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📝 Introduction
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Introduction Text</label>
                                <textarea id="vpwall-intro-text" 
                                       placeholder="Each brick represents a Vice President who has dedicated their time and passion to our club. Their names are forever etched in our club's history."
                                       rows="3"
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;"></textarea>
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Introductory paragraph shown above the wall</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Wall Plaque Text</label>
                                <input type="text" id="vpwall-plaque-text" 
                                       placeholder="Vice Presidents" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Text on the brass plaque above the brick wall</small>
                            </div>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--accent-gold-rgb), 0.05), rgba(var(--primary-green-rgb), 0.05)); border-radius: 10px;">
                        <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📭 Empty State
                        </h4>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Empty State Heading</label>
                                <input type="text" id="vpwall-empty-heading" 
                                       placeholder="No Vice Presidents Yet" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Heading shown when no VPs exist</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Empty State Text</label>
                                <input type="text" id="vpwall-empty-text" 
                                       placeholder="The wall awaits its first brick." 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">Message when no VPs exist</small>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div style="text-align: center; padding-top: 1rem; border-top: 2px solid #f0f0f0;">
                        <button id="save-vpwall-btn" class="btn btn-primary" onclick="saveVPWallPageContent()" style="font-size: 1.1rem; padding: 1rem 3rem;">
                            💾 Save VP Wall Page Content
                        </button>
                        <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                            Only changed fields will be saved
                        </p>
                    </div>

                </div>
            </details>

            <details class="content-accordion" style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 1rem; opacity: 0.6;">
                <summary style="font-size: 1.3rem; font-weight: bold; color: var(--text-light); cursor: not-allowed; padding: 0.5rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                    <span>📖</span> About Page (Coming Soon)
                </summary>
            </details>

            <!-- Alert Message -->
            <div id="content-management-alert" style="display: none; margin-top: 1rem;"></div>
        </div>
        <!-- ================================================ -->
        <!-- END CONTENT MANAGEMENT SECTION -->
        <!-- ================================================ -->

        <!-- News Management -->
        <div id="news" class="admin-section">
            <div class="section-header-bar">
                <h2>📰 News Management</h2>
                <div class="section-header-actions">
                    <a href="#news-categories" class="manage-link" onclick="showSection('news-categories')">🏷️ Manage Categories</a>
                    <button class="btn" onclick="populateNewsClubSectionDropdown(); openModal('newsModal')">Add News Article</button>
                </div>
            </div>
            
            <div id="newsAlert" style="display: none;"></div>
            <div class="content-list" id="newsList">
                <!-- News articles will be loaded here -->
            </div>
        </div>

        <!-- Fixtures Management -->
        <div id="fixtures" class="admin-section">
            <div class="section-header-bar">
                <h2>🏉 Fixtures & Results</h2>
                <div class="section-header-actions" style="flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <label for="admin-team-filter" style="font-weight: bold; color: var(--primary-green); white-space: nowrap;">Filter:</label>
                        <select id="admin-team-filter" class="team-select" style="padding: 0.5rem 0.75rem; border: 2px solid var(--primary-green); border-radius: 20px; font-size: 0.85rem; font-weight: bold; background: white; color: var(--primary-green); cursor: pointer; min-width: 150px;">
                            <option value="all">All Teams</option>
                        </select>
                    </div>
                    <a href="#league-tables" class="manage-link" onclick="showSection('league-tables')">🏆 League Tables</a>
                    <button class="btn btn-warning" onclick="openBulkEditFixtures()">📝 Bulk Edit</button>
                    <button class="btn btn-dedup" onclick="deduplicateGoogleCalendar()">📅 Dedup Calendar</button>
                    <button class="btn" onclick="adminSystem.currentEditIndex = null; openModal('fixtureModal')">Add Fixture</button>
                </div>
            </div>
            <div id="fixturesAlert" style="display: none;"></div>
            
            <!-- OLS 100: Fixtures Time Filter Tabs -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--bg-light);">
                <button id="tab-upcoming" class="fixture-time-tab active" onclick="switchFixtureTimeTab('upcoming')">
                    📅 Upcoming Fixtures
                </button>
                <button id="tab-past" class="fixture-time-tab" onclick="switchFixtureTimeTab('past')">
                    🏆 Past Fixtures
                </button>
            </div>
            
            <div class="content-list" id="fixturesList">
                <!-- Fixtures will be loaded here -->
            </div>
        </div>

        <!-- Gallery Management -->
        <div id="gallery" class="admin-section">
            <div class="section-header-bar">
                <h2>📸 Photo Gallery</h2>
                <button class="btn" onclick="openModal('galleryModal')">Upload Photos</button>
            </div>
            <div id="galleryAlert" style="display: none;"></div>
            <div class="content-list" id="galleryList">
                <!-- Gallery items will be loaded here -->
            </div>
        </div>

        <!-- Players Management -->
        <div id="players" class="admin-section">
            <div class="section-header-bar">
                <h2>👥 Player Management</h2>
                <div class="section-header-actions">
                    <button class="btn btn-warning" onclick="openBulkEditPlayers()">📝 Bulk Edit</button>
                    <button class="btn" onclick="openModal('playerModal')">Add Player</button>
                </div>
            </div>
            <div id="playersAlert" style="display: none;"></div>
            <div class="content-list" id="playersList">
                <!-- Players will be loaded here -->
            </div>
        </div>

        <!-- Teams Management -->
        <div id="teams" class="admin-section">
            <div class="section-header-bar">
                <h2>🏉 Team Management</h2>
                <div class="section-header-actions">
                    <a href="#club-sections" class="manage-link" onclick="showSection('club-sections')">🏢 Club Sections</a>
                    <a href="#filters" class="manage-link" onclick="showSection('filters')">🎯 Display Filters</a>
                    <button class="btn" onclick="openAddTeamModal()">Add Team</button>
                </div>
            </div>
            
            <div id="teamsAlert" style="display: none;"></div>
            <div class="content-list" id="teamsList">
                <!-- Teams will be loaded here -->
            </div>
        </div>

        <!-- Display Filters Section -->
        <div id="filters" class="admin-section">
            <div class="section-header-bar">
                <h2>🎯 Team Display Filters</h2>
                <button class="btn" onclick="openFilterModal()">➕ Add Display Filter</button>
            </div>

            <div class="info-box" style="margin-bottom: 1.5rem;">
                <h4>💡 What are Display Filters?</h4>
                <p>Display filters let you group multiple teams together on your public Teams page.</p>
                <p><strong>Example:</strong> Group "Mens 1st XV" + "Mens 2nd XV" into "Senior Squad"</p>
            </div>

            <div id="filtersAlert" style="display: none;"></div>
            <div class="content-list" id="filtersList">
                <!-- Filters will be loaded here -->
            </div>
        </div>

        <!-- Shop Management -->
        <div id="shop" class="admin-section">
            <div class="section-header-bar">
                <h2>🛒 Shop Management</h2>
                <button class="btn" onclick="openModal('shopModal')">Add Product</button>
            </div>
            <div id="shopAlert" style="display: none;"></div>

            <!-- Shop Stats -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card" style="background: linear-gradient(45deg, #28a745, #20c997);">
                    <span class="stat-number" id="totalProducts">0</span>
                    <span>Total Products</span>
                </div>
                <div class="stat-card" style="background: linear-gradient(45deg, #007bff, #6610f2);">
                    <span class="stat-number" id="totalValue">£0</span>
                    <span>Total Inventory Value</span>
                </div>
                <div class="stat-card" style="background: linear-gradient(45deg, #fd7e14, #e83e8c);">
                    <span class="stat-number" id="categoriesCount">0</span>
                    <span>Categories</span>
                </div>
                <div class="stat-card" style="background: linear-gradient(45deg, #6f42c1, #e83e8c);">
                    <span class="stat-number" id="lowStockCount">0</span>
                    <span>Low Stock Items</span>
                </div>
            </div>

            <!-- Category Filter -->
            <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: var(--shadow); margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem; color: var(--primary-green);">Filter by Category</h3>
                <div class="action-buttons" id="shopCategoryFilters">
                    <button class="btn btn-secondary active" data-category="all" onclick="filterShopItems('all')">All Items</button>
                    <button class="btn btn-secondary" data-category="jerseys" onclick="filterShopItems('jerseys')">Jerseys</button>
                    <button class="btn btn-secondary" data-category="training" onclick="filterShopItems('training')">Training Gear</button>
                    <button class="btn btn-secondary" data-category="accessories" onclick="filterShopItems('accessories')">Accessories</button>
                    <button class="btn btn-secondary" data-category="supporters" onclick="filterShopItems('supporters')">Supporters Gear</button>
                </div>
            </div>

            <div class="content-list" id="shopList">
                <!-- Shop items will be loaded here -->
            </div>
        </div>

        <!-- Sponsors Management -->
        <div id="sponsors" class="admin-section">
            <div class="section-header-bar">
                <h2>🤝 Sponsor Management</h2>
                <div class="section-header-actions">
                    <button class="btn btn-warning" onclick="openBulkEditSponsors()">📝 Bulk Edit</button>
                    <button class="btn" onclick="adminSystem.currentEditIndex = null; openModal('sponsorModal')">Add Sponsor</button>
                </div>
            </div>
            <div id="sponsorsAlert" style="display: none;"></div>

            <!-- Sponsor Stats -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card" style="background: linear-gradient(45deg, #ffd700, #ffed4e);">
                    <span class="stat-number" id="totalSponsors">0</span>
                    <span>Total Sponsors</span>
                </div>
                <div class="stat-card" style="background: linear-gradient(45deg, #28a745, #20c997);">
                    <span class="stat-number" id="activeSponsors">0</span>
                    <span>Active Sponsors</span>
                </div>
                <div class="stat-card" style="background: linear-gradient(45deg, #e5e4e2, #c0c0c0);">
                    <span class="stat-number" id="platinumCount">0</span>
                    <span>Platinum</span>
                </div>
                <div class="stat-card" style="background: linear-gradient(45deg, #17a2b8, #6610f2);">
                    <span class="stat-number" id="goldCount">0</span>
                    <span>Gold</span>
                </div>
            </div>

            <!-- Tier Filter -->
            <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: var(--shadow); margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem; color: var(--primary-green);">Filter by Tier</h3>
                <div class="action-buttons" id="sponsorTierFilters">
                    <button class="btn btn-secondary active" data-tier="all" onclick="filterSponsors('all')">All Sponsors</button>
                    <button class="btn btn-secondary" data-tier="platinum" onclick="filterSponsors('platinum')">💎 Platinum</button>
                    <button class="btn btn-secondary" data-tier="gold" onclick="filterSponsors('gold')">🥇 Gold</button>
                    <button class="btn btn-secondary" data-tier="silver" onclick="filterSponsors('silver')">🥈 Silver</button>
                    <button class="btn btn-secondary" data-tier="bronze" onclick="filterSponsors('bronze')">🥉 Bronze</button>
                </div>
            </div>

            <!-- Banner Preview -->
            <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: var(--shadow); margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem; color: var(--primary-green);">🎯 Banner Preview</h3>
                <div style="border: 2px dashed #ddd; border-radius: 10px; padding: 1rem; background: #f8f9fa; overflow: hidden;">
                    <div class="sponsor-preview-ticker" id="sponsorPreviewTicker" style="display: flex; gap: 2rem; align-items: center; animation: previewScroll 12s linear infinite;">
                        <!-- Preview will be loaded here -->
                    </div>
                </div>
                <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                    ℹ️ This shows how sponsors will appear in the homepage banner
                </p>
            </div>

            <div class="content-list" id="sponsorsList">
                <!-- Sponsors will be loaded here -->
            </div>
        </div>
    </div>

<!-- ================================================ -->
<!-- CONTACTS MANAGEMENT SECTION -->
<!-- INSERT THIS AFTER THE SPONSORS SECTION (around line 1200) -->
<!-- ================================================ -->

        <!-- Contacts Section -->
        <div id="contacts" class="admin-section">
            <div class="section-header-bar">
                <h2>📇 Club Contacts</h2>
                <div class="section-header-actions">
                    <button class="btn btn-warning" onclick="openBulkEditContacts()">📝 Bulk Edit</button>
                    <button class="btn" onclick="openContactModal()">➕ Add Contact</button>
                </div>
            </div>

            <!-- Stats Row -->
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 2rem;">
                <div class="stat-card">
                    <span class="stat-number" id="contactsTotal">0</span>
                    <span>Total Contacts</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="contactsWithPhotos">0</span>
                    <span>With Photos</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="contactsWithEmail">0</span>
                    <span>With Email</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="contactsCategories">0</span>
                    <span>Categories</span>
                </div>
            </div>

            <!-- Filter Controls -->
            <div style="background: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <strong>Filter by Category:</strong>
                    <select id="contactCategoryFilter" onchange="filterContactsByCategory()" style="padding: 0.5rem; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">All Categories</option>
                    </select>
                </label>
                <button class="btn" onclick="contactsManager.exportToCSV()" style="margin-left: auto;">📥 Export CSV</button>
                <button class="btn" onclick="contactsManager.exportToJSON()">📥 Export JSON</button>
            </div>

            <!-- Contacts List -->
            <div id="contactsList" class="content-list">
                <p class="empty-state">No contacts found. Add your first contact!</p>
            </div>
        </div>


<!-- OLS 107: Events Enquiry Management Section -->

<div id="events-enquiry" class="admin-section">
    <div class="section-header-bar">
        <h2>📧 Events & Enquiries</h2>
    </div>

    <!-- Tab Navigation -->
    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid #e0e0e0;">
        <button class="tab-btn" onclick="showEnquiryTab('config')" id="config-tab">
            ⚙️ Form Configuration
        </button>
        <button class="tab-btn active" onclick="showEnquiryTab('enquiries')" id="enquiries-tab">
            📬 View Enquiries <span id="new-enquiries-badge" class="badge" style="display: none;">0</span>
        </button>
    </div>

    <!-- CONFIG TAB -->
    <div id="config-enquiry-tab" class="enquiry-tab" style="display: none;">
        <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 2rem;">
            
            <!-- Email Recipients -->
            <div style="margin-bottom: 3rem;">
                <h3 style="margin-bottom: 1rem; color: var(--primary-green);">📬 Email Recipients</h3>
                <p style="color: var(--text-light); margin-bottom: 1rem;">
                    Enter email addresses to receive enquiry notifications (separate multiple emails with commas)
                </p>
                <input type="text" id="enquiry-emails" 
                       placeholder="venue@club.com, bookings@club.com"
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem;">
                <p style="color: var(--text-light); margin-top: 0.5rem; font-size: 0.9rem;">
                    💡 Separate multiple emails with commas
                </p>
            </div>

            <!-- Form Fields Configuration -->
            <div style="margin-bottom: 3rem;">
                <h3 style="margin-bottom: 1rem; color: var(--primary-green);">📋 Form Fields</h3>
                <p style="color: var(--text-light); margin-bottom: 1rem;">
                    Enable/disable fields and customize labels
                </p>

                <div id="fields-config-container" style="display: grid; gap: 1rem;">
                    <!-- Fields will be loaded here dynamically -->
                </div>
            </div>

            <!-- Custom Messages -->
            <div style="margin-bottom: 3rem;">
                <h3 style="margin-bottom: 1rem; color: var(--primary-green);">✉️ Custom Messages</h3>
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Form Title</label>
                        <input type="text" id="msg-form-title" 
                               placeholder="Venue Hire Enquiry"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Form Description</label>
                        <textarea id="msg-form-description" rows="2"
                                  placeholder="Interested in hiring our facilities?"
                                  style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical;"></textarea>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Submit Button Text</label>
                        <input type="text" id="msg-submit-button" 
                               placeholder="Send Enquiry"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Success Message</label>
                        <textarea id="msg-success-message" rows="2"
                                  placeholder="Thank you! We'll be in touch within 24 hours."
                                  style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical;"></textarea>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Email Subject Line</label>
                        <input type="text" id="msg-email-subject" 
                               placeholder="New Venue Hire Enquiry from {name}"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <p style="color: var(--text-light); margin-top: 0.25rem; font-size: 0.85rem;">
                            💡 Use {name} to insert the customer's name
                        </p>
                    </div>

                    <!-- Auto-reply Settings -->
                    <div style="border-top: 2px solid #f0f0f0; padding-top: 1rem; margin-top: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="checkbox" id="msg-auto-reply-enabled" 
                                   style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-weight: 600;">Enable Auto-Reply to Customer</span>
                        </label>
                        <div id="auto-reply-fields" style="display: none; padding-left: 2rem;">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Auto-Reply Subject</label>
                                <input type="text" id="msg-auto-reply-subject" 
                                       placeholder="We've received your enquiry"
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Auto-Reply Message</label>
                                <textarea id="msg-auto-reply-message" rows="3"
                                          placeholder="Thank you for your interest. We've received your enquiry and will respond within 24 hours."
                                          style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div style="text-align: center; padding-top: 2rem; border-top: 2px solid #f0f0f0;">
                <button class="btn btn-primary" onclick="saveEnquirySettings()" style="font-size: 1.1rem; padding: 1rem 3rem;">
                    💾 Save Configuration
                </button>
                <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                    Changes will be applied to the Events page immediately
                </p>
            </div>

            <!-- Status Message -->
            <div id="enquiry-config-status" style="display: none; margin-top: 1rem;"></div>
        </div>
    </div>

    <!-- ENQUIRIES TAB -->
    <div id="enquiries-enquiry-tab" class="enquiry-tab">
        <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: var(--shadow);">
            
            <!-- Filters and Actions -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="filter-chip active" onclick="filterEnquiries('all')">
                        All <span id="count-all">0</span>
                    </button>
                    <button class="filter-chip" onclick="filterEnquiries('new')">
                        🆕 New <span id="count-new">0</span>
                    </button>
                    <button class="filter-chip" onclick="filterEnquiries('contacted')">
                        ✅ Contacted <span id="count-contacted">0</span>
                    </button>
                    <button class="filter-chip" onclick="filterEnquiries('completed')">
                        ✔️ Completed <span id="count-completed">0</span>
                    </button>
                </div>
                <button class="btn btn-secondary" onclick="refreshEnquiries()">
                    🔄 Refresh
                </button>
            </div>

            <!-- Enquiries Table -->
            <div id="enquiries-table-container" style="overflow-x: auto;">
                <table id="enquiries-table" class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">Status</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Event Type</th>
                            <th>Date</th>
                            <th>Received</th>
                            <th style="width: 150px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="enquiries-tbody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 3rem; color: var(--text-light);">
                                Loading enquiries...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div id="enquiries-empty" style="display: none; text-align: center; padding: 3rem; color: var(--text-light);">
                <div style="font-size: 4rem; margin-bottom: 1rem;">📭</div>
                <h3 style="margin-bottom: 0.5rem;">No Enquiries Yet</h3>
                <p>Enquiries will appear here once customers submit the venue hire form</p>
            </div>
        </div>
    </div>
</div>

<!-- Enquiry Detail Modal -->
<div id="enquiry-detail-modal" class="admin-modal" style="display: none;">
    <div class="admin-modal-content" style="max-width: 700px;">
        <div class="admin-modal-header">
            <h3 id="enquiry-modal-title">Enquiry Details</h3>
            <span class="admin-modal-close" onclick="closeEnquiryModal()">&times;</span>
        </div>
        <div class="admin-modal-body">
            <div id="enquiry-detail-content">
                <!-- Content loaded dynamically -->
            </div>
            
            <!-- Status Update -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #f0f0f0;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Update Status</label>
                <select id="enquiry-modal-status" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 1rem;">
                    <option value="new">🆕 New</option>
                    <option value="contacted">✅ Contacted</option>
                    <option value="completed">✔️ Completed</option>
                </select>
                
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Internal Notes</label>
                <textarea id="enquiry-modal-notes" rows="3" 
                          placeholder="Add notes about this enquiry..."
                          style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical;"></textarea>
            </div>
        </div>
        <div class="admin-modal-footer">
            <button class="btn btn-secondary" onclick="closeEnquiryModal()">Cancel</button>
            <button class="btn btn-danger" onclick="deleteCurrentEnquiry()">🗑️ Delete</button>
            <button class="btn btn-primary" onclick="saveEnquiryUpdates()">💾 Save Changes</button>
        </div>
    </div>
</div>

<style>
/* OLS 107: Events Enquiry Admin Styles */
.tab-btn {
    padding: 1rem 1.5rem;
    border: none;
    background: transparent;
    cursor: pointer;
    font-weight: 600;
    color: var(--text-light);
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
}

.tab-btn:hover {
    color: var(--primary-green);
}

.tab-btn.active {
    color: var(--primary-green);
    border-bottom-color: var(--primary-green);
}

.badge {
    background: #dc3545;
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 10px;
    font-size: 0.8rem;
    margin-left: 0.5rem;
}

.field-config-item {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 1rem;
    align-items: center;
    padding: 1rem;
    background: var(--bg-light);
    border-radius: 8px;
}

.field-config-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.field-config-item input[type="text"] {
    padding: 0.5rem;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    font-size: 0.9rem;
}

.filter-chip {
    padding: 0.5rem 1rem;
    border: 2px solid #e0e0e0;
    background: white;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.filter-chip:hover {
    border-color: var(--primary-green);
    color: var(--primary-green);
}

.filter-chip.active {
    background: var(--primary-green);
    border-color: var(--primary-green);
    color: white;
}

.filter-chip span {
    display: inline-block;
    margin-left: 0.3rem;
    padding: 0.1rem 0.4rem;
    background: rgba(0,0,0,0.1);
    border-radius: 10px;
    font-size: 0.85rem;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
}

.data-table th {
    background: var(--bg-light);
    font-weight: 600;
    color: var(--text-dark);
}

.data-table tbody tr {
    transition: background 0.2s ease;
}

.data-table tbody tr:hover {
    background: rgba(var(--primary-green-rgb, 0,103,71), 0.05);
}

.status-badge {
    display: inline-block;
    padding: 0.4rem 0.8rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
}

.status-new {
    background: #fff3cd;
    color: #856404;
}

.status-contacted {
    background: #d1ecf1;
    color: #0c5460;
}

.status-completed {
    background: #d4edda;
    color: #155724;
}

.admin-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    padding: 1rem;
}

.admin-modal-content {
    background: white;
    border-radius: 15px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
    width: 100%;
}

.admin-modal-header {
    padding: 1.5rem 2rem;
    background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon));
    color: white;
    border-radius: 15px 15px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.admin-modal-body {
    padding: 2rem;
}

.admin-modal-footer {
    padding: 1.5rem 2rem;
    border-top: 2px solid #f0f0f0;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

.admin-modal-close {
    font-size: 2rem;
    cursor: pointer;
    line-height: 1;
}

.detail-grid {
    display: grid;
    gap: 1rem;
}

.detail-item {
    padding: 1rem;
    background: var(--bg-light);
    border-radius: 8px;
}

.detail-item label {
    display: block;
    font-weight: 600;
    color: var(--text-light);
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
}

.detail-item .value {
    font-size: 1rem;
    color: var(--text-dark);
}
</style>

<script>
// OLS 107: Events Enquiry Admin JavaScript
let currentEnquiryFilter = 'all';
let allEnquiries = [];
let currentEnquiryId = null;

// Tab switching
function showEnquiryTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    if (tabName === 'config') {
        document.getElementById('config-tab').classList.add('active');
    } else {
        document.getElementById('enquiries-tab').classList.add('active');
    }
    
    // Show/hide tab content
    document.getElementById('config-enquiry-tab').style.display = tabName === 'config' ? 'block' : 'none';
    document.getElementById('enquiries-enquiry-tab').style.display = tabName === 'enquiries' ? 'block' : 'none';
    
    // Load data if switching to enquiries tab
    if (tabName === 'enquiries') {
        loadEnquiries();
    }
}

// Load enquiry settings
async function loadEnquirySettings() {
    try {
        const settings = await window.netlifyDataManager.getEventsEnquirySettings();
        
        // Populate emails
        document.getElementById('enquiry-emails').value = settings.emails.join(', ');
        
        // Populate form fields
        const fieldsContainer = document.getElementById('fields-config-container');
        fieldsContainer.innerHTML = '';
        
        Object.keys(settings.fields).forEach(fieldKey => {
            const field = settings.fields[fieldKey];
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'field-config-item';
            fieldDiv.innerHTML = `
                <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                    <input type="checkbox" 
                           data-field="${fieldKey}" 
                           data-type="enabled"
                           ${field.enabled ? 'checked' : ''}>
                    <span style="font-weight: 600;">${field.label}</span>
                </label>
                <input type="text" 
                       placeholder="Custom label"
                       data-field="${fieldKey}"
                       data-type="label"
                       value="${field.label}">
                <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                    <input type="checkbox"
                           data-field="${fieldKey}"
                           data-type="required"
                           ${field.required ? 'checked' : ''}>
                    <span style="font-size: 0.9rem;">Required</span>
                </label>
            `;
            fieldsContainer.appendChild(fieldDiv);
        });
        
        // Populate messages
        document.getElementById('msg-form-title').value = settings.messages.formTitle || '';
        document.getElementById('msg-form-description').value = settings.messages.formDescription || '';
        document.getElementById('msg-submit-button').value = settings.messages.submitButton || '';
        document.getElementById('msg-success-message').value = settings.messages.successMessage || '';
        document.getElementById('msg-email-subject').value = settings.messages.emailSubject || '';
        
        // Auto-reply settings
        const autoReplyEnabled = settings.messages.autoReplyEnabled || false;
        document.getElementById('msg-auto-reply-enabled').checked = autoReplyEnabled;
        document.getElementById('auto-reply-fields').style.display = autoReplyEnabled ? 'block' : 'none';
        document.getElementById('msg-auto-reply-subject').value = settings.messages.autoReplySubject || '';
        document.getElementById('msg-auto-reply-message').value = settings.messages.autoReplyMessage || '';
        
        console.log('✅ Enquiry settings loaded');
    } catch (error) {
        console.error('Error loading enquiry settings:', error);
    }
}

// Toggle auto-reply fields
document.addEventListener('DOMContentLoaded', function() {
    const autoReplyCheckbox = document.getElementById('msg-auto-reply-enabled');
    if (autoReplyCheckbox) {
        autoReplyCheckbox.addEventListener('change', function() {
            document.getElementById('auto-reply-fields').style.display = this.checked ? 'block' : 'none';
        });
    }
});

// Save enquiry settings
async function saveEnquirySettings() {
    try {
        // Collect emails
        const emailsInput = document.getElementById('enquiry-emails').value;
        const emails = emailsInput.split(',').map(e => e.trim()).filter(e => e);
        
        if (emails.length === 0) {
            alert('Please enter at least one email address');
            return;
        }
        
        // Collect field settings
        const fields = {};
        document.querySelectorAll('#fields-config-container .field-config-item').forEach(item => {
            const fieldKey = item.querySelector('[data-type="enabled"]').dataset.field;
            fields[fieldKey] = {
                enabled: item.querySelector('[data-type="enabled"]').checked,
                required: item.querySelector('[data-type="required"]').checked,
                label: item.querySelector('[data-type="label"]').value
            };
            
            // Preserve options if they exist (e.g., eventType)
            if (fieldKey === 'eventType') {
                fields[fieldKey].options = ["Wedding", "Corporate Event", "Birthday Party", "Rugby Event", "Other"];
            }
        });
        
        // Collect messages
        const messages = {
            formTitle: document.getElementById('msg-form-title').value,
            formDescription: document.getElementById('msg-form-description').value,
            submitButton: document.getElementById('msg-submit-button').value,
            successMessage: document.getElementById('msg-success-message').value,
            emailSubject: document.getElementById('msg-email-subject').value,
            autoReplyEnabled: document.getElementById('msg-auto-reply-enabled').checked,
            autoReplySubject: document.getElementById('msg-auto-reply-subject').value,
            autoReplyMessage: document.getElementById('msg-auto-reply-message').value
        };
        
        // Spam settings (keep defaults)
        const spam = {
            honeypotEnabled: true,
            rateLimitMinutes: 5
        };
        
        const settings = { emails, fields, messages, spam };
        
        // Save via API
        await window.netlifyDataManager.saveEventsEnquirySettings(settings);
        
        // Show success message
        const statusDiv = document.getElementById('enquiry-config-status');
        statusDiv.className = 'success-message';
        statusDiv.textContent = '✅ Settings saved successfully!';
        statusDiv.style.display = 'block';
        
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 3000);
        
    } catch (error) {
        console.error('Error saving settings:', error);
        const statusDiv = document.getElementById('enquiry-config-status');
        statusDiv.className = 'error-message';
        statusDiv.textContent = '❌ Error saving settings: ' + error.message;
        statusDiv.style.display = 'block';
    }
}

// Load enquiries
async function loadEnquiries() {
    try {
        allEnquiries = await window.netlifyDataManager.getEventsEnquiries();
        renderEnquiries();
    } catch (error) {
        console.error('Error loading enquiries:', error);
    }
}

// Render enquiries table
function renderEnquiries() {
    // Filter enquiries
    let filtered = allEnquiries;
    if (currentEnquiryFilter !== 'all') {
        filtered = allEnquiries.filter(e => e.status === currentEnquiryFilter);
    }
    
    // Update counts
    document.getElementById('count-all').textContent = allEnquiries.length;
    document.getElementById('count-new').textContent = allEnquiries.filter(e => e.status === 'new').length;
    document.getElementById('count-contacted').textContent = allEnquiries.filter(e => e.status === 'contacted').length;
    document.getElementById('count-completed').textContent = allEnquiries.filter(e => e.status === 'completed').length;
    
    // Update new badge
    const newCount = allEnquiries.filter(e => e.status === 'new').length;
    const badge = document.getElementById('new-enquiries-badge');
    if (newCount > 0) {
        badge.textContent = newCount;
        badge.style.display = 'inline-block';
    } else {
        badge.style.display = 'none';
    }
    
    const tbody = document.getElementById('enquiries-tbody');
    const emptyState = document.getElementById('enquiries-empty');
    
    if (filtered.length === 0) {
        tbody.innerHTML = '';
        document.getElementById('enquiries-table-container').style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    
    document.getElementById('enquiries-table-container').style.display = 'block';
    emptyState.style.display = 'none';
    
    tbody.innerHTML = filtered.map(enquiry => {
        const date = new Date(enquiry.createdAt);
        const statusClass = `status-${enquiry.status}`;
        const statusText = {
            'new': '🆕 New',
            'contacted': '✅ Contacted',
            'completed': '✔️ Completed'
        }[enquiry.status] || enquiry.status;
        
        return `
            <tr>
                <td>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </td>
                <td><strong>${enquiry.name || 'N/A'}</strong></td>
                <td>${enquiry.email || 'N/A'}</td>
                <td>${enquiry.eventType || 'N/A'}</td>
                <td>${enquiry.eventDate || 'N/A'}</td>
                <td>${date.toLocaleDateString('en-GB')}</td>
                <td>
                    <button class="btn btn-secondary" onclick="viewEnquiry('${enquiry.id}')" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                        👁️ View
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Filter enquiries
function filterEnquiries(filter) {
    currentEnquiryFilter = filter;
    
    // Update active chip
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
    });
    event.target.classList.add('active');
    
    renderEnquiries();
}

// Refresh enquiries
async function refreshEnquiries() {
    await loadEnquiries();
}

// View enquiry details
function viewEnquiry(id) {
    const enquiry = allEnquiries.find(e => e.id === id);
    if (!enquiry) return;
    
    currentEnquiryId = id;
    
    // Mark as read
    if (!enquiry.readAt) {
        window.netlifyDataManager.updateEventsEnquiry(id, { readAt: new Date().toISOString() });
        enquiry.readAt = new Date().toISOString();
    }
    
    // Build detail view
    const detailContent = document.getElementById('enquiry-detail-content');
    detailContent.innerHTML = `
        <div class="detail-grid">
            ${Object.keys(enquiry).filter(key => !['id', 'status', 'notes', 'readAt', 'updatedAt', 'website', 'ip'].includes(key)).map(key => {
                if (key === 'createdAt') {
                    return `
                        <div class="detail-item">
                            <label>Received</label>
                            <div class="value">${new Date(enquiry[key]).toLocaleString('en-GB')}</div>
                        </div>
                    `;
                }
                return `
                    <div class="detail-item">
                        <label>${key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1')}</label>
                        <div class="value">${enquiry[key] || 'N/A'}</div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
    
    // Set current values
    document.getElementById('enquiry-modal-status').value = enquiry.status;
    document.getElementById('enquiry-modal-notes').value = enquiry.notes || '';
    
    // Show modal
    document.getElementById('enquiry-detail-modal').style.display = 'flex';
}

// Close enquiry modal
function closeEnquiryModal() {
    document.getElementById('enquiry-detail-modal').style.display = 'none';
    currentEnquiryId = null;
}

// Save enquiry updates
async function saveEnquiryUpdates() {
    if (!currentEnquiryId) return;
    
    try {
        const status = document.getElementById('enquiry-modal-status').value;
        const notes = document.getElementById('enquiry-modal-notes').value;
        
        await window.netlifyDataManager.updateEventsEnquiry(currentEnquiryId, { status, notes });
        
        // Update local data
        const enquiry = allEnquiries.find(e => e.id === currentEnquiryId);
        if (enquiry) {
            enquiry.status = status;
            enquiry.notes = notes;
        }
        
        closeEnquiryModal();
        renderEnquiries();
        
        // Update badge count
        if (window.updateNewEnquiriesBadge) {
            window.updateNewEnquiriesBadge();
        }
        
        alert('✅ Enquiry updated successfully');
    } catch (error) {
        console.error('Error updating enquiry:', error);
        alert('❌ Error updating enquiry: ' + error.message);
    }
}

// Delete enquiry
async function deleteCurrentEnquiry() {
    if (!currentEnquiryId) return;
    
    if (!confirm('Are you sure you want to delete this enquiry? This action cannot be undone.')) {
        return;
    }
    
    try {
        await window.netlifyDataManager.deleteEventsEnquiry(currentEnquiryId);
        
        // Remove from local data
        allEnquiries = allEnquiries.filter(e => e.id !== currentEnquiryId);
        
        closeEnquiryModal();
        renderEnquiries();
        
        // Update badge count
        if (window.updateNewEnquiriesBadge) {
            window.updateNewEnquiriesBadge();
        }
        
        alert('✅ Enquiry deleted successfully');
    } catch (error) {
        console.error('Error deleting enquiry:', error);
        alert('❌ Error deleting enquiry: ' + error.message);
    }
}

// Load settings when section is shown
document.addEventListener('DOMContentLoaded', function() {
    // Check if we're on the events-enquiry section
    const showSectionOriginal = window.showSection;
    window.showSection = function(sectionId) {
        showSectionOriginal(sectionId);
        if (sectionId === 'events-enquiry') {
            loadEnquirySettings();
            loadEnquiries(); // Load enquiries since View Enquiries is now default tab
        }
    };
});
</script>


        <!-- ============================================ -->
        <!-- ADMIN MANAGEMENT SECTION (OLS 97) -->
        <!-- ============================================ -->
        <div id="admin-management" class="admin-section">
            <div class="section-header-bar">
                <h2>👤 Admin Users</h2>
                <button class="btn" onclick="openAddAdminModal()">➕ Add Admin</button>
            </div>

            <!-- Admin Users List -->
            <div id="adminUsersList" class="data-list">
                <p class="empty-state">Loading admin users...</p>
            </div>
        </div>


        <!-- OLS 104: Admin Activity Log UI Section -->

<div id="activity-log" class="admin-section">
    <div class="section-header-bar">
        <h2>📋 Activity Log</h2>
    </div>

    <!-- Filter Controls -->
    <div class="activity-filters" style="background: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--text-dark);">Filter by Admin:</label>
                <select id="filterByAdmin" onchange="filterActivityLogs()" style="width: 100%; padding: 0.5rem; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="">All Admins</option>
                    <!-- Options populated dynamically -->
                </select>
            </div>
            
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--text-dark);">Filter by Action:</label>
                <select id="filterByAction" onchange="filterActivityLogs()" style="width: 100%; padding: 0.5rem; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="">All Actions</option>
                    <option value="create">Created</option>
                    <option value="update">Updated</option>
                    <option value="delete">Deleted</option>
                </select>
            </div>
            
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--text-dark);">Filter by Content:</label>
                <select id="filterByContent" onchange="filterActivityLogs()" style="width: 100%; padding: 0.5rem; border: 2px solid #ddd; border-radius: 5px;">
                    <option value="">All Content Types</option>
                    <option value="news">News</option>
                    <option value="fixtures">Fixtures</option>
                    <option value="players">Players</option>
                    <option value="sponsors">Sponsors</option>
                    <option value="gallery">Gallery</option>
                    <option value="shop">Shop</option>
                    <option value="teams">Teams</option>
                    <option value="contacts">Contacts</option>
                    <option value="admin-users">Admin Users</option>
                    <option value="site-settings">Site Settings</option>
                </select>
            </div>
            
            <div style="display: flex; align-items: flex-end;">
                <button onclick="clearActivityFilters()" class="btn" style="width: 100%; background: #6c757d;">
                    🔄 Clear Filters
                </button>
            </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span id="activityLogCount" style="color: var(--text-light); font-size: 0.9rem;">Loading...</span>
            <button onclick="loadActivityLogs()" class="btn" style="background: var(--primary-green);">
                ↻ Refresh
            </button>
        </div>
    </div>

    <!-- Activity Log Table -->
    <div style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div style="overflow-x: auto;">
            <table id="activityLogTable" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon)); color: white;">
                        <th style="padding: 1rem; text-align: left; font-weight: bold;">Timestamp</th>
                        <th style="padding: 1rem; text-align: left; font-weight: bold;">Admin</th>
                        <th style="padding: 1rem; text-align: left; font-weight: bold;">Action</th>
                        <th style="padding: 1rem; text-align: left; font-weight: bold;">Content Type</th>
                        <th style="padding: 1rem; text-align: left; font-weight: bold;">Item</th>
                        <th style="padding: 1rem; text-align: left; font-weight: bold;">Description</th>
                    </tr>
                </thead>
                <tbody id="activityLogTableBody">
                    <tr>
                        <td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-light);">
                            Loading activity logs...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- VP WALL SECTION (OLS 114) -->
<!-- ============================================ -->
<div id="vp-wall" class="admin-section">
    <div class="section-header-bar">
        <h2>🎖️ Vice Presidents</h2>
        <div class="section-header-actions">
            <a href="/vp-wall.html" target="_blank" class="manage-link">🌐 View Public Page</a>
            <button class="btn btn-warning" onclick="openBulkEditVPs()">📝 Bulk Edit</button>
            <button class="btn" onclick="openVPModal()">➕ Add VP</button>
        </div>
    </div>

    <div id="vpAlert" class="alert" style="display: none;"></div>

    <!-- Stats Cards -->
    <div class="stats-grid" style="margin-bottom: 2rem;">
        <div class="stat-card">
            <h3 style="font-size: 0.9rem; margin-bottom: 0.5rem;">Total VPs</h3>
            <p class="stat-number" id="vpTotalCount">0</p>
        </div>
        <div class="stat-card">
            <h3 style="font-size: 0.9rem; margin-bottom: 0.5rem;">Lifetime VPs</h3>
            <p class="stat-number" id="vpLifetimeCount">0</p>
        </div>
        <div class="stat-card">
            <h3 style="font-size: 0.9rem; margin-bottom: 0.5rem;">Annual VPs</h3>
            <p class="stat-number" id="vpAnnualCount">0</p>
        </div>
    </div>

    <!-- VP List -->
    <div class="content-section" style="background: var(--bg-light); padding: 1.5rem; border-radius: 10px;">
        <h3 style="margin-bottom: 1rem;">Vice Presidents</h3>
        <div id="vpList" class="content-list">
            <p style="text-align: center; color: var(--text-light); padding: 2rem;">Loading Vice Presidents...</p>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- OLS 132: NEWS CATEGORIES STANDALONE SECTION -->
<!-- ============================================ -->
<div id="news-categories" class="admin-section">
    <div class="section-header-bar">
        <div>
            <h2>🏷️ News Categories</h2>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">Define categories for organizing news articles</p>
        </div>
        <button class="btn" onclick="openNewsCategoryModal()">➕ Add Category</button>
    </div>

    <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <p style="color: var(--text-light); margin-bottom: 1.5rem; font-size: 0.9rem;">
            Categories appear as filter buttons on the public News page and in the article editor dropdown.
        </p>
        
        <!-- Categories List (will be populated by existing JS) -->
        <div id="news-categories-list-standalone" style="display: grid; gap: 0.75rem; margin-bottom: 1.5rem;">
            <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                Loading categories...
            </div>
        </div>
        
        <!-- Help Text -->
        <div style="padding: 1rem; background: rgba(var(--accent-gold-rgb), 0.1); border-radius: 8px;">
            <p style="margin: 0; font-size: 0.85rem; color: var(--text-dark);">
                <strong>💡 Tips:</strong><br>
                • Categories appear in the order shown (use arrows to reorder)<br>
                • The ID is used internally - keep it simple (e.g., "match", "social")<br>
                • Icons appear on article cards and filter buttons
            </p>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- OLS 132: LEAGUE TABLES STANDALONE SECTION -->
<!-- ============================================ -->
<div id="league-tables" class="admin-section">
    <div class="section-header-bar">
        <div>
            <h2>🏆 League Tables</h2>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">Configure live league table scraping from England Rugby</p>
        </div>
        <button class="btn" onclick="openLeagueTableModal()">➕ Add League Table</button>
    </div>

    <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <p style="color: var(--text-light); margin-bottom: 1.5rem; font-size: 0.9rem;">
            Link your teams to their England Rugby league pages for live standings on your homepage.
        </p>
        
        <!-- League Tables List (will be populated by existing JS) -->
        <div id="league-tables-list-standalone" style="display: grid; gap: 0.75rem; margin-bottom: 1.5rem;">
            <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                Loading league configurations...
            </div>
        </div>
        
        <!-- Help Text -->
        <div style="padding: 1rem; background: rgba(var(--primary-green-rgb), 0.1); border-radius: 8px;">
            <p style="margin: 0; font-size: 0.85rem; color: var(--text-dark);">
                <strong>💡 How it works:</strong><br>
                • Go to your team's page on englandrugby.com and copy the league URL<br>
                • Paste it here - we'll extract the division, competition, and season automatically<br>
                • The homepage will scrape live standings and highlight your club's position
            </p>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- OLS 132: CLUB SECTIONS STANDALONE SECTION -->
<!-- ============================================ -->
<div id="club-sections" class="admin-section">
    <div class="section-header-bar">
        <div>
            <h2>🏢 Club Sections</h2>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">Organize your club into sections (Senior, Ladies, Minis, etc.)</p>
        </div>
        <button class="btn" onclick="openClubSectionModal()">➕ Add Section</button>
    </div>

    <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <p style="color: var(--text-light); margin-bottom: 1.5rem; font-size: 0.9rem;">
            Club sections group teams together for filtering, news targeting, and training times display.
        </p>
        
        <!-- Sections List (will be populated by existing JS) -->
        <div id="club-sections-list-standalone" style="display: grid; gap: 0.75rem; margin-bottom: 1.5rem;">
            <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                Loading sections...
            </div>
        </div>
        
        <!-- Help Text -->
        <div style="padding: 1rem; background: rgba(var(--accent-gold-rgb), 0.1); border-radius: 8px;">
            <p style="margin: 0; font-size: 0.85rem; color: var(--text-dark);">
                <strong>💡 How it works:</strong><br>
                • Create sections like "Senior", "Ladies", "Minis & Juniors"<br>
                • Assign each team to a section in the Team form<br>
                • News articles can be targeted to specific sections<br>
                • Training times on the homepage are grouped by section
            </p>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- OLS 132: DATA MIGRATION STANDALONE SECTION -->
<!-- ============================================ -->
<div id="data-migration" class="admin-section">
    <div class="section-header-bar">
        <div>
            <h2>☁️ Data Migration</h2>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">Sync your local data to cloud storage</p>
        </div>
    </div>

    <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <div style="display: grid; gap: 1.5rem;">
            <!-- Status Card -->
            <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.1), rgba(var(--primary-maroon-rgb), 0.05)); border-radius: 10px; border: 2px solid var(--primary-green);">
                <h3 style="margin: 0 0 1rem 0; color: var(--primary-green);">📊 Storage Status</h3>
                <p style="margin: 0; color: var(--text-dark);">
                    Data is stored in two locations: your browser (localStorage) for instant access, and Netlify Blobs (cloud) for persistence across devices.
                </p>
            </div>
            
            <!-- Migration Actions -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 10px; text-align: center;">
                    <span style="font-size: 2rem; display: block; margin-bottom: 0.5rem;">📤</span>
                    <h4 style="margin: 0 0 0.5rem 0;">Push to Cloud</h4>
                    <p style="margin: 0 0 1rem 0; color: var(--text-light); font-size: 0.9rem;">
                        Upload all local data to cloud storage
                    </p>
                    <button class="btn" onclick="migrateToCloud()">Push Local → Cloud</button>
                </div>
                
                <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 10px; text-align: center;">
                    <span style="font-size: 2rem; display: block; margin-bottom: 0.5rem;">📥</span>
                    <h4 style="margin: 0 0 0.5rem 0;">Pull from Cloud</h4>
                    <p style="margin: 0 0 1rem 0; color: var(--text-light); font-size: 0.9rem;">
                        Download cloud data to this browser
                    </p>
                    <button class="btn btn-secondary" onclick="pullFromCloud()">Pull Cloud → Local</button>
                </div>
            </div>
            
            <!-- Warning -->
            <div style="padding: 1rem; background: rgba(220, 53, 69, 0.1); border-radius: 8px; border-left: 4px solid #dc3545;">
                <p style="margin: 0; font-size: 0.9rem; color: #721c24;">
                    <strong>⚠️ Warning:</strong> Migration overwrites existing data. Make sure you know which direction you want to sync before proceeding.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- VP Modal (OLS 114) -->
<div id="vpModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="vpModalTitle">➕ Add Vice President</h2>
            <button class="close-btn" onclick="closeVPModal()">&times;</button>
        </div>
        <form id="vpForm" onsubmit="saveVP(event)">
            <input type="hidden" id="vpId">
            
            <div class="form-group">
                <label for="vpName">Full Name *</label>
                <input type="text" id="vpName" placeholder="e.g., John Smith" required>
            </div>
            
            <div class="form-group">
                <label for="vpType">VP Type *</label>
                <select id="vpType" required style="width: 100%; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                    <option value="annual">Annual VP</option>
                    <option value="lifetime">Lifetime VP</option>
                </select>
                <small style="color: var(--text-light);">Lifetime VPs are permanent. Annual VPs may need renewal.</small>
            </div>
            
            <div class="form-group">
                <label for="vpNotes">Notes (Optional)</label>
                <textarea id="vpNotes" placeholder="Any additional notes..." rows="3"></textarea>
            </div>
            
            <div class="form-actions" style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeVPModal()">Cancel</button>
                <button type="submit" class="btn">💾 Save Vice President</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Activity Log Styles */
#activityLogTable tbody tr {
    border-bottom: 1px solid #e0e0e0;
    transition: background-color 0.2s;
}

#activityLogTable tbody tr:hover {
    background-color: #f5f5f5;
}

#activityLogTable tbody td {
    padding: 1rem;
    color: var(--text-dark);
}

.action-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: bold;
    text-transform: uppercase;
}

.action-create {
    background: #e8f5e9;
    color: #2e7d32;
}

.action-update {
    background: #e3f2fd;
    color: #1565c0;
}

.action-delete {
    background: #ffebee;
    color: #c62828;
}

.content-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    background: #f5f5f5;
    border-radius: 5px;
    font-size: 0.85rem;
    font-family: monospace;
}
</style>

<script>
// ============================================================
// OLS 104: Activity Log Management Functions
// ============================================================

// Store for filtering
let allActivityLogs = [];

// Load activity logs on page load (for super-admins)
document.addEventListener('DOMContentLoaded', function() {
    // Check if user is super-admin
    const session = JSON.parse(localStorage.getItem('olrfc_admin_session') || '{}');
    if (session.role === 'super-admin') {
        loadActivityLogs();
        loadAdminFilterOptions();
    }
});

/**
 * Load activity logs from backend
 */
async function loadActivityLogs() {
    try {
        console.log('📥 Loading activity logs...');
        
        // Show loading state
        document.getElementById('activityLogTableBody').innerHTML = `
            <tr>
                <td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-light);">
                    ⏳ Loading activity logs...
                </td>
            </tr>
        `;
        
        // Fetch logs from backend
        const response = await fetch('/.netlify/functions/admin-activity-logs?limit=200');
        
        if (!response.ok) {
            throw new Error('Failed to fetch activity logs');
        }
        
        const result = await response.json();
        allActivityLogs = result.data || [];
        
        console.log(`✅ Loaded ${allActivityLogs.length} activity logs`);
        
        // Display logs
        displayActivityLogs(allActivityLogs);
        
    } catch (error) {
        console.error('Error loading activity logs:', error);
        document.getElementById('activityLogTableBody').innerHTML = `
            <tr>
                <td colspan="6" style="padding: 2rem; text-align: center; color: #d32f2f;">
                    ❌ Failed to load activity logs: ${error.message}
                </td>
            </tr>
        `;
    }
}

/**
 * Display activity logs in table
 */
function displayActivityLogs(logs) {
    const tbody = document.getElementById('activityLogTableBody');
    
    if (!logs || logs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-light);">
                    No activity logs found
                </td>
            </tr>
        `;
        document.getElementById('activityLogCount').textContent = 'No logs';
        return;
    }
    
    // Update count
    document.getElementById('activityLogCount').textContent = `Showing ${logs.length} log${logs.length !== 1 ? 's' : ''}`;
    
    // Generate table rows
    tbody.innerHTML = logs.map(log => {
        const timestamp = new Date(log.timestamp);
        const formattedDate = timestamp.toLocaleDateString('en-GB', { 
            day: '2-digit', 
            month: 'short', 
            year: 'numeric' 
        });
        const formattedTime = timestamp.toLocaleTimeString('en-GB', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        const actionClass = `action-${log.actionType}`;
        const actionLabel = log.actionType.charAt(0).toUpperCase() + log.actionType.slice(1);
        
        return `
            <tr>
                <td style="white-space: nowrap;">
                    <div style="font-weight: 500;">${formattedDate}</div>
                    <div style="font-size: 0.85rem; color: var(--text-light);">${formattedTime}</div>
                </td>
                <td>
                    <div style="font-weight: 500;">${log.adminUsername}</div>
                    <div style="font-size: 0.85rem; color: var(--text-light);">${log.adminEmail}</div>
                </td>
                <td>
                    <span class="action-badge ${actionClass}">${actionLabel}</span>
                </td>
                <td>
                    <span class="content-badge">${log.contentType}</span>
                </td>
                <td>
                    ${log.itemTitle ? `<strong>${log.itemTitle}</strong>` : '<em style="color: var(--text-light);">—</em>'}
                </td>
                <td>
                    ${log.description || '<em style="color: var(--text-light);">No description</em>'}
                </td>
            </tr>
        `;
    }).join('');
}

/**
 * Filter activity logs based on dropdown selections
 */
function filterActivityLogs() {
    const adminFilter = document.getElementById('filterByAdmin').value;
    const actionFilter = document.getElementById('filterByAction').value;
    const contentFilter = document.getElementById('filterByContent').value;
    
    let filtered = [...allActivityLogs];
    
    if (adminFilter) {
        filtered = filtered.filter(log => log.adminEmail === adminFilter);
    }
    
    if (actionFilter) {
        filtered = filtered.filter(log => log.actionType === actionFilter);
    }
    
    if (contentFilter) {
        filtered = filtered.filter(log => log.contentType === contentFilter);
    }
    
    console.log(`🔍 Filtered to ${filtered.length} logs`);
    displayActivityLogs(filtered);
}

/**
 * Clear all filters
 */
function clearActivityFilters() {
    document.getElementById('filterByAdmin').value = '';
    document.getElementById('filterByAction').value = '';
    document.getElementById('filterByContent').value = '';
    displayActivityLogs(allActivityLogs);
}

/**
 * Load admin options for filter dropdown
 */
async function loadAdminFilterOptions() {
    try {
        const users = await window.netlifyDataManager.getAdminUsers();
        const select = document.getElementById('filterByAdmin');
        
        // Add options for each admin
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.email;
            option.textContent = `${user.username} (${user.email})`;
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading admin filter options:', error);
    }
}
</script>


        <!-- Contact Modal -->
        <div id="contactModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close" onclick="closeContactModal()">&times;</span>
                <h2 id="contactModalTitle">Add New Contact</h2>
                
                <form id="contactForm" onsubmit="saveContact(event)">
                    <!-- Profile Photo Upload -->
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="display: inline-block; position: relative;">
                            <div id="contactPhotoPreview" style="width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--primary-green); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon)); color: white; font-size: 3rem; font-weight: bold; overflow: hidden;">
                                <span id="contactInitials">?</span>
                                <img id="contactPhotoImg" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                            </div>
                            <input type="file" id="contactPhotoInput" accept="image/*" style="display: none;" onchange="handleContactPhotoUpload(event)">
                            <button type="button" onclick="document.getElementById('contactPhotoInput').click()" class="btn" style="margin: 0;">
                                📷 Upload Photo
                            </button>
                            <button type="button" onclick="removeContactPhoto()" class="btn" style="margin: 0; background: #dc3545; display: none;" id="removePhotoBtn">
                                🗑️ Remove Photo
                            </button>
                        </div>
                        <input type="hidden" id="contactPhotoURL" name="photo">
                        <div id="photoUploadProgress" style="display: none; margin-top: 1rem;">
                            <div style="background: #e0e0e0; border-radius: 10px; height: 8px; overflow: hidden;">
                                <div id="photoProgressBar" style="background: var(--primary-green); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-light);">Uploading photo...</p>
                        </div>
                    </div>

                    <!-- Basic Info -->
                    <div class="form-group">
                        <label for="contactName">Full Name *</label>
                        <input type="text" id="contactName" required placeholder="e.g. John Smith">
                    </div>

                    <div class="form-group">
                        <label for="contactRole">Role/Position *</label>
                        <input type="text" id="contactRole" required placeholder="e.g. OLRFC Chairman">
                    </div>

                    <div class="form-group">
                        <label for="contactCategory">Category *</label>
                        <select id="contactCategory" required onchange="updateCategoryColor()">
                            <option value="">Select a category...</option>
                            <option value="Club Leadership">🏉 Club Leadership</option>
                            <option value="Coaching Staff">📋 Coaching Staff</option>
                            <option value="Senior Section">🏆 Senior Section</option>
                            <option value="Minis & Juniors Section">👦 Minis & Juniors Section</option>
                            <option value="Safeguarding & Welfare">🛡️ Safeguarding & Welfare</option>
                            <option value="Operations & Facilities">⚙️ Operations & Facilities</option>
                            <option value="Communications & Media">📣 Communications & Media</option>
                            <option value="custom">➕ Add New Category...</option>
                        </select>
                    </div>

                    <div class="form-group" id="customCategoryGroup" style="display: none;">
                        <label for="customCategory">New Category Name</label>
                        <input type="text" id="customCategory" placeholder="e.g. Coaching Staff">
                    </div>

                    <!-- Contact Details -->
                    <div class="form-group">
                        <label for="contactEmail">Email (optional)</label>
                        <input type="email" id="contactEmail" placeholder="e.g. chairman@olsrugby.com">
                        <small style="color: var(--text-light);">Leave blank for "Contact via club for details"</small>
                    </div>

                    <div class="form-group">
                        <label for="contactPhone">Phone Number (optional)</label>
                        <input type="tel" id="contactPhone" placeholder="e.g. 07123 456789">
                    </div>

                    <div class="form-group">
                        <label for="contactBio">Bio/Description (optional)</label>
                        <textarea id="contactBio" rows="3" placeholder="Brief description or additional info..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="contactDisplayOrder">Display Order</label>
                        <input type="number" id="contactDisplayOrder" value="999" min="1" placeholder="1 = first, higher = later">
                        <small style="color: var(--text-light);">Lower numbers appear first within their category</small>
                    </div>

                    <input type="hidden" id="contactId">

                    <div class="modal-actions">
                        <button type="submit" class="btn">💾 Save Contact</button>
                        <button type="button" class="btn" onclick="closeContactModal()" style="background: #6c757d;">Cancel</button>
                    </div>
                </form>
            </div>
        </div>



    <!-- All Modals -->
    <!-- News Modal -->
    <div id="newsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📰 Add/Edit News Article</h3>
                <button class="close" onclick="closeModal('newsModal')">&times;</button>
            </div>
            <form id="newsForm">
                <div class="form-group">
                    <label>Title:</label>
                    <input type="text" id="newsTitle" required placeholder="Enter article title">
                </div>
                <div class="form-group">
                    <label>Category:</label>
                    <select id="newsCategory" onchange="toggleNewsFixtureDropdown()">
                        <option value="">Loading categories...</option>
                    </select>
                </div>
                
                <!-- OLS 130: Club Section for News -->
                <div class="form-group">
                    <label>Club Section:</label>
                    <select id="newsClubSection">
                        <option value="all">🏢 All Sections (Club-wide)</option>
                        <!-- Options populated dynamically from club sections config -->
                    </select>
                    <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">
                        Which part of the club is this article relevant to? "All Sections" appears everywhere.
                    </small>
                </div>
                
                <!-- OLS 122: Link Match Report to Fixture -->
                <div class="form-group" id="newsFixtureGroup">
                    <label>Link to Fixture (Optional):</label>
                    <select id="newsFixture">
                        <option value="">-- Select Fixture --</option>
                        <!-- Fixtures will be populated dynamically -->
                    </select>
                    <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                        💡 Link this match report to the relevant fixture
                    </small>
                </div>
                <div class="form-group">
                    <label>Content:</label>
                    <textarea id="newsContent" required placeholder="Write your article content here..."></textarea>
                </div>
                <div class="form-group">
                    <label>Author:</label>
                    <input type="text" id="newsAuthor" value="Club Admin" placeholder="Author name">
                </div>
                <div class="form-group">
                    <label>Publish Date:</label>
                    <input type="date" id="newsPublishDate">
                    <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">
                        Defaults to today. Backdate to publish retrospective articles (e.g. match reports).
                    </small>
                </div>

                <!-- 🎯 NEW: Image Upload Section -->
<div class="form-group">
    <label>Article Image (Optional):</label>
    <div class="file-upload">
        <p>📷 Upload Article Image</p>
        <input type="file" id="newsImage" accept="image/*">
        <p><small>Upload a custom image for this article (JPG, PNG, WebP)</small></p>
    </div>
    <div id="newsImagePreview" style="margin-top: 1rem; display: none;">
        <img id="newsImagePreviewImg" style="max-height: 150px; max-width: 300px; border: 2px solid #ddd; border-radius: 8px; object-fit: cover;">
        <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-light);">
            <span id="newsImageStatus">📷 Image ready to upload</span>
        </p>
    </div>
</div>
<!-- 🎯 END NEW SECTION -->
                <button type="submit" class="btn">💾 Save Article</button>
            </form>
        </div>
    </div>

    <!-- Fixture Modal -->
    <div id="fixtureModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🏉 Add/Edit Fixture</h3>
                <button class="close" onclick="closeModal('fixtureModal')">&times;</button>
            </div>
            <form id="fixtureForm">
                <div class="form-group">
                    <label>Team:</label>
                    <select id="fixtureTeam" required>
                        <!-- Teams will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Opponent:</label>
                    <input type="text" id="fixtureOpponent" required placeholder="e.g., Birmingham RFC">
                </div>
                <div class="form-group">
                    <label>Date & Time:</label>
                    <input type="datetime-local" id="fixtureDateTime" required>
                </div>
                <div class="form-group">
                    <label>Venue:</label>
                    <select id="fixtureVenue">
                        <option value="home">Home</option>
                        <option value="away">Away</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Competition:</label>
                    <input type="text" id="fixtureCompetition" placeholder="e.g., Regional Championship">
                </div>
                <!-- OLS 122: Removed match report dropdown - tagging now done from news form -->
                <!-- Match Status dropdown -->
                <div class="form-group">
                    <label>Match Status:</label>
                    <select id="fixtureMatchStatus" onchange="toggleFixtureScoreFields()">
                        <option value="played">✅ Played</option>
                        <option value="cancelled">❌ Cancelled</option>
                        <option value="postponed">⏸️ Postponed</option>
                    </select>
                </div>
                <div id="fixtureScoreFields">
                    <div class="form-group">
                        <label>Our Score (if played):</label>
                        <input type="number" id="fixtureOurScore" min="0" placeholder="Leave empty if not played">
                    </div>
                    <div class="form-group">
                        <label>Their Score (if played):</label>
                        <input type="number" id="fixtureTheirScore" min="0" placeholder="Leave empty if not played">
                    </div>
                </div>
                
                <!-- OLS 122: Teamsheet Upload -->
                <div class="form-group">
                    <label>Teamsheet (Optional):</label>
                    <div class="file-upload" style="padding: 1rem; border: 2px dashed var(--primary-green); border-radius: 8px; text-align: center; cursor: pointer;">
                        <p style="margin: 0;">📋 Upload Teamsheet Image</p>
                        <input type="file" id="fixtureTeamsheet" accept="image/*" style="display: none;">
                        <p style="margin: 0.5rem 0 0; font-size: 0.85rem; color: var(--text-light);">Click to select image (JPG, PNG, WebP)</p>
                    </div>
                    <div id="teamsheetPreview" style="margin-top: 1rem; display: none;">
                        <img id="teamsheetPreviewImg" style="max-height: 150px; max-width: 100%; border: 2px solid var(--primary-green); border-radius: 8px; object-fit: contain;">
                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; align-items: center;">
                            <span id="teamsheetStatus" style="font-size: 0.85rem; color: var(--text-light);">📋 Teamsheet ready</span>
                            <button type="button" onclick="clearTeamsheet()" style="background: #dc3545; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">✕ Remove</button>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn">💾 Save Fixture</button>
            </form>
        </div>
    </div>

    <!-- Bulk Edit Fixtures Modal - OLS 127 Enhanced -->
    <div id="bulkEditFixturesModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh;">
            <div class="modal-header">
                <h3>📝 Bulk Manage Fixtures</h3>
                <button class="close" onclick="closeModal('bulkEditFixturesModal')">&times;</button>
            </div>
            <div style="margin-bottom: 1rem;">
                <p style="color: var(--text-light);">Add, edit, or delete multiple fixtures at once. Changes are saved together.</p>
            </div>
            
            <!-- Filter Bar -->
            <div style="margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                <label for="bulk-edit-team-filter" style="font-weight: bold; color: var(--primary-green); white-space: nowrap;">Filter by Team:</label>
                <select id="bulk-edit-team-filter" class="team-select" style="padding: 0.6rem 1rem; border: 2px solid var(--primary-green); border-radius: 20px; font-size: 0.9rem; font-weight: bold; background: white; color: var(--primary-green); cursor: pointer; min-width: 200px;">
                    <option value="all">All Teams</option>
                </select>
                <span id="bulk-edit-fixture-count" style="color: var(--text-light); margin-left: auto;"></span>
            </div>
            
            <!-- Spreadsheet Import Summary -->
            <div id="spreadsheetImportSummary" style="display: none;"></div>

            <!-- OLS 127: Action Bar -->
            <div class="bulk-action-bar">
                <button class="btn btn-success" onclick="bulkAddNewRow()">➕ Add Row</button>
                <button class="btn btn-upload" onclick="bulkUploadSpreadsheet()">📤 Upload Spreadsheet</button>
                <button class="btn btn-danger" id="bulkDeleteSelectedBtn" onclick="bulkDeleteSelected()" style="display: none;">🗑️ Delete Selected (<span id="bulkSelectedCount">0</span>)</button>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-left: auto; cursor: pointer;">
                    <input type="checkbox" id="bulkSelectAll" onchange="bulkToggleSelectAll(this.checked)">
                    <span style="font-size: 0.9rem;">Select All</span>
                </label>
            </div>
            
            <!-- Table -->
            <div style="overflow-x: auto; max-height: 55vh; overflow-y: auto;">
                <table id="bulkEditFixturesTable" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead style="position: sticky; top: 0; background: var(--primary-green); color: white; z-index: 10;">
                        <tr>
                            <th class="checkbox-cell" style="padding: 0.8rem; border: 1px solid #ddd; width: 40px;"></th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Team</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Opponent</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Date</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Time</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Venue</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Competition</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Status</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Our Score</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Their Score</th>
                            <th style="padding: 0.8rem; text-align: center; border: 1px solid #ddd; width: 60px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bulkEditFixturesBody">
                        <!-- Rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Footer -->
            <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                <div id="bulkEditChangesCount" style="color: var(--text-light); font-weight: bold;"></div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="closeModal('bulkEditFixturesModal')">Cancel</button>
                    <button class="btn" onclick="saveBulkEditFixtures()">💾 Save All Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Calendar Deduplication Modal -->
    <div id="calendarDedupModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
            <div class="modal-header">
                <h3>📅 Google Calendar Deduplication</h3>
                <button class="close" onclick="closeModal('calendarDedupModal')">&times;</button>
            </div>

            <!-- Summary Stats -->
            <div id="dedupSummary" style="margin-bottom: 1rem;"></div>

            <!-- Results Table -->
            <div style="overflow-y: auto; max-height: 55vh;">
                <table id="dedupResultsTable" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead style="position: sticky; top: 0; background: #6f42c1; color: white; z-index: 10;">
                        <tr>
                            <th style="padding: 0.6rem; border: 1px solid #ddd; width: 40px;">
                                <input type="checkbox" id="dedupSelectAll" onchange="toggleDedupSelectAll(this.checked)" checked>
                            </th>
                            <th style="padding: 0.6rem; text-align: left; border: 1px solid #ddd;">Event Title</th>
                            <th style="padding: 0.6rem; text-align: left; border: 1px solid #ddd;">Date</th>
                            <th style="padding: 0.6rem; text-align: left; border: 1px solid #ddd;">Fixture ID Link</th>
                        </tr>
                    </thead>
                    <tbody id="dedupResultsBody"></tbody>
                </table>
            </div>

            <!-- Actions -->
            <div style="display: flex; gap: 1rem; margin-top: 1rem; align-items: center;">
                <button class="btn btn-danger" onclick="confirmDeleteCalendarDuplicates()" id="dedupDeleteBtn">
                    🗑️ Delete Selected Duplicates (<span id="dedupSelectedCount">0</span>)
                </button>
                <button class="btn btn-secondary" onclick="closeModal('calendarDedupModal')">Cancel</button>
                <span id="dedupProgressText" style="margin-left: auto; color: var(--text-light); font-size: 0.9rem;"></span>
            </div>
        </div>
    </div>

    <!-- OLS 127: Bulk Edit Sponsors Modal -->
    <div id="bulkEditSponsorsModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh;">
            <div class="modal-header">
                <h3>📝 Bulk Manage Sponsors</h3>
                <button class="close" onclick="closeModal('bulkEditSponsorsModal')">&times;</button>
            </div>
            <div style="margin-bottom: 1rem;">
                <p style="color: var(--text-light);">Add, edit, or delete multiple sponsors at once.</p>
            </div>
            
            <div class="bulk-action-bar">
                <button class="btn btn-success" onclick="bulkAddNewSponsorRow()">➕ Add Row</button>
                <button class="btn btn-danger" id="bulkDeleteSelectedSponsorsBtn" onclick="bulkDeleteSelectedSponsors()" style="display: none;">🗑️ Delete Selected (<span id="bulkSelectedSponsorsCount">0</span>)</button>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-left: auto; cursor: pointer;">
                    <input type="checkbox" id="bulkSelectAllSponsors" onchange="bulkToggleSelectAllSponsors(this.checked)">
                    <span style="font-size: 0.9rem;">Select All</span>
                </label>
            </div>
            
            <div style="overflow-x: auto; max-height: 55vh; overflow-y: auto;">
                <table id="bulkEditSponsorsTable" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead style="position: sticky; top: 0; background: var(--primary-green); color: white; z-index: 10;">
                        <tr>
                            <th class="checkbox-cell" style="padding: 0.8rem; border: 1px solid #ddd; width: 40px;"></th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Name</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Tier</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Phone</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Email</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Website</th>
                            <th style="padding: 0.8rem; text-align: center; border: 1px solid #ddd;">Active</th>
                            <th style="padding: 0.8rem; text-align: center; border: 1px solid #ddd;">Banner</th>
                            <th style="padding: 0.8rem; text-align: center; border: 1px solid #ddd; width: 60px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bulkEditSponsorsBody"></tbody>
                </table>
            </div>
            
            <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                <div id="bulkEditSponsorsChangesCount" style="color: var(--text-light); font-weight: bold;">No changes made</div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="closeModal('bulkEditSponsorsModal')">Cancel</button>
                    <button class="btn" onclick="saveBulkEditSponsors()">💾 Save All Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- OLS 127: Bulk Edit Contacts Modal -->
    <div id="bulkEditContactsModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh;">
            <div class="modal-header">
                <h3>📝 Bulk Manage Contacts</h3>
                <button class="close" onclick="closeModal('bulkEditContactsModal')">&times;</button>
            </div>
            <div style="margin-bottom: 1rem;">
                <p style="color: var(--text-light);">Add, edit, or delete multiple contacts at once.</p>
            </div>
            
            <div class="bulk-action-bar">
                <button class="btn btn-success" onclick="bulkAddNewContactRow()">➕ Add Row</button>
                <button class="btn btn-danger" id="bulkDeleteSelectedContactsBtn" onclick="bulkDeleteSelectedContacts()" style="display: none;">🗑️ Delete Selected (<span id="bulkSelectedContactsCount">0</span>)</button>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-left: auto; cursor: pointer;">
                    <input type="checkbox" id="bulkSelectAllContacts" onchange="bulkToggleSelectAllContacts(this.checked)">
                    <span style="font-size: 0.9rem;">Select All</span>
                </label>
            </div>
            
            <div style="overflow-x: auto; max-height: 55vh; overflow-y: auto;">
                <table id="bulkEditContactsTable" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead style="position: sticky; top: 0; background: var(--primary-green); color: white; z-index: 10;">
                        <tr>
                            <th class="checkbox-cell" style="padding: 0.8rem; border: 1px solid #ddd; width: 40px;"></th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Name</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Role</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Category</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Email</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Phone</th>
                            <th style="padding: 0.8rem; text-align: center; border: 1px solid #ddd;">Order</th>
                            <th style="padding: 0.8rem; text-align: center; border: 1px solid #ddd; width: 60px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bulkEditContactsBody"></tbody>
                </table>
            </div>
            
            <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                <div id="bulkEditContactsChangesCount" style="color: var(--text-light); font-weight: bold;">No changes made</div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="closeModal('bulkEditContactsModal')">Cancel</button>
                    <button class="btn" onclick="saveBulkEditContacts()">💾 Save All Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- OLS 127: Bulk Edit VPs Modal -->
    <div id="bulkEditVPsModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
            <div class="modal-header">
                <h3>📝 Bulk Manage Vice Presidents</h3>
                <button class="close" onclick="closeModal('bulkEditVPsModal')">&times;</button>
            </div>
            <div style="margin-bottom: 1rem;">
                <p style="color: var(--text-light);">Add, edit, or delete multiple VPs at once.</p>
            </div>
            
            <div class="bulk-action-bar">
                <button class="btn btn-success" onclick="bulkAddNewVPRow()">➕ Add Row</button>
                <button class="btn btn-danger" id="bulkDeleteSelectedVPsBtn" onclick="bulkDeleteSelectedVPs()" style="display: none;">🗑️ Delete Selected (<span id="bulkSelectedVPsCount">0</span>)</button>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-left: auto; cursor: pointer;">
                    <input type="checkbox" id="bulkSelectAllVPs" onchange="bulkToggleSelectAllVPs(this.checked)">
                    <span style="font-size: 0.9rem;">Select All</span>
                </label>
            </div>
            
            <div style="overflow-x: auto; max-height: 55vh; overflow-y: auto;">
                <table id="bulkEditVPsTable" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead style="position: sticky; top: 0; background: var(--primary-green); color: white; z-index: 10;">
                        <tr>
                            <th class="checkbox-cell" style="padding: 0.8rem; border: 1px solid #ddd; width: 40px;"></th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Name</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Type</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Notes</th>
                            <th style="padding: 0.8rem; text-align: center; border: 1px solid #ddd; width: 60px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bulkEditVPsBody"></tbody>
                </table>
            </div>
            
            <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                <div id="bulkEditVPsChangesCount" style="color: var(--text-light); font-weight: bold;">No changes made</div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="closeModal('bulkEditVPsModal')">Cancel</button>
                    <button class="btn" onclick="saveBulkEditVPs()">💾 Save All Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- OLS 127: Bulk Edit Players Modal -->
    <div id="bulkEditPlayersModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh;">
            <div class="modal-header">
                <h3>📝 Bulk Manage Players</h3>
                <button class="close" onclick="closeModal('bulkEditPlayersModal')">&times;</button>
            </div>
            <div style="margin-bottom: 1rem;">
                <p style="color: var(--text-light);">Add, edit, or delete multiple players at once.</p>
            </div>
            
            <!-- Filter Bar -->
            <div style="margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                <label for="bulk-edit-player-team-filter" style="font-weight: bold; color: var(--primary-green); white-space: nowrap;">Filter by Team:</label>
                <select id="bulk-edit-player-team-filter" style="padding: 0.6rem 1rem; border: 2px solid var(--primary-green); border-radius: 20px; font-size: 0.9rem; font-weight: bold; background: white; color: var(--primary-green); cursor: pointer; min-width: 200px;">
                    <option value="all">All Teams</option>
                </select>
                <span id="bulk-edit-player-count" style="color: var(--text-light); margin-left: auto;"></span>
            </div>
            
            <div class="bulk-action-bar">
                <button class="btn btn-success" onclick="bulkAddNewPlayerRow()">➕ Add Row</button>
                <button class="btn btn-danger" id="bulkDeleteSelectedPlayersBtn" onclick="bulkDeleteSelectedPlayers()" style="display: none;">🗑️ Delete Selected (<span id="bulkSelectedPlayersCount">0</span>)</button>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-left: auto; cursor: pointer;">
                    <input type="checkbox" id="bulkSelectAllPlayers" onchange="bulkToggleSelectAllPlayers(this.checked)">
                    <span style="font-size: 0.9rem;">Select All</span>
                </label>
            </div>
            
            <div style="overflow-x: auto; max-height: 50vh; overflow-y: auto;">
                <table id="bulkEditPlayersTable" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead style="position: sticky; top: 0; background: var(--primary-green); color: white; z-index: 10;">
                        <tr>
                            <th class="checkbox-cell" style="padding: 0.8rem; border: 1px solid #ddd; width: 40px;"></th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Name</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Team</th>
                            <th style="padding: 0.8rem; text-align: left; border: 1px solid #ddd;">Position</th>
                            <th style="padding: 0.8rem; text-align: center; border: 1px solid #ddd;">Appearances</th>
                            <th style="padding: 0.8rem; text-align: center; border: 1px solid #ddd; width: 60px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bulkEditPlayersBody"></tbody>
                </table>
            </div>
            
            <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                <div id="bulkEditPlayersChangesCount" style="color: var(--text-light); font-weight: bold;">No changes made</div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="closeModal('bulkEditPlayersModal')">Cancel</button>
                    <button class="btn" onclick="saveBulkEditPlayers()">💾 Save All Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gallery Modal -->
    <div id="galleryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="galleryModalTitle">📸 Upload Photos</h3>
                <button class="close" onclick="closeModal('galleryModal')">&times;</button>
            </div>
            <form id="galleryForm">
                <input type="hidden" id="galleryEditIndex" value="">
                <div class="form-group">
                    <label>Album Title:</label>
                    <input type="text" id="galleryTitle" required placeholder="e.g., Match vs Birmingham RFC">
                </div>
                <div class="form-group">
                    <label>Category:</label>
                    <select id="galleryCategory">
                        <option value="matches">Match Day</option>
                        <option value="training">Training</option>
                        <option value="social">Social Events</option>
                        <option value="team">Team Photos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Team:</label>
                    <select id="galleryTeam">
                        <!-- Teams will be populated dynamically -->
                        <option value="other">Other (Club-wide/Social)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Link to Fixture (Optional):</label>
                    <select id="galleryFixture">
                        <option value="">None - Not linked to a fixture</option>
                        <!-- Fixtures will be dynamically loaded here -->
                    </select>
                    <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                        💡 Link this album to a match fixture to show photos on the fixture page
                    </small>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="galleryDescription" placeholder="Brief description of the album..."></textarea>
                </div>
                
                <!-- Cover Photo Selection (only shown in edit mode) -->
                <div class="form-group" id="coverPhotoSection" style="display: none;">
                    <label>Album Cover Photo:</label>
                    <div id="coverPhotoGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                        <!-- Cover photo options will be displayed here -->
                    </div>
                    <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                        Click on a photo to set it as the album cover
                    </small>
                </div>
                
                <!-- File upload (required for new albums, hidden in edit mode) -->
                <div class="form-group" id="fileUploadSection">
                    <div class="file-upload">
                        <p>📸 Upload Photos</p>
                        <input type="file" id="galleryFiles" multiple accept="image/*">
                        <p><small>Select multiple photos (JPG, PNG, WebP)</small></p>
                    </div>
                </div>
                
                <button type="submit" class="btn" id="gallerySubmitBtn">📤 Upload Album</button>
            </form>
        </div>
    </div>

    <!-- Player Modal -->
    <div id="playerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>👥 Add/Edit Player</h3>
                <button class="close" onclick="closeModal('playerModal')">&times;</button>
            </div>
            <form id="playerForm">
                <div class="form-group">
                    <label>Player Name:</label>
                    <input type="text" id="playerName" required placeholder="e.g., John Smith">
                </div>
                <div class="form-group">
                    <label>Team:</label>
                    <select id="playerTeam">
                        <!-- Teams will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Position:</label>
                    <input type="text" id="playerPosition" placeholder="e.g., Fly-half, Hooker, Prop">
                </div>
                <div class="form-group">
                    <label>Appearances:</label>
                    <input type="number" id="playerApps" min="0" value="0" placeholder="Number of appearances">
                </div>
                <div class="form-group">
                    <div class="file-upload">
                        <p>📷 Player Photo</p>
                        <input type="file" id="playerPhoto" accept="image/*">
                        <div style="margin-top: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; cursor: pointer;">
                                <input type="checkbox" id="playerPhotoRemoveBg" checked style="width: auto; cursor: pointer;">
                                <span>🎨 Remove background automatically (recommended)</span>
                            </label>
                            <small style="display: block; margin-top: 0.25rem; color: var(--text-light);">
                                Removes blue/green screen backgrounds for professional player cards
                            </small>
                        </div>
                        <div id="playerPhotoPreview" style="margin-top: 1rem; display: none;">
                            <img id="playerPhotoPreviewImg" style="max-width: 200px; max-height: 200px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        </div>
                        <p><small>Upload a player photo (optional)</small></p>
                    </div>
                </div>
                <button type="submit" class="btn">💾 Save Player</button>
            </form>
        </div>
    </div>

    <!-- Teams Modal -->
    <div id="teamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🏉 Add/Edit Team</h3>
                <button class="close" onclick="closeModal('teamModal')">&times;</button>
            </div>
            <form id="teamForm">
                <div class="form-group">
                    <label>Team Name:</label>
                    <input type="text" id="teamName" required placeholder="e.g., Mens 1st XV">
                    <small>This will appear in navigation and on public pages</small>
                </div>
                
                <div class="form-group">
                    <label>Team Slug (URL-friendly):</label>
                    <input type="text" id="teamSlug" required placeholder="e.g., mens-1st">
                    <small>Used in URLs. Use lowercase, numbers, and hyphens only (auto-generated from name)</small>
                </div>
                
                <!-- OLS 130: Club Section -->
                <div class="form-group">
                    <label>Club Section:</label>
                    <select id="teamClubSection">
                        <option value="">— No Section —</option>
                        <!-- Options populated dynamically from club sections config -->
                    </select>
                    <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">
                        Which part of the club does this team belong to? (Senior, Ladies, Minis, etc.)
                        <a href="#" onclick="showSection('teams'); setTimeout(toggleClubSectionsPanel, 100); return false;" style="color: var(--primary-green);">
                            Configure sections →
                        </a>
                    </small>
                </div>
                
                <!-- OLS 125: Display Order Field -->
                <div class="form-group">
                    <label>Display Order:</label>
                    <input type="number" id="teamDisplayOrder" min="1" max="99" value="10" placeholder="10" style="max-width: 100px;">
                    <small style="display: block; margin-top: 0.25rem; color: var(--text-light);">
                        Controls order in all dropdowns and widgets (1 = first, lower numbers appear first)
                    </small>
                </div>
                
                <div class="form-group">
                    <label>Team Description (Optional):</label>
                    <textarea id="teamDescription" placeholder="Brief description of the team..." rows="3"></textarea>
                </div>
                
                <!-- OLS 131: Multi-Slot Training Schedule -->
                <div style="margin-top: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(var(--accent-gold-rgb), 0.1), rgba(var(--primary-green-rgb), 0.05)); border-radius: 10px; border: 2px solid var(--accent-gold);">
                    <h4 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        ⏰ Training Schedule
                    </h4>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="teamShowInTraining" onchange="toggleTeamTrainingFields()">
                            <strong>Show in training times section</strong>
                        </label>
                        <small style="display: block; margin-top: 0.25rem; color: var(--text-light); margin-left: 1.5rem;">Include this team in the homepage training times display</small>
                    </div>
                    
                    <!-- Training fields shown when showInTraining is checked -->
                    <div id="teamTrainingFields" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--accent-gold);">
                        <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 1rem; padding: 0.75rem; background: rgba(0,0,0,0.03); border-radius: 6px;">
                            💡 Add one or more training sessions. Teams with identical schedules will be grouped together.
                        </p>
                        
                        <div id="trainingSlotsList" style="margin-bottom: 1rem;">
                            <!-- Slots added dynamically -->
                        </div>
                        
                        <button type="button" onclick="addTrainingSlot()" style="padding: 0.5rem 1rem; background: var(--primary-green); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                            ➕ Add Training Session
                        </button>
                        
                        <div class="form-group" style="margin-top: 1rem;">
                            <label>Notes (Optional):</label>
                            <input type="text" id="teamTrainingNotes" placeholder="e.g., Touch only, All welcome">
                            <small>Shown next to team name</small>
                        </div>
                    </div>
                </div>
                
                <script>
                let trainingSlotCount = 0;
                
                function toggleTeamTrainingFields() {
                    const showInTraining = document.getElementById('teamShowInTraining').checked;
                    document.getElementById('teamTrainingFields').style.display = showInTraining ? 'block' : 'none';
                    
                    // Add first slot if none exist
                    if (showInTraining && document.querySelectorAll('.training-slot').length === 0) {
                        addTrainingSlot();
                    }
                }
                
                function addTrainingSlot(day = '', startTime = '', endTime = '') {
                    trainingSlotCount++;
                    const slotId = trainingSlotCount;
                    
                    const slotHtml = `
                        <div class="training-slot" id="trainingSlot-${slotId}" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #e0e0e0; flex-wrap: wrap;">
                            <select class="slot-day" style="padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem; min-width: 120px;">
                                <option value="">Select day...</option>
                                <option value="Monday" ${day === 'Monday' ? 'selected' : ''}>Monday</option>
                                <option value="Tuesday" ${day === 'Tuesday' ? 'selected' : ''}>Tuesday</option>
                                <option value="Wednesday" ${day === 'Wednesday' ? 'selected' : ''}>Wednesday</option>
                                <option value="Thursday" ${day === 'Thursday' ? 'selected' : ''}>Thursday</option>
                                <option value="Friday" ${day === 'Friday' ? 'selected' : ''}>Friday</option>
                                <option value="Saturday" ${day === 'Saturday' ? 'selected' : ''}>Saturday</option>
                                <option value="Sunday" ${day === 'Sunday' ? 'selected' : ''}>Sunday</option>
                            </select>
                            <input type="time" class="slot-start" value="${startTime}" style="padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem;">
                            <span style="color: var(--text-light);">to</span>
                            <input type="time" class="slot-end" value="${endTime}" style="padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem;">
                            <button type="button" onclick="removeTrainingSlot(${slotId})" style="padding: 0.4rem 0.6rem; background: #ff4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;" title="Remove">🗑️</button>
                        </div>
                    `;
                    
                    document.getElementById('trainingSlotsList').insertAdjacentHTML('beforeend', slotHtml);
                }
                
                function removeTrainingSlot(slotId) {
                    const slot = document.getElementById(`trainingSlot-${slotId}`);
                    if (slot) slot.remove();
                }
                
                function getTrainingSlots() {
                    const slots = [];
                    document.querySelectorAll('.training-slot').forEach(slot => {
                        const day = slot.querySelector('.slot-day').value;
                        const startTime = slot.querySelector('.slot-start').value;
                        const endTime = slot.querySelector('.slot-end').value;
                        if (day) { // Only include slots with a day selected
                            slots.push({ day, startTime, endTime });
                        }
                    });
                    return slots;
                }
                
                function clearTrainingSlots() {
                    document.getElementById('trainingSlotsList').innerHTML = '';
                    trainingSlotCount = 0;
                }
                
                function loadTrainingSlots(slots) {
                    clearTrainingSlots();
                    if (Array.isArray(slots) && slots.length > 0) {
                        slots.forEach(slot => {
                            addTrainingSlot(slot.day, slot.startTime, slot.endTime);
                        });
                    }
                }
                </script>
                
                <div class="form-group">
                    <div class="file-upload">
                        <p>📷 Team Photo (Optional)</p>
                        <input type="file" id="teamPhoto" accept="image/*">
                        <p><small>Upload a team photo or logo</small></p>
                    </div>
                </div>
                
                <button type="submit" class="btn">💾 Save Team</button>
            </form>
        </div>
    </div>

    <!-- Display Filters Modal -->
    <div id="filterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🎯 Add/Edit Display Filter</h3>
                <button class="close" onclick="closeModal('filterModal')">&times;</button>
            </div>
            <form id="filterForm">
                <input type="hidden" id="filterEditIndex" value="">
                
                <div class="form-group">
                    <label>Filter Name:</label>
                    <input type="text" id="filterName" required 
                           placeholder="e.g., Senior Squad">
                    <small>This appears as a tab on the Teams page</small>
                </div>

                <div class="form-group">
                    <label>Description (Optional):</label>
                    <textarea id="filterDescription" rows="2" 
                              placeholder="Brief description"></textarea>
                </div>

                <div class="form-group">
                    <label>Include Teams:</label>
                    <div id="filterTeamCheckboxes" class="checkbox-group"></div>
                    <small>Select which teams to include in this filter</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="filterEnabled" checked>
                        Enabled (show on public page)
                    </label>
                </div>

                <button type="submit" class="btn">💾 Save Filter</button>
            </form>
        </div>
    </div>

    <!-- Shop Modal -->
    <div id="shopModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>🛒 Add/Edit Product</h3>
                <button class="close" onclick="closeModal('shopModal')">&times;</button>
            </div>
            <form id="shopForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Product Name:</label>
                        <input type="text" id="shopProductName" required placeholder="e.g., Home Jersey 2025">
                    </div>
                    <div class="form-group">
                        <label>Category:</label>
                        <select id="shopCategory">
                            <option value="jerseys">Jerseys</option>
                            <option value="training">Training Gear</option>
                            <option value="accessories">Accessories</option>
                            <option value="supporters">Supporters Gear</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="shopDescription" placeholder="Product description, features, materials, etc."></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Price (£):</label>
                        <input type="number" id="shopPrice" step="0.01" min="0" required placeholder="39.99">
                    </div>
                    <div class="form-group">
                        <label>Stock Quantity:</label>
                        <input type="number" id="shopStock" min="0" required placeholder="25">
                    </div>
                    <div class="form-group">
                        <label>SKU/Code:</label>
                        <input type="text" id="shopSku" placeholder="OLS-HJ-2025">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Available Sizes:</label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.3rem;">
                                <input type="checkbox" id="sizeXS" value="XS"> XS
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.3rem;">
                                <input type="checkbox" id="sizeS" value="S"> S
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.3rem;">
                                <input type="checkbox" id="sizeM" value="M"> M
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.3rem;">
                                <input type="checkbox" id="sizeL" value="L"> L
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.3rem;">
                                <input type="checkbox" id="sizeXL" value="XL"> XL
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.3rem;">
                                <input type="checkbox" id="sizeXXL" value="XXL"> XXL
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Status:</label>
                        <select id="shopStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="out-of-stock">Out of Stock</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <div class="file-upload">
                        <p>📷 Product Images</p>
                        <input type="file" id="shopImages" multiple accept="image/*">
                        <p><small>Upload product photos (multiple images allowed)</small></p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Weight (kg):</label>
                        <input type="number" id="shopWeight" step="0.1" min="0" placeholder="0.5">
                    </div>
                    <div class="form-group">
                        <label>Shipping Cost (£):</label>
                        <input type="number" id="shopShipping" step="0.01" min="0" placeholder="4.99">
                    </div>
                </div>

                <button type="submit" class="btn" style="width: 100%;">💾 Save Product</button>
            </form>
        </div>
    </div>

    <!-- Sponsor Modal -->
    <div id="sponsorModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>🤝 Add/Edit Sponsor</h3>
                <button class="close" onclick="closeModal('sponsorModal')">&times;</button>
            </div>
            <form id="sponsorForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Company Name:</label>
                        <input type="text" id="sponsorName" required placeholder="e.g., Local Sports Equipment">
                    </div>
                    <div class="form-group">
                        <label>Sponsor Tier:</label>
                        <select id="sponsorTier" required>
                            <option value="bronze">🥉 Bronze</option>
                            <option value="silver">🥈 Silver</option>
                            <option value="gold">🥇 Gold</option>
                            <option value="platinum">💎 Platinum</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Phone Number:</label>
                        <input type="tel" id="sponsorPhone" placeholder="01234 567890">
                    </div>
                    <div class="form-group">
                        <label>Email Address:</label>
                        <input type="email" id="sponsorEmail" placeholder="contact@company.com">
                    </div>
                </div>

                <div class="form-group">
                    <label>Website URL:</label>
                    <input type="url" id="sponsorWebsite" placeholder="https://www.company.com">
                </div>

                <div class="form-group">
                    <div class="file-upload">
                        <p>📎 Upload Company Logo</p>
                        <input type="file" id="sponsorLogo" accept="image/*">
                        <p><small>PNG, JPG, or SVG files recommended. Best size: 200x100px</small></p>
                    </div>
                    <div id="logoPreview" style="margin-top: 1rem; display: none;">
                        <img id="logoPreviewImg" style="max-height: 80px; max-width: 160px; border: 2px solid #ddd; border-radius: 8px;">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="sponsorActive" checked>
                            Active Sponsor (show on website)
                        </label>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="sponsorBanner" checked>
                            Show in homepage banner
                        </label>
                    </div>
                </div>

                <button type="submit" class="btn" style="width: 100%;">💾 Save Sponsor</button>
            </form>
        </div>
    </div>

    <!-- OLS 128: News Category Modal -->
    <div id="newsCategoryModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="newsCategoryModalTitle">🏷️ Add News Category</h3>
                <button class="close" onclick="closeNewsCategoryModal()">&times;</button>
            </div>
            <form id="newsCategoryForm" onsubmit="saveNewsCategory(event)">
                <input type="hidden" id="editingCategoryId" value="">
                
                <div class="form-group">
                    <label>Category ID:</label>
                    <input type="text" id="categoryId" required placeholder="e.g., match, social, youth" pattern="[a-z0-9-]+" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <small style="color: var(--text-light);">Lowercase letters, numbers, and hyphens only. Used internally.</small>
                </div>
                
                <div class="form-group">
                    <label>Display Name:</label>
                    <input type="text" id="categoryName" required placeholder="e.g., Match Report, Social Event" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div class="form-group">
                    <label>Icon (Emoji):</label>
                    <input type="text" id="categoryIcon" required placeholder="e.g., 🏉, 🎉, 📢" maxlength="4" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1.5rem;">
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="categoryShowFilter" checked>
                        Show as filter button on News page
                    </label>
                </div>
                
                <button type="submit" class="btn" style="width: 100%;">💾 Save Category</button>
            </form>
        </div>
    </div>
    <!-- END News Category Modal -->

    <!-- OLS 130: Club Section Modal -->
    <div id="clubSectionModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="clubSectionModalTitle">🏢 Add Club Section</h3>
                <button class="close" onclick="closeClubSectionModal()">&times;</button>
            </div>
            <form id="clubSectionForm" onsubmit="saveClubSection(event)">
                <input type="hidden" id="editingClubSectionId" value="">
                
                <div class="form-group">
                    <label>Section ID:</label>
                    <input type="text" id="clubSectionId" required placeholder="e.g., senior, ladies, minis" pattern="[a-z0-9-]+" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <small style="color: var(--text-light);">Lowercase letters, numbers, and hyphens only. Used internally.</small>
                </div>
                
                <div class="form-group">
                    <label>Display Name:</label>
                    <input type="text" id="clubSectionName" required placeholder="e.g., Senior, Ladies, Minis & Juniors" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div class="form-group">
                    <label>Icon (Emoji):</label>
                    <input type="text" id="clubSectionIcon" placeholder="e.g., 🏉, 👩, 👶 (optional)" maxlength="4" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1.5rem;">
                </div>

                <div class="form-group">
                    <label>Calendar Colour:</label>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <input type="color" id="clubSectionColor" value="#e53935" oninput="document.getElementById('clubSectionColorHex').textContent = this.value" style="width: 50px; height: 40px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; padding: 2px;">
                        <span id="clubSectionColorHex" style="font-size: 0.85rem; color: var(--text-light); font-family: monospace;">#e53935</span>
                    </div>
                    <small style="color: var(--text-light);">Used to colour fixtures on the website calendar and event filters</small>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="clubSectionShowFilter" checked>
                        Show as filter option on News page
                    </label>
                    <small style="color: var(--text-light);">When enabled, users can filter news by this section</small>
                </div>
                
                <!-- OLS 131: Display Order for Training Section -->
                <div style="margin-top: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(var(--accent-gold-rgb), 0.1), rgba(var(--primary-green-rgb), 0.05)); border-radius: 10px; border: 2px solid var(--accent-gold);">
                    <h4 style="color: var(--primary-green); margin-bottom: 1rem; font-size: 1rem;">⏰ Training Display Order</h4>
                    <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 1rem;">
                        Controls where this section appears in the homepage training times. Teams with training enabled will be grouped under their section.
                    </p>
                    
                    <div class="form-group">
                        <label>Display Order:</label>
                        <input type="number" id="clubSectionTrainingSortOrder" min="1" max="99" value="10" placeholder="10" style="width: 100px; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">1 = first, higher = later</small>
                    </div>
                </div>
                
                <button type="submit" class="btn" style="width: 100%; margin-top: 1rem;">💾 Save Section</button>
            </form>
        </div>
    </div>
    <!-- END OLS 130: Club Section Modal -->

    <script>
        // Updated AdminSystem Class with Shop and Sponsor Management
        class AdminSystem {
            constructor() {
                this.currentEditIndex = null;
                this.currentSection = null;
                this.initializeData();
                this.loadAllData();
                this.updateStats();
                this.loadUserInfo();
            }

            loadUserInfo() {
                const session = JSON.parse(localStorage.getItem('olrfc_admin_session') || '{}');
                if (session.username) {
                    document.getElementById('currentUser').textContent = session.username;
                }
            }

            initializeData() {
    // Disabled for production - no auto-creation of empty arrays
}

            getData(key) {
                try {
                    const data = JSON.parse(localStorage.getItem(`olrfc_${key}`)) || [];
                    
                    // 🔧 DEDUPLICATE by ID to prevent showing duplicates
                    if (data.length > 0 && data[0].id) {
                        const seen = new Map();
                        const deduplicated = [];
                        
                        for (const item of data) {
                            if (!seen.has(item.id)) {
                                seen.set(item.id, true);
                                deduplicated.push(item);
                            }
                        }
                        
                        // If we found duplicates, save the cleaned version
                        if (deduplicated.length < data.length) {
                            console.log(`🧹 Removed ${data.length - deduplicated.length} duplicate ${key} items`);
                            localStorage.setItem(`olrfc_${key}`, JSON.stringify(deduplicated));
                        }
                        
                        return deduplicated;
                    }
                    
                    return data;
                } catch (e) {
                    console.error(`Error loading ${key} data:`, e);
                    return [];
                }
            }

            saveData(key, data) {
                try {
                    localStorage.setItem(`olrfc_${key}`, JSON.stringify(data));
                    this.updateStats();
                    this.showAlert(key, 'Data saved successfully!', 'success');
                } catch (e) {
                    console.error(`Error saving ${key} data:`, e);
                    this.showAlert(key, 'Error saving data. Storage might be full.', 'danger');
                }
            }

            showAlert(section, message, type = 'success') {
                const alertId = section + 'Alert';
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.className = `alert alert-${type}`;
                    alertElement.textContent = message;
                    alertElement.style.display = 'block';
                    setTimeout(() => {
                        alertElement.style.display = 'none';
                    }, 5000);
                }
            }

           updateStats() {
    console.log('🔄 updateStats() called at:', new Date().toISOString());
    
    // Read directly from localStorage to get accurate counts
    const news = JSON.parse(localStorage.getItem('olrfc_news')) || [];
    const fixtures = JSON.parse(localStorage.getItem('olrfc_fixtures')) || [];
    const gallery = JSON.parse(localStorage.getItem('olrfc_gallery')) || [];
    const players = JSON.parse(localStorage.getItem('olrfc_players')) || [];
    const teams = JSON.parse(localStorage.getItem('olrfc_teams')) || [];
    const shop = JSON.parse(localStorage.getItem('olrfc_shop')) || [];
    const sponsors = JSON.parse(localStorage.getItem('olrfc_sponsors')) || [];
    
    console.log('📊 Data counts from localStorage:', {
        news: news.length,
        fixtures: fixtures.length,
        gallery: gallery.length,
        players: players.length,
        teams: teams.length,
        shop: shop.length,
        sponsors: sponsors.length
    });
    
    // Update dashboard stat cards with null checks
    const newsCountEl = document.getElementById('newsCount');
    const fixturesCountEl = document.getElementById('fixturesCount');
    const galleryCountEl = document.getElementById('galleryCount');
    const playersCountEl = document.getElementById('playersCount');
    const teamsCountEl = document.getElementById('teamsCount');
    const shopCountEl = document.getElementById('shopCount');
    const sponsorsCountEl = document.getElementById('sponsorsCount');
    const contactsCountEl = document.getElementById('contactsCount');

    
    if (newsCountEl) newsCountEl.textContent = news.length;
    if (fixturesCountEl) fixturesCountEl.textContent = fixtures.length;
    if (galleryCountEl) galleryCountEl.textContent = gallery.length;
    if (playersCountEl) playersCountEl.textContent = players.length;
    if (teamsCountEl) teamsCountEl.textContent = teams.length;
    if (shopCountEl) shopCountEl.textContent = shop.length;
    if (sponsorsCountEl) sponsorsCountEl.textContent = sponsors.length;
    if (contactsCountEl) contactsCountEl.textContent = contactsManager.getAllContacts().filter(c => c.active).length;
    // Note: Enquiries count is updated by updateNewEnquiriesBadge() which runs on page load and every 2 minutes
    
    console.log('✅ Stats UI updated successfully');
    
    // Update shop-specific stats if on shop section
    this.updateShopStats();
    
    // Update sponsor-specific stats if on sponsors section
    this.updateSponsorStats();
}

forceStatsRefresh() {
    console.log('🔄 Force refresh triggered');
    this.updateStats();
}
            updateShopStats() {
                const shop = this.getData('shop');
                
                if (document.getElementById('totalProducts')) {
                    document.getElementById('totalProducts').textContent = shop.length;
                }
                
                if (document.getElementById('totalValue')) {
                    const totalValue = shop.reduce((sum, product) => {
                        return sum + (parseFloat(product.price) * parseInt(product.stock));
                    }, 0);
                    document.getElementById('totalValue').textContent = `£${totalValue.toFixed(2)}`;
                }
                
                if (document.getElementById('categoriesCount')) {
                    const categories = new Set(shop.map(product => product.category));
                    document.getElementById('categoriesCount').textContent = categories.size;
                }
                
                if (document.getElementById('lowStockCount')) {
                    const lowStock = shop.filter(product => parseInt(product.stock) < 5);
                    document.getElementById('lowStockCount').textContent = lowStock.length;
                }
            }

            updateSponsorStats() {
                const sponsors = this.getData('sponsors');
                
                if (document.getElementById('totalSponsors')) {
                    document.getElementById('totalSponsors').textContent = sponsors.length;
                }
                
                if (document.getElementById('activeSponsors')) {
                    const activeCount = sponsors.filter(sponsor => sponsor.active).length;
                    document.getElementById('activeSponsors').textContent = activeCount;
                }
                
                if (document.getElementById('platinumCount')) {
                    const platinumCount = sponsors.filter(sponsor => sponsor.tier === 'platinum').length;
                    document.getElementById('platinumCount').textContent = platinumCount;
                }
                
                if (document.getElementById('goldCount')) {
                    const goldCount = sponsors.filter(sponsor => sponsor.tier === 'gold').length;
                    document.getElementById('goldCount').textContent = goldCount;
                }
            }

            loadAllData() {
                this.loadNews();
                // Get current filter value
                const currentFilter = document.getElementById('admin-team-filter')?.value || 'all';
                this.loadFixtures(currentFilter, currentFixtureTimeFilter);
                this.loadGallery();
                this.loadPlayers();
                this.loadTeams();
                this.loadFilters();
                this.loadShop();
                this.loadSponsors();
                
                // Update all team dropdowns after teams are loaded (if functions exist)
                if (typeof updatePlayerTeamDropdown === 'function') updatePlayerTeamDropdown();
                if (typeof updateFixtureTeamDropdown === 'function') updateFixtureTeamDropdown();
                if (typeof updateGalleryTeamDropdown === 'function') updateGalleryTeamDropdown();
            }

            loadSponsors() {
                const sponsors = this.getData('sponsors');
                const sponsorsList = document.getElementById('sponsorsList');
                if (!sponsorsList) return;

                sponsorsList.innerHTML = '';

                if (sponsors.length === 0) {
                    sponsorsList.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 2rem;">No sponsors yet. Click "Add Sponsor" to get started!</p>';
                    return;
                }

                sponsors.forEach((sponsor, index) => {
                    const item = document.createElement('div');
                    item.className = 'content-item sponsor-item';
                    item.dataset.tier = sponsor.tier;
                    
                    const logoDisplay = sponsor.logo 
                        ? `<img src="${sponsor.logo}" alt="${sponsor.name}" style="width: 80px; height: 40px; object-fit: contain; border-radius: 6px; margin-right: 1rem; border: 1px solid #ddd;">`
                        : `<div style="width: 80px; height: 40px; background: linear-gradient(45deg, var(--primary-green), var(--primary-maroon)); border-radius: 6px; margin-right: 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; text-align: center;">${sponsor.name}</div>`;

                    item.innerHTML = `
                        <div style="display: flex; align-items: center;">
                            ${logoDisplay}
                            <div class="content-info">
                                <h4>🤝 ${sponsor.name}</h4>
                                <p><strong>Tier:</strong> <span class="sponsor-tier-badge tier-${sponsor.tier}">${this.formatSponsorTier(sponsor.tier)}</span></p>
                                <p><strong>Contact:</strong> ${sponsor.phone || 'N/A'} | ${sponsor.email || 'N/A'}</p>
                                <small><strong>Status:</strong> ${sponsor.active ? '✅ Active' : '❌ Inactive'} | <strong>Website:</strong> ${sponsor.website || 'Not provided'}</small>
                            </div>
                        </div>
                        <div class="content-actions">
                            <button class="btn btn-small btn-edit" onclick="editSponsor(${index})">✏️ Edit</button>
                            <button class="btn btn-small" onclick="duplicateSponsor(${index})" style="background: #17a2b8; color: white;">📋 Duplicate</button>
                            <button class="btn btn-small btn-delete" onclick="deleteSponsor(${index})">🗑️ Delete</button>
                        </div>
                    `;
                    sponsorsList.appendChild(item);
                });

                this.updateSponsorStats();
                this.loadSponsorPreview();
            }

            loadSponsorPreview() {
                const sponsors = this.getData('sponsors').filter(sponsor => sponsor.active);
                const previewTicker = document.getElementById('sponsorPreviewTicker');
                
                if (!previewTicker) return;
                
                previewTicker.innerHTML = '';
                
                if (sponsors.length === 0) {
                    previewTicker.innerHTML = '<div style="color: var(--text-light); font-style: italic;">No active sponsors to preview</div>';
                    return;
                }
                
                // Show sponsors twice for preview effect
                const sponsorLogos = [...sponsors, ...sponsors];
                
                sponsorLogos.forEach(sponsor => {
                    const logoDiv = document.createElement('div');
                    logoDiv.className = 'sponsor-preview-logo';
                    
                    if (sponsor.logo) {
                        logoDiv.innerHTML = `<img src="${sponsor.logo}" alt="${sponsor.name}">`;
                    } else {
                        logoDiv.textContent = sponsor.name;
                    }
                    
                    previewTicker.appendChild(logoDiv);
                });
            }

            loadNews() {
    const news = this.getData('news');
    const newsList = document.getElementById('newsList');
    if (!newsList) return;

    newsList.innerHTML = '';

    if (news.length === 0) {
        newsList.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 2rem;">No news articles yet. Click "Add News Article" to get started!</p>';
        return;
    }

    news.forEach((article, index) => {
        const item = document.createElement('div');
        item.className = 'content-item';
        item.innerHTML = `
            <div class="content-info">
                <h4>${article.title}</h4>
                <p><strong>Category:</strong> ${this.formatCategory(article.category)} | <strong>Author:</strong> ${article.author}</p>
                <small>Created: ${new Date(article.date).toLocaleDateString()}</small>
                <p style="margin-top: 0.5rem; color: var(--text-light);">${article.content ? article.content.substring(0, 100) + '...' : 'No content'}</p>
            </div>
            <div class="content-actions">
                <button class="btn btn-small btn-edit" onclick="editNews(${index})">✏️ Edit</button>
                <button class="btn btn-small btn-delete" onclick="deleteNews(${index})">🗑️ Delete</button>
            </div>
        `;
        newsList.appendChild(item);
    });
}

            loadFixtures(teamFilter = 'all', timeFilter = 'upcoming') {
                const fixtures = this.getData('fixtures');
                const fixturesList = document.getElementById('fixturesList');
                if (!fixturesList) return;

                fixturesList.innerHTML = '';

                // Filter fixtures by team if not 'all'
                let filteredFixtures = fixtures;
                if (teamFilter !== 'all') {
                    filteredFixtures = fixtures.filter(fixture => fixture.team === teamFilter);
                }

                // Sort fixtures by date (OLS 100: Added logical sorting)
                // Upcoming fixtures first (soonest first), then past fixtures (most recent first)
                const now = new Date();
                
                // Filter by time (OLS 100: Added time filter for tabs)
                filteredFixtures = filteredFixtures.filter(fixture => {
                    const fixtureDate = new Date(fixture.dateTime);
                    if (timeFilter === 'upcoming') {
                        return fixtureDate >= now;
                    } else {
                        return fixtureDate < now;
                    }
                });

                if (filteredFixtures.length === 0) {
                    const timeLabel = timeFilter === 'upcoming' ? 'upcoming' : 'past';
                    if (teamFilter !== 'all') {
                        fixturesList.innerHTML = `<p style="text-align: center; color: var(--text-light); padding: 2rem;">No ${timeLabel} fixtures found for this team.</p>`;
                    } else {
                        fixturesList.innerHTML = `<p style="text-align: center; color: var(--text-light); padding: 2rem;">No ${timeLabel} fixtures yet.</p>`;
                    }
                    return;
                }

                const sortedFixtures = [...filteredFixtures].sort((a, b) => {
                    const dateA = new Date(a.dateTime);
                    const dateB = new Date(b.dateTime);
                    
                    if (timeFilter === 'upcoming') {
                        // Upcoming: soonest first
                        return dateA - dateB;
                    } else {
                        // Past: most recent first
                        return dateB - dateA;
                    }
                });

                sortedFixtures.forEach((fixture) => {
                    // Find the original index for editing/deleting
                    const originalIndex = fixtures.indexOf(fixture);
                    
                    const item = document.createElement('div');
                    item.className = 'content-item';
                    const hasScore = fixture.ourScore !== null && fixture.ourScore !== undefined && fixture.ourScore !== '' &&
                                     fixture.theirScore !== null && fixture.theirScore !== undefined && fixture.theirScore !== '';
                    const fixtureDate = new Date(fixture.dateTime);
                    const isPast = fixtureDate < now;
                    const isCancelledOrPostponed = fixture.matchStatus === 'cancelled' || fixture.matchStatus === 'postponed';

                    // OLS 100: Check if past fixture is missing scores (skip cancelled/postponed)
                    const needsScore = isPast && !hasScore && !isCancelledOrPostponed;
                    if (needsScore) {
                        item.classList.add('missing-score');
                    }
                    
                    const result = isCancelledOrPostponed ? (fixture.matchStatus === 'cancelled' ? 'Cancelled' : 'Postponed') : hasScore ? `${fixture.ourScore} - ${fixture.theirScore}` : 'Upcoming';
                    const resultIcon = isCancelledOrPostponed ? (fixture.matchStatus === 'cancelled' ? '❌' : '⏸️') : hasScore ? '🏆' : '📅';
                    
                    // OLS 100: Add warning badge for past fixtures without scores
                    const scoreWarning = needsScore ? '<div class="missing-score-warning">Score needs updating</div>' : '';
                    
                    item.innerHTML = `
                        <div class="content-info">
                            <h4>${resultIcon} ${this.formatTeam(fixture.team)} vs ${fixture.opponent}</h4>
                            <p><strong>Date:</strong> ${new Date(fixture.dateTime).toLocaleDateString()} at ${new Date(fixture.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                            <p><strong>Venue:</strong> ${fixture.venue} | <strong>Result:</strong> ${result}</p>
                            <small>Competition: ${fixture.competition || 'Not specified'}</small>
                            ${scoreWarning}
                        </div>
                        <div class="content-actions">
                            <button class="btn btn-small btn-edit" onclick="editFixture(${originalIndex})">✏️ Edit</button>
                            <button class="btn btn-small btn-delete" onclick="deleteFixture(${originalIndex})">🗑️ Delete</button>
                        </div>
                    `;
                    fixturesList.appendChild(item);
                });
            }

            loadGallery() {
                const gallery = this.getData('gallery');
                const galleryList = document.getElementById('galleryList');
                if (!galleryList) return;

                galleryList.innerHTML = '';

                if (gallery.length === 0) {
                    galleryList.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 2rem;">No photo albums yet. Click "Upload Photos" to get started!</p>';
                    return;
                }

                gallery.forEach((album, index) => {
                    // Parse photos if it's a JSON string
                    let photoCount = 0;
                    if (typeof album.photos === 'string') {
                        try {
                            const parsedPhotos = JSON.parse(album.photos);
                            photoCount = parsedPhotos.length;
                        } catch (e) {
                            console.error('Error parsing photos for album:', album.title, e);
                            photoCount = album.photoCount || 0;
                        }
                    } else if (Array.isArray(album.photos)) {
                        photoCount = album.photos.length;
                    } else {
                        photoCount = album.photoCount || 0;
                    }
                    
                    const item = document.createElement('div');
                    item.className = 'content-item';
                    item.innerHTML = `
                        <div class="content-info">
                            <h4>📸 ${album.title}</h4>
                            <p><strong>Category:</strong> ${this.formatCategory(album.category)} | <strong>Photos:</strong> ${photoCount}</p>
                            <small>Created: ${new Date(album.date).toLocaleDateString()}</small>
                            <p style="margin-top: 0.5rem; color: var(--text-light);">${album.description || 'No description'}</p>
                        </div>
                        <div class="content-actions">
                            <button class="btn btn-small btn-edit" onclick="editAlbum(${index})">✏️ Edit</button>
                            <button class="btn btn-small btn-edit" onclick="viewAlbum(${index})">👁️ View</button>
                            <button class="btn btn-small btn-delete" onclick="deleteAlbum(${index})">🗑️ Delete</button>
                        </div>
                    `;
                    galleryList.appendChild(item);
                });
            }

            loadPlayers() {
                const players = this.getData('players');
                const playersList = document.getElementById('playersList');
                if (!playersList) return;

                playersList.innerHTML = '';

                if (players.length === 0) {
                    playersList.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 2rem;">No players yet. Click "Add Player" to get started!</p>';
                    return;
                }

                players.forEach((player, index) => {
                    const item = document.createElement('div');
                    item.className = 'content-item';
                    item.innerHTML = `
                        <div class="content-info">
                            <h4>👤 ${player.name}</h4>
                            <p><strong>Team:</strong> ${this.formatTeam(player.team)} | <strong>Position:</strong> ${player.position}</p>
                            <small>Appearances: ${player.appearances}</small>
                        </div>
                        <div class="content-actions">
                            <button class="btn btn-small btn-edit" onclick="editPlayer(${index})">✏️ Edit</button>
                            <button class="btn btn-small btn-delete" onclick="deletePlayer(${index})">🗑️ Delete</button>
                        </div>
                    `;
                    playersList.appendChild(item);
                });
            }

            loadTeams() {
                let teams = this.getData('teams');
                const teamsList = document.getElementById('teamsList');
                
                if (!teamsList) return;
                
                if (teams.length === 0) {
                    teamsList.innerHTML = `
                        <div style="padding: 3rem; text-align: center; color: var(--text-light);">
                            <p style="font-size: 1.2rem; margin-bottom: 1rem;">🏉 No teams yet</p>
                            <p>Click "Add Team" to create your first team</p>
                        </div>
                    `;
                    return;
                }
                
                // OLS 125: Sort by displayOrder (lower numbers first)
                teams = [...teams].sort((a, b) => {
                    const orderA = a.displayOrder || 99;
                    const orderB = b.displayOrder || 99;
                    return orderA - orderB;
                });
                
                teamsList.innerHTML = teams.map((team, index) => `
                    <div class="content-item" style="display: flex; align-items: center; gap: 1rem;">
                        <!-- OLS 125: Reorder buttons -->
                        <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                            <button class="btn btn-small" onclick="adminSystem.moveTeam('${team.id}', 'up')" 
                                    style="padding: 0.25rem 0.5rem; font-size: 0.8rem; ${index === 0 ? 'opacity: 0.3; cursor: not-allowed;' : ''}"
                                    ${index === 0 ? 'disabled' : ''} title="Move up">▲</button>
                            <button class="btn btn-small" onclick="adminSystem.moveTeam('${team.id}', 'down')" 
                                    style="padding: 0.25rem 0.5rem; font-size: 0.8rem; ${index === teams.length - 1 ? 'opacity: 0.3; cursor: not-allowed;' : ''}"
                                    ${index === teams.length - 1 ? 'disabled' : ''} title="Move down">▼</button>
                        </div>
                        <div class="content-info" style="flex: 1;">
                            <h3>🏉 ${team.name} <span style="font-size: 0.8rem; color: var(--text-light); font-weight: normal;">#${index + 1}</span></h3>
                            <p><strong>Slug:</strong> ${team.slug}</p>
                            <p><strong>Club Section:</strong> ${team.clubSection || 'Unassigned'}</p>
                            ${team.description ? `<p>${team.description}</p>` : ''}
                        </div>
                        <div class="content-actions">
                            <button class="btn btn-small btn-edit" onclick="adminSystem.editTeam('${team.id}')">✏️ Edit</button>
                            <button class="btn btn-small btn-delete" onclick="adminSystem.deleteTeam('${team.id}')">🗑️ Delete</button>
                        </div>
                    </div>
                `).join('');
            }
            
            // OLS 125: Move team up or down in display order
            async moveTeam(teamId, direction) {
                let teams = this.getData('teams');
                
                // Sort by displayOrder first
                teams = [...teams].sort((a, b) => {
                    const orderA = a.displayOrder || 99;
                    const orderB = b.displayOrder || 99;
                    return orderA - orderB;
                });
                
                const currentIndex = teams.findIndex(t => t.id === teamId);
                if (currentIndex === -1) return;
                
                const targetIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
                if (targetIndex < 0 || targetIndex >= teams.length) return;
                
                // Swap the display orders
                const currentTeam = teams[currentIndex];
                const targetTeam = teams[targetIndex];
                
                // Assign new display orders based on position
                teams.forEach((team, idx) => {
                    team.displayOrder = idx + 1;
                });
                
                // Swap the two teams
                [teams[currentIndex], teams[targetIndex]] = [teams[targetIndex], teams[currentIndex]];
                
                // Reassign display orders after swap
                teams.forEach((team, idx) => {
                    team.displayOrder = idx + 1;
                });
                
                // Save to localStorage
                this.saveData('teams', teams);
                this.loadTeams();
                
                // Update all dropdowns
                updatePlayerTeamDropdown();
                updateFixtureTeamDropdown();
                updateGalleryTeamDropdown();
                
                // Sync to cloud in background
                if (window.netlifyDataManager) {
                    try {
                        // Save both teams that changed
                        await window.netlifyDataManager.createTeam(teams.find(t => t.id === currentTeam.id));
                        await window.netlifyDataManager.createTeam(teams.find(t => t.id === targetTeam.id));
                        console.log('✅ Team order synced to cloud');
                    } catch (error) {
                        console.warn('Cloud sync failed for team reorder:', error);
                    }
                }
            }

            async editTeam(teamId) {
                const teams = this.getData('teams');
                const team = teams.find(t => t.id === teamId);
                const index = teams.findIndex(t => t.id === teamId);
                
                if (!team) {
                    console.error('Team not found:', teamId);
                    return;
                }
                
                this.currentEditIndex = index;
                
                document.getElementById('teamName').value = team.name;
                document.getElementById('teamSlug').value = team.slug;
                
                document.getElementById('teamDescription').value = team.description || '';
                
                // OLS 125: Display Order field
                document.getElementById('teamDisplayOrder').value = team.displayOrder || 10;
                
                // OLS 131: Training slots
                document.getElementById('teamShowInTraining').checked = team.showInTraining || false;
                document.getElementById('teamTrainingNotes').value = team.trainingNotes || '';
                
                // Load training slots - handle new format and legacy format
                clearTrainingSlots();
                if (team.trainingSlots && Array.isArray(team.trainingSlots) && team.trainingSlots.length > 0) {
                    // New slot format
                    loadTrainingSlots(team.trainingSlots);
                } else if (team.trainingDays) {
                    // Legacy format - convert to slots
                    let days = team.trainingDays;
                    if (typeof days === 'string') {
                        days = days.split(/[&,]/).map(d => d.trim()).filter(Boolean);
                    }
                    if (Array.isArray(days) && days.length > 0) {
                        // Parse legacy time
                        let startTime = team.trainingStartTime || '';
                        let endTime = team.trainingEndTime || '';
                        if (!startTime && !endTime && team.trainingTimes) {
                            const timeMatch = team.trainingTimes.match(/(\d{1,2}):?(\d{2})?\s*(am|pm)?\s*[-–to]+\s*(\d{1,2}):?(\d{2})?\s*(am|pm)?/i);
                            if (timeMatch) {
                                const parseTime = (h, m, ampm) => {
                                    let hour = parseInt(h);
                                    if (ampm && ampm.toLowerCase() === 'pm' && hour < 12) hour += 12;
                                    if (ampm && ampm.toLowerCase() === 'am' && hour === 12) hour = 0;
                                    return `${hour.toString().padStart(2, '0')}:${(m || '00').padStart(2, '0')}`;
                                };
                                startTime = parseTime(timeMatch[1], timeMatch[2], timeMatch[3]);
                                endTime = parseTime(timeMatch[4], timeMatch[5], timeMatch[6]);
                            }
                        }
                        // Create a slot for each day with same time
                        days.forEach(day => {
                            addTrainingSlot(day, startTime, endTime);
                        });
                    }
                }
                
                // Toggle visibility of training fields
                toggleTeamTrainingFields();
                
                // OLS 130: Club Section - await the async function before setting value
                await populateClubSectionDropdown();
                const clubSectionValue = team.clubSection || '';
                document.getElementById('teamClubSection').value = clubSectionValue;
                console.log('📋 Loaded team:', team.name, '| Club Section:', clubSectionValue, '| Dropdown value:', document.getElementById('teamClubSection').value);
                
                openModal('teamModal');
            }

            async deleteTeam(teamId) {
                const teams = this.getData('teams');
                const team = teams.find(t => t.id === teamId);
                
                if (!team) {
                    console.error('Team not found:', teamId);
                    return;
                }
                
                if (confirm(`Are you sure you want to delete "${team.name}"?\n\nNote: Players assigned to this team will not be deleted.`)) {
                    showLoading('Deleting team...');
                    try {
                        // Delete from Netlify Blobs
                        const result = await window.netlifyDataManager.deleteTeam(team.id);
                        
                        if (result.success) {
                            // Remove from localStorage (already done in deleteTeam method)
                            this.loadTeams();
                            this.updateStats();
                            
                            // Update all team dropdowns
                            updatePlayerTeamDropdown();
                            updateFixtureTeamDropdown();
                            updateGalleryTeamDropdown();
                            
                            showLoadingSuccess('Team deleted!');
                        } else {
                            throw new Error(result.error || 'Failed to delete team');
                        }
                    } catch (error) {
                        console.error('Error deleting team:', error);
                        showLoadingError('Failed to delete team');
                    }
                }
            }

            async loadFilters() {
                const filtersList = document.getElementById('filtersList');
                if (!filtersList) return;

                // 🆕 OLS 119: Try to load from site-settings first
                let filters = this.getData('team_filters');
                
                try {
                    const response = await fetch('/.netlify/functions/site-settings', {
                        method: 'GET'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const settings = result.data || {};
                        
                        if (settings['team-display-filters']) {
                            const cloudFilters = typeof settings['team-display-filters'] === 'string'
                                ? JSON.parse(settings['team-display-filters'])
                                : settings['team-display-filters'];
                            
                            if (cloudFilters && cloudFilters.length > 0) {
                                filters = cloudFilters;
                                // Update localStorage to match cloud
                                this.saveData('team_filters', filters);
                                console.log(`✅ Loaded ${filters.length} display filters from site-settings`);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ Could not load filters from site-settings, using localStorage:', error);
                }

                if (filters.length === 0) {
                    filtersList.innerHTML = '<div class="empty-state"><p>No display filters yet. Click "Add Display Filter" to create your first filter!</p></div>';
                    return;
                }

                filters.sort((a, b) => (a.order || 99) - (b.order || 99));

                filtersList.innerHTML = '';
                filters.forEach((filter, index) => {
                    const teamNames = filter.teamSlugs
                        .map(slug => this.getData('teams').find(t => t.slug === slug)?.name || slug)
                        .join(', ');

                    const card = document.createElement('div');
                    card.className = 'content-item';
                    card.innerHTML = `
                        <div class="content-info">
                            <h3>🎯 ${filter.name}</h3>
                            <p><strong>Includes:</strong> ${teamNames}</p>
                            ${filter.description ? `<p><em>${filter.description}</em></p>` : ''}
                            <p><strong>Status:</strong> ${filter.enabled ? '✅ Enabled' : '⚠️ Disabled'}</p>
                        </div>
                        <div class="content-actions">
                            <button class="btn btn-small btn-edit" onclick="adminSystem.editFilter(${index})">✏️ Edit</button>
                            <button class="btn btn-small btn-delete" onclick="adminSystem.deleteFilter(${index})">🗑️ Delete</button>
                        </div>
                    `;
                    filtersList.appendChild(card);
                });
            }

            editFilter(index) {
                const filters = this.getData('team_filters');
                const filter = filters[index];

                document.getElementById('filterEditIndex').value = index;
                document.getElementById('filterName').value = filter.name;
                document.getElementById('filterDescription').value = filter.description || '';
                document.getElementById('filterEnabled').checked = filter.enabled;

                this.populateFilterTeamCheckboxes(filter.teamSlugs);
                openModal('filterModal');
            }

            async deleteFilter(index) {
                const filters = this.getData('team_filters');
                const filter = filters[index];

                if (!filter) {
                    console.error('Filter not found at index:', index);
                    return;
                }

                if (confirm(`Delete filter "${filter.name}"?`)) {
                    try {
                        // 1. CLOUD-FIRST: Build filtered array and save to cloud
                        const updatedFilters = filters.filter((_, i) => i !== index);

                        const response = await fetch('/.netlify/functions/site-settings', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                'team-display-filters': JSON.stringify(updatedFilters)
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Cloud deletion failed');
                        }
                        console.log('Filter deleted from site-settings');

                        // 2. Only update localStorage AFTER cloud succeeds
                        this.saveData('team_filters', updatedFilters);
                        this.loadFilters();
                        this.showAlert('filters', 'Filter deleted successfully', 'success');
                    } catch (error) {
                        console.error('Error deleting filter:', error);
                        this.showAlert('filters', 'Error deleting filter: ' + error.message, 'danger');
                    }
                }
            }

            populateFilterTeamCheckboxes(selectedSlugs = []) {
                const container = document.getElementById('filterTeamCheckboxes');
                const teams = this.getData('teams');

                if (teams.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-light);">No teams available. Create teams first!</p>';
                    return;
                }

                container.innerHTML = teams.map(team => `
                    <label>
                        <input type="checkbox" name="filterTeams" value="${team.slug}" 
                               ${selectedSlugs.includes(team.slug) ? 'checked' : ''}>
                        <span>${team.name}</span>
                    </label>
                `).join('');
            }

            loadShop() {
                const shop = this.getData('shop');
                const shopList = document.getElementById('shopList');
                if (!shopList) return;

                shopList.innerHTML = '';

                if (shop.length === 0) {
                    shopList.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 2rem;">No products yet. Click "Add Product" to get started!</p>';
                    return;
                }

                shop.forEach((product, index) => {
                    const item = document.createElement('div');
                    item.className = 'content-item shop-item';
                    item.dataset.category = product.category;
                    
                    const stockStatus = parseInt(product.stock) === 0 ? 'Out of Stock' : 
                                      parseInt(product.stock) < 5 ? `Low Stock (${product.stock})` : 
                                      `In Stock (${product.stock})`;
                    
                    const stockClass = parseInt(product.stock) === 0 ? 'color: #dc3545;' : 
                                      parseInt(product.stock) < 5 ? 'color: #ffc107;' : 
                                      'color: #28a745;';

                    const imageDisplay = product.images && product.images.length > 0 
                        ? `<img src="${product.images[0].url}" alt="${product.name}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-right: 1rem;">`
                        : `<div style="width: 80px; height: 80px; background: linear-gradient(45deg, var(--primary-green), var(--primary-maroon)); border-radius: 8px; margin-right: 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem;">No Image</div>`;

                    item.innerHTML = `
                        <div style="display: flex; align-items: center;">
                            ${imageDisplay}
                            <div class="content-info">
                                <h4>🛒 ${product.name}</h4>
                                <p><strong>Price:</strong> £${product.price} | <strong>Category:</strong> ${this.formatShopCategory(product.category)}</p>
                                <p><strong>Status:</strong> <span style="${stockClass}">${stockStatus}</span> | <strong>SKU:</strong> ${product.sku || 'N/A'}</p>
                                <small>${product.description ? product.description.substring(0, 100) + '...' : 'No description'}</small>
                            </div>
                        </div>
                        <div class="content-actions">
                            <button class="btn btn-small btn-edit" onclick="editShopProduct(${index})">✏️ Edit</button>
                            <button class="btn btn-small" onclick="duplicateShopProduct(${index})" style="background: #17a2b8; color: white;">📋 Duplicate</button>
                            <button class="btn btn-small btn-delete" onclick="deleteShopProduct(${index})">🗑️ Delete</button>
                        </div>
                    `;
                    shopList.appendChild(item);
                });

                this.updateShopStats();
            }

            formatCategory(category) {
                const categories = {
                    'match': 'Match Report',
                    'training': 'Training',
                    'social': 'Social Event',
                    'club': 'Club Update',
                    'matches': 'Match Day',
                    'team': 'Team Photos'
                };
                return categories[category] || category;
            }

            formatTeam(team) {
                // Look up team from teams data instead of hardcoded list
                const teams = this.getData('teams');
                const foundTeam = teams.find(t => t.slug === team);
                
                // Return team name if found, otherwise return the slug as fallback
                return foundTeam ? foundTeam.name : team;
            }

            formatShopCategory(category) {
                const categories = {
                    'jerseys': 'Jerseys',
                    'training': 'Training Kit',
                    'accessories': 'Accessories',
                    'supporters': 'Supporters Gear'
                };
                return categories[category] || category;
            }

            formatSponsorTier(tier) {
                const tiers = {
                    'platinum': '💎 Platinum',
                    'gold': '🥇 Gold',
                    'silver': '🥈 Silver',
                    'bronze': '🥉 Bronze'
                };
                return tiers[tier] || tier;
            }
        }

        // Initialize admin system
        const adminSystem = new AdminSystem();

// Make adminSystem globally available BEFORE other scripts load
window.adminSystem = adminSystem;

// Listen for storage changes (in case data is updated from another tab or sync completes)
window.addEventListener('storage', function(e) {
    if (e.key && e.key.startsWith('olrfc_')) {
        console.log('📡 Storage change detected:', e.key);
        adminSystem.updateStats();
        
        // Reload the specific data type that changed
        const dataType = e.key.replace('olrfc_', '');
        if (typeof adminSystem['load' + dataType.charAt(0).toUpperCase() + dataType.slice(1)] === 'function') {
            adminSystem['load' + dataType.charAt(0).toUpperCase() + dataType.slice(1)]();
        }
    }
});

// Custom event listener for when Netlify sync completes
window.addEventListener('netlifyDataSynced', function(e) {
    console.log('📡 Netlify sync completed event received');
    
    // Wait a moment for data to settle, then refresh stats
    setTimeout(function() {
        console.log('🔄 Refreshing stats after Netlify sync');
        adminSystem.updateStats();
        adminSystem.loadAllData();
    }, 500);
});

// Force stats update on page focus (when returning to tab)
window.addEventListener('focus', function() {
    console.log('👁️ Page focused, refreshing stats');
    adminSystem.updateStats();
});

// Periodic stats refresh every 10 seconds (only when dashboard visible)
setInterval(function() {
    const currentSection = document.querySelector('.admin-section.active');
    if (currentSection && currentSection.id === 'dashboard') {
        console.log('⏰ Periodic stats refresh (dashboard visible)');
        adminSystem.updateStats();
    }
}, 10000);

        // Website Feature Control
        const websiteFeatureStates = {
            shop: false,
            events: false,
            members: false,
            payments: false,
            sponsors: false
        };

        async function toggleWebsiteFeature(feature) {
    websiteFeatureStates[feature] = !websiteFeatureStates[feature];
    
    const toggle = document.querySelector(`[data-feature="${feature}"]`);
    toggle.classList.toggle('active', websiteFeatureStates[feature]);
    
    // Keep localStorage for admin preview
    localStorage.setItem('olrfc_admin_features', JSON.stringify(websiteFeatureStates));
    
    const featureName = feature.charAt(0).toUpperCase() + feature.slice(1);
    const status = websiteFeatureStates[feature] ? 'enabled' : 'disabled';
    
    // 🚀 Save to Netlify Blobs (site-settings)
    try {
        const updates = {
            [`feature-${feature}`]: websiteFeatureStates[feature].toString()
        };
        
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to save: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to save feature state');
        }
        
        console.log(`✅ ${featureName} ${status} - saved to Netlify Blobs`);
        
        // Show success notification
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 100px; right: 20px; background: var(--accent-gold);
            color: var(--primary-green); padding: 1rem; border-radius: 10px;
            font-weight: bold; z-index: 10000; animation: slideInRight 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        `;
        notification.innerHTML = `
            ✅ ${featureName} ${status}<br>
            <small style="font-size: 0.85em; opacity: 0.9;">Updated for all users!</small>
        `;
        
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
        
    } catch (error) {
        console.error('Error submitting to Netlify:', error);
        
        // Show error notification
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 100px; right: 20px; background: #d32f2f;
            color: white; padding: 1rem; border-radius: 10px;
            font-weight: bold; z-index: 10000; animation: slideInRight 0.3s ease;
        `;
        notification.textContent = `⚠️ Error updating ${featureName}. Please try again.`;
        
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 4000);
    }
}

        async function loadWebsiteFeatureStates() {
            try {
                console.log('📥 Loading website feature states from Netlify...');
                
                // Fetch from Netlify Blobs
                const response = await fetch('/.netlify/functions/site-settings', {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const settings = result.data || {};
                    
                    // Extract feature states from settings
                    Object.keys(settings).forEach(key => {
                        if (key.startsWith('feature-')) {
                            const featureName = key.replace('feature-', '');
                            if (websiteFeatureStates.hasOwnProperty(featureName)) {
                                websiteFeatureStates[featureName] = settings[key] === 'true';
                            }
                        }
                    });
                    
                    console.log('✅ Website feature states loaded from Netlify:', websiteFeatureStates);
                } else {
                    console.log('Using default feature states (Netlify unavailable)');
                }
                
                // Update localStorage cache for admin preview
                localStorage.setItem('olrfc_admin_features', JSON.stringify(websiteFeatureStates));
                
            } catch (error) {
                console.error('Error loading feature states from Netlify:', error);
                
                // Fallback to localStorage
                const saved = localStorage.getItem('olrfc_admin_features');
                if (saved) {
                    Object.assign(websiteFeatureStates, JSON.parse(saved));
                    console.log('⚠️ Using cached feature states from localStorage');
                }
            }
            
            // Update toggle UI
            Object.keys(websiteFeatureStates).forEach(feature => {
                const toggle = document.querySelector(`[data-feature="${feature}"]`);
                if (toggle) {
                    toggle.classList.toggle('active', websiteFeatureStates[feature]);
                }
            });
        }

        // Navigation functions
        function showSection(sectionId) {
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeNav = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
            if (activeNav) {
                activeNav.classList.add('active');
            }

            // Load data when switching sections
if (sectionId === 'news') {
    adminSystem.loadNews();
} else if (sectionId === 'fixtures') {
    const currentFilter = document.getElementById('admin-team-filter')?.value || 'all';
    adminSystem.loadFixtures(currentFilter, currentFixtureTimeFilter);
} else if (sectionId === 'gallery') {
    adminSystem.loadGallery();
} else if (sectionId === 'players') {
    adminSystem.loadPlayers();
} else if (sectionId === 'teams') {
    adminSystem.loadTeams();
} else if (sectionId === 'shop') {
    adminSystem.loadShop();
} else if (sectionId === 'sponsors') {
    adminSystem.loadSponsors();
} else if (sectionId === 'contacts') {
    loadContacts();
} else if (sectionId === 'club-sections') {
    loadClubSectionsList();
}

            document.title = `${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)} - Admin Dashboard`;
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Special handling for player modal - update team dropdown
            if (modalId === 'playerModal') {
                // Delay to ensure modal is fully rendered before populating dropdown
                setTimeout(() => {
                    if (typeof updatePlayerTeamDropdown === 'function') {
                        updatePlayerTeamDropdown();
                    }
                }, 30);
            }
            
            // Special handling for fixture modal - update team dropdown
            if (modalId === 'fixtureModal') {
                // Reset form if not editing (OLS 100)
                if (adminSystem.currentEditIndex === null) {
                    const form = document.getElementById('fixtureForm');
                    if (form) form.reset();
                }
                
                // Delay to ensure modal is fully rendered before populating dropdowns
                setTimeout(() => {
                    // Populate team dropdown
                    if (typeof updateFixtureTeamDropdown === 'function') {
                        updateFixtureTeamDropdown();
                    }
                }, 30);
            }
            
            // OLS 122: Special handling for news modal - show/hide fixture dropdown based on category
            if (modalId === 'newsModal') {
                // Default publish date to today for new articles
                if (adminSystem.currentEditIndex === null) {
                    document.getElementById('newsPublishDate').value = new Date().toISOString().split('T')[0];
                }
                setTimeout(() => {
                    // Check initial category and toggle fixture dropdown visibility
                    toggleNewsFixtureDropdown();
                }, 30);
            }
            
            // Special handling for gallery modal - populate team dropdown AND fixtures dropdown
            if (modalId === 'galleryModal') {
                setTimeout(() => {
                    // First populate team dropdown
                    if (typeof updateGalleryTeamDropdown === 'function') {
                        updateGalleryTeamDropdown();
                    }
                    
                    const teamSelect = document.getElementById('galleryTeam');
                    
                    // Then populate fixtures based on currently selected team
                    populateFixturesDropdown(teamSelect.value);
                    
                    // Remove any existing listener to avoid duplicates
                    teamSelect.removeEventListener('change', handleTeamChange);
                    
                    // Add listener to update fixtures when team changes
                    teamSelect.addEventListener('change', handleTeamChange);
                }, 30);
            }
        }
        
        function handleTeamChange(event) {
            const selectedTeam = event.target.value;
            populateFixturesDropdown(selectedTeam);
        }
        
        function populateFixturesDropdown(selectedTeam = null) {
            const fixtureSelect = document.getElementById('galleryFixture');
            const fixtures = adminSystem.getData('fixtures');
            
            // Clear existing options (except the first "None" option)
            fixtureSelect.innerHTML = '<option value="">None - Not linked to a fixture</option>';
            
            if (fixtures.length === 0) {
                return;
            }
            
            // Filter fixtures by team if a team is selected
            let filteredFixtures = fixtures;
            if (selectedTeam && selectedTeam !== 'other') {
                filteredFixtures = fixtures.filter(fixture => {
                    // Match fixture team to selected team
                    return fixture.team === selectedTeam;
                });
            }
            
            // If no fixtures match the team, show a message
            if (filteredFixtures.length === 0 && selectedTeam !== 'other') {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = `No fixtures found for this team`;
                option.disabled = true;
                fixtureSelect.appendChild(option);
                console.log(`📋 No fixtures found for team: ${selectedTeam}`);
                return;
            }
            
            // Sort fixtures by date (newest first)
            const sortedFixtures = [...filteredFixtures].sort((a, b) => {
                const dateA = new Date(a.dateTime || a.date || a.matchDate);
                const dateB = new Date(b.dateTime || b.date || b.matchDate);
                return dateB - dateA;
            });
            
            // Add fixtures as options
            sortedFixtures.forEach(fixture => {
                const option = document.createElement('option');
                option.value = fixture.id;
                
                // Try multiple date formats
                let fixtureDate = 'Date TBC';
                const dateValue = fixture.dateTime || fixture.date || fixture.matchDate;
                
                // Debug: Log the fixture to see what data we have
                console.log('Processing fixture:', {
                    opponent: fixture.opponent,
                    dateValue: dateValue,
                    dateType: typeof dateValue,
                    fullFixture: fixture
                });
                
                if (dateValue) {
                    try {
                        let parsedDate = null;
                        
                        // Try different date parsing strategies
                        if (typeof dateValue === 'string') {
                            // Try ISO format first (YYYY-MM-DD or YYYY-MM-DDTHH:mm)
                            parsedDate = new Date(dateValue);
                            
                            // If that didn't work, try UK format (DD/MM/YYYY)
                            if (isNaN(parsedDate.getTime()) && dateValue.includes('/')) {
                                const parts = dateValue.split('/');
                                if (parts.length === 3) {
                                    // Assume DD/MM/YYYY format
                                    parsedDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                                }
                            }
                            
                            // If still invalid, try US format (MM/DD/YYYY)
                            if (isNaN(parsedDate.getTime()) && dateValue.includes('/')) {
                                const parts = dateValue.split('/');
                                if (parts.length === 3) {
                                    parsedDate = new Date(`${parts[2]}-${parts[0]}-${parts[1]}`);
                                }
                            }
                        } else {
                            // If it's already a date object or timestamp
                            parsedDate = new Date(dateValue);
                        }
                        
                        // Check if we got a valid date
                        if (parsedDate && !isNaN(parsedDate.getTime())) {
                            fixtureDate = parsedDate.toLocaleDateString('en-GB', {
                                day: 'numeric',
                                month: 'short',
                                year: 'numeric'
                            });
                            console.log('✅ Successfully parsed date:', fixtureDate);
                        } else {
                            // If all parsing failed, use the original value
                            console.warn('⚠️ Could not parse date, using original:', dateValue);
                            fixtureDate = dateValue;
                        }
                    } catch (e) {
                        console.warn('Error parsing fixture date:', dateValue, e);
                        fixtureDate = dateValue;
                    }
                }
                
                // Extract time if dateTime includes it
                let timeString = '';
                if (dateValue && typeof dateValue === 'string' && dateValue.includes('T')) {
                    try {
                        const parsedDate = new Date(dateValue);
                        if (!isNaN(parsedDate.getTime())) {
                            timeString = parsedDate.toLocaleTimeString('en-GB', {
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            });
                            timeString = ` ${timeString}`;
                        }
                    } catch (e) {
                        // Time extraction failed, continue without time
                    }
                }
                
                // Determine home/away based on venue field
                const homeAway = (fixture.venue === 'away' || fixture.homeAway === 'away') ? '@' : 'vs';
                const opponent = fixture.opponent || 'TBC';
                
                // Show result if completed (OLS 122: Fixed score field names)
                let displayText = `${fixtureDate}${timeString} - ${homeAway} ${opponent}`;
                if (fixture.ourScore !== null && fixture.ourScore !== undefined && fixture.ourScore !== '') {
                    displayText += ` (${fixture.ourScore}-${fixture.theirScore})`;
                }
                
                option.textContent = displayText;
                fixtureSelect.appendChild(option);
            });
            
            console.log(`📋 Loaded ${sortedFixtures.length} fixtures for team: ${selectedTeam || 'all'}`);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
            
            const form = document.getElementById(modalId).querySelector('form');
            if (form) {
                form.reset();
                adminSystem.currentEditIndex = null;
                
                // Special reset for player modal - clear photo preview
                if (modalId === 'playerModal') {
                    const preview = document.getElementById('playerPhotoPreview');
                    if (preview) {
                        preview.style.display = 'none';
                    }
                }
                
                // Special reset for gallery modal
                if (modalId === 'galleryModal') {
                    document.getElementById('galleryEditIndex').value = '';
                    document.getElementById('galleryModalTitle').textContent = '📸 Upload Photos';
                    document.getElementById('gallerySubmitBtn').textContent = '📤 Upload Album';
                    document.getElementById('fileUploadSection').style.display = 'block';
                    document.getElementById('galleryFiles').setAttribute('required', 'required');
                    document.getElementById('coverPhotoSection').style.display = 'none';
                }
                
                // OLS 122: Special reset for fixture modal - clear teamsheet preview
                if (modalId === 'fixtureModal') {
                    const teamsheetPreview = document.getElementById('teamsheetPreview');
                    const teamsheetPreviewImg = document.getElementById('teamsheetPreviewImg');
                    if (teamsheetPreview) {
                        teamsheetPreview.style.display = 'none';
                    }
                    if (teamsheetPreviewImg) {
                        teamsheetPreviewImg.src = '';
                        teamsheetPreviewImg.dataset.cloudinaryUrl = '';
                    }
                }
            }
        }

        // Sponsor Management Functions
        function editSponsor(index) {
            const sponsors = adminSystem.getData('sponsors');
            const sponsor = sponsors[index];

            if (!sponsor) {
                console.error('Sponsor not found at index:', index);
                return;
            }

            adminSystem.currentEditIndex = index;
            adminSystem.currentSection = 'sponsors';
            
            // Populate form
            document.getElementById('sponsorName').value = sponsor.name;
            document.getElementById('sponsorTier').value = sponsor.tier;
            document.getElementById('sponsorPhone').value = sponsor.phone || '';
            document.getElementById('sponsorEmail').value = sponsor.email || '';
            document.getElementById('sponsorWebsite').value = sponsor.website || '';
            document.getElementById('sponsorActive').checked = sponsor.active;
            document.getElementById('sponsorBanner').checked = sponsor.showInBanner !== false;
            
            // Show logo preview if exists
            if (sponsor.logo) {
                document.getElementById('logoPreview').style.display = 'block';
                document.getElementById('logoPreviewImg').src = sponsor.logo;
            }
            
            openModal('sponsorModal');
        }

        async function deleteSponsor(index) {
            const sponsors = adminSystem.getData('sponsors');
            const sponsor = sponsors[index];

            if (!sponsor) {
                console.error('Sponsor not found at index:', index);
                return;
            }

            if (confirm(`Are you sure you want to delete ${sponsor.name}?`)) {
                showLoading('Deleting sponsor...');

                try {
                    // 1. CLOUD-FIRST: Delete from Netlify Blobs first
                    const response = await fetch('/.netlify/functions/sponsors', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: sponsor.id })
                    });

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error || 'Cloud deletion failed');
                    }
                    console.log('Sponsor deleted from cloud storage');

                    // 2. Only delete from localStorage AFTER cloud succeeds
                    const freshSponsors = adminSystem.getData('sponsors');
                    const localIndex = freshSponsors.findIndex(s => s.id === sponsor.id);
                    if (localIndex !== -1) {
                        freshSponsors.splice(localIndex, 1);
                        adminSystem.saveData('sponsors', freshSponsors);
                    }

                    adminSystem.loadSponsors();
                    adminSystem.updateStats();
                    showLoadingSuccess('Sponsor deleted!');
                } catch (error) {
                    console.error('Error deleting sponsor:', error);
                    showLoadingError('Failed to delete sponsor: ' + error.message);
                }
            }
        }

        function duplicateSponsor(index) {
            const sponsors = adminSystem.getData('sponsors');
            const sponsor = {...sponsors[index]};
            
            sponsor.name = sponsor.name + ' (Copy)';
            sponsor.id = Date.now();
            sponsor.dateAdded = new Date().toISOString();
            
            sponsors.push(sponsor);
            adminSystem.saveData('sponsors', sponsors);
        }

        function filterSponsors(tier) {
            const sponsorItems = document.querySelectorAll('.sponsor-item');
            const filterButtons = document.querySelectorAll('#sponsorTierFilters .btn');
            
            // Update active button
            filterButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tier="${tier}"]`).classList.add('active');
            
            // Filter items
            sponsorItems.forEach(item => {
                if (tier === 'all' || item.dataset.tier === tier) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Shop Management Functions
        function filterShopItems(category) {
            const shopItems = document.querySelectorAll('.shop-item');
            const filterButtons = document.querySelectorAll('#shopCategoryFilters .btn');
            
            // Update active button
            filterButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
            
            // Filter items
            shopItems.forEach(item => {
                if (category === 'all' || item.dataset.category === category) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Form event listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadWebsiteFeatureStates();
            
            // Sponsor form submission
            document.getElementById('sponsorForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const sponsors = adminSystem.getData('sponsors');
    const logoPreviewImg = document.getElementById('logoPreviewImg');
    const cloudinaryUrl = logoPreviewImg?.dataset?.cloudinaryUrl || logoPreviewImg?.src || null;

    console.log('💾 Saving sponsor with logo:', cloudinaryUrl ? (cloudinaryUrl.includes('cloudinary') ? 'Cloudinary URL' : 'Base64/Local') : 'No logo');
    
    const sponsorData = {
        name: document.getElementById('sponsorName').value,
        tier: document.getElementById('sponsorTier').value,
        phone: document.getElementById('sponsorPhone').value,
        email: document.getElementById('sponsorEmail').value,
        website: document.getElementById('sponsorWebsite').value,
        logo: cloudinaryUrl,
        active: document.getElementById('sponsorActive').checked,
        showInBanner: document.getElementById('sponsorBanner').checked
    };

    // ✅ Determine if we're editing or creating new
    const isEditing = adminSystem.currentEditIndex !== null;
    const actionText = isEditing ? 'Updating sponsor...' : 'Creating sponsor...';
    showLoading(actionText);

    try {
        // Build the sponsor object
        const sponsor = {
            id: isEditing ? sponsors[adminSystem.currentEditIndex].id : Date.now(),
            ...sponsorData,
            dateAdded: isEditing ? sponsors[adminSystem.currentEditIndex].dateAdded : new Date().toISOString(),
            lastUpdated: new Date().toISOString()
        };

        // 1. CLOUD-FIRST: Save to cloud storage first
        if (window.netlifyDataManager) {
            if (isEditing) {
                console.log('Updating existing sponsor in cloud...');

                if (typeof window.netlifyDataManager.updateSponsor === 'function') {
                    const { id, ...updateData } = sponsor;
                    const result = await window.netlifyDataManager.updateSponsor(sponsor.id, updateData);
                    if (!result.success) {
                        throw new Error(result.error || 'Cloud update failed');
                    }
                    console.log('Sponsor updated in cloud successfully');
                }
            } else {
                console.log('Creating new sponsor in cloud...');

                const result = await window.netlifyDataManager.createSponsor(sponsorData);

                if (!result.success) {
                    throw new Error(result.error || 'Cloud save failed');
                }
                console.log('New sponsor saved to cloud successfully');
            }
        }

        // 2. Only update localStorage AFTER cloud succeeds
        if (isEditing) {
            const localIndex = sponsors.findIndex(s => s.id === sponsor.id);
            if (localIndex !== -1) {
                sponsors[localIndex] = sponsor;
            }
        } else {
            sponsors.push(sponsor);
        }

        adminSystem.saveData('sponsors', sponsors);

        const successText = isEditing ? 'Sponsor updated!' : 'Sponsor created!';
        showLoadingSuccess(successText);

        // Clean up and close
        closeModal('sponsorModal');
        document.getElementById('sponsorForm').reset();
        const logoPreview = document.getElementById('logoPreview');
        const logoPreviewImg2 = document.getElementById('logoPreviewImg');
        logoPreview.style.display = 'none';
        logoPreviewImg2.src = '';
        if (logoPreviewImg2.dataset) {
            delete logoPreviewImg2.dataset.cloudinaryUrl;
        }

        adminSystem.currentEditIndex = null;

        // Reload the sponsor list
        adminSystem.loadSponsors();

    } catch (error) {
        console.error('Error saving sponsor:', error);
        showLoadingError('Failed to save sponsor');
        adminSystem.showAlert('sponsors', 'Error saving sponsor: ' + error.message, 'danger');
    }
});
document.getElementById('newsForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // 🎯 NEW: Get the uploaded image if exists
    const newsImageInput = document.getElementById('newsImage');
    const newsImagePreviewImg = document.getElementById('newsImagePreviewImg');
    let imageUrl = newsImagePreviewImg?.dataset?.cloudinaryUrl || null;
    
    // 🎯 If there's a file to upload and no Cloudinary URL yet, upload it first
    if (newsImageInput.files.length > 0 && !imageUrl) {
        const file = newsImageInput.files[0];
        
        // Show uploading status
        showLoading('Uploading image...');
        const statusEl = document.getElementById('newsImageStatus');
        if (statusEl) statusEl.textContent = '☁️ Uploading image...';
        
        // Upload to Cloudinary
        if (window.cloudinaryUploader) {
            try {
                const uploadResult = await window.cloudinaryUploader.uploadNewsImage(file);
                
                if (uploadResult.success) {
                    imageUrl = uploadResult.url;
                    console.log('✅ Image uploaded to Cloudinary:', imageUrl);
                    if (statusEl) statusEl.textContent = '✅ Image uploaded successfully!';
                } else {
                    throw new Error(uploadResult.error);
                }
            } catch (uploadError) {
                console.warn('⚠️ Cloudinary upload failed:', uploadError);
                if (statusEl) statusEl.textContent = '⚠️ Upload failed, saving without image';
                imageUrl = null;
            }
        }
    }
    
    const newsData = {
        id: adminSystem.currentEditIndex !== null ? 
            adminSystem.getData('news')[adminSystem.currentEditIndex].id : 
            Date.now().toString(),
        title: document.getElementById('newsTitle').value.trim(),
        content: document.getElementById('newsContent').value.trim(),
        category: document.getElementById('newsCategory').value,
        author: document.getElementById('newsAuthor').value.trim() || 'Club Admin',
        date: document.getElementById('newsPublishDate').value || new Date().toISOString().split('T')[0],
        image: imageUrl, // 🎯 NEW: Include the image URL
        featured: false,
        // OLS 122: Link to fixture (for match reports)
        fixtureId: document.getElementById('newsFixture')?.value || null,
        // OLS 130: Club Section
        clubSection: document.getElementById('newsClubSection')?.value || 'all'
    };

    // Validate required fields
    if (!newsData.title || !newsData.content) {
        alert('Please fill in both title and content fields');
        return;
    }

    const isEditing = adminSystem.currentEditIndex !== null;
    const actionText = isEditing ? 'Updating article...' : 'Creating article...';
    showLoading(actionText);

    try {
        // 1. CLOUD-FIRST: Save to cloud storage first
        if (window.netlifyDataManager) {
            let result;

            if (isEditing && typeof window.netlifyDataManager.updateNews === 'function') {
                console.log('Updating news article in cloud...');
                result = await window.netlifyDataManager.updateNews(newsData.id, newsData);
            } else {
                console.log('Creating new news article in cloud...');
                result = await window.netlifyDataManager.createNews(newsData);
            }

            if (!result.success) {
                throw new Error(result.error || 'Cloud save failed');
            }
            console.log('News article successfully synced to cloud storage');
        }

        // 2. Only update localStorage AFTER cloud succeeds
        let existingNews = adminSystem.getData('news');

        if (isEditing) {
            const localIndex = existingNews.findIndex(n => n.id === newsData.id);
            if (localIndex !== -1) {
                existingNews[localIndex] = newsData;
            }
        } else {
            existingNews.unshift(newsData);
        }

        adminSystem.saveData('news', existingNews);
        adminSystem.loadNews();
        adminSystem.updateStats();

        const successText = isEditing ? 'Article updated!' : 'Article created!';
        showLoadingSuccess(successText);

        closeModal('newsModal');
        document.getElementById('newsForm').reset();
        document.getElementById('newsImagePreview').style.display = 'none';
        adminSystem.currentEditIndex = null;

    } catch (error) {
        console.error('Error saving news article:', error);
        showLoadingError('Failed to save article');
        adminSystem.showAlert('news', 'Error saving news article: ' + error.message, 'danger');
    }
});

// Enhanced news editing function (replace the existing placeholder)
// PLAYERS FORM SUBMISSION - Add this after the fixtures form handler
document.getElementById('playerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Get existing photo URL if editing
    let existingPhotoUrl = null;
    if (adminSystem.currentEditIndex !== null) {
        existingPhotoUrl = adminSystem.getData('players')[adminSystem.currentEditIndex].photo;
    }
    
    const playerData = {
        id: adminSystem.currentEditIndex !== null ? 
            adminSystem.getData('players')[adminSystem.currentEditIndex].id : 
            Date.now().toString(),
        name: document.getElementById('playerName').value.trim(),
        team: document.getElementById('playerTeam').value,
        position: document.getElementById('playerPosition').value.trim(),
        appearances: parseInt(document.getElementById('playerApps').value) || 0,
        photo: existingPhotoUrl // Start with existing photo URL
    };

    // Validate required fields
    if (!playerData.name) {
        alert('Please enter the player name');
        return;
    }

    const photoFile = document.getElementById('playerPhoto').files[0];
    const isEditing = adminSystem.currentEditIndex !== null;
    
    try {
        // 🎯 HANDLE PHOTO UPLOAD FIRST (if new photo selected)
        if (photoFile && window.cloudinaryUploader) {
            const removeBackground = document.getElementById('playerPhotoRemoveBg').checked;
            showLoading(`Uploading photo${removeBackground ? ' (removing background...)' : '...'}`);
            
            const uploadResult = await window.cloudinaryUploader.uploadPlayerPhoto(photoFile, removeBackground);
            
            if (uploadResult.success) {
                playerData.photo = uploadResult.url;
                console.log('✅ Player photo uploaded:', uploadResult.url);
                if (uploadResult.backgroundRemoved) {
                    console.log('🎨 Background removed automatically');
                }
            } else {
                console.warn('Photo upload failed:', uploadResult.error);
                // Continue saving player without photo
            }
        }
        
        const actionText = isEditing ? 'Updating player...' : 'Creating player...';
        showLoading(actionText);
        
        // 1. CLOUD-FIRST: Save to cloud storage first
        if (window.netlifyDataManager) {
            let result;

            if (isEditing && typeof window.netlifyDataManager.updatePlayer === 'function') {
                console.log('Updating player in cloud...');
                result = await window.netlifyDataManager.updatePlayer(playerData.id, playerData);
            } else {
                console.log('Creating new player in cloud...');
                result = await window.netlifyDataManager.createPlayer(playerData);
            }

            if (!result.success) {
                throw new Error(result.error || 'Cloud save failed');
            }
            console.log('Player successfully synced to cloud storage');
        }

        // 2. Only update localStorage AFTER cloud succeeds
        let existingPlayers = adminSystem.getData('players');

        if (isEditing) {
            const localIndex = existingPlayers.findIndex(p => p.id === playerData.id);
            if (localIndex !== -1) {
                existingPlayers[localIndex] = playerData;
            }
        } else {
            existingPlayers.unshift(playerData);
        }

        adminSystem.saveData('players', existingPlayers);
        adminSystem.loadPlayers();
        adminSystem.updateStats();

        const successText = isEditing ? 'Player updated!' : 'Player created!';
        showLoadingSuccess(successText);

        closeModal('playerModal');
        document.getElementById('playerForm').reset();
        adminSystem.currentEditIndex = null;
        
    } catch (error) {
        console.error('Error saving player:', error);
        showLoadingError('Failed to save player');
        adminSystem.showAlert('players', 'Error saving player: ' + error.message, 'danger');
    }
});

// Player Photo Preview Handler
document.getElementById('playerPhoto')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('playerPhotoPreview');
    const previewImg = document.getElementById('playerPhotoPreviewImg');
    
    if (file) {
        // Validate file is an image
        if (!file.type.startsWith('image/')) {
            alert('Please select a valid image file');
            e.target.value = '';
            preview.style.display = 'none';
            return;
        }
        
        // Check file size (10MB)
        if (file.size > 10 * 1024 * 1024) {
            alert('Photo must be less than 10MB');
            e.target.value = '';
            preview.style.display = 'none';
            return;
        }
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(event) {
            previewImg.src = event.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
    }
});

// ========================================
// TEAMS MANAGEMENT
// ========================================

// Auto-generate slug from team name
document.getElementById('teamName')?.addEventListener('input', function(e) {
    const name = e.target.value;
    const slug = name.toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '') // Remove special chars
        .replace(/\s+/g, '-')          // Replace spaces with hyphens
        .replace(/-+/g, '-')           // Replace multiple hyphens
        .trim();
    document.getElementById('teamSlug').value = slug;
});

// Teams Form Submission
document.getElementById('teamForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // OLS 131: Collect training slots
    const trainingSlots = getTrainingSlots();
    
    const teamData = {
        id: adminSystem.currentEditIndex !== null ? 
            adminSystem.getData('teams')[adminSystem.currentEditIndex].id : 
            Date.now().toString(),
        name: document.getElementById('teamName').value.trim(),
        slug: document.getElementById('teamSlug').value.trim(),
        description: document.getElementById('teamDescription').value.trim(),
        photo: null, // Handle photo upload separately if needed
        // OLS 125: Display Order
        displayOrder: parseInt(document.getElementById('teamDisplayOrder').value) || 10,
        // OLS 131: Training slots
        showInTraining: document.getElementById('teamShowInTraining').checked,
        trainingSlots: trainingSlots,
        trainingNotes: document.getElementById('teamTrainingNotes').value.trim(),
        // OLS 130: Club Section
        clubSection: document.getElementById('teamClubSection').value
    };

    // Validate required fields
    if (!teamData.name) {
        alert('Please enter the team name');
        return;
    }
    
    if (!teamData.slug) {
        alert('Please enter a team slug');
        return;
    }
    
    // Validate slug format
    if (!/^[a-z0-9-]+$/.test(teamData.slug)) {
        alert('Team slug can only contain lowercase letters, numbers, and hyphens');
        return;
    }

    // Check for duplicate slugs
    const existingTeams = adminSystem.getData('teams');
    const isDuplicate = existingTeams.some((team, index) => 
        team.slug === teamData.slug && index !== adminSystem.currentEditIndex
    );
    
    if (isDuplicate) {
        alert('A team with this slug already exists. Please use a different slug.');
        return;
    }

    try {
        const isEdit = adminSystem.currentEditIndex !== null;
        const actionText = isEdit ? 'Updating team...' : 'Creating team...';
        const successText = isEdit ? 'Team updated!' : 'Team created!';
        
        showLoading(actionText);
        
        // 1. CLOUD-FIRST: Save to cloud storage first
        if (window.netlifyDataManager) {
            const result = await window.netlifyDataManager.createTeam(teamData);

            if (!result.success) {
                throw new Error(result.error || 'Cloud save failed');
            }
            console.log('Team successfully synced to cloud storage');
        }

        // 2. Only update localStorage AFTER cloud succeeds
        let teams = adminSystem.getData('teams');

        if (isEdit) {
            const localIndex = teams.findIndex(t => t.id === teamData.id);
            if (localIndex !== -1) {
                teams[localIndex] = teamData;
            }
        } else {
            teams.unshift(teamData);
        }

        adminSystem.saveData('teams', teams);
        adminSystem.loadTeams();
        adminSystem.updateStats();

        // Update all team dropdowns
        updatePlayerTeamDropdown();
        updateFixtureTeamDropdown();
        updateGalleryTeamDropdown();

        showLoadingSuccess(successText);
        
        closeModal('teamModal');
        document.getElementById('teamForm').reset();
        // OLS 131: Reset training fields
        document.getElementById('teamShowInTraining').checked = false;
        document.getElementById('teamTrainingNotes').value = '';
        document.getElementById('teamTrainingFields').style.display = 'none';
        clearTrainingSlots();
        // OLS 125: Reset display order
        document.getElementById('teamDisplayOrder').value = '10';
        // OLS 130: Reset club section
        document.getElementById('teamClubSection').value = '';
        adminSystem.currentEditIndex = null;
        
    } catch (error) {
        console.error('Error saving team:', error);
        showLoadingError('Failed to save team');
    }
});

// Display Filters Form Handler
document.getElementById('filterForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const editIndex = document.getElementById('filterEditIndex').value;
    const selectedTeams = Array.from(document.querySelectorAll('input[name="filterTeams"]:checked'))
        .map(cb => cb.value);

    if (selectedTeams.length === 0) {
        alert('Please select at least one team!');
        return;
    }

    const filterData = {
        id: editIndex ? adminSystem.getData('team_filters')[editIndex].id : `filter-${Date.now()}`,
        name: document.getElementById('filterName').value.trim(),
        description: document.getElementById('filterDescription').value.trim(),
        teamSlugs: selectedTeams,
        enabled: document.getElementById('filterEnabled').checked,
        order: editIndex ? adminSystem.getData('team_filters')[editIndex].order : adminSystem.getData('team_filters').length + 1,
        createdAt: editIndex ? adminSystem.getData('team_filters')[editIndex].createdAt : new Date().toISOString()
    };

    const filters = adminSystem.getData('team_filters');
    if (editIndex) {
        filters[editIndex] = filterData;
    } else {
        filters.push(filterData);
    }

    // Save to localStorage for immediate use
    adminSystem.saveData('team_filters', filters);
    
    // 🆕 OLS 119: Save filters to site-settings (Blobs) instead of Netlify Forms
    try {
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                'team-display-filters': JSON.stringify(filters)
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                console.log('✅ Display filters saved to site-settings');
            } else {
                throw new Error(result.error || 'Failed to save filters');
            }
        } else {
            throw new Error(`HTTP ${response.status}`);
        }
    } catch (error) {
        console.error('❌ Error saving filters to site-settings:', error);
        adminSystem.showAlert('filters', 'Filter saved locally but cloud sync failed', 'warning');
    }
    
    adminSystem.loadFilters();
    closeModal('filterModal');
    document.getElementById('filterForm').reset();
    document.getElementById('filterEditIndex').value = '';
    adminSystem.showAlert('filters', 'Filter saved successfully!', 'success');
});

window.openFilterModal = function() {
    adminSystem.populateFilterTeamCheckboxes();
    openModal('filterModal');
};

// Function to update player team dropdown dynamically
window.updatePlayerTeamDropdown = function() {
    const dropdown = document.getElementById('playerTeam');
    if (!dropdown) return;
    
    // Save current selection before clearing
    const currentValue = dropdown.value;
    
    const teams = adminSystem.getData('teams');
    
    // Clear existing options
    dropdown.innerHTML = '';
    
    // Add teams from data
    if (teams.length > 0) {
        teams.forEach(team => {
            const option = document.createElement('option');
            option.value = team.slug;
            option.textContent = team.name;
            dropdown.appendChild(option);
        });
    } else {
        // If no teams, add a default option
        dropdown.innerHTML = '<option value="">No teams created yet</option>';
    }
    
    // Restore previous selection if it still exists
    if (currentValue && teams.some(team => team.slug === currentValue)) {
        dropdown.value = currentValue;
    }
};

// Function to update fixture team dropdown dynamically
window.updateFixtureTeamDropdown = function() {
    const dropdown = document.getElementById('fixtureTeam');
    if (!dropdown) return;
    
    const teams = adminSystem.getData('teams');
    
    // Clear existing options
    dropdown.innerHTML = '';
    
    // Add placeholder option first (OLS 100)
    const placeholderOption = document.createElement('option');
    placeholderOption.value = '';
    placeholderOption.textContent = '-- Select a team --';
    placeholderOption.disabled = true;
    placeholderOption.selected = true;
    dropdown.appendChild(placeholderOption);
    
    // Add teams from data
    teams.forEach(team => {
        const option = document.createElement('option');
        option.value = team.slug;
        option.textContent = team.name;
        dropdown.appendChild(option);
    });
    
    // If no teams, replace with different message
    if (teams.length === 0) {
        dropdown.innerHTML = '<option value="">No teams created yet</option>';
    }
};

// Function to update gallery team dropdown dynamically
window.updateGalleryTeamDropdown = function() {
    const dropdown = document.getElementById('galleryTeam');
    if (!dropdown) return;
    
    const teams = adminSystem.getData('teams');
    
    // Clear existing options (except "other" which we'll add back)
    dropdown.innerHTML = '';
    
    // Add teams from data
    teams.forEach(team => {
        const option = document.createElement('option');
        option.value = team.slug;
        option.textContent = team.name;
        dropdown.appendChild(option);
    });
    
    // Always add "other" option at the end
    const otherOption = document.createElement('option');
    otherOption.value = 'other';
    otherOption.textContent = 'Other (Club-wide/Social)';
    dropdown.appendChild(otherOption);
    
    // If no teams, just show "other" option
    if (teams.length === 0) {
        dropdown.innerHTML = '<option value="other">Other (Club-wide/Social)</option>';
    }
};

// GALLERY FORM SUBMISSION - Add after players form handler
document.getElementById('galleryForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const editIndex = document.getElementById('galleryEditIndex').value;
    const isEditMode = editIndex !== '';
    
    const albumTitle = document.getElementById('galleryTitle').value.trim();
    const albumCategory = document.getElementById('galleryCategory').value;
    const albumTeam = document.getElementById('galleryTeam').value;
    const albumFixtureId = document.getElementById('galleryFixture').value;
    const albumDescription = document.getElementById('galleryDescription').value.trim();
    const galleryFiles = document.getElementById('galleryFiles').files;

    // Validate inputs
    if (!albumTitle) {
        alert('Please enter an album title');
        return;
    }

    // EDIT MODE - Update existing album
    if (isEditMode) {
        try {
            const gallery = adminSystem.getData('gallery');
            const album = gallery[parseInt(editIndex)];
            
            // Parse photos if it's a JSON string
            if (typeof album.photos === 'string') {
                try {
                    album.photos = JSON.parse(album.photos);
                } catch (e) {
                    console.error('Error parsing album photos:', e);
                    alert('Error loading album photos. Please try again.');
                    return;
                }
            }
            
            // Get selected cover photo index
            const selectedCover = document.querySelector('.cover-photo-option.selected');
            const coverPhotoIndex = selectedCover ? parseInt(selectedCover.dataset.photoIndex) : 0;
            
            // Reorder photos array to put cover photo first
            if (coverPhotoIndex > 0 && Array.isArray(album.photos)) {
                const coverPhoto = album.photos.splice(coverPhotoIndex, 1)[0];
                album.photos.unshift(coverPhoto);
            }
            
            // Update album fields
            album.title = albumTitle;
            album.category = albumCategory;
            album.team = albumTeam;
            album.fixtureId = albumFixtureId || null;
            album.description = albumDescription;
            album.updatedAt = new Date().toISOString();
            
            // 1. CLOUD-FIRST: Sync to Netlify Blobs first
            if (window.netlifyDataManager) {
                const cloudResult = await window.netlifyDataManager.updateGalleryAlbum(album.id, album);
                if (!cloudResult.success) {
                    throw new Error(cloudResult.error || 'Cloud update failed');
                }
                console.log('Album updated in cloud storage');
            }

            // 2. Only update localStorage AFTER cloud succeeds
            adminSystem.saveData('gallery', gallery);
            adminSystem.loadGallery();
            adminSystem.updateStats();

            adminSystem.showAlert('gallery', 'Album updated successfully!', 'success');

            closeModal('galleryModal');
            return;
            
        } catch (error) {
            console.error('Error updating album:', error);
            alert('Error updating album: ' + error.message);
            return;
        }
    }

    // CREATE MODE - Upload new album
    if (galleryFiles.length === 0) {
        alert('Please select at least one photo to upload');
        return;
    }

    try {
        // Show upload progress
        const progressDiv = document.createElement('div');
        progressDiv.id = 'galleryUploadProgress';
        progressDiv.className = 'alert alert-info';
        progressDiv.style.position = 'fixed';
        progressDiv.style.top = '100px';
        progressDiv.style.right = '20px';
        progressDiv.style.zIndex = '10000';
        progressDiv.style.minWidth = '350px';
        document.body.appendChild(progressDiv);

        // Function to update progress
        const updateProgress = (message, current, total) => {
            const percentage = Math.round((current / total) * 100);
            progressDiv.innerHTML = `
                <strong>Uploading Album: ${albumTitle}</strong><br>
                ${message}<br>
                <div style="margin-top: 10px;">
                    <div style="background: #ddd; height: 8px; border-radius: 4px;">
                        <div style="background: var(--primary-green); height: 100%; width: ${percentage}%; border-radius: 4px; transition: width 0.3s ease;"></div>
                    </div>
                    <small>${current} / ${total} photos (${percentage}%)</small>
                </div>
            `;
        };

        // Upload photos to Cloudinary with album tag
        updateProgress('Starting upload...', 0, galleryFiles.length);

        const uploadResults = await window.cloudinaryUploader.uploadMultipleGalleryPhotos(
            galleryFiles,
            albumTitle,
            (progress) => {
                updateProgress(
                    `Uploading ${progress.fileName}...`,
                    progress.current,
                    progress.total
                );
            }
        );

        // Check for upload errors
        const failedUploads = uploadResults.filter(result => !result.success);
        if (failedUploads.length > 0) {
            console.warn('Some uploads failed:', failedUploads);
        }

        const successfulUploads = uploadResults.filter(result => result.success);

        if (successfulUploads.length === 0) {
            throw new Error('All photo uploads failed. Please try again.');
        }

        // Create album record
        const albumData = {
            id: Date.now().toString(),
            title: albumTitle,
            category: albumCategory,
            team: albumTeam,
            fixtureId: albumFixtureId || null, // Link to fixture (optional)
            description: albumDescription,
            date: new Date().toISOString(),
            photoCount: successfulUploads.length,
            photos: successfulUploads.map(result => ({
                url: result.url,
                publicId: result.publicId,
                albumTag: result.albumTag,
                width: result.width,
                height: result.height,
                uploadedAt: new Date().toISOString()
            })),
            albumTag: successfulUploads[0]?.albumTag || null
        };

        updateProgress('Syncing to cloud storage...', successfulUploads.length, galleryFiles.length);

        // 1. CLOUD-FIRST: Save to Netlify Blobs first
        if (window.netlifyDataManager) {
            const cloudResult = await window.netlifyDataManager.createGalleryAlbum(albumData);

            if (!cloudResult.success) {
                throw new Error(cloudResult.error || 'Cloud save failed');
            }
            console.log('Album successfully synced to cloud storage');
        }

        // 2. Only update localStorage AFTER cloud succeeds
        const existingGallery = adminSystem.getData('gallery');
        existingGallery.unshift(albumData);
        adminSystem.saveData('gallery', existingGallery);

        adminSystem.loadGallery();
        adminSystem.updateStats();

        // Remove progress indicator
        progressDiv.remove();

        // Show success message
        const successMessage = failedUploads.length > 0
            ? `Album created with ${successfulUploads.length} photos. ${failedUploads.length} photos failed to upload.`
            : `Album created successfully with ${successfulUploads.length} photos!`;

        adminSystem.showAlert('gallery', successMessage, failedUploads.length > 0 ? 'warning' : 'success');

        // Close modal and reset form
        closeModal('galleryModal');
        document.getElementById('galleryForm').reset();

        console.log('✅ Gallery album created:', albumData.title);
        console.log('📸 Photos uploaded:', successfulUploads.length);
        console.log('🏷️ Album tag:', albumData.albumTag);
        console.log('☁️ Synced to Netlify Forms');

    } catch (error) {
        console.error('❌ Gallery upload error:', error);
        
        // Remove progress indicator if exists
        const progressDiv = document.getElementById('galleryUploadProgress');
        if (progressDiv) {
            progressDiv.remove();
        }

        adminSystem.showAlert('gallery', 'Error uploading album: ' + error.message, 'danger');
    }
});

// ADD THIS FIXTURES FORM SUBMISSION HERE:
    document.getElementById('fixtureForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // OLS 122: Get teamsheet URL if uploaded
        const teamsheetPreviewImg = document.getElementById('teamsheetPreviewImg');
        let teamsheetUrl = teamsheetPreviewImg?.dataset?.cloudinaryUrl || null;
        
        // If there's a file selected but not yet uploaded, upload it now
        const teamsheetInput = document.getElementById('fixtureTeamsheet');
        if (teamsheetInput.files.length > 0 && !teamsheetUrl) {
            showLoading('Uploading teamsheet...');
            try {
                const result = await window.cloudinaryUploader.uploadImage(teamsheetInput.files[0], 'teamsheets');
                teamsheetUrl = result;
                console.log('✅ Teamsheet uploaded:', teamsheetUrl);
            } catch (uploadError) {
                console.error('❌ Teamsheet upload failed:', uploadError);
                // Continue without teamsheet
            }
        }
        
        // Preserve existing teamsheet if editing and no new one uploaded
        if (adminSystem.currentEditIndex !== null && !teamsheetUrl) {
            const existingFixture = adminSystem.getData('fixtures')[adminSystem.currentEditIndex];
            teamsheetUrl = existingFixture.teamsheetUrl || null;
        }
        
        const fixtureData = {
            id: adminSystem.currentEditIndex !== null ? 
                adminSystem.getData('fixtures')[adminSystem.currentEditIndex].id : 
                Date.now().toString(),
            team: document.getElementById('fixtureTeam').value,
            opponent: document.getElementById('fixtureOpponent').value.trim(),
            dateTime: document.getElementById('fixtureDateTime').value,
            venue: document.getElementById('fixtureVenue').value,
            competition: document.getElementById('fixtureCompetition').value.trim(),
            ourScore: document.getElementById('fixtureOurScore').value !== '' ? parseInt(document.getElementById('fixtureOurScore').value) : null,
            theirScore: document.getElementById('fixtureTheirScore').value !== '' ? parseInt(document.getElementById('fixtureTheirScore').value) : null,
            matchStatus: document.getElementById('fixtureMatchStatus').value || 'played',
            // OLS 122: Teamsheet URL
            teamsheetUrl: teamsheetUrl
        };

        // Validate required fields (OLS 100: Added team validation)
        if (!fixtureData.team || !fixtureData.opponent || !fixtureData.dateTime) {
            alert('Please fill in all required fields (Team, Opponent, and Date/Time)');
            return;
        }

        const isEditing = adminSystem.currentEditIndex !== null;
        const actionText = isEditing ? 'Updating fixture...' : 'Creating fixture...';
        showLoading(actionText);

        try {
            // 1. CLOUD-FIRST: Save to cloud storage first
            if (window.netlifyDataManager) {
                let result;

                if (isEditing && typeof window.netlifyDataManager.updateFixture === 'function') {
                    console.log('Updating fixture in cloud...');
                    result = await window.netlifyDataManager.updateFixture(fixtureData.id, fixtureData);
                } else {
                    console.log('Creating new fixture in cloud...');
                    result = await window.netlifyDataManager.createFixture(fixtureData);
                }

                if (!result.success) {
                    throw new Error(result.error || 'Cloud save failed');
                }
                console.log('Fixture successfully synced to cloud storage');
            }

            // 2. Only update localStorage AFTER cloud succeeds
            let existingFixtures = adminSystem.getData('fixtures');

            if (isEditing) {
                const localIndex = existingFixtures.findIndex(f => f.id === fixtureData.id);
                if (localIndex !== -1) {
                    existingFixtures[localIndex] = fixtureData;
                }
            } else {
                existingFixtures.unshift(fixtureData);
            }

            adminSystem.saveData('fixtures', existingFixtures);
            const currentFilter = document.getElementById('admin-team-filter')?.value || 'all';
            adminSystem.loadFixtures(currentFilter, currentFixtureTimeFilter);
            adminSystem.updateStats();

            const successText = isEditing ? 'Fixture updated!' : 'Fixture created!';
            showLoadingSuccess(successText);

            closeModal('fixtureModal');
            document.getElementById('fixtureForm').reset();
            document.getElementById('fixtureScoreFields').style.display = '';
            adminSystem.currentEditIndex = null;

        } catch (error) {
            console.error('Error saving fixture:', error);
            showLoadingError('Failed to save fixture');
            adminSystem.showAlert('fixtures', 'Error saving fixture: ' + error.message, 'danger');
        }
    });

    // OLS 122: Teamsheet file upload handlers
    // Click on upload area to trigger file input
    document.querySelector('#fixtureModal .file-upload')?.addEventListener('click', function() {
        document.getElementById('fixtureTeamsheet').click();
    });
    
    // Handle teamsheet file selection
    document.getElementById('fixtureTeamsheet')?.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const preview = document.getElementById('teamsheetPreview');
        const previewImg = document.getElementById('teamsheetPreviewImg');
        const status = document.getElementById('teamsheetStatus');
        
        // Show local preview immediately
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.style.display = 'block';
            status.textContent = '⏳ Uploading...';
        };
        reader.readAsDataURL(file);
        
        // Upload to Cloudinary
        if (window.cloudinaryUploader) {
            try {
                preview.style.opacity = '0.7';
                const url = await window.cloudinaryUploader.uploadImage(file, 'teamsheets');
                preview.style.opacity = '1';
                
                previewImg.dataset.cloudinaryUrl = url;
                previewImg.src = url;
                status.textContent = '✅ Teamsheet uploaded';
                console.log('✅ Teamsheet uploaded:', url);
            } catch (error) {
                preview.style.opacity = '1';
                status.textContent = '⚠️ Upload failed - will retry on save';
                console.error('❌ Teamsheet upload error:', error);
            }
        }
    });

    // Clear teamsheet function
    window.clearTeamsheet = function() {
        const preview = document.getElementById('teamsheetPreview');
        const previewImg = document.getElementById('teamsheetPreviewImg');
        const input = document.getElementById('fixtureTeamsheet');
        
        preview.style.display = 'none';
        previewImg.src = '';
        previewImg.dataset.cloudinaryUrl = '';
        input.value = '';
        
        console.log('🗑️ Teamsheet cleared');
    };

            // Logo file upload handler
            document.getElementById('sponsorLogo').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const logoPreview = document.getElementById('logoPreview');
    const logoPreviewImg = document.getElementById('logoPreviewImg');

    // Show local preview immediately
    const reader = new FileReader();
    reader.onload = function(e) {
        logoPreviewImg.src = e.target.result;
        logoPreview.style.display = 'block';
    };
    reader.readAsDataURL(file);

    // Upload to Cloudinary (if available)
    if (window.cloudinaryUploader) {
        try {
            logoPreview.style.opacity = '0.5';
            const result = await window.cloudinaryUploader.uploadSponsorLogo(file);
            logoPreview.style.opacity = '1';

            if (result.success) {
                logoPreviewImg.dataset.cloudinaryUrl = result.url;
                logoPreviewImg.src = result.url;
                console.log('✅ Cloudinary URL:', result.url);
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            logoPreview.style.opacity = '1';
            console.warn('Cloudinary upload failed, using local preview:', error);
            // Keep the local preview - don't clear it
        }
    }
});

// 🎯 NEW: Image Preview Handler for News
document.getElementById('newsImage').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const imagePreview = document.getElementById('newsImagePreview');
    const imagePreviewImg = document.getElementById('newsImagePreviewImg');
    const statusEl = document.getElementById('newsImageStatus');

    // Show local preview immediately
    const reader = new FileReader();
    reader.onload = function(e) {
        imagePreviewImg.src = e.target.result;
        imagePreview.style.display = 'block';
        if (statusEl) statusEl.textContent = '📷 Image ready to upload';
    };
    reader.readAsDataURL(file);

    // Upload to Cloudinary in background
    if (window.cloudinaryUploader) {
        try {
            if (statusEl) statusEl.textContent = '☁️ Uploading to cloud...';
            imagePreview.style.opacity = '0.6';
            
            const result = await window.cloudinaryUploader.uploadNewsImage(file);
            
            imagePreview.style.opacity = '1';

            if (result.success) {
                imagePreviewImg.dataset.cloudinaryUrl = result.url;
                imagePreviewImg.src = result.url;
                if (statusEl) statusEl.textContent = '✅ Uploaded to cloud successfully!';
                console.log('✅ Cloudinary URL:', result.url);
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            imagePreview.style.opacity = '1';
            if (statusEl) statusEl.textContent = '⚠️ Cloud upload pending (will retry on save)';
            console.warn('Cloudinary upload failed, using local preview:', error);
        }
    }
});

});

        // Session check and initialize
        document.addEventListener('DOMContentLoaded', function() {
    console.log('=== 🎯 DOMCONTENTLOADED EVENT FIRED ===');
    console.log('Time:', new Date().toISOString());
    
    // Check session
    const session = checkAdminSession();
    if (!session) {
        console.error('❌ No session found!');
        return;
    }
    console.log(`✅ Session valid: ${session.username}`);
    
    // DEBUG: Check data on page load
    console.log('=== ADMIN DASHBOARD LOAD DEBUG ===');
    
    // Check localStorage data
    console.log('📦 LocalStorage data on page load:');
    ['news', 'fixtures', 'players', 'sponsors', 'gallery', 'shop'].forEach(type => {
        const data = JSON.parse(localStorage.getItem('olrfc_' + type) || '[]');
        console.log(`  ${type}: ${data.length} records`);
    });
    
    // Check if stat elements exist
    console.log('🎯 Stat card elements exist:');
    console.log('  newsCount:', !!document.getElementById('newsCount'));
    console.log('  fixturesCount:', !!document.getElementById('fixturesCount'));
    console.log('  playersCount:', !!document.getElementById('playersCount'));
    console.log('  sponsorsCount:', !!document.getElementById('sponsorsCount'));
    console.log('  galleryCount:', !!document.getElementById('galleryCount'));
    console.log('  shopCount:', !!document.getElementById('shopCount'));
    
    // Check if adminSystem exists
    console.log('🔍 Checking adminSystem:', !!window.adminSystem);
    
    // Force stats update immediately
    console.log('🔄 Forcing initial stats update...');
    if (window.adminSystem) {
        window.adminSystem.updateStats();
        console.log('✅ Initial stats update completed');
    } else {
        console.error('❌ adminSystem not found on window object!');
    }
    
    // Force another update after 500ms
    setTimeout(function() {
        console.log('⏰ Running delayed stats update (500ms)...');
        if (window.adminSystem) {
            window.adminSystem.updateStats();
        }
    }, 500);
    
    // Force another update after 2 seconds
    setTimeout(function() {
        console.log('⏰ Running final stats update (2000ms)...');
        if (window.adminSystem) {
            window.adminSystem.updateStats();
        }
    }, 2000);
    
    // Load website feature states
    loadWebsiteFeatureStates();
});

        // Session check function
        function checkAdminSession() {
            const session = localStorage.getItem('olrfc_admin_session');
            if (!session) {
                // For demo purposes, create a session
                const demoSession = {
                    username: 'Admin User',
                    timestamp: new Date().getTime()
                };
                localStorage.setItem('olrfc_admin_session', JSON.stringify(demoSession));
                return demoSession;
            }
            
            const sessionData = JSON.parse(session);
            const now = new Date().getTime();
            
            if (now - sessionData.timestamp > 24 * 60 * 60 * 1000) {
                localStorage.removeItem('olrfc_admin_session');
                return checkAdminSession(); // Recreate session for demo
            }
            
            return sessionData;
        }

        // Logout function
        function adminLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('olrfc_admin_session');
                alert('Logged out successfully!');
                window.location.href = '../index.html';
            }
        }

        // Initialize sample data
function initializeSampleData() {
    // ⚠️ DISABLED - Sample data generation turned off for production
    console.log('Sample data initialization disabled');
    return;
    
    // Original code kept for reference but never executed
    /*
    if (adminSystem.getData('shop').length === 0) {
        const sampleProducts = [
            {
                name: "Home Jersey 2025",
                category: "jerseys",
                description: "Official Old Laurentian RFC home jersey for the 2025 season.",
                price: "65.00",
                stock: 25,
                sku: "OLS-HJ-2025",
                sizes: ["S", "M", "L", "XL", "XXL"],
                status: "active",
                images: [],
                weight: 0.3,
                shipping: 4.99,
                dateAdded: new Date().toISOString()
            }
        ];
        adminSystem.saveData('shop', sampleProducts);
    }

    if (adminSystem.getData('sponsors').length === 0) {
        const sampleSponsors = [
            {
                id: 1,
                name: "Local Sports Equipment",
                tier: "gold",
                phone: "01234 567890",
                email: "info@localsports.com",
                website: "https://www.localsports.com",
                logo: null,
                active: true,
                showInBanner: true,
                dateAdded: new Date().toISOString()
            },
            {
                id: 2,
                name: "Community Bank",
                tier: "silver",
                phone: "01234 567891",
                email: "community@bank.com",
                website: "https://www.communitybank.com",
                logo: null,
                active: true,
                showInBanner: true,
                dateAdded: new Date().toISOString()
            }
        ];
        adminSystem.saveData('sponsors', sampleSponsors);
    }

    adminSystem.loadAllData();
    */
}

        // Placeholder functions for other features
        function editNews(index) {
    const news = adminSystem.getData('news');
    const article = news[index];

    if (!article) {
        console.error('Article not found at index:', index);
        return;
    }

    adminSystem.currentEditIndex = index;
    adminSystem.currentSection = 'news';
    
    // Populate form with existing data
    document.getElementById('newsTitle').value = article.title;
    document.getElementById('newsContent').value = article.content;
    document.getElementById('newsCategory').value = article.category;
    document.getElementById('newsAuthor').value = article.author;
    document.getElementById('newsPublishDate').value = article.date || '';
    
    // OLS 130: Populate and set club section
    populateNewsClubSectionDropdown();
    document.getElementById('newsClubSection').value = article.clubSection || 'all';
    
    // 🎯 NEW: Handle existing image
    const newsImagePreview = document.getElementById('newsImagePreview');
    const newsImagePreviewImg = document.getElementById('newsImagePreviewImg');
    const newsImageStatus = document.getElementById('newsImageStatus');
    
    if (article.image) {
        // Show existing image
        newsImagePreviewImg.src = article.image;
        newsImagePreviewImg.dataset.cloudinaryUrl = article.image;
        newsImagePreview.style.display = 'block';
        
        if (newsImageStatus) {
            newsImageStatus.textContent = '📷 Current article image (upload new to replace)';
        }
        
        console.log('✅ Loaded existing image for editing:', article.image);
    } else {
        // No existing image - hide preview
        newsImagePreview.style.display = 'none';
        newsImagePreviewImg.dataset.cloudinaryUrl = '';
        
        if (newsImageStatus) {
            newsImageStatus.textContent = '📷 No image yet';
        }
    }
    
    // Clear the file input (so user can select same file again if needed)
    document.getElementById('newsImage').value = '';
    
    openModal('newsModal');
    
    // OLS 122: Handle fixture dropdown after modal opens
    setTimeout(() => {
        toggleNewsFixtureDropdown();
        // Set the fixture value if it exists
        if (article.fixtureId) {
            document.getElementById('newsFixture').value = article.fixtureId;
        }
    }, 50);
}

async function deleteNews(index) {
    const news = adminSystem.getData('news');
    const article = news[index];

    if (!article) {
        console.error('Article not found at index:', index);
        return;
    }

    if (confirm(`Are you sure you want to delete "${article.title}"?`)) {
        showLoading('Deleting article...');

        try {
            // 1. CLOUD-FIRST: Delete from Netlify Blobs first
            if (window.netlifyDataManager) {
                const result = await window.netlifyDataManager.deleteNews(article.id);

                if (!result.success) {
                    throw new Error(result.error || 'Cloud deletion failed');
                }
                console.log('News article deleted from cloud storage');
            }

            // 2. Only delete from localStorage AFTER cloud succeeds
            const freshNews = adminSystem.getData('news');
            const localIndex = freshNews.findIndex(n => n.id === article.id);
            if (localIndex !== -1) {
                freshNews.splice(localIndex, 1);
                adminSystem.saveData('news', freshNews);
            }

            // Update UI
            adminSystem.loadNews();
            adminSystem.updateStats();
            showLoadingSuccess('Article deleted!');

        } catch (error) {
            console.error('Error deleting news:', error);
            showLoadingError('Failed to delete article');
            adminSystem.showAlert('news', 'Error deleting news: ' + error.message, 'danger');
        }
    }
}

// ============================================================================
// OLS 122: NEWS FIXTURE TAGGING
// ============================================================================

/**
 * Toggle visibility of fixture dropdown based on news category
 * Only show when category is "match" (Match Report)
 */
function toggleNewsFixtureDropdown() {
    const category = document.getElementById('newsCategory').value;
    const fixtureGroup = document.getElementById('newsFixtureGroup');
    
    if (fixtureGroup) {
        if (category === 'match') {
            fixtureGroup.style.display = 'block';
            // Populate fixtures when showing
            populateNewsFixtureDropdown();
        } else {
            fixtureGroup.style.display = 'none';
            // Clear selection when hiding
            document.getElementById('newsFixture').value = '';
        }
    }
}

/**
 * Populate the fixture dropdown in the news form
 * Shows all fixtures, sorted by date (newest first)
 */
function populateNewsFixtureDropdown() {
    const dropdown = document.getElementById('newsFixture');
    if (!dropdown) {
        console.warn('⚠️ newsFixture dropdown not found');
        return;
    }
    
    const fixtures = adminSystem.getData('fixtures');
    
    // Clear and add default option
    dropdown.innerHTML = '<option value="">-- Select Fixture --</option>';
    
    if (!fixtures || fixtures.length === 0) {
        console.log('📭 No fixtures available for news fixture dropdown');
        return;
    }
    
    // Sort fixtures by date (newest first)
    const sortedFixtures = [...fixtures].sort((a, b) => {
        const dateA = new Date(a.dateTime || a.date);
        const dateB = new Date(b.dateTime || b.date);
        return dateB - dateA;
    });
    
    // Group into past (completed) and upcoming fixtures
    const now = new Date();
    const pastFixtures = sortedFixtures.filter(f => new Date(f.dateTime || f.date) < now);
    const upcomingFixtures = sortedFixtures.filter(f => new Date(f.dateTime || f.date) >= now);
    
    // Add past fixtures first (more likely to need match reports)
    if (pastFixtures.length > 0) {
        const pastGroup = document.createElement('optgroup');
        pastGroup.label = '📋 Past Fixtures';
        pastFixtures.forEach(fixture => {
            const option = createFixtureOption(fixture);
            pastGroup.appendChild(option);
        });
        dropdown.appendChild(pastGroup);
    }
    
    // Add upcoming fixtures
    if (upcomingFixtures.length > 0) {
        const upcomingGroup = document.createElement('optgroup');
        upcomingGroup.label = '📅 Upcoming Fixtures';
        upcomingFixtures.forEach(fixture => {
            const option = createFixtureOption(fixture);
            upcomingGroup.appendChild(option);
        });
        dropdown.appendChild(upcomingGroup);
    }
    
    console.log(`✅ Loaded ${pastFixtures.length} past + ${upcomingFixtures.length} upcoming fixtures into news dropdown`);
}

/**
 * Helper function to create a fixture option element
 */
function createFixtureOption(fixture) {
    const option = document.createElement('option');
    option.value = fixture.id;
    
    // Format date
    let dateStr = 'Date TBC';
    const dateValue = fixture.dateTime || fixture.date;
    if (dateValue) {
        try {
            const date = new Date(dateValue);
            if (!isNaN(date.getTime())) {
                dateStr = date.toLocaleDateString('en-GB', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
            }
        } catch (e) {
            dateStr = dateValue;
        }
    }
    
    // Home/away indicator
    const homeAway = (fixture.venue === 'away') ? '@' : 'vs';
    const opponent = fixture.opponent || 'TBC';
    
    // Build display text
    let displayText = `${dateStr} - ${homeAway} ${opponent}`;
    
    // Add score if available
    if (fixture.ourScore !== null && fixture.ourScore !== undefined && fixture.ourScore !== '') {
        displayText += ` (${fixture.ourScore}-${fixture.theirScore})`;
    }
    
    // Add team name for clarity
    if (fixture.team) {
        const teams = adminSystem.getData('teams');
        const teamObj = teams.find(t => t.id === fixture.team);
        if (teamObj) {
            displayText += ` [${teamObj.name}]`;
        }
    }
    
    option.textContent = displayText;
    return option;
}

// ============================================================================
// END NEWS FIXTURE TAGGING
// ============================================================================

// ============================================================================
// FIXTURE TIME FILTER (OLS 100)
// ============================================================================

/**
 * Switch between upcoming and past fixtures tabs
 */
function switchFixtureTimeTab(timeFilter) {
    console.log(`🔄 Switching to ${timeFilter} fixtures tab`);
    
    // Update global state
    currentFixtureTimeFilter = timeFilter;
    
    // Update tab styling
    document.querySelectorAll('.fixture-time-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.getElementById(`tab-${timeFilter}`).classList.add('active');
    
    // Reload fixtures with current team filter and new time filter
    const currentTeamFilter = document.getElementById('admin-team-filter')?.value || 'all';
    if (window.adminSystem) {
        window.adminSystem.loadFixtures(currentTeamFilter, timeFilter);
    }
}

// ============================================================================
// END FIXTURE TIME FILTER
// ============================================================================

        // Toggle score fields visibility based on match status
        function toggleFixtureScoreFields() {
            const status = document.getElementById('fixtureMatchStatus').value;
            const scoreFields = document.getElementById('fixtureScoreFields');
            if (status === 'cancelled' || status === 'postponed') {
                scoreFields.style.display = 'none';
                document.getElementById('fixtureOurScore').value = '';
                document.getElementById('fixtureTheirScore').value = '';
            } else {
                scoreFields.style.display = '';
            }
        }

        // Toggle score inputs in bulk edit row based on match status
        function toggleBulkEditScoreFields(fixtureId, statusValue) {
            const row = document.querySelector(`tr[data-fixture-id="${fixtureId}"]`);
            if (!row) return;
            const ourScoreInput = row.querySelector('input[data-field="ourScore"]');
            const theirScoreInput = row.querySelector('input[data-field="theirScore"]');
            if (statusValue === 'cancelled' || statusValue === 'postponed') {
                ourScoreInput.disabled = true;
                theirScoreInput.disabled = true;
                ourScoreInput.value = '';
                theirScoreInput.value = '';
                ourScoreInput.style.opacity = '0.4';
                theirScoreInput.style.opacity = '0.4';
            } else {
                ourScoreInput.disabled = false;
                theirScoreInput.disabled = false;
                ourScoreInput.style.opacity = '';
                theirScoreInput.style.opacity = '';
            }
        }

        function editFixture(index) {
    const fixtures = adminSystem.getData('fixtures');
    const fixture = fixtures[index];

    if (!fixture) {
        console.error('Fixture not found at index:', index);
        return;
    }

    adminSystem.currentEditIndex = index;
    adminSystem.currentSection = 'fixtures';
    
    // Open modal FIRST
    openModal('fixtureModal');
    
    // THEN populate form fields after a delay (to allow dropdown population to complete)
    setTimeout(() => {
        // Populate form fields
        document.getElementById('fixtureTeam').value = fixture.team;
        document.getElementById('fixtureOpponent').value = fixture.opponent;
        document.getElementById('fixtureDateTime').value = fixture.dateTime;
        document.getElementById('fixtureVenue').value = fixture.venue;
        document.getElementById('fixtureCompetition').value = fixture.competition || '';
        document.getElementById('fixtureOurScore').value = fixture.ourScore !== null && fixture.ourScore !== undefined ? fixture.ourScore : '';
        document.getElementById('fixtureTheirScore').value = fixture.theirScore !== null && fixture.theirScore !== undefined ? fixture.theirScore : '';

        // Set match status and toggle score fields visibility
        document.getElementById('fixtureMatchStatus').value = fixture.matchStatus || 'played';
        toggleFixtureScoreFields();

        // OLS 122: Load teamsheet preview if exists
        const teamsheetPreview = document.getElementById('teamsheetPreview');
        const teamsheetPreviewImg = document.getElementById('teamsheetPreviewImg');
        const teamsheetStatus = document.getElementById('teamsheetStatus');
        
        if (fixture.teamsheetUrl) {
            teamsheetPreviewImg.src = fixture.teamsheetUrl;
            teamsheetPreviewImg.dataset.cloudinaryUrl = fixture.teamsheetUrl;
            teamsheetPreview.style.display = 'block';
            teamsheetStatus.textContent = '📋 Current teamsheet (upload new to replace)';
            console.log('✅ Loaded existing teamsheet:', fixture.teamsheetUrl);
        } else {
            teamsheetPreview.style.display = 'none';
            teamsheetPreviewImg.src = '';
            teamsheetPreviewImg.dataset.cloudinaryUrl = '';
        }
    }, 50); // Slightly longer than openModal's 30ms to ensure dropdown is populated
}

async function deleteFixture(index) {
    const fixtures = adminSystem.getData('fixtures');
    const fixture = fixtures[index];

    if (!fixture) {
        console.error('Fixture not found at index:', index);
        return;
    }

    if (confirm(`Are you sure you want to delete the fixture against ${fixture.opponent}?`)) {
        showLoading('Deleting fixture...');

        try {
            // 1. CLOUD-FIRST: Delete from Netlify Blobs and Google Calendar first
            if (window.netlifyDataManager) {
                const result = await window.netlifyDataManager.deleteFixture(fixture);

                if (!result.success) {
                    throw new Error(result.error || 'Cloud deletion failed');
                }
                console.log('Fixture successfully deleted from cloud');
            }

            // 2. Only delete from localStorage AFTER cloud succeeds
            const freshFixtures = adminSystem.getData('fixtures');
            const localIndex = freshFixtures.findIndex(f => f.id === fixture.id);
            if (localIndex !== -1) {
                freshFixtures.splice(localIndex, 1);
                adminSystem.saveData('fixtures', freshFixtures);
            }

            const currentFilter = document.getElementById('admin-team-filter')?.value || 'all';
            adminSystem.loadFixtures(currentFilter, currentFixtureTimeFilter);
            adminSystem.updateStats();
            showLoadingSuccess('Fixture deleted!');

        } catch (error) {
            console.error('Error deleting fixture:', error);
            showLoadingError('Failed to delete fixture');
            adminSystem.showAlert('fixtures', 'Error deleting fixture: ' + error.message, 'danger');
        }
    }
}

// ============================================================================
// BULK EDIT FIXTURES - OLS 127 Enhanced
// Supports bulk ADD, EDIT, and DELETE operations
// ============================================================================

// Store original fixture data for change detection
let bulkEditOriginalData = {};
let bulkEditChangedCells = new Set();

// OLS 127: Track new rows and rows marked for deletion
let bulkEditNewRows = [];      // Array of temp IDs for new rows
let bulkEditDeleteIds = new Set();  // Set of fixture IDs marked for deletion
let bulkEditSelectedIds = new Set(); // Set of selected fixture IDs (for bulk delete)
let bulkEditNewRowCounter = 0;  // Counter for generating temp IDs

// OLS SAFETY: Snapshot of total fixture count when bulk edit was opened
// Used to prevent saving if data has become incomplete
let bulkEditSnapshotCount = 0;
let bulkEditCloudCount = null; // Will be fetched from cloud on open

/**
 * Open the bulk edit modal and populate with all fixtures
 */
async function openBulkEditFixtures(teamFilter = null) {
    // OLS SAFETY: First, sync fresh data from cloud before opening bulk edit
    // This prevents editing stale/partial data from localStorage
    showLoading('Loading fixtures from cloud...');

    try {
        const cloudResponse = await fetch('/.netlify/functions/fixtures', { method: 'GET' });
        if (cloudResponse.ok) {
            const cloudResult = await cloudResponse.json();
            const cloudFixtures = cloudResult.data || [];
            bulkEditCloudCount = cloudFixtures.length;

            // Update localStorage with fresh cloud data before opening editor
            localStorage.setItem('olrfc_fixtures', JSON.stringify(cloudFixtures));
            console.log(`✅ Bulk edit: Synced ${cloudFixtures.length} fixtures from cloud before editing`);
        } else {
            console.warn('⚠️ Could not fetch fixtures from cloud, using localStorage');
            bulkEditCloudCount = null;
        }
    } catch (err) {
        console.warn('⚠️ Cloud sync failed before bulk edit, using localStorage:', err.message);
        bulkEditCloudCount = null;
    }

    hideLoading();

    const allFixtures = adminSystem.getData('fixtures');
    const teams = adminSystem.getData('teams');

    // OLS SAFETY: Record the total count when we opened the editor
    bulkEditSnapshotCount = allFixtures.length;
    console.log(`📸 Bulk edit snapshot: ${bulkEditSnapshotCount} total fixtures at open time`);

    // Get current filter from main page if not provided
    if (teamFilter === null) {
        teamFilter = document.getElementById('admin-team-filter')?.value || 'all';
    }

    // Reset all tracking
    bulkEditOriginalData = {};
    bulkEditChangedCells.clear();
    bulkEditNewRows = [];
    bulkEditDeleteIds.clear();
    bulkEditSelectedIds.clear();
    bulkEditNewRowCounter = 0;

    // Clear any previous spreadsheet import summary
    const importSummary = document.getElementById('spreadsheetImportSummary');
    if (importSummary) {
        importSummary.style.display = 'none';
        importSummary.innerHTML = '';
    }

    // Reset select all checkbox
    const selectAllCheckbox = document.getElementById('bulkSelectAll');
    if (selectAllCheckbox) selectAllCheckbox.checked = false;

    // Populate the bulk edit team filter dropdown
    const bulkEditTeamFilter = document.getElementById('bulk-edit-team-filter');
    bulkEditTeamFilter.innerHTML = '<option value="all">All Teams</option>';
    teams.forEach(team => {
        const option = document.createElement('option');
        option.value = team.slug;
        option.textContent = team.name;
        bulkEditTeamFilter.appendChild(option);
    });

    // Set the current filter
    bulkEditTeamFilter.value = teamFilter;

    // Add event listener for filter changes (remove any existing first)
    const newFilter = bulkEditTeamFilter.cloneNode(true);
    bulkEditTeamFilter.parentNode.replaceChild(newFilter, bulkEditTeamFilter);
    newFilter.addEventListener('change', function() {
        // Check for unsaved changes
        const hasChanges = bulkEditChangedCells.size > 0 || bulkEditNewRows.length > 0 || bulkEditDeleteIds.size > 0;
        if (hasChanges) {
            if (!confirm(`You have unsaved changes. Changing the filter will discard these changes. Continue?`)) {
                this.value = teamFilter;
                return;
            }
        }
        reloadBulkEditTable(this.value);
    });

    // Filter fixtures based on selected team
    let fixtures = teamFilter === 'all'
        ? allFixtures
        : allFixtures.filter(fixture => fixture.team === teamFilter);

    // Sort fixtures: Upcoming first (soonest), then Past (most recent)
    const now = new Date();
    fixtures = fixtures.sort((a, b) => {
        const dateA = new Date(a.dateTime);
        const dateB = new Date(b.dateTime);
        const aIsUpcoming = dateA >= now;
        const bIsUpcoming = dateB >= now;

        if (aIsUpcoming === bIsUpcoming) {
            return aIsUpcoming ? dateA - dateB : dateB - dateA;
        }
        return aIsUpcoming ? -1 : 1;
    });

    // Update fixture count
    const countDisplay = document.getElementById('bulk-edit-fixture-count');
    countDisplay.textContent = `${fixtures.length} fixture${fixtures.length !== 1 ? 's' : ''}`;

    // Build team options HTML for dropdowns
    let teamOptionsHTML = '<option value="">-- Select team --</option>';
    teams.forEach(team => {
        teamOptionsHTML += `<option value="${team.slug}">${team.name}</option>`;
    });

    // Store team options for new rows
    window.bulkEditTeamOptionsHTML = teamOptionsHTML;

    // Populate table
    const tbody = document.getElementById('bulkEditFixturesBody');
    tbody.innerHTML = '';

    fixtures.forEach((fixture, displayIndex) => {
        const actualIndex = allFixtures.indexOf(fixture);
        bulkEditOriginalData[fixture.id] = JSON.parse(JSON.stringify(fixture));

        const row = createBulkEditRow(fixture, actualIndex, teamOptionsHTML, false);
        tbody.appendChild(row);
    });

    // Update UI counters
    updateBulkEditChangesCount();
    updateBulkDeleteButton();

    // Open modal
    document.getElementById('bulkEditFixturesModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

/**
 * Create a table row for bulk edit
 */
function createBulkEditRow(fixture, actualIndex, teamOptionsHTML, isNew = false) {
    const dateTimeObj = fixture.dateTime ? new Date(fixture.dateTime) : new Date();
    const dateStr = dateTimeObj.toISOString().split('T')[0];
    const timeStr = dateTimeObj.toTimeString().slice(0, 5);
    
    const row = document.createElement('tr');
    row.setAttribute('data-fixture-id', fixture.id);
    row.setAttribute('data-actual-index', actualIndex);
    
    if (isNew) {
        row.classList.add('new-row');
        row.setAttribute('data-is-new', 'true');
    }
    
    row.innerHTML = `
        <td class="checkbox-cell" style="text-align: center; padding: 0.5rem;">
            <input type="checkbox" class="bulk-select-checkbox" data-fixture-id="${fixture.id}" onchange="bulkToggleSelection('${fixture.id}', this.checked)">
        </td>
        <td data-field="team" data-fixture-id="${fixture.id}">
            <select data-field="team" data-fixture-id="${fixture.id}" onchange="bulkEditTrackChange('${fixture.id}', 'team', this.value)">
                ${teamOptionsHTML}
            </select>
        </td>
        <td data-field="opponent" data-fixture-id="${fixture.id}">
            <input type="text" value="${fixture.opponent || ''}" data-field="opponent" data-fixture-id="${fixture.id}" oninput="bulkEditTrackChange('${fixture.id}', 'opponent', this.value)">
        </td>
        <td data-field="date" data-fixture-id="${fixture.id}">
            <input type="date" value="${dateStr}" data-field="date" data-fixture-id="${fixture.id}" onchange="bulkEditTrackChange('${fixture.id}', 'date', this.value)">
        </td>
        <td data-field="time" data-fixture-id="${fixture.id}">
            <input type="time" value="${timeStr}" data-field="time" data-fixture-id="${fixture.id}" onchange="bulkEditTrackChange('${fixture.id}', 'time', this.value)">
        </td>
        <td data-field="venue" data-fixture-id="${fixture.id}">
            <select data-field="venue" data-fixture-id="${fixture.id}" onchange="bulkEditTrackChange('${fixture.id}', 'venue', this.value)">
                <option value="home" ${fixture.venue === 'home' ? 'selected' : ''}>Home</option>
                <option value="away" ${fixture.venue === 'away' ? 'selected' : ''}>Away</option>
            </select>
        </td>
        <td data-field="competition" data-fixture-id="${fixture.id}">
            <input type="text" value="${fixture.competition || ''}" data-field="competition" data-fixture-id="${fixture.id}" oninput="bulkEditTrackChange('${fixture.id}', 'competition', this.value)">
        </td>
        <td data-field="matchStatus" data-fixture-id="${fixture.id}">
            <select data-field="matchStatus" data-fixture-id="${fixture.id}" onchange="bulkEditTrackChange('${fixture.id}', 'matchStatus', this.value); toggleBulkEditScoreFields('${fixture.id}', this.value)">
                <option value="played" ${(!fixture.matchStatus || fixture.matchStatus === 'played') ? 'selected' : ''}>Played</option>
                <option value="cancelled" ${fixture.matchStatus === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                <option value="postponed" ${fixture.matchStatus === 'postponed' ? 'selected' : ''}>Postponed</option>
            </select>
        </td>
        <td data-field="ourScore" data-fixture-id="${fixture.id}">
            <input type="number" min="0" value="${fixture.ourScore || ''}" placeholder="-" data-field="ourScore" data-fixture-id="${fixture.id}" oninput="bulkEditTrackChange('${fixture.id}', 'ourScore', this.value)"${fixture.matchStatus === 'cancelled' || fixture.matchStatus === 'postponed' ? ' disabled style="opacity: 0.4"' : ''}>
        </td>
        <td data-field="theirScore" data-fixture-id="${fixture.id}">
            <input type="number" min="0" value="${fixture.theirScore || ''}" placeholder="-" data-field="theirScore" data-fixture-id="${fixture.id}" oninput="bulkEditTrackChange('${fixture.id}', 'theirScore', this.value)"${fixture.matchStatus === 'cancelled' || fixture.matchStatus === 'postponed' ? ' disabled style="opacity: 0.4"' : ''}>
        </td>
        <td style="text-align: center; padding: 0.5rem;">
            ${isNew ? `<button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="bulkRemoveNewRow('${fixture.id}')">✕</button>` : ''}
        </td>
    `;
    
    // Set the team dropdown value
    const teamSelect = row.querySelector('select[data-field="team"]');
    if (teamSelect) teamSelect.value = fixture.team || '';
    
    return row;
}

/**
 * OLS 127: Add a new empty row for a new fixture
 */
function bulkAddNewRow() {
    const tbody = document.getElementById('bulkEditFixturesBody');
    const teams = adminSystem.getData('teams');
    
    // Generate a temporary ID for the new row
    bulkEditNewRowCounter++;
    const tempId = `new_${Date.now()}_${bulkEditNewRowCounter}`;
    
    // Get the current team filter
    const currentFilter = document.getElementById('bulk-edit-team-filter')?.value || 'all';
    
    // Create empty fixture object with defaults
    const newFixture = {
        id: tempId,
        team: currentFilter !== 'all' ? currentFilter : '',
        opponent: '',
        dateTime: new Date().toISOString(),
        venue: 'home',
        competition: '',
        ourScore: null,
        theirScore: null
    };
    
    // Track this as a new row
    bulkEditNewRows.push(tempId);
    
    // Create and prepend the row (new rows at top)
    const row = createBulkEditRow(newFixture, -1, window.bulkEditTeamOptionsHTML, true);
    
    if (tbody.firstChild) {
        tbody.insertBefore(row, tbody.firstChild);
    } else {
        tbody.appendChild(row);
    }
    
    // Focus on the opponent field of the new row
    const opponentInput = row.querySelector('input[data-field="opponent"]');
    if (opponentInput) {
        opponentInput.focus();
    }
    
    // Update fixture count
    updateBulkEditFixtureCount();
    updateBulkEditChangesCount();
}

/**
 * OLS 127: Remove a new row that hasn't been saved yet
 */
function bulkRemoveNewRow(tempId) {
    const row = document.querySelector(`tr[data-fixture-id="${tempId}"]`);
    if (row) {
        row.remove();
        bulkEditNewRows = bulkEditNewRows.filter(id => id !== tempId);
        bulkEditSelectedIds.delete(tempId);
        updateBulkEditFixtureCount();
        updateBulkEditChangesCount();
        updateBulkDeleteButton();
    }
}

// =====================================================
// SPREADSHEET FIXTURE UPLOAD
// =====================================================

/**
 * Entry point: open file picker for CSV/Excel upload
 */
function bulkUploadSpreadsheet() {
    if (typeof XLSX === 'undefined') {
        alert('Spreadsheet library failed to load. Please refresh the page and try again.');
        return;
    }

    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv,.xlsx,.xls';
    input.style.display = 'none';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            processFixtureSpreadsheet(file);
        }
        input.remove();
    };
    document.body.appendChild(input);
    input.click();
}

/**
 * Process the uploaded spreadsheet file
 */
async function processFixtureSpreadsheet(file) {
    try {
        const arrayBuffer = await readFileAsArrayBuffer(file);
        const workbook = XLSX.read(arrayBuffer, { type: 'array', cellDates: true });

        // Get first sheet
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rawData = XLSX.utils.sheet_to_json(sheet, { defval: '' });

        if (!rawData || rawData.length === 0) {
            alert('The spreadsheet appears to be empty or could not be parsed.');
            return;
        }

        // Get column headers from first row keys
        const headers = Object.keys(rawData[0]);
        const columnMap = mapSpreadsheetColumns(headers);

        // Get teams and existing fixtures for matching
        const teams = adminSystem.getData('teams') || [];
        const existingFixtures = [...(adminSystem.getData('fixtures') || [])];

        // Also include unsaved new rows from the bulk edit table (e.g. from a previous upload)
        // so a second upload doesn't create duplicates of the first
        document.querySelectorAll('#bulkEditFixturesTable tbody tr[data-is-new="true"]').forEach(row => {
            const opponentInput = row.querySelector('input[data-field="opponent"]');
            const dateInput = row.querySelector('input[data-field="date"]');
            const timeInput = row.querySelector('input[data-field="time"]');
            const teamSelect = row.querySelector('select[data-field="team"]');
            if (opponentInput && dateInput && opponentInput.value.trim()) {
                existingFixtures.push({
                    opponent: opponentInput.value.trim(),
                    dateTime: dateInput.value ? `${dateInput.value}T${timeInput?.value || '14:00'}:00` : '',
                    team: teamSelect?.value || ''
                });
            }
        });

        // Parse rows
        const parsedResults = parseSpreadsheetRows(rawData, columnMap, teams, existingFixtures);

        // Show summary
        showSpreadsheetImportSummary(parsedResults, file.name);

        // Inject new fixtures into the bulk edit table
        if (parsedResults.fixtures.length > 0) {
            injectSpreadsheetFixtures(parsedResults);
        }

    } catch (error) {
        console.error('Spreadsheet processing error:', error);
        alert('Failed to process spreadsheet: ' + error.message);
    }
}

/**
 * Promise wrapper for FileReader
 */
function readFileAsArrayBuffer(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = (e) => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
    });
}

/**
 * Fuzzy-map spreadsheet column headers to fixture fields
 */
function mapSpreadsheetColumns(headers) {
    const fieldAliases = {
        team: ['team', 'squad', 'side', 'team name', 'team_name'],
        opponent: ['opponent', 'opposition', 'vs', 'against', 'opp', 'opponents', 'away team', 'home team'],
        date: ['date', 'match date', 'fixture date', 'game date', 'match_date', 'fixture_date'],
        time: ['time', 'kick off', 'ko', 'kickoff', 'start time', 'kick_off', 'start_time', 'kick-off'],
        venue: ['venue', 'home/away', 'h/a', 'ground', 'location', 'home_away', 'home or away'],
        competition: ['competition', 'comp', 'league', 'cup', 'tournament', 'type'],
        ourScore: ['our score', 'score', 'for', 'pts for', 'home score', 'our_score', 'points for'],
        theirScore: ['their score', 'opp score', 'against score', 'pts against', 'away score', 'their_score', 'opposition score', 'points against'],
        matchStatus: ['status', 'match status', 'result', 'match_status', 'played']
    };

    const columnMap = {};
    const usedHeaders = new Set();
    const usedFields = new Set();

    // Pass 1: exact match (case-insensitive)
    headers.forEach(header => {
        const normalised = header.toLowerCase().trim();
        for (const [field, aliases] of Object.entries(fieldAliases)) {
            if (usedFields.has(field)) continue;
            if (aliases.includes(normalised)) {
                columnMap[field] = header;
                usedHeaders.add(header);
                usedFields.add(field);
                break;
            }
        }
    });

    // Pass 2: partial/contains match
    headers.forEach(header => {
        if (usedHeaders.has(header)) return;
        const normalised = header.toLowerCase().trim();
        for (const [field, aliases] of Object.entries(fieldAliases)) {
            if (usedFields.has(field)) continue;
            const matched = aliases.some(alias =>
                normalised.includes(alias) || alias.includes(normalised)
            );
            if (matched) {
                columnMap[field] = header;
                usedHeaders.add(header);
                usedFields.add(field);
                break;
            }
        }
    });

    console.log('📊 Column mapping:', columnMap);
    return columnMap;
}

/**
 * Parse spreadsheet rows into fixture objects
 */
function parseSpreadsheetRows(rawRows, columnMap, teams, existingFixtures) {
    const fixtures = [];
    const duplicates = [];
    const warnings = [];

    rawRows.forEach((row, index) => {
        const rowNum = index + 2; // +2 for header row + 1-based index

        // Skip completely empty rows
        const values = Object.values(row).filter(v => v !== '' && v !== null && v !== undefined);
        if (values.length === 0) return;

        const fixture = {};
        const rowWarnings = [];

        // Extract opponent (required)
        const rawOpponent = columnMap.opponent ? String(row[columnMap.opponent] || '').trim() : '';
        if (!rawOpponent) {
            // Skip rows with no opponent - likely empty/header rows
            if (values.length <= 1) return;
            rowWarnings.push('No opponent found');
        }
        fixture.opponent = rawOpponent;

        // Extract and resolve team
        const rawTeam = columnMap.team ? String(row[columnMap.team] || '').trim() : '';
        if (rawTeam) {
            const resolvedTeam = resolveTeamSlug(rawTeam, teams);
            if (resolvedTeam) {
                fixture.team = resolvedTeam;
            } else {
                fixture.team = '';
                rowWarnings.push(`Could not match team "${rawTeam}"`);
            }
        } else {
            fixture.team = '';
        }

        // Extract and parse date/time
        const rawDate = columnMap.date ? row[columnMap.date] : '';
        const rawTime = columnMap.time ? row[columnMap.time] : '';
        const parsedDateTime = parseFixtureDateTime(rawDate, rawTime);
        if (parsedDateTime) {
            fixture.dateTime = parsedDateTime;
        } else {
            fixture.dateTime = '';
            if (rawDate) {
                rowWarnings.push(`Could not parse date "${rawDate}"`);
            } else {
                rowWarnings.push('No date found');
            }
        }

        // Extract venue
        const rawVenue = columnMap.venue ? String(row[columnMap.venue] || '').trim() : '';
        fixture.venue = parseFixtureVenue(rawVenue);

        // Extract competition
        fixture.competition = columnMap.competition ? String(row[columnMap.competition] || '').trim() : '';

        // Extract scores (optional)
        if (columnMap.ourScore) {
            const val = row[columnMap.ourScore];
            fixture.ourScore = (val !== '' && val !== null && !isNaN(val)) ? parseInt(val) : null;
        } else {
            fixture.ourScore = null;
        }

        if (columnMap.theirScore) {
            const val = row[columnMap.theirScore];
            fixture.theirScore = (val !== '' && val !== null && !isNaN(val)) ? parseInt(val) : null;
        } else {
            fixture.theirScore = null;
        }

        // Extract match status
        if (columnMap.matchStatus) {
            fixture.matchStatus = parseMatchStatus(String(row[columnMap.matchStatus] || ''));
        } else {
            fixture.matchStatus = 'played';
        }

        // Check for duplicates against existing fixtures
        if (fixture.opponent && fixture.dateTime) {
            const isDuplicate = checkFixtureDuplicate(fixture, existingFixtures);
            if (isDuplicate) {
                duplicates.push({ row: rowNum, fixture, reason: isDuplicate });
                return;
            }
        }

        // Collect warnings for this row
        if (rowWarnings.length > 0) {
            warnings.push({ row: rowNum, messages: rowWarnings });
        }

        fixture._rowNum = rowNum;
        fixtures.push(fixture);
    });

    return { fixtures, duplicates, warnings };
}

/**
 * Resolve a team name string to a team slug
 */
function resolveTeamSlug(teamName, teams) {
    if (!teamName || !teams || teams.length === 0) return null;

    const normalised = teamName.toLowerCase().trim();

    // Exact slug match
    const slugMatch = teams.find(t => t.slug === normalised);
    if (slugMatch) return slugMatch.slug;

    // Exact name match (case-insensitive)
    const nameMatch = teams.find(t => t.name.toLowerCase() === normalised);
    if (nameMatch) return nameMatch.slug;

    // Partial match
    const partialMatch = teams.find(t =>
        t.name.toLowerCase().includes(normalised) || normalised.includes(t.name.toLowerCase())
    );
    if (partialMatch) return partialMatch.slug;

    // Common rugby abbreviations
    const rugbyAbbreviations = {
        '1st': '1st-xv', 'firsts': '1st-xv', '1st xv': '1st-xv', '1st-xv': '1st-xv', 'first xv': '1st-xv', 'first': '1st-xv',
        '2nd': '2nd-xv', 'seconds': '2nd-xv', '2nd xv': '2nd-xv', '2nd-xv': '2nd-xv', 'second xv': '2nd-xv', 'second': '2nd-xv',
        '3rd': '3rd-xv', 'thirds': '3rd-xv', '3rd xv': '3rd-xv', '3rd-xv': '3rd-xv', 'third xv': '3rd-xv', 'third': '3rd-xv',
        'colts': 'colts', 'ladies': 'ladies', 'women': 'ladies', 'womens': 'ladies', "women's": 'ladies',
        'vets': 'veterans', 'veterans': 'veterans'
    };

    const abbrevMatch = rugbyAbbreviations[normalised];
    if (abbrevMatch) {
        const teamBySlug = teams.find(t => t.slug === abbrevMatch);
        if (teamBySlug) return teamBySlug.slug;

        // Try partial slug match
        const teamByPartialSlug = teams.find(t => t.slug.includes(abbrevMatch) || abbrevMatch.includes(t.slug));
        if (teamByPartialSlug) return teamByPartialSlug.slug;
    }

    return null;
}

/**
 * Parse various date/time formats into an ISO string
 */
function parseFixtureDateTime(rawDate, rawTime) {
    if (!rawDate && !rawTime) return null;

    let dateObj = null;

    // Handle JS Date objects (from SheetJS cellDates: true)
    if (rawDate instanceof Date) {
        dateObj = rawDate;
    }
    // Handle Excel serial numbers (number type)
    else if (typeof rawDate === 'number') {
        // Excel serial date: days since 1900-01-01 (with a bug for 1900-02-29)
        const excelEpoch = new Date(1899, 11, 30);
        dateObj = new Date(excelEpoch.getTime() + rawDate * 86400000);
    }
    // Handle string dates
    else if (typeof rawDate === 'string' && rawDate.trim()) {
        const dateStr = rawDate.trim();

        // Try DD/MM/YYYY or DD-MM-YYYY
        const dmyMatch = dateStr.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})$/);
        if (dmyMatch) {
            let [, day, month, year] = dmyMatch;
            if (year.length === 2) year = '20' + year;
            dateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        }

        // Try YYYY-MM-DD
        if (!dateObj) {
            const isoMatch = dateStr.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
            if (isoMatch) {
                const [, year, month, day] = isoMatch;
                dateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            }
        }

        // Try natural language dates: "1st Jan 2025", "15 February 2025", "Jan 1 2025"
        if (!dateObj) {
            const months = {
                'jan': 0, 'january': 0, 'feb': 1, 'february': 1, 'mar': 2, 'march': 2,
                'apr': 3, 'april': 3, 'may': 4, 'jun': 5, 'june': 5,
                'jul': 6, 'july': 6, 'aug': 7, 'august': 7, 'sep': 8, 'september': 8,
                'oct': 9, 'october': 9, 'nov': 10, 'november': 10, 'dec': 11, 'december': 11
            };

            // "1st Jan 2025" or "15 February 2025"
            const naturalMatch1 = dateStr.match(/^(\d{1,2})(?:st|nd|rd|th)?\s+([a-zA-Z]+)\s+(\d{4})$/);
            if (naturalMatch1) {
                const [, day, monthStr, year] = naturalMatch1;
                const monthNum = months[monthStr.toLowerCase()];
                if (monthNum !== undefined) {
                    dateObj = new Date(parseInt(year), monthNum, parseInt(day));
                }
            }

            // "Jan 1 2025" or "February 15, 2025"
            if (!dateObj) {
                const naturalMatch2 = dateStr.match(/^([a-zA-Z]+)\s+(\d{1,2})(?:st|nd|rd|th)?,?\s+(\d{4})$/);
                if (naturalMatch2) {
                    const [, monthStr, day, year] = naturalMatch2;
                    const monthNum = months[monthStr.toLowerCase()];
                    if (monthNum !== undefined) {
                        dateObj = new Date(parseInt(year), monthNum, parseInt(day));
                    }
                }
            }
        }

        // Last resort: try native Date.parse
        if (!dateObj) {
            const parsed = Date.parse(dateStr);
            if (!isNaN(parsed)) {
                dateObj = new Date(parsed);
            }
        }
    }

    if (!dateObj || isNaN(dateObj.getTime())) return null;

    // Parse time
    let hours = 14, minutes = 0; // Default to 14:00 (2pm)
    if (rawTime) {
        let timeStr = '';
        if (rawTime instanceof Date) {
            hours = rawTime.getHours();
            minutes = rawTime.getMinutes();
        } else if (typeof rawTime === 'string') {
            timeStr = rawTime.trim();
        } else if (typeof rawTime === 'number') {
            // Excel time fraction (0.625 = 15:00)
            const totalMinutes = Math.round(rawTime * 24 * 60);
            hours = Math.floor(totalMinutes / 60);
            minutes = totalMinutes % 60;
        }

        if (timeStr) {
            // Try HH:MM or HH:MM:SS
            const timeMatch = timeStr.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
            if (timeMatch) {
                hours = parseInt(timeMatch[1]);
                minutes = parseInt(timeMatch[2]);
            }
            // Try "2pm", "2:30pm", "14:00"
            else {
                const ampmMatch = timeStr.match(/^(\d{1,2})(?::(\d{2}))?\s*(am|pm)$/i);
                if (ampmMatch) {
                    hours = parseInt(ampmMatch[1]);
                    minutes = ampmMatch[2] ? parseInt(ampmMatch[2]) : 0;
                    if (ampmMatch[3].toLowerCase() === 'pm' && hours !== 12) hours += 12;
                    if (ampmMatch[3].toLowerCase() === 'am' && hours === 12) hours = 0;
                }
            }
        }
    }

    dateObj.setHours(hours, minutes, 0, 0);
    return dateObj.toISOString();
}

/**
 * Parse venue string to "home" or "away"
 */
function parseFixtureVenue(rawVenue) {
    if (!rawVenue) return 'home';
    const normalised = rawVenue.toLowerCase().trim();

    if (['a', 'away'].includes(normalised)) return 'away';
    if (['h', 'home'].includes(normalised)) return 'home';
    if (normalised.includes('away')) return 'away';
    if (normalised.includes('home')) return 'home';

    return 'home'; // Default
}

/**
 * Parse match status string
 */
function parseMatchStatus(rawStatus) {
    if (!rawStatus) return 'played';
    const normalised = rawStatus.toLowerCase().trim();

    if (['cancelled', 'canceled', 'c', 'x', 'off'].includes(normalised)) return 'cancelled';
    if (['postponed', 'pp', 'p', 'delayed', 'rearranged'].includes(normalised)) return 'postponed';
    if (['played', 'complete', 'completed', 'done', 'yes', 'y'].includes(normalised)) return 'played';

    return 'played';
}

/**
 * Check if a fixture is a duplicate of an existing one
 * Returns a reason string if duplicate, null otherwise
 */
function checkFixtureDuplicate(fixture, existingFixtures) {
    if (!fixture.opponent || !fixture.dateTime) return null;

    const fixtureDate = new Date(fixture.dateTime);
    const fixtureDateStr = fixtureDate.toISOString().split('T')[0];
    const fixtureOpponent = fixture.opponent.toLowerCase().trim();

    for (const existing of existingFixtures) {
        if (!existing.dateTime || !existing.opponent) continue;

        const existingDate = new Date(existing.dateTime);
        const existingDateStr = existingDate.toISOString().split('T')[0];
        const existingOpponent = existing.opponent.toLowerCase().trim();

        // Same opponent + same date
        if (existingOpponent === fixtureOpponent && existingDateStr === fixtureDateStr) {
            // If team is specified, also check team matches (or be lenient if team is empty)
            if (!fixture.team || !existing.team || fixture.team === existing.team) {
                return `Matches existing fixture: ${existing.opponent} on ${existingDateStr}${existing.team ? ` (${existing.team})` : ''}`;
            }
        }
    }

    return null;
}

/**
 * Escape HTML entities to prevent XSS in summary display
 */
function escapeHTML(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

/**
 * Show the import summary banner
 */
function showSpreadsheetImportSummary(parsedResults, fileName) {
    const container = document.getElementById('spreadsheetImportSummary');
    if (!container) return;

    const { fixtures, duplicates, warnings } = parsedResults;

    let detailsHTML = '';

    if (duplicates.length > 0) {
        detailsHTML += `<details>
            <summary>Duplicates Skipped (${duplicates.length})</summary>
            <ul>
                ${duplicates.map(d => `<li>Row ${d.row}: ${escapeHTML(d.fixture.opponent || 'Unknown')} — ${escapeHTML(d.reason)}</li>`).join('')}
            </ul>
        </details>`;
    }

    if (warnings.length > 0) {
        detailsHTML += `<details>
            <summary>Warnings (${warnings.length} rows)</summary>
            <ul>
                ${warnings.map(w => `<li>Row ${w.row}: ${escapeHTML(w.messages.join(', '))}</li>`).join('')}
            </ul>
        </details>`;
    }

    container.innerHTML = `
        <div class="spreadsheet-import-summary">
            <div class="summary-header">
                <h4>📤 Spreadsheet Import — ${escapeHTML(fileName)}</h4>
                <button class="summary-dismiss" onclick="this.closest('.spreadsheet-import-summary').parentElement.style.display='none'" title="Dismiss">&times;</button>
            </div>
            <div class="summary-stats">
                <span class="stat-item stat-added"><strong>${fixtures.length}</strong> fixture${fixtures.length !== 1 ? 's' : ''} added for review</span>
                <span class="stat-item stat-skipped"><strong>${duplicates.length}</strong> duplicate${duplicates.length !== 1 ? 's' : ''} skipped</span>
                ${warnings.length > 0 ? `<span class="stat-item stat-warnings"><strong>${warnings.length}</strong> warning${warnings.length !== 1 ? 's' : ''}</span>` : ''}
            </div>
            ${detailsHTML}
        </div>
    `;

    container.style.display = 'block';
}

/**
 * Inject parsed fixtures into the bulk edit table as new rows
 */
function injectSpreadsheetFixtures(parsedResults) {
    const tbody = document.getElementById('bulkEditFixturesBody');
    if (!tbody) return;

    const { fixtures } = parsedResults;
    let injectedCount = 0;

    fixtures.forEach((fixture, index) => {
        // Generate temp ID
        bulkEditNewRowCounter++;
        const tempId = `new_${Date.now()}_${bulkEditNewRowCounter}`;

        const fixtureWithId = {
            ...fixture,
            id: tempId
        };

        // Track as new row
        bulkEditNewRows.push(tempId);

        // Create the row using existing function
        const row = createBulkEditRow(fixtureWithId, -1, window.bulkEditTeamOptionsHTML, true);

        // Add imported-row class for blue styling (in addition to new-row)
        row.classList.add('imported-row');

        // Prepend to table
        if (tbody.firstChild) {
            tbody.insertBefore(row, tbody.firstChild);
        } else {
            tbody.appendChild(row);
        }

        injectedCount++;
    });

    // Update counts
    updateBulkEditFixtureCount();
    updateBulkEditChangesCount();

    // Scroll to top of the table to show imported rows
    const tableContainer = document.querySelector('#bulkEditFixturesTable')?.closest('div[style*="overflow"]');
    if (tableContainer) {
        tableContainer.scrollTop = 0;
    }

    console.log(`📤 Injected ${injectedCount} fixtures from spreadsheet`);
}

// =====================================================
// GOOGLE CALENDAR DEDUPLICATION
// =====================================================

/**
 * Scan Google Calendar for duplicate events and show results modal
 */
async function deduplicateGoogleCalendar() {
    showLoading('Scanning Google Calendar for duplicates...');

    try {
        // Get current fixture IDs from the website
        const fixtures = adminSystem.getData('fixtures') || [];
        const fixtureIds = fixtures.map(f => f.id).filter(Boolean);

        // Call the scan endpoint
        const authHeaders = window.netlifyDataManager ? window.netlifyDataManager.getAuthHeaders() : {};

        const response = await fetch('/.netlify/functions/deduplicate-calendar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...authHeaders
            },
            body: JSON.stringify({
                action: 'scan',
                fixtureIds: fixtureIds
            })
        });

        const result = await response.json();
        hideLoading();

        if (!response.ok || !result.success) {
            throw new Error(result.error || result.message || 'Scan failed');
        }

        if (result.duplicateCount === 0) {
            showLoadingSuccess('No duplicates found! Calendar is clean.');
            return;
        }

        // Store duplicates for later deletion
        window._calendarDuplicates = result.duplicates;

        // Render results
        renderDedupResults(result);

        // Open modal
        openModal('calendarDedupModal');

    } catch (error) {
        hideLoading();
        console.error('Calendar dedup error:', error);
        alert('Failed to scan calendar: ' + error.message);
    }
}

/**
 * Render deduplication scan results into the modal
 */
function renderDedupResults(data) {
    // Summary
    const summaryEl = document.getElementById('dedupSummary');
    summaryEl.innerHTML = `
        <div class="dedup-summary">
            <div class="dedup-stat">
                <strong>${data.totalEvents}</strong>
                <span>Total Events</span>
            </div>
            <div class="dedup-stat">
                <strong>${data.uniqueGroups}</strong>
                <span>Unique Fixtures</span>
            </div>
            <div class="dedup-stat">
                <strong style="color: #dc3545;">${data.duplicateCount}</strong>
                <span>Duplicates Found</span>
            </div>
            <div class="dedup-stat">
                <strong style="color: #28a745;">${data.keepCount}</strong>
                <span>Will Keep</span>
            </div>
        </div>
    `;

    // Table body
    const tbody = document.getElementById('dedupResultsBody');
    tbody.innerHTML = '';

    data.duplicates.forEach((dup, i) => {
        const row = document.createElement('tr');

        const dateFormatted = dup.date || 'Unknown';
        const fixtureIdDisplay = dup.fixtureId
            ? `<span class="dedup-old-id" title="${dup.fixtureId}">${dup.fixtureId.substring(0, 12)}...</span>`
            : '<span class="dedup-orphan">No fixture link</span>';

        row.innerHTML = `
            <td style="text-align: center;">
                <input type="checkbox" class="dedup-checkbox" data-event-id="${escapeHTML(dup.googleEventId)}" checked onchange="updateDedupSelectedCount()">
            </td>
            <td>${escapeHTML(dup.summary)}</td>
            <td>${escapeHTML(dateFormatted)}</td>
            <td>${fixtureIdDisplay}</td>
        `;

        tbody.appendChild(row);
    });

    // Update selected count
    updateDedupSelectedCount();

    // Reset select all
    const selectAll = document.getElementById('dedupSelectAll');
    if (selectAll) selectAll.checked = true;
}

/**
 * Toggle all dedup checkboxes
 */
function toggleDedupSelectAll(checked) {
    document.querySelectorAll('.dedup-checkbox').forEach(cb => {
        cb.checked = checked;
    });
    updateDedupSelectedCount();
}

/**
 * Update the selected count display
 */
function updateDedupSelectedCount() {
    const checked = document.querySelectorAll('.dedup-checkbox:checked').length;
    const countEl = document.getElementById('dedupSelectedCount');
    if (countEl) countEl.textContent = checked;

    const btn = document.getElementById('dedupDeleteBtn');
    if (btn) btn.disabled = checked === 0;
}

/**
 * Delete selected duplicate calendar events
 */
async function confirmDeleteCalendarDuplicates() {
    const checkedBoxes = document.querySelectorAll('.dedup-checkbox:checked');
    const eventIds = [...checkedBoxes].map(cb => cb.getAttribute('data-event-id'));

    if (eventIds.length === 0) {
        alert('No duplicates selected.');
        return;
    }

    if (!confirm(`Are you sure you want to delete ${eventIds.length} duplicate calendar events? This cannot be undone.`)) {
        return;
    }

    closeModal('calendarDedupModal');
    showLoading(`Deleting ${eventIds.length} duplicate events...`);

    try {
        const authHeaders = window.netlifyDataManager ? window.netlifyDataManager.getAuthHeaders() : {};

        const response = await fetch('/.netlify/functions/deduplicate-calendar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...authHeaders
            },
            body: JSON.stringify({
                action: 'delete',
                eventIds: eventIds
            })
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
            throw new Error(result.error || result.message || 'Deletion failed');
        }

        const msg = result.failed && result.failed.length > 0
            ? `Deleted ${result.deleted} events. ${result.failed.length} failed.`
            : `Successfully deleted ${result.deleted} duplicate events!`;

        showLoadingSuccess(msg, 3000);

    } catch (error) {
        console.error('Calendar dedup delete error:', error);
        showLoadingError('Failed to delete duplicates: ' + error.message);
    }
}

/**
 * OLS 127: Toggle selection of a fixture row
 */
function bulkToggleSelection(fixtureId, isSelected) {
    if (isSelected) {
        bulkEditSelectedIds.add(fixtureId);
    } else {
        bulkEditSelectedIds.delete(fixtureId);
    }
    updateBulkDeleteButton();
    
    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.bulk-select-checkbox');
    const selectAllCheckbox = document.getElementById('bulkSelectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = bulkEditSelectedIds.size === allCheckboxes.length && allCheckboxes.length > 0;
    }
}

/**
 * OLS 127: Toggle all checkboxes
 */
function bulkToggleSelectAll(isSelected) {
    const checkboxes = document.querySelectorAll('.bulk-select-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = isSelected;
        const fixtureId = checkbox.getAttribute('data-fixture-id');
        if (isSelected) {
            bulkEditSelectedIds.add(fixtureId);
        } else {
            bulkEditSelectedIds.delete(fixtureId);
        }
    });
    updateBulkDeleteButton();
}

/**
 * OLS 127: Mark selected fixtures for deletion
 */
function bulkDeleteSelected() {
    if (bulkEditSelectedIds.size === 0) {
        alert('No fixtures selected');
        return;
    }
    
    // Check if any are new rows - these can just be removed
    const newRowsSelected = [...bulkEditSelectedIds].filter(id => id.startsWith('new_'));
    const existingRowsSelected = [...bulkEditSelectedIds].filter(id => !id.startsWith('new_'));
    
    let confirmMessage = '';
    if (newRowsSelected.length > 0 && existingRowsSelected.length > 0) {
        confirmMessage = `Remove ${newRowsSelected.length} new row(s) and mark ${existingRowsSelected.length} existing fixture(s) for deletion?`;
    } else if (newRowsSelected.length > 0) {
        confirmMessage = `Remove ${newRowsSelected.length} new row(s)?`;
    } else {
        confirmMessage = `Mark ${existingRowsSelected.length} fixture(s) for deletion? They will be deleted when you save.`;
    }
    
    if (!confirm(confirmMessage)) return;
    
    // Remove new rows immediately
    newRowsSelected.forEach(tempId => {
        bulkRemoveNewRow(tempId);
    });
    
    // Mark existing rows for deletion
    existingRowsSelected.forEach(fixtureId => {
        const row = document.querySelector(`tr[data-fixture-id="${fixtureId}"]`);
        if (row && !row.classList.contains('new-row')) {
            row.classList.add('marked-for-delete');
            bulkEditDeleteIds.add(fixtureId);
            
            // Uncheck the checkbox
            const checkbox = row.querySelector('.bulk-select-checkbox');
            if (checkbox) checkbox.checked = false;
        }
    });
    
    // Clear selection
    bulkEditSelectedIds.clear();
    updateBulkDeleteButton();
    updateBulkEditChangesCount();
    
    // Reset select all checkbox
    const selectAllCheckbox = document.getElementById('bulkSelectAll');
    if (selectAllCheckbox) selectAllCheckbox.checked = false;
}

/**
 * OLS 127: Update the delete button visibility and count
 */
function updateBulkDeleteButton() {
    const btn = document.getElementById('bulkDeleteSelectedBtn');
    const countSpan = document.getElementById('bulkSelectedCount');
    
    if (btn && countSpan) {
        const count = bulkEditSelectedIds.size;
        countSpan.textContent = count;
        btn.style.display = count > 0 ? 'inline-block' : 'none';
    }
}

/**
 * Update fixture count display
 */
function updateBulkEditFixtureCount() {
    const tbody = document.getElementById('bulkEditFixturesBody');
    const rows = tbody.querySelectorAll('tr:not(.marked-for-delete)');
    const countDisplay = document.getElementById('bulk-edit-fixture-count');
    if (countDisplay) {
        countDisplay.textContent = `${rows.length} fixture${rows.length !== 1 ? 's' : ''}`;
    }
}

/**
 * Reload the bulk edit table with a new filter
 */
function reloadBulkEditTable(teamFilter) {
    const modal = document.getElementById('bulkEditFixturesModal');
    modal.style.display = 'none';
    setTimeout(() => {
        openBulkEditFixtures(teamFilter);
    }, 100);
}

/**
 * Track changes to cells (updated for OLS 127 to use fixture ID)
 */
function bulkEditTrackChange(fixtureId, field, newValue) {
    const cellKey = `${fixtureId}-${field}`;
    
    // For new rows, just mark as having content
    if (fixtureId.startsWith('new_')) {
        updateBulkEditChangesCount();
        return;
    }
    
    const originalFixture = bulkEditOriginalData[fixtureId];
    if (!originalFixture) return;
    
    // Handle date/time fields specially
    if (field === 'date' || field === 'time') {
        const row = document.querySelector(`tr[data-fixture-id="${fixtureId}"]`);
        const dateInput = row.querySelector('[data-field="date"]');
        const timeInput = row.querySelector('[data-field="time"]');
        
        const newDateTime = `${dateInput.value}T${timeInput.value}:00`;
        const originalDateTime = originalFixture.dateTime;
        
        const originalDateObj = new Date(originalDateTime);
        const originalCompare = `${originalDateObj.toISOString().split('T')[0]}T${originalDateObj.toTimeString().slice(0, 5)}:00`;
        
        if (newDateTime !== originalCompare) {
            dateInput.parentElement.classList.add('changed');
            timeInput.parentElement.classList.add('changed');
            bulkEditChangedCells.add(`${fixtureId}-dateTime`);
        } else {
            dateInput.parentElement.classList.remove('changed');
            timeInput.parentElement.classList.remove('changed');
            bulkEditChangedCells.delete(`${fixtureId}-dateTime`);
        }
        
        updateBulkEditChangesCount();
        return;
    }
    
    // Standard field comparison
    let compareOriginal = originalFixture[field];
    let compareNew = newValue;
    
    if (compareOriginal === null || compareOriginal === undefined) compareOriginal = '';
    if (compareNew === null || compareNew === undefined) compareNew = '';
    
    compareOriginal = String(compareOriginal);
    compareNew = String(compareNew);
    
    const cell = document.querySelector(`[data-field="${field}"][data-fixture-id="${fixtureId}"]`)?.parentElement;
    
    if (compareNew !== compareOriginal) {
        if (cell) cell.classList.add('changed');
        bulkEditChangedCells.add(cellKey);
    } else {
        if (cell) cell.classList.remove('changed');
        bulkEditChangedCells.delete(cellKey);
    }
    
    updateBulkEditChangesCount();
}

/**
 * Update the changes count display (OLS 127 enhanced)
 */
function updateBulkEditChangesCount() {
    const countEl = document.getElementById('bulkEditChangesCount');
    
    const editCount = bulkEditChangedCells.size;
    const newCount = bulkEditNewRows.length;
    const deleteCount = bulkEditDeleteIds.size;
    
    const parts = [];
    if (newCount > 0) parts.push(`${newCount} new`);
    if (editCount > 0) parts.push(`${editCount} edit${editCount > 1 ? 's' : ''}`);
    if (deleteCount > 0) parts.push(`${deleteCount} to delete`);
    
    if (parts.length === 0) {
        countEl.textContent = 'No changes made';
        countEl.style.color = 'var(--text-light)';
    } else {
        countEl.textContent = parts.join(', ');
        countEl.style.color = 'var(--primary-green)';
        countEl.style.fontWeight = 'bold';
    }
}

/**
 * Save all bulk edit changes (OLS 127 - handles create, update, and delete)
 */
async function saveBulkEditFixtures() {
    const hasEdits = bulkEditChangedCells.size > 0;
    const hasNew = bulkEditNewRows.length > 0;
    const hasDeletes = bulkEditDeleteIds.size > 0;

    if (!hasEdits && !hasNew && !hasDeletes) {
        alert('No changes to save');
        return;
    }

    // Build confirmation message
    const parts = [];
    if (hasNew) parts.push(`create ${bulkEditNewRows.length} new fixture(s)`);
    if (hasEdits) parts.push(`update ${getChangedFixtureCount()} fixture(s)`);
    if (hasDeletes) parts.push(`delete ${bulkEditDeleteIds.size} fixture(s)`);

    if (!confirm(`Are you sure you want to ${parts.join(', ')}?`)) {
        return;
    }

    showLoading('Processing bulk changes...');

    try {
        // ==========================================
        // OLS SAFETY: Fetch fresh cloud data as the authoritative source
        // This ensures we never lose records that weren't loaded locally
        // ==========================================
        let cloudFixtures = null;
        try {
            const cloudResponse = await fetch('/.netlify/functions/fixtures', { method: 'GET' });
            if (cloudResponse.ok) {
                const cloudResult = await cloudResponse.json();
                cloudFixtures = cloudResult.data || [];
                console.log(`☁️ Fetched ${cloudFixtures.length} fixtures from cloud before save`);
            }
        } catch (cloudErr) {
            console.warn('⚠️ Could not fetch cloud data before save:', cloudErr.message);
        }

        // Use cloud data as the base if available, otherwise fall back to localStorage
        const fixtures = cloudFixtures || adminSystem.getData('fixtures');

        // OLS SAFETY: Validate we have at least as many fixtures as when we opened the editor
        // (minus any intentional deletions)
        const expectedMinCount = bulkEditSnapshotCount - bulkEditDeleteIds.size;
        if (fixtures.length < expectedMinCount) {
            const proceed = confirm(
                `⚠️ DATA SAFETY WARNING: Expected at least ${expectedMinCount} fixtures but only found ${fixtures.length}. ` +
                `This could mean some fixtures failed to load. Proceeding may cause data loss.\n\n` +
                `Do you want to ABORT to prevent data loss? (Recommended: Click OK to abort)`
            );
            if (proceed) {
                hideLoading();
                alert('Save aborted to protect your data. Please refresh the page and try again.');
                return;
            }
        }

        const tbody = document.getElementById('bulkEditFixturesBody');
        const rows = tbody.querySelectorAll('tr');

        // ==========================================
        // 1. HANDLE DELETIONS (cloud-first)
        // ==========================================
        if (hasDeletes) {
            const idsToDelete = [...bulkEditDeleteIds];
            console.log(`🗑️ Bulk deleting ${idsToDelete.length} fixtures...`);

            if (window.netlifyDataManager && typeof window.netlifyDataManager.deleteFixtures === 'function') {
                const deleteResult = await window.netlifyDataManager.deleteFixtures(idsToDelete);

                if (deleteResult.success) {
                    console.log('✅ Bulk delete successful:', deleteResult.data.results);
                    // Remove from local fixtures array
                    idsToDelete.forEach(id => {
                        const index = fixtures.findIndex(f => f.id === id);
                        if (index !== -1) fixtures.splice(index, 1);
                    });
                } else {
                    console.error('❌ Bulk delete failed:', deleteResult.error);
                    throw new Error(`Delete failed: ${deleteResult.error}`);
                }
            } else {
                // Fallback: delete locally only
                console.warn('⚠️ deleteFixtures not available, deleting locally only');
                idsToDelete.forEach(id => {
                    const index = fixtures.findIndex(f => f.id === id);
                    if (index !== -1) fixtures.splice(index, 1);
                });
            }
        }

        // ==========================================
        // 2. HANDLE NEW FIXTURES (cloud-first)
        // ==========================================
        if (hasNew) {
            const newFixtures = [];

            bulkEditNewRows.forEach(tempId => {
                const row = document.querySelector(`tr[data-fixture-id="${tempId}"]`);
                if (!row) return;

                const teamInput = row.querySelector('select[data-field="team"]');
                const opponentInput = row.querySelector('input[data-field="opponent"]');
                const dateInput = row.querySelector('input[data-field="date"]');
                const timeInput = row.querySelector('input[data-field="time"]');
                const venueInput = row.querySelector('select[data-field="venue"]');
                const competitionInput = row.querySelector('input[data-field="competition"]');
                const matchStatusInput = row.querySelector('select[data-field="matchStatus"]');
                const ourScoreInput = row.querySelector('input[data-field="ourScore"]');
                const theirScoreInput = row.querySelector('input[data-field="theirScore"]');

                // Validate required fields
                if (!teamInput.value || !opponentInput.value.trim() || !dateInput.value) {
                    console.warn(`⚠️ Skipping incomplete new fixture row: ${tempId}`);
                    return;
                }

                newFixtures.push({
                    team: teamInput.value,
                    opponent: opponentInput.value.trim(),
                    dateTime: `${dateInput.value}T${timeInput.value}:00`,
                    venue: venueInput.value,
                    competition: competitionInput.value.trim(),
                    matchStatus: matchStatusInput ? matchStatusInput.value : 'played',
                    ourScore: ourScoreInput.value ? parseInt(ourScoreInput.value) : null,
                    theirScore: theirScoreInput.value ? parseInt(theirScoreInput.value) : null
                });
            });

            if (newFixtures.length > 0) {
                console.log(`➕ Bulk creating ${newFixtures.length} fixtures...`);

                if (window.netlifyDataManager && typeof window.netlifyDataManager.createFixtures === 'function') {
                    const createResult = await window.netlifyDataManager.createFixtures(newFixtures);

                    if (createResult.success) {
                        console.log('✅ Bulk create successful:', createResult.data.results);
                        // Add to local fixtures array with IDs from server
                        createResult.data.details.createdFixtures.forEach((created, index) => {
                            fixtures.push({ ...newFixtures[index], id: created.id, createdAt: new Date().toISOString() });
                        });
                    } else {
                        console.error('❌ Bulk create failed:', createResult.error);
                        throw new Error(`Create failed: ${createResult.error}`);
                    }
                } else {
                    // Fallback: create locally only
                    console.warn('⚠️ createFixtures not available, creating locally only');
                    newFixtures.forEach(fixture => {
                        fixture.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                        fixture.createdAt = new Date().toISOString();
                        fixtures.push(fixture);
                    });
                }
            }
        }

        // ==========================================
        // 3. HANDLE UPDATES (cloud-first)
        // ==========================================
        if (hasEdits) {
            // Get unique fixture IDs that have changes
            const changedFixtureIds = new Set();
            bulkEditChangedCells.forEach(cellKey => {
                const fixtureId = cellKey.split('-')[0];
                if (!fixtureId.startsWith('new_')) {
                    changedFixtureIds.add(fixtureId);
                }
            });

            const fixturesToUpdate = [];

            changedFixtureIds.forEach(fixtureId => {
                const row = document.querySelector(`tr[data-fixture-id="${fixtureId}"]`);
                if (!row || row.classList.contains('marked-for-delete')) return;

                const fixture = fixtures.find(f => f.id === fixtureId);
                if (!fixture) return;

                const teamInput = row.querySelector('select[data-field="team"]');
                const opponentInput = row.querySelector('input[data-field="opponent"]');
                const dateInput = row.querySelector('input[data-field="date"]');
                const timeInput = row.querySelector('input[data-field="time"]');
                const venueInput = row.querySelector('select[data-field="venue"]');
                const competitionInput = row.querySelector('input[data-field="competition"]');
                const matchStatusInput = row.querySelector('select[data-field="matchStatus"]');
                const ourScoreInput = row.querySelector('input[data-field="ourScore"]');
                const theirScoreInput = row.querySelector('input[data-field="theirScore"]');

                // Update fixture data
                fixture.team = teamInput.value;
                fixture.opponent = opponentInput.value.trim();
                fixture.dateTime = `${dateInput.value}T${timeInput.value}:00`;
                fixture.venue = venueInput.value;
                fixture.competition = competitionInput.value.trim();
                fixture.matchStatus = matchStatusInput ? matchStatusInput.value : 'played';
                fixture.ourScore = ourScoreInput.value ? parseInt(ourScoreInput.value) : null;
                fixture.theirScore = theirScoreInput.value ? parseInt(theirScoreInput.value) : null;

                fixturesToUpdate.push(fixture);
            });

            if (fixturesToUpdate.length > 0) {
                console.log(`✏️ Bulk updating ${fixturesToUpdate.length} fixtures...`);

                if (window.netlifyDataManager && typeof window.netlifyDataManager.updateFixtures === 'function') {
                    const updateResult = await window.netlifyDataManager.updateFixtures(fixturesToUpdate);

                    if (updateResult.success) {
                        console.log('✅ Bulk update successful:', updateResult.data.results);
                    } else {
                        console.error('❌ Bulk update failed:', updateResult.error);
                        throw new Error(`Update failed: ${updateResult.error}`);
                    }
                } else {
                    console.warn('⚠️ updateFixtures not available, updating locally only');
                }
            }
        }

        // ==========================================
        // OLS SAFETY: Sync localStorage from cloud after all operations complete
        // This ensures localStorage reflects the true state of the cloud
        // ==========================================
        try {
            const freshResponse = await fetch('/.netlify/functions/fixtures', { method: 'GET' });
            if (freshResponse.ok) {
                const freshResult = await freshResponse.json();
                const freshFixtures = freshResult.data || [];
                localStorage.setItem('olrfc_fixtures', JSON.stringify(freshFixtures));
                console.log(`✅ Post-save sync: localStorage updated with ${freshFixtures.length} fixtures from cloud`);
            } else {
                // Cloud fetch failed after save - use our local copy as fallback
                console.warn('⚠️ Post-save cloud sync failed, saving local copy');
                adminSystem.saveData('fixtures', fixtures);
            }
        } catch (syncErr) {
            console.warn('⚠️ Post-save cloud sync error, saving local copy:', syncErr.message);
            adminSystem.saveData('fixtures', fixtures);
        }

        // Success!
        const successParts = [];
        if (hasNew) successParts.push(`${bulkEditNewRows.length} created`);
        if (hasEdits) successParts.push(`${getChangedFixtureCount()} updated`);
        if (hasDeletes) successParts.push(`${bulkEditDeleteIds.size} deleted`);

        showLoadingSuccess(successParts.join(', '));

        // Close modal and refresh
        closeModal('bulkEditFixturesModal');
        const currentFilter = document.getElementById('admin-team-filter')?.value || 'all';
        adminSystem.loadFixtures(currentFilter, currentFixtureTimeFilter);
        adminSystem.updateStats();

    } catch (error) {
        console.error('❌ Error saving bulk changes:', error);
        showLoadingError('Failed to save changes');
        alert('Error saving changes: ' + error.message);
    }
}

/**
 * Helper: Get count of fixtures with changes (not including new rows)
 */
function getChangedFixtureCount() {
    const changedFixtureIds = new Set();
    bulkEditChangedCells.forEach(cellKey => {
        const fixtureId = cellKey.split('-')[0];
        if (!fixtureId.startsWith('new_')) {
            changedFixtureIds.add(fixtureId);
        }
    });
    return changedFixtureIds.size;
}

// ============================================================================
// END BULK EDIT FIXTURES
// ============================================================================

// ============================================================================
// BULK EDIT SPONSORS - OLS 127
// ============================================================================

let bulkSponsorOriginalData = {};
let bulkSponsorChangedCells = new Set();
let bulkSponsorNewRows = [];
let bulkSponsorDeleteIds = new Set();
let bulkSponsorSelectedIds = new Set();
let bulkSponsorNewRowCounter = 0;

async function openBulkEditSponsors() {
    // OLS SAFETY: Sync fresh data from cloud before opening bulk edit
    showLoading('Loading sponsors from cloud...');
    try {
        const cloudResponse = await fetch('/.netlify/functions/sponsors', { method: 'GET' });
        if (cloudResponse.ok) {
            const cloudResult = await cloudResponse.json();
            const cloudSponsors = cloudResult.data || [];
            localStorage.setItem('olrfc_sponsors', JSON.stringify(cloudSponsors));
            console.log(`✅ Bulk edit sponsors: Synced ${cloudSponsors.length} from cloud`);
        }
    } catch (err) { console.warn('⚠️ Cloud sync failed before bulk edit sponsors:', err.message); }
    hideLoading();

    const sponsors = adminSystem.getData('sponsors') || [];

    bulkSponsorOriginalData = {};
    bulkSponsorChangedCells.clear();
    bulkSponsorNewRows = [];
    bulkSponsorDeleteIds.clear();
    bulkSponsorSelectedIds.clear();
    bulkSponsorNewRowCounter = 0;

    const selectAllCheckbox = document.getElementById('bulkSelectAllSponsors');
    if (selectAllCheckbox) selectAllCheckbox.checked = false;

    const tbody = document.getElementById('bulkEditSponsorsBody');
    tbody.innerHTML = '';

    sponsors.forEach(sponsor => {
        bulkSponsorOriginalData[sponsor.id] = JSON.parse(JSON.stringify(sponsor));
        const row = createBulkSponsorRow(sponsor, false);
        tbody.appendChild(row);
    });

    updateBulkSponsorChangesCount();
    updateBulkDeleteSponsorsButton();

    document.getElementById('bulkEditSponsorsModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function createBulkSponsorRow(sponsor, isNew = false) {
    const row = document.createElement('tr');
    row.setAttribute('data-sponsor-id', sponsor.id);
    if (isNew) {
        row.classList.add('new-row');
        row.setAttribute('data-is-new', 'true');
    }
    
    row.innerHTML = `
        <td class="checkbox-cell" style="text-align: center; padding: 0.5rem;">
            <input type="checkbox" class="bulk-select-sponsor-checkbox" data-sponsor-id="${sponsor.id}" onchange="bulkToggleSponsorSelection('${sponsor.id}', this.checked)">
        </td>
        <td><input type="text" value="${sponsor.name || ''}" data-field="name" data-sponsor-id="${sponsor.id}" oninput="bulkSponsorTrackChange('${sponsor.id}', 'name', this.value)" required></td>
        <td>
            <select data-field="tier" data-sponsor-id="${sponsor.id}" onchange="bulkSponsorTrackChange('${sponsor.id}', 'tier', this.value)">
                <option value="bronze" ${sponsor.tier === 'bronze' ? 'selected' : ''}>🥉 Bronze</option>
                <option value="silver" ${sponsor.tier === 'silver' ? 'selected' : ''}>🥈 Silver</option>
                <option value="gold" ${sponsor.tier === 'gold' ? 'selected' : ''}>🥇 Gold</option>
                <option value="platinum" ${sponsor.tier === 'platinum' ? 'selected' : ''}>💎 Platinum</option>
            </select>
        </td>
        <td><input type="tel" value="${sponsor.phone || ''}" data-field="phone" data-sponsor-id="${sponsor.id}" oninput="bulkSponsorTrackChange('${sponsor.id}', 'phone', this.value)"></td>
        <td><input type="email" value="${sponsor.email || ''}" data-field="email" data-sponsor-id="${sponsor.id}" oninput="bulkSponsorTrackChange('${sponsor.id}', 'email', this.value)"></td>
        <td><input type="url" value="${sponsor.website || ''}" data-field="website" data-sponsor-id="${sponsor.id}" oninput="bulkSponsorTrackChange('${sponsor.id}', 'website', this.value)" placeholder="https://..."></td>
        <td style="text-align: center;"><input type="checkbox" ${sponsor.active !== false ? 'checked' : ''} data-field="active" data-sponsor-id="${sponsor.id}" onchange="bulkSponsorTrackChange('${sponsor.id}', 'active', this.checked)"></td>
        <td style="text-align: center;"><input type="checkbox" ${sponsor.banner !== false ? 'checked' : ''} data-field="banner" data-sponsor-id="${sponsor.id}" onchange="bulkSponsorTrackChange('${sponsor.id}', 'banner', this.checked)"></td>
        <td style="text-align: center; padding: 0.5rem;">
            ${isNew ? `<button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="bulkRemoveNewSponsorRow('${sponsor.id}')">✕</button>` : ''}
        </td>
    `;
    return row;
}

function bulkAddNewSponsorRow() {
    const tbody = document.getElementById('bulkEditSponsorsBody');
    bulkSponsorNewRowCounter++;
    const tempId = `new_${Date.now()}_${bulkSponsorNewRowCounter}`;
    
    const newSponsor = { id: tempId, name: '', tier: 'bronze', phone: '', email: '', website: '', active: true, banner: true };
    bulkSponsorNewRows.push(tempId);
    
    const row = createBulkSponsorRow(newSponsor, true);
    if (tbody.firstChild) tbody.insertBefore(row, tbody.firstChild);
    else tbody.appendChild(row);
    
    row.querySelector('input[data-field="name"]').focus();
    updateBulkSponsorChangesCount();
}

function bulkRemoveNewSponsorRow(tempId) {
    const row = document.querySelector(`tr[data-sponsor-id="${tempId}"]`);
    if (row) {
        row.remove();
        bulkSponsorNewRows = bulkSponsorNewRows.filter(id => id !== tempId);
        bulkSponsorSelectedIds.delete(tempId);
        updateBulkSponsorChangesCount();
        updateBulkDeleteSponsorsButton();
    }
}

function bulkToggleSponsorSelection(sponsorId, isSelected) {
    if (isSelected) bulkSponsorSelectedIds.add(sponsorId);
    else bulkSponsorSelectedIds.delete(sponsorId);
    updateBulkDeleteSponsorsButton();
}

function bulkToggleSelectAllSponsors(isSelected) {
    document.querySelectorAll('.bulk-select-sponsor-checkbox').forEach(cb => {
        cb.checked = isSelected;
        const id = cb.getAttribute('data-sponsor-id');
        if (isSelected) bulkSponsorSelectedIds.add(id);
        else bulkSponsorSelectedIds.delete(id);
    });
    updateBulkDeleteSponsorsButton();
}

function bulkDeleteSelectedSponsors() {
    if (bulkSponsorSelectedIds.size === 0) return;
    
    const newRows = [...bulkSponsorSelectedIds].filter(id => id.startsWith('new_'));
    const existingRows = [...bulkSponsorSelectedIds].filter(id => !id.startsWith('new_'));
    
    if (!confirm(`Delete ${bulkSponsorSelectedIds.size} sponsor(s)?`)) return;
    
    newRows.forEach(id => bulkRemoveNewSponsorRow(id));
    existingRows.forEach(id => {
        const row = document.querySelector(`tr[data-sponsor-id="${id}"]`);
        if (row) {
            row.classList.add('marked-for-delete');
            bulkSponsorDeleteIds.add(id);
            const cb = row.querySelector('.bulk-select-sponsor-checkbox');
            if (cb) cb.checked = false;
        }
    });
    
    bulkSponsorSelectedIds.clear();
    updateBulkDeleteSponsorsButton();
    updateBulkSponsorChangesCount();
    document.getElementById('bulkSelectAllSponsors').checked = false;
}

function updateBulkDeleteSponsorsButton() {
    const btn = document.getElementById('bulkDeleteSelectedSponsorsBtn');
    const countSpan = document.getElementById('bulkSelectedSponsorsCount');
    if (btn && countSpan) {
        countSpan.textContent = bulkSponsorSelectedIds.size;
        btn.style.display = bulkSponsorSelectedIds.size > 0 ? 'inline-block' : 'none';
    }
}

function bulkSponsorTrackChange(sponsorId, field, newValue) {
    if (sponsorId.startsWith('new_')) { updateBulkSponsorChangesCount(); return; }
    
    const original = bulkSponsorOriginalData[sponsorId];
    if (!original) return;
    
    const cellKey = `${sponsorId}-${field}`;
    let origVal = original[field];
    if (origVal === null || origVal === undefined) origVal = field === 'active' || field === 'banner' ? true : '';
    
    const changed = String(newValue) !== String(origVal);
    const cell = document.querySelector(`[data-field="${field}"][data-sponsor-id="${sponsorId}"]`)?.parentElement;
    
    if (changed) { if (cell) cell.classList.add('changed'); bulkSponsorChangedCells.add(cellKey); }
    else { if (cell) cell.classList.remove('changed'); bulkSponsorChangedCells.delete(cellKey); }
    
    updateBulkSponsorChangesCount();
}

function updateBulkSponsorChangesCount() {
    const countEl = document.getElementById('bulkEditSponsorsChangesCount');
    const parts = [];
    if (bulkSponsorNewRows.length > 0) parts.push(`${bulkSponsorNewRows.length} new`);
    if (bulkSponsorChangedCells.size > 0) parts.push(`${bulkSponsorChangedCells.size} edits`);
    if (bulkSponsorDeleteIds.size > 0) parts.push(`${bulkSponsorDeleteIds.size} to delete`);
    countEl.textContent = parts.length === 0 ? 'No changes made' : parts.join(', ');
    countEl.style.color = parts.length === 0 ? 'var(--text-light)' : 'var(--primary-green)';
}

async function saveBulkEditSponsors() {
    const hasNew = bulkSponsorNewRows.length > 0;
    const hasEdits = bulkSponsorChangedCells.size > 0;
    const hasDeletes = bulkSponsorDeleteIds.size > 0;

    if (!hasNew && !hasEdits && !hasDeletes) { alert('No changes to save'); return; }
    if (!confirm('Save all changes?')) return;

    showLoading('Processing sponsor changes...');

    try {
        // OLS SAFETY: Fetch fresh cloud data as authoritative base
        let sponsors = null;
        try {
            const cloudResponse = await fetch('/.netlify/functions/sponsors', { method: 'GET' });
            if (cloudResponse.ok) {
                const cloudResult = await cloudResponse.json();
                sponsors = cloudResult.data || [];
                console.log(`☁️ Fetched ${sponsors.length} sponsors from cloud before save`);
            }
        } catch (err) { console.warn('⚠️ Cloud fetch failed, using localStorage:', err.message); }
        if (!sponsors) sponsors = adminSystem.getData('sponsors') || [];

        // Delete
        if (hasDeletes && window.netlifyDataManager?.deleteSponsors) {
            const result = await window.netlifyDataManager.deleteSponsors([...bulkSponsorDeleteIds]);
            if (result.success) sponsors = sponsors.filter(s => !bulkSponsorDeleteIds.has(s.id));
        }

        // Create new
        if (hasNew) {
            const newSponsors = [];
            bulkSponsorNewRows.forEach(tempId => {
                const row = document.querySelector(`tr[data-sponsor-id="${tempId}"]`);
                if (!row) return;
                const name = row.querySelector('[data-field="name"]').value.trim();
                if (!name) return;
                newSponsors.push({
                    name,
                    tier: row.querySelector('[data-field="tier"]').value,
                    phone: row.querySelector('[data-field="phone"]').value.trim(),
                    email: row.querySelector('[data-field="email"]').value.trim(),
                    website: row.querySelector('[data-field="website"]').value.trim(),
                    active: row.querySelector('[data-field="active"]').checked,
                    banner: row.querySelector('[data-field="banner"]').checked
                });
            });
            if (newSponsors.length > 0 && window.netlifyDataManager?.createSponsors) {
                const result = await window.netlifyDataManager.createSponsors(newSponsors);
                if (result.success) {
                    result.data.details.createdSponsors.forEach((c, i) => sponsors.push({ ...newSponsors[i], id: c.id }));
                }
            }
        }

        // Update
        if (hasEdits) {
            const changedIds = new Set();
            bulkSponsorChangedCells.forEach(k => changedIds.add(k.split('-')[0]));
            const toUpdate = [];
            changedIds.forEach(id => {
                const row = document.querySelector(`tr[data-sponsor-id="${id}"]`);
                if (!row || row.classList.contains('marked-for-delete')) return;
                const sponsor = sponsors.find(s => s.id === id);
                if (!sponsor) return;
                sponsor.name = row.querySelector('[data-field="name"]').value.trim();
                sponsor.tier = row.querySelector('[data-field="tier"]').value;
                sponsor.phone = row.querySelector('[data-field="phone"]').value.trim();
                sponsor.email = row.querySelector('[data-field="email"]').value.trim();
                sponsor.website = row.querySelector('[data-field="website"]').value.trim();
                sponsor.active = row.querySelector('[data-field="active"]').checked;
                sponsor.banner = row.querySelector('[data-field="banner"]').checked;
                toUpdate.push(sponsor);
            });
            if (toUpdate.length > 0 && window.netlifyDataManager?.updateSponsors) {
                await window.netlifyDataManager.updateSponsors(toUpdate);
            }
        }

        // OLS SAFETY: Re-sync localStorage from cloud after all operations
        try {
            const freshResponse = await fetch('/.netlify/functions/sponsors', { method: 'GET' });
            if (freshResponse.ok) {
                const freshResult = await freshResponse.json();
                localStorage.setItem('olrfc_sponsors', JSON.stringify(freshResult.data || []));
            } else { adminSystem.saveData('sponsors', sponsors); }
        } catch (e) { adminSystem.saveData('sponsors', sponsors); }

        showLoadingSuccess('Sponsors updated!');
        closeModal('bulkEditSponsorsModal');
        adminSystem.loadSponsors();
        adminSystem.updateStats();
    } catch (error) {
        showLoadingError('Failed to save');
        alert('Error: ' + error.message);
    }
}

// ============================================================================
// BULK EDIT CONTACTS - OLS 127
// ============================================================================

let bulkContactOriginalData = {};
let bulkContactChangedCells = new Set();
let bulkContactNewRows = [];
let bulkContactDeleteIds = new Set();
let bulkContactSelectedIds = new Set();
let bulkContactNewRowCounter = 0;

const contactCategories = ['Club Leadership', 'Coaching Staff', 'Senior Section', 'Minis & Juniors Section', 'Safeguarding & Welfare', 'Operations & Facilities', 'Communications & Media'];

async function openBulkEditContacts() {
    // OLS SAFETY: Sync fresh data from cloud before opening bulk edit
    showLoading('Loading contacts from cloud...');
    try {
        const cloudResponse = await fetch('/.netlify/functions/contacts', { method: 'GET' });
        if (cloudResponse.ok) {
            const cloudResult = await cloudResponse.json();
            const cloudContacts = cloudResult.data || [];
            localStorage.setItem('olrfc_contacts', JSON.stringify(cloudContacts));
            console.log(`✅ Bulk edit contacts: Synced ${cloudContacts.length} from cloud`);
        }
    } catch (err) { console.warn('⚠️ Cloud sync failed before bulk edit contacts:', err.message); }
    hideLoading();

    const contacts = adminSystem.getData('contacts') || [];

    bulkContactOriginalData = {};
    bulkContactChangedCells.clear();
    bulkContactNewRows = [];
    bulkContactDeleteIds.clear();
    bulkContactSelectedIds.clear();
    bulkContactNewRowCounter = 0;

    document.getElementById('bulkSelectAllContacts').checked = false;

    const tbody = document.getElementById('bulkEditContactsBody');
    tbody.innerHTML = '';

    contacts.sort((a, b) => (a.displayOrder || 999) - (b.displayOrder || 999)).forEach(contact => {
        bulkContactOriginalData[contact.id] = JSON.parse(JSON.stringify(contact));
        tbody.appendChild(createBulkContactRow(contact, false));
    });

    updateBulkContactChangesCount();
    updateBulkDeleteContactsButton();

    document.getElementById('bulkEditContactsModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function createBulkContactRow(contact, isNew = false) {
    const row = document.createElement('tr');
    row.setAttribute('data-contact-id', contact.id);
    if (isNew) { row.classList.add('new-row'); row.setAttribute('data-is-new', 'true'); }
    
    let categoryOptions = contactCategories.map(c => `<option value="${c}" ${contact.category === c ? 'selected' : ''}>${c}</option>`).join('');
    
    row.innerHTML = `
        <td class="checkbox-cell" style="text-align: center; padding: 0.5rem;">
            <input type="checkbox" class="bulk-select-contact-checkbox" data-contact-id="${contact.id}" onchange="bulkToggleContactSelection('${contact.id}', this.checked)">
        </td>
        <td><input type="text" value="${contact.name || ''}" data-field="name" data-contact-id="${contact.id}" oninput="bulkContactTrackChange('${contact.id}', 'name', this.value)" required></td>
        <td><input type="text" value="${contact.role || ''}" data-field="role" data-contact-id="${contact.id}" oninput="bulkContactTrackChange('${contact.id}', 'role', this.value)" required></td>
        <td><select data-field="category" data-contact-id="${contact.id}" onchange="bulkContactTrackChange('${contact.id}', 'category', this.value)">${categoryOptions}</select></td>
        <td><input type="email" value="${contact.email || ''}" data-field="email" data-contact-id="${contact.id}" oninput="bulkContactTrackChange('${contact.id}', 'email', this.value)"></td>
        <td><input type="tel" value="${contact.phone || ''}" data-field="phone" data-contact-id="${contact.id}" oninput="bulkContactTrackChange('${contact.id}', 'phone', this.value)"></td>
        <td style="width: 70px;"><input type="number" value="${contact.displayOrder || 999}" data-field="displayOrder" data-contact-id="${contact.id}" oninput="bulkContactTrackChange('${contact.id}', 'displayOrder', this.value)" min="1" style="width: 60px;"></td>
        <td style="text-align: center; padding: 0.5rem;">
            ${isNew ? `<button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="bulkRemoveNewContactRow('${contact.id}')">✕</button>` : ''}
        </td>
    `;
    return row;
}

function bulkAddNewContactRow() {
    const tbody = document.getElementById('bulkEditContactsBody');
    bulkContactNewRowCounter++;
    const tempId = `new_${Date.now()}_${bulkContactNewRowCounter}`;
    
    const newContact = { id: tempId, name: '', role: '', category: 'Club Leadership', email: '', phone: '', displayOrder: 999 };
    bulkContactNewRows.push(tempId);
    
    const row = createBulkContactRow(newContact, true);
    if (tbody.firstChild) tbody.insertBefore(row, tbody.firstChild);
    else tbody.appendChild(row);
    
    row.querySelector('input[data-field="name"]').focus();
    updateBulkContactChangesCount();
}

function bulkRemoveNewContactRow(tempId) {
    const row = document.querySelector(`tr[data-contact-id="${tempId}"]`);
    if (row) { row.remove(); bulkContactNewRows = bulkContactNewRows.filter(id => id !== tempId); bulkContactSelectedIds.delete(tempId); updateBulkContactChangesCount(); updateBulkDeleteContactsButton(); }
}

function bulkToggleContactSelection(contactId, isSelected) {
    if (isSelected) bulkContactSelectedIds.add(contactId); else bulkContactSelectedIds.delete(contactId);
    updateBulkDeleteContactsButton();
}

function bulkToggleSelectAllContacts(isSelected) {
    document.querySelectorAll('.bulk-select-contact-checkbox').forEach(cb => {
        cb.checked = isSelected;
        const id = cb.getAttribute('data-contact-id');
        if (isSelected) bulkContactSelectedIds.add(id); else bulkContactSelectedIds.delete(id);
    });
    updateBulkDeleteContactsButton();
}

function bulkDeleteSelectedContacts() {
    if (bulkContactSelectedIds.size === 0) return;
    if (!confirm(`Delete ${bulkContactSelectedIds.size} contact(s)?`)) return;
    
    [...bulkContactSelectedIds].filter(id => id.startsWith('new_')).forEach(id => bulkRemoveNewContactRow(id));
    [...bulkContactSelectedIds].filter(id => !id.startsWith('new_')).forEach(id => {
        const row = document.querySelector(`tr[data-contact-id="${id}"]`);
        if (row) { row.classList.add('marked-for-delete'); bulkContactDeleteIds.add(id); row.querySelector('.bulk-select-contact-checkbox').checked = false; }
    });
    
    bulkContactSelectedIds.clear();
    updateBulkDeleteContactsButton();
    updateBulkContactChangesCount();
    document.getElementById('bulkSelectAllContacts').checked = false;
}

function updateBulkDeleteContactsButton() {
    const btn = document.getElementById('bulkDeleteSelectedContactsBtn');
    const countSpan = document.getElementById('bulkSelectedContactsCount');
    if (btn && countSpan) { countSpan.textContent = bulkContactSelectedIds.size; btn.style.display = bulkContactSelectedIds.size > 0 ? 'inline-block' : 'none'; }
}

function bulkContactTrackChange(contactId, field, newValue) {
    if (contactId.startsWith('new_')) { updateBulkContactChangesCount(); return; }
    const original = bulkContactOriginalData[contactId];
    if (!original) return;
    let origVal = original[field]; if (origVal === null || origVal === undefined) origVal = field === 'displayOrder' ? 999 : '';
    const changed = String(newValue) !== String(origVal);
    const cell = document.querySelector(`[data-field="${field}"][data-contact-id="${contactId}"]`)?.parentElement;
    if (changed) { if (cell) cell.classList.add('changed'); bulkContactChangedCells.add(`${contactId}-${field}`); }
    else { if (cell) cell.classList.remove('changed'); bulkContactChangedCells.delete(`${contactId}-${field}`); }
    updateBulkContactChangesCount();
}

function updateBulkContactChangesCount() {
    const countEl = document.getElementById('bulkEditContactsChangesCount');
    const parts = [];
    if (bulkContactNewRows.length > 0) parts.push(`${bulkContactNewRows.length} new`);
    if (bulkContactChangedCells.size > 0) parts.push(`${bulkContactChangedCells.size} edits`);
    if (bulkContactDeleteIds.size > 0) parts.push(`${bulkContactDeleteIds.size} to delete`);
    countEl.textContent = parts.length === 0 ? 'No changes made' : parts.join(', ');
    countEl.style.color = parts.length === 0 ? 'var(--text-light)' : 'var(--primary-green)';
}

async function saveBulkEditContacts() {
    const hasNew = bulkContactNewRows.length > 0, hasEdits = bulkContactChangedCells.size > 0, hasDeletes = bulkContactDeleteIds.size > 0;
    if (!hasNew && !hasEdits && !hasDeletes) { alert('No changes to save'); return; }
    if (!confirm('Save all changes?')) return;
    showLoading('Processing contact changes...');

    try {
        // OLS SAFETY: Fetch fresh cloud data as authoritative base
        let contacts = null;
        try {
            const cloudResponse = await fetch('/.netlify/functions/contacts', { method: 'GET' });
            if (cloudResponse.ok) {
                const cloudResult = await cloudResponse.json();
                contacts = cloudResult.data || [];
                console.log(`☁️ Fetched ${contacts.length} contacts from cloud before save`);
            }
        } catch (err) { console.warn('⚠️ Cloud fetch failed, using localStorage:', err.message); }
        if (!contacts) contacts = adminSystem.getData('contacts') || [];

        if (hasDeletes && window.netlifyDataManager?.deleteContacts) {
            const result = await window.netlifyDataManager.deleteContacts([...bulkContactDeleteIds]);
            if (result.success) contacts = contacts.filter(c => !bulkContactDeleteIds.has(c.id));
        }

        if (hasNew) {
            const newContacts = [];
            bulkContactNewRows.forEach(tempId => {
                const row = document.querySelector(`tr[data-contact-id="${tempId}"]`);
                if (!row) return;
                const name = row.querySelector('[data-field="name"]').value.trim();
                const role = row.querySelector('[data-field="role"]').value.trim();
                const category = row.querySelector('[data-field="category"]').value;
                if (!name || !role || !category) return;
                newContacts.push({ name, role, category, email: row.querySelector('[data-field="email"]').value.trim(), phone: row.querySelector('[data-field="phone"]').value.trim(), displayOrder: parseInt(row.querySelector('[data-field="displayOrder"]').value) || 999 });
            });
            if (newContacts.length > 0 && window.netlifyDataManager?.createContacts) {
                const result = await window.netlifyDataManager.createContacts(newContacts);
                if (result.success) result.data.details.createdContacts.forEach((c, i) => contacts.push({ ...newContacts[i], id: c.id }));
            }
        }

        if (hasEdits) {
            const changedIds = new Set(); bulkContactChangedCells.forEach(k => changedIds.add(k.split('-')[0]));
            const toUpdate = [];
            changedIds.forEach(id => {
                const row = document.querySelector(`tr[data-contact-id="${id}"]`);
                if (!row || row.classList.contains('marked-for-delete')) return;
                const contact = contacts.find(c => c.id === id);
                if (!contact) return;
                contact.name = row.querySelector('[data-field="name"]').value.trim();
                contact.role = row.querySelector('[data-field="role"]').value.trim();
                contact.category = row.querySelector('[data-field="category"]').value;
                contact.email = row.querySelector('[data-field="email"]').value.trim();
                contact.phone = row.querySelector('[data-field="phone"]').value.trim();
                contact.displayOrder = parseInt(row.querySelector('[data-field="displayOrder"]').value) || 999;
                toUpdate.push(contact);
            });
            if (toUpdate.length > 0 && window.netlifyDataManager?.updateContacts) await window.netlifyDataManager.updateContacts(toUpdate);
        }

        // OLS SAFETY: Re-sync localStorage from cloud after all operations
        try {
            const freshResponse = await fetch('/.netlify/functions/contacts', { method: 'GET' });
            if (freshResponse.ok) {
                const freshResult = await freshResponse.json();
                localStorage.setItem('olrfc_contacts', JSON.stringify(freshResult.data || []));
            } else { adminSystem.saveData('contacts', contacts); }
        } catch (e) { adminSystem.saveData('contacts', contacts); }

        showLoadingSuccess('Contacts updated!');
        closeModal('bulkEditContactsModal');
        if (typeof loadContacts === 'function') loadContacts();
    } catch (error) { showLoadingError('Failed to save'); alert('Error: ' + error.message); }
}

// ============================================================================
// BULK EDIT VPs - OLS 127
// ============================================================================

let bulkVPOriginalData = {};
let bulkVPChangedCells = new Set();
let bulkVPNewRows = [];
let bulkVPDeleteIds = new Set();
let bulkVPSelectedIds = new Set();
let bulkVPNewRowCounter = 0;

async function openBulkEditVPs() {
    // OLS SAFETY: Sync fresh data from cloud before opening bulk edit
    showLoading('Loading VPs from cloud...');
    try {
        const cloudResponse = await fetch('/.netlify/functions/vp-wall', { method: 'GET' });
        if (cloudResponse.ok) {
            const cloudResult = await cloudResponse.json();
            const cloudVPs = cloudResult.data || [];
            localStorage.setItem('olrfc_vps', JSON.stringify(cloudVPs));
            console.log(`✅ Bulk edit VPs: Synced ${cloudVPs.length} from cloud`);
        }
    } catch (err) { console.warn('⚠️ Cloud sync failed before bulk edit VPs:', err.message); }
    hideLoading();

    const vps = JSON.parse(localStorage.getItem('olrfc_vps') || '[]');

    bulkVPOriginalData = {};
    bulkVPChangedCells.clear();
    bulkVPNewRows = [];
    bulkVPDeleteIds.clear();
    bulkVPSelectedIds.clear();
    bulkVPNewRowCounter = 0;

    document.getElementById('bulkSelectAllVPs').checked = false;

    const tbody = document.getElementById('bulkEditVPsBody');
    tbody.innerHTML = '';

    vps.forEach(vp => {
        bulkVPOriginalData[vp.id] = JSON.parse(JSON.stringify(vp));
        tbody.appendChild(createBulkVPRow(vp, false));
    });

    updateBulkVPChangesCount();
    updateBulkDeleteVPsButton();

    document.getElementById('bulkEditVPsModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function createBulkVPRow(vp, isNew = false) {
    const row = document.createElement('tr');
    row.setAttribute('data-vp-id', vp.id);
    if (isNew) { row.classList.add('new-row'); row.setAttribute('data-is-new', 'true'); }
    
    row.innerHTML = `
        <td class="checkbox-cell" style="text-align: center; padding: 0.5rem;">
            <input type="checkbox" class="bulk-select-vp-checkbox" data-vp-id="${vp.id}" onchange="bulkToggleVPSelection('${vp.id}', this.checked)">
        </td>
        <td><input type="text" value="${vp.name || ''}" data-field="name" data-vp-id="${vp.id}" oninput="bulkVPTrackChange('${vp.id}', 'name', this.value)" required></td>
        <td>
            <select data-field="type" data-vp-id="${vp.id}" onchange="bulkVPTrackChange('${vp.id}', 'type', this.value)">
                <option value="annual" ${vp.type === 'annual' ? 'selected' : ''}>Annual VP</option>
                <option value="lifetime" ${vp.type === 'lifetime' ? 'selected' : ''}>Lifetime VP</option>
            </select>
        </td>
        <td><input type="text" value="${vp.notes || ''}" data-field="notes" data-vp-id="${vp.id}" oninput="bulkVPTrackChange('${vp.id}', 'notes', this.value)" placeholder="Optional notes..."></td>
        <td style="text-align: center; padding: 0.5rem;">
            ${isNew ? `<button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="bulkRemoveNewVPRow('${vp.id}')">✕</button>` : ''}
        </td>
    `;
    return row;
}

function bulkAddNewVPRow() {
    const tbody = document.getElementById('bulkEditVPsBody');
    bulkVPNewRowCounter++;
    const tempId = `new_${Date.now()}_${bulkVPNewRowCounter}`;
    
    const newVP = { id: tempId, name: '', type: 'annual', notes: '' };
    bulkVPNewRows.push(tempId);
    
    const row = createBulkVPRow(newVP, true);
    if (tbody.firstChild) tbody.insertBefore(row, tbody.firstChild);
    else tbody.appendChild(row);
    
    row.querySelector('input[data-field="name"]').focus();
    updateBulkVPChangesCount();
}

function bulkRemoveNewVPRow(tempId) {
    const row = document.querySelector(`tr[data-vp-id="${tempId}"]`);
    if (row) { row.remove(); bulkVPNewRows = bulkVPNewRows.filter(id => id !== tempId); bulkVPSelectedIds.delete(tempId); updateBulkVPChangesCount(); updateBulkDeleteVPsButton(); }
}

function bulkToggleVPSelection(vpId, isSelected) {
    if (isSelected) bulkVPSelectedIds.add(vpId); else bulkVPSelectedIds.delete(vpId);
    updateBulkDeleteVPsButton();
}

function bulkToggleSelectAllVPs(isSelected) {
    document.querySelectorAll('.bulk-select-vp-checkbox').forEach(cb => {
        cb.checked = isSelected;
        const id = cb.getAttribute('data-vp-id');
        if (isSelected) bulkVPSelectedIds.add(id); else bulkVPSelectedIds.delete(id);
    });
    updateBulkDeleteVPsButton();
}

function bulkDeleteSelectedVPs() {
    if (bulkVPSelectedIds.size === 0) return;
    if (!confirm(`Delete ${bulkVPSelectedIds.size} VP(s)?`)) return;
    
    [...bulkVPSelectedIds].filter(id => id.startsWith('new_')).forEach(id => bulkRemoveNewVPRow(id));
    [...bulkVPSelectedIds].filter(id => !id.startsWith('new_')).forEach(id => {
        const row = document.querySelector(`tr[data-vp-id="${id}"]`);
        if (row) { row.classList.add('marked-for-delete'); bulkVPDeleteIds.add(id); row.querySelector('.bulk-select-vp-checkbox').checked = false; }
    });
    
    bulkVPSelectedIds.clear();
    updateBulkDeleteVPsButton();
    updateBulkVPChangesCount();
    document.getElementById('bulkSelectAllVPs').checked = false;
}

function updateBulkDeleteVPsButton() {
    const btn = document.getElementById('bulkDeleteSelectedVPsBtn');
    const countSpan = document.getElementById('bulkSelectedVPsCount');
    if (btn && countSpan) { countSpan.textContent = bulkVPSelectedIds.size; btn.style.display = bulkVPSelectedIds.size > 0 ? 'inline-block' : 'none'; }
}

function bulkVPTrackChange(vpId, field, newValue) {
    if (vpId.startsWith('new_')) { updateBulkVPChangesCount(); return; }
    const original = bulkVPOriginalData[vpId];
    if (!original) return;
    let origVal = original[field] || '';
    const changed = String(newValue) !== String(origVal);
    const cell = document.querySelector(`[data-field="${field}"][data-vp-id="${vpId}"]`)?.parentElement;
    if (changed) { if (cell) cell.classList.add('changed'); bulkVPChangedCells.add(`${vpId}-${field}`); }
    else { if (cell) cell.classList.remove('changed'); bulkVPChangedCells.delete(`${vpId}-${field}`); }
    updateBulkVPChangesCount();
}

function updateBulkVPChangesCount() {
    const countEl = document.getElementById('bulkEditVPsChangesCount');
    const parts = [];
    if (bulkVPNewRows.length > 0) parts.push(`${bulkVPNewRows.length} new`);
    if (bulkVPChangedCells.size > 0) parts.push(`${bulkVPChangedCells.size} edits`);
    if (bulkVPDeleteIds.size > 0) parts.push(`${bulkVPDeleteIds.size} to delete`);
    countEl.textContent = parts.length === 0 ? 'No changes made' : parts.join(', ');
    countEl.style.color = parts.length === 0 ? 'var(--text-light)' : 'var(--primary-green)';
}

async function saveBulkEditVPs() {
    const hasNew = bulkVPNewRows.length > 0, hasEdits = bulkVPChangedCells.size > 0, hasDeletes = bulkVPDeleteIds.size > 0;
    if (!hasNew && !hasEdits && !hasDeletes) { alert('No changes to save'); return; }
    if (!confirm('Save all changes?')) return;
    showLoading('Processing VP changes...');

    try {
        // OLS SAFETY: Fetch fresh cloud data as authoritative base
        let vps = null;
        try {
            const cloudResponse = await fetch('/.netlify/functions/vp-wall', { method: 'GET' });
            if (cloudResponse.ok) {
                const cloudResult = await cloudResponse.json();
                vps = cloudResult.data || [];
                console.log(`☁️ Fetched ${vps.length} VPs from cloud before save`);
            }
        } catch (err) { console.warn('⚠️ Cloud fetch failed, using localStorage:', err.message); }
        if (!vps) vps = JSON.parse(localStorage.getItem('olrfc_vps') || '[]');

        if (hasDeletes && window.netlifyDataManager?.deleteVPs) {
            const result = await window.netlifyDataManager.deleteVPs([...bulkVPDeleteIds]);
            if (result.success) vps = vps.filter(v => !bulkVPDeleteIds.has(v.id));
        }

        if (hasNew) {
            const newVPs = [];
            bulkVPNewRows.forEach(tempId => {
                const row = document.querySelector(`tr[data-vp-id="${tempId}"]`);
                if (!row) return;
                const name = row.querySelector('[data-field="name"]').value.trim();
                const type = row.querySelector('[data-field="type"]').value;
                if (!name || !type) return;
                newVPs.push({ name, type, notes: row.querySelector('[data-field="notes"]').value.trim() });
            });
            if (newVPs.length > 0 && window.netlifyDataManager?.createVPs) {
                const result = await window.netlifyDataManager.createVPs(newVPs);
                if (result.success) result.data.details.createdVPs.forEach((c, i) => vps.push({ ...newVPs[i], id: c.id }));
            }
        }

        if (hasEdits) {
            const changedIds = new Set(); bulkVPChangedCells.forEach(k => changedIds.add(k.split('-')[0]));
            const toUpdate = [];
            changedIds.forEach(id => {
                const row = document.querySelector(`tr[data-vp-id="${id}"]`);
                if (!row || row.classList.contains('marked-for-delete')) return;
                const vp = vps.find(v => v.id === id);
                if (!vp) return;
                vp.name = row.querySelector('[data-field="name"]').value.trim();
                vp.type = row.querySelector('[data-field="type"]').value;
                vp.notes = row.querySelector('[data-field="notes"]').value.trim();
                toUpdate.push(vp);
            });
            if (toUpdate.length > 0 && window.netlifyDataManager?.updateVPs) await window.netlifyDataManager.updateVPs(toUpdate);
        }

        // OLS SAFETY: Re-sync localStorage from cloud after all operations
        try {
            const freshResponse = await fetch('/.netlify/functions/vp-wall', { method: 'GET' });
            if (freshResponse.ok) {
                const freshResult = await freshResponse.json();
                localStorage.setItem('olrfc_vps', JSON.stringify(freshResult.data || []));
            } else { localStorage.setItem('olrfc_vps', JSON.stringify(vps)); }
        } catch (e) { localStorage.setItem('olrfc_vps', JSON.stringify(vps)); }

        showLoadingSuccess('VPs updated!');
        closeModal('bulkEditVPsModal');
        if (typeof loadVPList === 'function') loadVPList();
    } catch (error) { showLoadingError('Failed to save'); alert('Error: ' + error.message); }
}

// ============================================================================
// ============================================================================
// BULK EDIT PLAYERS - OLS 127
// ============================================================================

let bulkPlayerOriginalData = {};
let bulkPlayerChangedCells = new Set();
let bulkPlayerNewRows = [];
let bulkPlayerDeleteIds = new Set();
let bulkPlayerSelectedIds = new Set();
let bulkPlayerNewRowCounter = 0;
let bulkPlayerTeamFilter = 'all';

async function openBulkEditPlayers(teamFilter = null) {
    // OLS SAFETY: Sync fresh data from cloud before opening bulk edit
    showLoading('Loading players from cloud...');
    try {
        const cloudResponse = await fetch('/.netlify/functions/players', { method: 'GET' });
        if (cloudResponse.ok) {
            const cloudResult = await cloudResponse.json();
            const cloudPlayers = cloudResult.data || [];
            localStorage.setItem('olrfc_players', JSON.stringify(cloudPlayers));
            console.log(`✅ Bulk edit players: Synced ${cloudPlayers.length} from cloud`);
        }
    } catch (err) { console.warn('⚠️ Cloud sync failed before bulk edit players:', err.message); }
    hideLoading();

    const allPlayers = adminSystem.getData('players') || [];
    const teams = adminSystem.getData('teams') || [];

    if (teamFilter === null) {
        teamFilter = document.getElementById('player-team-filter')?.value || 'all';
    }
    bulkPlayerTeamFilter = teamFilter;

    bulkPlayerOriginalData = {};
    bulkPlayerChangedCells.clear();
    bulkPlayerNewRows = [];
    bulkPlayerDeleteIds.clear();
    bulkPlayerSelectedIds.clear();
    bulkPlayerNewRowCounter = 0;

    document.getElementById('bulkSelectAllPlayers').checked = false;

    // Populate team filter dropdown
    const filterSelect = document.getElementById('bulk-edit-player-team-filter');
    filterSelect.innerHTML = '<option value="all">All Teams</option>';
    teams.forEach(team => {
        filterSelect.innerHTML += `<option value="${team.slug}" ${teamFilter === team.slug ? 'selected' : ''}>${team.name}</option>`;
    });

    // Add filter change handler
    filterSelect.onchange = function() {
        const hasChanges = bulkPlayerChangedCells.size > 0 || bulkPlayerNewRows.length > 0 || bulkPlayerDeleteIds.size > 0;
        if (hasChanges && !confirm('You have unsaved changes. Changing filter will discard them. Continue?')) {
            this.value = bulkPlayerTeamFilter;
            return;
        }
        closeModal('bulkEditPlayersModal');
        setTimeout(() => openBulkEditPlayers(this.value), 100);
    };

    // Filter players
    let players = teamFilter === 'all' ? allPlayers : allPlayers.filter(p => p.team === teamFilter);

    // Sort by name
    players.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

    // Update count
    document.getElementById('bulk-edit-player-count').textContent = `${players.length} player${players.length !== 1 ? 's' : ''}`;

    // Build team options HTML
    let teamOptionsHTML = '<option value="">-- Select team --</option>';
    teams.forEach(team => {
        teamOptionsHTML += `<option value="${team.slug}">${team.name}</option>`;
    });
    window.bulkPlayerTeamOptionsHTML = teamOptionsHTML;

    const tbody = document.getElementById('bulkEditPlayersBody');
    tbody.innerHTML = '';

    players.forEach(player => {
        bulkPlayerOriginalData[player.id] = JSON.parse(JSON.stringify(player));
        tbody.appendChild(createBulkPlayerRow(player, false));
    });

    updateBulkPlayerChangesCount();
    updateBulkDeletePlayersButton();

    document.getElementById('bulkEditPlayersModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function createBulkPlayerRow(player, isNew = false) {
    const row = document.createElement('tr');
    row.setAttribute('data-player-id', player.id);
    if (isNew) { row.classList.add('new-row'); row.setAttribute('data-is-new', 'true'); }
    
    row.innerHTML = `
        <td class="checkbox-cell" style="text-align: center; padding: 0.5rem;">
            <input type="checkbox" class="bulk-select-player-checkbox" data-player-id="${player.id}" onchange="bulkTogglePlayerSelection('${player.id}', this.checked)">
        </td>
        <td><input type="text" value="${player.name || ''}" data-field="name" data-player-id="${player.id}" oninput="bulkPlayerTrackChange('${player.id}', 'name', this.value)" required></td>
        <td>
            <select data-field="team" data-player-id="${player.id}" onchange="bulkPlayerTrackChange('${player.id}', 'team', this.value)">
                ${window.bulkPlayerTeamOptionsHTML}
            </select>
        </td>
        <td>
            <select data-field="position" data-player-id="${player.id}" onchange="bulkPlayerTrackChange('${player.id}', 'position', this.value)">
                <option value="">-- Select --</option>
                <option value="Prop" ${player.position === 'Prop' ? 'selected' : ''}>Prop</option>
                <option value="Hooker" ${player.position === 'Hooker' ? 'selected' : ''}>Hooker</option>
                <option value="Lock" ${player.position === 'Lock' ? 'selected' : ''}>Lock</option>
                <option value="Flanker" ${player.position === 'Flanker' ? 'selected' : ''}>Flanker</option>
                <option value="Number 8" ${player.position === 'Number 8' ? 'selected' : ''}>Number 8</option>
                <option value="Scrum Half" ${player.position === 'Scrum Half' ? 'selected' : ''}>Scrum Half</option>
                <option value="Fly Half" ${player.position === 'Fly Half' ? 'selected' : ''}>Fly Half</option>
                <option value="Centre" ${player.position === 'Centre' ? 'selected' : ''}>Centre</option>
                <option value="Wing" ${player.position === 'Wing' ? 'selected' : ''}>Wing</option>
                <option value="Full Back" ${player.position === 'Full Back' ? 'selected' : ''}>Full Back</option>
                <option value="Utility" ${player.position === 'Utility' ? 'selected' : ''}>Utility</option>
            </select>
        </td>
        <td style="text-align: center;"><input type="number" value="${player.appearances || 0}" data-field="appearances" data-player-id="${player.id}" oninput="bulkPlayerTrackChange('${player.id}', 'appearances', this.value)" min="0" style="width: 70px;"></td>
        <td style="text-align: center; padding: 0.5rem;">
            ${isNew ? `<button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="bulkRemoveNewPlayerRow('${player.id}')">✕</button>` : ''}
        </td>
    `;
    
    // Set team dropdown value
    const teamSelect = row.querySelector('select[data-field="team"]');
    if (teamSelect) teamSelect.value = player.team || '';
    
    return row;
}

function bulkAddNewPlayerRow() {
    const tbody = document.getElementById('bulkEditPlayersBody');
    bulkPlayerNewRowCounter++;
    const tempId = `new_${Date.now()}_${bulkPlayerNewRowCounter}`;
    
    const newPlayer = { 
        id: tempId, 
        name: '', 
        team: bulkPlayerTeamFilter !== 'all' ? bulkPlayerTeamFilter : '', 
        position: '', 
        appearances: 0 
    };
    bulkPlayerNewRows.push(tempId);
    
    const row = createBulkPlayerRow(newPlayer, true);
    if (tbody.firstChild) tbody.insertBefore(row, tbody.firstChild);
    else tbody.appendChild(row);
    
    row.querySelector('input[data-field="name"]').focus();
    updateBulkPlayerChangesCount();
}

function bulkRemoveNewPlayerRow(tempId) {
    const row = document.querySelector(`tr[data-player-id="${tempId}"]`);
    if (row) { 
        row.remove(); 
        bulkPlayerNewRows = bulkPlayerNewRows.filter(id => id !== tempId); 
        bulkPlayerSelectedIds.delete(tempId); 
        updateBulkPlayerChangesCount(); 
        updateBulkDeletePlayersButton(); 
    }
}

function bulkTogglePlayerSelection(playerId, isSelected) {
    if (isSelected) bulkPlayerSelectedIds.add(playerId); 
    else bulkPlayerSelectedIds.delete(playerId);
    updateBulkDeletePlayersButton();
}

function bulkToggleSelectAllPlayers(isSelected) {
    document.querySelectorAll('.bulk-select-player-checkbox').forEach(cb => {
        cb.checked = isSelected;
        const id = cb.getAttribute('data-player-id');
        if (isSelected) bulkPlayerSelectedIds.add(id); 
        else bulkPlayerSelectedIds.delete(id);
    });
    updateBulkDeletePlayersButton();
}

function bulkDeleteSelectedPlayers() {
    if (bulkPlayerSelectedIds.size === 0) return;
    if (!confirm(`Delete ${bulkPlayerSelectedIds.size} player(s)?`)) return;
    
    [...bulkPlayerSelectedIds].filter(id => id.startsWith('new_')).forEach(id => bulkRemoveNewPlayerRow(id));
    [...bulkPlayerSelectedIds].filter(id => !id.startsWith('new_')).forEach(id => {
        const row = document.querySelector(`tr[data-player-id="${id}"]`);
        if (row) { 
            row.classList.add('marked-for-delete'); 
            bulkPlayerDeleteIds.add(id); 
            row.querySelector('.bulk-select-player-checkbox').checked = false; 
        }
    });
    
    bulkPlayerSelectedIds.clear();
    updateBulkDeletePlayersButton();
    updateBulkPlayerChangesCount();
    document.getElementById('bulkSelectAllPlayers').checked = false;
}

function updateBulkDeletePlayersButton() {
    const btn = document.getElementById('bulkDeleteSelectedPlayersBtn');
    const countSpan = document.getElementById('bulkSelectedPlayersCount');
    if (btn && countSpan) { 
        countSpan.textContent = bulkPlayerSelectedIds.size; 
        btn.style.display = bulkPlayerSelectedIds.size > 0 ? 'inline-block' : 'none'; 
    }
}

function bulkPlayerTrackChange(playerId, field, newValue) {
    if (playerId.startsWith('new_')) { updateBulkPlayerChangesCount(); return; }
    const original = bulkPlayerOriginalData[playerId];
    if (!original) return;
    let origVal = original[field]; 
    if (origVal === null || origVal === undefined) origVal = field === 'appearances' ? 0 : '';
    const changed = String(newValue) !== String(origVal);
    const cell = document.querySelector(`[data-field="${field}"][data-player-id="${playerId}"]`)?.parentElement;
    if (changed) { if (cell) cell.classList.add('changed'); bulkPlayerChangedCells.add(`${playerId}-${field}`); }
    else { if (cell) cell.classList.remove('changed'); bulkPlayerChangedCells.delete(`${playerId}-${field}`); }
    updateBulkPlayerChangesCount();
}

function updateBulkPlayerChangesCount() {
    const countEl = document.getElementById('bulkEditPlayersChangesCount');
    const parts = [];
    if (bulkPlayerNewRows.length > 0) parts.push(`${bulkPlayerNewRows.length} new`);
    if (bulkPlayerChangedCells.size > 0) parts.push(`${bulkPlayerChangedCells.size} edits`);
    if (bulkPlayerDeleteIds.size > 0) parts.push(`${bulkPlayerDeleteIds.size} to delete`);
    countEl.textContent = parts.length === 0 ? 'No changes made' : parts.join(', ');
    countEl.style.color = parts.length === 0 ? 'var(--text-light)' : 'var(--primary-green)';
}

async function saveBulkEditPlayers() {
    const hasNew = bulkPlayerNewRows.length > 0, hasEdits = bulkPlayerChangedCells.size > 0, hasDeletes = bulkPlayerDeleteIds.size > 0;
    if (!hasNew && !hasEdits && !hasDeletes) { alert('No changes to save'); return; }
    if (!confirm('Save all changes?')) return;
    showLoading('Processing player changes...');

    try {
        // OLS SAFETY: Fetch fresh cloud data as authoritative base
        let players = null;
        try {
            const cloudResponse = await fetch('/.netlify/functions/players', { method: 'GET' });
            if (cloudResponse.ok) {
                const cloudResult = await cloudResponse.json();
                players = cloudResult.data || [];
                console.log(`☁️ Fetched ${players.length} players from cloud before save`);
            }
        } catch (err) { console.warn('⚠️ Cloud fetch failed, using localStorage:', err.message); }
        if (!players) players = adminSystem.getData('players') || [];

        // Delete
        if (hasDeletes && window.netlifyDataManager?.deletePlayers) {
            const result = await window.netlifyDataManager.deletePlayers([...bulkPlayerDeleteIds]);
            if (result.success) players = players.filter(p => !bulkPlayerDeleteIds.has(p.id));
        }

        // Create new
        if (hasNew) {
            const newPlayers = [];
            bulkPlayerNewRows.forEach(tempId => {
                const row = document.querySelector(`tr[data-player-id="${tempId}"]`);
                if (!row) return;
                const name = row.querySelector('[data-field="name"]').value.trim();
                const team = row.querySelector('[data-field="team"]').value;
                const position = row.querySelector('[data-field="position"]').value;
                if (!name || !team || !position) return;
                newPlayers.push({
                    name,
                    team,
                    position,
                    appearances: parseInt(row.querySelector('[data-field="appearances"]').value) || 0
                });
            });
            if (newPlayers.length > 0 && window.netlifyDataManager?.createPlayers) {
                const result = await window.netlifyDataManager.createPlayers(newPlayers);
                if (result.success) {
                    result.data.details.createdPlayers.forEach((c, i) => players.push({ ...newPlayers[i], id: c.id }));
                }
            }
        }

        // Update
        if (hasEdits) {
            const changedIds = new Set();
            bulkPlayerChangedCells.forEach(k => changedIds.add(k.split('-')[0]));
            const toUpdate = [];
            changedIds.forEach(id => {
                const row = document.querySelector(`tr[data-player-id="${id}"]`);
                if (!row || row.classList.contains('marked-for-delete')) return;
                const player = players.find(p => p.id === id);
                if (!player) return;
                player.name = row.querySelector('[data-field="name"]').value.trim();
                player.team = row.querySelector('[data-field="team"]').value;
                player.position = row.querySelector('[data-field="position"]').value;
                player.appearances = parseInt(row.querySelector('[data-field="appearances"]').value) || 0;
                toUpdate.push(player);
            });
            if (toUpdate.length > 0 && window.netlifyDataManager?.updatePlayers) {
                await window.netlifyDataManager.updatePlayers(toUpdate);
            }
        }

        // OLS SAFETY: Re-sync localStorage from cloud after all operations
        try {
            const freshResponse = await fetch('/.netlify/functions/players', { method: 'GET' });
            if (freshResponse.ok) {
                const freshResult = await freshResponse.json();
                localStorage.setItem('olrfc_players', JSON.stringify(freshResult.data || []));
            } else { adminSystem.saveData('players', players); }
        } catch (e) { adminSystem.saveData('players', players); }

        showLoadingSuccess('Players updated!');
        closeModal('bulkEditPlayersModal');
        adminSystem.loadPlayers();
        adminSystem.updateStats();
    } catch (error) {
        showLoadingError('Failed to save');
        alert('Error: ' + error.message);
    }
}

// ============================================================================
// END BULK EDIT - OLS 127
// ============================================================================

        function editPlayer(index) {
    const players = adminSystem.getData('players');
    const player = players[index];

    if (!player) {
        console.error('Player not found at index:', index);
        return;
    }

    adminSystem.currentEditIndex = index;
    adminSystem.currentSection = 'players';
    
    document.getElementById('playerName').value = player.name;
    document.getElementById('playerPosition').value = player.position || '';
    document.getElementById('playerApps').value = player.appearances || 0;
    
    // Show existing photo if available
    const preview = document.getElementById('playerPhotoPreview');
    const previewImg = document.getElementById('playerPhotoPreviewImg');
    if (player.photo) {
        previewImg.src = player.photo;
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
    
    openModal('playerModal');
    
    // Set team dropdown value AFTER modal opens and dropdown is populated
    setTimeout(() => {
        document.getElementById('playerTeam').value = player.team;
    }, 50);
}

async function deletePlayer(index) {
    const players = adminSystem.getData('players');
    const player = players[index];

    if (!player) {
        console.error('Player not found at index:', index);
        return;
    }

    if (confirm(`Are you sure you want to delete ${player.name}?`)) {
        showLoading('Deleting player...');

        try {
            // 1. CLOUD-FIRST: Delete from Netlify Blobs first
            if (window.netlifyDataManager) {
                const result = await window.netlifyDataManager.deletePlayer(player.id);

                if (!result.success) {
                    throw new Error(result.error || 'Cloud deletion failed');
                }
                console.log('Player deleted from cloud storage');
            }

            // 2. Only delete from localStorage AFTER cloud succeeds
            const freshPlayers = adminSystem.getData('players');
            const localIndex = freshPlayers.findIndex(p => p.id === player.id);
            if (localIndex !== -1) {
                freshPlayers.splice(localIndex, 1);
                adminSystem.saveData('players', freshPlayers);
            }

            // Update UI
            adminSystem.loadPlayers();
            adminSystem.updateStats();
            showLoadingSuccess('Player deleted!');

        } catch (error) {
            console.error('Error deleting player:', error);
            showLoadingError('Failed to delete player');
            adminSystem.showAlert('players', 'Error deleting player: ' + error.message, 'danger');
        }
    }
}

        function editShopProduct(index) { console.log('Edit shop product', index); }
        function migrateToCloud() {
    // Show migration options dialog
    showMigrationDialog();
}

function showMigrationDialog() {
    // Remove existing dialog if present
    const existingDialog = document.getElementById('migrationDialog');
    if (existingDialog) {
        existingDialog.remove();
    }
    
    // Analyze current data for migration
    const migrationAnalysis = analyzeMigrationData();
    
    const dialog = document.createElement('div');
    dialog.id = 'migrationDialog';
    dialog.className = 'modal';
    dialog.style.display = 'block';
    
    dialog.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>🚀 Migrate Data to Cloud Storage</h3>
                <button class="close" onclick="closeMigrationDialog()">&times;</button>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <p>This will transfer your localStorage data to Netlify Forms for persistent cloud storage.</p>
                
                <div style="background: #e3f2fd; border: 1px solid #1976d2; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <h4>Migration Analysis</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
                        ${Object.entries(migrationAnalysis.dataTypes).map(([dataType, info]) => `
                            <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 4px;">
                                <strong>${dataType.charAt(0).toUpperCase() + dataType.slice(1)}</strong><br>
                                <span style="color: #1976d2;">${info.count} records</span><br>
                                <small style="color: ${info.hasIntegration ? '#4caf50' : '#ff9800'};">
                                    ${info.hasIntegration ? 'Cloud Ready' : 'Local Only'}
                                </small>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <strong>Total Records:</strong> ${migrationAnalysis.totalRecords}<br>
                        <strong>Cloud Integration:</strong> ${migrationAnalysis.integratedTypes} of 6 data types ready<br>
                        <strong>Estimated Time:</strong> ${estimateMigrationTime(migrationAnalysis.totalRecords)}
                    </div>
                </div>
                
                <div style="margin: 1rem 0;">
                    <h4>Migration Options</h4>
                    <label style="display: block; margin: 0.5rem 0;">
                        <input type="radio" name="migrationMode" value="integrated" checked>
                        Migrate only cloud-integrated data types (${migrationAnalysis.integratedTypes} types)
                    </label>
                    <label style="display: block; margin: 0.5rem 0;">
                        <input type="radio" name="migrationMode" value="all">
                        Attempt to migrate all data types (may fail for non-integrated types)
                    </label>
                </div>
                
                <div style="margin: 1rem 0;">
                    <h4>Safety Options</h4>
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;">
                        <input type="checkbox" id="createMigrationBackup" checked>
                        Create backup before migration (recommended)
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;">
                        <input type="checkbox" id="verifyAfterMigration" checked>
                        Verify data integrity after migration
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;">
                        <input type="checkbox" id="pauseOnErrors">
                        Pause migration on errors for review
                    </label>
                </div>
                
                <div style="margin: 1rem 0; padding: 1rem; background: #fff3e0; border: 1px solid #ff9800; border-radius: 8px;">
                    <strong>⚠️ Important Notes:</strong><br>
                    • This will submit each record individually to Netlify Forms<br>
                    • Existing cloud data will not be affected (no duplicates)<br>
                    • Migration can be stopped at any time<br>
                    • localStorage data will remain unchanged
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeMigrationDialog()">Cancel</button>
                <button class="btn btn-primary" onclick="startMigration()" 
                        ${migrationAnalysis.totalRecords === 0 ? 'disabled' : ''}>
                    Start Migration
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(dialog);
}

function analyzeMigrationData() {
    const dataTypes = ['news', 'fixtures', 'players', 'sponsors', 'gallery', 'shop'];
    const analysis = {
        dataTypes: {},
        totalRecords: 0,
        integratedTypes: 0,
        nonIntegratedTypes: 0
    };
    
    // Check which data types have cloud integration
    const integratedTypes = ['news', 'fixtures', 'players', 'sponsors']; // Based on your session 3 progress
    
    dataTypes.forEach(dataType => {
        const data = adminSystem.getData(dataType);
        const hasIntegration = integratedTypes.includes(dataType);
        
        analysis.dataTypes[dataType] = {
            count: data.length,
            hasIntegration: hasIntegration
        };
        
        analysis.totalRecords += data.length;
        
        if (hasIntegration) {
            analysis.integratedTypes++;
        } else {
            analysis.nonIntegratedTypes++;
        }
    });
    
    return analysis;
}

function estimateMigrationTime(recordCount) {
    const secondsPerRecord = 0.5; // Estimate 0.5 seconds per record
    const totalSeconds = recordCount * secondsPerRecord;
    
    if (totalSeconds < 60) {
        return `${Math.ceil(totalSeconds)} seconds`;
    } else {
        return `${Math.ceil(totalSeconds / 60)} minutes`;
    }
}

function closeMigrationDialog() {
    const dialog = document.getElementById('migrationDialog');
    if (dialog) {
        dialog.remove();
    }
}

async function startMigration() {
    try {
        // Get migration settings
        const migrationMode = document.querySelector('input[name="migrationMode"]:checked')?.value || 'integrated';
        const createBackup = document.getElementById('createMigrationBackup')?.checked || false;
        const verifyAfter = document.getElementById('verifyAfterMigration')?.checked || false;
        const pauseOnErrors = document.getElementById('pauseOnErrors')?.checked || false;
        
        // Close dialog
        closeMigrationDialog();
        
        // Create backup if requested
        if (createBackup) {
            showMigrationProgress('Creating backup...', 0, 0);
            await createMigrationBackup();
        }
        
        // Start migration
        const migrationResult = await performBatchMigration(migrationMode, pauseOnErrors);
        
        // Verify data integrity if requested
        if (verifyAfter && migrationResult.success) {
            showMigrationProgress('Verifying data integrity...', 0, 0);
            await verifyMigrationIntegrity(migrationResult);
        }
        
        // Show completion
        showMigrationComplete(migrationResult);
        
    } catch (error) {
        console.error('Migration failed:', error);
        showMigrationError(`Migration failed: ${error.message}`);
    }
}

async function createMigrationBackup() {
    const backupData = {
        metadata: {
            backupDate: new Date().toISOString(),
            backupType: 'pre-migration',
            backupVersion: '1.0'
        },
        data: {}
    };
    
    const dataTypes = ['news', 'fixtures', 'players', 'sponsors', 'gallery', 'shop'];
    dataTypes.forEach(dataType => {
        backupData.data[dataType] = {
            records: adminSystem.getData(dataType),
            count: adminSystem.getData(dataType).length
        };
    });
    
    const filename = `olrfc_migration_backup_${Date.now()}.json`;
    const dataStr = JSON.stringify(backupData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const downloadLink = document.createElement('a');
    downloadLink.href = URL.createObjectURL(dataBlob);
    downloadLink.download = filename;
    downloadLink.style.display = 'none';
    
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
}

async function performBatchMigration(migrationMode, pauseOnErrors) {
    const migrationResult = {
        success: false,
        totalRecords: 0,
        successCount: 0,
        errorCount: 0,
        skippedCount: 0,
        errors: [],
        dataTypes: {},
        startTime: new Date(),
        endTime: null
    };
    
    // Define which data types to migrate
    const integratedTypes = ['news', 'fixtures', 'players', 'sponsors'];
    const allTypes = ['news', 'fixtures', 'players', 'sponsors', 'gallery', 'shop'];
    const dataTypesToMigrate = migrationMode === 'integrated' ? integratedTypes : allTypes;
    
    // Check if netlify data manager is available
    if (!window.netlifyDataManager) {
        throw new Error('Netlify Data Manager not available. Please check your integration.');
    }
    
    let totalRecords = 0;
    let processedRecords = 0;
    
    // Count total records
    dataTypesToMigrate.forEach(dataType => {
        const data = adminSystem.getData(dataType);
        totalRecords += data.length;
        migrationResult.dataTypes[dataType] = {
            total: data.length,
            success: 0,
            errors: 0,
            skipped: 0
        };
    });
    
    migrationResult.totalRecords = totalRecords;
    
    if (totalRecords === 0) {
        throw new Error('No records found to migrate');
    }
    
    // Process each data type
    for (const dataType of dataTypesToMigrate) {
        const data = adminSystem.getData(dataType);
        
        showMigrationProgress(`Migrating ${dataType}...`, processedRecords, totalRecords);
        
        // Process each record in the data type
        for (let i = 0; i < data.length; i++) {
            const record = data[i];
            processedRecords++;
            
            try {
                // Skip if record already has cloud sync marker
                if (record._cloudSynced) {
                    migrationResult.dataTypes[dataType].skipped++;
                    migrationResult.skippedCount++;
                    continue;
                }
                
                showMigrationProgress(
                    `Migrating ${dataType}: ${i + 1}/${data.length}`, 
                    processedRecords, 
                    totalRecords
                );
                
                // Submit to cloud based on data type
                let result;
                switch (dataType) {
                    case 'news':
                        result = await window.netlifyDataManager.createNews(record);
                        break;
                    case 'fixtures':
                        result = await window.netlifyDataManager.createFixture(record);
                        break;
                    case 'players':
                        result = await window.netlifyDataManager.createPlayer(record);
                        break;
                    case 'sponsors':
                        result = await window.netlifyDataManager.createSponsor(record);
                        break;
                    case 'gallery':
                        // Note: Gallery may not have cloud integration yet
                        throw new Error(`${dataType} cloud integration not yet implemented`);
                    case 'shop':
                        // Note: Shop may not have cloud integration yet
                        throw new Error(`${dataType} cloud integration not yet implemented`);
                    default:
                        throw new Error(`Unknown data type: ${dataType}`);
                }
                
                if (result && result.success) {
                    migrationResult.dataTypes[dataType].success++;
                    migrationResult.successCount++;
                    
                    // Mark record as synced (optional - only if you want to track this)
                    // record._cloudSynced = true;
                    
                } else {
                    throw new Error(result?.error || 'Unknown cloud submission error');
                }
                
                // Small delay to avoid overwhelming the API
                await new Promise(resolve => setTimeout(resolve, 100));
                
            } catch (error) {
                migrationResult.dataTypes[dataType].errors++;
                migrationResult.errorCount++;
                migrationResult.errors.push({
                    dataType: dataType,
                    recordIndex: i,
                    record: record,
                    error: error.message,
                    timestamp: new Date().toISOString()
                });
                
                console.warn(`Migration error for ${dataType}[${i}]:`, error);
                
                if (pauseOnErrors) {
                    const continueOnError = await askContinueOnError(error, dataType, i);
                    if (!continueOnError) {
                        throw new Error('Migration paused by user due to errors');
                    }
                }
            }
        }
    }
    
    migrationResult.endTime = new Date();
    migrationResult.success = migrationResult.errorCount < migrationResult.totalRecords;
    
    return migrationResult;
}

async function askContinueOnError(error, dataType, recordIndex) {
    return new Promise((resolve) => {
        const dialog = document.createElement('div');
        dialog.className = 'modal';
        dialog.style.display = 'block';
        dialog.innerHTML = `
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>Migration Error</h3>
                </div>
                <div>
                    <p><strong>Error occurred during migration:</strong></p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
                        <strong>Data Type:</strong> ${dataType}<br>
                        <strong>Record:</strong> ${recordIndex + 1}<br>
                        <strong>Error:</strong> ${error.message}
                    </div>
                    <p>What would you like to do?</p>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button class="btn btn-danger" onclick="handleErrorChoice(false)">Stop Migration</button>
                    <button class="btn btn-secondary" onclick="handleErrorChoice(true)">Continue</button>
                </div>
            </div>
        `;
        
        window.handleErrorChoice = (continueChoice) => {
            dialog.remove();
            delete window.handleErrorChoice;
            resolve(continueChoice);
        };
        
        document.body.appendChild(dialog);
    });
}

async function verifyMigrationIntegrity(migrationResult) {
    // Basic verification - check if the migration counts make sense
    const verification = {
        passed: true,
        issues: []
    };
    
    Object.entries(migrationResult.dataTypes).forEach(([dataType, stats]) => {
        if (stats.errors > stats.success) {
            verification.passed = false;
            verification.issues.push(`${dataType}: More errors (${stats.errors}) than successes (${stats.success})`);
        }
    });
    
    migrationResult.verification = verification;
    return verification;
}

// UI functions for migration progress
function showMigrationProgress(message, current, total) {
    let alertElement = document.getElementById('migrationProgress');
    if (!alertElement) {
        alertElement = document.createElement('div');
        alertElement.id = 'migrationProgress';
        alertElement.className = 'alert alert-info';
        alertElement.style.position = 'fixed';
        alertElement.style.top = '100px';
        alertElement.style.right = '20px';
        alertElement.style.zIndex = '10000';
        alertElement.style.minWidth = '350px';
        document.body.appendChild(alertElement);
    }
    
    const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
    
    alertElement.innerHTML = `
        <strong>Migration in Progress...</strong><br>
        ${message}<br>
        <div style="margin-top: 10px;">
            <div style="background: #ddd; height: 8px; border-radius: 4px;">
                <div style="background: var(--primary-green); height: 100%; width: ${percentage}%; border-radius: 4px; transition: width 0.3s ease;"></div>
            </div>
            <small>${current} / ${total} records (${percentage}%)</small>
        </div>
        <button onclick="stopMigration()" style="margin-top: 10px; padding: 5px 10px; border: none; background: #dc3545; color: white; border-radius: 4px; cursor: pointer; font-size: 12px;">
            Stop Migration
        </button>
    `;
}

function showMigrationComplete(result) {
    const progressElement = document.getElementById('migrationProgress');
    if (progressElement) {
        progressElement.remove();
    }
    
    const duration = result.endTime ? Math.round((result.endTime - result.startTime) / 1000) : 0;
    const successRate = result.totalRecords > 0 ? Math.round((result.successCount / result.totalRecords) * 100) : 0;
    
    const alertType = result.errorCount === 0 ? 'success' : result.successCount > result.errorCount ? 'warning' : 'danger';
    
    const alertElement = document.createElement('div');
    alertElement.className = `alert alert-${alertType}`;
    alertElement.style.position = 'fixed';
    alertElement.style.top = '100px';
    alertElement.style.right = '20px';
    alertElement.style.zIndex = '10000';
    alertElement.style.minWidth = '400px';
    alertElement.style.maxHeight = '500px';
    alertElement.style.overflowY = 'auto';
    
    alertElement.innerHTML = `
        <strong>Migration Complete!</strong><br>
        <div style="margin: 1rem 0;">
            <strong>Results:</strong><br>
            • Total Records: ${result.totalRecords}<br>
            • Successfully Migrated: ${result.successCount} (${successRate}%)<br>
            • Errors: ${result.errorCount}<br>
            • Skipped: ${result.skippedCount}<br>
            • Duration: ${duration} seconds
        </div>
        
        <div style="margin: 1rem 0;">
            <strong>Data Type Breakdown:</strong><br>
            ${Object.entries(result.dataTypes).map(([dataType, stats]) => 
                `• ${dataType}: ${stats.success}/${stats.total} (${stats.errors} errors)`
            ).join('<br>')}
        </div>
        
        ${result.errors.length > 0 ? `
            <details style="margin-top: 1rem;">
                <summary>View Error Details (${result.errors.length} errors)</summary>
                <div style="max-height: 150px; overflow-y: auto; margin-top: 0.5rem; font-size: 12px;">
                    ${result.errors.map(error => 
                        `<div style="border-bottom: 1px solid #ddd; padding: 0.3rem 0;">
                            <strong>${error.dataType}:</strong> ${error.error}
                        </div>`
                    ).join('')}
                </div>
            </details>
        ` : ''}
        
        <button onclick="this.parentElement.remove()" style="margin-top: 15px; padding: 8px 15px; border: none; background: var(--primary-green); color: white; border-radius: 4px; cursor: pointer;">
            Close
        </button>
    `;
    
    document.body.appendChild(alertElement);
    
    // Auto-remove after 2 minutes
    setTimeout(() => {
        if (alertElement.parentElement) {
            alertElement.remove();
        }
    }, 120000);
}

function showMigrationError(message) {
    const progressElement = document.getElementById('migrationProgress');
    if (progressElement) {
        progressElement.remove();
    }
    
    const alertElement = document.createElement('div');
    alertElement.className = 'alert alert-danger';
    alertElement.style.position = 'fixed';
    alertElement.style.top = '100px';
    alertElement.style.right = '20px';
    alertElement.style.zIndex = '10000';
    alertElement.style.minWidth = '350px';
    
    alertElement.innerHTML = `
        <strong>Migration Failed!</strong><br>
        ${message}<br>
        <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; border: none; background: #dc3545; color: white; border-radius: 4px; cursor: pointer;">Close</button>
    `;
    
    document.body.appendChild(alertElement);
    
    setTimeout(() => {
        if (alertElement.parentElement) {
            alertElement.remove();
        }
    }, 15000);
}

function stopMigration() {
    // This would need to be implemented with proper cancellation tokens
    // For now, just show a warning
    if (confirm('Are you sure you want to stop the migration? Progress will be lost.')) {
        const progressElement = document.getElementById('migrationProgress');
        if (progressElement) {
            progressElement.remove();
        }
        
        showMigrationError('Migration stopped by user');
    }
}
        function deleteShopProduct(index) { console.log('Delete shop product', index); }
        function duplicateShopProduct(index) { console.log('Duplicate shop product', index); }
        function viewAlbum(index) { console.log('View album', index); }
        
        function editAlbum(index) {
            const gallery = adminSystem.getData('gallery');
            const album = gallery[index];
            
            // Parse photos if it's a JSON string (from Netlify Forms)
            if (typeof album.photos === 'string') {
                try {
                    album.photos = JSON.parse(album.photos);
                } catch (e) {
                    console.error('Error parsing album photos:', e);
                    alert('Error loading album photos. Please try again.');
                    return;
                }
            }
            
            // Store the edit index
            document.getElementById('galleryEditIndex').value = index;
            
            // Update modal title and button text
            document.getElementById('galleryModalTitle').textContent = '✏️ Edit Album';
            document.getElementById('gallerySubmitBtn').textContent = '💾 Save Changes';
            
            // Hide file upload section in edit mode
            document.getElementById('fileUploadSection').style.display = 'none';
            document.getElementById('galleryFiles').removeAttribute('required');
            
            // Show cover photo selection
            const coverPhotoSection = document.getElementById('coverPhotoSection');
            coverPhotoSection.style.display = 'block';
            
            // Populate cover photo grid
            const coverPhotoGrid = document.getElementById('coverPhotoGrid');
            coverPhotoGrid.innerHTML = '';
            
            if (album.photos && Array.isArray(album.photos) && album.photos.length > 0) {
                album.photos.forEach((photo, photoIndex) => {
                    const photoOption = document.createElement('div');
                    photoOption.className = 'cover-photo-option';
                    if (photoIndex === 0) {
                        photoOption.classList.add('selected');
                    }
                    photoOption.dataset.photoIndex = photoIndex;
                    photoOption.innerHTML = `<img src="${photo.url}" alt="Photo ${photoIndex + 1}">`;
                    
                    photoOption.addEventListener('click', function() {
                        // Remove selected class from all
                        coverPhotoGrid.querySelectorAll('.cover-photo-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        // Add selected class to clicked
                        this.classList.add('selected');
                    });
                    
                    coverPhotoGrid.appendChild(photoOption);
                });
            }
            
            // Open modal FIRST
            openModal('galleryModal');
            
            // THEN populate form fields after a delay (to allow dropdown population to complete)
            setTimeout(() => {
                document.getElementById('galleryTitle').value = album.title;
                document.getElementById('galleryCategory').value = album.category;
                document.getElementById('galleryTeam').value = album.team || 'other';
                
                // OLS 122: Repopulate fixtures dropdown based on the album's team, THEN set the fixture value
                if (typeof populateFixturesDropdown === 'function') {
                    populateFixturesDropdown(album.team || 'other');
                }
                
                // Set fixture value AFTER repopulating the dropdown
                setTimeout(() => {
                    document.getElementById('galleryFixture').value = album.fixtureId || '';
                }, 20);
                
                document.getElementById('galleryDescription').value = album.description || '';
            }, 50); // Slightly longer than openModal's 30ms to ensure dropdown is populated
        }
        
        async function deleteAlbum(index) {
    const gallery = adminSystem.getData('gallery');
    const album = gallery[index];

    if (!album) {
        console.error('Album not found at index:', index);
        return;
    }

    if (confirm(`Are you sure you want to delete "${album.title}"?\n\nThis will:\n✗ Remove the album from your dashboard\n✗ Delete the album from cloud storage\n\n⚠️ Note: Photos will remain in Cloudinary.`)) {
        try {
            // 1. CLOUD-FIRST: Delete from Netlify Blobs first
            if (window.netlifyDataManager) {
                const result = await window.netlifyDataManager.deleteGalleryAlbum(album.id);
                if (!result.success) {
                    throw new Error(result.error || 'Cloud deletion failed');
                }
                console.log('Album deleted from cloud storage');
            }

            // 2. Only delete from localStorage AFTER cloud succeeds
            const freshGallery = adminSystem.getData('gallery');
            const localIndex = freshGallery.findIndex(a => a.id === album.id);
            if (localIndex !== -1) {
                freshGallery.splice(localIndex, 1);
                adminSystem.saveData('gallery', freshGallery);
            }

            // Update UI
            adminSystem.loadGallery();
            adminSystem.updateStats();

            adminSystem.showAlert('gallery', 'Album deleted successfully!', 'success');

        } catch (error) {
            console.error('Error deleting album:', error);
            adminSystem.showAlert('gallery', 'Error deleting album: ' + error.message, 'danger');
        }
    }
}
        function exportData() {
    try {
        // Show progress indicator
        showExportProgress('Initializing export...');
        
        // Define all data types to export
        const dataTypes = ['news', 'fixtures', 'players', 'sponsors', 'gallery', 'shop'];
        
        // Initialize export object with metadata
        const exportData = {
            metadata: {
                exportDate: new Date().toISOString(),
                exportVersion: '1.0',
                systemVersion: 'OLS-WEBSITE-v1.0',
                dataTypes: dataTypes,
                exportedBy: document.getElementById('currentUser').textContent || 'Admin User',
                browserInfo: {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    platform: navigator.platform
                }
            },
            data: {},
            statistics: {},
            validation: {
                errors: [],
                warnings: [],
                totalRecords: 0,
                validatedAt: new Date().toISOString()
            }
        };

        let totalRecords = 0;
        let hasErrors = false;

        // Export each data type with validation
        dataTypes.forEach(dataType => {
            showExportProgress(`Processing ${dataType}...`);
            
            try {
                const rawData = adminSystem.getData(dataType);
                const validatedData = validateDataType(dataType, rawData);
                
                exportData.data[dataType] = {
                    records: validatedData.data,
                    count: validatedData.data.length,
                    lastModified: getLastModified(dataType),
                    dataIntegrity: validatedData.integrity,
                    schemaVersion: getSchemaVersion(dataType)
                };
                
                exportData.statistics[dataType] = {
                    recordCount: validatedData.data.length,
                    validRecords: validatedData.valid,
                    invalidRecords: validatedData.invalid,
                    lastUpdate: getLastModified(dataType)
                };
                
                totalRecords += validatedData.data.length;
                
                // Collect validation errors
                if (validatedData.errors.length > 0) {
                    exportData.validation.errors.push(...validatedData.errors);
                    hasErrors = true;
                }
                
                if (validatedData.warnings.length > 0) {
                    exportData.validation.warnings.push(...validatedData.warnings);
                }
                
            } catch (error) {
                console.error(`Error processing ${dataType}:`, error);
                exportData.validation.errors.push({
                    dataType: dataType,
                    error: `Failed to export ${dataType}: ${error.message}`,
                    timestamp: new Date().toISOString()
                });
                hasErrors = true;
            }
        });

        exportData.validation.totalRecords = totalRecords;
        
        // Export website settings
        showExportProgress('Exporting settings...');
        exportData.data.settings = {
            websiteFeatures: JSON.parse(localStorage.getItem('olrfc_admin_features') || '{}'),
            adminSession: JSON.parse(localStorage.getItem('olrfc_admin_session') || '{}'),
            exportCount: getExportCount() + 1
        };

        // Generate final validation report
        const validationReport = generateValidationReport(exportData.validation);
        
        // Create downloadable file
        showExportProgress('Generating download file...');
        
        const filename = `olrfc_export_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        // Create download link
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(dataBlob);
        downloadLink.download = filename;
        downloadLink.style.display = 'none';
        
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        // Update export count
        incrementExportCount();
        
        // Show completion message
        const statusMessage = hasErrors ? 
            `Export completed with ${exportData.validation.errors.length} errors and ${exportData.validation.warnings.length} warnings` :
            `Export completed successfully! ${totalRecords} records exported.`;
            
        const alertType = hasErrors ? 'warning' : 'success';
        
        showExportComplete(statusMessage, validationReport, filename, alertType);
        
        // Log export event
        console.log('Data export completed:', {
            filename: filename,
            totalRecords: totalRecords,
            errors: exportData.validation.errors.length,
            warnings: exportData.validation.warnings.length
        });
        
    } catch (error) {
        console.error('Export failed:', error);
        showExportError(`Export failed: ${error.message}`);
    }
}

// Data validation functions
function validateDataType(dataType, data) {
    const result = {
        data: data,
        valid: 0,
        invalid: 0,
        errors: [],
        warnings: [],
        integrity: 'valid'
    };
    
    if (!Array.isArray(data)) {
        result.errors.push({
            dataType: dataType,
            error: 'Data is not an array',
            timestamp: new Date().toISOString()
        });
        result.integrity = 'corrupted';
        return result;
    }
    
    // Validate each record based on data type
    data.forEach((record, index) => {
        const validation = validateRecord(dataType, record, index);
        
        if (validation.isValid) {
            result.valid++;
        } else {
            result.invalid++;
            result.errors.push(...validation.errors);
        }
        
        result.warnings.push(...validation.warnings);
    });
    
    // Set overall integrity status
    if (result.invalid > 0) {
        result.integrity = result.invalid > result.valid ? 'corrupted' : 'partial';
    }
    
    return result;
}

function validateRecord(dataType, record, index) {
    const validation = {
        isValid: true,
        errors: [],
        warnings: []
    };
    
    // Common validation
    if (!record || typeof record !== 'object') {
        validation.isValid = false;
        validation.errors.push({
            dataType: dataType,
            recordIndex: index,
            error: 'Record is not a valid object',
            timestamp: new Date().toISOString()
        });
        return validation;
    }
    
    // Data-type specific validation
    switch (dataType) {
        case 'news':
            if (!record.title || !record.content) {
                validation.isValid = false;
                validation.errors.push({
                    dataType: dataType,
                    recordIndex: index,
                    error: 'News record missing required fields (title, content)',
                    timestamp: new Date().toISOString()
                });
            }
            break;
            
        case 'fixtures':
            if (!record.team || !record.opponent || !record.dateTime) {
                validation.isValid = false;
                validation.errors.push({
                    dataType: dataType,
                    recordIndex: index,
                    error: 'Fixture record missing required fields (team, opponent, dateTime)',
                    timestamp: new Date().toISOString()
                });
            }
            break;
            
        case 'players':
            if (!record.name || !record.team) {
                validation.isValid = false;
                validation.errors.push({
                    dataType: dataType,
                    recordIndex: index,
                    error: 'Player record missing required fields (name, team)',
                    timestamp: new Date().toISOString()
                });
            }
            break;
            
        case 'sponsors':
            if (!record.name || !record.tier) {
                validation.isValid = false;
                validation.errors.push({
                    dataType: dataType,
                    recordIndex: index,
                    error: 'Sponsor record missing required fields (name, tier)',
                    timestamp: new Date().toISOString()
                });
            }
            break;
            
        case 'gallery':
            if (!record.title || !record.photos) {
                validation.isValid = false;
                validation.errors.push({
                    dataType: dataType,
                    recordIndex: index,
                    error: 'Gallery record missing required fields (title, photos)',
                    timestamp: new Date().toISOString()
                });
            }
            break;
            
        case 'shop':
            if (!record.name || !record.price) {
                validation.isValid = false;
                validation.errors.push({
                    dataType: dataType,
                    recordIndex: index,
                    error: 'Shop record missing required fields (name, price)',
                    timestamp: new Date().toISOString()
                });
            }
            break;
    }
    
    return validation;
}

// Helper functions
function getLastModified(dataType) {
    // Try to get from localStorage metadata, fallback to current timestamp
    const metaKey = `olrfc_${dataType}_meta`;
    const meta = JSON.parse(localStorage.getItem(metaKey) || '{}');
    return meta.lastModified || new Date().toISOString();
}

function getSchemaVersion(dataType) {
    // Return schema version for each data type
    const schemas = {
        news: '1.0',
        fixtures: '1.0', 
        players: '1.0',
        sponsors: '1.0',
        gallery: '1.0',
        shop: '1.0'
    };
    return schemas[dataType] || '1.0';
}

function getExportCount() {
    return parseInt(localStorage.getItem('olrfc_export_count') || '0');
}

function incrementExportCount() {
    const count = getExportCount() + 1;
    localStorage.setItem('olrfc_export_count', count.toString());
}

function generateValidationReport(validation) {
    let report = `Validation Report:\n`;
    report += `Total Records: ${validation.totalRecords}\n`;
    report += `Errors: ${validation.errors.length}\n`;
    report += `Warnings: ${validation.warnings.length}\n\n`;
    
    if (validation.errors.length > 0) {
        report += `ERRORS:\n`;
        validation.errors.forEach((error, index) => {
            report += `${index + 1}. [${error.dataType}] ${error.error}\n`;
        });
        report += `\n`;
    }
    
    if (validation.warnings.length > 0) {
        report += `WARNINGS:\n`;
        validation.warnings.forEach((warning, index) => {
            report += `${index + 1}. [${warning.dataType}] ${warning.warning}\n`;
        });
    }
    
    return report;
}

// Progress and completion UI functions
function showExportProgress(message) {
    // Update existing alert or create new one
    let alertElement = document.getElementById('exportProgress');
    if (!alertElement) {
        alertElement = document.createElement('div');
        alertElement.id = 'exportProgress';
        alertElement.className = 'alert alert-info';
        alertElement.style.position = 'fixed';
        alertElement.style.top = '100px';
        alertElement.style.right = '20px';
        alertElement.style.zIndex = '10000';
        alertElement.style.minWidth = '300px';
        document.body.appendChild(alertElement);
    }
    
    alertElement.innerHTML = `
        <strong>Exporting Data...</strong><br>
        ${message}
        <div style="margin-top: 10px;">
            <div style="background: #ddd; height: 6px; border-radius: 3px;">
                <div style="background: var(--primary-green); height: 100%; width: 50%; border-radius: 3px; animation: pulse 1s infinite;"></div>
            </div>
        </div>
    `;
}

function showExportComplete(message, report, filename, alertType) {
    // Remove progress indicator
    const progressElement = document.getElementById('exportProgress');
    if (progressElement) {
        progressElement.remove();
    }
    
    // Show completion message
    const alertElement = document.createElement('div');
    alertElement.className = `alert alert-${alertType}`;
    alertElement.style.position = 'fixed';
    alertElement.style.top = '100px';
    alertElement.style.right = '20px';
    alertElement.style.zIndex = '10000';
    alertElement.style.minWidth = '350px';
    alertElement.style.maxHeight = '400px';
    alertElement.style.overflowY = 'auto';
    
    alertElement.innerHTML = `
        <strong>Export Complete!</strong><br>
        ${message}<br>
        <small>File: ${filename}</small><br>
        <details style="margin-top: 10px;">
            <summary>View Validation Report</summary>
            <pre style="font-size: 12px; margin-top: 10px; background: #f8f9fa; padding: 10px; border-radius: 4px;">${report}</pre>
        </details>
        <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; border: none; background: var(--primary-green); color: white; border-radius: 4px; cursor: pointer;">Close</button>
    `;
    
    document.body.appendChild(alertElement);
    
    // Auto-remove after 30 seconds
    setTimeout(() => {
        if (alertElement.parentElement) {
            alertElement.remove();
        }
    }, 30000);
}

function showExportError(message) {
    // Remove progress indicator
    const progressElement = document.getElementById('exportProgress');
    if (progressElement) {
        progressElement.remove();
    }
    
    // Show error
    const alertElement = document.createElement('div');
    alertElement.className = 'alert alert-danger';
    alertElement.style.position = 'fixed';
    alertElement.style.top = '100px';
    alertElement.style.right = '20px';
    alertElement.style.zIndex = '10000';
    alertElement.innerHTML = `
        <strong>Export Failed!</strong><br>
        ${message}<br>
        <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; border: none; background: #dc3545; color: white; border-radius: 4px; cursor: pointer;">Close</button>
    `;
    
    document.body.appendChild(alertElement);
    
    setTimeout(() => {
        if (alertElement.parentElement) {
            alertElement.remove();
        }
    }, 10000);
}
        function importData() {
    // Create file input dialog
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    fileInput.style.display = 'none';
    
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            processImportFile(file);
        }
    });
    
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}

async function processImportFile(file) {
    try {
        showImportProgress('Reading file...');
        
        // Read file content
        const fileContent = await readFileAsText(file);
        let importData;
        
        try {
            importData = JSON.parse(fileContent);
        } catch (parseError) {
            throw new Error('Invalid JSON file format');
        }
        
        // Validate import file structure
        showImportProgress('Validating file structure...');
        const structureValidation = validateImportStructure(importData);
        
        if (!structureValidation.isValid) {
            throw new Error(`Invalid import file: ${structureValidation.errors.join(', ')}`);
        }
        
        // Analyze import data and conflicts
        showImportProgress('Analyzing data conflicts...');
        const analysisResult = analyzeImportData(importData);
        
        // Show import preview and conflict resolution dialog
        showImportPreview(importData, analysisResult);
        
    } catch (error) {
        console.error('Import processing failed:', error);
        showImportError(`Import failed: ${error.message}`);
    }
}

function readFileAsText(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = (e) => reject(new Error('Failed to read file'));
        reader.readAsText(file);
    });
}

function validateImportStructure(importData) {
    const validation = {
        isValid: true,
        errors: [],
        warnings: []
    };
    
    // Check basic structure
    if (!importData || typeof importData !== 'object') {
        validation.isValid = false;
        validation.errors.push('File does not contain valid JSON object');
        return validation;
    }
    
    // Check for required sections
    if (!importData.metadata) {
        validation.errors.push('Missing metadata section');
        validation.isValid = false;
    }
    
    if (!importData.data) {
        validation.errors.push('Missing data section');
        validation.isValid = false;
    }
    
    // Check metadata structure
    if (importData.metadata) {
        if (!importData.metadata.exportDate) {
            validation.warnings.push('Missing export date in metadata');
        }
        if (!importData.metadata.exportVersion) {
            validation.warnings.push('Missing export version in metadata');
        }
    }
    
    // Check data types
    if (importData.data) {
        const expectedDataTypes = ['news', 'fixtures', 'players', 'sponsors', 'gallery', 'shop'];
        const foundDataTypes = Object.keys(importData.data);
        
        expectedDataTypes.forEach(dataType => {
            if (dataType !== 'settings' && !foundDataTypes.includes(dataType)) {
                validation.warnings.push(`Missing data type: ${dataType}`);
            }
        });
    }
    
    return validation;
}

function analyzeImportData(importData) {
    const analysis = {
        summary: {
            totalRecords: 0,
            dataTypes: {},
            conflicts: 0,
            newRecords: 0,
            duplicates: 0
        },
        conflicts: [],
        recommendations: []
    };
    
    const dataTypes = ['news', 'fixtures', 'players', 'sponsors', 'gallery', 'shop'];
    
    dataTypes.forEach(dataType => {
        if (importData.data[dataType] && importData.data[dataType].records) {
            const importRecords = importData.data[dataType].records;
            const existingRecords = adminSystem.getData(dataType);
            
            analysis.summary.dataTypes[dataType] = {
                importCount: importRecords.length,
                existingCount: existingRecords.length,
                conflicts: 0,
                newRecords: 0
            };
            
            // Analyze each import record
            importRecords.forEach((importRecord, index) => {
                const conflict = findConflict(dataType, importRecord, existingRecords);
                
                if (conflict) {
                    analysis.conflicts.push({
                        dataType: dataType,
                        importIndex: index,
                        existingIndex: conflict.index,
                        importRecord: importRecord,
                        existingRecord: conflict.record,
                        conflictType: conflict.type
                    });
                    analysis.summary.conflicts++;
                    analysis.summary.dataTypes[dataType].conflicts++;
                } else {
                    analysis.summary.newRecords++;
                    analysis.summary.dataTypes[dataType].newRecords++;
                }
                
                analysis.summary.totalRecords++;
            });
        }
    });
    
    // Generate recommendations
    if (analysis.summary.conflicts > 0) {
        analysis.recommendations.push('Review conflicts before importing');
        analysis.recommendations.push('Consider backing up current data first');
    }
    
    if (analysis.summary.totalRecords === 0) {
        analysis.recommendations.push('No data found to import');
    }
    
    return analysis;
}

function findConflict(dataType, importRecord, existingRecords) {
    // Find conflicts based on unique identifiers for each data type
    for (let i = 0; i < existingRecords.length; i++) {
        const existing = existingRecords[i];
        let isConflict = false;
        let conflictType = 'duplicate';
        
        switch (dataType) {
            case 'news':
                if (existing.title === importRecord.title && existing.date === importRecord.date) {
                    isConflict = true;
                    conflictType = existing.content === importRecord.content ? 'exact_duplicate' : 'title_date_conflict';
                }
                break;
                
            case 'fixtures':
                if (existing.team === importRecord.team && 
                    existing.opponent === importRecord.opponent && 
                    existing.dateTime === importRecord.dateTime) {
                    isConflict = true;
                    conflictType = 'fixture_conflict';
                }
                break;
                
            case 'players':
                if (existing.name === importRecord.name && existing.team === importRecord.team) {
                    isConflict = true;
                    conflictType = existing.position === importRecord.position ? 'exact_duplicate' : 'name_team_conflict';
                }
                break;
                
            case 'sponsors':
                if (existing.name === importRecord.name) {
                    isConflict = true;
                    conflictType = existing.tier === importRecord.tier ? 'exact_duplicate' : 'sponsor_name_conflict';
                }
                break;
                
            case 'gallery':
                if (existing.title === importRecord.title && existing.date === importRecord.date) {
                    isConflict = true;
                    conflictType = 'gallery_conflict';
                }
                break;
                
            case 'shop':
                if (existing.name === importRecord.name) {
                    isConflict = true;
                    conflictType = existing.price === importRecord.price ? 'exact_duplicate' : 'product_name_conflict';
                }
                break;
        }
        
        if (isConflict) {
            return {
                index: i,
                record: existing,
                type: conflictType
            };
        }
    }
    
    return null;
}

function showImportPreview(importData, analysisResult) {
    // Remove any existing import dialogs
    const existingDialog = document.getElementById('importPreviewDialog');
    if (existingDialog) {
        existingDialog.remove();
    }
    
    // Create import preview dialog
    const dialog = document.createElement('div');
    dialog.id = 'importPreviewDialog';
    dialog.className = 'modal';
    dialog.style.display = 'block';
    
    const hasConflicts = analysisResult.summary.conflicts > 0;
    
    dialog.innerHTML = `
        <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>📥 Import Preview</h3>
                <button class="close" onclick="closeImportPreview()">&times;</button>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <h4>Import Summary</h4>
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <strong>File:</strong> ${importData.metadata.exportDate ? new Date(importData.metadata.exportDate).toLocaleString() : 'Unknown date'}<br>
                    <strong>Total Records:</strong> ${analysisResult.summary.totalRecords}<br>
                    <strong>New Records:</strong> ${analysisResult.summary.newRecords}<br>
                    <strong>Conflicts:</strong> <span style="color: ${hasConflicts ? '#dc3545' : '#28a745'}">${analysisResult.summary.conflicts}</span>
                </div>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <h4>Data Types</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    ${Object.entries(analysisResult.summary.dataTypes).map(([dataType, info]) => `
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                            <strong>${dataType.charAt(0).toUpperCase() + dataType.slice(1)}</strong><br>
                            <small>Import: ${info.importCount} | Existing: ${info.existingCount}</small><br>
                            <small style="color: ${info.conflicts > 0 ? '#dc3545' : '#28a745'}">
                                ${info.conflicts > 0 ? `${info.conflicts} conflicts` : 'No conflicts'}
                            </small>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${hasConflicts ? `
                <div style="margin-bottom: 2rem;">
                    <h4 style="color: #dc3545;">⚠️ Conflicts Found</h4>
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 1rem; border-radius: 8px;">
                        <p>The following conflicts were detected. Choose how to handle them:</p>
                        <div style="margin: 1rem 0;">
                            <label style="display: block; margin: 0.5rem 0;">
                                <input type="radio" name="conflictStrategy" value="skip" checked> Skip conflicting records (keep existing)
                            </label>
                            <label style="display: block; margin: 0.5rem 0;">
                                <input type="radio" name="conflictStrategy" value="overwrite"> Overwrite existing with imported data
                            </label>
                            <label style="display: block; margin: 0.5rem 0;">
                                <input type="radio" name="conflictStrategy" value="rename"> Create duplicates with modified names
                            </label>
                        </div>
                        <details style="margin-top: 1rem;">
                            <summary>View Conflict Details (${analysisResult.conflicts.length} conflicts)</summary>
                            <div style="max-height: 200px; overflow-y: auto; margin-top: 0.5rem;">
                                ${analysisResult.conflicts.map((conflict, index) => `
                                    <div style="border-bottom: 1px solid #ddd; padding: 0.5rem 0;">
                                        <strong>${conflict.dataType}</strong> - ${conflict.conflictType}<br>
                                        <small>Import: ${getConflictDescription(conflict.importRecord, conflict.dataType)}</small><br>
                                        <small>Existing: ${getConflictDescription(conflict.existingRecord, conflict.dataType)}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    </div>
                </div>
            ` : ''}
            
            <div style="margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="createBackup" checked>
                    Create backup before importing (recommended)
                </label>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeImportPreview()">Cancel</button>
                <button class="btn btn-primary" onclick="executeImport()">
                    ${hasConflicts ? 'Import with Conflict Resolution' : 'Import Data'}
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(dialog);
    
    // Store import data for execution
    window.pendingImportData = importData;
    window.pendingImportAnalysis = analysisResult;
}

function getConflictDescription(record, dataType) {
    switch (dataType) {
        case 'news':
            return `"${record.title}" (${record.author})`;
        case 'fixtures':
            return `${record.team} vs ${record.opponent}`;
        case 'players':
            return `${record.name} (${record.team})`;
        case 'sponsors':
            return `${record.name} (${record.tier})`;
        case 'gallery':
            return `"${record.title}" (${record.photos?.length || 0} photos)`;
        case 'shop':
            return `"${record.name}" (£${record.price})`;
        default:
            return 'Unknown';
    }
}

function closeImportPreview() {
    const dialog = document.getElementById('importPreviewDialog');
    if (dialog) {
        dialog.remove();
    }
    
    // Clean up pending import data
    delete window.pendingImportData;
    delete window.pendingImportAnalysis;
}

async function executeImport() {
    try {
        const importData = window.pendingImportData;
        const analysisResult = window.pendingImportAnalysis;
        
        if (!importData || !analysisResult) {
            throw new Error('Import data not found');
        }
        
        // Get user preferences
        const conflictStrategy = document.querySelector('input[name="conflictStrategy"]:checked')?.value || 'skip';
        const createBackup = document.getElementById('createBackup')?.checked || false;
        
        // Close preview dialog
        closeImportPreview();
        
        // Create backup if requested
        if (createBackup) {
            showImportProgress('Creating backup...');
            await createImportBackup();
        }
        
        // Execute import
        showImportProgress('Importing data...');
        const importResult = await performImport(importData, analysisResult, conflictStrategy);
        
        // Show completion message
        showImportComplete(importResult);
        
        // Refresh all data displays
        adminSystem.loadAllData();
        adminSystem.updateStats();
        
    } catch (error) {
        console.error('Import execution failed:', error);
        showImportError(`Import failed: ${error.message}`);
    }
}

async function createImportBackup() {
    // Create a backup export before importing
    const backupData = await createBackupData();
    const filename = `olrfc_backup_before_import_${Date.now()}.json`;
    const dataStr = JSON.stringify(backupData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const downloadLink = document.createElement('a');
    downloadLink.href = URL.createObjectURL(dataBlob);
    downloadLink.download = filename;
    downloadLink.style.display = 'none';
    
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
}

async function createBackupData() {
    // Simplified backup creation (reuse export logic)
    const dataTypes = ['news', 'fixtures', 'players', 'sponsors', 'gallery', 'shop'];
    const backupData = {
        metadata: {
            backupDate: new Date().toISOString(),
            backupType: 'pre-import',
            backupVersion: '1.0'
        },
        data: {}
    };
    
    dataTypes.forEach(dataType => {
        backupData.data[dataType] = {
            records: adminSystem.getData(dataType),
            count: adminSystem.getData(dataType).length
        };
    });
    
    return backupData;
}

async function performImport(importData, analysisResult, conflictStrategy) {
    const importResult = {
        imported: 0,
        skipped: 0,
        overwritten: 0,
        renamed: 0,
        errors: []
    };
    
    const dataTypes = ['news', 'fixtures', 'players', 'sponsors', 'gallery', 'shop'];
    
    dataTypes.forEach(dataType => {
        if (importData.data[dataType] && importData.data[dataType].records) {
            const importRecords = importData.data[dataType].records;
            const existingRecords = adminSystem.getData(dataType);
            const conflicts = analysisResult.conflicts.filter(c => c.dataType === dataType);
            
            importRecords.forEach((importRecord, index) => {
                const conflict = conflicts.find(c => c.importIndex === index);
                
                if (conflict) {
                    // Handle conflict based on strategy
                    switch (conflictStrategy) {
                        case 'skip':
                            importResult.skipped++;
                            break;
                            
                        case 'overwrite':
                            existingRecords[conflict.existingIndex] = importRecord;
                            importResult.overwritten++;
                            break;
                            
                        case 'rename':
                            const renamedRecord = createRenamedRecord(importRecord, dataType);
                            existingRecords.push(renamedRecord);
                            importResult.renamed++;
                            break;
                    }
                } else {
                    // No conflict, add new record
                    existingRecords.push(importRecord);
                    importResult.imported++;
                }
            });
            
            // Save updated data
            adminSystem.saveData(dataType, existingRecords);
        }
    });
    
    return importResult;
}

function createRenamedRecord(record, dataType) {
    const renamedRecord = { ...record };
    const timestamp = new Date().toLocaleTimeString();
    
    switch (dataType) {
        case 'news':
            renamedRecord.title += ` (Imported ${timestamp})`;
            break;
        case 'players':
            renamedRecord.name += ` (Imported)`;
            break;
        case 'sponsors':
            renamedRecord.name += ` (Imported)`;
            break;
        case 'gallery':
            renamedRecord.title += ` (Imported ${timestamp})`;
            break;
        case 'shop':
            renamedRecord.name += ` (Imported)`;
            break;
        case 'fixtures':
            renamedRecord.opponent += ` (Imported)`;
            break;
    }
    
    return renamedRecord;
}

// Progress and completion UI functions
function showImportProgress(message) {
    let alertElement = document.getElementById('importProgress');
    if (!alertElement) {
        alertElement = document.createElement('div');
        alertElement.id = 'importProgress';
        alertElement.className = 'alert alert-info';
        alertElement.style.position = 'fixed';
        alertElement.style.top = '100px';
        alertElement.style.right = '20px';
        alertElement.style.zIndex = '10000';
        alertElement.style.minWidth = '300px';
        document.body.appendChild(alertElement);
    }
    
    alertElement.innerHTML = `
        <strong>Importing Data...</strong><br>
        ${message}
        <div style="margin-top: 10px;">
            <div style="background: #ddd; height: 6px; border-radius: 3px;">
                <div style="background: var(--primary-green); height: 100%; width: 70%; border-radius: 3px; animation: pulse 1s infinite;"></div>
            </div>
        </div>
    `;
}

function showImportComplete(result) {
    const progressElement = document.getElementById('importProgress');
    if (progressElement) {
        progressElement.remove();
    }
    
    const alertElement = document.createElement('div');
    alertElement.className = 'alert alert-success';
    alertElement.style.position = 'fixed';
    alertElement.style.top = '100px';
    alertElement.style.right = '20px';
    alertElement.style.zIndex = '10000';
    alertElement.style.minWidth = '350px';
    
    alertElement.innerHTML = `
        <strong>Import Complete!</strong><br>
        <div style="margin-top: 10px;">
            <strong>Results:</strong><br>
            • Imported: ${result.imported} new records<br>
            • Skipped: ${result.skipped} conflicts<br>
            • Overwritten: ${result.overwritten} records<br>
            • Renamed: ${result.renamed} duplicates<br>
            ${result.errors.length > 0 ? `• Errors: ${result.errors.length}<br>` : ''}
        </div>
        <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; border: none; background: var(--primary-green); color: white; border-radius: 4px; cursor: pointer;">Close</button>
    `;
    
    document.body.appendChild(alertElement);
    
    setTimeout(() => {
        if (alertElement.parentElement) {
            alertElement.remove();
        }
    }, 15000);
}

function showImportError(message) {
    const progressElement = document.getElementById('importProgress');
    if (progressElement) {
        progressElement.remove();
    }
    
    const alertElement = document.createElement('div');
    alertElement.className = 'alert alert-danger';
    alertElement.style.position = 'fixed';
    alertElement.style.top = '100px';
    alertElement.style.right = '20px';
    alertElement.style.zIndex = '10000';
    alertElement.innerHTML = `
        <strong>Import Failed!</strong><br>
        ${message}<br>
        <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; border: none; background: #dc3545; color: white; border-radius: 4px; cursor: pointer;">Close</button>
    `;
    
    document.body.appendChild(alertElement);
    
    setTimeout(() => {
        if (alertElement.parentElement) {
            alertElement.remove();
        }
    }, 10000);
}

function showCSVImportPreview(parsedData, dataType, validationResult) {
    // Remove progress indicator
    const progressElement = document.getElementById('importProgress');
    if (progressElement) {
        progressElement.remove();
    }
    
    // Create preview modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.id = 'csvImportPreview';
    
    const errorList = validationResult.errors.map(err => 
        `<li>Row ${err.row || 'Unknown'}: ${err.message || err.error || 'Validation error'}</li>`
    ).join('');
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>⚠️ CSV Import Validation Issues</h3>
                <button class="close" onclick="document.getElementById('csvImportPreview').remove()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem;">
                <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <strong>⚠️ Validation Found ${validationResult.errors.length} Issue(s)</strong>
                    <p style="margin: 0.5rem 0 0 0;">Some rows in your CSV have validation errors. You can choose to:</p>
                    <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem;">
                        <li>Import only valid rows (skip errors)</li>
                        <li>Fix the CSV and try again</li>
                    </ul>
                </div>
                
                <div>
                    <h4>Validation Errors:</h4>
                    <ul style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 4px;">
                        ${errorList}
                    </ul>
                </div>
                
                <div style="background: #e3f2fd; border: 1px solid #1976d2; padding: 1rem; border-radius: 8px; margin-top: 1.5rem;">
                    <strong>📊 Import Summary:</strong>
                    <p style="margin: 0.5rem 0 0 0;">
                        Total Rows: ${parsedData.rows.length}<br>
                        Valid Rows: ${validationResult.valid || 0}<br>
                        Invalid Rows: ${validationResult.errors.length}
                    </p>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end; padding: 1rem 1.5rem; border-top: 1px solid #dee2e6;">
                <button class="btn btn-secondary" onclick="document.getElementById('csvImportPreview').remove()">Cancel</button>
                <button class="btn btn-primary" onclick="proceedWithPartialImport('${dataType}', ${JSON.stringify(parsedData.rows).replace(/'/g, "\\'")})" ${validationResult.valid === 0 ? 'disabled' : ''}>
                    Import Valid Rows Only (${validationResult.valid || 0})
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

async function proceedWithPartialImport(dataType, rows) {
    try {
        // Close preview modal
        const modal = document.getElementById('csvImportPreview');
        if (modal) modal.remove();
        
        // Filter to valid rows only
        const validRows = rows.filter(row => {
            const validation = validateRecord(dataType, row, 0);
            return validation.isValid;
        });
        
        if (validRows.length === 0) {
            showImportError('No valid rows to import');
            return;
        }
        
        // Proceed with import
        await executeCSVImport(validRows, dataType);
        
    } catch (error) {
        console.error('Partial import failed:', error);
        showImportError(`Import failed: ${error.message}`);
    }
}

        function clearAllData() {
    // Show confirmation dialog with detailed warning
    const confirmDialog = document.createElement('div');
    confirmDialog.className = 'modal';
    confirmDialog.style.display = 'block';
    
    confirmDialog.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="color: #dc3545;">⚠️ Clear All Data</h3>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <p><strong>This will permanently delete ALL data from localStorage:</strong></p>
                <ul style="margin: 1rem 0; padding-left: 2rem;">
                    <li>News articles (${adminSystem.getData('news').length} items)</li>
                    <li>Fixtures (${adminSystem.getData('fixtures').length} items)</li>
                    <li>Players (${adminSystem.getData('players').length} items)</li>
                    <li>Sponsors (${adminSystem.getData('sponsors').length} items)</li>
                    <li>Gallery albums (${adminSystem.getData('gallery').length} items)</li>
                    <li>Shop products (${adminSystem.getData('shop').length} items)</li>
                    <li>Admin settings and preferences</li>
                </ul>
                
                <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
                    <strong>Warning:</strong> This action cannot be undone. Cloud data will remain unaffected.
                </div>
                
                <p>Type <strong>"DELETE ALL DATA"</strong> to confirm:</p>
                <input type="text" id="deleteConfirmation" placeholder="Type confirmation text here" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0;">
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="cancelClearData()">Cancel</button>
                <button class="btn btn-danger" onclick="executeClearData()" id="confirmDeleteBtn" disabled>Clear All Data</button>
            </div>
        </div>
    `;
    
    confirmDialog.id = 'clearDataDialog';
    document.body.appendChild(confirmDialog);
    
    // Enable delete button only when correct text is typed
    document.getElementById('deleteConfirmation').addEventListener('input', function(e) {
        const deleteBtn = document.getElementById('confirmDeleteBtn');
        if (e.target.value === 'DELETE ALL DATA') {
            deleteBtn.disabled = false;
            deleteBtn.style.backgroundColor = '#dc3545';
        } else {
            deleteBtn.disabled = true;
            deleteBtn.style.backgroundColor = '#6c757d';
        }
    });
}

function cancelClearData() {
    const dialog = document.getElementById('clearDataDialog');
    if (dialog) {
        dialog.remove();
    }
}

function executeClearData() {
    try {
        // Close confirmation dialog
        cancelClearData();
        
        // Show progress
        showClearProgress('Clearing all data...');
        
        // Clear all data types
        const dataTypes = ['news', 'fixtures', 'players', 'sponsors', 'gallery', 'shop'];
        dataTypes.forEach(dataType => {
            localStorage.removeItem(`olrfc_${dataType}`);
            localStorage.removeItem(`olrfc_${dataType}_meta`);
        });
        
        // Clear admin settings
        localStorage.removeItem('olrfc_admin_features');
        localStorage.removeItem('olrfc_export_count');
        localStorage.removeItem('olrfc_pending_sync');
        
        // Reset admin system data
        adminSystem.initializeData();
        adminSystem.loadAllData();
        adminSystem.updateStats();
        
        // Show completion
        showClearComplete();
        
    } catch (error) {
        console.error('Clear data failed:', error);
        showClearError(`Failed to clear data: ${error.message}`);
    }
}
function exportToCSV() {
    // Show CSV export options dialog
    showCSVExportDialog();
}

function showCSVExportDialog() {
    const existingDialog = document.getElementById('csvExportDialog');
    if (existingDialog) {
        existingDialog.remove();
    }
    
    // Analyze available data for CSV export
    const dataTypes = ['news', 'fixtures', 'players', 'sponsors', 'gallery', 'shop'];
    const dataAnalysis = {};
    
    dataTypes.forEach(dataType => {
        const data = adminSystem.getData(dataType);
        dataAnalysis[dataType] = {
            count: data.length,
            hasData: data.length > 0
        };
    });
    
    const dialog = document.createElement('div');
    dialog.id = 'csvExportDialog';
    dialog.className = 'modal';
    dialog.style.display = 'block';
    
    dialog.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>📊 Export to CSV/Excel</h3>
                <button class="close" onclick="closeCSVExportDialog()">&times;</button>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <p>Export your data as CSV files for bulk editing in Excel or Google Sheets.</p>
                
                <div style="margin: 1rem 0;">
                    <h4>Export Options</h4>
                    <label style="display: block; margin: 0.5rem 0;">
                        <input type="radio" name="csvExportType" value="individual" checked>
                        Individual CSV files for each data type
                    </label>
                    <label style="display: block; margin: 0.5rem 0;">
                        <input type="radio" name="csvExportType" value="combined">
                        Single combined Excel-compatible file (.csv)
                    </label>
                </div>
                
                <div style="margin: 1rem 0;">
                    <h4>Data Types to Export</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                        ${dataTypes.map(dataType => `
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="export_${dataType}" ${dataAnalysis[dataType].hasData ? 'checked' : ''} ${!dataAnalysis[dataType].hasData ? 'disabled' : ''}>
                                ${dataType.charAt(0).toUpperCase() + dataType.slice(1)} (${dataAnalysis[dataType].count} records)
                            </label>
                        `).join('')}
                    </div>
                </div>
                
                <div style="background: #e3f2fd; border: 1px solid #1976d2; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <h4>CSV Import Notes</h4>
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem; font-size: 0.9rem;">
                        <li>CSV files can be opened and edited in Excel, Google Sheets, or any spreadsheet application</li>
                        <li>Do not change column headers - they are required for re-import</li>
                        <li>Keep the 'id' column unchanged to preserve existing records</li>
                        <li>Remove the 'id' value to create new records when importing</li>
                        <li>Date formats should be: YYYY-MM-DD</li>
                        <li>DateTime formats should be: YYYY-MM-DDTHH:MM</li>
                    </ul>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeCSVExportDialog()">Cancel</button>
                <button class="btn btn-primary" onclick="executeCSVExport()">Export CSV</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(dialog);
}

function closeCSVExportDialog() {
    const dialog = document.getElementById('csvExportDialog');
    if (dialog) {
        dialog.remove();
    }
}

function executeCSVExport() {
    try {
        const exportType = document.querySelector('input[name="csvExportType"]:checked')?.value || 'individual';
        
        // Get selected data types
        const selectedDataTypes = [];
        const dataTypes = ['news', 'fixtures', 'players', 'sponsors', 'gallery', 'shop'];
        
        dataTypes.forEach(dataType => {
            const checkbox = document.getElementById(`export_${dataType}`);
            if (checkbox && checkbox.checked) {
                selectedDataTypes.push(dataType);
            }
        });
        
        if (selectedDataTypes.length === 0) {
            alert('Please select at least one data type to export');
            return;
        }
        
        closeCSVExportDialog();
        
        if (exportType === 'individual') {
            exportIndividualCSVFiles(selectedDataTypes);
        } else {
            exportCombinedCSVFile(selectedDataTypes);
        }
        
    } catch (error) {
        console.error('CSV Export failed:', error);
        alert(`CSV Export failed: ${error.message}`);
    }
}

function exportIndividualCSVFiles(dataTypes) {
    dataTypes.forEach(dataType => {
        const data = adminSystem.getData(dataType);
        if (data.length > 0) {
            const csv = convertToCSV(data, dataType);
            const filename = `olrfc_${dataType}_${new Date().toISOString().split('T')[0]}.csv`;
            downloadCSV(csv, filename);
        }
    });
    
    showCSVExportComplete(`Exported ${dataTypes.length} CSV files`);
}

function exportCombinedCSVFile(dataTypes) {
    let combinedCSV = '';
    let totalRecords = 0;
    
    dataTypes.forEach((dataType, index) => {
        const data = adminSystem.getData(dataType);
        if (data.length > 0) {
            if (index > 0) {
                combinedCSV += '\n\n';
            }
            
            // Add section header
            combinedCSV += `"=== ${dataType.toUpperCase()} DATA ==="\n`;
            combinedCSV += convertToCSV(data, dataType);
            totalRecords += data.length;
        }
    });
    
    const filename = `olrfc_combined_export_${new Date().toISOString().split('T')[0]}.csv`;
    downloadCSV(combinedCSV, filename);
    
    showCSVExportComplete(`Exported ${totalRecords} records in combined file`);
}

function convertToCSV(data, dataType) {
    if (!data || data.length === 0) {
        return '';
    }
    
    // Define column mappings for each data type
    const columnMappings = {
        news: ['id', 'title', 'content', 'category', 'author', 'date', 'featured'],
        fixtures: ['id', 'team', 'opponent', 'dateTime', 'venue', 'competition', 'ourScore', 'theirScore'],
        players: ['id', 'name', 'team', 'position', 'appearances', 'photo'],
        sponsors: ['name', 'logo', 'website', 'active'],
        gallery: ['id', 'title', 'category', 'description', 'date', 'photos'],
        shop: ['id', 'name', 'category', 'price', 'stock', 'description', 'sku', 'sizes', 'status']
    };
    
    const columns = columnMappings[dataType] || Object.keys(data[0] || {});
    
    // Create CSV header
    let csv = columns.map(col => `"${col}"`).join(',') + '\n';
    
    // Add data rows
    data.forEach(record => {
        const row = columns.map(column => {
            let value = record[column] || '';
            
            // Handle special data types
            if (Array.isArray(value)) {
                value = JSON.stringify(value);
            } else if (typeof value === 'object' && value !== null) {
                value = JSON.stringify(value);
            } else if (typeof value === 'boolean') {
                value = value ? 'TRUE' : 'FALSE';
            } else {
                value = String(value);
            }
            
            // Escape quotes and wrap in quotes
            value = value.replace(/"/g, '""');
            return `"${value}"`;
        });
        
        csv += row.join(',') + '\n';
    });
    
    return csv;
}

function downloadCSV(csvContent, filename) {
    // Add BOM for Excel compatibility
    const BOM = '\uFEFF';
    const csvWithBOM = BOM + csvContent;
    
    const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function showCSVExportComplete(message) {
    const alertElement = document.createElement('div');
    alertElement.className = 'alert alert-success';
    alertElement.style.position = 'fixed';
    alertElement.style.top = '100px';
    alertElement.style.right = '20px';
    alertElement.style.zIndex = '10000';
    alertElement.style.minWidth = '350px';
    
    alertElement.innerHTML = `
        <strong>CSV Export Complete!</strong><br>
        ${message}<br>
        <small>Files are ready for editing in Excel or Google Sheets</small><br>
        <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; border: none; background: var(--primary-green); color: white; border-radius: 4px; cursor: pointer;">Close</button>
    `;
    
    document.body.appendChild(alertElement);
    
    setTimeout(() => {
        if (alertElement.parentElement) {
            alertElement.remove();
        }
    }, 10000);
}

// CSV Import functionality (to handle edited CSV files)
function importFromCSV() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.csv';
    fileInput.style.display = 'none';
    
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            processCSVImport(file);
        }
    });
    
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}

async function processCSVImport(file) {
    try {
        showImportProgress('Reading CSV file...');
        
        const csvContent = await readFileAsText(file);
        const parsedData = parseCSV(csvContent);
        const dataType = detectDataType(parsedData.headers);
        
        if (!dataType) {
            throw new Error('Could not detect data type from CSV headers. Please ensure you are importing a valid exported CSV file.');
        }
        
        showImportProgress('Validating CSV data...');
        const validationResult = validateCSVData(parsedData.rows, dataType);
        
        if (validationResult.errors.length > 0) {
            showCSVImportPreview(parsedData, dataType, validationResult);
        } else {
            await executeCSVImport(parsedData.rows, dataType);
        }
        
    } catch (error) {
        console.error('CSV Import failed:', error);
        showImportError(`CSV Import failed: ${error.message}`);
    }
}

function parseCSV(csvContent) {
    const lines = csvContent.split('\n').filter(line => line.trim());
    if (lines.length === 0) {
        throw new Error('CSV file is empty');
    }
    
    // Parse header
    const headerLine = lines[0];
    const headers = parseCSVLine(headerLine);
    
    // Parse data rows
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line && !line.startsWith('"===')) { // Skip section headers in combined files
            const values = parseCSVLine(line);
            if (values.length === headers.length) {
                const record = {};
                headers.forEach((header, index) => {
                    let value = values[index];
                    
                    // Convert string values back to appropriate types
                    if (value === 'TRUE') value = true;
                    else if (value === 'FALSE') value = false;
                    else if (value && value.startsWith('[') || value.startsWith('{')) {
                        try {
                            value = JSON.parse(value);
                        } catch (e) {
                            // Keep as string if JSON parsing fails
                        }
                    }
                    
                    record[header] = value;
                });
                rows.push(record);
            }
        }
    }
    
    return { headers, rows };
}

function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    let i = 0;
    
    while (i < line.length) {
        const char = line[i];
        
        if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
                // Escaped quote
                current += '"';
                i += 2;
            } else {
                // Toggle quote state
                inQuotes = !inQuotes;
                i++;
            }
        } else if (char === ',' && !inQuotes) {
            // Field separator
            result.push(current);
            current = '';
            i++;
        } else {
            current += char;
            i++;
        }
    }
    
    result.push(current); // Add last field
    return result;
}

function detectDataType(headers) {
    const dataTypeSignatures = {
        news: ['title', 'content', 'category', 'author'],
        fixtures: ['team', 'opponent', 'dateTime', 'venue'],
        players: ['name', 'team', 'position'],
        sponsors: ['name', 'logo', 'website'],
        gallery: ['title', 'photos'],
        shop: ['name', 'price', 'category']
    };
    
    for (const [dataType, signature] of Object.entries(dataTypeSignatures)) {
        const matchCount = signature.filter(field => headers.includes(field)).length;
        if (matchCount >= signature.length - 1) { // Allow for one missing field
            return dataType;
        }
    }
    
    return null;
}

function validateCSVData(rows, dataType) {
    const validation = {
        valid: 0,
        invalid: 0,
        errors: [],
        warnings: []
    };
    
    rows.forEach((record, index) => {
        const recordValidation = validateRecord(dataType, record, index);
        if (recordValidation.isValid) {
            validation.valid++;
        } else {
            validation.invalid++;
            validation.errors.push(...recordValidation.errors);
        }
        validation.warnings.push(...recordValidation.warnings);
    });
    
    return validation;
}

async function executeCSVImport(rows, dataType) {
    showImportProgress(`Importing ${rows.length} ${dataType} records...`);
    
    const existingData = adminSystem.getData(dataType);
    let newRecords = 0;
    let updatedRecords = 0;
    
    rows.forEach(record => {
        if (record.id && record.id !== '') {
            // Update existing record
            const existingIndex = existingData.findIndex(existing => existing.id == record.id);
            if (existingIndex >= 0) {
                existingData[existingIndex] = record;
                updatedRecords++;
            } else {
                existingData.push(record);
                newRecords++;
            }
        } else {
            // Create new record with new ID
            record.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
            existingData.push(record);
            newRecords++;
        }
    });
    
    // Save updated data
    adminSystem.saveData(dataType, existingData);
    adminSystem.loadAllData();
    adminSystem.updateStats();
    
    showCSVImportComplete(dataType, newRecords, updatedRecords);
}

function showCSVImportComplete(dataType, newRecords, updatedRecords) {
    const progressElement = document.getElementById('importProgress');
    if (progressElement) {
        progressElement.remove();
    }
    
    const alertElement = document.createElement('div');
    alertElement.className = 'alert alert-success';
    alertElement.style.position = 'fixed';
    alertElement.style.top = '100px';
    alertElement.style.right = '20px';
    alertElement.style.zIndex = '10000';
    
    alertElement.innerHTML = `
        <strong>CSV Import Complete!</strong><br>
        Data Type: ${dataType}<br>
        New Records: ${newRecords}<br>
        Updated Records: ${updatedRecords}<br>
        <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; border: none; background: var(--primary-green); color: white; border-radius: 4px; cursor: pointer;">Close</button>
    `;
    
    document.body.appendChild(alertElement);
    
    setTimeout(() => {
        if (alertElement.parentElement) {
            alertElement.remove();
        }
    }, 15000);
}

function showClearProgress(message) {
    const alertElement = document.createElement('div');
    alertElement.id = 'clearProgress';
    alertElement.className = 'alert alert-warning';
    alertElement.style.position = 'fixed';
    alertElement.style.top = '100px';
    alertElement.style.right = '20px';
    alertElement.style.zIndex = '10000';
    alertElement.innerHTML = `<strong>Clearing Data...</strong><br>${message}`;
    document.body.appendChild(alertElement);
}

function showClearComplete() {
    const progressElement = document.getElementById('clearProgress');
    if (progressElement) {
        progressElement.remove();
    }
    
    const alertElement = document.createElement('div');
    alertElement.className = 'alert alert-success';
    alertElement.style.position = 'fixed';
    alertElement.style.top = '100px';
    alertElement.style.right = '20px';
    alertElement.style.zIndex = '10000';
    alertElement.innerHTML = `
        <strong>Data Cleared Successfully!</strong><br>
        All localStorage data has been removed.<br>
        <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; border: none; background: var(--primary-green); color: white; border-radius: 4px; cursor: pointer;">Close</button>
    `;
    document.body.appendChild(alertElement);
    
    setTimeout(() => {
        if (alertElement.parentElement) {
            alertElement.remove();
        }
    }, 10000);
}

function showClearError(message) {
    const progressElement = document.getElementById('clearProgress');
    if (progressElement) {
        progressElement.remove();
    }
    
    const alertElement = document.createElement('div');
    alertElement.className = 'alert alert-danger';
    alertElement.style.position = 'fixed';
    alertElement.style.top = '100px';
    alertElement.style.right = '20px';
    alertElement.style.zIndex = '10000';
    alertElement.innerHTML = `
        <strong>Clear Failed!</strong><br>
        ${message}<br>
        <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; border: none; background: #dc3545; color: white; border-radius: 4px; cursor: pointer;">Close</button>
    `;
    document.body.appendChild(alertElement);
}
       //  setTimeout(initializeSampleData, 500);

// ================================================
// CONTACTS MANAGEMENT JAVASCRIPT
// INSERT THIS IN THE <script> SECTION AT THE END OF admin-dashboard.html
// ================================================

// ============================================
// CONTACTS MANAGEMENT FUNCTIONS
// ============================================

let currentContactId = null;

// Load and display contacts
function loadContacts() {
    const contacts = contactsManager.getAllContacts();
    const contactsList = document.getElementById('contactsList');
    
    if (!contactsList) return; // Not on contacts page
    
    if (contacts.length === 0) {
        contactsList.innerHTML = '<p class="empty-state">No contacts found. Add your first contact!</p>';
        return;
    }
    
    // Group contacts by category
    const categories = contactsManager.getCategories();
    
    let html = '';
    
    categories.forEach(category => {
        const categoryContacts = contactsManager.getContactsByCategory(category.name);
        
        if (categoryContacts.length > 0) {
            html += `
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--primary-green); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span>${category.emoji}</span>
                        <span>${category.name}</span>
                        <span style="background: var(--bg-light); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.9rem;">${categoryContacts.length}</span>
                    </h3>
                    <div style="display: grid; gap: 1rem;">
            `;
            
            categoryContacts.forEach(contact => {
                html += createContactItem(contact);
            });
            
            html += '</div></div>';
        }
    });
    
    contactsList.innerHTML = html;
    updateContactsStats();
    populateCategoryFilter();
}

// Create contact item HTML
function createContactItem(contact) {
    const initials = contact.name
        .split(' ')
        .map(n => n[0])
        .join('')
        .toUpperCase()
        .substring(0, 2);
    
    const photoHTML = contact.photo 
        ? `<img src="${contact.photo}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-green);">`
        : `<div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon)); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem;">${initials}</div>`;
    
    return `
        <div class="content-item" style="background: white; padding: 1rem; border-radius: 10px; box-shadow: var(--shadow);">
            <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                ${photoHTML}
                <div style="flex: 1;">
                    <strong style="font-size: 1.1rem;">${contact.name}</strong>
                    <p style="color: var(--primary-green); margin: 0.25rem 0;">${contact.role}</p>
                    <div style="display: flex; gap: 1rem; font-size: 0.9rem; color: var(--text-light); flex-wrap: wrap;">
                        ${contact.email ? `<span>📧 ${contact.email}</span>` : ''}
                        ${contact.phone ? `<span>📞 ${contact.phone}</span>` : ''}
                        ${!contact.email && !contact.phone ? '<span style="font-style: italic;">Contact via club</span>' : ''}
                    </div>
                </div>
            </div>
            <div class="content-actions">
                <button class="btn-edit" onclick="editContact('${contact.id}')">✏️ Edit</button>
                <button class="btn-delete" onclick="deleteContact('${contact.id}', '${contact.name}')">🗑️ Delete</button>
            </div>
        </div>
    `;
}

// Update contacts statistics
function updateContactsStats() {
    const stats = contactsManager.getStats();
    
    const elements = {
        contactsTotal: stats.totalContacts,
        contactsWithPhotos: stats.contactsWithPhotos,
        contactsWithEmail: stats.contactsWithEmail,
        contactsCategories: stats.totalCategories
    };
    
    Object.keys(elements).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = elements[id];
    });
}

// Populate category filter dropdown
function populateCategoryFilter() {
    const select = document.getElementById('contactCategoryFilter');
    if (!select) return;
    
    const categories = contactsManager.getCategories();
    
    // Keep "All Categories" option
    select.innerHTML = '<option value="">All Categories</option>';
    
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.name;
        option.textContent = `${category.emoji} ${category.name}`;
        select.appendChild(option);
    });
}

// Filter contacts by category
function filterContactsByCategory() {
    const selectedCategory = document.getElementById('contactCategoryFilter').value;
    
    if (!selectedCategory) {
        loadContacts();
        return;
    }
    
    const contacts = contactsManager.getContactsByCategory(selectedCategory);
    const contactsList = document.getElementById('contactsList');
    
    if (contacts.length === 0) {
        contactsList.innerHTML = '<p class="empty-state">No contacts in this category.</p>';
        return;
    }
    
    let html = '<div style="display: grid; gap: 1rem;">';
    contacts.forEach(contact => {
        html += createContactItem(contact);
    });
    html += '</div>';
    
    contactsList.innerHTML = html;
}

// Open contact modal (add or edit)
function openContactModal(contactId = null) {
    currentContactId = contactId;
    const modal = document.getElementById('contactModal');
    const title = document.getElementById('contactModalTitle');
    const form = document.getElementById('contactForm');
    
    form.reset();
    document.getElementById('customCategoryGroup').style.display = 'none';
    resetPhotoPreview();
    
    if (contactId) {
        // Edit mode
        title.textContent = 'Edit Contact';
        const contact = contactsManager.getContact(contactId);
        
        if (contact) {
            document.getElementById('contactId').value = contact.id;
            document.getElementById('contactName').value = contact.name;
            document.getElementById('contactRole').value = contact.role;
            document.getElementById('contactCategory').value = contact.category;
            document.getElementById('contactEmail').value = contact.email || '';
            document.getElementById('contactPhone').value = contact.phone || '';
            document.getElementById('contactBio').value = contact.bio || '';
            document.getElementById('contactDisplayOrder').value = contact.displayOrder || 999;
            
            if (contact.photo) {
                document.getElementById('contactPhotoURL').value = contact.photo;
                document.getElementById('contactPhotoImg').src = contact.photo;
                document.getElementById('contactPhotoImg').style.display = 'block';
                document.getElementById('contactInitials').style.display = 'none';
                document.getElementById('removePhotoBtn').style.display = 'inline-block';
            }
        }
    } else {
        // Add mode
        title.textContent = 'Add New Contact';
        document.getElementById('contactId').value = '';
    }
    
    modal.style.display = 'block';
}

// Close contact modal
function closeContactModal() {
    document.getElementById('contactModal').style.display = 'none';
    currentContactId = null;
}

// Handle contact photo upload
async function handleContactPhotoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
    }
    
    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('Image must be less than 5MB');
        return;
    }
    
    // Show progress
    const progressDiv = document.getElementById('photoUploadProgress');
    const progressBar = document.getElementById('photoProgressBar');
    progressDiv.style.display = 'block';
    progressBar.style.width = '30%';
    
    try {
        // Upload to Cloudinary
        const photoURL = await cloudinaryUpload.uploadImage(file, 'contacts');
        
        progressBar.style.width = '100%';
        
        // Update preview
        document.getElementById('contactPhotoURL').value = photoURL;
        document.getElementById('contactPhotoImg').src = photoURL;
        document.getElementById('contactPhotoImg').style.display = 'block';
        document.getElementById('contactInitials').style.display = 'none';
        document.getElementById('removePhotoBtn').style.display = 'inline-block';
        
        setTimeout(() => {
            progressDiv.style.display = 'none';
            progressBar.style.width = '0%';
        }, 1000);
        
    } catch (error) {
        console.error('Photo upload failed:', error);
        alert('Failed to upload photo. Please try again.');
        progressDiv.style.display = 'none';
        progressBar.style.width = '0%';
    }
}

// Remove contact photo
function removeContactPhoto() {
    document.getElementById('contactPhotoURL').value = '';
    document.getElementById('contactPhotoImg').style.display = 'none';
    document.getElementById('contactInitials').style.display = 'block';
    document.getElementById('contactInitials').textContent = '?';
    document.getElementById('removePhotoBtn').style.display = 'none';
}

// Reset photo preview
function resetPhotoPreview() {
    document.getElementById('contactPhotoURL').value = '';
    document.getElementById('contactPhotoImg').style.display = 'none';
    document.getElementById('contactPhotoImg').src = '';
    document.getElementById('contactInitials').style.display = 'block';
    document.getElementById('contactInitials').textContent = '?';
    document.getElementById('removePhotoBtn').style.display = 'none';
}

// Update preview initials when name changes
document.addEventListener('DOMContentLoaded', function() {
    const nameInput = document.getElementById('contactName');
    if (nameInput) {
        nameInput.addEventListener('input', function() {
            const initials = this.value
                .split(' ')
                .map(n => n[0])
                .join('')
                .toUpperCase()
                .substring(0, 2);
            
            const initialsSpan = document.getElementById('contactInitials');
            if (initialsSpan && initialsSpan.style.display !== 'none') {
                initialsSpan.textContent = initials || '?';
            }
        });
    }
});

// Handle custom category
function updateCategoryColor() {
    const select = document.getElementById('contactCategory');
    const customGroup = document.getElementById('customCategoryGroup');
    
    if (select.value === 'custom') {
        customGroup.style.display = 'block';
    } else {
        customGroup.style.display = 'none';
    }
}

// Save contact (add or update)
async function saveContact(event) {
    event.preventDefault();
    
    // Get form values
    let category = document.getElementById('contactCategory').value;
    
    // Handle custom category
    if (category === 'custom') {
        const customCategory = document.getElementById('customCategory').value.trim();
        if (!customCategory) {
            alert('Please enter a category name');
            return;
        }
        category = customCategory;
    }
    
    const contactData = {
        name: document.getElementById('contactName').value.trim(),
        role: document.getElementById('contactRole').value.trim(),
        category: category,
        email: document.getElementById('contactEmail').value.trim(),
        phone: document.getElementById('contactPhone').value.trim(),
        photo: document.getElementById('contactPhotoURL').value,
        bio: document.getElementById('contactBio').value.trim(),
        displayOrder: parseInt(document.getElementById('contactDisplayOrder').value) || 999
    };
    
    // Validate email if provided
    if (contactData.email && !isValidEmail(contactData.email)) {
        alert('Please enter a valid email address');
        return;
    }
    
    // Show loading spinner
    const contactId = document.getElementById('contactId').value;
    showLoading(contactId ? 'Updating contact...' : 'Adding contact...');
    
    try {
        if (contactId) {
            // Update existing contact
            await contactsManager.updateContact(contactId, contactData);
            showLoadingSuccess('Contact updated successfully!');
        } else {
            // Add new contact
            await contactsManager.addContact(contactData);
            showLoadingSuccess('Contact added successfully!');
        }
        
        closeContactModal();
        loadContacts();
        
    } catch (error) {
        console.error('Error saving contact:', error);
        showLoadingError('Failed to save contact. Please try again.');
    }
}

// Edit contact
function editContact(contactId) {
    openContactModal(contactId);
}

// Delete contact
async function deleteContact(contactId, contactName) {
    if (!confirm(`Are you sure you want to delete ${contactName}?\n\nThis action cannot be undone.`)) {
        return;
    }
    
    // Show loading spinner
    showLoading('Deleting contact...');
    
    try {
        await contactsManager.deleteContact(contactId);
        showLoadingSuccess('Contact deleted successfully!');
        loadContacts();
    } catch (error) {
        console.error('Error deleting contact:', error);
        showLoadingError('Failed to delete contact. Please try again.');
    }
}


// ============================================
// SITE CUSTOMIZATION FUNCTIONS
// ============================================

// Show/hide customization tabs
function showCustomizationTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.customization-tab').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // Show selected tab
    const selectedTab = document.getElementById(`${tabName}-tab`);
    if (selectedTab) {
        selectedTab.style.display = 'block';
    }
    
    // Load player card background if viewing advanced-settings tab
    if (tabName === 'advanced-settings') {
        loadPlayerCardBackgroundPreview();
        loadAPIConfiguration(); // OLS 108: Load API keys
        loadDefaultMatchImagePreviews(); // OLS 128: Load default match images
    }
    
    // OLS 129: Load header style if viewing brand-colors tab
    if (tabName === 'brand-colors') {
        loadHeaderStyle();
    }
    
    // Update button styles (optional - could highlight active tab button)
    document.querySelectorAll('#site-customization .btn-secondary').forEach(btn => {
        btn.style.background = '';
        btn.style.color = '';
    });
}

// Load existing customization settings
async function loadCustomizationSettings() {
    try {
        // OLS 90: Use Blobs endpoint instead of Forms
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'GET'
        });
        
        if (!response.ok) {
            console.log('No existing settings found, using defaults');
            return;
        }
        
        const result = await response.json();
        const settings = result.data || {};
        
        // Apply settings directly from object (no deduplication needed)
        Object.keys(settings).forEach(settingName => {
            const settingValue = settings[settingName];
            const fieldId = `setting-${settingName}`;
            const field = document.getElementById(fieldId);
            
            if (field) {
                field.value = settingValue;
            }
            
            // Handle logo preview
            if (settingName === 'logo-url' && settingValue) {
                const logoPreview = document.getElementById('logo-preview');
                if (logoPreview) {
                    logoPreview.src = settingValue;
                    logoPreview.dataset.cloudinaryUrl = settingValue;
                    console.log('✅ Custom logo loaded:', settingValue);
                }
            }
            
            // Handle color fields
            if (settingName.startsWith('color-')) {
                const colorField = document.getElementById(settingName);
                const hexField = document.getElementById(`${settingName}-hex`);
                if (colorField) colorField.value = settingValue;
                if (hexField) hexField.value = settingValue;
            }
        });
        
        console.log('✅ Customization settings loaded:', Object.keys(settings).length, 'settings');
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

// Save all customization settings
async function saveSiteCustomization() {
    const submitBtn = event.target;
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Checking changes...';
    
    try {
        // Collect current settings
        const currentSettings = {
            'club-name': document.getElementById('setting-club-name')?.value || 'Old Laurentian RFC',
            'club-tagline': document.getElementById('setting-club-tagline')?.value || 'Est. 1919',
            'contact-address': document.getElementById('setting-contact-address')?.value || '',
            'contact-email': document.getElementById('setting-contact-email')?.value || '',
            'contact-phone': document.getElementById('setting-contact-phone')?.value || '',
            'social-facebook': document.getElementById('setting-social-facebook')?.value || '',
            'social-instagram': document.getElementById('setting-social-instagram')?.value || '',
            'social-twitter': document.getElementById('setting-social-twitter')?.value || '',
            'social-youtube': document.getElementById('setting-social-youtube')?.value || '',
            'copyright': document.getElementById('setting-copyright')?.value || '',
            'color-primary-green': document.getElementById('color-primary-green')?.value || '#2e5016',
            'color-primary-maroon': document.getElementById('color-primary-maroon')?.value || '#8b1538',
            'color-accent-gold': document.getElementById('color-accent-gold')?.value || '#f4c430'
        };
        
        // Fetch existing settings to compare
        let existingSettings = {};
        try {
            const response = await fetch('/.netlify/functions/site-settings', {
                method: 'GET'
            });
            
            if (response.ok) {
                const result = await response.json();
                existingSettings = result.data || {};
            }
        } catch (error) {
            console.warn('Could not load existing settings, will save all:', error);
        }
        
        // Find only changed settings (normalize empty values)
        const changedSettings = {};
        for (const [name, value] of Object.entries(currentSettings)) {
            const existingValue = existingSettings[name];
            const currentValue = value;
            
            // Normalize empty values (treat undefined, null, "" as equivalent)
            const normalizedExisting = !existingValue || existingValue === '' ? '' : existingValue;
            const normalizedCurrent = !currentValue || currentValue === '' ? '' : currentValue;
            
            // Only mark as changed if values are actually different
            if (normalizedExisting !== normalizedCurrent) {
                changedSettings[name] = value;
                console.log(`🔄 Changed: ${name}`, {old: normalizedExisting, new: normalizedCurrent});
            }
        }
        
        const changeCount = Object.keys(changedSettings).length;
        
        if (changeCount === 0) {
            showCustomizationAlert('info', 'ℹ️ No changes detected.');
            submitBtn.textContent = '💾 Save All Changes';
            submitBtn.disabled = false;
            return;
        }
        
        console.log(`📝 Saving ${changeCount} changed setting(s):`, Object.keys(changedSettings));
        
        // Update Blobs with changed settings (single API call)
        submitBtn.textContent = '⏳ Saving to Blobs...';
        
        try {
            const response = await fetch('/.netlify/functions/site-settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(changedSettings)
            });
            
            if (!response.ok) {
                throw new Error(`Failed to save: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || 'Failed to save settings');
            }
            
            console.log('✅ Settings saved to Blobs:', Object.keys(changedSettings));
            
            // Show success message
            showCustomizationAlert('success', `✅ ${changeCount} setting(s) saved successfully! Refresh your site pages to see changes.`);
            
        } catch (error) {
            console.error('Failed to save settings:', error);
            showCustomizationAlert('error', `❌ Error saving settings: ${error.message}`);
        }
        
        submitBtn.textContent = '💾 Save All Changes';
        submitBtn.disabled = false;
        
    } catch (error) {
        console.error('Error saving settings:', error);
        showCustomizationAlert('error', '❌ Error saving settings. Please try again.');
        submitBtn.textContent = '💾 Save All Changes';
        submitBtn.disabled = false;
    }
}

// ============================================
// NEW FOCUSED SAVE FUNCTIONS (OLS 75)
// ============================================

/**
 * Save Club Identity (Tab 1)
 * Saves: club name, club tagline
 * Note: Logo saves automatically on upload
 */
async function saveClubIdentity() {
    const submitBtn = event.target;
    const statusDiv = document.getElementById('club-identity-status');
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Checking changes...';
    
    try {
        // Collect current settings (only club identity fields)
        const currentSettings = {
            'club-name': document.getElementById('setting-club-name')?.value || 'Old Laurentian RFC',
            'club-tagline': document.getElementById('setting-club-tagline')?.value || 'Est. 1919'
        };
        
        // Fetch existing settings to compare
        let existingSettings = {};
        try {
            const response = await fetch('/.netlify/functions/site-settings', {
                method: 'GET'
            });
            
            if (response.ok) {
                const result = await response.json();
                existingSettings = result.data || {};
            }
        } catch (error) {
            console.warn('Could not load existing settings, will save all:', error);
        }
        
        // Find only changed settings
        const changedSettings = {};
        for (const [name, value] of Object.entries(currentSettings)) {
            const existingValue = existingSettings[name];
            const normalizedExisting = !existingValue || existingValue === '' ? '' : existingValue;
            const normalizedCurrent = !value || value === '' ? '' : value;
            
            if (normalizedExisting !== normalizedCurrent) {
                changedSettings[name] = value;
                console.log(`🔄 Club Identity - Changed: ${name}`, {old: normalizedExisting, new: normalizedCurrent});
            }
        }
        
        const changeCount = Object.keys(changedSettings).length;
        
        if (changeCount === 0) {
            showTabStatus('club-identity-status', 'info', 'ℹ️ No changes detected.');
            submitBtn.textContent = '💾 Save Club Identity';
            submitBtn.disabled = false;
            return;
        }
        
        console.log(`📝 Saving ${changeCount} club identity setting(s):`, Object.keys(changedSettings));
        
        // Save to Blobs (single API call)
        submitBtn.textContent = '⏳ Saving to Blobs...';
        
        try {
            const response = await fetch('/.netlify/functions/site-settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(changedSettings)
            });
            
            if (!response.ok) {
                throw new Error(`Failed to save: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || 'Failed to save settings');
            }
            
            console.log('✅ Club identity settings saved to Blobs:', Object.keys(changedSettings));
            
            // Show success message
            showTabStatus('club-identity-status', 'success', `✅ ${changeCount} setting(s) saved! Refresh pages to see changes.`);
            
        } catch (error) {
            console.error('Failed to save club identity:', error);
            showTabStatus('club-identity-status', 'error', `❌ Error saving: ${error.message}`);
        }
        
        submitBtn.textContent = '💾 Save Club Identity';
        submitBtn.disabled = false;
        
    } catch (error) {
        console.error('Error saving club identity:', error);
        showTabStatus('club-identity-status', 'error', '❌ Error saving. Please try again.');
        submitBtn.textContent = '💾 Save Club Identity';
        submitBtn.disabled = false;
    }
}

/**
 * Save Color Scheme (Tab 2)
 * Saves: primary green, primary maroon, accent gold colors
 */
async function saveColorScheme() {
    const submitBtn = event.target;
    const statusDiv = document.getElementById('brand-colors-status');
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Checking changes...';
    
    try {
        // Collect current settings (color fields + header style)
        const currentSettings = {
            'color-primary-green': document.getElementById('color-primary-green')?.value || '#2e5016',
            'color-primary-maroon': document.getElementById('color-primary-maroon')?.value || '#8b1538',
            'color-accent-gold': document.getElementById('color-accent-gold')?.value || '#f4c430',
            'header-style': document.querySelector('.header-style-option.selected')?.dataset.style || 'gradient'
        };
        
        // Fetch existing settings to compare
        let existingSettings = {};
        try {
            const response = await fetch('/.netlify/functions/site-settings', {
                method: 'GET'
            });
            
            if (response.ok) {
                const result = await response.json();
                existingSettings = result.data || {};
            }
        } catch (error) {
            console.warn('Could not load existing settings, will save all:', error);
        }
        
        // Find only changed settings
        const changedSettings = {};
        for (const [name, value] of Object.entries(currentSettings)) {
            const existingValue = existingSettings[name];
            const normalizedExisting = !existingValue || existingValue === '' ? '' : existingValue;
            const normalizedCurrent = !value || value === '' ? '' : value;
            
            if (normalizedExisting !== normalizedCurrent) {
                changedSettings[name] = value;
                console.log(`🔄 Color Scheme - Changed: ${name}`, {old: normalizedExisting, new: normalizedCurrent});
            }
        }
        
        const changeCount = Object.keys(changedSettings).length;
        
        if (changeCount === 0) {
            showTabStatus('brand-colors-status', 'info', 'ℹ️ No changes detected.');
            submitBtn.textContent = '💾 Save Color Scheme';
            submitBtn.disabled = false;
            return;
        }
        
        console.log(`📝 Saving ${changeCount} color setting(s):`, Object.keys(changedSettings));
        
        // Save to Blobs (single API call)
        submitBtn.textContent = '⏳ Saving to Blobs...';
        
        try {
            const response = await fetch('/.netlify/functions/site-settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(changedSettings)
            });
            
            if (!response.ok) {
                throw new Error(`Failed to save: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || 'Failed to save settings');
            }
            
            console.log('✅ Color settings saved to Blobs:', Object.keys(changedSettings));
            
            // Show success message
            showTabStatus('brand-colors-status', 'success', `✅ ${changeCount} color(s) saved! Refresh pages to see changes.`);
            
        } catch (error) {
            console.error('Failed to save color scheme:', error);
            showTabStatus('brand-colors-status', 'error', `❌ Error saving: ${error.message}`);
        }
        
        submitBtn.textContent = '💾 Save Color Scheme';
        submitBtn.disabled = false;
        
    } catch (error) {
        console.error('Error saving color scheme:', error);
        showTabStatus('brand-colors-status', 'error', '❌ Error saving. Please try again.');
        submitBtn.textContent = '💾 Save Color Scheme';
        submitBtn.disabled = false;
    }
}

/**
 * Save Footer Settings (Tab 4)
 * Saves: contact address, email, phone, social links, copyright
 */
async function saveFooterSettings() {
    const submitBtn = event.target;
    const statusDiv = document.getElementById('footer-contact-status');
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Checking changes...';
    
    try {
        // Collect current settings (only footer/contact fields)
        const currentSettings = {
            'contact-address': document.getElementById('setting-contact-address')?.value || '',
            'contact-email': document.getElementById('setting-contact-email')?.value || '',
            'contact-phone': document.getElementById('setting-contact-phone')?.value || '',
            'social-facebook': document.getElementById('setting-social-facebook')?.value || '',
            'social-instagram': document.getElementById('setting-social-instagram')?.value || '',
            'social-twitter': document.getElementById('setting-social-twitter')?.value || '',
            'social-youtube': document.getElementById('setting-social-youtube')?.value || '',
            'copyright': document.getElementById('setting-copyright')?.value || ''
        };
        
        // Fetch existing settings to compare
        let existingSettings = {};
        try {
            const response = await fetch('/.netlify/functions/site-settings', {
                method: 'GET'
            });
            
            if (response.ok) {
                const result = await response.json();
                existingSettings = result.data || {};
            }
        } catch (error) {
            console.warn('Could not load existing settings, will save all:', error);
        }
        
        // Find only changed settings
        const changedSettings = {};
        for (const [name, value] of Object.entries(currentSettings)) {
            const existingValue = existingSettings[name];
            const normalizedExisting = !existingValue || existingValue === '' ? '' : existingValue;
            const normalizedCurrent = !value || value === '' ? '' : value;
            
            if (normalizedExisting !== normalizedCurrent) {
                changedSettings[name] = value;
                console.log(`🔄 Footer - Changed: ${name}`, {old: normalizedExisting, new: normalizedCurrent});
            }
        }
        
        const changeCount = Object.keys(changedSettings).length;
        
        if (changeCount === 0) {
            showTabStatus('footer-contact-status', 'info', 'ℹ️ No changes detected.');
            submitBtn.textContent = '💾 Save Footer & Contact';
            submitBtn.disabled = false;
            return;
        }
        
        console.log(`📝 Saving ${changeCount} footer setting(s):`, Object.keys(changedSettings));
        
        // Save to Blobs (single API call)
        submitBtn.textContent = '⏳ Saving to Blobs...';
        
        try {
            const response = await fetch('/.netlify/functions/site-settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(changedSettings)
            });
            
            if (!response.ok) {
                throw new Error(`Failed to save: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || 'Failed to save settings');
            }
            
            console.log('✅ Footer settings saved to Blobs:', Object.keys(changedSettings));
            
            // Show success message
            showTabStatus('footer-contact-status', 'success', `✅ ${changeCount} setting(s) saved! Refresh pages to see changes.`);
            
        } catch (error) {
            console.error('Failed to save footer settings:', error);
            showTabStatus('footer-contact-status', 'error', `❌ Error saving: ${error.message}`);
        }
        
        submitBtn.textContent = '💾 Save Footer & Contact';
        submitBtn.disabled = false;
        
    } catch (error) {
        console.error('Error saving footer settings:', error);
        showTabStatus('footer-contact-status', 'error', '❌ Error saving. Please try again.');
        submitBtn.textContent = '💾 Save Footer & Contact';
        submitBtn.disabled = false;
    }
}

/**
 * Save Advanced Settings (Tab 5)
 * Saves: player card background URL from localStorage to Netlify
 */
async function saveAdvancedSettings() {
    const submitBtn = event.target;
    const statusDiv = document.getElementById('advanced-settings-status');
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Checking changes...';
    
    try {
        // Get player card background URL from localStorage
        const backgroundUrl = localStorage.getItem('olrfc_player_card_background') || '';
        
        // Get API configuration from form (OLS 108)
        const sendgridKey = document.getElementById('api-sendgrid-key')?.value || '';
        const sendgridFromEmail = document.getElementById('api-sendgrid-from-email')?.value || '';
        const sendgridNotifyEmail = document.getElementById('api-sendgrid-notify-email')?.value || '';
        
        // Fetch existing settings to compare
        let existingBackgroundUrl = '';
        let existingSendgridKey = '';
        let existingSendgridFromEmail = '';
        let existingSendgridNotifyEmail = '';
        
        try {
            const response = await fetch('/.netlify/functions/site-settings', {
                method: 'GET'
            });
            
            if (response.ok) {
                const result = await response.json();
                const settings = result.data || {};
                
                existingBackgroundUrl = settings['player-card-background'] || '';
                existingSendgridKey = settings['api-sendgrid-key'] || '';
                existingSendgridFromEmail = settings['api-sendgrid-from-email'] || '';
                existingSendgridNotifyEmail = settings['api-sendgrid-notify-email'] || '';
            }
        } catch (error) {
            console.warn('Could not load existing settings, will save:', error);
        }
        
        // Build changed settings object
        const changedSettings = {};
        let hasChanges = false;
        
        // Check player card background
        const normalizedExistingBg = !existingBackgroundUrl || existingBackgroundUrl === '' ? '' : existingBackgroundUrl;
        const normalizedCurrentBg = !backgroundUrl || backgroundUrl === '' ? '' : backgroundUrl;
        
        if (normalizedExistingBg !== normalizedCurrentBg) {
            changedSettings['player-card-background'] = backgroundUrl;
            hasChanges = true;
            console.log('📝 Player card background changed:', {old: normalizedExistingBg, new: normalizedCurrentBg});
        }
        
        // Check API configuration (OLS 108)
        if (sendgridKey !== existingSendgridKey) {
            changedSettings['api-sendgrid-key'] = sendgridKey;
            hasChanges = true;
            console.log('📝 SendGrid API key changed');
        }
        
        if (sendgridFromEmail !== existingSendgridFromEmail) {
            changedSettings['api-sendgrid-from-email'] = sendgridFromEmail;
            hasChanges = true;
            console.log('📝 SendGrid from email changed');
        }
        
        if (sendgridNotifyEmail !== existingSendgridNotifyEmail) {
            changedSettings['api-sendgrid-notify-email'] = sendgridNotifyEmail;
            hasChanges = true;
            console.log('📝 SendGrid notify email changed');
        }
        
        // If no changes, show info message
        if (!hasChanges) {
            showTabStatus('advanced-settings-status', 'info', 'ℹ️ No changes detected.');
            submitBtn.textContent = '💾 Save Advanced Settings';
            submitBtn.disabled = false;
            return;
        }
        
        // Save to Blobs
        submitBtn.textContent = '⏳ Saving to Blobs...';
        
        try {
            const response = await fetch('/.netlify/functions/site-settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(changedSettings)
            });
            
            if (!response.ok) {
                throw new Error(`Failed to save: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || 'Failed to save settings');
            }
            
            console.log('✅ Advanced settings saved to Blobs');
            
            // Show success message
            showTabStatus('advanced-settings-status', 'success', '✅ Settings saved! API configuration is now active.');
            
            // Update SendGrid status indicator
            updateSendGridStatus(sendgridKey, sendgridFromEmail, sendgridNotifyEmail);
            
        } catch (error) {
            console.error('Failed to save advanced settings:', error);
            showTabStatus('advanced-settings-status', 'error', `❌ Error saving: ${error.message}`);
        }
        
        submitBtn.textContent = '💾 Save Advanced Settings';
        submitBtn.disabled = false;
        
    } catch (error) {
        console.error('Error saving advanced settings:', error);
        showTabStatus('advanced-settings-status', 'error', '❌ Error saving. Please try again.');
        submitBtn.textContent = '💾 Save Advanced Settings';
        submitBtn.disabled = false;
    }
}

// Helper function to show status in tab-specific divs
function showTabStatus(divId, type, message) {
    const statusDiv = document.getElementById(divId);
    if (!statusDiv) return;
    
    statusDiv.style.display = 'block';
    statusDiv.style.padding = '1rem';
    statusDiv.style.borderRadius = '10px';
    statusDiv.style.marginTop = '1rem';
    statusDiv.textContent = message;
    
    if (type === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '2px solid #c3e6cb';
    } else if (type === 'info') {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '2px solid #bee5eb';
    } else {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '2px solid #f5c6cb';
    }
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

// OLS 108: Load API Configuration from Blobs
async function loadAPIConfiguration() {
    try {
        console.log('📥 Loading API configuration...');
        
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'GET'
        });
        
        if (!response.ok) {
            console.log('No API configuration found');
            return;
        }
        
        const result = await response.json();
        const settings = result.data || {};
        
        // Populate SendGrid fields
        const sendgridKey = settings['api-sendgrid-key'] || '';
        const sendgridFromEmail = settings['api-sendgrid-from-email'] || '';
        const sendgridNotifyEmail = settings['api-sendgrid-notify-email'] || '';
        
        if (document.getElementById('api-sendgrid-key')) {
            document.getElementById('api-sendgrid-key').value = sendgridKey;
        }
        
        if (document.getElementById('api-sendgrid-from-email')) {
            document.getElementById('api-sendgrid-from-email').value = sendgridFromEmail;
        }
        
        if (document.getElementById('api-sendgrid-notify-email')) {
            document.getElementById('api-sendgrid-notify-email').value = sendgridNotifyEmail;
        }
        
        // Update status indicator
        updateSendGridStatus(sendgridKey, sendgridFromEmail, sendgridNotifyEmail);
        
        console.log('✅ API configuration loaded');
        
    } catch (error) {
        console.error('Error loading API configuration:', error);
    }
}

// OLS 108: Update SendGrid status indicator
function updateSendGridStatus(apiKey, fromEmail, notifyEmail) {
    const statusDiv = document.getElementById('sendgrid-status');
    if (!statusDiv) return;
    
    const isConfigured = apiKey && fromEmail && notifyEmail;
    
    statusDiv.style.display = 'block';
    statusDiv.style.padding = '0.75rem';
    statusDiv.style.borderRadius = '8px';
    
    if (isConfigured) {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '2px solid #c3e6cb';
        statusDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.2rem;">✅</span>
                <div>
                    <div style="font-weight: 600;">SendGrid Configured</div>
                    <div style="font-size: 0.85rem; margin-top: 0.25rem;">
                        From: ${fromEmail}<br>
                        Notifications: ${notifyEmail}
                    </div>
                </div>
            </div>
        `;
    } else {
        statusDiv.style.background = '#fff3cd';
        statusDiv.style.color = '#856404';
        statusDiv.style.border = '2px solid #ffc107';
        statusDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.2rem;">⚠️</span>
                <div>
                    <div style="font-weight: 600;">Not Configured</div>
                    <div style="font-size: 0.85rem; margin-top: 0.25rem;">
                        Email notifications will not work until SendGrid is configured above.
                    </div>
                </div>
            </div>
        `;
    }
}


// Show alert message
function showCustomizationAlert(type, message) {
    const alert = document.getElementById('customizationAlert');
    alert.style.display = 'block';
    alert.style.padding = '1rem';
    alert.style.borderRadius = '10px';
    alert.style.marginTop = '1rem';
    alert.textContent = message;
    
    if (type === 'success') {
        alert.style.background = '#d4edda';
        alert.style.color = '#155724';
        alert.style.border = '2px solid #c3e6cb';
    } else if (type === 'info') {
        alert.style.background = '#d1ecf1';
        alert.style.color = '#0c5460';
        alert.style.border = '2px solid #bee5eb';
    } else {
        alert.style.background = '#f8d7da';
        alert.style.color = '#721c24';
        alert.style.border = '2px solid #f5c6cb';
    }
    
    setTimeout(() => {
        alert.style.display = 'none';
    }, 5000);
}

// Color picker updates
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[type="color"]').forEach(picker => {
        picker.addEventListener('input', function() {
            const hexField = document.getElementById(this.id + '-hex');
            if (hexField) {
                hexField.value = this.value;
            }
        });
    });
});

// Reset colors to default
// ==========================================
// OLS 129: HEADER STYLE MANAGEMENT
// ==========================================

/**
 * Select a header style option
 */
function selectHeaderStyle(style) {
    // Remove selected class from all options
    document.querySelectorAll('.header-style-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    
    // Add selected class to clicked option
    const selectedOption = document.querySelector(`.header-style-option[data-style="${style}"]`);
    if (selectedOption) {
        selectedOption.classList.add('selected');
        console.log(`🎨 Header style selected: ${style}`);
    }
}

/**
 * Load current header style from settings
 */
async function loadHeaderStyle() {
    try {
        const response = await fetch('/.netlify/functions/site-settings');
        if (response.ok) {
            const result = await response.json();
            const settings = result.data || {};
            const currentStyle = settings['header-style'] || 'gradient';
            selectHeaderStyle(currentStyle);
            console.log(`🎨 Header style loaded: ${currentStyle}`);
        }
    } catch (error) {
        console.warn('Could not load header style, defaulting to gradient');
        selectHeaderStyle('gradient');
    }
}

function resetColorsToDefault() {
    if (confirm('Reset to Old Laurentian RFC default colors?')) {
        document.getElementById('color-primary-green').value = '#2e5016';
        document.getElementById('color-primary-maroon').value = '#8b1538';
        document.getElementById('color-accent-gold').value = '#f4c430';
        
        document.getElementById('color-primary-green-hex').value = '#2e5016';
        document.getElementById('color-primary-maroon-hex').value = '#8b1538';
        document.getElementById('color-accent-gold-hex').value = '#f4c430';
    }
}

// Upload logo function with Cloudinary integration and background removal
async function uploadLogo() {
    // Create a hidden file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/png, image/jpeg, image/jpg';
    fileInput.style.display = 'none';
    
    fileInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file type
        if (!file.type.match('image/png') && !file.type.match('image/jpeg')) {
            alert('Please upload a PNG or JPG file.');
            return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB.');
            return;
        }
        
        const logoPreviewImg = document.getElementById('logo-preview');
        const logoPreviewPlaceholder = document.getElementById('logo-preview-placeholder');
        const removeBackgroundCheckbox = document.getElementById('remove-logo-background');
        const shouldRemoveBackground = removeBackgroundCheckbox?.checked || false;
        
        // Show local preview immediately
        const reader = new FileReader();
        reader.onload = function(e) {
            logoPreviewImg.src = e.target.result;
            logoPreviewImg.style.display = 'block';
            if (logoPreviewPlaceholder) logoPreviewPlaceholder.style.display = 'none';
        };
        reader.readAsDataURL(file);
        
        let fileToUpload = file;
        
        // Step 1: Remove background if requested
        if (shouldRemoveBackground && window.backgroundRemovalService) {
            try {
                console.log('🎨 Removing background...');
                logoPreviewImg.style.opacity = '0.4';
                
                const processedBlob = await window.backgroundRemovalService.removeBackground(file, {
                    type: 'logo'
                });
                
                // Convert blob to file
                fileToUpload = new File([processedBlob], file.name.replace(/\.(jpg|jpeg)$/i, '.png'), {
                    type: 'image/png'
                });
                
                // Update preview with background-removed version
                const processedUrl = URL.createObjectURL(processedBlob);
                logoPreviewImg.src = processedUrl;
                
                console.log('✅ Background removed successfully');
                
            } catch (error) {
                console.error('❌ Background removal failed:', error);
                
                // Ask user if they want to continue without background removal
                const continueUpload = confirm(
                    'Background removal failed: ' + error.message + 
                    '\n\nDo you want to upload the logo without removing the background?'
                );
                
                if (!continueUpload) {
                    logoPreviewImg.style.opacity = '1';
                    logoPreviewImg.src = '../images/logo/olrfc-logo.png';
                    return;
                }
                
                // Continue with original file
                fileToUpload = file;
            }
        }
        
        // Step 2: Upload to Cloudinary
        if (window.cloudinaryUploader) {
            try {
                console.log('📤 Uploading logo to Cloudinary...');
                logoPreviewImg.style.opacity = '0.6';
                
                // Use existing uploadSponsorLogo method (works for any logo)
                const result = await window.cloudinaryUploader.uploadSponsorLogo(fileToUpload);
                
                logoPreviewImg.style.opacity = '1';
                
                if (result.success) {
                    const cloudinaryUrl = result.url;
                    logoPreviewImg.src = cloudinaryUrl;
                    logoPreviewImg.dataset.cloudinaryUrl = cloudinaryUrl;
                    
                    console.log('✅ Logo uploaded to Cloudinary:', cloudinaryUrl);
                    
                    // Step 3: Save logo URL to Netlify Blobs (site-settings)
                    try {
                        const updates = {
                            'logo-url': cloudinaryUrl
                        };
                        
                        const saveResponse = await fetch('/.netlify/functions/site-settings', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updates)
                        });
                        
                        if (!saveResponse.ok) {
                            throw new Error(`Failed to save: ${saveResponse.status}`);
                        }
                        
                        const result = await saveResponse.json();
                        
                        if (!result.success) {
                            throw new Error(result.error || 'Failed to save logo URL');
                        }
                        
                        console.log('✅ Logo URL saved to Blobs');
                        const successMessage = shouldRemoveBackground 
                            ? '✅ Logo uploaded successfully with background removed! Your new logo will appear across all pages.'
                            : '✅ Logo uploaded successfully! Your new logo will appear across all pages.';
                        alert(successMessage);
                        
                    } catch (saveError) {
                        console.error('❌ Failed to save logo URL:', saveError);
                        throw new Error('Failed to save logo URL to settings');
                    }
                    
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
                
            } catch (error) {
                logoPreviewImg.style.opacity = '1';
                console.error('❌ Logo upload error:', error);
                alert('Upload failed: ' + error.message + '\n\nPlease try again or contact support.');
                // Restore original logo
                logoPreviewImg.src = '../images/logo/olrfc-logo.png';
            }
        } else {
            alert('Cloudinary uploader not available. Please refresh the page and try again.');
            console.error('❌ window.cloudinaryUploader not found');
        }
    });
    
    // Trigger file selection
    fileInput.click();
}

// ============================================
// HERO BACKGROUND IMAGE UPLOAD
// ============================================

async function uploadHeroBackground() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/png, image/jpeg, image/jpg';
    fileInput.style.display = 'none';
    
    fileInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file type
        if (!file.type.match('image/png') && !file.type.match('image/jpeg')) {
            alert('Please upload a PNG or JPG file.');
            return;
        }
        
        // Validate file size (max 10MB for background images)
        if (file.size > 10 * 1024 * 1024) {
            alert('File size must be less than 10MB.');
            return;
        }
        
        const previewImg = document.getElementById('hero-bg-preview');
        
        // Show local preview immediately
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
        };
        reader.readAsDataURL(file);
        
        // Upload to Cloudinary
        if (window.cloudinaryUploader) {
            try {
                console.log('📤 Uploading hero background to Cloudinary...');
                previewImg.style.opacity = '0.6';
                
                const result = await window.cloudinaryUploader.uploadSponsorLogo(file);
                
                previewImg.style.opacity = '1';
                
                if (result.success) {
                    const cloudinaryUrl = result.url;
                    previewImg.src = cloudinaryUrl;
                    previewImg.dataset.cloudinaryUrl = cloudinaryUrl;
                    
                    console.log('✅ Hero background uploaded to Cloudinary:', cloudinaryUrl);
                    
                    // Save to Netlify Blobs
                    try {
                        const updates = {
                            'homepage-hero-background': cloudinaryUrl
                        };
                        
                        const saveResponse = await fetch('/.netlify/functions/site-settings', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updates)
                        });
                        
                        if (!saveResponse.ok) {
                            throw new Error(`Failed to save: ${saveResponse.status}`);
                        }
                        
                        const result = await saveResponse.json();
                        
                        if (!result.success) {
                            throw new Error(result.error || 'Failed to save hero background URL');
                        }
                        
                        console.log('✅ Hero background URL saved to Blobs');
                        alert('✅ Hero background uploaded successfully! It will appear on your homepage.');
                        
                    } catch (saveError) {
                        console.error('❌ Failed to save hero background URL:', saveError);
                        alert('Image uploaded but failed to save. Please try again.');
                    }
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                console.error('❌ Upload error:', error);
                alert('Failed to upload image: ' + error.message);
                previewImg.style.opacity = '1';
            }
        } else {
            alert('Cloudinary uploader not available. Please refresh the page and try again.');
            console.error('❌ window.cloudinaryUploader not found');
        }
    });
    
    fileInput.click();
}

// ============================================
// HERITAGE IMAGE UPLOAD
// ============================================

async function uploadHeritageImage() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/png, image/jpeg, image/jpg';
    fileInput.style.display = 'none';
    
    fileInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file type
        if (!file.type.match('image/png') && !file.type.match('image/jpeg')) {
            alert('Please upload a PNG or JPG file.');
            return;
        }
        
        // Validate file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
            alert('File size must be less than 10MB.');
            return;
        }
        
        const previewImg = document.getElementById('heritage-img-preview');
        
        // Show local preview immediately
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
        };
        reader.readAsDataURL(file);
        
        // Upload to Cloudinary
        if (window.cloudinaryUploader) {
            try {
                console.log('📤 Uploading heritage image to Cloudinary...');
                previewImg.style.opacity = '0.6';
                
                const result = await window.cloudinaryUploader.uploadSponsorLogo(file);
                
                previewImg.style.opacity = '1';
                
                if (result.success) {
                    const cloudinaryUrl = result.url;
                    previewImg.src = cloudinaryUrl;
                    previewImg.dataset.cloudinaryUrl = cloudinaryUrl;
                    
                    console.log('✅ Heritage image uploaded to Cloudinary:', cloudinaryUrl);
                    
                    // Save to Netlify Blobs
                    try {
                        const updates = {
                            'homepage-heritage-image': cloudinaryUrl
                        };
                        
                        const saveResponse = await fetch('/.netlify/functions/site-settings', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updates)
                        });
                        
                        if (!saveResponse.ok) {
                            throw new Error(`Failed to save: ${saveResponse.status}`);
                        }
                        
                        const result = await saveResponse.json();
                        
                        if (!result.success) {
                            throw new Error(result.error || 'Failed to save heritage image URL');
                        }
                        
                        console.log('✅ Heritage image URL saved to Blobs');
                        alert('✅ Heritage image uploaded successfully! It will appear in your About section.');
                        
                    } catch (saveError) {
                        console.error('❌ Failed to save heritage image URL:', saveError);
                        alert('Image uploaded but failed to save. Please try again.');
                    }
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                console.error('❌ Upload error:', error);
                alert('Failed to upload image: ' + error.message);
                previewImg.style.opacity = '1';
            }
        } else {
            alert('Cloudinary uploader not available. Please refresh the page and try again.');
            console.error('❌ window.cloudinaryUploader not found');
        }
    });
    
    fileInput.click();
}

// ============================================
// PLAYER CARD BACKGROUND MANAGEMENT
// ============================================

async function uploadPlayerCardBackground() {
    // Create a hidden file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/png, image/jpeg, image/jpg';
    fileInput.style.display = 'none';
    
    fileInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file type
        if (!file.type.match('image/png') && !file.type.match('image/jpeg')) {
            alert('Please upload a PNG or JPG file.');
            return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB.');
            return;
        }
        
        const bgPreview = document.getElementById('player-card-bg-preview');
        const cardPreview = document.getElementById('player-card-preview');
        
        // Show local preview immediately
        const reader = new FileReader();
        reader.onload = function(e) {
            bgPreview.style.backgroundImage = `url(${e.target.result})`;
            bgPreview.style.backgroundSize = 'cover';
            bgPreview.style.backgroundPosition = 'center';
            bgPreview.innerHTML = '';
            
            // Update player card preview
            cardPreview.style.backgroundImage = `url(${e.target.result})`;
            cardPreview.style.backgroundSize = 'cover';
            cardPreview.style.backgroundPosition = 'center';
        };
        reader.readAsDataURL(file);
        
        // Upload to Cloudinary
        if (window.cloudinaryUploader) {
            try {
                console.log('📤 Uploading player card background to Cloudinary...');
                bgPreview.style.opacity = '0.6';
                
                // Create custom upload for player card backgrounds
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', 'olrfc_sponsors');
                formData.append('folder', 'olrfc/player-card-backgrounds');
                formData.append('tags', 'player-card-background');
                
                const cloudinaryUrl = `https://api.cloudinary.com/v1_1/${window.cloudinaryUploader.cloudName}/image/upload`;
                
                const response = await fetch(cloudinaryUrl, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                
                const result = await response.json();
                
                bgPreview.style.opacity = '1';
                
                const cloudinaryUrlResult = result.secure_url;
                console.log('✅ Player card background uploaded:', cloudinaryUrlResult);
                
                // Save to localStorage
                localStorage.setItem('olrfc_player_card_background', cloudinaryUrlResult);
                
                alert('✅ Player card background uploaded successfully! Click "Save Advanced Settings" to persist this change.');
                
            } catch (error) {
                console.error('❌ Upload failed:', error);
                bgPreview.style.opacity = '1';
                alert('Upload failed: ' + error.message);
            }
        } else {
            alert('Cloudinary uploader not available. Please refresh the page and try again.');
        }
    });
    
    // Trigger file selection
    fileInput.click();
}

function removePlayerCardBackground() {
    if (!confirm('Remove the custom player card background? Cards will use your club color gradient instead.')) {
        return;
    }
    
    // Remove from localStorage
    localStorage.removeItem('olrfc_player_card_background');
    
    // Reset previews to gradient
    const bgPreview = document.getElementById('player-card-bg-preview');
    const cardPreview = document.getElementById('player-card-preview');
    
    bgPreview.style.backgroundImage = '';
    bgPreview.style.background = 'linear-gradient(135deg, var(--primary-green), var(--primary-maroon))';
    bgPreview.innerHTML = 'No custom background<br>Using gradient';
    
    cardPreview.style.backgroundImage = '';
    cardPreview.style.background = 'linear-gradient(135deg, var(--primary-green), var(--primary-maroon))';
    
    alert('✅ Background removed from preview. Click "Save Advanced Settings" to persist this change.');
}

// Load player card background on tab show
function loadPlayerCardBackgroundPreview() {
    const backgroundUrl = localStorage.getItem('olrfc_player_card_background');
    const bgPreview = document.getElementById('player-card-bg-preview');
    const cardPreview = document.getElementById('player-card-preview');
    
    if (backgroundUrl) {
        bgPreview.style.backgroundImage = `url(${backgroundUrl})`;
        bgPreview.style.backgroundSize = 'cover';
        bgPreview.style.backgroundPosition = 'center';
        bgPreview.innerHTML = '';
        
        cardPreview.style.backgroundImage = `url(${backgroundUrl})`;
        cardPreview.style.backgroundSize = 'cover';
        cardPreview.style.backgroundPosition = 'center';
    } else {
        bgPreview.style.backgroundImage = '';
        bgPreview.style.background = 'linear-gradient(135deg, var(--primary-green), var(--primary-maroon))';
        bgPreview.innerHTML = 'No custom background<br>Using gradient';
        
        cardPreview.style.backgroundImage = '';
        cardPreview.style.background = 'linear-gradient(135deg, var(--primary-green), var(--primary-maroon))';
    }
}

// Load settings when Site Customization section is shown
const originalShowSection = showSection;
showSection = function(sectionId) {
    originalShowSection(sectionId);
    if (sectionId === 'site-customization') {
        loadCustomizationSettings();
        loadPlayerCardBackgroundPreview();
    }
    // OLS 132: Update sidebar active state
    if (typeof updateSidebarActive === 'function') {
        updateSidebarActive(sectionId);
    }
};

// ============================================
// NAVIGATION MENU MANAGEMENT
// ============================================

/**
 * Save a single navigation setting to Netlify Forms
 */
async function saveNavigationSetting(settingKey, isEnabled) {
    try {
        const updates = {
            [`navigation-${settingKey}`]: isEnabled.toString()
        };
        
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to save: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to save');
        }
        
        console.log(`✅ Saved ${settingKey} to Blobs: ${isEnabled}`);
        showNavigationStatus(`✅ ${settingKey} ${isEnabled ? 'enabled' : 'disabled'}`, 'success');
        
    } catch (error) {
        console.error(`❌ Error saving ${settingKey}:`, error);
        showNavigationStatus(`❌ Failed to save ${settingKey}`, 'error');
    }
}

/**
 * Handle toggle change - auto-save individual setting
 */
async function handleNavigationToggle(settingKey, checkbox) {
    const isEnabled = checkbox.checked;
    await saveNavigationSetting(settingKey, isEnabled);
}

/**
 * Show status message
 */
function showNavigationStatus(message, type) {
    const statusDiv = document.getElementById('nav-save-status');
    statusDiv.style.display = 'block';
    statusDiv.style.background = type === 'success' ? 'var(--success-green)' : '#dc3545';
    statusDiv.style.color = 'white';
    statusDiv.innerHTML = message;
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 3000);
}

/**
 * Save all navigation settings to Netlify Forms (LEGACY - kept for reset button)
 */
async function saveNavigationSettings() {
    const statusDiv = document.getElementById('nav-save-status');
    
    try {
        // Get toggle states
        const settings = {
            home: document.getElementById('nav-toggle-home').checked,
            players: document.getElementById('nav-toggle-players').checked,
            shop: document.getElementById('nav-toggle-shop').checked,
            policies: document.getElementById('nav-toggle-policies').checked,
            contact: document.getElementById('nav-toggle-contact').checked,
            'vp-wall': document.getElementById('nav-toggle-vp-wall').checked
        };
        
        console.log('💾 Saving all navigation settings:', settings);
        
        // Build updates object for Blobs
        const updates = {};
        Object.keys(settings).forEach(key => {
            updates[`navigation-${key}`] = settings[key].toString();
        });
        
        // Save to Blobs (single API call)
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to save: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to save settings');
        }
        
        console.log('✅ All navigation settings saved to Blobs');

        // Log activity
        if (window.activityLogger) {
            const visiblePages = Object.entries(settings).filter(([, v]) => v).map(([k]) => k);
            const hiddenPages = Object.entries(settings).filter(([, v]) => !v).map(([k]) => k);
            let desc = 'Updated navigation settings';
            if (hiddenPages.length > 0) {
                desc += ` - hidden: ${hiddenPages.join(', ')}`;
            }
            window.activityLogger.logUpdate('site-settings', 'Navigation Settings', null, desc);
        }

        // Show success message
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--success-green)';
        statusDiv.style.color = 'white';
        statusDiv.innerHTML = '✅ All navigation settings saved!';

        console.log('✅ All navigation settings saved successfully');
        
        // Hide message after 3 seconds
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 3000);
        
    } catch (error) {
        console.error('❌ Error saving navigation settings:', error);
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#dc3545';
        statusDiv.style.color = 'white';
        statusDiv.innerHTML = '❌ Failed to save navigation settings. Please try again.';
    }
}

/**
 * Load navigation settings from Netlify Forms
 */
async function loadNavigationSettings() {
    // Prevent loading multiple times
    if (document.getElementById('nav-toggle-shop')?._loaded) {
        console.log('⏭️ Navigation settings already loaded, skipping');
        return;
    }
    
    try {
        console.log('📥 Loading navigation settings...');
        
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'GET'
        });
        
        if (!response.ok) {
            console.log('Using default navigation settings (all enabled)');
            return;
        }
        
        const result = await response.json();
        const settings = result.data || {};
        
        // Build map from Blobs object (already has latest values)
        const settingsMap = new Map();
        
        Object.entries(settings).forEach(([name, value]) => {
            // Only process navigation settings
            if (name?.startsWith('navigation-')) {
                settingsMap.set(name, value);
            }
        });
        
        // Apply LATEST saved settings to toggles (with defaults)
        const navigationSettings = {
            home: true,
            players: true,
            shop: true,
            policies: true,
            contact: true,
            'vp-wall': true
        };
        
        // Override defaults with latest saved values FROM settingsMap
        settingsMap.forEach((value, name) => {
            const key = name.replace('navigation-', '');
            navigationSettings[key] = value === 'true';
        });
        
        // Update toggles
        document.getElementById('nav-toggle-home').checked = navigationSettings.home;
        document.getElementById('nav-toggle-players').checked = navigationSettings.players;
        document.getElementById('nav-toggle-shop').checked = navigationSettings.shop;
        document.getElementById('nav-toggle-policies').checked = navigationSettings.policies;
        document.getElementById('nav-toggle-contact').checked = navigationSettings.contact;
        document.getElementById('nav-toggle-vp-wall').checked = navigationSettings['vp-wall'];
        
        // Mark as loaded
        document.getElementById('nav-toggle-shop')._loaded = true;
        
        console.log('✅ Navigation settings loaded (latest only):', Object.keys(navigationSettings).length, 'settings');
        
        // Update preview
        updateNavigationPreview();
        
    } catch (error) {
        console.error('Error loading navigation settings:', error);
    }
}

/**
 * Reset navigation settings to defaults (all enabled)
 */
async function resetNavigationToDefaults() {
    if (!confirm('Are you sure you want to reset all navigation settings to default (all enabled)?')) {
        return;
    }
    
    // Set all toggles to checked
    document.getElementById('nav-toggle-home').checked = true;
    document.getElementById('nav-toggle-players').checked = true;
    document.getElementById('nav-toggle-shop').checked = true;
    document.getElementById('nav-toggle-policies').checked = true;
    document.getElementById('nav-toggle-contact').checked = true;
    document.getElementById('nav-toggle-vp-wall').checked = true;
    
    // Save the defaults
    await saveNavigationSettings();
}

/**
 * Update the header preview (legacy function, kept for compatibility)
 */
function updateNavigationPreview() {
    // No longer needed with auto-save, but kept for compatibility
    console.log('🔄 Navigation preview updated');
}

// Load navigation settings when the page loads
// Wait for both DOM ready AND data sync to complete
document.addEventListener('DOMContentLoaded', () => {
    // First, wait for admin-data-loader to finish syncing
    window.addEventListener('olrfcDataReady', () => {
        console.log('🔄 Data sync complete, loading navigation settings...');
        loadNavigationSettings();
    });
    
    // Also load immediately if data is already ready (fallback)
    setTimeout(() => {
        if (document.getElementById('nav-toggle-shop') && !document.getElementById('nav-toggle-shop')._loaded) {
            console.log('🔄 Loading navigation settings (fallback)...');
            loadNavigationSettings();
        }
    }, 1000);
});

// ============================================
// CONTENT MANAGEMENT FUNCTIONS - OLS 76
// ============================================

/**
 * Load homepage content from site-settings
 */
async function loadHomePageContent() {
    console.log('📥 Loading homepage content...');
    
    try {
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'GET'
        });
        
        if (!response.ok) {
            console.log('Using default homepage content');
            return;
        }
        
        const result = await response.json();
        const settings = result.data || {};
        
        // Build Map from Blobs object (already has latest values)
        const contentMap = new Map();
        
        Object.entries(settings).forEach(([name, value]) => {
            // Only process homepage content settings (not league-tables which is handled separately)
            if (name?.startsWith('homepage-')) {
                contentMap.set(name, value);
            }
        });
        
        console.log(`✅ Loaded ${contentMap.size} homepage content fields`);
        
        // Populate form fields with loaded values
        contentMap.forEach((value, name) => {
            const fieldId = name; // e.g., 'homepage-hero-heading'
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = value || '';
                // Store original value for change detection
                field.dataset.originalValue = value || '';
            }
        });
        
        // Set defaults for fields with no saved value
        const defaults = {
            'homepage-hero-heading': 'Welcome to Old Laurentian RFC',
            'homepage-hero-tagline': 'Proudly representing tradition, excellence, and the spirit of rugby since our founding',
            'homepage-fixtures-title': 'Fixtures & Results',
            'homepage-social-title': 'Our Socials',
            'homepage-news-title': 'Latest News',
            'homepage-league-title': 'League Table',
            'homepage-calendar-title': '📅 Club Calendar',
            'homepage-about-title': 'Welcome Back to Fenley Fields',
            'homepage-findus-title': '📍 Find Us & Join Us',
            'homepage-training-title': 'Training Times',
            'homepage-about-content': '',
            'homepage-stat1-number': '450+',
            'homepage-stat1-label': 'Club Members',
            'homepage-stat2-number': '100+',
            'homepage-stat2-label': 'Years of Heritage',
            'homepage-stat3-number': '3',
            'homepage-stat3-label': 'Wins This Season',
            'homepage-stat4-number': '2',
            'homepage-stat4-label': 'Senior Teams',
            'homepage-instagram-url': 'https://www.instagram.com/olsrugby/',
            'homepage-facebook-url': 'https://www.facebook.com/olsrugby',
            'homepage-league-url': 'https://www.englandrugby.com/fixtures-and-results/search-results?division=66509&competition=1597&season=2025-2026#tables',
            'homepage-page-title': 'Old Laurentian RFC - Est. 1919',
            'homepage-page-description': 'Official website of Old Laurentian RFC. News, fixtures, results, events and more from Rugby\'s friendliest club since 1919.'
            // Note: League table configs now managed separately via league-tables array
        };
        
        // Apply defaults and store original values
        Object.keys(defaults).forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field && !field.value) {
                field.value = defaults[fieldId];
                field.dataset.originalValue = defaults[fieldId];
            }
        });
        
        console.log('✅ Homepage content loaded successfully');
        
    } catch (error) {
        console.error('Error loading homepage content:', error);
    }
}

/**
 * Load fixtures page content - OLS 79
 */
async function loadFixturesPageContent() {
    console.log('📥 Loading fixtures page content...');
    
    try {
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'GET'
        });
        
        if (!response.ok) {
            console.log('Using default fixtures content');
            return;
        }
        
        const result = await response.json();
        const settings = result.data || {};
        
        // Build Map from Blobs object (already has latest values)
        const contentMap = new Map();
        
        Object.entries(settings).forEach(([name, value]) => {
            // Only process fixtures content settings
            if (name?.startsWith('fixtures-')) {
                contentMap.set(name, value);
            }
        });
        
        console.log(`✅ Loaded ${contentMap.size} fixtures content fields`);
        
        // Populate form fields with loaded values
        contentMap.forEach((value, name) => {
            const fieldId = name;
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = value || '';
                // Store original value for change detection
                field.dataset.originalValue = value || '';
            }
        });
        
        // Set defaults for fields with no saved value
        const defaults = {
            'fixtures-page-title': 'Fixtures & Results - Old Laurentian RFC',
            'fixtures-main-heading': 'Fixtures & Results',
            'fixtures-page-description': 'Complete fixture list and results for all Old Laurentian RFC teams',
            'fixtures-filter-label': 'Filter by Team:',
            'fixtures-all-teams-label': 'All Teams',
            'fixtures-results-title': 'Recent Results',
            'fixtures-upcoming-title': 'Upcoming Fixtures',
            'fixtures-summary1-label': 'Games Played',
            'fixtures-summary1-detail': 'This Season',
            'fixtures-summary2-label': 'Wins',
            'fixtures-summary3-label': 'Upcoming',
            'fixtures-summary3-detail': 'Next 30 days',
            'fixtures-summary4-label': 'Points Scored',
            'fixtures-summary4-detail': 'All competitions'
        };
        
        // Apply defaults and store original values
        Object.keys(defaults).forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field && !field.value) {
                field.value = defaults[fieldId];
                field.dataset.originalValue = defaults[fieldId];
            }
        });
        
        console.log('✅ Fixtures content loaded successfully');
        
    } catch (error) {
        console.error('Error loading fixtures content:', error);
    }
}

/**
 * Save homepage content - only submit changed fields
 */
async function saveHomePageContent() {
    const submitBtn = document.getElementById('save-homepage-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Checking changes...';
    
    // List of all homepage field IDs
    const fieldIds = [
        'homepage-hero-heading',
        'homepage-hero-tagline',
        'homepage-fixtures-title',
        'homepage-social-title',
        'homepage-news-title',
        'homepage-league-title',
        'homepage-calendar-title',
        'homepage-about-title',
        'homepage-findus-title',
        'homepage-training-title',
        'homepage-about-content',
        'homepage-stat1-number',
        'homepage-stat1-label',
        'homepage-stat2-number',
        'homepage-stat2-label',
        'homepage-stat3-number',
        'homepage-stat3-label',
        'homepage-stat4-number',
        'homepage-stat4-label',
        'homepage-instagram-url',
        'homepage-facebook-url',
        'homepage-league-url',
        'homepage-page-title',
        'homepage-page-description'
        // Note: League table configs now managed separately via league-tables array
    ];
    
    // Detect changed fields
    const changedFields = [];
    
    fieldIds.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            const currentValue = field.value || '';
            const originalValue = field.dataset.originalValue || '';
            
            // Normalize empty values
            const normalizedCurrent = currentValue.trim();
            const normalizedOriginal = originalValue.trim();
            
            if (normalizedCurrent !== normalizedOriginal) {
                changedFields.push({
                    name: fieldId,
                    value: currentValue
                });
                console.log(`🔄 Changed: ${fieldId}`, {old: normalizedOriginal, new: normalizedCurrent});
            }
        }
    });
    
    const changeCount = changedFields.length;
    
    if (changeCount === 0) {
        showContentAlert('info', 'ℹ️ No changes detected.');
        submitBtn.textContent = '💾 Save Homepage Content';
        submitBtn.disabled = false;
        return;
    }
    
    console.log(`📝 Saving ${changeCount} changed field(s):`, changedFields.map(f => f.name));
    
    // Build updates object from changed fields
    const updates = {};
    changedFields.forEach(field => {
        updates[field.name] = field.value;
    });
    
    // Save to Blobs (single API call)
    submitBtn.textContent = '⏳ Saving to Blobs...';
    
    try {
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to save: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to save');
        }
        
        console.log('✅ Homepage content saved to Blobs:', Object.keys(updates));

        // Log activity
        if (window.activityLogger) {
            const fieldNames = changedFields.map(f => f.name.replace('homepage-', '').replace(/-/g, ' '));
            window.activityLogger.logUpdate('site-settings', 'Homepage Content', null,
                `Updated homepage content: ${fieldNames.join(', ')} (${changeCount} field${changeCount > 1 ? 's' : ''})`);
        }

        // Update original values for change detection
        changedFields.forEach(field => {
            const fieldElement = document.getElementById(field.name);
            if (fieldElement) {
                fieldElement.dataset.originalValue = field.value;
            }
        });

        // Show success message
        showContentAlert('success', `✅ ${changeCount} field(s) saved successfully! Refresh homepage to see changes.`);
        
    } catch (error) {
        console.error('Failed to save homepage content:', error);
        showContentAlert('error', `❌ Error saving: ${error.message}`);
    }
    
    submitBtn.textContent = '💾 Save Homepage Content';
    submitBtn.disabled = false;
}

/**
 * Save fixtures page content - OLS 79
 */
async function saveFixturesPageContent() {
    const submitBtn = document.getElementById('save-fixtures-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Checking changes...';
    
    // List of all fixtures field IDs
    const fieldIds = [
        'fixtures-page-title',
        'fixtures-main-heading',
        'fixtures-page-description',
        'fixtures-filter-label',
        'fixtures-all-teams-label',
        'fixtures-results-title',
        'fixtures-upcoming-title',
        'fixtures-summary1-label',
        'fixtures-summary1-detail',
        'fixtures-summary2-label',
        'fixtures-summary3-label',
        'fixtures-summary3-detail',
        'fixtures-summary4-label',
        'fixtures-summary4-detail'
    ];
    
    // Detect changed fields
    const changedFields = [];
    
    fieldIds.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            const currentValue = field.value || '';
            const originalValue = field.dataset.originalValue || '';
            
            // Normalize empty values
            const normalizedCurrent = currentValue.trim();
            const normalizedOriginal = originalValue.trim();
            
            if (normalizedCurrent !== normalizedOriginal) {
                changedFields.push({
                    name: fieldId,
                    value: currentValue
                });
                console.log(`🔄 Changed: ${fieldId}`, {old: normalizedOriginal, new: normalizedCurrent});
            }
        }
    });
    
    const changeCount = changedFields.length;
    
    if (changeCount === 0) {
        showContentAlert('info', 'ℹ️ No changes detected.');
        submitBtn.textContent = '💾 Save Fixtures Page Content';
        submitBtn.disabled = false;
        return;
    }
    
    console.log(`📝 Saving ${changeCount} changed field(s):`, changedFields.map(f => f.name));
    
    // Build updates object from changed fields
    const updates = {};
    changedFields.forEach(field => {
        updates[field.name] = field.value;
    });
    
    // Save to Blobs (single API call)
    submitBtn.textContent = '⏳ Saving to Blobs...';
    
    try {
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to save: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to save');
        }
        
        console.log('✅ Fixtures content saved to Blobs:', Object.keys(updates));

        // Log activity
        if (window.activityLogger) {
            const fieldNames = changedFields.map(f => f.name.replace('fixtures-', '').replace(/-/g, ' '));
            window.activityLogger.logUpdate('site-settings', 'Fixtures Page Content', null,
                `Updated fixtures page content: ${fieldNames.join(', ')} (${changeCount} field${changeCount > 1 ? 's' : ''})`);
        }

        // Update original values for change detection
        changedFields.forEach(field => {
            const fieldElement = document.getElementById(field.name);
            if (fieldElement) {
                fieldElement.dataset.originalValue = field.value;
            }
        });
        
        // Show success message
        showContentAlert('success', `✅ ${changeCount} field(s) saved successfully! Refresh fixtures page to see changes.`);
        
    } catch (error) {
        console.error('Failed to save fixtures content:', error);
        showContentAlert('error', `❌ Error saving: ${error.message}`);
    }
    
    submitBtn.textContent = '💾 Save Fixtures Page Content';
    submitBtn.disabled = false;
}

async function saveNewsPageContent() {
    const submitBtn = document.getElementById('save-news-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Checking changes...';
    
    // List of all news field IDs
    const fieldIds = [
        'news-page-title',
        'news-main-heading',
        'news-page-description',
        'news-filter-all',
        'news-filter-seniors',
        'news-filter-ladies',
        'news-filter-youth',
        'news-filter-club',
        'news-filter-social',
        'news-loadmore-text'
    ];
    
    // Detect changed fields
    const changedFields = [];
    
    fieldIds.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            const currentValue = field.value || '';
            const originalValue = field.dataset.originalValue || '';
            
            // Normalize empty values
            const normalizedCurrent = currentValue.trim();
            const normalizedOriginal = originalValue.trim();
            
            if (normalizedCurrent !== normalizedOriginal) {
                changedFields.push({
                    name: fieldId,
                    value: currentValue
                });
                console.log(`🔄 Changed: ${fieldId}`, {old: normalizedOriginal, new: normalizedCurrent});
            }
        }
    });
    
    const changeCount = changedFields.length;
    
    if (changeCount === 0) {
        showContentAlert('info', 'ℹ️ No changes detected.');
        submitBtn.textContent = '💾 Save News Page Content';
        submitBtn.disabled = false;
        return;
    }
    
    console.log(`📝 Saving ${changeCount} changed field(s):`, changedFields.map(f => f.name));
    
    // Build updates object from changed fields
    const updates = {};
    changedFields.forEach(field => {
        updates[field.name] = field.value;
    });
    
    // Save to Blobs (single API call)
    submitBtn.textContent = '⏳ Saving to Blobs...';
    
    try {
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to save: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to save settings');
        }
        
        console.log('✅ News page content saved to Blobs:', Object.keys(updates));

        // Log activity
        if (window.activityLogger) {
            const fieldNames = changedFields.map(f => f.name.replace('news-', '').replace(/-/g, ' '));
            window.activityLogger.logUpdate('site-settings', 'News Page Content', null,
                `Updated news page content: ${fieldNames.join(', ')} (${changeCount} field${changeCount > 1 ? 's' : ''})`);
        }

        // Update original values in DOM
        changedFields.forEach(field => {
            const fieldElement = document.getElementById(field.name);
            if (fieldElement) {
                fieldElement.dataset.originalValue = field.value;
            }
        });
        
        // Show success message
        showContentAlert('success', `✅ ${changeCount} field(s) saved successfully! Refresh news page to see changes.`);
        
    } catch (error) {
        console.error('Failed to save news page content:', error);
        showContentAlert('error', `❌ Error saving: ${error.message}`);
    }
    
    submitBtn.textContent = '💾 Save News Page Content';
    submitBtn.disabled = false;
}

async function saveEventsPageContent() {
    const submitBtn = document.getElementById('save-events-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Checking changes...';
    
    // List of all events field IDs
    const fieldIds = [
        'events-page-title',
        'events-main-heading',
        'events-page-description',
        'events-filter-title',
        'events-filter-all',
        'events-filter-senior',
        'events-filter-junior',
        'events-filter-colts',
        'events-filter-social',
        'events-list-title',
        'events-loading-message',
        'events-empty-title',
        'events-empty-message'
    ];
    
    // Detect changed fields
    const changedFields = [];
    
    fieldIds.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            const currentValue = field.value || '';
            const originalValue = field.dataset.originalValue || '';
            
            // Normalize empty values
            const normalizedCurrent = currentValue.trim();
            const normalizedOriginal = originalValue.trim();
            
            if (normalizedCurrent !== normalizedOriginal) {
                changedFields.push({
                    name: fieldId,
                    value: currentValue
                });
                console.log(`🔄 Changed: ${fieldId}`, {old: normalizedOriginal, new: normalizedCurrent});
            }
        }
    });
    
    const changeCount = changedFields.length;
    
    if (changeCount === 0) {
        showContentAlert('info', 'ℹ️ No changes detected.');
        submitBtn.textContent = '💾 Save Events Page Content';
        submitBtn.disabled = false;
        return;
    }
    
    console.log(`📝 Saving ${changeCount} changed field(s):`, changedFields.map(f => f.name));
    
    // Build updates object from changed fields
    const updates = {};
    changedFields.forEach(field => {
        updates[field.name] = field.value;
    });
    
    // Save to Blobs (single API call)
    submitBtn.textContent = '⏳ Saving to Blobs...';
    
    try {
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to save: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to save settings');
        }
        
        console.log('✅ Events page content saved to Blobs:', Object.keys(updates));

        // Log activity
        if (window.activityLogger) {
            const fieldNames = changedFields.map(f => f.name.replace('events-', '').replace(/-/g, ' '));
            window.activityLogger.logUpdate('site-settings', 'Events Page Content', null,
                `Updated events page content: ${fieldNames.join(', ')} (${changeCount} field${changeCount > 1 ? 's' : ''})`);
        }

        // Update original values in DOM
        changedFields.forEach(field => {
            const fieldElement = document.getElementById(field.name);
            if (fieldElement) {
                fieldElement.dataset.originalValue = field.value;
            }
        });
        
        // Show success message
        showContentAlert('success', `✅ ${changeCount} field(s) saved successfully! Refresh events page to see changes.`);
        
    } catch (error) {
        console.error('Failed to save events page content:', error);
        showContentAlert('error', `❌ Error saving: ${error.message}`);
    }
    
    submitBtn.textContent = '💾 Save Events Page Content';
    submitBtn.disabled = false;
}

// ============================================================================
// OLS 124: CALENDAR CONFIGURATION FUNCTIONS
// ============================================================================

// State for calendar configuration (fixture colours now driven by club-sections)
let calendarConfig = {
    additionalCalendars: [],
    fixturesCalendarId: ''
};

// Default additional calendars
const defaultAdditionalCalendars = [
    { id: 'social', label: 'Social Events', calendarId: '', color: '#fb8c00', enabled: true },
    { id: 'tv', label: 'TV Fixtures', calendarId: '', color: '#8e24aa', enabled: false }
];

// Load calendar configuration when accordion opens
async function loadCalendarConfiguration() {
    console.log('📅 Loading calendar configuration...');
    
    try {
        // Load from site-settings
        const response = await fetch('/.netlify/functions/site-settings');
        const result = await response.json();
        const settings = result.data || {};
        
        // Parse additional calendars
        if (settings['calendar-additional-sources']) {
            try {
                calendarConfig.additionalCalendars = JSON.parse(settings['calendar-additional-sources']);
            } catch (e) {
                calendarConfig.additionalCalendars = [...defaultAdditionalCalendars];
            }
        } else {
            calendarConfig.additionalCalendars = [...defaultAdditionalCalendars];
        }
        
        // Fixtures calendar ID
        calendarConfig.fixturesCalendarId = settings['calendar-fixtures-id'] || '';
        
        // Render additional calendars
        renderAdditionalCalendars();
        
        // Set fixtures calendar ID
        const fixturesIdField = document.getElementById('calendar-fixtures-id');
        if (fixturesIdField) {
            fixturesIdField.value = calendarConfig.fixturesCalendarId;
        }
        
        console.log('✅ Calendar configuration loaded:', calendarConfig);
        
    } catch (error) {
        console.error('❌ Error loading calendar configuration:', error);
        // Use defaults on error
        calendarConfig.additionalCalendars = [...defaultAdditionalCalendars];
        renderAdditionalCalendars();
    }
}

// Render Additional Calendars
function renderAdditionalCalendars() {
    const container = document.getElementById('additional-calendars-container');
    if (!container) return;
    
    if (calendarConfig.additionalCalendars.length === 0) {
        container.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No additional calendars configured.</p>';
        return;
    }
    
    container.innerHTML = calendarConfig.additionalCalendars.map((cal, index) => `
        <div class="additional-calendar-item" data-index="${index}" style="padding: 1rem; background: white; border-radius: 8px; border: 2px solid ${cal.enabled ? '#4caf50' : '#e0e0e0'};">
            <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                <!-- Color Picker -->
                <input type="color" value="${cal.color}" onchange="updateAdditionalCalendar(${index}, 'color', this.value)" 
                       style="width: 50px; height: 40px; border: none; cursor: pointer; border-radius: 4px;">
                
                <!-- Label Input -->
                <input type="text" value="${cal.label}" onchange="updateAdditionalCalendar(${index}, 'label', this.value)"
                       placeholder="Calendar name (e.g., Social Events)"
                       style="padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                
                <!-- Enable/Disable Toggle -->
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" ${cal.enabled ? 'checked' : ''} onchange="updateAdditionalCalendar(${index}, 'enabled', this.checked)"
                           style="width: 20px; height: 20px; cursor: pointer;">
                    <span style="font-weight: bold; color: ${cal.enabled ? '#4caf50' : '#9e9e9e'};">
                        ${cal.enabled ? 'Enabled' : 'Disabled'}
                    </span>
                </label>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: center;">
                <!-- Calendar ID Input -->
                <input type="text" value="${cal.calendarId || ''}" onchange="updateAdditionalCalendar(${index}, 'calendarId', this.value)"
                       placeholder="Google Calendar ID (e.g., email@gmail.com or abc123@group.calendar.google.com)"
                       style="padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.9rem; font-family: monospace;">
                
                <!-- Delete Button -->
                <button type="button" onclick="removeAdditionalCalendar(${index})" 
                        style="padding: 0.5rem 1rem; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                    🗑️
                </button>
            </div>
        </div>
    `).join('');
}

// Add a new additional calendar
function addAdditionalCalendar() {
    calendarConfig.additionalCalendars.push({
        id: 'calendar_' + Date.now(),
        label: 'New Calendar',
        calendarId: '',
        color: '#607d8b',
        enabled: false
    });
    renderAdditionalCalendars();
}

// Update an additional calendar property
function updateAdditionalCalendar(index, property, value) {
    if (calendarConfig.additionalCalendars[index]) {
        calendarConfig.additionalCalendars[index][property] = value;
        
        // Re-render if enabled state changed (for border color)
        if (property === 'enabled') {
            renderAdditionalCalendars();
        }
    }
}

// Remove an additional calendar
function removeAdditionalCalendar(index) {
    const cal = calendarConfig.additionalCalendars[index];
    if (confirm(`Remove "${cal.label}"?`)) {
        calendarConfig.additionalCalendars.splice(index, 1);
        renderAdditionalCalendars();
    }
}

// Save Calendar Configuration
async function saveCalendarConfiguration() {
    const submitBtn = document.getElementById('save-calendar-config-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Saving...';
    
    try {
        // Get fixtures calendar ID
        const fixturesId = document.getElementById('calendar-fixtures-id')?.value || '';
        
        // Build updates object (fixture colours now driven by club-sections)
        const updates = {
            'calendar-additional-sources': JSON.stringify(calendarConfig.additionalCalendars),
            'calendar-fixtures-id': fixturesId
        };
        
        // Save to Netlify Blobs
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to save: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to save settings');
        }
        
        // Update local cache
        calendarConfig.fixturesCalendarId = fixturesId;
        
        // Also update localStorage for immediate frontend use
        const cachedSettings = localStorage.getItem('olrfc_site-settings');
        if (cachedSettings) {
            try {
                const settings = JSON.parse(cachedSettings);
                Object.assign(settings, updates);
                localStorage.setItem('olrfc_site-settings', JSON.stringify(settings));
            } catch (e) {
                console.warn('Failed to update localStorage cache');
            }
        }
        
        console.log('✅ Calendar configuration saved:', updates);
        showContentAlert('success', '✅ Calendar configuration saved! Refresh the website to see changes.');
        
    } catch (error) {
        console.error('❌ Error saving calendar configuration:', error);
        showContentAlert('error', `❌ Error saving: ${error.message}`);
    }
    
    submitBtn.textContent = '💾 Save Calendar Configuration';
    submitBtn.disabled = false;
}

// Initialize calendar config when accordion opens
document.addEventListener('DOMContentLoaded', () => {
    const calendarAccordion = document.getElementById('calendar-config-accordion');
    if (calendarAccordion) {
        calendarAccordion.addEventListener('toggle', (e) => {
            if (e.target.open) {
                loadCalendarConfiguration();
            }
        });
    }
    
});

// ============================================================================
// END OLS 124: CALENDAR CONFIGURATION FUNCTIONS
// ============================================================================

async function saveGalleryPageContent() {
    const submitBtn = document.getElementById('save-gallery-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Checking changes...';
    
    // List of all gallery field IDs
    const fieldIds = [
        'gallery-page-title',
        'gallery-main-heading',
        'gallery-page-description',
        'gallery-loading-message',
        'gallery-team-filter-label',
        'gallery-season-filter-label',
        'gallery-sort-label',
        'gallery-team-all',
        'gallery-team-mens1st',
        'gallery-team-mens2nd',
        'gallery-team-ladies',
        'gallery-team-colts',
        'gallery-team-other',
        'gallery-season-all',
        'gallery-sort-newest',
        'gallery-sort-oldest',
        'gallery-empty-title',
        'gallery-empty-message',
        'gallery-credit-title',
        'gallery-photographer-name',
        'gallery-credit-message',
        'gallery-photographer-instagram-url',
        'gallery-photographer-instagram-label',
        'gallery-photographer-facebook-url',
        'gallery-photographer-facebook-label',
        'gallery-photographer-email',
        'gallery-photographer-email-label'
    ];
    
    // Detect changed fields
    const changedFields = [];
    
    fieldIds.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            const currentValue = field.value || '';
            const originalValue = field.dataset.originalValue || '';
            
            // Normalize empty values
            const normalizedCurrent = currentValue.trim();
            const normalizedOriginal = originalValue.trim();
            
            if (normalizedCurrent !== normalizedOriginal) {
                changedFields.push({
                    name: fieldId,
                    value: currentValue
                });
                console.log(`🔄 Changed: ${fieldId}`, {old: normalizedOriginal, new: normalizedCurrent});
            }
        }
    });
    
    const changeCount = changedFields.length;
    
    if (changeCount === 0) {
        showContentAlert('info', 'ℹ️ No changes detected.');
        submitBtn.textContent = '💾 Save Gallery Page Content';
        submitBtn.disabled = false;
        return;
    }
    
    console.log(`📝 Saving ${changeCount} changed field(s):`, changedFields.map(f => f.name));
    
    // Build updates object from changed fields
    const updates = {};
    changedFields.forEach(field => {
        updates[field.name] = field.value;
    });
    
    // Save to Blobs (single API call)
    submitBtn.textContent = '⏳ Saving to Blobs...';
    
    try {
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to save: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to save');
        }
        
        console.log('✅ Gallery content saved to Blobs:', Object.keys(updates));

        // Log activity
        if (window.activityLogger) {
            const fieldNames = changedFields.map(f => f.name.replace('gallery-', '').replace(/-/g, ' '));
            window.activityLogger.logUpdate('site-settings', 'Gallery Page Content', null,
                `Updated gallery page content: ${fieldNames.join(', ')} (${changeCount} field${changeCount > 1 ? 's' : ''})`);
        }

        // Update original values for change detection
        changedFields.forEach(field => {
            const fieldElement = document.getElementById(field.name);
            if (fieldElement) {
                fieldElement.dataset.originalValue = field.value;
            }
        });
        
        // Show success message
        showContentAlert('success', `✅ ${changeCount} field(s) saved successfully! Refresh gallery page to see changes.`);
        
    } catch (error) {
        console.error('Failed to save gallery content:', error);
        showContentAlert('error', `❌ Error saving: ${error.message}`);
    }
    
    submitBtn.textContent = '💾 Save Gallery Page Content';
    submitBtn.disabled = false;
}

/**
 * Load contacts page content - OLS 80
 */
async function loadContactsPageContent() {
    console.log('📥 Loading contacts page content...');
    
    try {
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'GET'
        });
        
        if (!response.ok) {
            console.log('Using default contacts content');
            return;
        }
        
        const result = await response.json();
        const settings = result.data || {};
        
        // Build Map from Blobs object (already has latest values)
        const contentMap = new Map();
        
        Object.entries(settings).forEach(([name, value]) => {
            // Only process contacts content settings
            if (name?.startsWith('contacts-')) {
                contentMap.set(name, value);
            }
        });
        
        console.log(`✅ Loaded ${contentMap.size} contacts content fields`);
        
        // Populate form fields with loaded values
        contentMap.forEach((value, name) => {
            const field = document.getElementById(name);
            if (field) {
                field.value = value || '';
                field.dataset.originalValue = value || '';
            }
        });
        
        // Set defaults for fields with no saved value
        const defaults = {
            'contacts-page-title': 'Club Contacts - Old Laurentian RFC',
            'contacts-main-heading': 'Club Committee Contacts',
            'contacts-page-description': 'Our dedicated committee members are here to help. Find the right person for your enquiry below.',
            'contacts-location-heading': '📍 Club Address',
            'contacts-venue-name': 'Fenley Field',
            'contacts-venue-street': 'Lime Tree Avenue',
            'contacts-venue-city': 'Rugby, Warwickshire, CV22 7QT',
            'contacts-training-heading': '⏰ Training Times',
            // OLS 117: Tuesday/Thursday schedule fields removed - now managed via Teams
            'contacts-loading-message': 'Loading contacts...',
            'contacts-empty-title': 'No Contacts Available',
            'contacts-empty-message': 'Contact information will be displayed here once added by club administrators.',
            'contacts-no-info-message': 'Contact via club for details'
        };
        
        // Apply defaults
        Object.keys(defaults).forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field && !field.value) {
                field.value = defaults[fieldId];
                field.dataset.originalValue = defaults[fieldId];
            }
        });
        
        console.log('✅ Contacts content loaded successfully');
        
    } catch (error) {
        console.error('Error loading contacts content:', error);
    }
}

/**
 * Save contacts page content - OLS 80
 */
async function saveContactsPageContent() {
    const submitBtn = document.getElementById('save-contacts-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Checking changes...';
    
    // List of all contacts field IDs
    const fieldIds = [
        'contacts-page-title',
        'contacts-main-heading',
        'contacts-page-description',
        'contacts-location-heading',
        'contacts-venue-name',
        'contacts-venue-street',
        'contacts-venue-city',
        'contacts-training-heading',
        // OLS 117: Tuesday/Thursday schedule fields removed - now managed via Teams
        'contacts-loading-message',
        'contacts-empty-title',
        'contacts-empty-message',
        'contacts-no-info-message'
    ];
    
    // Detect changed fields
    const changedFields = [];
    
    fieldIds.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            const currentValue = field.value || '';
            const originalValue = field.dataset.originalValue || '';
            
            // Normalize empty values
            const normalizedCurrent = currentValue.trim();
            const normalizedOriginal = originalValue.trim();
            
            if (normalizedCurrent !== normalizedOriginal) {
                changedFields.push({
                    name: fieldId,
                    value: currentValue
                });
                console.log(`🔄 Changed: ${fieldId}`, {old: normalizedOriginal, new: normalizedCurrent});
            }
        }
    });
    
    const changeCount = changedFields.length;
    
    if (changeCount === 0) {
        showContentAlert('info', 'ℹ️ No changes detected.');
        submitBtn.textContent = '💾 Save Contacts Page Content';
        submitBtn.disabled = false;
        return;
    }
    
    console.log(`📝 Saving ${changeCount} changed field(s):`, changedFields.map(f => f.name));
    
    // Build updates object from changed fields
    const updates = {};
    changedFields.forEach(field => {
        updates[field.name] = field.value;
    });
    
    // Save to Blobs (single API call)
    submitBtn.textContent = '⏳ Saving to Blobs...';
    
    try {
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to save: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to save');
        }
        
        console.log('✅ Contacts content saved to Blobs:', Object.keys(updates));

        // Log activity
        if (window.activityLogger) {
            const fieldNames = changedFields.map(f => f.name.replace('contacts-', '').replace(/-/g, ' '));
            window.activityLogger.logUpdate('site-settings', 'Contacts Page Content', null,
                `Updated contacts page content: ${fieldNames.join(', ')} (${changeCount} field${changeCount > 1 ? 's' : ''})`);
        }

        // Update original values for change detection
        changedFields.forEach(field => {
            const fieldElement = document.getElementById(field.name);
            if (fieldElement) {
                fieldElement.dataset.originalValue = field.value;
            }
        });
        
        // Show success message
        showContentAlert('success', `✅ ${changeCount} field(s) saved successfully! Refresh contacts page to see changes.`);
        
    } catch (error) {
        console.error('Failed to save contacts content:', error);
        showContentAlert('error', `❌ Error saving: ${error.message}`);
    }
    
    submitBtn.textContent = '💾 Save Contacts Page Content';
    submitBtn.disabled = false;
}

/**
 * Load Teams Page content from Netlify Blobs (OLS 119)
 */
async function loadTeamsPageContent() {
    try {
        console.log('📥 Loading teams page content...');
        
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'GET'
        });
        
        if (!response.ok) {
            console.log('Using default teams content');
            return;
        }
        
        const result = await response.json();
        const settings = result.data || {};
        
        // Populate teams page fields
        const teamsFields = [
            'teams-page-title',
            'teams-main-heading',
            'teams-page-description'
        ];
        
        teamsFields.forEach(fieldId => {
            const element = document.getElementById(fieldId);
            if (element && settings[fieldId]) {
                element.value = settings[fieldId];
                element.dataset.originalValue = settings[fieldId];
            }
        });
        
        console.log('✅ Teams page content loaded');
        
    } catch (error) {
        console.error('❌ Error loading teams page content:', error);
    }
}

/**
 * Save Teams Page content to Netlify Blobs (OLS 119)
 */
async function saveTeamsPageContent() {
    const submitBtn = document.getElementById('save-teams-btn');
    const originalText = submitBtn.textContent;
    
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Saving...';
    
    try {
        // Collect all teams page fields
        const teamsFields = [
            'teams-page-title',
            'teams-main-heading',
            'teams-page-description'
        ];
        
        // Build updates object with only changed values
        const updates = {};
        let changeCount = 0;
        
        teamsFields.forEach(fieldId => {
            const element = document.getElementById(fieldId);
            if (element) {
                const currentValue = element.value.trim();
                const originalValue = element.dataset.originalValue || '';
                
                if (currentValue && currentValue !== originalValue) {
                    updates[fieldId] = currentValue;
                    changeCount++;
                }
            }
        });
        
        if (changeCount === 0) {
            showContentAlert('info', 'ℹ️ No changes detected.');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            return;
        }
        
        console.log(`📝 Saving ${changeCount} teams page field(s):`, updates);
        
        // Save to Netlify Blobs
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            // Update localStorage cache
            const cached = JSON.parse(localStorage.getItem('olrfc_site-settings') || '{}');
            Object.assign(cached, updates);
            localStorage.setItem('olrfc_site-settings', JSON.stringify(cached));
            
            // Update original values for change detection
            Object.keys(updates).forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.dataset.originalValue = updates[fieldId];
                }
            });
            
            showContentAlert('success', `✅ ${changeCount} field(s) saved! Refresh teams page to see changes.`);
            console.log('✅ Teams page content saved to Netlify Blobs');

            // Log activity
            if (window.activityLogger) {
                const fieldNames = Object.keys(updates).map(f => f.replace('teams-', '').replace(/-/g, ' '));
                window.activityLogger.logUpdate('site-settings', 'Teams Page Content', null,
                    `Updated teams page content: ${fieldNames.join(', ')} (${changeCount} field${changeCount > 1 ? 's' : ''})`);
            }
        } else {
            throw new Error(result.error || 'Unknown error');
        }
        
    } catch (error) {
        console.error('❌ Error saving teams page content:', error);
        showContentAlert('error', `❌ Error saving: ${error.message}`);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}

/**
 * Load sponsors page content - OLS 80
 */
async function loadSponsorsPageContent() {
    console.log('📥 Loading sponsors page content...');
    
    try {
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'GET'
        });
        
        if (!response.ok) {
            console.log('Using default sponsors content');
            return;
        }
        
        const result = await response.json();
        const settings = result.data || {};
        
        // Build Map from Blobs object (already has latest values)
        const contentMap = new Map();
        
        Object.entries(settings).forEach(([name, value]) => {
            // Only process sponsors content settings
            if (name?.startsWith('sponsors-')) {
                contentMap.set(name, value);
            }
        });
        
        console.log(`✅ Loaded ${contentMap.size} sponsors content fields`);
        
        // Populate form fields with loaded values
        contentMap.forEach((value, name) => {
            const field = document.getElementById(name);
            if (field) {
                field.value = value || '';
                field.dataset.originalValue = value || '';
            }
        });
        
        // Set defaults for fields with no saved value
        const defaults = {
            'sponsors-page-title': 'Our Sponsors - Old Laurentian RFC',
            'sponsors-main-heading': 'Our Sponsors',
            'sponsors-page-description': 'Thank you to our sponsors for supporting Old Laurentian RFC',
            'sponsors-list-title': 'Our Sponsors',
            'sponsors-loading-message': 'Loading sponsors...',
            'sponsors-empty-icon': '🤝',
            'sponsors-empty-text': 'No sponsors to display at this time.',
            'sponsors-card-website-label': 'Visit Website',
            'sponsors-modal-phone-label': 'Phone',
            'sponsors-modal-email-label': 'Email',
            'sponsors-modal-website-label': 'Website'
        };
        
        // Apply defaults
        Object.keys(defaults).forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field && !field.value) {
                field.value = defaults[fieldId];
                field.dataset.originalValue = defaults[fieldId];
            }
        });
        
        console.log('✅ Sponsors content loaded successfully');
        
    } catch (error) {
        console.error('Error loading sponsors content:', error);
    }
}

/**
 * Save sponsors page content - OLS 80
 */
async function saveSponsorsPageContent() {
    const submitBtn = document.getElementById('save-sponsors-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Checking changes...';
    
    // List of all sponsors field IDs
    const fieldIds = [
        'sponsors-page-title',
        'sponsors-main-heading',
        'sponsors-page-description',
        'sponsors-list-title',
        'sponsors-loading-message',
        'sponsors-empty-icon',
        'sponsors-empty-text',
        'sponsors-card-website-label',
        'sponsors-modal-phone-label',
        'sponsors-modal-email-label',
        'sponsors-modal-website-label'
    ];
    
    // Detect changed fields
    const changedFields = [];
    
    fieldIds.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            const currentValue = field.value || '';
            const originalValue = field.dataset.originalValue || '';
            
            // Normalize empty values
            const normalizedCurrent = currentValue.trim();
            const normalizedOriginal = originalValue.trim();
            
            if (normalizedCurrent !== normalizedOriginal) {
                changedFields.push({
                    name: fieldId,
                    value: currentValue
                });
                console.log(`🔄 Changed: ${fieldId}`, {old: normalizedOriginal, new: normalizedCurrent});
            }
        }
    });
    
    const changeCount = changedFields.length;
    
    if (changeCount === 0) {
        showContentAlert('info', 'ℹ️ No changes detected.');
        submitBtn.textContent = '💾 Save Sponsors Page Content';
        submitBtn.disabled = false;
        return;
    }
    
    console.log(`📝 Saving ${changeCount} changed field(s):`, changedFields.map(f => f.name));
    
    // Build updates object from changed fields
    const updates = {};
    changedFields.forEach(field => {
        updates[field.name] = field.value;
    });
    
    // Save to Blobs (single API call)
    submitBtn.textContent = '⏳ Saving to Blobs...';
    
    try {
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to save: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to save');
        }
        
        console.log('✅ Sponsors content saved to Blobs:', Object.keys(updates));

        // Log activity
        if (window.activityLogger) {
            const fieldNames = changedFields.map(f => f.name.replace('sponsors-', '').replace(/-/g, ' '));
            window.activityLogger.logUpdate('site-settings', 'Sponsors Page Content', null,
                `Updated sponsors page content: ${fieldNames.join(', ')} (${changeCount} field${changeCount > 1 ? 's' : ''})`);
        }

        // Update original values for change detection
        changedFields.forEach(field => {
            const fieldElement = document.getElementById(field.name);
            if (fieldElement) {
                fieldElement.dataset.originalValue = field.value;
            }
        });
        
        // Show success message
        showContentAlert('success', `✅ ${changeCount} field(s) saved successfully! Refresh sponsors page to see changes.`);
        
    } catch (error) {
        console.error('Failed to save sponsors content:', error);
        showContentAlert('error', `❌ Error saving: ${error.message}`);
    }
    
    submitBtn.textContent = '💾 Save Sponsors Page Content';
    submitBtn.disabled = false;
}

/**
 * Load VP Wall page content from site settings (OLS 114)
 */
async function loadVPWallPageContent() {
    console.log('📥 Loading VP Wall page content...');
    
    try {
        const response = await fetch('/.netlify/functions/site-settings');
        if (!response.ok) throw new Error('Failed to fetch settings');
        
        const result = await response.json();
        const settings = result.data || {};
        
        // Field mappings for VP Wall page
        const fieldMappings = {
            'vpwall-page-title': 'Vice Presidents Wall - Old Laurentian RFC',
            'vpwall-main-heading': '🧱 Vice Presidents Wall',
            'vpwall-page-subtitle': 'Honoring those who have served our club with distinction',
            'vpwall-intro-text': 'Each brick represents a Vice President who has dedicated their time and passion to our club. Their names are forever etched in our club\'s history.',
            'vpwall-plaque-text': 'Vice Presidents',
            'vpwall-empty-heading': 'No Vice Presidents Yet',
            'vpwall-empty-text': 'The wall awaits its first brick.'
        };
        
        // Populate fields
        Object.keys(fieldMappings).forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                const value = settings[fieldId] || '';
                field.value = value;
                field.placeholder = fieldMappings[fieldId];
                field.dataset.originalValue = value;
            }
        });
        
        console.log('✅ VP Wall page content loaded');
        
    } catch (error) {
        console.error('Error loading VP Wall page content:', error);
    }
}

/**
 * Save VP Wall page content to site settings (OLS 114)
 */
async function saveVPWallPageContent() {
    const submitBtn = document.getElementById('save-vpwall-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = '⏳ Checking changes...';
    
    // All VP Wall field IDs
    const fieldIds = [
        'vpwall-page-title',
        'vpwall-main-heading',
        'vpwall-page-subtitle',
        'vpwall-intro-text',
        'vpwall-plaque-text',
        'vpwall-empty-heading',
        'vpwall-empty-text'
    ];
    
    // Detect changed fields
    const changedFields = [];
    
    fieldIds.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            const currentValue = field.value || '';
            const originalValue = field.dataset.originalValue || '';
            
            const normalizedCurrent = currentValue.trim();
            const normalizedOriginal = originalValue.trim();
            
            if (normalizedCurrent !== normalizedOriginal) {
                changedFields.push({
                    name: fieldId,
                    value: currentValue
                });
                console.log(`🔄 Changed: ${fieldId}`, {old: normalizedOriginal, new: normalizedCurrent});
            }
        }
    });
    
    const changeCount = changedFields.length;
    
    if (changeCount === 0) {
        showContentAlert('info', 'ℹ️ No changes detected.');
        submitBtn.textContent = '💾 Save VP Wall Page Content';
        submitBtn.disabled = false;
        return;
    }
    
    console.log(`📝 Saving ${changeCount} changed field(s):`, changedFields.map(f => f.name));
    
    // Build updates object
    const updates = {};
    changedFields.forEach(field => {
        updates[field.name] = field.value;
    });
    
    submitBtn.textContent = '⏳ Saving to Blobs...';
    
    try {
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to save: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to save');
        }
        
        console.log('✅ VP Wall content saved to Blobs:', Object.keys(updates));

        // Log activity
        if (window.activityLogger) {
            const fieldNames = changedFields.map(f => f.name.replace('vpwall-', '').replace(/-/g, ' '));
            window.activityLogger.logUpdate('site-settings', 'VP Wall Page Content', null,
                `Updated VP Wall page content: ${fieldNames.join(', ')} (${changeCount} field${changeCount > 1 ? 's' : ''})`);
        }

        // Update original values
        changedFields.forEach(field => {
            const fieldElement = document.getElementById(field.name);
            if (fieldElement) {
                fieldElement.dataset.originalValue = field.value;
            }
        });

        showContentAlert('success', `✅ ${changeCount} field(s) saved successfully! Refresh VP Wall page to see changes.`);
        
    } catch (error) {
        console.error('Failed to save VP Wall content:', error);
        showContentAlert('error', `❌ Error saving: ${error.message}`);
    }
    
    submitBtn.textContent = '💾 Save VP Wall Page Content';
    submitBtn.disabled = false;
}

/**
 * Show alert message in content management section
 */
function showContentAlert(type, message) {
    const alertDiv = document.getElementById('content-management-alert');
    alertDiv.style.display = 'block';
    alertDiv.className = `alert alert-${type}`;
    alertDiv.innerHTML = message;
    alertDiv.style.padding = '1rem';
    alertDiv.style.borderRadius = '10px';
    alertDiv.style.marginTop = '1rem';
    
    if (type === 'success') {
        alertDiv.style.background = 'linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.1), rgba(var(--primary-green-rgb), 0.05))';
        alertDiv.style.border = '2px solid var(--primary-green)';
        alertDiv.style.color = 'var(--primary-green)';
    } else if (type === 'info') {
        alertDiv.style.background = 'rgba(33, 150, 243, 0.1)';
        alertDiv.style.border = '2px solid #2196F3';
        alertDiv.style.color = '#1976D2';
    } else if (type === 'error') {
        alertDiv.style.background = 'rgba(244, 67, 54, 0.1)';
        alertDiv.style.border = '2px solid #f44336';
        alertDiv.style.color = '#d32f2f';
    }
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        alertDiv.style.display = 'none';
    }, 5000);
}

/**
 * Load homepage content when Content Management section is shown
 */
const originalShowSectionForContent = showSection;
showSection = function(sectionId) {
    originalShowSectionForContent(sectionId);
    
    if (sectionId === 'content-management') {
        // Check if already loaded
        const heroHeading = document.getElementById('homepage-hero-heading');
        if (heroHeading && !heroHeading.dataset.loaded) {
            loadHomePageContent();
            loadFixturesPageContent();
            loadContactsPageContent();
            loadSponsorsPageContent();
            loadTeamsPageContent();
            loadVPWallPageContent();
            heroHeading.dataset.loaded = 'true';
        }
    }
};

// ============================================
// END CONTENT MANAGEMENT FUNCTIONS
// ============================================

// ============================================
// END SITE CUSTOMIZATION FUNCTIONS
// ============================================

    </script>

    <!-- Hidden Netlify Forms for Data Persistence -->
<!-- Add these forms to your admin-dashboard.html, preferably near the end of the body, before the closing </body> tag -->

<!-- Fixtures Form -->
<form name="olrfc-fixtures" netlify netlify-honeypot="bot-field" hidden>
  <input type="hidden" name="bot-field" />
  <input type="text" name="id" />
  <input type="text" name="team" />
  <input type="text" name="opponent" />
  <input type="datetime-local" name="dateTime" />
  <input type="text" name="venue" />
  <input type="text" name="competition" />
  <input type="number" name="ourScore" />
  <input type="number" name="theirScore" />
  <input type="text" name="status" />
  <input type="text" name="createdAt" />
  <input type="text" name="updatedAt" />
</form>

<!-- Hidden Form: Site Settings -->
<form name="olrfc-site-settings" netlify netlify-honeypot="bot-field" hidden>
  <input type="hidden" name="form-name" value="olrfc-site-settings" />
  <input type="text" name="setting-name" />
  <input type="text" name="setting-value" />
  <input type="text" name="updated-by" />
  <input type="text" name="updated-at" />
  <input type="text" name="timestamp" />
</form>

<!-- News Form -->
<form name="olrfc-news" netlify netlify-honeypot="bot-field" hidden>
  <input type="hidden" name="bot-field" />
  <input type="text" name="id" />
  <input type="text" name="title" />
  <textarea name="content"></textarea>
  <input type="text" name="category" />
  <input type="text" name="author" />
  <input type="text" name="date" />
  <input type="checkbox" name="featured" />
  <input type="text" name="createdAt" />
  <input type="text" name="updatedAt" />
</form>

<!-- Players Form -->
<form name="olrfc-players" netlify netlify-honeypot="bot-field" hidden>
  <input type="hidden" name="bot-field" />
  <input type="text" name="id" />
  <input type="text" name="name" />
  <input type="text" name="team" />
  <input type="text" name="position" />
  <input type="number" name="appearances" />
  <input type="text" name="photo" />
  <input type="text" name="createdAt" />
  <input type="text" name="updatedAt" />
</form>

<!-- Sponsors Form -->
<form name="olrfc-sponsors" netlify netlify-honeypot="bot-field" hidden>
  <input type="hidden" name="bot-field" />
  <input type="text" name="id" />
  <input type="text" name="name" />
  <input type="text" name="tier" />
  <input type="text" name="logo" />
  <input type="url" name="website" />
  <input type="tel" name="phone" />
  <input type="email" name="email" />
  <input type="checkbox" name="active" />
  <input type="checkbox" name="showInBanner" />
  <input type="text" name="createdAt" />
  <input type="text" name="updatedAt" />
</form>

<!-- Contacts Form -->
<!-- ADD THIS AFTER LINE 6387 in admin-dashboard.html (after sponsors form, before gallery form) -->
<form name="olrfc-contacts" netlify netlify-honeypot="bot-field" hidden>
  <input type="hidden" name="bot-field" />
  <input type="text" name="id" />
  <input type="text" name="name" />
  <input type="text" name="role" />
  <input type="text" name="category" />
  <input type="text" name="categoryColor" />
  <input type="text" name="categoryEmoji" />
  <input type="email" name="email" />
  <input type="tel" name="phone" />
  <input type="text" name="photo" />
  <textarea name="bio"></textarea>
  <input type="number" name="displayOrder" />
  <input type="checkbox" name="active" />
  <input type="text" name="createdAt" />
  <input type="text" name="updatedAt" />
</form>

<!-- Gallery Form -->
<form name="olrfc-gallery" netlify netlify-honeypot="bot-field" hidden>
  <input type="hidden" name="bot-field" />
  <input type="text" name="id" />
  <input type="text" name="title" />
  <input type="text" name="category" />
  <input type="text" name="team" />
  <input type="text" name="fixtureId" />
  <textarea name="description"></textarea>
  <input type="text" name="date" />
  <input type="number" name="photoCount" />
  <textarea name="photos"></textarea>
  <input type="text" name="albumTag" />
  <input type="text" name="createdAt" />
  <input type="text" name="updatedAt" />
</form>

<!-- Shop Form -->
<form name="olrfc-shop" netlify netlify-honeypot="bot-field" hidden>
  <input type="hidden" name="bot-field" />
  <input type="text" name="id" />
  <input type="text" name="name" />
  <input type="text" name="category" />
  <input type="number" name="price" step="0.01" />
  <input type="number" name="stock" />
  <textarea name="description"></textarea>
  <textarea name="images"></textarea>
  <textarea name="sizes"></textarea>
  <input type="text" name="status" />
  <input type="text" name="createdAt" />
  <input type="text" name="updatedAt" />
</form>

<!-- Team Data Form -->
<form name="olrfc-teams" netlify netlify-honeypot="bot-field" hidden>
  <input type="hidden" name="bot-field" />
  <input type="text" name="id" />
  <input type="text" name="name" />
  <input type="text" name="slug" />
  <input type="text" name="ageGroup" />
  <textarea name="description"></textarea>
  <input type="text" name="photo" />
  <input type="text" name="createdAt" />
</form>

<!-- Team Filters Form -->
<form name="olrfc-team-filters" netlify netlify-honeypot="bot-field" hidden>
  <input type="hidden" name="bot-field" />
  <input type="text" name="id" />
  <input type="text" name="name" />
  <textarea name="description"></textarea>
  <textarea name="teamSlugs"></textarea>
  <input type="text" name="enabled" />
  <input type="number" name="order" />
  <input type="text" name="createdAt" />
</form>

<!-- ============================================================================ -->
<!-- ADMIN HEADER CUSTOMIZATION LOADER - OLS 95 -->
<!-- Loads custom logo and club name from Netlify Blobs (white-label ready) -->
<!-- Logo is hidden by default, only shows when custom logo uploaded -->
<!-- ============================================================================ -->
<script>
(async function() {
    try {
        console.log('🎨 Loading custom branding for admin dashboard header...');
        
        // Fetch site settings
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'GET'
        });
        
        if (!response.ok) {
            console.log('⚠️ Site settings not available, using defaults (no logo)');
            return;
        }
        
        const result = await response.json();
        const settings = result.data || {};
        
        console.log('📊 Site settings loaded, checking for logo and club name...');
        
        // Apply custom logo ONLY if one exists
        const logoUrl = settings['logo-url'];
        const logoImg = document.getElementById('admin-header-logo');
        
        if (logoUrl && logoImg) {
            // Set up error handler first
            logoImg.onerror = function() {
                console.warn('⚠️ Failed to load custom logo, hiding logo element');
                this.style.display = 'none';
                this.onerror = null;
            };
            
            // Load and show the custom logo
            logoImg.onload = function() {
                console.log('✅ Custom logo loaded successfully');
                this.style.display = 'block';
            };
            
            logoImg.src = logoUrl;
            console.log('📤 Loading custom logo from Cloudinary...');
            
            // ALSO update the logo preview in Site Customization section
            const logoPreview = document.getElementById('logo-preview');
            const logoPreviewPlaceholder = document.getElementById('logo-preview-placeholder');
            if (logoPreview && logoPreviewPlaceholder) {
                logoPreview.src = logoUrl;
                logoPreview.style.display = 'block';
                logoPreviewPlaceholder.style.display = 'none';
                logoPreview.dataset.cloudinaryUrl = logoUrl; // Store for uploadLogo function
                console.log('✅ Logo preview updated in Site Customization');
            }
            
        } else {
            console.log('ℹ️ No custom logo uploaded yet - logo hidden (white-label ready)');
            if (logoImg) {
                logoImg.style.display = 'none';
            }
        }
        
        // Apply custom club name if set
        const clubName = settings['club-name'];
        if (clubName) {
            const clubNameEl = document.getElementById('admin-header-club-name');
            if (clubNameEl) {
                clubNameEl.textContent = clubName;
                console.log('✅ Custom club name applied to admin header:', clubName);
            }
        } else {
            console.log('ℹ️ No custom club name set, using default');
        }
        
    } catch (error) {
        console.error('❌ Error loading admin header customization:', error);
        console.log('ℹ️ Logo hidden, using default club name');
    }
})();
</script>

<!-- Add/Edit Admin User Modal (OLS 97) -->
<div id="adminUserModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2 id="adminModalTitle">➕ Add New Admin</h2>
            <span class="close" onclick="closeAdminUserModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="adminUserForm" onsubmit="saveAdminUser(event)">
                <input type="hidden" id="adminUserId">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="adminUsername">Username *</label>
                        <input type="text" id="adminUsername" required placeholder="e.g. john.smith">
                        <small>Display name for this admin user</small>
                    </div>

                    <div class="form-group">
                        <label for="adminUserEmail">Email Address *</label>
                        <input type="email" id="adminUserEmail" required placeholder="john.smith@example.com">
                        <small>Used as login username</small>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group" id="passwordGroup">
                        <label for="adminUserPassword">Password *</label>
                        <input type="password" id="adminUserPassword" placeholder="Enter secure password" minlength="8">
                        <small>Minimum 8 characters</small>
                    </div>

                    <div class="form-group">
                        <label for="adminUserRole">Role *</label>
                        <select id="adminUserRole" required onchange="updatePermissionsUI()">
                            <option value="">-- Select Role --</option>
                            <option value="super-admin">Super Admin (Full Access)</option>
                            <option value="admin">Admin (Content Management)</option>
                            <option value="editor">Editor (View & Edit Only)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="permissionsGroup">
                    <label>Permissions</label>
                    <div style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; border: 1px solid #e5e7eb; margin-top: 0.5rem;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.5rem 0;">
                                <input type="checkbox" name="perm_news" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 15px; color: var(--text-dark);">📰 News Management</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.5rem 0;">
                                <input type="checkbox" name="perm_fixtures" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 15px; color: var(--text-dark);">🏉 Fixtures & Results</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.5rem 0;">
                                <input type="checkbox" name="perm_players" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 15px; color: var(--text-dark);">👤 Player Profiles</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.5rem 0;">
                                <input type="checkbox" name="perm_sponsors" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 15px; color: var(--text-dark);">🤝 Sponsors</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.5rem 0;">
                                <input type="checkbox" name="perm_gallery" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 15px; color: var(--text-dark);">📸 Photo Gallery</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.5rem 0;">
                                <input type="checkbox" name="perm_shop" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 15px; color: var(--text-dark);">🛍️ Shop</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.5rem 0;">
                                <input type="checkbox" name="perm_teams" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 15px; color: var(--text-dark);">⚡ Teams</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.5rem 0;">
                                <input type="checkbox" name="perm_settings" style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 15px; color: var(--text-dark);">⚙️ Site Settings</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.5rem 0;">
                                <input type="checkbox" name="perm_contacts" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 15px; color: var(--text-dark);">📞 Contacts</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.5rem 0;">
                                <input type="checkbox" name="perm_events" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 15px; color: var(--text-dark);">📅 Events & Enquiries</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.5rem 0;">
                                <input type="checkbox" name="perm_vp_wall" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 15px; color: var(--text-dark);">🏛️ VP Wall</span>
                            </label>
                        </div>
                    </div>
                    <small id="permissionsNote" style="display: block; margin-top: 0.75rem; color: var(--text-light);">Super Admins have all permissions automatically</small>
                </div>

                <div class="form-group">
                    <label for="adminUserStatus">Account Status *</label>
                    <select id="adminUserStatus" required>
                        <option value="active">✅ Active (Can Login)</option>
                        <option value="disabled">🚫 Disabled (Cannot Login)</option>
                    </select>
                    <small>Disabled users cannot access the dashboard</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAdminUserModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">💾 Save Admin User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- OLS 99: Password Reset Modal -->
<div id="resetPasswordModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>🔒 Reset Password</h2>
            <span class="close" onclick="closeResetPasswordModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                <p style="margin: 0; color: #856404; font-size: 14px;">
                    ⚠️ <strong>Security Note:</strong> You are about to reset the password for <strong id="resetUserName"></strong> (<span id="resetUserEmail"></span>).
                    Please share the new temporary password securely via phone, email, or Slack.
                </p>
            </div>
            
            <form id="resetPasswordForm" onsubmit="submitPasswordReset(event)">
                <input type="hidden" id="resetUserId">
                
                <div class="form-group">
                    <label for="newTempPassword">New Temporary Password *</label>
                    <input type="password" id="newTempPassword" required placeholder="Enter secure temporary password" minlength="8">
                    <small>Minimum 8 characters. User should change this upon first login.</small>
                </div>

                <div class="form-group">
                    <label for="confirmTempPassword">Confirm New Password *</label>
                    <input type="password" id="confirmTempPassword" required placeholder="Re-enter password" minlength="8">
                    <small>Must match the password above</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeResetPasswordModal()">Cancel</button>
                    <button type="submit" class="btn btn-warning" style="background: #ff9800; border-color: #ff9800;">🔒 Reset Password</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Admin Management Styles (OLS 97) */
.admin-user-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
}

.admin-user-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.admin-user-info h3 {
    margin: 0 0 5px 0;
    color: #333;
}

.admin-user-info p {
    margin: 0;
    color: #666;
    font-size: 14px;
}

.admin-role-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.role-super-admin {
    background: #4CAF50;
    color: white;
}

.role-admin {
    background: #2196F3;
    color: white;
}

.role-editor {
    background: #FF9800;
    color: white;
}

.status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
    margin-left: 10px;
}

.status-active {
    background: #e8f5e9;
    color: #2e7d32;
}

.status-disabled {
    background: #ffebee;
    color: #c62828;
}

.admin-user-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.detail-item label {
    display: block;
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
}

.detail-item value {
    display: block;
    font-size: 14px;
    color: #333;
    font-weight: 500;
}

.admin-user-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    padding-top: 15px;
    border-top: 1px solid #eee;
}
</style>

<script>
// ========================================
// ADMIN USER MANAGEMENT FUNCTIONS (OLS 97)
// ========================================

// Load admin users on page load
document.addEventListener('DOMContentLoaded', function() {
    if (hasRole('super-admin')) {
        loadAdminUsers();
    }
});

// Load and display all admin users
async function loadAdminUsers() {
    try {
        console.log('📥 Loading admin users...');
        
        const users = await window.netlifyDataManager.getAdminUsers();
        
        if (!users || users.length === 0) {
            document.getElementById('adminUsersList').innerHTML = '<div class="empty-state"><p>No admin users found.</p><button class="btn btn-primary" onclick="openAddAdminModal()">Add First Admin</button></div>';
            return;
        }
        
        localStorage.setItem('olrfc_admin_users', JSON.stringify(users));
        displayAdminUsers(users);
        
    } catch (error) {
        console.error('Error loading admin users:', error);
        document.getElementById('adminUsersList').innerHTML = '<div class="error-state"><p>⚠️ Error loading admin users: ' + error.message + '</p><button class="btn btn-secondary" onclick="loadAdminUsers()">Retry</button></div>';
    }
}

// Display admin users in the UI
function displayAdminUsers(users) {
    var container = document.getElementById('adminUsersList');
    
    if (!users || users.length === 0) {
        container.innerHTML = '<p class="empty-state">No admin users found.</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < users.length; i++) {
        var user = users[i];
        var permCount = 0;
        var permLabels = { news: 'News', fixtures: 'Fixtures', players: 'Players', sponsors: 'Sponsors', gallery: 'Gallery', shop: 'Shop', teams: 'Teams', contacts: 'Contacts', events: 'Events', 'vp-wall': 'VP Wall', settings: 'Settings', users: 'Users' };
        var enabledPerms = [];
        if (user.permissions) {
            for (var key in user.permissions) {
                if (user.permissions[key] === true) {
                    permCount++;
                    if (permLabels[key]) enabledPerms.push(permLabels[key]);
                }
            }
        }
        
        html += '<div class="admin-user-card">';
        html += '<div class="admin-user-header">';
        html += '<div class="admin-user-info">';
        html += '<h3>' + user.username + '<span class="status-badge status-' + user.status + '">' + user.status + '</span></h3>';
        html += '<p>' + user.email + '</p>';
        html += '</div>';
        html += '<span class="admin-role-badge role-' + user.role + '">' + user.role.replace('-', ' ') + '</span>';
        html += '</div>';
        html += '<div class="admin-user-details">';
        html += '<div class="detail-item"><label>Created</label><value>' + (user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A') + '</value></div>';
        html += '<div class="detail-item"><label>Last Login</label><value>' + (user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never') + '</value></div>';
        html += '<div class="detail-item"><label>Permissions</label><value title="' + enabledPerms.join(', ') + '">' + permCount + ' enabled (' + enabledPerms.join(', ') + ')</value></div>';
        html += '</div>';
        html += '<div class="admin-user-actions">';
        html += '<button class="btn btn-secondary" onclick=\'editAdminUser(' + JSON.stringify(user).replace(/'/g, "\\'") + ')\'>✏️ Edit</button>';
        
        // Add Reset Password button (only for other users, not yourself)
        if (user.id !== window.currentAdmin.userId) {
            html += '<button class="btn btn-warning" onclick="openResetPasswordModal(\'' + user.id + '\', \'' + user.username.replace(/'/g, "\\'") + '\', \'' + user.email + '\')" style="background: #ff9800; border-color: #ff9800;">🔒 Reset Password</button>';
        }
        
        if (user.id !== window.currentAdmin.userId) {
            html += '<button class="btn btn-danger" onclick="deleteAdminUserConfirm(\'' + user.id + '\', \'' + user.username + '\')">🗑️ Delete</button>';
        } else {
            html += '<small style="color: #999;">(You cannot delete yourself)</small>';
        }
        html += '</div>';
        html += '</div>';
    }
    
    container.innerHTML = html;
}

// Open add admin modal
function openAddAdminModal() {
    document.getElementById('adminModalTitle').textContent = '➕ Add New Admin';
    document.getElementById('adminUserForm').reset();
    document.getElementById('adminUserId').value = '';
    document.getElementById('passwordGroup').style.display = 'block';
    document.getElementById('adminUserPassword').required = true;
    document.getElementById('adminUserModal').style.display = 'flex';
}

// Open edit admin modal
function editAdminUser(user) {
    document.getElementById('adminModalTitle').textContent = '✏️ Edit Admin User';
    document.getElementById('adminUserId').value = user.id;
    document.getElementById('adminUsername').value = user.username;
    document.getElementById('adminUserEmail').value = user.email;
    document.getElementById('adminUserRole').value = user.role;
    document.getElementById('adminUserStatus').value = user.status;
    
    document.getElementById('passwordGroup').style.display = 'none';
    document.getElementById('adminUserPassword').required = false;
    
    var perms = user.permissions || {};
    document.querySelector('[name="perm_news"]').checked = perms.news !== false;
    document.querySelector('[name="perm_fixtures"]').checked = perms.fixtures !== false;
    document.querySelector('[name="perm_players"]').checked = perms.players !== false;
    document.querySelector('[name="perm_sponsors"]').checked = perms.sponsors !== false;
    document.querySelector('[name="perm_gallery"]').checked = perms.gallery !== false;
    document.querySelector('[name="perm_shop"]').checked = perms.shop !== false;
    document.querySelector('[name="perm_teams"]').checked = perms.teams !== false;
    document.querySelector('[name="perm_settings"]').checked = perms.settings === true;
    document.querySelector('[name="perm_contacts"]').checked = perms.contacts !== false;
    document.querySelector('[name="perm_events"]').checked = perms.events !== false;
    document.querySelector('[name="perm_vp_wall"]').checked = perms['vp-wall'] !== false;
    
    updatePermissionsUI();
    document.getElementById('adminUserModal').style.display = 'flex';
}

// Close admin user modal
function closeAdminUserModal() {
    document.getElementById('adminUserModal').style.display = 'none';
    document.getElementById('adminUserForm').reset();
}

// Update permissions UI based on role
function updatePermissionsUI() {
    var role = document.getElementById('adminUserRole').value;
    var permissionsGroup = document.getElementById('permissionsGroup');
    var permCheckboxes = permissionsGroup.querySelectorAll('input[type="checkbox"]');
    
    if (role === 'super-admin') {
        for (var i = 0; i < permCheckboxes.length; i++) {
            permCheckboxes[i].checked = true;
            permCheckboxes[i].disabled = true;
        }
        document.getElementById('permissionsNote').textContent = 'Super Admins have all permissions automatically';
    } else {
        for (var i = 0; i < permCheckboxes.length; i++) {
            permCheckboxes[i].disabled = false;
        }
        document.getElementById('permissionsNote').textContent = 'Select which features this user can access';
    }
}

// Save admin user (create or update)
async function saveAdminUser(event) {
    event.preventDefault();
    
    var userId = document.getElementById('adminUserId').value;
    var isEditing = Boolean(userId);
    
    var userData = {
        id: userId || ('admin_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)),
        username: document.getElementById('adminUsername').value.trim(),
        email: document.getElementById('adminUserEmail').value.trim().toLowerCase(),
        role: document.getElementById('adminUserRole').value,
        status: document.getElementById('adminUserStatus').value,
        permissions: {
            news: document.querySelector('[name="perm_news"]').checked,
            fixtures: document.querySelector('[name="perm_fixtures"]').checked,
            players: document.querySelector('[name="perm_players"]').checked,
            sponsors: document.querySelector('[name="perm_sponsors"]').checked,
            gallery: document.querySelector('[name="perm_gallery"]').checked,
            shop: document.querySelector('[name="perm_shop"]').checked,
            teams: document.querySelector('[name="perm_teams"]').checked,
            settings: document.querySelector('[name="perm_settings"]').checked,
            contacts: document.querySelector('[name="perm_contacts"]').checked,
            events: document.querySelector('[name="perm_events"]').checked,
            'vp-wall': document.querySelector('[name="perm_vp_wall"]').checked,
            users: document.getElementById('adminUserRole').value === 'super-admin'
        }
    };
    
    if (!isEditing) {
        var password = document.getElementById('adminUserPassword').value;
        if (!password || password.length < 8) {
            alert('Password must be at least 8 characters');
            return;
        }
        userData.password = password;
        userData.createdAt = new Date().toISOString();
        userData.lastLogin = null;
    }
    
    const actionText = isEditing ? 'Updating admin user...' : 'Creating admin user...';
    const successText = isEditing ? 'Admin user updated!' : 'Admin user created!';
    
    showLoading(actionText);
    
    try {
        if (isEditing) {
            await window.netlifyDataManager.updateAdminUser(userId, userData);
            showLoadingSuccess(successText);
        } else {
            await window.netlifyDataManager.createAdminUser(userData);
            showLoadingSuccess(successText);
        }
        
        closeAdminUserModal();
        await loadAdminUsers();
        
    } catch (error) {
        console.error('Error saving admin user:', error);
        showLoadingError('Failed to save admin user');
    }
}

// Delete admin user with confirmation
async function deleteAdminUserConfirm(userId, username) {
    if (!confirm('Are you sure you want to delete admin user "' + username + '"?\n\nThis action cannot be undone.')) {
        return;
    }
    
    showLoading('Deleting admin user...');
    
    try {
        await window.netlifyDataManager.deleteAdminUser(userId);
        showLoadingSuccess('Admin user deleted!');
        await loadAdminUsers();
    } catch (error) {
        console.error('Error deleting admin user:', error);
        showLoadingError('Failed to delete admin user');
    }
}

// OLS 99: Open password reset modal
function openResetPasswordModal(userId, username, email) {
    document.getElementById('resetUserId').value = userId;
    document.getElementById('resetUserName').textContent = username;
    document.getElementById('resetUserEmail').textContent = email;
    document.getElementById('resetPasswordForm').reset();
    document.getElementById('resetPasswordModal').style.display = 'flex';
}

// OLS 99: Close password reset modal
function closeResetPasswordModal() {
    document.getElementById('resetPasswordModal').style.display = 'none';
    document.getElementById('resetPasswordForm').reset();
}

// OLS 99: Submit password reset
async function submitPasswordReset(event) {
    event.preventDefault();
    
    const userId = document.getElementById('resetUserId').value;
    const newPassword = document.getElementById('newTempPassword').value;
    const confirmPassword = document.getElementById('confirmTempPassword').value;
    
    // Validate passwords match
    if (newPassword !== confirmPassword) {
        alert('❌ Passwords do not match. Please try again.');
        return;
    }
    
    // Validate password length
    if (newPassword.length < 8) {
        alert('❌ Password must be at least 8 characters long.');
        return;
    }
    
    try {
        const result = await window.netlifyDataManager.resetAdminPassword(userId, newPassword);
        
        closeResetPasswordModal();
        
        // Show success message with instructions
        alert(
            '✅ Password reset successful!\n\n' +
            'The temporary password for ' + document.getElementById('resetUserName').textContent + ' has been updated.\n\n' +
            '⚠️ IMPORTANT: Please share this temporary password securely:\n' +
            '• Via phone call\n' +
            '• Via encrypted email\n' +
            '• Via Slack DM\n\n' +
            'The user should change this password immediately after logging in.'
        );
        
        // Reload admin users to reflect any changes
        await loadAdminUsers();
        
    } catch (error) {
        console.error('Error resetting password:', error);
        alert('❌ Error resetting password: ' + error.message);
    }
}

</script>

<!-- ============================================================================ -->
<!-- ADMIN TEAM FILTER - OLS 100 -->
<!-- Loads teams into fixtures admin filter dropdown and handles filtering -->
<!-- ============================================================================ -->
<script>
(async function() {
    /**
     * Load teams from Netlify Blobs and populate admin team filter dropdown
     */
    async function loadAdminTeamFilter() {
        try {
            console.log('📥 Loading teams for admin fixtures filter...');
            
            // Fetch teams from Netlify Blobs
            const response = await fetch('/.netlify/functions/teams', {
                method: 'GET'
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch teams from Netlify');
            }
            
            const result = await response.json();
            const teams = result.data || [];
            
            console.log(`📊 Loaded ${teams.length} teams for admin filter`);
            
            // Get dropdown element
            const dropdown = document.getElementById('admin-team-filter');
            
            if (!dropdown) {
                console.warn('⚠️ Admin team filter dropdown not found');
                return;
            }
            
            // Clear existing options except "All Teams"
            dropdown.innerHTML = '<option value="all">All Teams</option>';
            
            // Add each team
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.slug;
                option.textContent = team.name;
                dropdown.appendChild(option);
            });
            
            // Add event listener for filtering
            dropdown.addEventListener('change', function() {
                const selectedTeam = this.value;
                console.log(`🔍 Filtering fixtures by team: ${selectedTeam}`);
                
                // Use the global adminSystem instance to load filtered fixtures
                if (window.adminSystem) {
                    window.adminSystem.loadFixtures(selectedTeam, currentFixtureTimeFilter);
                } else {
                    console.error('❌ adminSystem not available');
                }
            });
            
            console.log('✅ Admin team filter loaded successfully');
            
        } catch (error) {
            console.error('Error loading admin team filter:', error);
        }
    }
    
    // Load team filter when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadAdminTeamFilter);
    } else {
        loadAdminTeamFilter();
    }
})();
</script>

<!-- ============================================ -->
<!-- OLS 102: Loading Spinner JavaScript -->
<!-- ============================================ -->
<script>
const LoadingSpinner = {
    overlay: null,
    spinner: null,
    messageEl: null,
    container: null,
    
    init() {
        this.overlay = document.getElementById('loadingOverlay');
        this.spinner = this.overlay?.querySelector('.loading-spinner');
        this.messageEl = this.overlay?.querySelector('#loadingMessage');
        this.container = this.overlay?.querySelector('.loading-spinner-container');
    },
    
    show(message = 'Saving changes...') {
        if (!this.overlay) this.init();
        
        this.container?.classList.remove('success', 'error');
        if (this.spinner) this.spinner.style.display = 'block';
        
        const checkmark = this.overlay?.querySelector('.loading-checkmark');
        const errorIcon = this.overlay?.querySelector('.loading-error');
        if (checkmark) checkmark.classList.remove('show');
        if (errorIcon) errorIcon.classList.remove('show');
        
        if (this.messageEl) this.messageEl.textContent = message;
        if (this.overlay) this.overlay.classList.add('active');
        
        document.body.style.overflow = 'hidden';
    },
    
    hide() {
        if (!this.overlay) return;
        this.overlay.classList.remove('active');
        document.body.style.overflow = '';
    },
    
    success(message = 'Changes saved!', duration = 1200) {
        if (!this.overlay) this.init();
        
        if (this.spinner) this.spinner.style.display = 'none';
        
        let checkmark = this.overlay.querySelector('.loading-checkmark');
        if (!checkmark) {
            checkmark = document.createElement('div');
            checkmark.className = 'loading-checkmark';
            this.container.insertBefore(checkmark, this.messageEl.parentElement);
        }
        checkmark.classList.add('show');
        
        if (this.messageEl) this.messageEl.textContent = message;
        this.container?.classList.add('success');
        
        setTimeout(() => {
            this.hide();
        }, duration);
    },
    
    error(message = 'Failed to save changes', duration = 2000) {
        if (!this.overlay) this.init();
        
        if (this.spinner) this.spinner.style.display = 'none';
        
        let errorIcon = this.overlay.querySelector('.loading-error');
        if (!errorIcon) {
            errorIcon = document.createElement('div');
            errorIcon.className = 'loading-error';
            this.container.insertBefore(errorIcon, this.messageEl.parentElement);
        }
        errorIcon.classList.add('show');
        
        if (this.messageEl) this.messageEl.textContent = message;
        this.container?.classList.add('error');
        
        setTimeout(() => {
            this.hide();
        }, duration);
    },
    
    updateMessage(message) {
        if (this.messageEl) this.messageEl.textContent = message;
    }
};

document.addEventListener('DOMContentLoaded', () => {
    LoadingSpinner.init();
});

window.showLoading = (message) => LoadingSpinner.show(message);
window.hideLoading = () => LoadingSpinner.hide();
window.showLoadingSuccess = (message, duration) => LoadingSpinner.success(message, duration);
window.showLoadingError = (message, duration) => LoadingSpinner.error(message, duration);

// OLS 107: Update New Enquiries Badge
async function updateNewEnquiriesBadge() {
    try {
        const badge = document.getElementById('new-enquiries-nav-badge');
        const sidebarBadge = document.getElementById('sidebar-enquiry-badge');
        const dashboardCount = document.getElementById('enquiriesCount');
        
        // Get all enquiries
        const enquiries = await window.netlifyDataManager.getEventsEnquiries();
        
        // Count "new" status enquiries (for badges)
        const newCount = enquiries.filter(e => e.status === 'new').length;
        
        // Total enquiries count (for dashboard stat)
        const totalCount = enquiries.length;
        
        // Update header badge (legacy)
        if (badge) {
            if (newCount > 0) {
                badge.textContent = newCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Update sidebar badge
        if (sidebarBadge) {
            if (newCount > 0) {
                sidebarBadge.textContent = newCount;
                sidebarBadge.style.display = 'inline-block';
            } else {
                sidebarBadge.style.display = 'none';
            }
        }
        
        // Update dashboard stat card
        if (dashboardCount) {
            dashboardCount.textContent = totalCount;
        }
        
        console.log(`📧 Enquiries updated: ${totalCount} total, ${newCount} new`);
    } catch (error) {
        console.error('Error updating enquiries badge:', error);
    }
}

// Update badge on page load
document.addEventListener('DOMContentLoaded', () => {
    updateNewEnquiriesBadge();
    
    // Update badge every 2 minutes
    setInterval(updateNewEnquiriesBadge, 120000);
});

// Make function globally accessible so enquiry management can refresh it
window.updateNewEnquiriesBadge = updateNewEnquiriesBadge;

// ============================================
// VP WALL MANAGEMENT FUNCTIONS (OLS 114)
// ============================================

// Store current edit VP ID
let currentEditVPId = null;

/**
 * Open VP Modal for add/edit
 */
function openVPModal(vpId = null) {
    currentEditVPId = vpId;
    const modal = document.getElementById('vpModal');
    const title = document.getElementById('vpModalTitle');
    const form = document.getElementById('vpForm');
    
    // Reset form
    form.reset();
    document.getElementById('vpId').value = '';
    document.getElementById('vpType').value = 'annual'; // Default to annual
    
    if (vpId) {
        // Edit mode - load VP data
        title.textContent = '✏️ Edit Vice President';
        loadVPForEdit(vpId);
    } else {
        // Add mode
        title.textContent = '➕ Add Vice President';
    }
    
    modal.style.display = 'flex';
}

/**
 * Close VP Modal
 */
function closeVPModal() {
    document.getElementById('vpModal').style.display = 'none';
    currentEditVPId = null;
}

/**
 * Load VP data into form for editing
 */
async function loadVPForEdit(vpId) {
    try {
        const vps = JSON.parse(localStorage.getItem('olrfc_vps') || '[]');
        const vp = vps.find(v => v.id === vpId);
        
        if (vp) {
            document.getElementById('vpId').value = vp.id;
            document.getElementById('vpName').value = vp.name || '';
            document.getElementById('vpType').value = vp.type || 'annual';
            document.getElementById('vpNotes').value = vp.notes || '';
        }
    } catch (error) {
        console.error('Error loading VP for edit:', error);
        showVPAlert('Error loading VP data', 'danger');
    }
}

/**
 * Save VP (create or update)
 */
async function saveVP(event) {
    event.preventDefault();
    
    const vpId = document.getElementById('vpId').value;
    const vpData = {
        name: document.getElementById('vpName').value.trim(),
        type: document.getElementById('vpType').value,
        notes: document.getElementById('vpNotes').value.trim()
    };
    
    // Validation
    if (!vpData.name) {
        showVPAlert('Please enter a name', 'danger');
        return;
    }
    
    try {
        // Show loading
        if (window.showLoading) {
            showLoading(vpId ? 'Updating Vice President...' : 'Adding Vice President...');
        }
        
        let result;
        
        if (vpId) {
            // Update existing VP
            result = await window.netlifyDataManager.updateVP(vpId, vpData);
        } else {
            // Create new VP
            vpData.id = Date.now().toString();
            vpData.dateAdded = new Date().toISOString();
            result = await window.netlifyDataManager.createVP(vpData);
        }
        
        if (result.success) {
            // Update localStorage
            let vps = JSON.parse(localStorage.getItem('olrfc_vps') || '[]');
            
            if (vpId) {
                // Update in array
                const index = vps.findIndex(v => v.id === vpId);
                if (index !== -1) {
                    vps[index] = { ...vps[index], ...vpData, lastUpdated: new Date().toISOString() };
                }
            } else {
                // Add to array
                vps.push(vpData);
            }
            
            localStorage.setItem('olrfc_vps', JSON.stringify(vps));
            
            closeVPModal();
            loadVPList();
            updateVPStats();

            // Log activity
            if (window.activityLogger) {
                if (vpId) {
                    window.activityLogger.logUpdate('vp-wall', vpData.name, vpId,
                        `Updated VP: ${vpData.name} (${vpData.type})`);
                } else {
                    window.activityLogger.logCreate('vp-wall', vpData.name, vpData.id,
                        `Added VP: ${vpData.name} (${vpData.type})`);
                }
            }

            if (window.showLoadingSuccess) {
                showLoadingSuccess(vpId ? 'VP Updated!' : 'VP Added!');
            }

            showVPAlert(vpId ? 'Vice President updated successfully!' : 'Vice President added successfully!', 'success');
        } else {
            throw new Error(result.error || 'Failed to save VP');
        }
        
    } catch (error) {
        console.error('Error saving VP:', error);
        if (window.showLoadingError) {
            showLoadingError('Failed to save VP');
        }
        showVPAlert('Error saving Vice President: ' + error.message, 'danger');
    }
}

/**
 * Delete VP
 */
async function deleteVP(vpId) {
    // Get VP info for confirmation message
    const vps = JSON.parse(localStorage.getItem('olrfc_vps') || '[]');
    const vp = vps.find(v => v.id === vpId);
    const vpName = vp ? vp.name : 'this VP';
    const isLifetime = vp && vp.type === 'lifetime';
    
    const confirmMsg = isLifetime 
        ? `⚠️ "${vpName}" is a LIFETIME VP.\n\nAre you sure you want to remove them from the wall?`
        : `Remove "${vpName}" from the VP Wall?`;
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        if (window.showLoading) {
            showLoading('Removing Vice President...');
        }
        
        const result = await window.netlifyDataManager.deleteVP(vpId);
        
        if (result.success) {
            // Update localStorage
            let vps = JSON.parse(localStorage.getItem('olrfc_vps') || '[]');
            vps = vps.filter(v => v.id !== vpId);
            localStorage.setItem('olrfc_vps', JSON.stringify(vps));

            // Log activity
            if (window.activityLogger) {
                window.activityLogger.logDelete('vp-wall', vpName, vpId);
            }

            loadVPList();
            updateVPStats();

            if (window.showLoadingSuccess) {
                showLoadingSuccess('VP Removed!');
            }

            showVPAlert('Vice President removed from the wall', 'success');
        } else {
            throw new Error(result.error || 'Failed to delete VP');
        }
        
    } catch (error) {
        console.error('Error deleting VP:', error);
        if (window.showLoadingError) {
            showLoadingError('Failed to remove VP');
        }
        showVPAlert('Error removing Vice President: ' + error.message, 'danger');
    }
}

/**
 * Load VP list into admin section
 */
async function loadVPList() {
    const listContainer = document.getElementById('vpList');
    if (!listContainer) return;
    
    try {
        // Try to sync from cloud first
        if (window.netlifyDataManager && window.netlifyDataManager.getVPs) {
            await window.netlifyDataManager.getVPs();
        }
        
        const vps = JSON.parse(localStorage.getItem('olrfc_vps') || '[]');
        
        if (vps.length === 0) {
            listContainer.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: var(--text-light);">
                    <p style="font-size: 3rem; margin-bottom: 1rem;">🧱</p>
                    <h3>No Vice Presidents Yet</h3>
                    <p>Click "Add Vice President" to add the first brick to the wall.</p>
                </div>
            `;
            return;
        }
        
        // Sort: Lifetime first, then by name
        const sortedVPs = [...vps].sort((a, b) => {
            // Lifetime VPs first
            if (a.type === 'lifetime' && b.type !== 'lifetime') return -1;
            if (a.type !== 'lifetime' && b.type === 'lifetime') return 1;
            // Then alphabetically
            return (a.name || '').localeCompare(b.name || '');
        });
        
        listContainer.innerHTML = sortedVPs.map(vp => {
            const isLifetime = vp.type === 'lifetime';
            const typeBadge = isLifetime 
                ? '<span style="background: linear-gradient(135deg, #b8860b, #daa520); color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 10px; margin-left: 0.5rem;">♦ LIFETIME</span>'
                : '<span style="background: var(--primary-green); color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 10px; margin-left: 0.5rem;">ANNUAL</span>';
            
            return `
                <div class="content-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: white; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid ${isLifetime ? '#b8860b' : 'var(--primary-green)'};">
                    <div class="content-info">
                        <h4 style="margin: 0 0 0.25rem 0; color: var(--text-dark);">
                            ${vp.name}
                            ${typeBadge}
                        </h4>
                        ${vp.notes ? `<p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">📝 ${vp.notes.substring(0, 60)}${vp.notes.length > 60 ? '...' : ''}</p>` : ''}
                    </div>
                    <div class="content-actions" style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="openVPModal('${vp.id}')" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                            ✏️ Edit
                        </button>
                        <button class="btn btn-danger" onclick="deleteVP('${vp.id}')" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                            🗑️ Remove
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading VP list:', error);
        listContainer.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #dc3545;">
                <p>❌ Error loading Vice Presidents</p>
                <button class="btn btn-secondary" onclick="loadVPList()">Try Again</button>
            </div>
        `;
    }
}

/**
 * Update VP stats cards
 */
function updateVPStats() {
    const vps = JSON.parse(localStorage.getItem('olrfc_vps') || '[]');
    
    const total = vps.length;
    const lifetime = vps.filter(vp => vp.type === 'lifetime').length;
    const annual = total - lifetime;
    
    // Update stats in VP section
    const totalEl = document.getElementById('vpTotalCount');
    const lifetimeEl = document.getElementById('vpLifetimeCount');
    const annualEl = document.getElementById('vpAnnualCount');
    
    if (totalEl) totalEl.textContent = total;
    if (lifetimeEl) lifetimeEl.textContent = lifetime;
    if (annualEl) annualEl.textContent = annual;
    
    // Update main dashboard stat
    const dashboardStat = document.getElementById('vpsCount');
    if (dashboardStat) dashboardStat.textContent = total;
}

/**
 * Show VP alert message
 */
function showVPAlert(message, type = 'success') {
    const alertEl = document.getElementById('vpAlert');
    if (!alertEl) return;
    
    alertEl.textContent = message;
    alertEl.className = `alert alert-${type}`;
    alertEl.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        alertEl.style.display = 'none';
    }, 5000);
}

// Hook into showSection to load VPs when section is shown
(function() {
    const originalShowSection = window.showSection;
    if (originalShowSection) {
        window.showSection = function(sectionId) {
            originalShowSection(sectionId);
            if (sectionId === 'vp-wall') {
                loadVPList();
                updateVPStats();
            }
        };
    }
})();

// Initialize VP stats on page load
document.addEventListener('DOMContentLoaded', function() {
    updateVPStats();
});
</script>

<!-- OLS 120: League Table Multi-Team Management -->
<script>
/**
 * League Table Configuration Manager
 * Supports multiple teams with different league tables
 */

// Load league tables on page load
document.addEventListener('DOMContentLoaded', function() {
    loadLeagueTablesList();
});

/**
 * Load and display all configured league tables
 */
async function loadLeagueTablesList() {
    const container = document.getElementById('league-tables-list');
    const standaloneContainer = document.getElementById('league-tables-list-standalone');
    
    try {
        // Get league tables from site-settings
        const response = await fetch('/.netlify/functions/site-settings');
        const result = await response.json();
        const settings = result.data || {};
        
        // Parse league tables array (stored as JSON string)
        let leagueTables = [];
        try {
            leagueTables = JSON.parse(settings['league-tables'] || '[]');
        } catch (e) {
            leagueTables = [];
        }
        
        if (leagueTables.length === 0) {
            const emptyHtml = `
                <div style="text-align: center; padding: 2rem; color: var(--text-light); background: #f8f9fa; border-radius: 8px;">
                    <p style="font-size: 2rem; margin-bottom: 0.5rem;">🏆</p>
                    <p style="margin: 0;">No league tables configured yet.</p>
                    <p style="margin: 0; font-size: 0.9rem;">Click "Add League Table" to get started.</p>
                </div>
            `;
            if (container) container.innerHTML = emptyHtml;
            if (standaloneContainer) standaloneContainer.innerHTML = emptyHtml;
            return;
        }
        
        // Sort: default first, then by team name
        leagueTables.sort((a, b) => {
            if (a.isDefault && !b.isDefault) return -1;
            if (!a.isDefault && b.isDefault) return 1;
            return (a.teamName || '').localeCompare(b.teamName || '');
        });
        
        const tablesHtml = leagueTables.map(config => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid ${config.isDefault ? 'var(--accent-gold)' : 'var(--primary-green)'};">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                        <strong style="color: var(--text-dark);">${config.teamName || 'Unknown Team'}</strong>
                        ${config.isDefault ? '<span style="background: var(--accent-gold); color: var(--primary-green); font-size: 0.7rem; padding: 0.15rem 0.5rem; border-radius: 10px; font-weight: bold;">DEFAULT</span>' : ''}
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-light);">
                        Division: ${config.division} • Competition: ${config.competition} • ${config.season}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-light);">
                        Highlighting: "${config.clubName}"
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    ${!config.isDefault ? `<button onclick="setDefaultLeagueTable('${config.id}')" class="btn btn-secondary" style="padding: 0.4rem 0.75rem; font-size: 0.8rem;" title="Set as default">⭐</button>` : ''}
                    <button onclick="openLeagueTableModal('${config.id}')" class="btn btn-secondary" style="padding: 0.4rem 0.75rem; font-size: 0.8rem;">✏️ Edit</button>
                    <button onclick="deleteLeagueTable('${config.id}')" class="btn btn-danger" style="padding: 0.4rem 0.75rem; font-size: 0.8rem;">🗑️</button>
                </div>
            </div>
        `).join('');
        
        if (container) container.innerHTML = tablesHtml;
        if (standaloneContainer) standaloneContainer.innerHTML = tablesHtml;
        
        console.log(`✅ Loaded ${leagueTables.length} league table configs`);
        
    } catch (error) {
        console.error('Error loading league tables:', error);
        const errorHtml = `
            <div style="text-align: center; padding: 2rem; color: #dc3545;">
                <p>❌ Error loading league tables</p>
                <button class="btn btn-secondary" onclick="loadLeagueTablesList()">Try Again</button>
            </div>
        `;
        if (container) container.innerHTML = errorHtml;
        if (standaloneContainer) standaloneContainer.innerHTML = errorHtml;
    }
}

/**
 * Parse RFU league URL to extract all parameters
 * Supports URL formats:
 * 1. Full: ?team=X&competition=Y&division=Z&season=S
 * 2. Division/Competition only: ?competition=Y&division=Z&season=S
 * 3. Team-based only: ?team=X&season=S
 */
function parseLeagueUrl(url) {
    const parsedDisplay = document.getElementById('league-url-parsed');
    const errorDisplay = document.getElementById('league-url-error');
    const divisionInput = document.getElementById('league-modal-division');
    const competitionInput = document.getElementById('league-modal-competition');
    const seasonInput = document.getElementById('league-modal-season');
    const teamIdInput = document.getElementById('league-modal-teamid'); // Hidden field for RFU team ID
    
    // Reset displays
    parsedDisplay.style.display = 'none';
    errorDisplay.style.display = 'none';
    
    if (!url || url.trim() === '') {
        return;
    }
    
    try {
        const urlObj = new URL(url);
        const params = urlObj.searchParams;
        
        const division = params.get('division');
        const competition = params.get('competition');
        const season = params.get('season');
        const team = params.get('team'); // RFU team ID (not our internal team)
        
        // Format 1: Full URL with all params (most reliable)
        if (division && competition && season) {
            divisionInput.value = division;
            competitionInput.value = competition;
            seasonInput.value = season;
            if (teamIdInput) teamIdInput.value = team || '';
            
            let displayHtml = `
                <div style="color: var(--primary-green); font-weight: bold; margin-bottom: 0.25rem;">✅ URL Parsed:</div>
                <div>Division: ${division}</div>
                <div>Competition: ${competition}</div>
                <div>Season: ${season}</div>
            `;
            if (team) {
                displayHtml += `<div>RFU Team ID: ${team}</div>`;
            }
            
            parsedDisplay.innerHTML = displayHtml;
            parsedDisplay.style.display = 'block';
            console.log('✅ Parsed league URL:', { division, competition, season, team });
            return;
        }
        
        // Format 2: Team-based URL only
        if (team && season) {
            divisionInput.value = `team:${team}`;
            competitionInput.value = 'auto';
            seasonInput.value = season;
            if (teamIdInput) teamIdInput.value = team;
            
            parsedDisplay.innerHTML = `
                <div style="color: var(--primary-green); font-weight: bold; margin-bottom: 0.25rem;">✅ Team URL Detected:</div>
                <div>Team ID: ${team}</div>
                <div>Season: ${season}</div>
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-light);">
                    💡 For best results, go to your specific league table and use that URL instead.<br>
                    Or continue - we'll try to fetch your team's league automatically.
                </div>
            `;
            parsedDisplay.style.display = 'block';
            
            console.log('✅ Parsed league URL (team-based):', { team, season });
            return;
        }
        
        // Neither format matched
        errorDisplay.style.display = 'block';
        divisionInput.value = '';
        competitionInput.value = '';
        seasonInput.value = '';
        if (teamIdInput) teamIdInput.value = '';
        
    } catch (e) {
        // Invalid URL
        errorDisplay.style.display = 'block';
        divisionInput.value = '';
        competitionInput.value = '';
        seasonInput.value = '';
        if (teamIdInput) teamIdInput.value = '';
    }
}

/**
 * Open modal for adding/editing league table
 */
async function openLeagueTableModal(editId = null) {
    const modal = document.getElementById('league-table-modal');
    const title = document.getElementById('league-modal-title');
    const teamSelect = document.getElementById('league-team-select');
    const urlInput = document.getElementById('league-modal-url');
    const parsedDisplay = document.getElementById('league-url-parsed');
    const errorDisplay = document.getElementById('league-url-error');
    
    // OLS 132: Table selection elements
    const scanStatus = document.getElementById('league-scan-status');
    const tableSelection = document.getElementById('league-table-selection');
    
    // Reset form
    document.getElementById('league-edit-id').value = editId || '';
    document.getElementById('league-modal-division').value = '';
    document.getElementById('league-modal-competition').value = '';
    document.getElementById('league-modal-season').value = '';
    document.getElementById('league-modal-teamid').value = '';
    document.getElementById('league-modal-tableindex').value = '0'; // OLS 132
    document.getElementById('league-modal-clubname').value = '';
    document.getElementById('league-modal-default').checked = false;
    urlInput.value = '';
    parsedDisplay.style.display = 'none';
    errorDisplay.style.display = 'none';
    
    // OLS 132: Reset table selection UI
    if (scanStatus) scanStatus.style.display = 'none';
    if (tableSelection) tableSelection.style.display = 'none';
    
    // Populate team dropdown
    await populateTeamDropdown();
    
    if (editId) {
        // Edit mode - load existing config
        title.textContent = 'Edit League Table';
        
        const response = await fetch('/.netlify/functions/site-settings');
        const result = await response.json();
        const settings = result.data || {};
        const leagueTables = JSON.parse(settings['league-tables'] || '[]');
        const config = leagueTables.find(lt => lt.id === editId);
        
        if (config) {
            teamSelect.value = config.teamId || '';
            document.getElementById('league-modal-division').value = config.division || '';
            document.getElementById('league-modal-competition').value = config.competition || '';
            document.getElementById('league-modal-season').value = config.season || '';
            document.getElementById('league-modal-teamid').value = config.rfuTeamId || '';
            document.getElementById('league-modal-tableindex').value = config.tableIndex || '0'; // OLS 132
            document.getElementById('league-modal-clubname').value = config.clubName || '';
            document.getElementById('league-modal-default').checked = config.isDefault || false;
            
            // Use stored URL or reconstruct it
            const isTeamBased = config.division && config.division.startsWith('team:');
            let rfuUrl = config.rfuUrl;
            
            if (!rfuUrl) {
                if (isTeamBased) {
                    const teamId = config.division.replace('team:', '');
                    rfuUrl = `https://www.englandrugby.com/fixtures-and-results/search-results?team=${teamId}&season=${config.season}#related-teams-tables`;
                } else if (config.division && config.competition && config.season) {
                    // Include rfuTeamId if available
                    const teamParam = config.rfuTeamId ? `team=${config.rfuTeamId}&` : '';
                    rfuUrl = `https://www.englandrugby.com/fixtures-and-results/search-results?${teamParam}competition=${config.competition}&division=${config.division}&season=${config.season}#tables`;
                }
            }
            
            if (rfuUrl) {
                urlInput.value = rfuUrl;
                
                if (isTeamBased) {
                    const teamId = config.division.replace('team:', '');
                    parsedDisplay.innerHTML = `
                        <div style="color: var(--primary-green); font-weight: bold; margin-bottom: 0.25rem;">✅ Team URL Detected:</div>
                        <div>Team ID: ${teamId}</div>
                        <div>Season: ${config.season}</div>
                        ${config.tableIndex ? `<div>Table Index: ${config.tableIndex}</div>` : ''}
                    `;
                } else {
                    let displayHtml = `
                        <div style="color: var(--primary-green); font-weight: bold; margin-bottom: 0.25rem;">✅ URL Parsed:</div>
                        <div>Division: ${config.division}</div>
                        <div>Competition: ${config.competition}</div>
                        <div>Season: ${config.season}</div>
                    `;
                    if (config.rfuTeamId) {
                        displayHtml += `<div>RFU Team ID: ${config.rfuTeamId}</div>`;
                    }
                    if (config.tableIndex) {
                        displayHtml += `<div>Table Index: ${config.tableIndex}</div>`;
                    }
                    parsedDisplay.innerHTML = displayHtml;
                }
                parsedDisplay.style.display = 'block';
            }
            
            // OLS 132: Show note about existing table selection
            if (config.tableIndex && scanStatus) {
                scanStatus.innerHTML = `<span style="color: var(--text-light);">ℹ️ Currently using table index ${config.tableIndex}. Click "Scan for Tables" to change.</span>`;
                scanStatus.style.display = 'block';
            }
        }
    } else {
        title.textContent = 'Add League Table';
    }
    
    modal.style.display = 'flex';
}

/**
 * OLS 132: Scan RFU page for available league tables
 */
async function scanForLeagueTables() {
    const urlInput = document.getElementById('league-modal-url');
    const teamSelect = document.getElementById('league-team-select');
    const scanBtn = document.getElementById('league-scan-btn');
    const scanStatus = document.getElementById('league-scan-status');
    const tableSelection = document.getElementById('league-table-selection');
    const tableOptions = document.getElementById('league-table-options');
    const tableSelectorInput = document.getElementById('league-modal-tableindex'); // Reusing this for tableSelector
    
    // Get team ID from URL or team select
    const url = urlInput?.value?.trim();
    let teamId = '';
    let season = '2025-2026';
    
    if (url && url.includes('englandrugby.com')) {
        const urlObj = new URL(url);
        teamId = urlObj.searchParams.get('team') || '';
        season = urlObj.searchParams.get('season') || '2025-2026';
    }
    
    // Fallback to RFU team ID field
    if (!teamId) {
        teamId = document.getElementById('league-modal-teamid')?.value?.trim() || '';
    }
    
    if (!teamId) {
        alert('Please enter a URL with a team ID or set the RFU Team ID');
        return;
    }
    
    // Build discover URL
    let discoverUrl = `/.netlify/functions/league-table?discover=true&team=${teamId}&season=${season}`;
    
    // Show scanning status
    scanBtn.disabled = true;
    scanBtn.textContent = '⏳ Scanning (this takes ~15 seconds)...';
    scanStatus.innerHTML = '<span style="color: var(--text-light);">⏳ Puppeteer is navigating to the RFU site...</span>';
    scanStatus.style.display = 'block';
    tableSelection.style.display = 'none';
    
    try {
        const response = await fetch(discoverUrl);
        const result = await response.json();
        
        if (!result.success || !result.tables?.length) {
            throw new Error(result.error || 'No tables found');
        }
        
        console.log('📊 Found tables:', result.tables);
        
        // Build table options
        tableOptions.innerHTML = result.tables.map((table, idx) => `
            <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem; background: ${idx === 0 ? 'rgba(var(--primary-green-rgb), 0.1)' : '#f8f9fa'}; border-radius: 8px; cursor: pointer; border: 2px solid ${idx === 0 ? 'var(--primary-green)' : 'transparent'};" 
                   class="league-table-option" 
                   onclick="selectLeagueTable(${table.index}, this)">
                <input type="radio" name="league-table-choice" value="${table.index}" ${idx === 0 ? 'checked' : ''} style="margin-top: 0.25rem;">
                <div style="flex: 1;">
                    <div style="font-weight: bold; color: var(--text-dark); margin-bottom: 0.25rem;">
                        ${table.title || `Table ${idx + 1}`}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-light);">
                        ${table.preview || 'Click to view full table'}
                    </div>
                </div>
            </label>
        `).join('');
        
        // Set default to first table
        tableSelectorInput.value = result.tables[0]?.index || 0;
        
        // Show selection UI
        scanStatus.innerHTML = `<span style="color: var(--primary-green);">✅ Found ${result.tables.length} table(s). Select the one you want to display.</span>`;
        scanStatus.style.display = 'block';
        tableSelection.style.display = 'block';
        
    } catch (error) {
        console.error('Error scanning for tables:', error);
        scanStatus.innerHTML = `<span style="color: #dc3545;">❌ ${error.message || 'Failed to scan page. Make sure the URL is correct.'}</span>`;
        scanStatus.style.display = 'block';
        tableSelection.style.display = 'none';
    } finally {
        scanBtn.disabled = false;
        scanBtn.textContent = '🔍 Scan for Tables';
    }
}

/**
 * OLS 132: Select a specific league table
 */
function selectLeagueTable(tableIndex, element) {
    // Update hidden input
    document.getElementById('league-modal-tableindex').value = tableIndex;
    
    // Update visual selection
    document.querySelectorAll('.league-table-option').forEach(opt => {
        opt.style.background = '#f8f9fa';
        opt.style.borderColor = 'transparent';
    });
    element.style.background = 'rgba(var(--primary-green-rgb), 0.1)';
    element.style.borderColor = 'var(--primary-green)';
    
    console.log('📊 Selected table index:', tableIndex);
}

/**
 * Close league table modal
 */
function closeLeagueTableModal() {
    document.getElementById('league-table-modal').style.display = 'none';
}

/**
 * Populate team dropdown from teams API
 */
async function populateTeamDropdown() {
    const select = document.getElementById('league-team-select');
    
    try {
        // Try localStorage first (faster)
        let teams = JSON.parse(localStorage.getItem('olrfc_teams') || '[]');
        
        // If empty, fetch from API
        if (teams.length === 0) {
            const response = await fetch('/.netlify/functions/teams');
            const result = await response.json();
            teams = result.data || [];
        }
        
        // Get existing league table configs to show which teams already have one
        const settingsResponse = await fetch('/.netlify/functions/site-settings');
        const settingsResult = await settingsResponse.json();
        const settings = settingsResult.data || {};
        const leagueTables = JSON.parse(settings['league-tables'] || '[]');
        const configuredTeamIds = leagueTables.map(lt => lt.teamId);
        
        // Build options - show all teams, mark ones already configured
        select.innerHTML = '<option value="">Select a team...</option>';
        
        teams.forEach(team => {
            const isConfigured = configuredTeamIds.includes(team.id);
            const editId = document.getElementById('league-edit-id').value;
            const currentConfig = leagueTables.find(lt => lt.id === editId);
            const isCurrentTeam = currentConfig && currentConfig.teamId === team.id;
            
            // Show team if not configured, or if it's the team being edited
            const option = document.createElement('option');
            option.value = team.id;
            option.textContent = team.name + (isConfigured && !isCurrentTeam ? ' (already configured)' : '');
            option.disabled = isConfigured && !isCurrentTeam;
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading teams:', error);
        select.innerHTML = '<option value="">Error loading teams</option>';
    }
}

/**
 * Save league table configuration
 */
async function saveLeagueTable() {
    const editId = document.getElementById('league-edit-id').value;
    const teamSelect = document.getElementById('league-team-select');
    const teamId = teamSelect.value;
    const teamName = teamSelect.options[teamSelect.selectedIndex]?.text.replace(' (already configured)', '') || '';
    
    const division = document.getElementById('league-modal-division').value.trim();
    const competition = document.getElementById('league-modal-competition').value.trim();
    const season = document.getElementById('league-modal-season').value.trim();
    const rfuTeamId = document.getElementById('league-modal-teamid')?.value.trim() || ''; // RFU's team ID
    const clubName = document.getElementById('league-modal-clubname').value.trim();
    const isDefault = document.getElementById('league-modal-default').checked;
    
    // Validation
    if (!teamId) {
        alert('Please select a team');
        return;
    }
    if (!season) {
        alert('Please paste a valid England Rugby league URL');
        return;
    }
    // Allow either: division/competition format OR team-based format (division starts with "team:")
    const isTeamBased = division && division.startsWith('team:');
    const isDivisionBased = division && competition && !division.startsWith('team:');
    if (!isTeamBased && !isDivisionBased) {
        alert('Please paste a valid England Rugby league URL');
        return;
    }
    if (!clubName) {
        alert('Please enter the club name as it appears in the league table');
        return;
    }
    
    const actionText = editId ? 'Updating league table...' : 'Adding league table...';
    const successText = editId ? 'League table updated!' : 'League table added!';
    
    showLoading(actionText);
    
    try {
        // Get current league tables
        const response = await fetch('/.netlify/functions/site-settings');
        const result = await response.json();
        const settings = result.data || {};
        let leagueTables = JSON.parse(settings['league-tables'] || '[]');
        
        // If setting as default, unset others
        if (isDefault) {
            leagueTables = leagueTables.map(lt => ({ ...lt, isDefault: false }));
        }
        
        const configData = {
            id: editId || `lt-${Date.now()}`,
            teamId,
            teamName,
            division,
            competition,
            season,
            rfuTeamId, // RFU's team ID for URL building
            tableIndex: parseInt(document.getElementById('league-modal-tableindex')?.value) || 0, // OLS 132: Selected table index
            clubName,
            isDefault,
            rfuUrl: document.getElementById('league-modal-url').value.trim()
        };
        
        if (editId) {
            // Update existing
            const index = leagueTables.findIndex(lt => lt.id === editId);
            if (index !== -1) {
                leagueTables[index] = configData;
            }
        } else {
            // Add new
            leagueTables.push(configData);
        }
        
        // Save to site-settings
        const saveResponse = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 'league-tables': JSON.stringify(leagueTables) })
        });
        
        if (!saveResponse.ok) {
            throw new Error('Failed to save');
        }
        
        console.log('✅ League table saved:', configData);
        
        closeLeagueTableModal();
        loadLeagueTablesList();
        showLoadingSuccess(successText);
        
    } catch (error) {
        console.error('Error saving league table:', error);
        showLoadingError('Failed to save league table');
    }
}

/**
 * Delete league table configuration
 */
async function deleteLeagueTable(configId) {
    if (!confirm('Delete this league table configuration?')) {
        return;
    }
    
    showLoading('Deleting league table...');
    
    try {
        const response = await fetch('/.netlify/functions/site-settings');
        const result = await response.json();
        const settings = result.data || {};
        let leagueTables = JSON.parse(settings['league-tables'] || '[]');
        
        leagueTables = leagueTables.filter(lt => lt.id !== configId);
        
        const saveResponse = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 'league-tables': JSON.stringify(leagueTables) })
        });
        
        if (!saveResponse.ok) {
            throw new Error('Failed to save');
        }
        
        console.log('✅ League table deleted:', configId);
        loadLeagueTablesList();
        showLoadingSuccess('League table deleted!');
        
    } catch (error) {
        console.error('Error deleting league table:', error);
        showLoadingError('Failed to delete league table');
    }
}

/**
 * Set a league table as default
 */
async function setDefaultLeagueTable(configId) {
    try {
        const response = await fetch('/.netlify/functions/site-settings');
        const result = await response.json();
        const settings = result.data || {};
        let leagueTables = JSON.parse(settings['league-tables'] || '[]');
        
        // Update default flags
        leagueTables = leagueTables.map(lt => ({
            ...lt,
            isDefault: lt.id === configId
        }));
        
        const saveResponse = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 'league-tables': JSON.stringify(leagueTables) })
        });
        
        if (!saveResponse.ok) {
            throw new Error('Failed to save');
        }
        
        console.log('✅ Default league table set:', configId);
        loadLeagueTablesList();
        
    } catch (error) {
        console.error('Error setting default:', error);
        alert('Failed to set default: ' + error.message);
    }
}

// Close modal on outside click
document.getElementById('league-table-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeLeagueTableModal();
    }
});

// Hook into showSection to load league tables when content-management is shown
(function() {
    const originalShowSection = window.showSection;
    if (originalShowSection) {
        window.showSection = function(sectionId) {
            originalShowSection(sectionId);
            if (sectionId === 'content-management') {
                loadLeagueTablesList();
            }
            // OLS 128: Load news categories when news section is shown
            if (sectionId === 'news') {
                populateNewsCategoryDropdown();
            }
        };
    }
})();

// ==========================================
// OLS 128: NEWS CATEGORIES MANAGEMENT
// ==========================================

// Cache for news categories
let cachedNewsCategories = null;

/**
 * Get news categories from CMS or return defaults
 */
async function getNewsCategories() {
    // Default categories
    const defaults = [
        { id: 'match', name: 'Match Report', icon: '🏉', order: 1, showFilter: true },
        { id: 'training', name: 'Training', icon: '💪', order: 2, showFilter: true },
        { id: 'social', name: 'Social Event', icon: '🎉', order: 3, showFilter: true },
        { id: 'club', name: 'Club Update', icon: '📢', order: 4, showFilter: true }
    ];
    
    try {
        // Try localStorage cache first
        const cachedSettings = localStorage.getItem('olrfc_site-settings');
        if (cachedSettings) {
            const settings = JSON.parse(cachedSettings);
            if (settings['news-categories']) {
                cachedNewsCategories = JSON.parse(settings['news-categories']);
                return cachedNewsCategories;
            }
        }
        
        // Fetch from API
        const response = await fetch('/.netlify/functions/site-settings');
        if (response.ok) {
            const result = await response.json();
            const settings = result.data || {};
            if (settings['news-categories']) {
                cachedNewsCategories = JSON.parse(settings['news-categories']);
                return cachedNewsCategories;
            }
        }
    } catch (error) {
        console.warn('Could not load news categories:', error);
    }
    
    cachedNewsCategories = defaults;
    return defaults;
}

/**
 * Save news categories to CMS
 */
async function saveNewsCategories(categories) {
    try {
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 'news-categories': JSON.stringify(categories) })
        });
        
        if (response.ok) {
            cachedNewsCategories = categories;
            // Update localStorage cache
            const cachedSettings = localStorage.getItem('olrfc_site-settings');
            if (cachedSettings) {
                const settings = JSON.parse(cachedSettings);
                settings['news-categories'] = JSON.stringify(categories);
                localStorage.setItem('olrfc_site-settings', JSON.stringify(settings));
            }
            return true;
        }
    } catch (error) {
        console.error('Failed to save news categories:', error);
    }
    return false;
}

/**
 * Toggle the news categories section visibility
 */
function toggleNewsCategoriesSection() {
    const content = document.getElementById('news-categories-content');
    const toggle = document.getElementById('news-categories-toggle');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.style.transform = 'rotate(180deg)';
        loadNewsCategoriesList();
    } else {
        content.style.display = 'none';
        toggle.style.transform = 'rotate(0deg)';
    }
}

/**
 * Load and render the news categories list with article counts
 */
async function loadNewsCategoriesList() {
    const listContainer = document.getElementById('news-categories-list');
    const standaloneContainer = document.getElementById('news-categories-list-standalone');
    
    const loadingHtml = '<div style="text-align: center; padding: 1rem; color: var(--text-light);">Loading...</div>';
    if (listContainer) listContainer.innerHTML = loadingHtml;
    if (standaloneContainer) standaloneContainer.innerHTML = loadingHtml;
    
    const categories = await getNewsCategories();
    
    // Get article counts per category
    const articles = JSON.parse(localStorage.getItem('olrfc_news') || '[]');
    const articleCounts = {};
    articles.forEach(article => {
        articleCounts[article.category] = (articleCounts[article.category] || 0) + 1;
    });
    
    if (categories.length === 0) {
        const emptyHtml = '<div style="text-align: center; padding: 1rem; color: var(--text-light);">No categories configured. Add your first category!</div>';
        if (listContainer) listContainer.innerHTML = emptyHtml;
        if (standaloneContainer) standaloneContainer.innerHTML = emptyHtml;
        return;
    }
    
    const categoriesHtml = categories.map((cat, index) => {
        const count = articleCounts[cat.id] || 0;
        const countBadge = count > 0 
            ? `<span style="background: var(--primary-green); color: white; font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 10px; margin-left: 0.5rem;" title="${count} article${count === 1 ? '' : 's'} using this category">${count}</span>`
            : `<span style="background: #e0e0e0; color: var(--text-light); font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 10px; margin-left: 0.5rem;">0</span>`;
        
        return `
        <div class="news-category-item" data-id="${cat.id}" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
            <span style="cursor: grab; color: var(--text-light);">☰</span>
            <span style="font-size: 1.5rem;">${cat.icon}</span>
            <div style="flex: 1;">
                <strong style="color: var(--primary-green);">${cat.name}</strong>
                <span style="color: var(--text-light); font-size: 0.85rem; margin-left: 0.5rem;">(${cat.id})</span>
                ${cat.showFilter !== false ? '<span style="background: var(--accent-gold); color: var(--primary-green); font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 10px; margin-left: 0.5rem;">Filter</span>' : ''}
                ${countBadge}
            </div>
            <button onclick="editNewsCategory('${cat.id}')" class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">✏️</button>
            <button onclick="deleteNewsCategory('${cat.id}')" class="btn btn-danger" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">🗑️</button>
        </div>
    `}).join('');
    
    if (listContainer) listContainer.innerHTML = categoriesHtml;
    if (standaloneContainer) standaloneContainer.innerHTML = categoriesHtml;
    
    initCategoryDragDrop();
}

/**
 * Initialize drag & drop for category reordering
 */
function initCategoryDragDrop() {
    // Apply to both the inline and standalone containers
    ['news-categories-list', 'news-categories-list-standalone'].forEach(containerId => {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const items = container.querySelectorAll('.news-category-item');
        
        items.forEach(item => {
            item.setAttribute('draggable', 'true');
            
            item.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', item.dataset.id);
                item.style.opacity = '0.5';
            });
            
            item.addEventListener('dragend', () => {
                item.style.opacity = '1';
            });
            
            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                item.style.borderTop = '3px solid var(--primary-green)';
            });
            
            item.addEventListener('dragleave', () => {
                item.style.borderTop = '';
            });
            
            item.addEventListener('drop', async (e) => {
                e.preventDefault();
                item.style.borderTop = '';
                
                const draggedId = e.dataTransfer.getData('text/plain');
                const targetId = item.dataset.id;
                
                if (draggedId !== targetId) {
                    await reorderNewsCategories(draggedId, targetId);
                }
            });
        });
    });
}

/**
 * Reorder categories after drag & drop
 */
async function reorderNewsCategories(draggedId, targetId) {
    let categories = await getNewsCategories();
    
    const draggedIndex = categories.findIndex(c => c.id === draggedId);
    const targetIndex = categories.findIndex(c => c.id === targetId);
    
    if (draggedIndex === -1 || targetIndex === -1) return;
    
    const [dragged] = categories.splice(draggedIndex, 1);
    categories.splice(targetIndex, 0, dragged);
    
    categories.forEach((cat, index) => {
        cat.order = index + 1;
    });
    
    const success = await saveNewsCategories(categories);
    if (success) {
        await loadNewsCategoriesList();
    }
}

/**
 * Open the news category modal for adding
 */
function openNewsCategoryModal() {
    document.getElementById('newsCategoryModalTitle').textContent = '🏷️ Add News Category';
    document.getElementById('editingCategoryId').value = '';
    document.getElementById('categoryId').value = '';
    document.getElementById('categoryId').disabled = false;
    document.getElementById('categoryName').value = '';
    document.getElementById('categoryIcon').value = '';
    document.getElementById('categoryShowFilter').checked = true;
    document.getElementById('newsCategoryModal').style.display = 'flex';
}

/**
 * Close the news category modal
 */
function closeNewsCategoryModal() {
    document.getElementById('newsCategoryModal').style.display = 'none';
}

/**
 * Edit an existing news category
 */
async function editNewsCategory(categoryId) {
    const categories = await getNewsCategories();
    const category = categories.find(c => c.id === categoryId);
    
    if (!category) return;
    
    document.getElementById('newsCategoryModalTitle').textContent = '🏷️ Edit News Category';
    document.getElementById('editingCategoryId').value = categoryId;
    document.getElementById('categoryId').value = category.id;
    document.getElementById('categoryId').disabled = true;
    document.getElementById('categoryName').value = category.name;
    document.getElementById('categoryIcon').value = category.icon;
    document.getElementById('categoryShowFilter').checked = category.showFilter !== false;
    document.getElementById('newsCategoryModal').style.display = 'flex';
}

/**
 * Save a news category (add or update)
 */
async function saveNewsCategory(event) {
    event.preventDefault();
    
    const editingId = document.getElementById('editingCategoryId').value;
    const id = document.getElementById('categoryId').value.toLowerCase().replace(/[^a-z0-9-]/g, '');
    const name = document.getElementById('categoryName').value.trim();
    const icon = document.getElementById('categoryIcon').value.trim();
    const showFilter = document.getElementById('categoryShowFilter').checked;
    
    if (!id || !name || !icon) {
        alert('Please fill in all fields');
        return;
    }
    
    const actionText = editingId ? 'Updating category...' : 'Creating category...';
    const successText = editingId ? 'Category updated!' : 'Category created!';
    
    showLoading(actionText);
    
    try {
        let categories = await getNewsCategories();
        
        if (editingId) {
            const index = categories.findIndex(c => c.id === editingId);
            if (index !== -1) {
                categories[index].name = name;
                categories[index].icon = icon;
                categories[index].showFilter = showFilter;
            }
        } else {
            if (categories.some(c => c.id === id)) {
                showLoadingError('A category with this ID already exists');
                return;
            }
            
            categories.push({
                id: id,
                name: name,
                icon: icon,
                order: categories.length + 1,
                showFilter: showFilter
            });
        }
        
        const success = await saveNewsCategories(categories);
        
        if (success) {
            closeNewsCategoryModal();
            await loadNewsCategoriesList();
            await populateNewsCategoryDropdown();
            showLoadingSuccess(successText);
        } else {
            showLoadingError('Failed to save category');
        }
    } catch (error) {
        console.error('Error saving news category:', error);
        showLoadingError('Failed to save category');
    }
}

/**
 * Delete a news category with article count warning
 */
async function deleteNewsCategory(categoryId) {
    const articles = JSON.parse(localStorage.getItem('olrfc_news') || '[]');
    const affectedArticles = articles.filter(a => a.category === categoryId);
    const articleCount = affectedArticles.length;
    
    let warningMessage = `Delete the "${categoryId}" category?`;
    
    if (articleCount > 0) {
        warningMessage += `\n\n⚠️ WARNING: There ${articleCount === 1 ? 'is' : 'are'} ${articleCount} article${articleCount === 1 ? '' : 's'} using this category.\n\n`;
        warningMessage += `These articles will need to be reassigned, otherwise they'll only appear in "All News".`;
    }
    
    if (!confirm(warningMessage)) return;
    
    showLoading('Deleting category...');
    
    try {
        let categories = await getNewsCategories();
        categories = categories.filter(c => c.id !== categoryId);
        categories.forEach((cat, index) => { cat.order = index + 1; });
        
        const success = await saveNewsCategories(categories);
        
        if (success) {
            await loadNewsCategoriesList();
            await populateNewsCategoryDropdown();
            showLoadingSuccess('Category deleted!');
        } else {
            showLoadingError('Failed to delete category');
        }
    } catch (error) {
        console.error('Error deleting news category:', error);
        showLoadingError('Failed to delete category');
    }
}

/**
 * Populate the news category dropdown in the article form
 */
async function populateNewsCategoryDropdown() {
    const dropdown = document.getElementById('newsCategory');
    if (!dropdown) return;
    
    const categories = await getNewsCategories();
    
    dropdown.innerHTML = categories.map(cat => 
        `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`
    ).join('');
}

/**
 * Format category for display
 */
function formatCategory(category) {
    if (cachedNewsCategories) {
        const cat = cachedNewsCategories.find(c => c.id === category);
        if (cat) return `${cat.icon} ${cat.name}`;
    }
    const defaults = { 'match': '🏉 Match Report', 'training': '💪 Training', 'social': '🎉 Social Event', 'club': '📢 Club Update' };
    return defaults[category] || category;
}

// Close modal on outside click
document.getElementById('newsCategoryModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeNewsCategoryModal();
});

// ==========================================
// OLS 130: CLUB SECTIONS MANAGEMENT
// ==========================================

let cachedClubSections = null;

/**
 * Get club sections from site-settings
 */
async function getClubSections() {
    // Return cached if available
    if (cachedClubSections) return cachedClubSections;
    
    // Default sections
    const defaultSections = [
        { id: 'senior', name: 'Senior', icon: '🏉', order: 1, showFilter: true, color: '#e53935' },
        { id: 'ladies', name: 'Ladies', icon: '👩', order: 2, showFilter: true, color: '#43a047' },
        { id: 'minis', name: 'Minis & Juniors', icon: '👶', order: 3, showFilter: true, color: '#1e88e5' }
    ];
    
    try {
        // Try localStorage first
        const cachedSettings = localStorage.getItem('olrfc_site-settings');
        if (cachedSettings) {
            const settings = JSON.parse(cachedSettings);
            if (settings['club-sections']) {
                cachedClubSections = JSON.parse(settings['club-sections']);
                return cachedClubSections;
            }
        }
        
        // Fetch from API
        const response = await fetch('/.netlify/functions/site-settings');
        if (response.ok) {
            const result = await response.json();
            const settings = result.data || {};
            if (settings['club-sections']) {
                cachedClubSections = JSON.parse(settings['club-sections']);
                return cachedClubSections;
            }
        }
    } catch (error) {
        console.error('Error loading club sections:', error);
    }
    
    // Return defaults if nothing found
    cachedClubSections = defaultSections;
    return defaultSections;
}

/**
 * Save club sections to site-settings
 */
async function saveClubSections(sections) {
    try {
        const authHeaders = window.netlifyDataManager ? window.netlifyDataManager.getAuthHeaders() : {};
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', ...authHeaders },
            body: JSON.stringify({ 'club-sections': JSON.stringify(sections) })
        });
        
        if (response.ok) {
            // Update cache
            cachedClubSections = sections;
            
            // Update localStorage
            const cachedSettings = localStorage.getItem('olrfc_site-settings');
            if (cachedSettings) {
                const settings = JSON.parse(cachedSettings);
                settings['club-sections'] = JSON.stringify(sections);
                localStorage.setItem('olrfc_site-settings', JSON.stringify(settings));
            }
            
            return true;
        }
    } catch (error) {
        console.error('Error saving club sections:', error);
    }
    return false;
}

/**
 * Toggle club sections panel visibility
 */
function toggleClubSectionsPanel() {
    const content = document.getElementById('club-sections-content');
    const toggle = document.getElementById('club-sections-toggle');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.style.transform = 'rotate(180deg)';
        loadClubSectionsList();
    } else {
        content.style.display = 'none';
        toggle.style.transform = 'rotate(0deg)';
    }
}

/**
 * Load and display club sections list
 */
async function loadClubSectionsList() {
    const listContainer = document.getElementById('club-sections-list');
    const standaloneContainer = document.getElementById('club-sections-list-standalone');
    
    const sections = await getClubSections();
    
    if (sections.length === 0) {
        const emptyHtml = `
            <div style="text-align: center; padding: 1rem; color: var(--text-light);">
                No sections defined yet. Add your first section!
            </div>
        `;
        if (listContainer) listContainer.innerHTML = emptyHtml;
        if (standaloneContainer) standaloneContainer.innerHTML = emptyHtml;
        return;
    }
    
    // Sort by order
    sections.sort((a, b) => (a.order || 99) - (b.order || 99));
    
    // Count teams in each section
    const teams = JSON.parse(localStorage.getItem('olrfc_teams') || '[]');
    
    const sectionsHtml = sections.map(section => {
        const teamCount = teams.filter(t => t.clubSection === section.id).length;
        const sectionColor = section.color || '#9e9e9e';
        return `
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: white; border-radius: 8px; border: 1px solid #e0e0e0; border-left: 4px solid ${sectionColor};">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span style="font-size: 1.5rem;">${section.icon || '📁'}</span>
                    <div>
                        <div style="font-weight: bold; color: var(--primary-green);">${section.name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-light);">
                            <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: ${sectionColor}; vertical-align: middle; margin-right: 4px;"></span>
                            ID: ${section.id} • ${teamCount} team${teamCount !== 1 ? 's' : ''}
                            ${section.showFilter ? ' • Shows in filters' : ''}
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="editClubSection('${section.id}')" class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">✏️</button>
                    <button onclick="deleteClubSection('${section.id}')" class="btn btn-danger" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">🗑️</button>
                </div>
            </div>
        `;
    }).join('');
    
    if (listContainer) listContainer.innerHTML = sectionsHtml;
    if (standaloneContainer) standaloneContainer.innerHTML = sectionsHtml;
}

/**
 * Open club section modal for adding
 */
function openClubSectionModal() {
    document.getElementById('clubSectionModalTitle').textContent = '🏢 Add Club Section';
    document.getElementById('editingClubSectionId').value = '';
    document.getElementById('clubSectionId').value = '';
    document.getElementById('clubSectionId').disabled = false;
    document.getElementById('clubSectionName').value = '';
    document.getElementById('clubSectionIcon').value = '';
    document.getElementById('clubSectionColor').value = '#9e9e9e';
    document.getElementById('clubSectionColorHex').textContent = '#9e9e9e';
    document.getElementById('clubSectionShowFilter').checked = true;
    document.getElementById('clubSectionTrainingSortOrder').value = '10';
    document.getElementById('clubSectionModal').style.display = 'flex';
}

/**
 * Close club section modal
 */
function closeClubSectionModal() {
    document.getElementById('clubSectionModal').style.display = 'none';
}

/**
 * Edit an existing club section
 */
async function editClubSection(sectionId) {
    const sections = await getClubSections();
    const section = sections.find(s => s.id === sectionId);
    
    if (!section) return;
    
    document.getElementById('clubSectionModalTitle').textContent = '🏢 Edit Club Section';
    document.getElementById('editingClubSectionId').value = sectionId;
    document.getElementById('clubSectionId').value = section.id;
    document.getElementById('clubSectionId').disabled = true;
    document.getElementById('clubSectionName').value = section.name;
    document.getElementById('clubSectionIcon').value = section.icon || '';
    document.getElementById('clubSectionColor').value = section.color || '#9e9e9e';
    document.getElementById('clubSectionColorHex').textContent = section.color || '#9e9e9e';
    document.getElementById('clubSectionShowFilter').checked = section.showFilter !== false;
    document.getElementById('clubSectionTrainingSortOrder').value = section.trainingSortOrder || 10;
    document.getElementById('clubSectionModal').style.display = 'flex';
}

/**
 * Save a club section (add or update)
 */
async function saveClubSection(event) {
    event.preventDefault();
    
    const editingId = document.getElementById('editingClubSectionId').value;
    const id = document.getElementById('clubSectionId').value.toLowerCase().replace(/[^a-z0-9-]/g, '');
    const name = document.getElementById('clubSectionName').value.trim();
    const icon = document.getElementById('clubSectionIcon').value.trim();
    const color = document.getElementById('clubSectionColor').value || '#9e9e9e';
    const showFilter = document.getElementById('clubSectionShowFilter').checked;
    const trainingSortOrder = parseInt(document.getElementById('clubSectionTrainingSortOrder').value) || 10;
    
    if (!id || !name) {
        alert('Please fill in Section ID and Display Name');
        return;
    }
    
    const actionText = editingId ? 'Updating section...' : 'Creating section...';
    const successText = editingId ? 'Section updated!' : 'Section created!';
    
    showLoading(actionText);
    
    try {
        let sections = await getClubSections();
        
        if (editingId) {
            // Update existing
            const index = sections.findIndex(s => s.id === editingId);
            if (index !== -1) {
                sections[index].name = name;
                sections[index].icon = icon;
                sections[index].color = color;
                sections[index].showFilter = showFilter;
                sections[index].trainingSortOrder = trainingSortOrder;
            }
        } else {
            // Check for duplicate ID
            if (sections.some(s => s.id === id)) {
                showLoadingError('A section with this ID already exists');
                return;
            }
            
            // Add new
            sections.push({
                id: id,
                name: name,
                icon: icon,
                color: color,
                order: sections.length + 1,
                showFilter: showFilter,
                trainingSortOrder: trainingSortOrder
            });
        }
        
        const success = await saveClubSections(sections);
        
        if (success) {
            closeClubSectionModal();
            await loadClubSectionsList();
            await populateClubSectionDropdown();
            showLoadingSuccess(successText);
        } else {
            showLoadingError('Failed to save section');
        }
    } catch (error) {
        console.error('Error saving club section:', error);
        showLoadingError('Failed to save section');
    }
}

/**
 * Delete a club section
 */
async function deleteClubSection(sectionId) {
    const teams = JSON.parse(localStorage.getItem('olrfc_teams') || '[]');
    const affectedTeams = teams.filter(t => t.clubSection === sectionId);
    const teamCount = affectedTeams.length;
    
    let warningMessage = `Delete the "${sectionId}" section?`;
    
    if (teamCount > 0) {
        warningMessage += `\n\n⚠️ WARNING: ${teamCount} team${teamCount === 1 ? ' is' : 's are'} assigned to this section.\n\n`;
        warningMessage += `These teams will become unassigned.`;
    }
    
    if (!confirm(warningMessage)) return;
    
    showLoading('Deleting section...');
    
    try {
        let sections = await getClubSections();
        sections = sections.filter(s => s.id !== sectionId);
        sections.forEach((s, index) => { s.order = index + 1; });
        
        const success = await saveClubSections(sections);
        
        if (success) {
            await loadClubSectionsList();
            await populateClubSectionDropdown();
            showLoadingSuccess('Section deleted!');
        } else {
            showLoadingError('Failed to delete section');
        }
    } catch (error) {
        console.error('Error deleting club section:', error);
        showLoadingError('Failed to delete section');
    }
}

/**
 * Open the Add Team modal with properly populated dropdown
 */
async function openAddTeamModal() {
    await populateClubSectionDropdown();
    // Reset the form for new team
    document.getElementById('teamForm').reset();
    document.getElementById('teamShowInTraining').checked = false;
    document.getElementById('teamTrainingNotes').value = '';
    document.getElementById('teamTrainingFields').style.display = 'none';
    clearTrainingSlots();
    document.getElementById('teamDisplayOrder').value = '10';
    document.getElementById('teamClubSection').value = '';
    adminSystem.currentEditIndex = null;
    openModal('teamModal');
}

/**
 * Populate the club section dropdown in the team form
 */
async function populateClubSectionDropdown() {
    const dropdown = document.getElementById('teamClubSection');
    if (!dropdown) return;
    
    const sections = await getClubSections();
    console.log('📂 Populating club section dropdown with:', sections.map(s => ({ id: s.id, name: s.name })));
    
    dropdown.innerHTML = '<option value="">— No Section —</option>' + 
        sections.map(s => `<option value="${s.id}">${s.icon ? s.icon + ' ' : ''}${s.name}</option>`).join('');
}

/**
 * Populate the club section dropdown in the news form (OLS 130)
 * Includes "All Sections" as the first/default option
 */
async function populateNewsClubSectionDropdown() {
    const dropdown = document.getElementById('newsClubSection');
    if (!dropdown) return;
    
    const sections = await getClubSections();
    
    dropdown.innerHTML = '<option value="all">🏢 All Sections (Club-wide)</option>' + 
        sections.filter(s => s.showFilter !== false).map(s => 
            `<option value="${s.id}">${s.icon} ${s.name}</option>`
        ).join('');
}

/**
 * Get section info by ID
 */
async function getClubSectionInfo(sectionId) {
    if (!sectionId) return null;
    const sections = await getClubSections();
    return sections.find(s => s.id === sectionId);
}

// Close modal on outside click
document.getElementById('clubSectionModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeClubSectionModal();
});

// ==========================================
// END OLS 130: CLUB SECTIONS MANAGEMENT
// ==========================================

// ==========================================
// OLS 128: DEFAULT MATCH IMAGES MANAGEMENT
// ==========================================

/**
 * Load and display current default match images
 */
async function loadDefaultMatchImagePreviews() {
    const winPreview = document.getElementById('default-win-image-preview');
    const lossPreview = document.getElementById('default-loss-image-preview');
    
    if (!winPreview || !lossPreview) return;
    
    try {
        let settings = null;
        const cachedSettings = localStorage.getItem('olrfc_site-settings');
        if (cachedSettings) {
            settings = JSON.parse(cachedSettings);
        } else {
            const response = await fetch('/.netlify/functions/site-settings');
            if (response.ok) {
                const result = await response.json();
                settings = result.data || {};
            }
        }
        
        if (settings) {
            if (settings['default-match-win-image']) {
                winPreview.innerHTML = `<img src="${settings['default-match-win-image']}" alt="Win image" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                winPreview.innerHTML = `<span style="color: var(--text-light); font-size: 0.9rem;">No image set<br><small>(shows gradient placeholder)</small></span>`;
            }
            
            if (settings['default-match-loss-image']) {
                lossPreview.innerHTML = `<img src="${settings['default-match-loss-image']}" alt="Loss image" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                lossPreview.innerHTML = `<span style="color: var(--text-light); font-size: 0.9rem;">No image set<br><small>(shows gradient placeholder)</small></span>`;
            }
        }
    } catch (error) {
        console.error('Error loading default match images:', error);
    }
}

/**
 * Upload a default match image (win or loss)
 */
async function uploadDefaultMatchImage(type, input) {
    const file = input.files[0];
    if (!file) return;
    
    const previewId = type === 'win' ? 'default-win-image-preview' : 'default-loss-image-preview';
    const preview = document.getElementById(previewId);
    const settingKey = type === 'win' ? 'default-match-win-image' : 'default-match-loss-image';
    
    preview.innerHTML = `<span style="color: var(--text-light);">⏳ Uploading...</span>`;
    
    try {
        if (!window.cloudinaryUploader) throw new Error('Cloudinary uploader not available');
        
        const imageUrl = await window.cloudinaryUploader.uploadImage(file, 'news-defaults');
        if (!imageUrl) throw new Error('Upload failed');
        
        const response = await fetch('/.netlify/functions/site-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [settingKey]: imageUrl })
        });
        
        if (!response.ok) throw new Error('Failed to save');
        
        const cachedSettings = localStorage.getItem('olrfc_site-settings');
        if (cachedSettings) {
            const settings = JSON.parse(cachedSettings);
            settings[settingKey] = imageUrl;
            localStorage.setItem('olrfc_site-settings', JSON.stringify(settings));
        }
        
        preview.innerHTML = `<img src="${imageUrl}" alt="${type} image" style="width: 100%; height: 100%; object-fit: cover;">`;
        input.value = '';
        alert(`✅ Default ${type} image saved!`);
        
    } catch (error) {
        console.error(`Error uploading ${type} image:`, error);
        preview.innerHTML = `<span style="color: #dc3545;">❌ Upload failed</span>`;
        alert(`Failed to upload: ${error.message}`);
        input.value = '';
    }
}

// ==========================================
// OLS 132: SIDEBAR NAVIGATION FUNCTIONS
// ==========================================

/**
 * Toggle sidebar section expand/collapse
 */
function toggleSidebarSection(header) {
    const links = header.nextElementSibling;
    header.classList.toggle('collapsed');
    links.classList.toggle('collapsed');
}

/**
 * Toggle mobile sidebar
 */
function toggleSidebar() {
    const sidebar = document.getElementById('adminSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    sidebar.classList.toggle('open');
    overlay.classList.toggle('open');
}

/**
 * Close sidebar on mobile after navigation
 */
function closeSidebarMobile() {
    if (window.innerWidth <= 900) {
        const sidebar = document.getElementById('adminSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.remove('open');
        overlay.classList.remove('open');
    }
}

/**
 * Update sidebar active state
 */
function updateSidebarActive(sectionId) {
    // Remove active from all links
    document.querySelectorAll('.sidebar-link, .sidebar-solo-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // Add active to matching link
    const activeLink = document.querySelector(`.sidebar-link[href="#${sectionId}"], .sidebar-solo-link[href="#${sectionId}"]`);
    if (activeLink) {
        activeLink.classList.add('active');
        
        // Expand parent section if collapsed
        const parentSection = activeLink.closest('.sidebar-section');
        if (parentSection) {
            const header = parentSection.querySelector('.sidebar-header');
            const links = parentSection.querySelector('.sidebar-links');
            if (header && links && links.classList.contains('collapsed')) {
                header.classList.remove('collapsed');
                links.classList.remove('collapsed');
            }
        }
    }
}

/**
 * Update sidebar enquiry badge
 */
function updateSidebarEnquiryBadge(count) {
    const badge = document.getElementById('sidebar-enquiry-badge');
    if (badge) {
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }
}

// Initialize sidebar state on load
document.addEventListener('DOMContentLoaded', function() {
    // Check URL hash for initial section
    const hash = window.location.hash.replace('#', '');
    if (hash) {
        updateSidebarActive(hash);
    }
});
</script>

        </div><!-- /.container -->
        </main><!-- /.admin-main -->
    </div><!-- /.admin-layout -->

<!-- OLS 132: League Table Modal - Moved outside admin-sections so it displays properly -->
<div id="league-table-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 15px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin: 0 0 1.5rem 0; color: var(--primary-green);" id="league-modal-title">Add League Table</h3>
        
        <input type="hidden" id="league-edit-id">
        <input type="hidden" id="league-modal-division">
        <input type="hidden" id="league-modal-competition">
        <input type="hidden" id="league-modal-season">
        <input type="hidden" id="league-modal-teamid">
        <input type="hidden" id="league-modal-tableindex" value="0">
        
        <div style="display: grid; gap: 1rem;">
            <!-- Team Selection -->
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Team</label>
                <select id="league-team-select" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                    <option value="">Select a team...</option>
                </select>
            </div>
            
            <!-- RFU URL Input -->
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">England Rugby League URL</label>
                <input type="url" id="league-modal-url" 
                       placeholder="https://www.englandrugby.com/fixtures-and-results/search-results?competition=1597&division=66509&season=2025-2026#tables" 
                       oninput="parseLeagueUrl(this.value)"
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.9rem;">
                <small style="color: var(--text-light);">Go to englandrugby.com, find your league table, copy the URL</small>
                
                <!-- Parsed Values Display -->
                <div id="league-url-parsed" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: rgba(var(--primary-green-rgb), 0.1); border-radius: 8px; font-size: 0.85rem;">
                    <!-- Content populated by parseLeagueUrl() -->
                </div>
                
                <!-- Error Display -->
                <div id="league-url-error" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: rgba(220, 53, 69, 0.1); border-radius: 8px; font-size: 0.85rem; color: #dc3545;">
                    ❌ Could not parse URL. Make sure it's from englandrugby.com with division, competition, and season parameters.
                </div>
            </div>
            
            <!-- OLS 132: Table Scanner -->
            <div>
                <button type="button" onclick="scanForLeagueTables()" class="btn btn-secondary" style="width: 100%; padding: 0.75rem;" id="league-scan-btn">
                    🔍 Scan for Tables
                </button>
                <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">After pasting URL, scan to find available tables on that page</small>
                
                <!-- Scanning Status -->
                <div id="league-scan-status" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px; text-align: center;">
                    <span style="color: var(--text-light);">⏳ Scanning page for tables...</span>
                </div>
                
                <!-- Table Selection -->
                <div id="league-table-selection" style="display: none; margin-top: 0.75rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Select Table to Use:</label>
                    <div id="league-table-options" style="display: grid; gap: 0.5rem;">
                        <!-- Populated by scanForLeagueTables() -->
                    </div>
                </div>
            </div>
            
            <!-- Club Name in League -->
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Club Name in League</label>
                <input type="text" id="league-modal-clubname" placeholder="Old Laurentian" 
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                <small style="color: var(--text-light);">Exact name as shown in RFU table (for highlighting your row)</small>
            </div>
            
            <!-- Default Toggle -->
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" id="league-modal-default" style="width: 18px; height: 18px;">
                <label for="league-modal-default" style="font-weight: bold; cursor: pointer;">Set as default (shows first on homepage)</label>
            </div>
        </div>
        
        <!-- Modal Buttons -->
        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button onclick="saveLeagueTable()" class="btn" style="flex: 1;">💾 Save</button>
            <button onclick="closeLeagueTableModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
        </div>
    </div>
</div>

</body>
</html>
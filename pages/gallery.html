<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Gallery</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <script src="../js/sanitize-html.js"></script>
    <script src="../js/shared-settings.js"></script>
    <script src="../js/color-manager.js"></script>
    <style>
        /* Admin controlled elements */
        .nav-item[data-admin-controlled="true"] {
            display: none;
        }

        .nav-item[data-admin-controlled="true"].admin-enabled {
            display: block;
        }

        /* Gallery Styles */
        .gallery-hero {
            background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon));
            color: white;
            padding: 3rem 2rem;
            text-align: center;
            margin-top: 80px;
        }

        .gallery-hero h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .gallery-hero p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .gallery-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        /* Loading State */
        .loading-spinner {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--bg-light);
            border-top-color: var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Filter Section */
        .filters-section {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .filter-group {
            margin-bottom: 1.5rem;
        }

        .filter-group:last-child {
            margin-bottom: 0;
        }

        .filter-label {
            font-weight: bold;
            color: var(--primary-green);
            font-size: 1rem;
            margin-bottom: 0.8rem;
            display: block;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
        }

        .filter-btn {
            padding: 0.6rem 1.2rem;
            border: 2px solid var(--primary-green);
            background: white;
            color: var(--primary-green);
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .filter-btn:hover {
            background: var(--bg-light);
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: var(--primary-green);
            color: white;
            box-shadow: 0 4px 12px rgba(var(--primary-green-rgb), 0.3);
        }

        .filter-btn.season-btn.active {
            background: var(--primary-maroon);
            border-color: var(--primary-maroon);
        }

        /* Team Filter Dropdown (Mobile Only) */
        .team-filter-dropdown {
            display: none; /* Hidden on desktop */
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid var(--primary-green);
            border-radius: 10px;
            background: white;
            color: var(--primary-green);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%232e5016' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 12px;
            padding-right: 2.5rem;
        }

        .team-filter-dropdown:focus {
            outline: none;
            border-color: var(--primary-maroon);
            box-shadow: 0 0 0 3px rgba(var(--primary-green-rgb), 0.1);
        }

        /* Desktop: Show buttons, hide dropdown */
        .team-filter-buttons {
            display: flex; /* Visible on desktop */
        }

        /* Team Badge on Album Card */
        .team-badge {
            display: inline-block;
            background: var(--primary-green);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        /* Albums Grid */
        .albums-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .album-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .album-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .album-cover {
            width: 100%;
            height: 250px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .album-cover::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        }

        .photo-count {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            color: var(--primary-green);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            z-index: 1;
        }

        .album-info {
            padding: 1.5rem;
        }

        .album-title {
            font-size: 1.3rem;
            color: var(--primary-green);
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .album-category {
            display: inline-block;
            background: var(--accent-gold);
            color: var(--primary-green);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .album-description {
            color: var(--text-light);
            font-size: 0.95rem;
            margin-top: 0.5rem;
        }

        .album-date {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        /* Photo Modal */
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            overflow-y: auto;
        }

        .photo-modal.active {
            display: block;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon));
            color: white;
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 10001;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .close-modal {
            background: white;
            color: var(--primary-green);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: var(--accent-gold);
            transform: rotate(90deg);
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .photo-item:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            color: var(--primary-green);
            margin-bottom: 1rem;
        }

        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 20000;
            align-items: center;
            justify-content: center;
        }

        .lightbox.active {
            display: flex;
        }

        .lightbox-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .lightbox-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            color: var(--primary-green);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 2rem;
            cursor: pointer;
            z-index: 20001;
        }

        /* üéØ PREVENT FLASH OF DEFAULT CONTENT */
        .gallery-hero {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .cms-content-loaded .gallery-hero {
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .gallery-hero {
                padding: 2rem 1rem;
                margin-top: 70px;
            }

            .gallery-hero h1 {
                font-size: 1.8rem;
            }

            .filters-section {
                padding: 1.5rem;
            }

            .filter-label {
                font-size: 0.9rem;
            }

            .filter-btn {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }

            /* Mobile: Hide team filter buttons, show dropdown */
            .team-filter-buttons {
                display: none !important;
            }

            .team-filter-dropdown {
                display: block !important;
            }

            .albums-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .photos-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                padding: 1rem;
                gap: 0.5rem;
            }

            .modal-header {
                padding: 1rem;
            }

            .modal-title {
                font-size: 1.2rem;
            }
        }

        /* Photographer Credit Section */
        .photographer-credit {
            background: linear-gradient(135deg, rgba(var(--primary-green-rgb), 0.05), rgba(var(--primary-maroon-rgb), 0.05));
            border-top: 3px solid var(--accent-gold);
            padding: 2rem;
            margin: 3rem 0 0 0;
            text-align: center;
        }

        .photographer-credit-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .photographer-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            display: block;
        }

        .photographer-credit h3 {
            color: var(--primary-green);
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .photographer-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary-maroon);
            margin-bottom: 0.5rem;
        }

        .photographer-credit p {
            color: var(--text-light);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .photographer-link {
            display: inline-block;
            margin-top: 1rem;
            color: var(--primary-green);
            text-decoration: none;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            border: 2px solid var(--primary-green);
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .photographer-link:hover {
            background: var(--primary-green);
            color: white;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .photographer-credit {
                padding: 1.5rem 1rem;
                margin: 2rem 0 0 0;
            }

            .photographer-icon {
                font-size: 2rem;
            }

            .photographer-credit h3 {
                font-size: 1.1rem;
            }

            .photographer-name {
                font-size: 1rem;
            }

            .photographer-credit p {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header-placeholder" data-page="gallery"></div>

    <!-- Gallery Hero -->
    <section class="gallery-hero">
        <h1>üì∏ Photo Gallery</h1>
        <p>Relive the best moments from our club</p>
    </section>

    <!-- Gallery Container -->
    <main class="gallery-container">
        <!-- Loading State -->
        <div id="loadingState" class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading albums...</p>
        </div>

        <!-- Filters Section -->
        <div id="filtersSection" class="filters-section" style="display: none;">
            <!-- Team Filter -->
            <div class="filter-group">
                <label class="filter-label">üèâ Filter by Team:</label>
                
                <!-- Mobile Dropdown (hidden on desktop) -->
                <select id="teamFilterDropdown" class="team-filter-dropdown">
                    <!-- Team options populated dynamically from Netlify -->
                </select>
                
                <!-- Desktop Buttons (hidden on mobile) -->
                <div class="filter-buttons team-filter-buttons">
                    <!-- Team buttons populated dynamically from Netlify -->
                </div>
            </div>

            <!-- Season Filter -->
            <div class="filter-group">
                <label class="filter-label">üìÖ Filter by Season:</label>
                <div class="filter-buttons" id="seasonFilters">
                    <button class="filter-btn season-filter active" data-season="all">All Seasons</button>
                    <!-- Dynamic season buttons will be added here -->
                </div>
            </div>

            <!-- Sort by Date -->
            <div class="filter-group">
                <label class="filter-label">üìÜ Sort by Date:</label>
                <div class="filter-buttons">
                    <button class="filter-btn sort-btn active" data-sort="newest">Newest First</button>
                    <button class="filter-btn sort-btn" data-sort="oldest">Oldest First</button>
                </div>
            </div>
        </div>

        <!-- Albums Grid -->
        <div id="albumsGrid" class="albums-grid" style="display: none;"></div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-icon">üì∑</div>
            <h3>No Albums Yet</h3>
            <p>Check back soon for photos from matches, training, and club events!</p>
        </div>
    </main>

    <!-- Photographer Credit -->
    <section class="photographer-credit">
        <div class="photographer-credit-content">
            <span class="photographer-icon">üì∏</span>
            <h3>Photography Credit</h3>
            <div class="photographer-name">Chris Reading</div>
            <p>All photos captured by our dedicated club photographer. Thank you Chris for capturing these memorable moments!</p>
            <div style="display: flex; gap: 1rem; justify-content: center; align-items: center; margin-top: 1.5rem; flex-wrap: wrap;">
                <a href="https://www.instagram.com/chrisreadingfoto" target="_blank" class="photographer-link" style="margin: 0;">
                    üì∑ Instagram
                </a>
                <a href="https://www.facebook.com/Chrisreadingfoto" target="_blank" class="photographer-link" style="margin: 0;">
                    üë§ Facebook
                </a>
                <a href="/cdn-cgi/l/email-protection#5a3932283329283f3b3e33343d3c352e351a3d373b333674393537" class="photographer-link" style="margin: 0;">
                    ‚úâÔ∏è Email Chris
                </a>
            </div>
        </div>
    </section>

    <!-- Photo Modal -->
    <div id="photoModal" class="photo-modal">
        <div class="modal-header">
            <div>
                <div class="modal-title" id="modalAlbumTitle"></div>
                <small id="modalPhotoCount"></small>
            </div>
            <button class="close-modal" onclick="closePhotoModal()">√ó</button>
        </div>
        <div class="photos-grid" id="photosGrid"></div>
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <button class="lightbox-close">√ó</button>
        <div class="lightbox-content">
            <img id="lightboxImage" src="" alt="Full size photo">
        </div>
    </div>

    <!-- Footer -->
    <div id="footer-placeholder" data-page="gallery"></div>

    <!-- Scripts -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="../js/main.js"></script>
    <script src="../js/header.js"></script>
    <script src="../js/footer.js"></script>
    <script src="../js/seo-manager.js"></script>
    <script>
        // Load feature states from admin settings (STILL FROM FORMS - NOT MIGRATED YET)
        async function loadFeatureStates() {
            try {
                const response = await fetch('/.netlify/functions/netlify-forms-get?form_name=admin-settings');
                
                if (!response.ok) {
                    throw new Error('Failed to fetch settings');
                }
                
                const result = await response.json();
                const settings = result.data || [];
                
                const featureStates = {
                    shop: false,
                    events: false,
                    members: false,
                    payments: false,
                    sponsors: false
                };
                
                settings.reverse();
                settings.forEach(setting => {
                    if (setting['setting-name']?.startsWith('feature-')) {
                        const featureName = setting['setting-name'].replace('feature-', '');
                        if (featureStates.hasOwnProperty(featureName)) {
                            featureStates[featureName] = setting['setting-value'] === 'true';
                        }
                    }
                });
                
                window.featureStates = featureStates;
                
                // Apply saved states to navigation
                Object.keys(featureStates).forEach(feature => {
                    const navItems = document.querySelectorAll(`[data-admin-controlled="true"][data-feature="${feature}"]`);
                    navItems.forEach(item => {
                        item.classList.toggle('admin-enabled', featureStates[feature]);
                    });
                });
                
                return featureStates;
                
            } catch (error) {
                console.error('‚ùå Error loading feature states:', error);
                
                const fallbackStates = {
                    shop: false,
                    events: false,
                    members: false,
                    payments: false,
                    sponsors: true
                };
                
                window.featureStates = fallbackStates;
                return fallbackStates;
            }
        }

        // Gallery Loader - NOW LOADS FROM NETLIFY BLOBS (OLS 88)
        class GalleryLoader {
            constructor() {
                this.albums = [];
                this.currentAlbum = null;
                this.currentTeamFilter = 'all';
                this.currentSeasonFilter = 'all';
                this.currentSortOrder = 'newest'; // Default to newest first
                this.availableSeasons = new Set();
            }

            async loadAlbums() {
                try {
                    console.log('üì° Loading gallery albums...');
                    
                    // STEP 1: Try to fetch from Netlify Blobs (works on all devices)
                    let netlifyAlbums = await this.fetchFromNetlify();
                    
                    if (netlifyAlbums && netlifyAlbums.length > 0) {
                        console.log(`‚úÖ Loaded ${netlifyAlbums.length} album(s) from Netlify Blobs`);
                        this.albums = netlifyAlbums;
                        
                        // Save to localStorage for faster future loads
                        localStorage.setItem('olrfc_gallery', JSON.stringify(netlifyAlbums));
                    } else {
                        // STEP 2: Fallback to localStorage if Netlify fetch fails
                        console.log('‚ö†Ô∏è Netlify fetch failed or empty, trying localStorage...');
                        const storedAlbums = localStorage.getItem('olrfc_gallery');
                        
                        if (storedAlbums) {
                            this.albums = JSON.parse(storedAlbums);
                            console.log(`‚úÖ Loaded ${this.albums.length} album(s) from localStorage`);
                        } else {
                            console.log('üì≠ No albums found in localStorage either');
                            this.albums = [];
                        }
                    }
                    
                    // Parse and process albums
                    if (this.albums.length > 0) {
                        this.albums = this.albums.map(album => {
                            const parsedAlbum = {
                                ...album,
                                photos: typeof album.photos === 'string' 
                                    ? JSON.parse(album.photos) 
                                    : album.photos,
                                photoCount: parseInt(album.photoCount || album.photos?.length || 0),
                                team: album.team || 'other' // Fallback for old albums
                            };
                            
                            // Calculate and add season
                            parsedAlbum.season = this.calculateSeason(parsedAlbum.date);
                            this.availableSeasons.add(parsedAlbum.season);
                            
                            return parsedAlbum;
                        });
                    }

                    this.generateSeasonFilters();
                    this.displayAlbums();
                    this.initializeFilters();
                } catch (error) {
                    console.error('‚ùå Error loading gallery:', error);
                    this.showEmptyState();
                }
            }

            async fetchFromNetlify() {
                try {
                    console.log('‚òÅÔ∏è Fetching albums from Netlify Blobs...');
                    
                    const response = await fetch('/.netlify/functions/gallery', {
                        method: 'GET'
                    });

                    if (!response.ok) {
                        throw new Error(`Netlify fetch failed: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || 'Failed to fetch gallery');
                    }
                    
                    const albums = result.data || [];

                    // Photos are already arrays in Blobs (no need to parse)
                    return albums;
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è Netlify fetch error:', error.message);
                    return null;
                }
            }

            calculateSeason(dateString) {
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = date.getMonth() + 1; // 0-indexed, so +1
                
                // Season runs August to June
                // If month is Aug-Dec, season is year/year+1
                // If month is Jan-Jun, season is year-1/year
                if (month >= 8) {
                    return `${year}/${String(year + 1).slice(2)}`;
                } else {
                    return `${year - 1}/${String(year).slice(2)}`;
                }
            }

            generateSeasonFilters() {
                const seasonFilters = document.getElementById('seasonFilters');
                
                // Keep the "All Seasons" button
                const allButton = seasonFilters.querySelector('[data-season="all"]');
                seasonFilters.innerHTML = '';
                seasonFilters.appendChild(allButton);
                
                // Sort seasons in descending order (newest first)
                const sortedSeasons = Array.from(this.availableSeasons).sort().reverse();
                
                sortedSeasons.forEach(season => {
                    const button = document.createElement('button');
                    button.className = 'filter-btn season-filter';
                    button.dataset.season = season;
                    button.textContent = season;
                    seasonFilters.appendChild(button);
                });
            }

            displayAlbums() {
                const loadingState = document.getElementById('loadingState');
                const filtersSection = document.getElementById('filtersSection');
                const albumsGrid = document.getElementById('albumsGrid');
                const emptyState = document.getElementById('emptyState');

                loadingState.style.display = 'none';

                if (this.albums.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }

                // Show filters
                filtersSection.style.display = 'block';
                albumsGrid.style.display = 'grid';
                albumsGrid.innerHTML = '';

                // Filter albums based on current filters
                let filteredAlbums = this.albums;

                // Apply team filter
                if (this.currentTeamFilter !== 'all') {
                    filteredAlbums = filteredAlbums.filter(album => 
                        album.team === this.currentTeamFilter
                    );
                }

                // Apply season filter
                if (this.currentSeasonFilter !== 'all') {
                    filteredAlbums = filteredAlbums.filter(album => 
                        album.season === this.currentSeasonFilter
                    );
                }

                // Sort albums by date based on current sort order
                const sortedAlbums = [...filteredAlbums].sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    
                    if (this.currentSortOrder === 'newest') {
                        return dateB - dateA; // Newest first (default)
                    } else {
                        return dateA - dateB; // Oldest first
                    }
                });

                // Show empty state if no albums match filters
                if (sortedAlbums.length === 0) {
                    albumsGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: var(--text-light);"><h3>No albums found</h3><p>Try adjusting your filters</p></div>';
                    return;
                }

                sortedAlbums.forEach(album => {
                    const albumCard = this.createAlbumCard(album);
                    albumsGrid.appendChild(albumCard);
                });

                console.log(`üìä Showing ${sortedAlbums.length} of ${this.albums.length} albums`);
            }

            createAlbumCard(album) {
                const card = document.createElement('div');
                card.className = 'album-card';
                card.onclick = () => this.openAlbum(album);

                // Get cover photo (first photo in album)
                const coverPhoto = album.photos && album.photos[0] 
                    ? album.photos[0].url 
                    : 'https://via.placeholder.com/400x300?text=No+Photos';

                // Format date
                const albumDate = new Date(album.date).toLocaleDateString('en-GB', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

                // Category display
                const categoryMap = {
                    'matches': 'üèâ Match Day',
                    'training': 'üí™ Training',
                    'social': 'üéâ Social',
                    'team': 'üë• Team Photo'
                };
                const categoryDisplay = categoryMap[album.category] || album.category;

                // Team display
                const teamMap = {
                    'mens-1st': "Men's 1st XV",
                    'mens-2nd': "Men's 2nd XV",
                    'ladies': 'Phoenix Ladies',
                    'colts': 'Colts',
                    'other': 'Club'
                };
                const teamDisplay = teamMap[album.team] || 'Club';

                card.innerHTML = `
                    <div class="album-cover" style="background-image: url('${coverPhoto}')">
                        <div class="photo-count">üì∏ ${album.photoCount || album.photos?.length || 0}</div>
                    </div>
                    <div class="album-info">
                        <div class="team-badge">${teamDisplay}</div>
                        <div class="album-category">${categoryDisplay}</div>
                        <h3 class="album-title">${album.title}</h3>
                        <p class="album-date">${albumDate} ‚Ä¢ ${album.season}</p>
                        ${album.description ? `<p class="album-description">${album.description}</p>` : ''}
                    </div>
                `;

                return card;
            }

            openAlbum(album) {
                this.currentAlbum = album;
                const modal = document.getElementById('photoModal');
                const modalTitle = document.getElementById('modalAlbumTitle');
                const modalPhotoCount = document.getElementById('modalPhotoCount');
                const photosGrid = document.getElementById('photosGrid');

                modalTitle.textContent = album.title;
                modalPhotoCount.textContent = `${album.photoCount || album.photos?.length || 0} photos`;

                photosGrid.innerHTML = '';

                if (album.photos && album.photos.length > 0) {
                    album.photos.forEach((photo, index) => {
                        const photoItem = document.createElement('div');
                        photoItem.className = 'photo-item';
                        photoItem.onclick = () => this.openLightbox(photo.url);

                        photoItem.innerHTML = `<img src="${photo.url}" alt="Photo ${index + 1}" loading="lazy">`;
                        photosGrid.appendChild(photoItem);
                    });
                }

                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            openLightbox(imageUrl) {
                const lightbox = document.getElementById('lightbox');
                const lightboxImage = document.getElementById('lightboxImage');

                lightboxImage.src = imageUrl;
                lightbox.classList.add('active');
            }

            initializeFilters() {
                // Team filter dropdown (mobile)
                const teamDropdown = document.getElementById('teamFilterDropdown');
                teamDropdown.addEventListener('change', (e) => {
                    this.currentTeamFilter = e.target.value;
                    this.displayAlbums();
                    console.log(`üèâ Team filter (dropdown): ${this.currentTeamFilter}`);
                    
                    // Sync with desktop buttons (keep them in sync)
                    const teamFilters = document.querySelectorAll('.team-filter');
                    teamFilters.forEach(btn => {
                        if (btn.dataset.team === e.target.value) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                });

                // Team filter buttons (desktop)
                const teamFilters = document.querySelectorAll('.team-filter');
                teamFilters.forEach(button => {
                    button.addEventListener('click', () => {
                        // Remove active class from all team filters
                        teamFilters.forEach(btn => btn.classList.remove('active'));
                        // Add active class to clicked button
                        button.classList.add('active');
                        // Update filter and re-display
                        this.currentTeamFilter = button.dataset.team;
                        this.displayAlbums();
                        console.log(`üèâ Team filter: ${this.currentTeamFilter}`);
                        
                        // Sync dropdown value
                        teamDropdown.value = button.dataset.team;
                    });
                });

                // Season filter buttons
                const seasonFilters = document.querySelectorAll('.season-filter');
                seasonFilters.forEach(button => {
                    button.addEventListener('click', () => {
                        // Remove active class from all season filters
                        seasonFilters.forEach(btn => btn.classList.remove('active'));
                        // Add active class to clicked button
                        button.classList.add('active');
                        // Update filter and re-display
                        this.currentSeasonFilter = button.dataset.season;
                        this.displayAlbums();
                        console.log(`üìÖ Season filter: ${this.currentSeasonFilter}`);
                    });
                });

                // Sort order buttons
                const sortButtons = document.querySelectorAll('.sort-btn');
                sortButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        // Remove active class from all sort buttons
                        sortButtons.forEach(btn => btn.classList.remove('active'));
                        // Add active class to clicked button
                        button.classList.add('active');
                        // Update sort order and re-display
                        this.currentSortOrder = button.dataset.sort;
                        this.displayAlbums();
                        console.log(`üìÜ Sort order: ${this.currentSortOrder}`);
                    });
                });
            }

            showEmptyState() {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        // Close modal functions
        function closePhotoModal() {
            document.getElementById('photoModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
        }

        // Initialize gallery
        const galleryLoader = new GalleryLoader();
        
        // Load albums on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Load feature states first
            await loadFeatureStates();
            
            // Then load gallery
            await galleryLoader.loadAlbums();
            
            // OLS 122: Check for URL parameter to open specific album
            const urlParams = new URLSearchParams(window.location.search);
            const albumId = urlParams.get('id');
            
            if (albumId && galleryLoader.albums) {
                const album = galleryLoader.albums.find(a => a.id === albumId);
                if (album) {
                    console.log('‚úÖ Opening album from URL parameter:', album.title);
                    // Small delay to ensure DOM is ready
                    setTimeout(() => {
                        galleryLoader.openAlbum(album);
                    }, 100);
                } else {
                    console.warn('‚ö†Ô∏è Album not found for ID:', albumId);
                }
            }
        });

        // Mobile menu toggle
        document.getElementById('menuToggle')?.addEventListener('click', function() {
            const nav = document.querySelector('.nav');
            nav.classList.toggle('active');
        });

        // Close mobile menu when clicking a link
        document.querySelectorAll('.nav a').forEach(link => {
            link.addEventListener('click', () => {
                document.querySelector('.nav').classList.remove('active');
            });
        });

        // Close modals with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePhotoModal();
                closeLightbox();
            }
        });
    </script>

    <!-- CMS Content Loading - NO FLASH APPROACH -->
    <script>
    (async function() {
        try {
            let settingsToApply = null;
            let loadedFromCache = false;
            
            // üöÄ STEP 1: Check localStorage FIRST (instant, no flash)
            const cachedSettings = localStorage.getItem('olrfc_site-settings');
            if (cachedSettings) {
                try {
                    settingsToApply = JSON.parse(cachedSettings);
                    loadedFromCache = true;
                    console.log('‚ö° Using cached settings (instant load, no flash)');
                    applyContent(settingsToApply);
                    document.body.classList.add('cms-content-loaded'); // Show content immediately
                } catch (e) {
                    console.warn('‚ö†Ô∏è Cache parse error:', e);
                }
            }
            
            // üåê STEP 2: Fetch fresh data from Netlify (background refresh OR first load)
            const response = await fetch('/.netlify/functions/site-settings', {
                method: 'GET'
            });
            
            if (response.ok) {
                const result = await response.json();
                const freshSettings = result.data || {};
                
                // Update localStorage cache
                localStorage.setItem('olrfc_site-settings', JSON.stringify(freshSettings));
                
                // Only re-apply if content changed OR this is first load
                if (!loadedFromCache) {
                    console.log('üì° First load: applying fresh settings from Netlify');
                    applyContent(freshSettings);
                    document.body.classList.add('cms-content-loaded'); // Show content with fade-in
                } else if (JSON.stringify(freshSettings) !== cachedSettings) {
                    console.log('üîÑ Content updated, refreshing page...');
                    applyContent(freshSettings);
                }
            } else if (!loadedFromCache) {
                // No cache AND Netlify failed - show defaults
                console.log('‚ö†Ô∏è No cache, Netlify unavailable - using defaults');
                document.body.classList.add('cms-content-loaded'); // Show defaults
            }
            
            function applyContent(settingsData) {
                // Build content map (only gallery fields)
                const content = {};
                Object.keys(settingsData).forEach(key => {
                    if (key.startsWith('gallery-')) {
                        content[key] = settingsData[key];
                    }
                });
                
                // Helper function to get content with fallback
                const get = (key, fallback) => content[key] || fallback;
                
                // 1. Page Title
                const pageTitle = get('gallery-page-title', 'Photo Gallery');
                document.title = pageTitle;
                
                // 2. Main Heading
                const mainHeading = document.querySelector('.gallery-hero h1');
                if (mainHeading) {
                    const headingText = get('gallery-main-heading', 'üì∏ Photo Gallery');
                    mainHeading.textContent = headingText;
                }
                
                // 3. Page Description
                const pageDescription = document.querySelector('.gallery-hero p');
                if (pageDescription) {
                    const descText = get('gallery-page-description', 'Relive the best moments from our club');
                    pageDescription.textContent = descText;
                }
                
                // 4. Loading Message
                const loadingMsg = document.querySelector('#loadingState p');
                if (loadingMsg) {
                    const msgText = get('gallery-loading-message', 'Loading albums...');
                    loadingMsg.textContent = msgText;
                }
                
                // 5. Team Filter Label
                const teamFilterLabels = document.querySelectorAll('.filter-label');
                if (teamFilterLabels[0]) {
                    const labelText = get('gallery-team-filter-label', 'üèâ Filter by Team:');
                    teamFilterLabels[0].textContent = labelText;
                }
                
                // 6. Season Filter Label
                if (teamFilterLabels[1]) {
                    const labelText = get('gallery-season-filter-label', 'üìÖ Filter by Season:');
                    teamFilterLabels[1].textContent = labelText;
                }
                
                // 7. Sort Label
                if (teamFilterLabels[2]) {
                    const labelText = get('gallery-sort-label', 'üìÜ Sort by Date:');
                    teamFilterLabels[2].textContent = labelText;
                }
                
                // 8-13. Team Filter Options (both dropdown and buttons)
                const teamMap = {
                    'all': { id: 'gallery-team-all', default: 'All Teams' },
                    'mens-1st': { id: 'gallery-team-mens1st', default: "Men's 1st XV" },
                    'mens-2nd': { id: 'gallery-team-mens2nd', default: "Men's 2nd XV" },
                    'ladies': { id: 'gallery-team-ladies', default: 'Phoenix Ladies' },
                    'colts': { id: 'gallery-team-colts', default: 'Colts' },
                    'other': { id: 'gallery-team-other', default: 'Other' }
                };
                
                // Update dropdown options
                const dropdown = document.getElementById('teamFilterDropdown');
                if (dropdown) {
                    dropdown.querySelectorAll('option').forEach(option => {
                        const value = option.value;
                        if (teamMap[value]) {
                            const text = get(teamMap[value].id, teamMap[value].default);
                            option.textContent = text;
                        }
                    });
                }
                
                // Update filter buttons
                document.querySelectorAll('.team-filter').forEach(btn => {
                    const teamValue = btn.dataset.team;
                    if (teamMap[teamValue]) {
                        const text = get(teamMap[teamValue].id, teamMap[teamValue].default);
                        btn.textContent = text;
                    }
                });
                
                // 14. All Seasons button
                const allSeasonsBtn = document.querySelector('.season-filter[data-season="all"]');
                if (allSeasonsBtn) {
                    const text = get('gallery-season-all', 'All Seasons');
                    allSeasonsBtn.textContent = text;
                }
                
                // 15-16. Sort buttons
                const newestBtn = document.querySelector('.sort-btn[data-sort="newest"]');
                if (newestBtn) {
                    const text = get('gallery-sort-newest', 'Newest First');
                    newestBtn.textContent = text;
                }
                
                const oldestBtn = document.querySelector('.sort-btn[data-sort="oldest"]');
                if (oldestBtn) {
                    const text = get('gallery-sort-oldest', 'Oldest First');
                    oldestBtn.textContent = text;
                }
                
                // 17. Empty State Title
                const emptyTitle = document.querySelector('#emptyState h3');
                if (emptyTitle) {
                    const titleText = get('gallery-empty-title', 'No Albums Yet');
                    emptyTitle.textContent = titleText;
                }
                
                // 18. Empty State Message
                const emptyMsg = document.querySelector('#emptyState p');
                if (emptyMsg) {
                    const msgText = get('gallery-empty-message', 'Check back soon for photos from matches, training, and club events!');
                    emptyMsg.textContent = msgText;
                }
                
                // 19. Photography Credit Title
                const creditTitle = document.querySelector('.photographer-credit h3');
                if (creditTitle) {
                    const titleText = get('gallery-credit-title', 'Photography Credit');
                    creditTitle.textContent = titleText;
                }
                
                // 20. Photographer Name
                const photographerName = document.querySelector('.photographer-name');
                if (photographerName) {
                    const nameText = get('gallery-photographer-name', 'Chris Reading');
                    photographerName.textContent = nameText;
                }
                
                // 21. Credit Message
                const creditMsg = document.querySelector('.photographer-credit-content > p');
                if (creditMsg) {
                    const msgText = get('gallery-credit-message', 'All photos captured by our dedicated club photographer. Thank you for capturing these memorable moments!');
                    creditMsg.textContent = msgText;
                }
                
                // 22-27. Social Media Links
                const socialLinksContainer = document.querySelector('.photographer-credit-content > div');
                if (socialLinksContainer) {
                    // Clear existing links
                    socialLinksContainer.innerHTML = '';
                    
                    // Instagram
                    const instagramUrl = get('gallery-photographer-instagram-url', '');
                    if (instagramUrl) {
                        const instagramLabel = get('gallery-photographer-instagram-label', 'üì∑ Instagram');
                        const instagramLink = document.createElement('a');
                        instagramLink.href = instagramUrl;
                        instagramLink.target = '_blank';
                        instagramLink.className = 'photographer-link';
                        instagramLink.style.margin = '0';
                        instagramLink.textContent = instagramLabel;
                        socialLinksContainer.appendChild(instagramLink);
                    }
                    
                    // Facebook
                    const facebookUrl = get('gallery-photographer-facebook-url', '');
                    if (facebookUrl) {
                        const facebookLabel = get('gallery-photographer-facebook-label', 'üë§ Facebook');
                        const facebookLink = document.createElement('a');
                        facebookLink.href = facebookUrl;
                        facebookLink.target = '_blank';
                        facebookLink.className = 'photographer-link';
                        facebookLink.style.margin = '0';
                        facebookLink.textContent = facebookLabel;
                        socialLinksContainer.appendChild(facebookLink);
                    }
                    
                    // Email
                    const email = get('gallery-photographer-email', '');
                    if (email) {
                        const emailLabel = get('gallery-photographer-email-label', '‚úâÔ∏è Email');
                        const emailLink = document.createElement('a');
                        emailLink.href = `mailto:${email}`;
                        emailLink.className = 'photographer-link';
                        emailLink.style.margin = '0';
                        emailLink.textContent = emailLabel;
                        socialLinksContainer.appendChild(emailLink);
                    }
                }
                
                console.log('‚úÖ Gallery page CMS content applied (27 fields)');
            }
            
        } catch (error) {
            console.error('‚ùå Error loading CMS content:', error);
            // Show defaults even if error
            document.body.classList.add('cms-content-loaded');
        }
    })();
    </script>

<!-- ============================================================================ -->
<!-- DYNAMIC TEAM FILTERS LOADER - OLS 81 -->
<!-- Fetches teams from Netlify Blobs and populates gallery team filters -->
<!-- ============================================================================ -->
<script>
(function() {
    /**
     * Load teams from Netlify Blobs and populate gallery team filters
     * Populates both mobile dropdown and desktop buttons
     */
    async function loadTeamFilters() {
        try {
            console.log('üì• Loading teams from Netlify Blobs for gallery filters...');
            
            // Fetch teams from Netlify Blobs
            const response = await fetch('/.netlify/functions/teams', {
                method: 'GET'
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch teams from Netlify');
            }
            
            const result = await response.json();
            const teams = result.data || [];
            
            console.log(`üìä Loaded ${teams.length} teams for gallery filters`);
            
            // Get filter elements
            const dropdown = document.getElementById('teamFilterDropdown');
            const buttonsContainer = document.querySelector('.team-filter-buttons');
            
            if (!dropdown || !buttonsContainer) {
                console.warn('‚ö†Ô∏è Gallery team filter elements not found');
                return;
            }
            
            // Clear existing content
            dropdown.innerHTML = '';
            buttonsContainer.innerHTML = '';
            
            // Add "All Teams" option first
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.selected = true;
            allOption.textContent = 'All Teams';
            dropdown.appendChild(allOption);
            
            const allButton = document.createElement('button');
            allButton.className = 'filter-btn team-filter active';
            allButton.setAttribute('data-team', 'all');
            allButton.textContent = 'All Teams';
            buttonsContainer.appendChild(allButton);
            
            // Add each team
            teams.forEach(team => {
                // Mobile dropdown option
                const option = document.createElement('option');
                option.value = team.slug;
                option.textContent = team.name;
                dropdown.appendChild(option);
                
                // Desktop button
                const button = document.createElement('button');
                button.className = 'filter-btn team-filter';
                button.setAttribute('data-team', team.slug);
                button.textContent = team.name;
                buttonsContainer.appendChild(button);
            });
            
            // Add "Other" option at the end (for miscellaneous albums)
            const otherOption = document.createElement('option');
            otherOption.value = 'other';
            otherOption.textContent = 'Other';
            dropdown.appendChild(otherOption);
            
            const otherButton = document.createElement('button');
            otherButton.className = 'filter-btn team-filter';
            otherButton.setAttribute('data-team', 'other');
            otherButton.textContent = 'Other';
            buttonsContainer.appendChild(otherButton);
            
            console.log('‚úÖ Gallery team filters loaded successfully from Netlify');
            
            // Re-initialize filter event listeners if needed
            if (window.galleryLoader && typeof window.galleryLoader.initializeFilters === 'function') {
                console.log('üîÑ Re-initializing gallery filters...');
                window.galleryLoader.initializeFilters();
            }
            
        } catch (error) {
            console.error('Error loading gallery team filters:', error);
            
            // Fallback: add basic "All Teams" and "Other" options so page doesn't break
            const dropdown = document.getElementById('teamFilterDropdown');
            const buttonsContainer = document.querySelector('.team-filter-buttons');
            
            if (dropdown && dropdown.children.length === 0) {
                dropdown.innerHTML = '<option value="all" selected>All Teams</option><option value="other">Other</option>';
            }
            
            if (buttonsContainer && buttonsContainer.children.length === 0) {
                const allBtn = document.createElement('button');
                allBtn.className = 'filter-btn team-filter active';
                allBtn.setAttribute('data-team', 'all');
                allBtn.textContent = 'All Teams';
                buttonsContainer.appendChild(allBtn);
                
                const otherBtn = document.createElement('button');
                otherBtn.className = 'filter-btn team-filter';
                otherBtn.setAttribute('data-team', 'other');
                otherBtn.textContent = 'Other';
                buttonsContainer.appendChild(otherBtn);
            }
            
            console.log('‚ö†Ô∏è Using fallback: All Teams and Other only');
        }
    }
    
    // Load teams when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadTeamFilters);
    } else {
        loadTeamFilters();
    }
})();
</script>

</body>
</html>
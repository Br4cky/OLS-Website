<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Sponsors</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <style>
        /* Admin controlled elements */
        .nav-item[data-admin-controlled="true"] {
            display: none;
        }

        .nav-item[data-admin-controlled="true"].admin-enabled {
            display: block;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(180deg, var(--bg-light) 0%, rgba(var(--primary-green-rgb), 0.12) 50%, rgba(var(--primary-maroon-rgb), 0.12) 100%);
            color: var(--text-dark);
            min-height: 100vh;
        }

        /* Page Header */
        .page-header {
            background: linear-gradient(135deg, var(--primary-green), var(--primary-maroon));
            color: white;
            padding: 6rem 0 3rem;
            text-align: center;
            margin-top: 80px;
        }

        .page-header h1 {
            margin: 0;
            font-size: 3rem;
            font-weight: bold;
        }

        .page-header p {
            margin: 1rem 0 0;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Sponsors List Section */
        .sponsors-list-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .sponsors-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 3px solid var(--primary-maroon);
            padding-bottom: 1rem;
        }

        .sponsors-list-title {
            font-size: 2rem;
            color: var(--primary-green);
            font-weight: bold;
        }

        .sponsor-count {
            font-size: 1.1rem;
            color: var(--text-light);
            font-weight: normal;
        }

        /* Sponsors Grid */
        .sponsors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 2rem;
        }

        .sponsor-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border-left: 5px solid var(--accent-gold);
            cursor: pointer;
            position: relative;
        }

        .sponsor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .sponsor-logo-display {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-light);
            overflow: hidden;
        }

        .sponsor-logo-display img {
            width: 100%;
            height: auto;
            display: block;
        }

        .sponsor-logo-display.no-logo {
            background: linear-gradient(45deg, var(--primary-green), var(--primary-maroon));
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            min-height: 150px;
        }

        .sponsor-card-body {
            padding: 1.5rem;
        }

        .sponsor-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary-green);
            margin-bottom: 1rem;
            text-align: center;
        }

        .sponsor-details {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .sponsor-detail {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            color: var(--text-dark);
            padding: 0.5rem;
            background: var(--bg-light);
            border-radius: 8px;
        }

        .sponsor-detail-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .sponsor-detail a {
            color: var(--text-dark);
            text-decoration: none;
            word-break: break-word;
        }

        .sponsor-detail a:hover {
            color: var(--primary-maroon);
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .spinner {
            border: 4px solid var(--bg-light);
            border-top: 4px solid var(--primary-green);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state-text {
            font-size: 1.3rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 2rem;
            border-bottom: 2px solid var(--bg-light);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: var(--primary-maroon);
        }

        .modal-sponsor-name {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-green);
            margin: 0;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-logo {
            height: 200px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-light);
            border-radius: 10px;
            margin-bottom: 2rem;
            padding: 2rem;
        }

        .modal-logo img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }

        .modal-logo.no-logo {
            background: linear-gradient(45deg, var(--primary-green), var(--primary-maroon));
            color: white;
            font-size: 4rem;
            font-weight: bold;
        }

        .modal-details {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .modal-detail {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: 8px;
        }

        .modal-detail-icon {
            font-size: 1.5rem;
            width: 30px;
            text-align: center;
            flex-shrink: 0;
        }

        .modal-detail-content {
            flex: 1;
        }

        .modal-detail-label {
            font-weight: bold;
            color: var(--primary-green);
            display: block;
            margin-bottom: 0.25rem;
        }

        .modal-detail-text {
            color: var(--text-dark);
            word-break: break-word;
        }

        .modal-detail-text a {
            color: var(--primary-maroon);
            text-decoration: none;
        }

        .modal-detail-text a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 2rem;
            }

            .sponsors-grid {
                grid-template-columns: 1fr;
            }

            .filter-buttons {
                width: 100%;
            }

            .filter-btn {
                flex: 1;
                min-width: 120px;
                justify-content: center;
            }

            .modal-content {
                margin: 1rem;
            }

            .sponsors-list-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header-placeholder" data-page="sponsors"></div>

    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <h1>Our Sponsors</h1>
            <p>Thank you to our sponsors for their support</p>
        </div>
    </section>

    <!-- Main Container -->
    <div class="container">
        <!-- Sponsors List Section -->
        <div class="sponsors-list-section">
            <div class="sponsors-list-header">
                <div class="sponsors-list-title">
                    Our Sponsors <span class="sponsor-count" id="sponsor-count">(0)</span>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading" class="loading-state">
                <div class="spinner"></div>
                <p>Loading sponsors...</p>
            </div>

            <!-- Sponsors Grid -->
            <div class="sponsors-grid" id="sponsors-grid" style="display: none;"></div>

            <!-- Empty State -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <div class="empty-state-icon">ü§ù</div>
                <p class="empty-state-text">No sponsors to display at this time.</p>
            </div>
        </div>
    </div>

    <!-- Sponsor Modal -->
    <div id="sponsor-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal()">&times;</button>
                <h2 class="modal-sponsor-name" id="modal-name"></h2>
            </div>
            <div class="modal-body">
                <div class="modal-logo" id="modal-logo"></div>
                <div class="modal-details" id="modal-details"></div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer-placeholder" data-page="sponsors"></div>

    <!-- Scripts -->
    <script src="../js/sanitize-html.js"></script>
    <script src="../js/shared-settings.js"></script>
    <script src="../js/header.js"></script>
    <script src="../js/footer.js"></script>
    <script src="../js/color-manager.js"></script>
    <script src="../js/seo-manager.js"></script>

    <script>
        // Load feature states from admin settings
        async function loadFeatureStates() {
            try {
                const response = await fetch('/.netlify/functions/site-settings', {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch settings');
                }
                
                const result = await response.json();
                const settings = result.data || {};
                
                const featureStates = {
                    shop: false,
                    events: false,
                    members: false,
                    payments: false,
                    sponsors: false
                };
                
                // Extract feature states from settings object
                Object.keys(settings).forEach(key => {
                    if (key.startsWith('feature-')) {
                        const featureName = key.replace('feature-', '');
                        if (featureStates.hasOwnProperty(featureName)) {
                            featureStates[featureName] = settings[key] === 'true';
                        }
                    }
                });
                
                window.featureStates = featureStates;
                
                // Apply saved states to navigation
                Object.keys(featureStates).forEach(feature => {
                    const navItems = document.querySelectorAll(`[data-admin-controlled="true"][data-feature="${feature}"]`);
                    navItems.forEach(item => {
                        item.classList.toggle('admin-enabled', featureStates[feature]);
                    });
                });
                
                return featureStates;
                
            } catch (error) {
                console.error('‚ùå Error loading feature states:', error);
                
                const fallbackStates = {
                    shop: false,
                    events: false,
                    members: false,
                    payments: false,
                    sponsors: true
                };
                
                window.featureStates = fallbackStates;
                return fallbackStates;
            }
        }

        let allSponsors = [];

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        async function loadSponsors() {
            try {
                console.log('üì• Loading sponsors from localStorage...');
                
                const sponsors = JSON.parse(localStorage.getItem('olrfc_sponsors') || '[]');
                allSponsors = sponsors.filter(s => s.active === true || s.active === 'true');
                
                console.log(`‚úÖ Loaded ${allSponsors.length} active sponsors`);
                
                displaySponsors();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('sponsors-grid').style.display = 'grid';
                
            } catch (error) {
                console.error('Error loading sponsors:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: var(--primary-maroon);">‚ö†Ô∏è Error loading sponsors. Please try again.</p>
                `;
            }
        }

        function displaySponsors() {
            const grid = document.getElementById('sponsors-grid');
            const emptyState = document.getElementById('empty-state');
            const countEl = document.getElementById('sponsor-count');
            
            countEl.textContent = `(${allSponsors.length})`;
            
            if (allSponsors.length === 0) {
                grid.style.display = 'none';
                
                // Use CMS content for empty state
                const emptyIcon = window.sponsorsCMSContent?.emptyIcon || 'ü§ù';
                const emptyText = window.sponsorsCMSContent?.emptyText || 'No sponsors to display at this time.';
                
                emptyState.innerHTML = `
                    <div class="empty-state-icon">${emptyIcon}</div>
                    <p class="empty-state-text">${emptyText}</p>
                `;
                emptyState.style.display = 'block';
                return;
            }
            
            grid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            // Randomize order
            const randomSponsors = shuffleArray(allSponsors);
            
            grid.innerHTML = randomSponsors.map(sponsor => createSponsorCard(sponsor)).join('');
        }

        function createSponsorCard(sponsor) {
            const logoHtml = sponsor.logo 
                ? `<img src="${sponsor.logo}" alt="${sponsor.name}">`
                : `<div style="font-size: 2.5rem;">${sponsor.name.substring(0, 2).toUpperCase()}</div>`;
            
            const websiteLabel = window.sponsorsCMSContent?.cardWebsiteLabel || 'Visit Website';
            
            return `
                <div class="sponsor-card" onclick='showSponsorModal(${JSON.stringify(sponsor).replace(/'/g, "&#39;")})'>
                    <div class="sponsor-logo-display ${!sponsor.logo ? 'no-logo' : ''}">
                        ${logoHtml}
                    </div>
                    <div class="sponsor-card-body">
                        <div class="sponsor-name">${sponsor.name}</div>
                        <div class="sponsor-details">
                            ${sponsor.website ? `
                                <div class="sponsor-detail">
                                    <span class="sponsor-detail-icon">üåê</span>
                                    <span>${websiteLabel}</span>
                                </div>
                            ` : ''}
                            ${sponsor.phone ? `
                                <div class="sponsor-detail">
                                    <span class="sponsor-detail-icon">üìû</span>
                                    <span>${sponsor.phone}</span>
                                </div>
                            ` : ''}
                            ${sponsor.email ? `
                                <div class="sponsor-detail">
                                    <span class="sponsor-detail-icon">‚úâÔ∏è</span>
                                    <span>${sponsor.email}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function showSponsorModal(sponsor) {
            const modal = document.getElementById('sponsor-modal');
            
            // Get CMS labels
            const phoneLabel = window.sponsorsCMSContent?.modalPhoneLabel || 'Phone';
            const emailLabel = window.sponsorsCMSContent?.modalEmailLabel || 'Email';
            const websiteLabel = window.sponsorsCMSContent?.modalWebsiteLabel || 'Website';
            
            // Set sponsor name
            document.getElementById('modal-name').textContent = sponsor.name;
            
            // Logo
            const modalLogo = document.getElementById('modal-logo');
            if (sponsor.logo) {
                modalLogo.className = 'modal-logo';
                modalLogo.innerHTML = `<img src="${sponsor.logo}" alt="${sponsor.name}">`;
            } else {
                modalLogo.className = 'modal-logo no-logo';
                modalLogo.textContent = sponsor.name.substring(0, 2).toUpperCase();
            }
            
            // Details
            const details = [];
            
            if (sponsor.phone) {
                details.push(`
                    <div class="modal-detail">
                        <div class="modal-detail-icon">üìû</div>
                        <div class="modal-detail-content">
                            <span class="modal-detail-label">${phoneLabel}</span>
                            <div class="modal-detail-text">
                                <a href="tel:${sponsor.phone}">${sponsor.phone}</a>
                            </div>
                        </div>
                    </div>
                `);
            }
            
            if (sponsor.email) {
                details.push(`
                    <div class="modal-detail">
                        <div class="modal-detail-icon">‚úâÔ∏è</div>
                        <div class="modal-detail-content">
                            <span class="modal-detail-label">${emailLabel}</span>
                            <div class="modal-detail-text">
                                <a href="mailto:${sponsor.email}">${sponsor.email}</a>
                            </div>
                        </div>
                    </div>
                `);
            }
            
            if (sponsor.website) {
                details.push(`
                    <div class="modal-detail">
                        <div class="modal-detail-icon">üåê</div>
                        <div class="modal-detail-content">
                            <span class="modal-detail-label">${websiteLabel}</span>
                            <div class="modal-detail-text">
                                <a href="${sponsor.website}" target="_blank" rel="noopener noreferrer">${sponsor.website}</a>
                            </div>
                        </div>
                    </div>
                `);
            }
            
            document.getElementById('modal-details').innerHTML = details.join('');
            
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('sponsor-modal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('sponsor-modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Load sponsors when page loads
        window.addEventListener('DOMContentLoaded', async function() {
            // Load feature states first
            await loadFeatureStates();
            
            // Then load sponsors
            loadSponsors();
        });
    </script>

    <!-- CMS Content Loading -->
    <script>
    (async function() {
        try {
            // Fetch sponsors page content from CMS
            const response = await fetch('/.netlify/functions/site-settings', {
                method: 'GET'
            });
            
            if (!response.ok) {
                console.log('CMS content not available, using defaults');
                return;
            }
            
            const result = await response.json();
            const settings = result.data || {};
            
            // Build content map (only sponsors fields)
            const content = {};
            Object.keys(settings).forEach(key => {
                if (key.startsWith('sponsors-')) {
                    content[key] = settings[key];
                }
            });
            
            // Helper function to get content with fallback
            const get = (key, fallback) => content[key] || fallback;
            
            // Store CMS content globally for use in JavaScript functions
            window.sponsorsCMSContent = {
                cardWebsiteLabel: get('sponsors-card-website-label', 'Visit Website'),
                modalPhoneLabel: get('sponsors-modal-phone-label', 'Phone'),
                modalEmailLabel: get('sponsors-modal-email-label', 'Email'),
                modalWebsiteLabel: get('sponsors-modal-website-label', 'Website'),
                emptyIcon: get('sponsors-empty-icon', 'ü§ù'),
                emptyText: get('sponsors-empty-text', 'No sponsors to display at this time.')
            };
            
            // Apply content to page elements
            applyContent();
            
            function applyContent() {
                // 1. Page Title
                const pageTitle = get('sponsors-page-title', 'Our Sponsors');
                document.title = pageTitle;
                
                // 2. Main Heading
                const mainHeading = document.querySelector('.page-header h1');
                if (mainHeading) {
                    const headingText = get('sponsors-main-heading', 'Our Sponsors');
                    mainHeading.textContent = headingText;
                }
                
                // 3. Page Description
                const pageDescription = document.querySelector('.page-header p');
                if (pageDescription) {
                    const descText = get('sponsors-page-description', 'Thank you to our sponsors for their support');
                    pageDescription.textContent = descText;
                }
                
                // 4. List Title
                const listTitle = document.querySelector('.sponsors-list-title');
                if (listTitle) {
                    const titleText = get('sponsors-list-title', 'Our Sponsors');
                    // Preserve the sponsor count span
                    const countSpan = listTitle.querySelector('.sponsor-count');
                    listTitle.innerHTML = titleText + ' ';
                    if (countSpan) {
                        listTitle.appendChild(countSpan);
                    }
                }
                
                // 5. Loading Message
                const loadingMsg = document.querySelector('#loading p');
                if (loadingMsg) {
                    const msgText = get('sponsors-loading-message', 'Loading sponsors...');
                    loadingMsg.textContent = msgText;
                }
                
                console.log('‚úÖ Sponsors page CMS content applied successfully (11 fields)');
            }
            
        } catch (error) {
            console.log('Error loading CMS content:', error);
        }
    })();
    </script>
</body>
</html>
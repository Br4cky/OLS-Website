/**
 * Admin Gallery Manager - OLS-WEBSITE
 * Photo album management and organization
 */

class AdminGalleryManager {
    constructor(adminSystem) {
        this.adminSystem = adminSystem;
        this.formHandlerAttached = false; // ADD THIS FLAG
        // REMOVE setupFormHandler() call from constructor
    }

    // ADD THIS METHOD - Lazy form handler initialization
    ensureFormHandler() {
        if (this.formHandlerAttached) return;
        
        const form = document.getElementById('galleryForm');
        if (form) {
            form.addEventListener('submit', (e) => this.handleGallerySubmission(e));
            this.formHandlerAttached = true;
            console.log('AdminGalleryManager form handler attached');
        }
    }

    async handleGallerySubmission(e) {
        e.preventDefault();
        
        const files = document.getElementById('galleryFiles').files;
        const photos = await this.processPhotoFiles(files);
        
        const galleryData = {
            id: this.adminSystem.currentEditIndex !== null ? 
                this.adminSystem.getData('gallery')[this.adminSystem.currentEditIndex].id : 
                Date.now().toString(),
            title: document.getElementById('galleryTitle').value.trim(),
            category: document.getElementById('galleryCategory').value,
            description: document.getElementById('galleryDescription').value.trim(),
            photos: photos,
            date: new Date().toISOString().split('T')[0]
        };

        // Validate required fields
        if (!galleryData.title) {
            alert('Please enter an album title');
            return;
        }

        try {
            // 1. IMMEDIATE localStorage update
            let existingGallery = this.adminSystem.getData('gallery');
            
            if (this.adminSystem.currentEditIndex !== null) {
                // Merge photos if editing existing album
                const existingPhotos = existingGallery[this.adminSystem.currentEditIndex].photos || [];
                galleryData.photos = [...existingPhotos, ...photos];
                existingGallery[this.adminSystem.currentEditIndex] = galleryData;
            } else {
                existingGallery.unshift(galleryData);
            }
            
            this.adminSystem.saveData('gallery', existingGallery);
            this.adminSystem.loadGallery();
            this.adminSystem.updateStats();
            
            const action = this.adminSystem.currentEditIndex !== null ? 'updated' : 'created';
            this.adminSystem.showAlert('gallery', `Album ${action} successfully with ${photos.length} photos!`, 'success');
            
            // 2. BACKGROUND cloud storage (when available)
            if (window.netlifyDataManager && window.netlifyDataManager.createGallery) {
                try {
                    const result = await window.netlifyDataManager.createGallery(galleryData);
                    
                    if (result.success) {
                        console.log('Gallery successfully synced to cloud storage');
                        setTimeout(() => {
                            this.adminSystem.showAlert('gallery', 'Album synced to cloud storage ‚úì', 'success');
                        }, 1000);
                    }
                } catch (cloudError) {
                    console.warn('Cloud storage failed, but localStorage succeeded:', cloudError);
                    this.adminSystem.showAlert('gallery', 'Album saved locally (cloud sync pending)', 'warning');
                }
            }
            
            closeModal('galleryModal');
            document.getElementById('galleryForm').reset();
            this.adminSystem.currentEditIndex = null;
            
        } catch (error) {
            console.error('Error saving gallery album:', error);
            this.adminSystem.showAlert('gallery', 'Error saving album: ' + error.message, 'danger');
        }
    }

    async processPhotoFiles(files) {
        const photos = [];
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            try {
                const processedPhoto = await this.processPhotoFile(file);
                photos.push(processedPhoto);
            } catch (error) {
                console.warn(`Failed to process photo ${file.name}:`, error);
            }
        }
        
        return photos;
    }

    async processPhotoFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                // Create thumbnail
                this.createThumbnail(e.target.result, 300, 200).then(thumbnail => {
                    resolve({
                        id: Date.now() + Math.random().toString(36).substr(2, 9),
                        name: file.name,
                        originalUrl: e.target.result,
                        thumbnailUrl: thumbnail,
                        size: file.size,
                        type: file.type,
                        uploadDate: new Date().toISOString()
                    });
                }).catch(reject);
            };
            
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    createThumbnail(imageSrc, maxWidth = 300, maxHeight = 200) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = () => {
                // Calculate thumbnail dimensions maintaining aspect ratio
                let { width, height } = img;
                
                if (width > height) {
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob((blob) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(blob);
                }, 'image/jpeg', 0.8);
            };
            
            img.src = imageSrc;
        });
    }

    editAlbum(index) {
        const gallery = this.adminSystem.getData('gallery');
        const album = gallery[index];
        
        if (!album) {
            console.error('Album not found at index:', index);
            return;
        }
        
        this.adminSystem.currentEditIndex = index;
        this.adminSystem.currentSection = 'gallery';
        
        // CRITICAL: Ensure form handler before opening modal
        setTimeout(() => {
            this.ensureFormHandler();
            
            // Populate form with existing data
            document.getElementById('galleryTitle').value = album.title || '';
            document.getElementById('galleryCategory').value = album.category || 'matches';
            document.getElementById('galleryDescription').value = album.description || '';
        }, 50);
        
        openModal('galleryModal');
    }

    viewAlbum(index) {
        const gallery = this.adminSystem.getData('gallery');
        const album = gallery[index];
        
        if (!album) {
            console.error('Album not found at index:', index);
            return;
        }
        
        this.showAlbumViewer(album);
    }

    showAlbumViewer(album) {
        // Create album viewer modal
        const viewer = document.createElement('div');
        viewer.className = 'modal';
        viewer.style.display = 'block';
        
        viewer.innerHTML = `
            <div class="modal-content" style="max-width: 90vw; max-height: 90vh; padding: 1rem;">
                <div class="modal-header">
                    <h3>üì∏ ${album.title}</h3>
                    <button class="close" onclick="this.closest('.modal').remove()">&times;</button>
                </div>
                <div style="margin-bottom: 1rem;">
                    <p><strong>Category:</strong> ${this.adminSystem.formatCategory(album.category)}</p>
                    <p><strong>Photos:</strong> ${album.photos?.length || 0}</p>
                    <p><strong>Description:</strong> ${album.description || 'No description'}</p>
                </div>
                <div class="photo-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; max-height: 60vh; overflow-y: auto;">
                    ${this.renderPhotoGrid(album.photos || [])}
                </div>
                <div style="margin-top: 1rem; text-align: center;">
                    <button class="btn btn-secondary" onclick="downloadAlbum('${album.id}')">üì• Download Album</button>
                    <button class="btn btn-danger" onclick="deleteAlbumFromViewer('${album.id}')" style="margin-left: 1rem;">üóëÔ∏è Delete Album</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(viewer);
    }

    renderPhotoGrid(photos) {
        if (!photos || photos.length === 0) {
            return '<p style="text-align: center; color: var(--text-light);">No photos in this album</p>';
        }
        
        return photos.map(photo => `
            <div class="photo-item" style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; cursor: pointer;" onclick="showPhotoLightbox('${photo.id}', '${photo.originalUrl}')">
                <img src="${photo.thumbnailUrl || photo.originalUrl}" alt="${photo.name}" style="width: 100%; height: 150px; object-fit: cover;">
                <div style="padding: 0.5rem; background: white;">
                    <small>${photo.name}</small>
                </div>
            </div>
        `).join('');
    }

    showPhotoLightbox(photoId, photoUrl) {
        const lightbox = document.createElement('div');
        lightbox.className = 'modal';
        lightbox.style.display = 'block';
        lightbox.style.background = 'rgba(0,0,0,0.9)';
        
        lightbox.innerHTML = `
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90vw; max-height: 90vh;">
                <button class="close" onclick="this.closest('.modal').remove()" style="position: absolute; top: -40px; right: 0; background: white; color: black; border-radius: 50%;">&times;</button>
                <img src="${photoUrl}" style="max-width: 100%; max-height: 100%; border-radius: 8px;">
            </div>
        `;
        
        document.body.appendChild(lightbox);
        
        // Close on background click
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) {
                lightbox.remove();
            }
        });
    }

    deleteAlbum(index) {
        const gallery = this.adminSystem.getData('gallery');
        const album = gallery[index];
        
        if (!album) {
            console.error('Album not found at index:', index);
            return;
        }
        
        if (confirm(`Are you sure you want to delete the album "${album.title}"? This will delete all ${album.photos?.length || 0} photos.`)) {
            try {
                gallery.splice(index, 1);
                this.adminSystem.saveData('gallery', gallery);
                this.adminSystem.loadGallery();
                this.adminSystem.updateStats();
                this.adminSystem.showAlert('gallery', 'Album deleted successfully', 'success');
            } catch (error) {
                console.error('Error deleting album:', error);
                this.adminSystem.showAlert('gallery', 'Error deleting album: ' + error.message, 'danger');
            }
        }
    }

    duplicateAlbum(index) {
        const gallery = this.adminSystem.getData('gallery');
        const album = gallery[index];
        
        if (!album) {
            console.error('Album not found at index:', index);
            return;
        }
        
        const duplicatedAlbum = {
            ...album,
            id: Date.now().toString(),
            title: album.title + ' (Copy)',
            date: new Date().toISOString().split('T')[0]
        };
        
        gallery.unshift(duplicatedAlbum);
        this.adminSystem.saveData('gallery', gallery);
        this.adminSystem.loadGallery();
        this.adminSystem.updateStats();
        
        this.adminSystem.showAlert('gallery', 'Album duplicated successfully', 'success');
    }

    // Photo management within albums
    removePhotoFromAlbum(albumIndex, photoId) {
        const gallery = this.adminSystem.getData('gallery');
        const album = gallery[albumIndex];
        
        if (!album) {
            console.error('Album not found at index:', albumIndex);
            return;
        }
        
        album.photos = album.photos.filter(photo => photo.id !== photoId);
        
        this.adminSystem.saveData('gallery', gallery);
        this.adminSystem.loadGallery();
        
        this.adminSystem.showAlert('gallery', 'Photo removed from album', 'success');
    }

    addPhotosToExistingAlbum(albumIndex, newPhotos) {
        const gallery = this.adminSystem.getData('gallery');
        const album = gallery[albumIndex];
        
        if (!album) {
            console.error('Album not found at index:', albumIndex);
            return;
        }
        
        album.photos = [...(album.photos || []), ...newPhotos];
        
        this.adminSystem.saveData('gallery', gallery);
        this.adminSystem.loadGallery();
        
        this.adminSystem.showAlert('gallery', `Added ${newPhotos.length} photos to album`, 'success');
    }

    // Gallery organization and filtering
    getAlbumsByCategory(category) {
        const gallery = this.adminSystem.getData('gallery');
        if (category === 'all') {
            return gallery;
        }
        return gallery.filter(album => album.category === category);
    }

    searchAlbums(searchTerm) {
        const gallery = this.adminSystem.getData('gallery');
        
        if (!searchTerm || searchTerm.trim() === '') {
            return gallery;
        }
        
        const term = searchTerm.toLowerCase();
        
        return gallery.filter(album => 
            (album.title || '').toLowerCase().includes(term) ||
            (album.description || '').toLowerCase().includes(term) ||
            this.adminSystem.formatCategory(album.category).toLowerCase().includes(term)
        );
    }

    // Export and backup functionality
    downloadAlbum(albumId) {
        const gallery = this.adminSystem.getData('gallery');
        const album = gallery.find(a => a.id === albumId);
        
        if (!album) {
            console.error('Album not found:', albumId);
            return;
        }
        
        // Create ZIP-like download (simplified - would need proper ZIP library)
        const albumData = {
            albumInfo: {
                title: album.title,
                description: album.description,
                category: album.category,
                date: album.date,
                photoCount: album.photos?.length || 0
            },
            photos: album.photos || []
        };
        
        const dataStr = JSON.stringify(albumData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(dataBlob);
        downloadLink.download = `album_${album.title.replace(/\s+/g, '_')}_${Date.now()}.json`;
        downloadLink.click();
    }

    exportGalleryByCategory(category) {
        const albums = this.getAlbumsByCategory(category);
        const csvData = this.convertGalleryToCSV(albums);
        const filename = `olrfc_gallery_${category}_${new Date().toISOString().split('T')[0]}.csv`;
        
        this.downloadCSV(csvData, filename);
    }

    convertGalleryToCSV(albums) {
        const headers = ['Title', 'Category', 'Description', 'Photo Count', 'Date Created'];
        let csv = headers.join(',') + '\n';
        
        albums.forEach(album => {
            const row = [
                album.title || '',
                this.adminSystem.formatCategory(album.category),
                album.description || '',
                album.photos?.length || 0,
                album.date || ''
            ];
            
            csv += row.map(field => `"${field}"`).join(',') + '\n';
        });
        
        return csv;
    }

    downloadCSV(csvContent, filename) {
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
    }

    // Gallery statistics
    getGalleryStats() {
        const gallery = this.adminSystem.getData('gallery');
        
        const stats = {
            totalAlbums: gallery.length,
            totalPhotos: gallery.reduce((sum, album) => sum + (album.photos?.length || 0), 0),
            byCategory: {},
            averagePhotosPerAlbum: 0
        };
        
        const categories = ['matches', 'training', 'social', 'team'];
        categories.forEach(category => {
            const categoryAlbums = gallery.filter(album => album.category === category);
            stats.byCategory[category] = {
                albums: categoryAlbums.length,
                photos: categoryAlbums.reduce((sum, album) => sum + (album.photos?.length || 0), 0)
            };
        });
        
        if (gallery.length > 0) {
            stats.averagePhotosPerAlbum = Math.round(stats.totalPhotos / gallery.length);
        }
        
        return stats;
    }
}

// ============================================
// INITIALIZE AND GLOBAL EXPORTS
// ============================================

let adminGalleryManager;

document.addEventListener('DOMContentLoaded', function() {
    if (window.adminSystem) {
        adminGalleryManager = new AdminGalleryManager(window.adminSystem);
        console.log('Admin Gallery Manager initialized');
    }
});

// Export all CRUD functions to global scope for HTML onclick compatibility
window.editAlbum = function(index) {
    if (adminGalleryManager) {
        adminGalleryManager.editAlbum(index);
    } else {
        console.error('AdminGalleryManager not initialized');
    }
};

window.viewAlbum = function(index) {
    if (adminGalleryManager) {
        adminGalleryManager.viewAlbum(index);
    } else {
        console.error('AdminGalleryManager not initialized');
    }
};

window.deleteAlbum = function(index) {
    if (adminGalleryManager) {
        adminGalleryManager.deleteAlbum(index);
    } else {
        console.error('AdminGalleryManager not initialized');
    }
};

window.duplicateAlbum = function(index) {
    if (adminGalleryManager) {
        adminGalleryManager.duplicateAlbum(index);
    } else {
        console.error('AdminGalleryManager not initialized');
    }
};

window.downloadAlbum = function(albumId) {
    if (adminGalleryManager) {
        adminGalleryManager.downloadAlbum(albumId);
    } else {
        console.error('AdminGalleryManager not initialized');
    }
};

window.showPhotoLightbox = function(photoId, photoUrl) {
    if (adminGalleryManager) {
        adminGalleryManager.showPhotoLightbox(photoId, photoUrl);
    } else {
        console.error('AdminGalleryManager not initialized');
    }
};

window.deleteAlbumFromViewer = function(albumId) {
    if (adminGalleryManager) {
        const gallery = adminGalleryManager.adminSystem.getData('gallery');
        const index = gallery.findIndex(album => album.id === albumId);
        if (index !== -1) {
            adminGalleryManager.deleteAlbum(index);
            // Close the viewer
            document.querySelectorAll('.modal').forEach(modal => modal.remove());
        }
    } else {
        console.error('AdminGalleryManager not initialized');
    }
};